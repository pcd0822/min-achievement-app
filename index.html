<!DOCTYPE html>

<html lang="ko">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>최소 성취수준 보장지도 관리 웹 앱</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>



    <style>

        body { font-family: 'Inter', 'Pretendard', sans-serif; }

        .tab-button {

            padding: 10px 20px;

            cursor: pointer;

            border-bottom: 3px solid transparent;

            transition: all 0.3s ease;

        }

        .tab-button.active {

            border-bottom-color: #4f46e5;

            color: #4f46e5;

            font-weight: 600;

        }

        .form-section {

            display: none;

        }

        .form-section.active {

            display: block;

        }

        .modal-overlay {

            position: fixed;

            top: 0;

            left: 0;

            right: 0;

            bottom: 0;

            background: rgba(0,0,0,0.5);

            display: flex;

            align-items: center;

            justify-content: center;

            z-index: 1000;

        }

        .modal-content {

            background: white;

            padding: 2rem;

            border-radius: 0.5rem;

            max-width: 90%;

            width: 500px;

        }

        .modal-content.modal-large {

            width: 90%;

            max-width: 1200px;

            max-height: 90vh;

            overflow-y: auto;

        }

        .stats-table {

            width: 100%;

            border-collapse: collapse;

        }

        .stats-table th, .stats-table td {

            border: 1px solid #e5e7eb;

            padding: 0.5rem;

            text-align: center;

            font-size: 0.875rem;

        }

        .stats-table thead th {

            background-color: #f9fafb;

            font-weight: 600;

        }

        .stats-section-title {

            font-weight: 600;

            margin-bottom: 0.75rem;

            font-size: 1.1rem;

        }

        .stats-chart-track {

            width: 100%;

            background: #e5e7eb;

            border-radius: 9999px;

            overflow: hidden;

            height: 24px;

        }

        .stats-chart-bar {

            height: 24px;

            border-radius: 9999px;

            background: linear-gradient(90deg, #4f46e5, #6366f1);

        }

        .stats-chart-label {

            font-size: 0.85rem;

        }

        .table-wide-cell {

            min-width: 260px;

            max-width: 420px;

            white-space: normal;

            word-break: keep-all;

        }

        .attendance-dropdown-changed {
            background-color: #fef3c7 !important; /* 노란색 배경 */
            border-color: #f59e0b !important; /* 주황색 테두리 */
        }
        .table-exception-cell {

            min-width: 280px;

            max-width: 420px;

        }

        /* A4 비율과 유사한 미리보기 모달창 스타일 */

        .modal-preview {

             width: 210mm; /* A4 width */

             max-width: 95%;

             max-height: 90vh; /* 높이 제한 */

             overflow-y: auto; /* 내용이 길면 스크롤 */

             padding: 0; /* 내부 패딩은 #print-area가 담당 */

        }

        /* 미리보기/인쇄 영역 스타일 */

        #print-area {

            font-family: 'Malgun Gothic', sans-serif;

            color: black;

            background: white;

            padding: 15mm; /* A4 여백과 유사한 패딩 */

            box-sizing: border-box;

            width: 100%; /* modal-preview 너비에 맞춤 */

        }

         #print-area h1, #print-area h3, #print-area h4 {

             margin-top: 1.5em;

             margin-bottom: 0.8em;

             font-weight: bold;

         }

         #print-area h1 { font-size: 1.8rem; text-align: center; }

         #print-area h3 { font-size: 1.2rem; }

         #print-area h4 { font-size: 1.0rem; }



         #print-area table {

             width: 100%;

             border-collapse: collapse;

             margin-top: 10px;

             font-size: 9pt;

            table-layout: auto; /* 셀 너비 자동 조정 */

         }

         #print-area th, #print-area td {

             border: 1px solid #666; /* 인쇄 시 잘 보이도록 어두운 테두리 */

            padding: 10px 12px;

             text-align: center;

            vertical-align: top;

             word-wrap: break-word; /* 긴 텍스트 줄바꿈 */

            overflow-wrap: break-word;

            min-height: 40px;

            height: auto;

            line-height: 1.5;

            box-sizing: border-box;

         }

          #print-area th {

              background-color: #f2f2f2;

              font-weight: bold;

              min-height: 45px;

              vertical-align: middle;

          }

        /* 모든 행의 높이를 균일하게 설정 */

        #print-area tbody tr {

            height: auto;

            min-height: 40px;

        }

        #print-area tbody td {

            height: auto;

            min-height: 40px;

          }

         /* 테이블 내 텍스트 왼쪽 정렬용 */

         #print-area .text-left {

             text-align: left;

         }

         /* 본문 내용 등 줄바꿈 유지를 위함 */

         #print-area .whitespace-pre-wrap {

            white-space: pre-wrap;

            word-break: break-all;

            text-align: left; /* 본문은 보통 왼쪽 정렬 */

            min-height: 20px; /* 본문 영역 최소 높이 (다른 행과 동일하게) */

            height: auto; /* 텍스트 양에 따라 유동적으로 늘어남 */

            line-height: 1.5; /* 가독성 향상 */

         }

         #print-area .signature-section {

             margin-top: 50px;

             display: flex;

             justify-content: space-around;

             text-align: center;

             font-size: 1rem;

         }

         #print-area .seal-section {

            text-align: center;

            margin-top: 50px;

         }

         #print-area .seal-section img {

            width: 70px;

            height: 70px;

            margin: 0 auto;

         }

         #print-area .school-name {

            font-size: 1.2rem;

            font-weight: bold;

            margin-top: 30px;

         }



        [v-cloak] { display: none; }



        .table-cell-content {

            padding: 0.5rem 0;

            min-height: 2.5rem;

            display: flex;

            align-items: center;

        }



        .table-cell-content:not(:last-child) {

            border-bottom: 1px solid #e5e7eb;

        }



        .scroll-arrow {

            position: absolute;

            top: 50%;

            transform: translateY(-50%);

            z-index: 30;

            width: 2.5rem;

            height: 2.5rem;

            border-radius: 9999px;

            background-color: rgba(255, 255, 255, 0.7);

            backdrop-filter: blur(4px);

            border: 1px solid rgba(0, 0, 0, 0.1);

            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);

            cursor: pointer;

            display: flex;

            align-items: center;

            justify-content: center;

            font-size: 1.5rem;

            color: #4a5568;

            transition: all 0.2s ease-in-out;

        }

        .scroll-arrow:hover {

            background-color: rgba(255, 255, 255, 0.9);

            transform: translateY(-50%) scale(1.1);

        }

        .scroll-arrow.left { left: -1.25rem; }

        .scroll-arrow.right { right: -1.25rem; }



        /* 출석부 테이블 정렬 개선 */

        .overflow-x-auto table {

            border-collapse: separate;

            border-spacing: 0;

            table-layout: auto;

        }

        .overflow-x-auto table thead th,

        .overflow-x-auto table tbody td {

            vertical-align: top;

        }

        .overflow-x-auto table thead th.sticky,

        .overflow-x-auto table tbody td.sticky {

            vertical-align: top;

        }

        /* sticky 셀의 정확한 위치 설정 */

        .overflow-x-auto table thead th[style*="left: 0"],

        .overflow-x-auto table tbody td[style*="left: 0"] {

            left: 0 !important;

        }

        /* 이름 열을 학번 열에 정확히 붙이기 */

        .overflow-x-auto table thead th[style*="left: 80px"],

        .overflow-x-auto table tbody td[style*="left: 80px"] {

            left: 80px !important;

        }

        /* 테이블 헤더와 본문 셀의 높이 일치를 위한 추가 스타일 */

        .overflow-x-auto table thead th,

        .overflow-x-auto table tbody td {

            vertical-align: top;

            box-sizing: border-box;

        }



        /* 인쇄 전용 스타일 (안정적인 버전으로 수정) */

        @media print {

            /* 1. 기본 인쇄 설정 */

            body {

                margin: 0;

                padding: 0;

                background-color: white;

            }

            
            
            /* 2. 인쇄 불필요 UI 요소 명시적 숨기기 */

            #app > header, 

            #app > main,

            #app > footer, /* 저작권 문구가 있는 footer 숨기기 */

            div[v-if="showAttendanceModal"],

            div[v-if="showImportModal"],

            div[v-if="showSchoolIdModal"], /* 학교코드 모달 숨기기 */

            #print-area-container, /* html2canvas용 컨테이너 숨기기 */

            .modal-overlay .modal-content > div:not(#print-area-container-in-modal), /* 모달 내 버튼, 상태메시지 숨기기 */

            .no-print-status, /* 상태 메시지 숨기기 */

            .no-print-controls, /* 버튼 컨트롤 숨기기 */

            .scroll-arrow {

                display: none !important;

            }



            /* 3. 모달 관련 스타일 리셋 (인쇄 시 화면을 가리지 않도록) */

            .modal-overlay {

                position: static !important;

                background: none !important;

                overflow: visible !important;

                display: block !important;

                width: 100%; height: 100%; z-index: auto;

            }

            .modal-content {

                border: none !important; box-shadow: none !important;

                padding: 0 !important; width: 100% !important;

                max-width: 100% !important; max-height: none !important;

                overflow: visible !important; display: block !important;

            }

            
            
            /* 4. 인쇄할 컨테이너 및 내용 보이기 */

            #print-area-container-in-modal,

            #print-area-container-in-modal * {

                visibility: visible !important; /* visibility: visible로 되돌림 */

            }

            #print-area-container-in-modal {

                 display: block !important;

            }



            /* 5. 인쇄할 영역(#print-area) 스타일 리셋 */

            #print-area {

                padding: 0 !important; margin: 0 !important; /* @page 여백이 적용됨 */

                border: none !important; box-shadow: none !important;

                width: 100% !important; font-size: 10pt !important;

                color: black !important; background: white !important;

            }

            
            
            /* 6. 인쇄용 테이블/폰트 미세 조정 */

            #print-area table { 

                font-size: 8pt !important; 

                width: 100% !important;

                max-width: 100% !important;

                min-width: 0 !important;

                table-layout: fixed !important; /* 고정 레이아웃으로 열 너비 강제 */

            }

            #print-area th, #print-area td { 

                padding: 4px 3px !important; 

                font-size: 7.5pt !important;

                word-wrap: break-word !important;

                overflow-wrap: break-word !important;

            }

            #print-area th {

                font-weight: 600 !important;

            }

            /* 테이블이 A4 가로폭에 맞도록 조정 */

            #print-area #underachievers-table,

            #print-area table {

                width: 100% !important;

                max-width: 100% !important;

                min-width: 0 !important;

                table-layout: fixed !important; /* 고정 레이아웃으로 열 너비 강제 */

            }

            /* 인쇄 시 테이블 열 너비 최적화 */

            #print-area #underachievers-table th:nth-child(1),

            #print-area #underachievers-table td:nth-child(1) {

                width: 8% !important; /* 학번 */

                min-width: 0 !important;

                max-width: 8% !important;

            }

            #print-area #underachievers-table th:nth-child(2),

            #print-area #underachievers-table td:nth-child(2) {

                width: 8% !important; /* 이름 */

                min-width: 0 !important;

                max-width: 8% !important;

            }

            #print-area #underachievers-table th:nth-child(3),

            #print-area #underachievers-table td:nth-child(3) {

                width: 10% !important; /* 특기사항 */

                min-width: 0 !important;

                max-width: 10% !important;

            }

            #print-area #underachievers-table th:nth-child(4),

            #print-area #underachievers-table td:nth-child(4) {

                width: 16% !important; /* 미도달내역 */

                min-width: 0 !important;

                max-width: 16% !important;

            }

            #print-area #underachievers-table th:nth-child(5),

            #print-area #underachievers-table td:nth-child(5) {

                width: 20% !important; /* 미도달 과목(학점수) */

                min-width: 0 !important;

                max-width: 20% !important;

            }

            #print-area #underachievers-table th:nth-child(6),

            #print-area #underachievers-table td:nth-child(6) {

                width: 20% !important; /* 보충지도(추가학습) 내역 */

                min-width: 0 !important;

                max-width: 20% !important;

            }

            #print-area #underachievers-table th:nth-child(7),

            #print-area #underachievers-table td:nth-child(7) {

                width: 8% !important; /* 비고 */

                min-width: 0 !important;

                max-width: 8% !important;

            }

            /* 긴 텍스트가 있는 셀 처리 */

            #print-area #underachievers-table td {

                white-space: normal !important;

                line-height: 1.3 !important;

            }



            /* 7. @page 설정 (A4 여백) */

            @page {

                size: A4 portrait;

                margin: 20mm;

            }

            .page-break {

                page-break-after: always !important;

            }

            img {

                 max-width: 100% !important;

                 height: auto !important;

                 visibility: visible !important;

             }

        }

        
        
        /* 과목 카드 애니메이션 */

        .subject-card {

            transition: all 0.3s ease;

        }

        .subject-card:hover {

            transform: translateY(-8px);

            box-shadow: 0 20px 40px rgba(147, 51, 234, 0.3) !important;

        }

    </style>

</head>

<body class="bg-gray-100">



    <div id="app" v-cloak class="min-h-screen flex flex-col">

        <!-- Header -->

        <header class="bg-white shadow-md">

            <div class="container mx-auto px-4 sm:px-6 lg:px-8">

                <div class="flex items-center justify-between h-16">

                    <div class="flex flex-col sm:flex-row sm:items-center">

                    <div class="flex items-center">

                        <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">

                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"/>

                        </svg>

                        <h1 class="ml-2 text-2xl font-bold text-gray-800">최소 성취수준 보장지도 관리</h1>

                        </div>

                        <span class="sm:ml-4 sm:mt-0 mt-1 text-xs text-gray-400">Designed by 박찬들 (설악고)</span>

                    </div>

                     <!-- Login/Logout UI -->

                    <div v-if="isLoggedIn" class="flex items-center space-x-4">

                         <span class="text-gray-600 text-sm"> {{ user?.email }}</span>

                         <span v-if="role" class="text-gray-600 font-semibold">[{{ role }}] 모드</span>

                         <span v-if="currentSchoolCode" class="text-xs text-indigo-600 bg-indigo-50 px-2 py-1 rounded">학교코드: {{ currentSchoolCode }}</span>

                         <button @click="logout" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition text-sm">로그아웃</button>

                         <button v-if="role" @click="resetRole" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition text-sm">역할 재선택</button>

                         <button v-if="role === '관리자'" @click="openAdminModifyModal" class="ml-2 px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition text-sm">학교 코드 수정 및 발급</button>

                    </div>

                    <div v-else>

                         <button @click="login" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">Google 로그인</button>

                    </div>

                </div>

            </div>

        </header>



        <!-- Main Content -->

        <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">

            <!-- Loading Indicator -->

             <div v-if="isLoading" class="text-center mt-10">

                 <p class="text-gray-600">데이터 로딩 중...</p>

             </div>





            <!-- Role Selection Modal (Show if logged in but no role) -->

            <div v-if="isLoggedIn && !role && !isLoading && !showSchoolIdModal" class="modal-overlay">

                <div class="modal-content">

                    <h3 class="text-2xl font-bold mb-6 text-center">역할 선택</h3>

                    <div class="space-y-4">

                        <button @click="selectRole('교과교사')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">교과교사</button>

                        <button @click="selectRole('담임교사')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">담임교사</button>

                        <p class="text-sm text-gray-600 text-center mt-2 mb-2">※ 교과교사/담임교사 선택 시 학교코드 입력이 필요합니다.</p>

                        <div>

                            <button @click="selectRole('관리자')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">관리자</button>

                            <div v-if="showAdminCodeInput" class="mt-2">

                                <input type="password" v-model="adminCode" @keyup.enter="submitAdminCode" placeholder="관리자 코드 입력 (0822)" class="w-full p-2 border rounded-md">

                                <button @click="submitAdminCode" class="w-full mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">확인</button>

                                <p v-if="adminCodeError" class="text-red-500 text-sm mt-1">{{ adminCodeError }}</p>

                            </div>

                        </div>

                    </div>

                    <p v-if="statusMessage" class="mt-4 text-center text-sm text-blue-600">{{ statusMessage }}</p>

                    <div class="mt-6 flex justify-end">

                        <button @click="cancelRoleSelection" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition">취소</button>

                    </div>

                </div>

            </div>



            <!-- School ID Modal (Show if role selected, but no schoolId) -->

            <div v-if="showSchoolIdModal && !isLoading" class="modal-overlay">

                <div class="modal-content">

                    <h3 class="text-2xl font-bold mb-4 text-center">학교코드 설정</h3>



                    <div class="mb-4 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md p-3">

                        학교코드는 학교 구성원에게만 공유하세요. 외부에 유출될 경우 학생 개인정보가 노출될 수 있습니다.

                    </div>



                    <div v-if="role === '관리자'" class="mb-4">

                        <div class="grid grid-cols-2 gap-2">

                            <button type="button"

                                    @click="setSchoolIdMode('create')"

                                    :class="['px-4 py-2 rounded-md border transition',

                                             schoolIdMode === 'create' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-gray-100 text-gray-700 border-gray-200']">

                                학교코드 생성

                            </button>

                            <button type="button"

                                    @click="setSchoolIdMode('input')"

                                    :class="['px-4 py-2 rounded-md border transition',

                                             schoolIdMode === 'input' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-gray-100 text-gray-700 border-gray-200']">

                                학교코드 입력

                            </button>

                        </div>

                        <p v-if="schoolIdMode === 'create'" class="text-sm text-gray-600 mt-3">

                            새 학교코드를 생성합니다. 등록되지 않은 고유한 문자열을 사용하면 자동으로 현재 관리자 계정과 연결됩니다.

                        </p>

                        <p v-else-if="schoolIdMode === 'input'" class="text-sm text-gray-600 mt-3">

                            이전에 본인 계정으로 생성한 학교코드를 입력하세요. 다른 관리자가 만든 코드는 사용할 수 없습니다.

                        </p>

                    </div>



                    <p v-else class="text-sm text-gray-600 mb-4">

                        학교 관리자에게 전달받은 학교코드를 정확히 입력하세요.

                    </p>

                    
                    
                    <form @submit.prevent="handleSchoolIdSubmit" class="space-y-4">

                        <div>

                            <label for="school-id-input" class="sr-only">학교코드</label>

                            <input id="school-id-input" type="text" v-model="newSchoolId" placeholder="학교코드 (예: korea_high_2025)" required class="w-full p-3 border border-gray-300 rounded-md">

                        </div>

                        <p v-if="schoolIdError" class="text-red-500 text-sm mt-1">{{ schoolIdError }}</p>

                        
                        
                        <button type="submit" class="w-full px-6 py-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition">

                            <span v-if="role === '관리자' && schoolIdMode === 'create'">학교코드 생성</span>

                            <span v-else-if="role === '관리자' && schoolIdMode === 'input'">학교코드 입력</span>

                            <span v-else>참여하기</span>

                        </button>

                    </form>

                </div>

            </div>



             <!-- Main Dashboard (Show only if logged in and role is selected) -->

             <div v-if="isLoggedIn && role && !isLoading">

                <!-- Admin View -->

                 <div v-if="role === '관리자'">

                      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-3">

                          <h2 class="text-3xl font-bold text-gray-800">관리자 대시보드 (학교코드: {{ currentSchoolCode || '미설정' }})</h2>

                          <button

                              @click="openStatisticsModal"

                              class="inline-flex items-center justify-center px-4 py-2 bg-slate-800 text-white rounded-md hover:bg-slate-900 transition text-sm font-semibold shadow-sm"

                          >

                              통계 대시보드 보기

                          </button>

                      </div>

                      <div v-if="!currentSchoolCode" class="mb-6 p-4 bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500 rounded-md">

                          <p class="font-bold">안내</p>

                          <p>학교코드가 설정되지 않았습니다. 데이터를 저장하거나 관리하려면 우측 상단의 '학교 코드 수정 및 발급' 버튼을 눌러 코드를 먼저 설정해주세요.</p>

                      </div>

                       <div class="space-y-8">

                           <!-- 1. 교육과정 편제표 업로드 -->

                           <div class="bg-white p-6 rounded-lg shadow-md">

                               <h3 class="text-xl font-semibold mb-4">1. 교육과정 편제표 업로드</h3>

                               <div class="flex space-x-4">

                                   <button @click="downloadTemplate('curriculum')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>

                                   <input type="file" @change="uploadFile($event, 'curriculum')" class="hidden" id="curriculum-upload-admin">

                                   <label for="curriculum-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</label>

                               </div>

                               <p v-if="uploadStatus.curriculum" class="mt-2 text-sm font-medium">{{ uploadStatus.curriculum }}</p>

                           </div>



                           <!-- 2. 학적 정보 업로드 -->

                           <div class="bg-white p-6 rounded-lg shadow-md">

                               <h3 class="text-xl font-semibold mb-4">2. 학적 정보 업로드</h3>

                               <div class="flex space-x-4">

                                   <button @click="downloadTemplate('student')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>

                                   <input type="file" @change="uploadFile($event, 'student')" class="hidden" id="student-upload-admin">

                                   <label for="student-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</label>

                               </div>

                                <p v-if="uploadStatus.student" class="mt-2 text-sm font-medium">{{ uploadStatus.student }}</p>

                           </div>



                            <!-- 2-1. 정서지원프로그램 이수시간 업로드 -->

                           <div class="bg-white p-6 rounded-lg shadow-md">

                               <h3 class="text-xl font-semibold mb-4">2-1. 정서지원프로그램 이수시간 업로드</h3>

                               <div class="flex space-x-4">

                                   <button @click="downloadTemplate('emotionalSupport')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>

                                   <input type="file" @change="uploadFile($event, 'emotionalSupport')" class="hidden" id="emotional-support-upload-admin">

                                   <label for="emotional-support-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</label>

                               </div>

                               <p v-if="uploadStatus.emotionalSupport" class="mt-2 text-sm font-medium">{{ uploadStatus.emotionalSupport }}</p>

                           </div>



                           <!-- 3. 운영 모듈 설계 -->

                           <div class="bg-white p-6 rounded-lg shadow-md">

                               <h3 class="text-xl font-semibold mb-4">3. 운영 모듈 설계</h3>

                               <!-- 교과별 학점당 시수 (전체 너비) -->
                               <div class="mb-6">

                                   <label class="block text-sm font-medium text-gray-700 mb-2">
                                       교과별 학점당 시수 
                                       <span class="text-xs font-normal text-gray-500">(교육과정 편제표의 분류(보통교과/전문교과)별로 학점당 시수를 입력하세요)</span>
                                   </label>
                                   
                                   <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                       <div v-for="category in availableCategories" :key="category" class="mb-3">
                                           <label class="block text-xs font-medium text-gray-600 mb-1">{{ category }}</label>
                                           <input type="number" v-model.number="moduleConfig.hoursPerCreditByCategory[category]" :placeholder="`${category} 학점당 시수`" class="block w-full p-2 border border-gray-300 rounded-md">
                                       </div>
                                   </div>

                               </div>

                               <!-- 연계 비율 입력 (3열 그리드) -->
                               <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">

                                   <div>

                                       <label class="block text-sm font-medium text-gray-700">예방지도 연계 비율 (%)</label>

                                       <input type="number" v-model.number="moduleConfig.preventiveRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

                                   </div>

                                   <div>

                                       <label class="block text-sm font-medium text-gray-700">정서지원 프로그램 연계 비율 (%)</label>

                                       <input type="number" v-model.number="moduleConfig.emotionalSupportRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

                                   </div>

                                   <div>

                                       <label class="block text-sm font-medium text-gray-700">학습지원대상자 예방지도 인정비율 (%)</label>

                                       <input type="number" v-model.number="moduleConfig.specialPreventiveRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

                                   </div>

                               </div>

                               <h4 class="text-lg font-semibold mt-6 mb-2">항목별 인정시수 (1회 기준)</h4>

                               <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

                                   <div v-for="(item, index) in moduleConfig.recognizedHours" :key="index">

                                       <label class="block text-sm font-medium text-gray-700">{{ item.name }}</label>

                                       <input type="number" step="0.1" v-model.number="item.hours" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

                                   </div>

                               </div>

                               <button @click="saveModuleConfig" class="mt-6 px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">운영 모듈 저장</button>

                                <p v-if="moduleConfigStatus" class="mt-2 text-sm font-medium text-green-600">{{ moduleConfigStatus }}</p>

                           </div>



                           <!-- 4. 대상자 선정 -->

                           <div class="bg-white p-6 rounded-lg shadow-md">

                               <h3 class="text-xl font-semibold mb-4">4. 대상자 선정</h3>

                               <div class="flex flex-wrap gap-3 items-center">
                                   <input type="file" @change="processGradeFiles" multiple class="hidden" id="grade-upload">

                                   <label for="grade-upload" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">성적 파일 업로드 (복수 선택 가능)</label>

                                   <button @click="showAttendanceModal = true" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition">출석률 미도달 학생 입력</button>

                                   <button @click="resetUnderachieverList" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">미도달 명단 초기화</button>
                               </div>

                               <p v-if="fileProcessingError" class="mt-2 text-sm font-medium text-red-500">{{ fileProcessingError }}</p>



                               <div v-if="underachievers.length > 0" class="mt-6">

                                   <h4 class="text-lg font-semibold mb-2">학업성취율/출석률 미도달 학생 현황 (처리 결과)</h4>

                                   <div class="overflow-x-auto">

                                       <table class="min-w-full" id="underachievers-table" style="min-width: 1150px;">

                                           <thead class="bg-gray-50">

                                               <tr>

                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">학번</th>

                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이름</th>

                                                   <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">특기사항</th>

                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">미도달내역</th>

                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider table-wide-cell">미도달 과목(학점수)</th>

                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">보충지도(추가학습) 내역</th>

                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider table-exception-cell">예외처리</th>

                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">조치</th>

                                               </tr>

                                           </thead>

                                           <tbody v-for="student in groupedUnderachievers" :key="student.id" class="bg-white">

                                               <tr v-for="(detail, detailIndex) in student.details" :key="student.id + detail.reason + detailIndex">

                                                   <td v-if="detailIndex === 0" :rowspan="student.details.length" class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ student.id }}</td>

                                                   <td v-if="detailIndex === 0" :rowspan="student.details.length" class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ student.name }}</td>

                                                   <td v-if="detailIndex === 0" :rowspan="student.details.length" class="px-3 py-4 whitespace-nowrap align-top border-b border-gray-200 text-xs">{{ student.specialNotes }}</td>

                                                   <td class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ detail.reason }}</td>

                                                        <td class="px-6 py-4 whitespace-normal align-top border-b border-gray-200 table-wide-cell">
                                                            <div v-if="detail.category" class="text-xs text-gray-500 mb-1">{{ detail.category }}</div>
                                                            <div>{{ detail.subjects }}</div>
                                                        </td>

                                                   <td class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ detail.lessonDetails }}</td>

                                                       <td v-if="detailIndex === 0" :rowspan="student.details.length" class="px-6 py-4 whitespace-normal align-top border-b border-gray-200 table-exception-cell">

                                                           <div class="space-y-2">

                                                               <select

                                                                   class="border border-gray-300 rounded-md text-sm px-3 py-1.5 bg-white focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"

                                                                   :value="getStudentExceptionReason(student.id)"

                                                                   @change="updateStudentExceptionReason(student.id, $event.target.value)"

                                                               >

                                                                   <option value="">예외처리 없음</option>

                                                                   <option v-for="option in exceptionOptions" :key="option.value" :value="option.value">{{ option.label }}</option>

                                                               </select>

                                                               <p class="text-xs text-gray-600" v-if="getStudentExceptionReason(student.id)">선택된 사유: {{ getStudentExceptionReason(student.id) }}</p>

                                                               <p class="text-xs text-gray-500" v-else>학생이 예외처리 대상이 아니면 '예외처리 없음'으로 두세요.</p>

                                                           </div>

                                                       </td>

                                                   <td v-if="detailIndex === 0" :rowspan="student.details.length" class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200 text-sm font-medium">

                                                       <button @click="deleteDetailGroup(student.details[0])" class="text-red-600 hover:text-red-900">삭제</button>

                                                   </td>

                                               </tr>

                                           </tbody>

                                       </table>

                                   </div>

                                   <div class="mt-6 flex justify-end items-center space-x-4">

                                       <div class="relative">

                                           <button @click="toggleExportOptions" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">내보내기</button>

                                           <div v-if="showExportOptions" class="absolute right-0 bottom-full mb-2 w-48 bg-white rounded-md shadow-lg z-20">

                                               <a href="#" @click.prevent="exportTable('pdf')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">PDF로 저장</a>

                                               <a href="#" @click.prevent="exportTable('xlsx')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">XLSX 파일</a>

                                               <a href="#" @click.prevent="exportTable('csv')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CSV (Google Sheets용)</a>

                                           </div>

                                       </div>

                                       <button @click="saveUnderachieversToLocalStorage" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">미도달 대상자 저장하기</button>
                                       <button @click="openUnderachieverExportModal" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">명단 확정 및 내보내기</button>
                                   </div>

                                   <p v-if="underachieversStatus" class="mt-2 text-right text-sm font-medium text-green-600">{{ underachieversStatus }}</p>

                               </div>

                           </div>


                           <!-- 미도달 대상자 엑셀 내보내기 모달 -->
                           <div v-if="showUnderachieverExportModal" class="modal-overlay">
                               <div class="modal-content">
                                   <h3 class="text-xl font-semibold mb-4">미도달 대상자 명단 내보내기</h3>
                                   <p class="text-sm text-gray-600 mb-4">성적/출석 기반으로 계산된 현재 미도달 대상자 명단을 엑셀 파일로 저장합니다.</p>
                                   <div class="space-y-4">
                                       <div>
                                           <label class="block text-sm font-medium text-gray-700 mb-1">내보내기 범위</label>
                                           <div class="flex items-center space-x-4">
                                               <label class="inline-flex items-center">
                                                   <input type="radio" class="mr-2" value="all" v-model="underachieverExportMode">
                                                   <span>모든 과목</span>
                                               </label>
                                               <label class="inline-flex items-center">
                                                   <input type="radio" class="mr-2" value="bySubject" v-model="underachieverExportMode">
                                                   <span>과목별</span>
                                               </label>
                                           </div>
                                       </div>
                                       <div v-if="underachieverExportMode === 'bySubject'">
                                           <label class="block text-sm font-medium text-gray-700 mb-1">과목 선택</label>
                                           <select v-model="underachieverExportSubject" class="w-full p-2 border border-gray-300 rounded-md">
                                               <option value="">과목을 선택하세요</option>
                                               <option v-for="subject in underachieverExportSubjects" :key="subject" :value="subject">
                                                   {{ subject }}
                                               </option>
                                           </select>
                                           <p class="mt-1 text-xs text-gray-500">현재 미도달 대상자의 미도달 과목 목록에서 중복 제외 후 추출한 과목입니다.</p>
                                       </div>
                                   </div>
                                   <div class="mt-6 flex justify-end space-x-2">
                                       <button @click="closeUnderachieverExportModal" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100">취소</button>
                                       <button @click="exportUnderachieversToExcel" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">엑셀 파일 다운로드</button>
                                   </div>
                               </div>
                           </div>


                           <!-- 5. 가정통신문 및 서약서 양식 관리 -->

                           <div class="bg-white p-6 rounded-lg shadow-md">

                               <h3 class="text-xl font-semibold mb-4">5. 가정통신문 및 서약서 양식 관리</h3>

                               <div class="flex border-b">

                                   <button class="tab-button" :class="{ 'active': adminFormTab === 'newsletter' }" @click="adminFormTab = 'newsletter'">가정통신문</button>

                                   <button class="tab-button" :class="{ 'active': adminFormTab === 'pledge' }" @click="adminFormTab = 'pledge'">서약서</button>

                               </div>



                               <!-- 가정통신문 폼 -->

                               <div v-if="adminFormTab === 'newsletter'" class="mt-6 space-y-4">

                                   <input type="text" v-model="newsletterForm.title" placeholder="제목" class="w-full p-2 border rounded">

                                   <input type="text" v-model="newsletterForm.docNumber" placeholder="문서 번호 (예: 한국고 2025-00호)" class="w-full p-2 border rounded">

                                   <input type="text" v-model="newsletterForm.department" placeholder="담당 부서 및 연락처" class="w-full p-2 border rounded">

                                   <div>

                                       <label class="block text-sm font-medium text-gray-700">학교 로고 이미지</label>

                                       <input type="file" @change="handleImageUpload($event, 'newsletter', 'logoUrl')" accept="image/*" class="w-full">

                                   <div v-if="newsletterForm.logoUrl" class="mt-2 relative inline-block">

                                        <img :src="newsletterForm.logoUrl" alt="로고 미리보기" class="h-16 object-contain border rounded">

                                        <button type="button" @click="removeImage('newsletter', 'logoUrl')" class="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-black bg-opacity-60 text-white flex items-center justify-center text-sm hover:bg-opacity-80" aria-label="로고 삭제">×</button>

                                   </div>

                                   </div>

                                   <textarea v-model="newsletterForm.body" placeholder="본문 내용" rows="10" class="w-full p-2 border rounded"></textarea>

                                   <input type="text" v-model="newsletterForm.dispatchDate" placeholder="발송일 (예: 2025.7.14.)" class="w-full p-2 border rounded">

                                   <div class="flex items-center space-x-2">

                                       <input type="checkbox" v-model="newsletterForm.includeSeal" id="newsletterSealCheck">

                                       <label for="newsletterSealCheck">학교장 날인 포함</label>

                                   </div>

                                   <div v-if="newsletterForm.includeSeal">

                                       <label class="block text-sm font-medium text-gray-700">학교장 날인 이미지</label>

                                       <input type="file" @change="handleImageUpload($event, 'newsletter', 'sealUrl')" accept="image/*" class="w-full">

                                       <div v-if="newsletterForm.sealUrl" class="mt-2 relative inline-block">

                                            <img :src="newsletterForm.sealUrl" alt="날인 미리보기" class="h-16 object-contain border rounded">

                                            <button type="button" @click="removeImage('newsletter', 'sealUrl')" class="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-black bg-opacity-60 text-white flex items-center justify-center text-sm hover:bg-opacity-80" aria-label="날인 삭제">×</button>

                                       </div>

                                   </div>

                                   <div class="flex space-x-2">

                                       <button @click="previewFormAdmin('newsletter')" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">미리보기 및 출력</button>

                                        <button @click="saveFormTemplates" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">양식 저장</button>

                                   </div>

                               </div>



                               <!-- 서약서 폼 -->

                                <div v-if="adminFormTab === 'pledge'" class="mt-6 space-y-4">

                                    <textarea v-model="pledgeForm.content" placeholder="서약서 동의 내용" rows="10" class="w-full p-2 border rounded"></textarea>

                                    <input type="text" v-model="pledgeForm.dispatchDate" placeholder="서약일 (예: 2025.7.14.)" class="w-full p-2 border rounded">

                                    <div class="flex items-center space-x-2">

                                        <input type="checkbox" v-model="pledgeForm.includeSeal" id="pledgeSealCheck">

                                        <label for="pledgeSealCheck">학교장 날인 포함</label>

                                    </div>

                                    <div v-if="pledgeForm.includeSeal">

                                        <label class="block text-sm font-medium text-gray-700">학교장 날인 이미지</label>

                                        <input type="file" @change="handleImageUpload($event, 'pledge', 'sealUrl')" accept="image/*" class="w-full">

                                         <img v-if="pledgeForm.sealUrl" :src="pledgeForm.sealUrl" alt="날인 미리보기" class="mt-2 h-16 object-contain">

                                    </div>

                                    <div class="flex space-x-2">

                                       <button @click="previewFormAdmin('pledge')" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">미리보기 및 출력</button>

                                        <button @click="saveFormTemplates" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">양식 저장</button>

                                    </div>

                                </div>

                           </div>

                       </div>

                 </div>



                <!-- Teacher View -->

                 <div v-if="role === '교과교사' && schoolId">

                      <h2 class="text-3xl font-bold text-gray-800 mb-6">교과교사 대시보드 (학교코드: {{ currentSchoolCode || schoolId || '미설정' }})</h2>

                      
                      
                      <!-- 과목 카드 뷰 (초기 화면) -->

                      <div v-if="teacherViewMode === 'cards' || (teacherViewMode !== 'dropdown' && currentSubjectIndex < 0)" class="mb-8">

                          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">

                              <!-- 과목 카드들 -->

                              <div 

                                  v-for="(plan, index) in teacherPlanList" 

                                  :key="index"

                                  @click="selectSubjectFromCard(index)"

                                  class="subject-card bg-white rounded-lg shadow-lg p-6 cursor-pointer transition-all duration-300 hover:shadow-purple-300 hover:shadow-2xl hover:-translate-y-2 border-2 border-gray-200 hover:border-purple-300"

                                  style="min-height: 280px; display: flex; flex-direction: column; justify-content: space-between;"

                              >

                                  <div>

                                      <h3 class="text-2xl font-bold text-indigo-700 mb-4 text-center">{{ plan.subjectName || '과목명 미입력' }}</h3>

                                      <div class="space-y-2 text-sm text-gray-700">

                                          <p><span class="font-semibold">학년:</span> {{ plan.subjectGrade ? plan.subjectGrade + '학년' : '미입력' }}</p>

                                          <p><span class="font-semibold">학기:</span> {{ plan.subjectSemester ? plan.subjectSemester + '학기' : '미입력' }}</p>

                                          <p><span class="font-semibold">계열:</span> {{ plan.subjectCategory || '미입력' }}</p>

                                          <p><span class="font-semibold">담당교사:</span> {{ plan.teacherNames && plan.teacherNames.length > 0 ? plan.teacherNames.join(', ') : '미입력' }}</p>

                                      </div>

                                  </div>

                                  <div class="mt-4 pt-4 border-t border-gray-200">

                                      <button @click.stop="deleteSubject(index)" class="w-full px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition text-sm">삭제</button>

                                  </div>

                              </div>

                              
                              
                              <!-- 새 과목 추가 카드 -->

                              <div 

                                  @click="addNewSubjectDirectly()"

                                  class="subject-card bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg shadow-lg p-6 cursor-pointer transition-all duration-300 hover:shadow-purple-300 hover:shadow-2xl hover:-translate-y-2 border-2 border-dashed border-purple-300 hover:border-purple-500"

                                  style="min-height: 280px; display: flex; flex-direction: column; justify-content: center; align-items: center;"

                              >

                                  <div class="text-center">

                                      <div class="text-6xl text-purple-400 mb-4">+</div>

                                      <p class="text-lg font-semibold text-purple-700">새 과목 추가</p>

                                  </div>

                              </div>

                          </div>

                      </div>

                      
                      
                      <!-- 드롭다운 뷰 (카드 클릭 후) -->

                      <div v-if="teacherViewMode === 'dropdown'" class="mb-6">

                          <div class="flex items-center space-x-4 mb-6">

                              <label class="text-lg font-semibold text-gray-700">과목 선택:</label>

                              <select 

                                  v-model="currentSubjectIndex" 

                                  @change="switchSubject"

                                  class="px-4 py-2 border border-gray-300 rounded-md text-lg min-w-[300px]"

                              >

                                  <option v-for="(plan, index) in teacherPlanList" :key="index" :value="index">

                                      {{ plan.subjectName }} ({{ plan.subjectGrade ? plan.subjectGrade + '학년' : '' }} {{ plan.subjectSemester ? plan.subjectSemester + '학기' : '' }} {{ plan.subjectSeries || '' }} {{ plan.subjectCategory || '' }})

                                  </option>

                              </select>

                              <button @click="addNewSubjectDirectly()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">+ 새 과목 추가</button>

                              <button @click="returnToCardView()" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition">카드 뷰로 돌아가기</button>

                          </div>

                      </div>

                      
                      
                       <div v-if="teacherViewMode === 'dropdown' && currentSubjectIndex >= 0" class="flex border-b mb-6">

                           <button class="tab-button" :class="{ 'active': teacherTab === 'plan' }" @click="switchTeacherTab('plan')">계획서 작성</button>

                           <button class="tab-button" :class="{ 'active': teacherTab === 'preventive' }" @click="switchTeacherTab('preventive')">예방지도 출석부 & 수업일지</button>

                           <button class="tab-button" :class="{ 'active': teacherTab === 'supplementary' }" @click="switchTeacherTab('supplementary')">보충지도 출석부&수업일지</button>
                           <button class="tab-button" :class="{ 'active': teacherTab === 'additional' }" @click="switchTeacherTab('additional')">추가학습 출석부&수업일지</button>
                       </div>



                       <!-- 계획서 작성 탭 -->

                       <div v-if="teacherViewMode === 'dropdown' && currentSubjectIndex >= 0 && teacherTab === 'plan'" class="space-y-6">

                           <div class="bg-white p-6 rounded-lg shadow-md space-y-4">

                               <div>

                                   <label for="subjectName" class="block text-sm font-medium text-gray-700">과목명</label>

                                   <input type="text" id="subjectName" v-model="teacherPlan.subjectName" @change="handleSubjectChange" placeholder="편제표에 등록된 과목명을 정확히 입력하세요" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

                               </div>

                               <div class="grid grid-cols-2 gap-4">

                                   <div>

                                       <label for="subjectGrade" class="block text-sm font-medium text-gray-700">학년</label>

                                       <select id="subjectGrade" v-model.number="teacherPlan.subjectGrade" @change="handleSubjectChange" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

                                           <option value="">선택</option>

                                           <option :value="1">1학년</option>

                                           <option :value="2">2학년</option>

                                           <option :value="3">3학년</option>

                                       </select>

                                   </div>

                                   <div>

                                       <label for="subjectSemester" class="block text-sm font-medium text-gray-700">학기</label>

                                       <select id="subjectSemester" v-model.number="teacherPlan.subjectSemester" @change="handleSubjectChange" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

                                           <option value="">선택</option>

                                           <option :value="1">1학기</option>

                                           <option :value="2">2학기</option>

                                       </select>

                                   </div>

                               </div>

                               <div class="grid grid-cols-2 gap-4">

                                   <div>

                                       <label for="subjectSeries" class="block text-sm font-medium text-gray-700">계열</label>

                                       <select id="subjectSeries" v-model="teacherPlan.subjectSeries" @change="handleSubjectChange" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

                                           <option value="">선택</option>

                                           <option v-for="series in availableSeries" :key="series" :value="series">{{ series }}</option>

                                       </select>

                                   </div>

                                   <div>

                                       <label for="subjectCategory" class="block text-sm font-medium text-gray-700">분류</label>

                                       <select id="subjectCategory" v-model="teacherPlan.subjectCategory" @change="handleSubjectChange" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

                                           <option value="">선택</option>

                                           <option v-for="category in availableCategories" :key="category" :value="category">{{ category }}</option>

                                       </select>

                                   </div>

                               </div>

                               <!-- 과목 정보 저장 버튼 -->
                               <div class="pt-4 border-t">
                                   <button 
                                       type="button"
                                       @click="validateAndSaveSubject" 
                                       class="w-full px-6 py-3 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition font-medium">
                                       과목 정보 저장
                                   </button>
                                   <p v-if="teacherPlanError" class="mt-2 text-sm text-red-600">{{ teacherPlanError }}</p>
                                   <p v-else-if="teacherPlan.subjectName && !teacherPlan.subjectNotFound" class="mt-2 text-sm text-green-600">✓ 과목 정보가 편제표와 일치합니다.</p>
                               </div>

                               <div>

                                   <label class="block text-sm font-medium text-gray-700">교과교사명</label>

                                   <div v-for="(name, index) in teacherPlan.teacherNames" :key="index" class="flex items-center space-x-2 mt-2">

                                       <input type="text" v-model="teacherPlan.teacherNames[index]" placeholder="교과교사 이름을 입력하세요" class="w-full p-2 border border-gray-300 rounded-md">

                                       <button @click="removeTeacher(index)" v-if="teacherPlan.teacherNames.length > 1" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600">&times;</button>

                                   </div>

                                   <button @click="addTeacher" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 교과교사 추가</button>

                               </div>

                           </div>



                           <div class="bg-white p-6 rounded-lg shadow-md space-y-4">

                               <h3 class="text-lg font-semibold">성취기준 및 최소 성취수준 진술문</h3>

                               <div v-for="(achievement, index) in teacherPlan.achievements" :key="index" class="p-4 border rounded-md space-y-2">

                                   <label class="block text-sm font-medium text-gray-700">성취기준 {{ index + 1 }}</label>

                                   <textarea v-model="achievement.text" class="w-full p-2 border border-gray-300 rounded-md" rows="2"></textarea>

                                   <div class="flex items-center justify-between">

                                       <button @click="generateStatement(index)" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 disabled:bg-gray-400" :disabled="achievement.loading">

                                           <span v-if="!achievement.loading">최소 성취수준 진술문 생성</span>

                                           <span v-else>생성 중...</span>

                                       </button>

                                       <button @click="removeAchievement(index)" class="px-3 py-1.5 bg-red-500 text-white text-sm rounded-md hover:bg-red-600">&times; 삭제</button>

                                   </div>

                                   <div v-if="achievement.statement || achievement.isEditing" class="mt-2 p-3 bg-gray-100 rounded-md">

                                       <div class="flex items-start justify-between mb-2">

                                       <p class="text-sm font-semibold">최소 성취수준 진술문:</p>

                                           <button

                                               v-if="!achievement.isEditing"

                                               type="button"

                                               @click="startEditingStatement(index)"

                                               class="text-indigo-600 hover:text-indigo-800 transition flex items-center space-x-1 text-sm"

                                               aria-label="진술문 수정"

                                           >

                                               <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">

                                                   <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.651-1.652a1.875 1.875 0 112.652 2.652L8.25 18.375 3 21l2.625-5.25L16.862 4.487z" />

                                               </svg>

                                               <span>수정</span>

                                           </button>

                                       </div>

                                       <div v-if="achievement.isEditing" class="space-y-2">

                                           <textarea v-model="achievement.editDraft" rows="3" class="w-full p-2 border border-gray-300 rounded-md text-sm"></textarea>

                                           <div class="flex justify-end space-x-2">

                                               <button type="button" @click="cancelEditingStatement(index)" class="px-3 py-1.5 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">취소</button>

                                               <button type="button" @click="saveEditedStatement(index)" class="px-3 py-1.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">저장</button>

                                           </div>

                                       </div>

                                       <p v-else class="text-sm text-gray-800 whitespace-pre-line">{{ achievement.statement }}</p>

                                   </div>

                               </div>

                               <button @click="addAchievement" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 성취기준 추가</button>

                               <p v-if="teacherPlanError" class="text-red-500 text-sm mt-2">{{ teacherPlanError }}</p>

                           </div>



                           <div class="bg-white p-6 rounded-lg shadow-md space-y-4">

                               <h3 class="text-lg font-semibold">학기말 성적 산출 방법</h3>

                               <div class="flex space-x-4">

                                   <label><input type="radio" v-model="teacherPlan.gradeCalculation" value="추정분할점수"> 추정분할점수</label>

                                   <label><input type="radio" v-model="teacherPlan.gradeCalculation" value="고정분할점수"> 고정분할점수</label>

                               </div>

                           </div>



                           <div class="bg-white p-6 rounded-lg shadow-md space-y-4">

                               <h3 class="text-lg font-semibold">최소 성취수준 미도달 예방 지도 계획</h3>

                               <div class="flex space-x-4">

                                   <label><input type="radio" v-model="teacherPlan.conductPrevention" value="O"> 진행함</label>

                                   <label><input type="radio" v-model="teacherPlan.conductPrevention" value="X"> 진행하지 않음</label>

                               </div>

                               <div v-if="teacherPlan.conductPrevention === 'O'" class="space-y-4 pt-4 border-t">

                                   <div>

                                       <label class="block text-sm font-medium text-gray-700">예방지도 대상자 선정기준</label>

                                       <textarea v-model="teacherPlan.preventionTarget" rows="3" class="mt-1 block w-full p-2 border rounded-md"></textarea>

                                   </div>

                                   <div>

                                       <label class="block text-sm font-medium text-gray-700">예방지도 방법 (복수선택 가능)</label>

                                       <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">

                                           <label v-for="method in moduleConfig.recognizedHours" :key="method.name" class="flex items-center space-x-2">

                                               <input type="checkbox" :value="method.name" v-model="teacherPlan.preventionMethods">

                                               <span>{{ method.name }}</span>

                                           </label>

                                       </div>

                                   </div>

                                   <div>

                                       <label class="block text-sm font-medium text-gray-700">예방지도 운영 기간</label>

                                       <input type="text" class="flatpickr-range mt-1 block w-full p-2 border rounded-md" data-plan-type="prevention" :value="formatDateRange(teacherPlan.preventionPeriod)" @input="updatePeriodFromInput('prevention', $event)">

                                       <p v-if="teacherPlan.preventionPeriod && teacherPlan.preventionPeriod.length >= 2" class="mt-1 text-sm text-gray-600">

                                           {{ formatDateRange(teacherPlan.preventionPeriod) }}

                                       </p>

                                   </div>

                                   <div>

                                       <label class="block text-sm font-medium text-gray-700">차시별 지도 계획</label>

                                       <div v-for="(session, index) in teacherPlan.preventionSessions" :key="index" class="flex items-center space-x-2 mt-2">

                                           <span class="font-semibold">{{ index + 1 }}차시:</span>

                                           <input type="text" v-model="session.plan" class="w-full p-2 border rounded-md" placeholder="지도 계획을 입력하세요">

                                           <button @click="removePreventionSession(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">&times;</button>

                                       </div>

                                       <button @click="addPreventionSession" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 차시 추가</button>

                                   </div>

                               </div>

                           </div>



                           <div class="bg-white p-6 rounded-lg shadow-md space-y-4">

                               <h3 class="text-lg font-semibold">보충 지도 운영 계획</h3>

                               <div>

                                   <label class="block text-sm font-medium text-gray-700">보충지도 방법 (복수선택 가능)</label>

                                   <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">

                                       <label v-for="method in moduleConfig.recognizedHours" :key="method.name" class="flex items-center space-x-2">

                                           <input type="checkbox" :value="method.name" v-model="teacherPlan.supplementaryMethods">

                                           <span>{{ method.name }}</span>

                                       </label>

                                   </div>

                               </div>

                               <div>

                                   <label class="block text-sm font-medium text-gray-700">보충지도 운영 기간</label>

                                   <input type="text" class="flatpickr-range mt-1 block w-full p-2 border rounded-md" data-plan-type="supplementary" :value="formatDateRange(teacherPlan.supplementaryPeriod)" @input="updatePeriodFromInput('supplementary', $event)">

                                   <p v-if="teacherPlan.supplementaryPeriod && teacherPlan.supplementaryPeriod.length >= 2" class="mt-1 text-sm text-gray-600">

                                       {{ formatDateRange(teacherPlan.supplementaryPeriod) }}

                                   </p>

                               </div>

                               <div>

                                   <label class="block text-sm font-medium text-gray-700">차시별 지도 계획 (최대 {{ teacherPlan.maxSupplementaryHours }}차시)</label>

                                   <div v-for="(session, index) in teacherPlan.supplementarySessions" :key="index" class="flex items-center space-x-2 mt-2">

                                       <span class="font-semibold">{{ index + 1 }}차시:</span>

                                       <input type="text" v-model="session.plan" class="w-full p-2 border rounded-md" placeholder="지도 계획을 입력하세요">

                                       <button @click="removeSupplementarySession(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">&times;</button>

                                   </div>

                                   <button @click="addSupplementarySession" :disabled="!teacherPlan.maxSupplementaryHours || teacherPlan.supplementarySessions.length >= teacherPlan.maxSupplementaryHours" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:bg-gray-400">+ 차시 추가</button>

                               </div>

                           </div>



                           <div class="bg-white p-6 rounded-lg shadow-md space-y-4">

                               <h3 class="text-lg font-semibold">추가 학습 운영 계획</h3>

                               <div>

                                   <label class="block text-sm font-medium text-gray-700">추가학습 방법 (복수선택 가능)</label>

                                   <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">

                                       <label v-for="method in moduleConfig.recognizedHours" :key="method.name" class="flex items-center space-x-2">

                                           <input type="checkbox" :value="method.name" v-model="teacherPlan.additionalMethods">

                                           <span>{{ method.name }}</span>

                                       </label>

                                   </div>

                               </div>

                               <div>

                                   <label class="block text-sm font-medium text-gray-700">추가학습 운영 기간</label>

                                   <input type="text" class="flatpickr-range mt-1 block w-full p-2 border rounded-md" data-plan-type="additional" :value="formatDateRange(teacherPlan.additionalPeriod)" @input="updatePeriodFromInput('additional', $event)">

                                   <p v-if="teacherPlan.additionalPeriod && teacherPlan.additionalPeriod.length >= 2" class="mt-1 text-sm text-gray-600">

                                       {{ formatDateRange(teacherPlan.additionalPeriod) }}

                                   </p>

                               </div>

                               <div>

                                   <label class="block text-sm font-medium text-gray-700">
                                       차시별 지도 계획 
                                       <span v-if="teacherPlan.subjectNotFound" class="text-red-600 text-sm font-normal">(해당 과목을 편제표에서 찾을 수 없습니다.)</span>
                                       <span v-else-if="teacherPlan.maxAdditionalHours > 0">(최대 {{ teacherPlan.maxAdditionalHours }}차시)</span>
                                   </label>

                                   <div v-for="(session, index) in teacherPlan.additionalSessions" :key="index" class="flex items-center space-x-2 mt-2">

                                       <span class="font-semibold">{{ index + 1 }}차시:</span>

                                       <input type="text" v-model="session.plan" class="w-full p-2 border rounded-md" placeholder="지도 계획을 입력하세요">

                                       <button @click="removeAdditionalSession(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">&times;</button>

                                   </div>

                                   <button @click="addAdditionalSession" :disabled="!teacherPlan.maxAdditionalHours || teacherPlan.additionalSessions.length >= teacherPlan.maxAdditionalHours" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:bg-gray-400">+ 차시 추가</button>

                               </div>

                           </div>



                           <div class="text-center">

                                <button @click="saveTeacherPlan" class="mt-6 px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">계획안 저장</button>

                               <button @click="generatePlanPreview" class="mt-6 ml-4 px-8 py-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition text-lg">계획안 미리보기</button>

                                <p v-if="teacherPlanStatus" class="mt-2 text-sm text-green-600">{{ teacherPlanStatus }}</p>

                           </div>

                       </div>



                       <!-- 지도 출석부 & 수업일지 -->

                        <div v-if="currentGuidanceData && teacherTab !== 'plan'" class="space-y-8">

                           <div class="bg-white p-6 rounded-lg shadow-md flex justify-between items-start">

                               <h3 class="text-xl font-semibold">{{ teacherTab === 'preventive' ? '예방지도' : teacherTab === 'supplementary' ? '보충지도' : '추가학습' }} 출석부 & 수업일지</h3>
                               <div class="text-right">

                                   <p><strong>과목명:</strong> {{ teacherPlan.subjectName || '미입력' }}</p>

                                   <p><strong>교과교사:</strong> {{ formattedTeacherNames }}</p>

                                   <div class="mt-2 flex space-x-2">

                                       <button @click="generateCompletionStatusPdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">이수현황표 PDF</button>

                                       <button @click="generateAttendancePdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">출석부 PDF</button>

                                       <button @click="generateLessonLogPdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">수업일지 PDF</button>

                                   </div>

                               </div>

                           </div>



                           <!-- 이수현황표 -->

                           <div class="bg-white p-6 rounded-lg shadow-md">

                               <div class="flex justify-between items-center mb-4">

                                   <h4 class="text-lg font-semibold">{{ teacherTab === 'preventive' ? '예방지도' : teacherTab === 'supplementary' ? '보충지도' : '추가학습' }} 이수현황표</h4>
                                   <button v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" @click="exportCompletionStatusExcel" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm font-semibold">
                                       이수현황표 엑셀 다운로드
                                   </button>

                               </div>

                               <div class="overflow-x-auto">

                                   <table class="min-w-full text-sm text-center">

                                       <thead class="bg-gray-50">

                                           <tr>

                                               <th class="p-2 border">학생</th>

                                               <th v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" class="p-2 border">특기사항</th>

                                               <th v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" class="p-2 border">미도달 항목</th>

                                               <th v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" class="p-2 border">예방지도</th>

                                               <th v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" class="p-2 border">정서지원프로그램</th>

                                               <th v-for="rh in moduleConfig.recognizedHours" :key="rh.name" class="p-2 border">{{ rh.name }}</th>

                                               <th class="p-2 border bg-gray-100">총계</th>

                                               <th v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" class="p-2 border bg-gray-100">이수여부</th>

                                               <th v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" class="p-2 border bg-gray-100">비고</th>

                                           </tr>

                                       </thead>

                                       <tbody>

                                           <tr v-for="student in currentGuidanceData.students" :key="student.id">

                                               <td class="p-2 border font-semibold whitespace-nowrap">{{ student.name }} ({{ student.id }})</td>

                                               <td v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" class="p-2 border">

                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].specialNotes : '일반학생' }}

                                               </td>

                                               <td v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" class="p-2 border">{{ student.reason || '과목출석률' }}</td>

                                               <td v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" class="p-2 border">

                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].preventiveHours : 0 }}

                                               </td>

                                               <td v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" class="p-2 border">

                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].emotionalSupportHours : 0 }}

                                               </td>

                                               <td v-for="rh in moduleConfig.recognizedHours" :key="rh.name" class="p-2 border">

                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id][rh.name] : 0 }}

                                               </td>

                                               <td class="p-2 border bg-gray-100 font-bold">

                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].total : 0 }}

                                               </td>

                                               <td v-if="teacherTab === 'supplementary' || teacherTab === 'additional'"

                                                   class="p-2 border font-bold"

                                                   :class="{

                                                       'text-green-600': guidanceCompletionStatus[student.id] && guidanceCompletionStatus[student.id].completionStatus === '이수',

                                                       'text-red-600': guidanceCompletionStatus[student.id] && guidanceCompletionStatus[student.id].completionStatus === '미이수'

                                                   }">

                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].completionStatus : '' }}

                                               </td>

                                               <td v-if="teacherTab === 'supplementary' || teacherTab === 'additional'" class="p-2 border text-sm text-gray-700">
                                                   <div v-if="teacherTab === 'additional'" class="space-y-1">
                                                       <select
                                                           class="w-full border border-gray-300 rounded-md text-xs px-2 py-1 bg-white focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                                                           :value="student.exceptionReason || ''"
                                                           @change="updateAdditionalStudentExceptionReason(student.id, $event.target.value)"
                                                       >
                                                           <option value="">예외처리 없음</option>
                                                           <option v-for="option in exceptionOptions" :key="option.value" :value="option.value">{{ option.label }}</option>
                                                       </select>
                                                       <p class="text-xs text-gray-500" v-if="student.exceptionReason">예외처리: {{ student.exceptionReason }}</p>
                                                   </div>
                                                   <div v-else>
                                                       {{ student.note || '' }}
                                                   </div>
                                               </td>

                                           </tr>

                                            <tr v-if="!currentGuidanceData.students || currentGuidanceData.students.length === 0">

                                               <td :colspan="moduleConfig.recognizedHours.length + (teacherTab === 'supplementary' ? 8 : teacherTab === 'additional' ? 8 : 2)" class="text-center p-4 text-gray-500">학생이 없습니다.</td>

                                           </tr>

                                       </tbody>

                                   </table>

                               </div>

                           </div>



                           <!-- 출석부 -->

                           <div class="bg-white p-6 rounded-lg shadow-md">

                               <h4 class="text-lg font-semibold mb-4">출석부</h4>

                               <div v-if="teacherTab === 'preventive'">

                                   <div class="flex space-x-2 mb-4">

                                       <input type="text" v-model="newGuidanceStudentId" @keyup.enter="addGuidanceStudent(teacherTab)" placeholder="학번 입력 후 Enter" class="p-2 border rounded-md w-48">

                                       <button @click="addGuidanceStudent(teacherTab)" class="px-4 py-2 bg-blue-500 text-white rounded-md">학생 추가</button>

                                   </div>

                                   <p v-if="currentGuidanceData.error" class="text-red-500 text-sm mb-4 -mt-2">{{ currentGuidanceData.error }}</p>

                               </div>

                               <div v-else-if="teacherTab === 'supplementary'" class="mb-4">
                                    <div class="flex space-x-2">

                                       <button @click="showImportModal = true" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition">대상자 업로드</button>
                                        <button @click="resetSupplementaryStudents" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">대상자 초기화</button>

                                    </div>

                                   <p class="mt-2 text-sm text-gray-600">관리자가 내려받아 공유한 미도달 대상자 엑셀 파일을 업로드하여 보충지도 대상자를 생성합니다.</p>
                               </div>
                               <div v-else-if="teacherTab === 'additional'" class="mb-4">
                                   <div class="flex space-x-2">
                                       <input type="text" v-model="newGuidanceStudentId" @keyup.enter="addGuidanceStudent(teacherTab)" placeholder="학번 입력 후 Enter" class="p-2 border rounded-md w-48">
                                       <button @click="addGuidanceStudent(teacherTab)" class="px-4 py-2 bg-blue-500 text-white rounded-md">학생 추가</button>
                                       <button @click="showImportModal = true" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition">대상자 업로드</button>
                                       <button @click="resetAdditionalStudents" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">대상자 초기화</button>
                                   </div>
                                   <p v-if="currentGuidanceData && currentGuidanceData.error" class="text-red-500 text-sm mb-4 -mt-2">{{ currentGuidanceData.error }}</p>
                                   <p class="mt-2 text-sm text-gray-600">과목 출석률 미도달 대상자를 수동으로 추가하거나, 관리자가 내려받아 공유한 미도달 대상자 엑셀 파일을 업로드할 수 있습니다.</p>
                               </div>



                               <div class="relative">

                                   <button @click="scrollAttendance('left', $event)" class="scroll-arrow left">‹</button>

                                   <div class="overflow-x-auto">

                                       <table class="min-w-full text-sm" style="border-collapse: separate; border-spacing: 0;">

                                           <thead>

                                               <tr class="text-center">

                                                   <th class="sticky left-0 bg-gray-100 z-20 p-2 border-y border-l border-gray-300" style="width: 80px; min-width: 80px; max-width: 80px;" align="top">학번</th>

                                                   <th class="sticky bg-gray-100 z-20 p-2 border-y border-l border-r border-gray-300 whitespace-nowrap" style="width: 96px; min-width: 96px; max-width: 96px; left: 80px;" align="top">이름</th>

                                                   <th v-for="(session, index) in currentGuidanceData.sessions" :key="index" class="p-2 border border-gray-300 min-w-[150px] align-top">

                                                       <div class="flex items-center justify-center space-x-2 mb-2">

                                                           <p class="font-bold">{{ index + 1 }}차시</p>

                                                           <button v-if="session.isSaved" @click="toggleSaveSession(session)" title="수정" class="p-1 hover:bg-gray-200 rounded">

                                                               <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>

                                                           </button>

                                                       </div>

                                                       <input type="text" class="flatpickr-single w-full p-1 border rounded text-center text-xs mb-1" placeholder="날짜 선택" :value="session.date" @change="session.date = $event.target.value; saveGuidanceData()" :disabled="session.isSaved">

                                                       <input type="text" class="w-full p-1 border rounded text-center text-xs" placeholder="예: 16:00~17:00" v-model="session.time" @change="saveGuidanceData" :disabled="session.isSaved">

                                                       <button v-if="!session.isSaved" @click="toggleSaveSession(session)" :disabled="!isSessionReadyToSave(session)" class="w-full mt-1 px-2 py-1 text-xs rounded text-white bg-green-500 hover:bg-green-600 disabled:bg-gray-400">저장</button>

                                                   </th>

                                               </tr>

                                           </thead>

                                           <tbody>

                                               <tr v-for="student in currentGuidanceData.students" :key="student.id" class="text-center">

                                                   <td class="sticky left-0 bg-white z-20 p-2 border-l border-b border-gray-300" style="width: 80px; min-width: 80px; max-width: 80px;" align="top">{{ student.id }}</td>

                                                   <td class="sticky bg-white z-20 p-2 border-l border-r border-b border-gray-300 font-semibold whitespace-nowrap" style="width: 96px; min-width: 96px; max-width: 96px; left: 80px;" align="top">

                                                       <div class="flex items-center justify-between">

                                                           <span>{{ student.name }}</span>

                                                           <button v-if="teacherTab === 'preventive' || teacherTab === 'supplementary' || teacherTab === 'additional'" @click="removeGuidanceStudent(teacherTab, student.id)" class="ml-2 text-red-600 hover:text-red-900 font-bold" title="삭제">×</button>

                                                       </div>

                                                   </td>

                                                   <td v-for="(session, index) in currentGuidanceData.sessions" :key="index" class="p-2 border border-gray-300 align-top">

                                                       <select 
                                                           class="w-full p-1 border rounded text-xs" 
                                                           :class="{ 'attendance-dropdown-changed': isAttendanceChanged(session, student.id) }"
                                                           v-model="session.attendance[student.id]" 
                                                           :disabled="session.isSaved">
                                                           <option value="">선택</option>

                                                           <option v-for="rh in moduleConfig.recognizedHours" :key="rh.name" :value="rh.name">{{ rh.name }}</option>

                                                       </select>

                                                   </td>

                                               </tr>

                                               <tr v-if="!currentGuidanceData.students || currentGuidanceData.students.length === 0">

                                                   <td :colspan="(currentGuidanceData.sessions?.length || 0) + 2" class="text-center p-4 border border-gray-300 text-gray-500">학생을 추가해주세요.</td>

                                               </tr>

                                           </tbody>

                                       </table>

                                   </div>

                                   <button @click="scrollAttendance('right', $event)" class="scroll-arrow right">›</button>

                               </div>

                               <div class="mt-4 flex items-center justify-between">

                                   <button @click="addGuidanceSession(teacherTab)" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm">+ 차시 추가</button>

                                   <div class="flex items-center space-x-2">

                                       <button @click="saveGuidanceDataManually('attendance')" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition font-semibold">

                                           출석부 저장

                                       </button>

                                       <p v-if="guidanceDataStatus" class="text-sm font-medium" :class="guidanceDataStatus.includes('완료') ? 'text-green-600' : 'text-red-600'">

                                           {{ guidanceDataStatus }}

                                       </p>

                                   </div>

                               </div>

                           </div>



                           <!-- 수업일지 -->

                           <div class="bg-white p-6 rounded-lg shadow-md">

                               <h4 class="text-lg font-semibold mb-4">수업일지</h4>

                               <div class="mb-6 p-4 border rounded-md bg-gray-50 grid grid-cols-2 gap-4 text-sm">

                                   <div><strong>과목명:</strong> {{ teacherPlan.subjectName || '미입력' }}</div>

                                   <div><strong>운영차시:</strong> {{ savedGuidanceSessions.length }} 차시</div>

                                   <div><strong>지도교사:</strong> {{ formattedTeacherNames }}</div>

                                   <div><strong>운영기간:</strong> {{ guidanceOperationPeriod }}</div>

                               </div>

                               <div class="space-y-2">

                                   <div v-for="(session, index) in savedGuidanceSessions" :key="session.date + index" class="border-b border-gray-200 pb-3 last:border-b-0 last:pb-0">

                                       <div class="flex items-start gap-3 mb-2">

                                           <span class="font-bold text-sm shrink-0">{{ index + 1 }}차시</span>

                                           <div class="flex-1">

                                               <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm mb-2">

                                                   <div class="flex items-center gap-2">

                                                       <span class="font-semibold shrink-0">날짜/시간:</span>

                                                       <span class="text-gray-700">{{ session.date }} / {{ session.time }}</span>

                                           </div>

                                                   <div class="flex items-center gap-2">

                                                       <span class="font-semibold shrink-0">수업방법:</span>

                                                       <span class="text-gray-700">{{ [...new Set(Object.values(session.attendance || {}))].filter(Boolean).join(', ') || '미입력' }}</span>

                                       </div>

                                                   <div class="flex items-center gap-2">

                                                       <label class="font-semibold shrink-0">장소:</label>

                                                       <input type="text" class="flex-1 p-1 border rounded text-sm" v-model="session.place" @change="saveGuidanceData" placeholder="장소 입력">

                                       </div>

                                   </div>

                                               <div>

                                                   <label class="font-semibold text-sm block mb-1">지도내용:</label>

                                                   <textarea 

                                                       class="w-full p-1 border rounded text-sm resize-none" 

                                                       v-model="session.content" 

                                                       @input="handleTextareaResize($event); saveGuidanceData()"

                                                       @change="saveGuidanceData"

                                                       style="min-height: 2rem; line-height: 1.5; height: auto;"

                                                       placeholder="지도내용을 입력하세요"></textarea>

                                               </div>

                                           </div>

                                       </div>

                                   </div>

                                   <p v-if="savedGuidanceSessions.length === 0" class="text-center text-gray-500 py-4">저장된 수업일지가 없습니다.</p>

                               </div>

                               <div class="mt-4 flex items-center justify-end space-x-2">

                                   <button @click="saveGuidanceDataManually('lessonLog')" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition font-semibold">

                                       수업일지 저장

                                   </button>

                                   <p v-if="lessonLogDataStatus" class="text-sm font-medium" :class="lessonLogDataStatus.includes('완료') ? 'text-green-600' : 'text-red-600'">

                                       {{ lessonLogDataStatus }}

                                   </p>

                               </div>

                           </div>

                       </div>

                        <!-- Message when teacher tab is not 'plan' but guidance data isn't ready -->

                        <div v-if="teacherTab !== 'plan' && !teacherPlan.subjectName" class="text-center text-gray-500 mt-10">

                            <p>출석부 및 수업일지를 보려면 먼저 '계획서 작성' 탭에서 과목명을 입력하고 저장해주세요.</p>

                        </div>

                 </div>



                 <!-- Homeroom Teacher View -->

                  <div v-if="role === '담임교사' && schoolId" class="space-y-6">

                     <h2 class="text-3xl font-bold text-gray-800">담임교사 대시보드 (학교코드: {{ currentSchoolCode || schoolId || '미설정' }})</h2>

                      <div class="bg-white p-6 rounded-lg shadow-md">

                          <div class="space-y-4">
                              <div>
                                  <label class="block text-sm font-medium text-gray-700">미도달 대상자 엑셀 업로드</label>
                                  <input type="file" accept=".xlsx,.xls" @change="handleHomeroomUnderachieverUpload" class="mt-1 block w-full text-sm text-gray-700">
                                  <p class="mt-1 text-xs text-gray-500">
                                      관리자가 내보낸 미도달 대상자 엑셀 파일을 업로드한 뒤, 학급 번호를 입력해 조회하세요.
                                  </p>
                              </div>
                          <div class="flex items-end space-x-2">

                              <div class="flex-grow">

                                  <label for="homeroom-class-input" class="block text-sm font-medium text-gray-700">학급 번호 입력</label>

                                  <input id="homeroom-class-input" type="text" v-model="homeroomClassInput" @keyup.enter="searchHomeroomClass" placeholder="예: 101" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

                              </div>

                              <button @click="searchHomeroomClass" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">조회</button>

                          </div>

                          <p v-if="homeroomMessage" class="mt-2 text-sm text-gray-600">{{ homeroomMessage }}</p>

                          </div>
                      </div>



                      <div v-if="processedHomeroomStudents.length > 0" class="bg-white p-6 rounded-lg shadow-md">

                          <h3 class="text-xl font-semibold mb-4">{{ homeroomClassInput }}반 미도달 학생 현황</h3>

                          <div class="overflow-x-auto">

                              <table class="min-w-full text-sm">

                                  <thead class="bg-gray-50">

                                      <tr>

                                          <th class="p-2 border">학번</th>

                                          <th class="p-2 border">이름</th>

                                          <th class="p-2 border">미도달 과목</th>

                                          <th class="p-2 border">미도달 내역</th>

                                          <th class="p-2 border">서류 출력</th>

                                      </tr>

                                  </thead>

                                  <tbody>

                                      <template v-for="(row, index) in processedHomeroomStudents" :key="row.id + row.subject + index">

                                          <tr>

                                              <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="p-2 border align-top text-center">{{ row.id }}</td>

                                              <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="p-2 border align-top text-center">{{ row.name }}</td>

                                              <td class="p-2 border">{{ row.subject }}</td>

                                              <td class="p-2 border text-center">{{ row.reason }}</td>

                                              <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="p-2 border align-top text-center">

                                                  <div class="flex flex-col space-y-2">

                                                      <button @click="printHomeroomStudentForm(row.originalStudent, 'newsletter')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded-md hover:bg-blue-600">가정통신문</button>

                                                      <button @click="printHomeroomStudentForm(row.originalStudent, 'pledge')" class="px-2 py-1 bg-green-500 text-white text-xs rounded-md hover:bg-green-600">서약서</button>

                                                  </div>

                                              </td>

                                          </tr>

                                      </template>

                                  </tbody>

                              </table>

                          </div>

                      </div>

                  </div>

             </div>

        </main>



        <footer class="bg-gray-50 border-t">

            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-xs text-gray-500">

                © 2025 박찬들. 본 웹 애플리케이션의 모든 콘텐츠는 저작권법의 보호를 받습니다.

            </div>

        </footer>



        <!-- Modals -->

        <!-- Attendance Modal (Restored for Admin) -->

         <div v-if="showAttendanceModal" class="modal-overlay" @click.self="closeAttendanceModal">

             <div class="modal-content">

                 <h3 class="text-xl font-bold mb-4">출석률 미도달 학생 추가</h3>

                 <form @submit.prevent="addAttendanceStudent">

                     <div class="space-y-4">

                         <input v-model="newAttendanceStudent.id" placeholder="학번" required class="w-full p-2 border rounded-md">

                         <div class="grid grid-cols-3 gap-4">

                             <div>

                                 <label class="block text-sm font-medium text-gray-700">학년</label>

                                 <select v-model.number="newAttendanceStudent.grade" class="w-full p-2 border rounded-md">

                                     <option value="">선택</option>

                                     <option :value="1">1학년</option>

                                     <option :value="2">2학년</option>

                                     <option :value="3">3학년</option>

                                 </select>

                             </div>

                             <div>

                                 <label class="block text-sm font-medium text-gray-700">학기</label>

                                 <select v-model.number="newAttendanceStudent.semester" class="w-full p-2 border rounded-md">

                                     <option value="">선택</option>

                                     <option :value="1">1학기</option>

                                     <option :value="2">2학기</option>

                                 </select>

                             </div>

                             <div>

                                 <label class="block text-sm font-medium text-gray-700">분류</label>

                                 <select v-model="newAttendanceStudent.category" class="w-full p-2 border rounded-md">

                                     <option value="">선택</option>

                                     <option v-for="category in availableCategories" :key="category" :value="category">{{ category }}</option>

                                 </select>

                             </div>

                         </div>

                         <div v-for="(subject, index) in newAttendanceStudent.subjects" :key="index" class="flex items-center space-x-2">

                             <input v-model="newAttendanceStudent.subjects[index]" placeholder="출석률 미도달 과목" required class="w-full p-2 border rounded-md">

                             <button type="button" v-if="newAttendanceStudent.subjects.length > 1" @click="removeAttendanceSubject(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">-</button>

                         </div>

                          <button type="button" @click="addAttendanceSubject" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+</button>

                     </div>

                     <p v-if="attendanceModalError" class="text-red-500 text-sm mt-2">{{ attendanceModalError }}</p>

                     <div class="mt-6 flex justify-end space-x-2">

                         <button type="button" @click="closeAttendanceModal" class="px-4 py-2 bg-gray-300 rounded-md">취소</button>

                         <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md">추가</button>

                     </div>

                 </form>

             </div>

         </div>





        <!-- Preview Modal -->

        <div v-if="showPreviewModal" class="modal-overlay" @click.self="closePreviewModal">

            <div class="modal-content modal-preview"> <!-- Apply A4-like width -->

                 <!-- Container for printable content -->

                 <div id="print-area-container-in-modal"> <!-- ID for print media query -->

                    <div v-html="previewHtml"></div>

                 </div>

                 <!-- Combined status display -->

                <p v-if="statusText" class="text-sm mt-4 text-center font-semibold no-print-status" :class="statusClass">{{ statusText }}</p>

                <div class="mt-6 mb-4 mr-4 flex justify-end space-x-2 no-print-controls">

                    <button @click="closePreviewModal" class="px-4 py-2 bg-gray-300 rounded-md">닫기</button>

                     <!-- Use window.print() for native PDF generation/printing -->

                     <button @click="printPreviewModalContent" class="px-4 py-2 bg-indigo-600 text-white rounded-md">인쇄 / PDF 저장</button>

                </div>

            </div>

        </div>



         <!-- Import Modal (Teacher - Upload Underachiever Excel) -->
          <div v-if="showImportModal" class="modal-overlay" @click.self="closeImportModal">

             <div class="modal-content">

                 <h3 class="text-xl font-bold mb-4">보충지도 대상자 업로드</h3>
                 <form @submit.prevent="importUnderachievers">

                     <div class="space-y-4">

                         <div>
                         <label class="block text-sm font-medium text-gray-700">과목명</label>

                         <input :value="teacherPlan.subjectName" placeholder="먼저 '계획서 작성' 탭에서 과목명을 입력하세요" required class="w-full p-2 border rounded-md bg-gray-100" disabled>

                         </div>
                         <div class="grid grid-cols-3 gap-4">

                             <div>

                                 <label class="block text-sm font-medium text-gray-700">학년</label>

                                 <input :value="teacherPlan.subjectGrade ? teacherPlan.subjectGrade + '학년' : '미입력'" class="w-full p-2 border rounded-md bg-gray-100" disabled>
                             </div>

                             <div>

                                 <label class="block text-sm font-medium text-gray-700">학기</label>

                                 <input :value="teacherPlan.subjectSemester ? teacherPlan.subjectSemester + '학기' : '미입력'" class="w-full p-2 border rounded-md bg-gray-100" disabled>
                             </div>

                             <div>

                                 <label class="block text-sm font-medium text-gray-700">계열(분류)</label>
                                 <input :value="teacherPlan.subjectCategory || '미입력'" class="w-full p-2 border rounded-md bg-gray-100" disabled>
                             </div>

                         </div>

                         <div>

                             <label class="block text-sm font-medium text-gray-700">학급 (여러 학급 입력 가능, 예: 101, 102)</label>
                             <div class="space-y-2">
                                 <div
                                     v-for="(cls, index) in importClasses"
                                     :key="'import-class-' + index"
                                     class="flex items-center space-x-2"
                                 >
                                     <input
                                         type="text"
                                         v-model="importClasses[index]"
                                         placeholder="예: 101 (1학년 1반), 202 (2학년 2반)"
                                         class="flex-1 p-2 border rounded-md"
                                     >
                                     <button
                                         type="button"
                                         @click="removeImportClassInput(index)"
                                         v-if="importClasses.length > 1"
                                         class="px-2 py-1 bg-red-500 text-white text-xs rounded-md hover:bg-red-600"
                                     >
                                         삭제
                                     </button>
                             </div>

                                 <button
                                     type="button"
                                     @click="addImportClassInput"
                                     class="px-3 py-1 bg-gray-200 text-gray-800 text-xs rounded-md hover:bg-gray-300"
                                 >
                                     + 학급 추가
                                 </button>
                         </div>
                             <p class="mt-1 text-xs text-gray-500">
                                 각 학급 번호는 학생 학번 5자리 중 앞 3자리와 일치해야 합니다. (예: 1학년 1반 = 101)
                             </p>
                     </div>
                         <div>
                             <label class="block text-sm font-medium text-gray-700">미도달 대상자 엑셀 파일</label>
                             <input type="file"
                                    accept=".xlsx,.xls"
                                    @change="handleUnderachieverFileChange"
                                    class="w-full p-2 border rounded-md bg-white">
                             <p class="mt-1 text-xs text-gray-500">
                                 관리자가 '명단 확정 및 내보내기'로 생성한 엑셀 파일을 선택해주세요.
                                 동일 과목의 학생만 보충지도 대상자로 추가됩니다.
                             </p>
                         </div>
                         <div>
                             <p class="text-xs text-gray-500">
                                 이미 등록된 대상자가 있는 상태에서 업로드하면, 중복을 제외한 새로운 학생만 추가됩니다.
                                 대상자를 처음부터 다시 구성하려면 먼저 '대상자 초기화'를 눌러주세요.
                             </p>
                         </div>

                     </div>

                     <p v-if="importModalError" class="text-red-500 text-sm mt-2">{{ importModalError }}</p>

                     <div class="mt-6 flex justify-end space-x-2">

                         <button type="button" @click="closeImportModal" class="px-4 py-2 bg-gray-300 rounded-md">취소</button>

                         <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md" :disabled="!teacherPlan.subjectName || !selectedUnderachieverFile">업로드</button>
                     </div>

                 </form>

             </div>

         </div>



        <!-- NEW: Admin Modify Modal (SchoolId & Admin Code) -->

        <div v-if="showAdminModifyModal" class="modal-overlay" @click.self="showAdminModifyModal = false">

            <div class="modal-content">

                <h3 class="text-2xl font-bold mb-4 text-center">학교 코드 수정 및 발급</h3>

                <div class="mb-4">

                    <label for="modify-mode" class="block text-sm font-medium text-gray-700">수정 항목</label>

                    <select id="modify-mode" v-model="adminModifyMode" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

                        <option value="schoolCode">학교코드</option>

                        <option value="adminCode">관리자 코드</option>

                    </select>

                </div>



                <!-- 학교코드 수정 -->

                <div v-if="adminModifyMode === 'schoolCode'">

                    <p class="text-sm text-gray-600 mb-2">현재 발급 중인 학교코드: <strong class="text-indigo-600">{{ currentSchoolCode || '설정되지 않음' }}</strong></p>

                    <p class="text-sm text-gray-600 mb-2">새로운 학교코드를 입력하면 기존 코드가 즉시 대체됩니다. <br/> <strong class="text-red-600">주의: 변경 후에는 새 코드를 교사들에게 즉시 공유해야 합니다.</strong></p>

                    <input type="text" v-model="newSchoolIdForModify" placeholder="새 학교코드 입력" class="w-full p-3 border border-gray-300 rounded-md">

                </div>

                
                
                <!-- 관리자 코드 확인 -->

                <div v-if="adminModifyMode === 'adminCode'">

                    <p class="text-sm text-gray-600 mb-2">현재 앱의 관리자 코드는 <strong class="text-indigo-600">'0822'</strong> 입니다.</p>

                    <p class="text-sm text-gray-600 mb-2">이 코드는 앱에 고정되어 있으며, 모든 학교 관리자가 동일하게 사용합니다. (변경 불가)</p>

                </div>



                <p v-if="adminModifyError" class="text-red-500 text-sm mt-2">{{ adminModifyError }}</p>

                
                
                <div class="mt-6 flex justify-end space-x-2">

                    <button type="button" @click="showAdminModifyModal = false" class="px-4 py-2 bg-gray-300 rounded-md">닫기</button>

                    <button v-if="adminModifyMode === 'schoolCode'" type="button" @click="saveAdminSchoolIdModification" class="px-4 py-2 bg-indigo-600 text-white rounded-md">학교코드 저장</button>

                </div>

            </div>

        </div>    

        
        
        <!-- Statistics Dashboard Modal -->

        <div v-if="showStatisticsModal" class="modal-overlay" @click.self="closeStatisticsModal">

            <div class="modal-content modal-large">

                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mb-4">

                    <div>

                        <h3 class="text-2xl font-bold text-gray-900">통계 대시보드</h3>

                        <p v-if="statisticsState.lastUpdated" class="text-sm text-gray-500 mt-1">

                            최종 계산 시각: {{ statisticsState.lastUpdated }}

                        </p>

                    </div>

                    <div class="flex items-center gap-2">
                    <button
                            @click="resetStatisticsDashboard"
                            class="px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition text-xs font-semibold"
                        >
                            통계 초기화
                        </button>
                    <button

                        @click="closeStatisticsModal"

                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition text-sm font-semibold"

                    >

                        닫기

                    </button>

                </div>
                </div>

                <!-- 학년/학기별 필터 -->

                <div class="mb-6 p-4 bg-gray-50 rounded-lg">

                    <h4 class="text-sm font-semibold text-gray-700 mb-3">학년/학기별 필터</h4>

                    <div class="flex flex-wrap gap-2">

                        <button

                            v-for="filter in statisticsFilters"

                            :key="filter.key"

                            @click="selectedStatisticsFilter = filter.key"

                            :class="[

                                'px-4 py-2 rounded-md text-sm font-medium transition',

                                selectedStatisticsFilter === filter.key

                                    ? 'bg-indigo-600 text-white'

                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'

                            ]"

                        >

                            {{ filter.label }}

                        </button>

                    </div>

                </div>

                <div v-if="statisticsState.loading" class="py-12 text-center text-sm text-gray-600">

                    통계를 계산 중입니다. 잠시만 기다려주세요...

                </div>

                <div v-else>

                    <p v-if="statisticsState.error" class="mb-4 text-sm text-red-600">{{ statisticsState.error }}</p>

                    <div class="mb-4 p-4 border rounded-lg bg-white">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">교과별 이수현황 엑셀 업로드</h4>
                        <input
                            type="file"
                            multiple
                            accept=".xlsx,.xls"
                            @change="handleCompletionExcelUpload"
                            class="block w-full text-sm text-gray-700"
                        >
                        <p class="mt-1 text-xs text-gray-500">
                            교과교사가 다운로드한 이수현황표 엑셀 파일들을 한 번에 선택하여 업로드하면,
                            아래 통계가 해당 데이터 기준으로 다시 계산됩니다.
                        </p>
                    </div>
                    <div class="space-y-8 max-h-[70vh] overflow-y-auto pr-2">

                        <section>

                            <h4 class="stats-section-title">과목별 이수 현황 요약</h4>

                            <table class="stats-table">

                                <thead>

                                    <tr>

                                        <th>과목</th>

                                        <th>학점</th>

                                        <th>학업성취율 미도달</th>

                                        <th>과목출석률 미도달</th>

                                        <th>예외처리 인원</th>

                                        <th>미이수</th>

                                        <th>이수</th>

                                    </tr>

                                </thead>

                                <tbody>

                                    <tr v-for="row in filteredSubjectSummary" :key="`${row.subjectName}-${row.category || ''}-${row.credits || 0}`">
                                        <td>{{ row.displayName || row.subjectName }}{{ row.category ? ' (' + row.category + ')' : '' }}</td>
                                        <td>{{ row.credits }}</td>

                                        <td>{{ row.gradeCount }}</td>

                                        <td>{{ row.attendanceCount }}</td>

                                        <td>{{ row.exceptionCount }}</td>

                                        <td>{{ row.incompleteCount }}</td>

                                        <td>{{ row.completeCount }}</td>

                                    </tr>

                                    <tr v-if="filteredSubjectSummary.length === 0">

                                        <td colspan="7">표시할 데이터가 없습니다.</td>

                                    </tr>

                                </tbody>

                            </table>

                        </section>



                        <section>

                            <h4 class="stats-section-title">과목별 예방지도 참여 현황</h4>

                            <table class="stats-table">

                                <thead>

                                    <tr>

                                        <th>과목</th>

                                        <th>진행 여부</th>

                                        <th>참여 인원</th>

                                        <th>미참여 인원</th>

                                    </tr>

                                </thead>

                                <tbody>

                                    <tr v-for="row in filteredPreventionSummary" :key="`${row.subjectName}-${row.category || ''}-${row.credits || 0}`">
                                        <td>{{ row.displayName || row.subjectName }}{{ row.category ? ' (' + row.category + ')' : '' }}</td>
                                        <td>{{ row.hasPrevention ? '진행함' : '미진행' }}</td>
                                        <td>{{ row.participants }}</td>

                                        <td>{{ row.nonParticipants }}</td>

                                    </tr>

                                    <tr v-if="filteredPreventionSummary.length === 0">

                                        <td colspan="4">표시할 데이터가 없습니다.</td>

                                    </tr>

                                </tbody>

                            </table>

                        </section>



                        <section>

                            <h4 class="stats-section-title">과목별 추가학습 참여 현황</h4>

                            <table class="stats-table">

                                <thead>

                                    <tr>

                                        <th>과목</th>

                                        <th>학점</th>

                                        <th>추가학습 대상(과목출석률)</th>

                                        <th>추가학습 참여 인원</th>

                                        <th>미참여 인원</th>

                                        <th>예외처리 인원</th>

                                        <th>미이수</th>

                                        <th>이수</th>

                                    </tr>

                                </thead>

                                <tbody>

                                    <tr v-for="row in filteredAdditionalSummary" :key="`${row.subjectName}-${row.category || ''}-${row.credits || 0}`">
                                        <td>{{ row.displayName || row.subjectName }}{{ row.category ? ' (' + row.category + ')' : '' }}</td>
                                        <td>{{ row.credits }}</td>

                                        <td>{{ row.attendanceTargets }}</td>

                                        <td>{{ row.participants }}</td>

                                        <td>{{ row.nonParticipants }}</td>

                                        <td>{{ row.exceptionCount }}</td>

                                        <td>{{ row.incompleteCount }}</td>

                                        <td>{{ row.completeCount }}</td>

                                    </tr>

                                    <tr v-if="filteredAdditionalSummary.length === 0">

                                        <td colspan="8">표시할 데이터가 없습니다.</td>

                                    </tr>

                                </tbody>

                            </table>

                        </section>



                        <section>

                            <h4 class="stats-section-title">과목별 보충지도(학업성취율) 참여 현황</h4>

                            <table class="stats-table">

                                <thead>

                                    <tr>

                                        <th>과목</th>

                                        <th>학점</th>

                                        <th>보충지도 대상(학업성취율)</th>

                                        <th>보충지도 참여 인원</th>

                                        <th>미참여 인원</th>

                                        <th>예외처리 인원</th>

                                        <th>미이수</th>

                                        <th>이수</th>

                                    </tr>

                                </thead>

                                <tbody>

                                    <tr v-for="row in filteredRemedialSummary" :key="`${row.subjectName}-${row.category || ''}-${row.credits || 0}`">
                                        <td>{{ row.displayName || row.subjectName }}{{ row.category ? ' (' + row.category + ')' : '' }}</td>
                                        <td>{{ row.credits }}</td>

                                        <td>{{ row.gradeTargets }}</td>

                                        <td>{{ row.participants }}</td>

                                        <td>{{ row.nonParticipants }}</td>

                                        <td>{{ row.exceptionCount }}</td>

                                        <td>{{ row.incompleteCount }}</td>

                                        <td>{{ row.completeCount }}</td>

                                    </tr>

                                    <tr v-if="filteredRemedialSummary.length === 0">

                                        <td colspan="8">표시할 데이터가 없습니다.</td>

                                    </tr>

                                </tbody>

                            </table>

                        </section>



                        <section>

                            <h4 class="stats-section-title">과목별 미도달 유형 분포</h4>

                            <table class="stats-table">

                                <thead>

                                    <tr>

                                        <th>과목</th>

                                        <th>학업성취율 미도달</th>

                                        <th>과목출석률 미도달</th>

                                        <th>둘 다 미도달</th>

                                    </tr>

                                </thead>

                                <tbody>

                                    <tr v-for="row in filteredDeficitSummary" :key="`${row.subjectName}-${row.category || ''}`">

                                        <td>{{ row.subjectName }}{{ row.category ? ' (' + row.category + ')' : '' }}</td>

                                        <td>{{ row.gradeCount }}</td>

                                        <td>{{ row.attendanceCount }}</td>

                                        <td>{{ row.bothCount }}</td>

                                    </tr>

                                    <tr v-if="filteredDeficitSummary.length === 0">

                                        <td colspan="4">표시할 데이터가 없습니다.</td>

                                    </tr>

                                </tbody>

                            </table>

                        </section>



                        <section>

                            <h4 class="stats-section-title">다과목 미도달 학생 수</h4>
                            <table class="stats-table">

                                <thead>

                                    <tr>

                                        <th>구분</th>

                                        <th>학생 수</th>

                                    </tr>

                                </thead>

                                <tbody>

                                    <tr v-for="bucket in statisticsState.multiSubjectBuckets" :key="bucket.label">

                                        <td>{{ bucket.label }}</td>

                                        <td>{{ bucket.count }}</td>

                                    </tr>

                                    <tr v-if="statisticsState.multiSubjectBuckets.length === 0">

                                        <td colspan="2">표시할 데이터가 없습니다.</td>

                                    </tr>

                                </tbody>

                            </table>

                        </section>





                    </div>

                </div>

            </div>

        </div>    

        
        
        <!-- 인쇄용 컨테이너 (숨김 - html2canvas 전용) -->

        <div id="print-area-container" class="hidden"></div>



    </div>

    <script type="module">

        // Vue 3 CDN

        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

        // Firebase SDK Imports

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, writeBatch, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";



        const createEmptyAchievement = () => ({

            text: '',

            statement: '',

            loading: false,

            isEditing: false,

            editDraft: ''

        });

        
        
        // --- Firebase Configuration ---

        const firebaseConfig = {

            apiKey: "AIzaSyD_KHsc9Izjj38b44-2GcH1YDKoQ9Sek1k",

            authDomain: "min-achievement-app-184d2.firebaseapp.com",

            projectId: "min-achievement-app-184d2",

            storageBucket: "min-achievement-app-184d2.appspot.com",

            messagingSenderId: "177231838739",

            appId: "1:177231838739:web:7e2f2b2cf20d8e4e2949e6",

            measurementId: "G-4GT4CZRPXB"

        };



        // --- [수정] Initialize Firebase and then mount Vue App ---

        try {

            const firebaseApp = initializeApp(firebaseConfig);

            const auth = getAuth(firebaseApp);

            const db = getFirestore(firebaseApp);

            console.log("Firebase initialized successfully.");



            // Firebase 초기화 성공 후 Vue 앱 마운트

            createApp({

                data() {

                    return {

                        // --- Authentication State ---

                        user: null,

                        isLoggedIn: false,

                        isLoading: true,



                        // --- Role Management State ---

                        role: null,

                        schoolId: null,

                        currentSchoolCode: '',

                        previousRole: null,

                        previousSchoolId: null,

                        previousSchoolCode: '',

                        showAdminCodeInput: false,

                        adminCode: '',

                        adminCodeError: '',

                        showSchoolIdModal: false,

                        schoolIdMode: 'join',

                        newSchoolId: '',

                        schoolIdError: '',



                        // --- UI State ---

                        teacherTab: 'plan',

                        adminFormTab: 'newsletter',

                        uploadStatus: { curriculum: '', student: '', emotionalSupport: '' },

                        statusMessage: '',

                        moduleConfigStatus: '',

                        underachieversStatus: '',

                        teacherPlanStatus: '',

                        adminActionStatus: '',

                        guidanceDataStatus: '', // 출석부 저장 상태

                        lessonLogDataStatus: '', // 수업일지 저장 상태

                        // --- Admin Modify Modal State ---

                        showAdminModifyModal: false,

                        adminModifyMode: 'schoolCode',

                        newSchoolIdForModify: '',

                        adminModifyError: '',

                        
                        
                        // --- Common Data (Loaded from Firestore) ---

                        moduleConfig: {

                            hoursPerCreditByCategory: {},

                            preventiveRatio: 50,

                            emotionalSupportRatio: 20,

                            specialPreventiveRatio: 30,

                            recognizedHours: [

                                { name: '수업시간별도지도', hours: 1 }, { name: '온라인콘텐츠수강', hours: 1 },

                                { name: 'RunUP과정수강', hours: 1 }, { name: '학습멘토링', hours: 1 },

                                { name: '대면지도', hours: 1 }, { name: '보충과제부여', hours: 1 }

                            ]

                        },

                        newsletterForm: {

                            title: '최소 성취수준 보장지도 참여 안내', docNumber: '교무기획부-000', department: '담당부서 (연락처)',

                            logoUrl: null, body: '학부모님, 안녕하십니까?\n\n귀 자녀는 다음과 같은 사유로 최소 성취수준 보장지도 대상자로 선정되었음을 알려드립니다. 본교에서는 학생의 학업 능력 향상을 위해 보충 학습 프로그램을 운영하고 있으니, 학생이 프로그램에 성실히 참여할 수 있도록 가정에서도 많은 격려와 지도 부탁드립니다.\n\n[대상 학생 정보는 하단 참조]', dispatchDate: 'YYYY.MM.DD.', includeSeal: false, sealUrl: null

                        },

                        pledgeForm: {

                            content: '본인은 최소 성취수준 보장지도 프로그램의 모든 활동에 성실하게 참여할 것을 서약합니다.\n\n[대상 학생 정보는 하단 참조]', dispatchDate: 'YYYY.MM.DD.', includeSeal: false, sealUrl: null

                        },

                        curriculumData: [],

                        studentData: [],

                        emotionalSupportData: [],

                        deployedUnderachievers: [],



                        // --- Admin Specific Local State ---

                        underachievers: [],

                        showUnderachieverExportModal: false,
                        underachieverExportMode: 'all',
                        underachieverExportSubject: '',
                        underachieverExportSubjects: [],
                        exceptionOptions: [

                            { value: '특수교육대상', label: '특수교육대상' },

                            { value: '위탁학생', label: '위탁학생' },

                            { value: '중장기적 정기적인 병원진료', label: '중장기적 정기적인 병원진료' }

                        ],

                        showStatisticsModal: false,

                        selectedStatisticsFilter: 'all',

                        statisticsFilters: [

                            { key: 'all', label: '전체' },

                            { key: '1-1', label: '1학년 1학기' },

                            { key: '1-2', label: '1학년 2학기' },

                            { key: '2-1', label: '2학년 1학기' },

                            { key: '2-2', label: '2학년 2학기' },

                            { key: '3-1', label: '3학년 1학기' },

                            { key: '3-2', label: '3학년 2학기' }

                        ],

                        statisticsState: {

                            loading: false,

                            error: '',

                            subjectSummary: [],

                            preventionSummary: [],

                            additionalSummary: [],

                            remedialSummary: [],

                            deficitSummary: [],

                            multiSubjectBuckets: [],

                            gradePreventionRatios: [],

                            preventionCourseRatio: { totalSubjects: 0, activeSubjects: 0, percentage: 0 },

                            lastUpdated: '',

                            allData: {

                                subjectSummary: [],

                                preventionSummary: [],

                                additionalSummary: [],

                                remedialSummary: [],

                                deficitSummary: []

                            }

                        },

                        completionExcelData: [],
                        fileProcessingError: '',

                        showAttendanceModal: false,

                        newAttendanceStudent: { id: '', subjects: [''], grade: null, semester: null, category: '' },

                        attendanceModalError: '',

                        homeroomUnderachieverRows: [],
                        homeroomUnderachieverRows: [],
                        showExportOptions: false,



                        // --- Teacher Specific State ---

                        showImportModal: false,

                        importClasses: [''],

                        importGrade: null,

                        importSemester: null,

                        importCategory: '',

                        importModalError: '',

                        selectedUnderachieverFile: null,
                        // --- Multi-Subject Management ---

                        teacherPlanList: [], // 여러 과목의 계획서 배열

                        teacherGuidanceDataList: [], // 여러 과목의 출석부/수업일지 배열

                        currentSubjectIndex: -1, // 현재 선택된 과목 인덱스 (-1이면 미선택)

                        teacherViewMode: 'cards', // 'cards' 또는 'dropdown'

                        
                        
                        // 기존 단일 과목 데이터 (하위 호환성 유지)

                        teacherPlan: {

                            subjectName: '', 

                            subjectGrade: null,

                            subjectSemester: null,

                            subjectSeries: '',  // 계열 (인문계열/전문계열)

                            subjectCategory: '',  // 분류 (보통교과/전문교과)

                            subjectNotFound: false,  // 편제표에서 과목을 찾지 못한 경우 true

                            teacherNames: [''],

                            achievements: [createEmptyAchievement()],

                            gradeCalculation: '추정분할점수', conductPrevention: 'X',

                            preventionTarget: '', preventionMethods: [], preventionPeriod: [],

                            preventionSessions: [{ plan: '' }, { plan: '' }, { plan: '' }],

                            supplementaryMethods: [], supplementaryPeriod: [],

                            supplementarySessions: [],

                            maxSupplementaryHours: 0,

                            additionalMethods: [], additionalPeriod: [],

                            additionalSessions: [],

                            maxAdditionalHours: 0,

                        },

                        teacherPlanError: '',

                        teacherGuidanceData: {

                            preventive: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {}, originalAttendance: {} })), error: ''},
                            supplementary: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {}, originalAttendance: {} })), error: ''}
                        },

                        newGuidanceStudentId: '',

                        
                        
                        // --- Subject Management State ---

                        showAddSubjectModal: false,

                        newSubjectForm: {

                            subjectName: '',

                            subjectGrade: null,

                            subjectSemester: null,

                            subjectCategory: '',

                            teacherNames: ['']

                        },



                        // --- Homeroom Teacher State ---

                        homeroomClassInput: '',

                        searchedStudents: [],

                        homeroomMessage: '',

                        processedHomeroomStudents: [],



                        // --- Preview Modal State ---

                        showPreviewModal: false,

                        previewHtml: '',

                    }

                },



                computed: {

                    availableSeries() {

                        // 교육과정 편제표에서 계열 열의 중복값을 제거하여 드롭다운 목록 생성

                        if (!this.curriculumData || this.curriculumData.length === 0) return [];

                        const series = new Set();

                        this.curriculumData.forEach(row => {

                            if (row && row['계열']) {

                                const seriesValue = String(row['계열']).trim();

                                if (seriesValue) series.add(seriesValue);

                            }

                        });

                        // 기본값 추가

                        if (series.size === 0) {

                            series.add('인문계열');

                            series.add('전문계열');

                        }

                        return Array.from(series).sort();

                    },

                    availableCategories() {

                        // 교육과정 편제표에서 분류 열의 중복값을 제거하여 드롭다운 목록 생성

                        if (!this.curriculumData || this.curriculumData.length === 0) return [];

                        const categories = new Set();

                        this.curriculumData.forEach(row => {

                            if (row && row['분류']) {

                                const category = String(row['분류']).trim();

                                if (category) categories.add(category);

                            }

                        });

                        // 기본값 추가

                        if (categories.size === 0) {

                            categories.add('보통교과');

                            categories.add('전문교과');

                        }

                        return Array.from(categories).sort();

                    },

                    planTitle() {

                        // 계획서 제목 생성: ~학년 ~학기 ~계열 최소 성취수준 보장지도 운영 계획(안)

                        const parts = [];

                        if (this.teacherPlan.subjectGrade) parts.push(`${this.teacherPlan.subjectGrade}학년`);

                        if (this.teacherPlan.subjectSemester) parts.push(`${this.teacherPlan.subjectSemester}학기`);

                        if (this.teacherPlan.subjectCategory) parts.push(this.teacherPlan.subjectCategory);

                        if (parts.length > 0) {

                            return `${parts.join(' ')} 최소 성취수준 보장지도 운영 계획(안)`;

                        }

                        return '최소 성취수준 보장지도 운영 계획(안)';

                    },

                    filteredSubjectSummary() {

                        if (this.selectedStatisticsFilter === 'all') {

                            return this.statisticsState.subjectSummary || [];

                        }

                        const [grade, semester] = this.selectedStatisticsFilter.split('-');

                        const filterGrade = Number(grade);

                        const filterSemester = Number(semester);

                        return (this.statisticsState.subjectSummary || []).filter(row => {

                            // 통계 데이터에 저장된 학년/학기 정보와 필터가 일치하는지 확인

                            if (row.grade != null && row.semester != null) {

                                return row.grade === filterGrade && row.semester === filterSemester;

                            }

                            // 학년/학기 정보가 없으면 교육과정 편제표에서 확인

                            const subjectInfo = this.findSubjectInCurriculum(row.subjectName, filterGrade, filterSemester, null);

                            return subjectInfo !== null;

                        });

                    },

                    filteredPreventionSummary() {

                        if (this.selectedStatisticsFilter === 'all') {

                            return this.statisticsState.preventionSummary || [];

                        }

                        const [grade, semester] = this.selectedStatisticsFilter.split('-');

                        const filterGrade = Number(grade);

                        const filterSemester = Number(semester);

                        return (this.statisticsState.preventionSummary || []).filter(row => {

                            if (row.grade != null && row.semester != null) {

                                return row.grade === filterGrade && row.semester === filterSemester;

                            }

                            const subjectInfo = this.findSubjectInCurriculum(row.subjectName, filterGrade, filterSemester, null);

                            return subjectInfo !== null;

                        });

                    },

                    filteredAdditionalSummary() {

                        if (this.selectedStatisticsFilter === 'all') {

                            return this.statisticsState.additionalSummary || [];

                        }

                        const [grade, semester] = this.selectedStatisticsFilter.split('-');

                        const filterGrade = Number(grade);

                        const filterSemester = Number(semester);

                        return (this.statisticsState.additionalSummary || []).filter(row => {

                            if (row.grade != null && row.semester != null) {

                                return row.grade === filterGrade && row.semester === filterSemester;

                            }

                            const subjectInfo = this.findSubjectInCurriculum(row.subjectName, filterGrade, filterSemester, null);

                            return subjectInfo !== null;

                        });

                    },

                    filteredRemedialSummary() {

                        if (this.selectedStatisticsFilter === 'all') {

                            return this.statisticsState.remedialSummary || [];

                        }

                        const [grade, semester] = this.selectedStatisticsFilter.split('-');

                        const filterGrade = Number(grade);

                        const filterSemester = Number(semester);

                        return (this.statisticsState.remedialSummary || []).filter(row => {

                            if (row.grade != null && row.semester != null) {

                                return row.grade === filterGrade && row.semester === filterSemester;

                            }

                            const subjectInfo = this.findSubjectInCurriculum(row.subjectName, filterGrade, filterSemester, null);

                            return subjectInfo !== null;

                        });

                    },

                    filteredDeficitSummary() {

                        if (this.selectedStatisticsFilter === 'all') {

                            return this.statisticsState.deficitSummary || [];

                        }

                        const [grade, semester] = this.selectedStatisticsFilter.split('-');

                        const filterGrade = Number(grade);

                        const filterSemester = Number(semester);

                        return (this.statisticsState.deficitSummary || []).filter(row => {

                            if (row.grade != null && row.semester != null) {

                                return row.grade === filterGrade && row.semester === filterSemester;

                            }

                            const subjectInfo = this.findSubjectInCurriculum(row.subjectName, filterGrade, filterSemester, null);

                            return subjectInfo !== null;

                        });

                    },

                    statusText() {

                        return this.teacherPlanError || this.adminActionStatus || this.moduleConfigStatus || this.underachieversStatus || this.teacherPlanStatus || '';

                    },

                    statusClass() {

                        const text = this.statusText;

                        if (text.includes('오류') || text.includes('실패')) return 'text-red-500';

                        if (text.includes('완료') || text.includes('성공') || text.includes('저장됨') || text.includes('배포됨')) return 'text-green-600';

                        if (text.includes('중')) return 'text-blue-600';

                        return 'text-gray-600';

                    },

                    formattedTeacherNames() {

                        if (!this.teacherPlan || !this.teacherPlan.teacherNames) return '';

                        return this.teacherPlan.teacherNames

                            .map(name => name ? name.trim() : '')

                            .filter(name => name)

                            .map(name => `${name} (인)`)

                            .join(', ');

                    },

                    groupedUnderachievers() {

                        if (this.role !== '관리자') return [];

                        const result = [];

                        this.underachievers.forEach(student => {

                            if (!student || !student.id) return;

                            const studentInfo = this.studentData.find(s => String(s.학번) === student.id);

                            const specialNotes = (studentInfo && studentInfo.특기사항) ? studentInfo.특기사항 : '일반학생';



                            const studentEntry = { id: student.id, name: student.name, specialNotes: specialNotes, details: [] };

                            const subjectsByReason = new Map();

                            const allSubjects = new Map();



                            (student.gradeSubjects || []).forEach(subject => {

                                if (!subject || !subject.name) return;

                                if (!allSubjects.has(subject.name)) {
                                    // 계열 정보 사용 (series가 있으면 사용, 없으면 category를 계열로 간주 - 기존 호환성)
                                    const series = subject.series || student.series || (subject.category && (subject.category === '인문계열' || subject.category === '전문계열') ? subject.category : null) || (student.category && (student.category === '인문계열' || student.category === '전문계열') ? student.category : '인문계열');
                                    const curriculumInfo = this.findSubjectInCurriculum(subject.name, student.grade, student.semester, series, null);
                                    // 분류는 교육과정 편제표에서 찾은 값 사용 (보통교과/전문교과)
                                    const category = curriculumInfo ? (curriculumInfo['분류'] || subject.category || '') : (subject.category || '');
                                    allSubjects.set(subject.name, { grade: true, attendance: false, credits: subject.credits, category: category, series: series });

                                } else { 
                                    const series = subject.series || student.series || (subject.category && (subject.category === '인문계열' || subject.category === '전문계열') ? subject.category : null) || (student.category && (student.category === '인문계열' || student.category === '전문계열') ? student.category : '인문계열');
                                    const curriculumInfo = this.findSubjectInCurriculum(subject.name, student.grade, student.semester, series, null);
                                    const category = curriculumInfo ? (curriculumInfo['분류'] || subject.category || '') : (subject.category || '');
                                    allSubjects.get(subject.name).grade = true;
                                    if (category) allSubjects.get(subject.name).category = category;
                                    if (series) allSubjects.get(subject.name).series = series;
                                }

                            });

                            (student.attendanceSubjects || []).forEach(subjectName => {

                                if (!subjectName) return;

                                if (!allSubjects.has(subjectName)) {
                                    // 출석 과목의 경우 계열 정보가 없을 수 있으므로, 교육과정 편제표에서 찾기
                                    // 계열 정보가 있으면 사용, 없으면 전체에서 검색
                                    const series = student.series || (student.category && (student.category === '인문계열' || student.category === '전문계열') ? student.category : '인문계열');
                                    const curriculumInfo = this.findSubjectInCurriculum(subjectName, student.grade, student.semester, series, null);

                                    const credits = curriculumInfo ? curriculumInfo.학점 : 'N/A';
                                    const category = curriculumInfo ? (curriculumInfo['분류'] || '') : '';

                                    allSubjects.set(subjectName, { grade: false, attendance: true, credits: credits, category: category, series: series });

                                } else { 
                                    allSubjects.get(subjectName).attendance = true;
                                    const series = student.series || (student.category && (student.category === '인문계열' || student.category === '전문계열') ? student.category : '인문계열');
                                    const curriculumInfo = this.findSubjectInCurriculum(subjectName, student.grade, student.semester, series, null);
                                    if (curriculumInfo && curriculumInfo['분류']) {
                                        allSubjects.get(subjectName).category = curriculumInfo['분류'];
                                    }
                                    if (series) allSubjects.get(subjectName).series = series;
                                }

                            });



                            allSubjects.forEach((details, subjectName) => {

                                let reason = '';

                                if (details.grade && details.attendance) reason = '학업성취율&과목출석률';

                                else if (details.grade) reason = '학업성취율';

                                else if (details.attendance) reason = '과목출석률';



                                if (reason) {

                                    if (!subjectsByReason.has(reason)) subjectsByReason.set(reason, []);

                                    subjectsByReason.get(reason).push({ name: subjectName, ...details });

                                }

                            });



                            // 계열별로 그룹핑
                            const subjectsByCategoryAndReason = new Map();
                            
                            subjectsByReason.forEach((subjectsArray, reason) => {
                                // 계열별로 그룹핑
                                const groupedByCategory = new Map();
                                
                                subjectsArray.forEach(subject => {
                                    const category = subject.category || '';
                                    if (!groupedByCategory.has(category)) {
                                        groupedByCategory.set(category, []);
                                    }
                                    groupedByCategory.get(category).push(subject);
                                });
                                
                                // 각 계열별로 처리
                                groupedByCategory.forEach((categorySubjects, category) => {
                                    // 과목명만 표시 (계열명 제거)
                                    const consolidatedSubjects = categorySubjects.map(s => `${s.name}(${s.credits}학점)`).join(', ');
                                    const lessonType = categorySubjects.some(s => s.grade) ? '보충지도' : '추가학습';
                                    
                                    // 계열별 시수 가져오기
                                    const hoursPerCredit = this.getHoursPerCredit(category);
                                    const hoursText = hoursPerCredit ? `*${hoursPerCredit}시수` : '';
                                    const lessonDetails = `${lessonType}(과목 학점수${hoursText})`;

                                    studentEntry.details.push({
                                        reason: reason, 
                                        subjects: consolidatedSubjects, 
                                        lessonDetails: lessonDetails,
                                        originalSubjects: categorySubjects, 
                                        id: student.id, 
                                        name: student.name,
                                        category: category
                                    });
                                });
                            });



                            if (studentEntry.details.length > 0) result.push(studentEntry);

                        });

                        result.sort((a, b) => a.id.localeCompare(b.id));

                        return result;

                    },

                    currentGuidanceData() {

                        if (this.role !== '교과교사') return null;

                        if (this.teacherTab === 'preventive' || this.teacherTab === 'supplementary' || this.teacherTab === 'additional') {
                            if (!this.teacherGuidanceData[this.teacherTab]) {

                                this.teacherGuidanceData[this.teacherTab] = this.getInitialGuidanceData()[this.teacherTab];

                            }

                            return this.teacherGuidanceData[this.teacherTab];

                        }

                        return null;

                    },

                    guidanceCompletionStatus() {

                        const data = this.currentGuidanceData;

                        if (!this.role || !data || !data.students) return {};



                        const preventiveTotals = {};

                        const preventiveData = this.teacherGuidanceData.preventive;

                        if (preventiveData && preventiveData.sessions) {

                            preventiveData.sessions.forEach(session => {

                                if (session && session.isSaved && session.attendance) {

                                    for (const studentId in session.attendance) {

                                        const methodName = session.attendance[studentId];

                                        if (methodName) {

                                            const methodConfig = this.moduleConfig.recognizedHours.find(m => m.name === methodName);

                                            if (methodConfig) {

                                                if (!preventiveTotals[studentId]) preventiveTotals[studentId] = 0;

                                                preventiveTotals[studentId] += methodConfig.hours;

                                            }

                                        }

                                    }

                                }

                            });

                        }



                        const status = {};

                        let requiredHoursForCompletion = 0;

                        let maxEmotionalSupportHours = 0;

                        let supplementaryHours = 0;

                        let requiredSubjectCredits = 0;



                        if (this.teacherPlan.subjectName && 

                            this.teacherPlan.subjectGrade != null && 

                            this.teacherPlan.subjectSemester != null && 

                            this.teacherPlan.subjectCategory) {

                            try {

                                // teacherPlan.subjectSeries는 계열(인문계열/전문계열)
                                // teacherPlan.subjectCategory는 분류(보통교과/전문교과) - 시수 적용 기준
                                const subjectInfo = this.findSubjectInCurriculum(

                                    this.teacherPlan.subjectName,

                                    this.teacherPlan.subjectGrade,

                                    this.teacherPlan.subjectSemester,

                                    this.teacherPlan.subjectSeries,  // 계열

                                    this.teacherPlan.subjectCategory  // 분류는 시수 적용에만 사용

                                );

                            if (subjectInfo) {

                                requiredSubjectCredits = Number(subjectInfo.학점) || 0;
                                
                                const category = this.teacherPlan.subjectCategory || '';
                                const hoursPerCredit = this.getHoursPerCredit(category);

                                supplementaryHours = requiredSubjectCredits * hoursPerCredit;

                                requiredHoursForCompletion = Math.ceil((supplementaryHours * 2) / 3 * 10) / 10;

                                maxEmotionalSupportHours = supplementaryHours * (this.moduleConfig.emotionalSupportRatio / 100);

                                }

                            } catch (error) {

                                console.error('guidanceCompletionStatus에서 findSubjectInCurriculum 호출 오류:', error);

                            }

                        }



                        data.students.forEach(student => {

                            if (!student || !student.id) return;

                            status[student.id] = { name: student.name };

                            const studentInfo = this.studentData.find(s => String(s['학번']) === student.id);

                            status[student.id].specialNotes = (studentInfo && studentInfo['특기사항']) ? studentInfo['특기사항'] : '일반학생';

                            this.moduleConfig.recognizedHours.forEach(rh => {

                                status[student.id][rh.name] = 0;

                            });

                            status[student.id].total = 0;

                            if (this.teacherTab === 'supplementary') {

                                status[student.id].preventiveHours = 0;

                                status[student.id].emotionalSupportHours = 0;

                                status[student.id].completionStatus = '미이수';

                            }

                            if (this.teacherTab === 'additional') {

                                status[student.id].preventiveHours = 0;

                                status[student.id].emotionalSupportHours = 0;

                                status[student.id].completionStatus = '미이수';

                            }

                        });



                        if (data.sessions) {

                            data.sessions.forEach(session => {

                                if (session && session.isSaved && session.attendance) {

                                    for (const studentId in session.attendance) {

                                        if (!status[studentId]) continue;

                                        const methodName = session.attendance[studentId];

                                        if (methodName) {

                                            const methodConfig = this.moduleConfig.recognizedHours.find(m => m.name === methodName);

                                            if (methodConfig) {

                                                status[studentId][methodName] = parseFloat((status[studentId][methodName] + methodConfig.hours).toFixed(2));

                                                if (this.teacherTab === 'preventive') {

                                                    status[studentId].total = parseFloat((status[studentId].total + methodConfig.hours).toFixed(2));

                                                }

                                            }

                                        }

                                    }

                                }

                            });

                        }



                        if ((this.teacherTab === 'supplementary' || this.teacherTab === 'additional') && requiredSubjectCredits > 0) {

                            data.students.forEach(student => {

                                if (!student || !status[student.id]) return;



                                let currentStudentTotal = 0;

                                this.moduleConfig.recognizedHours.forEach(rh => {

                                    currentStudentTotal += (status[student.id][rh.name] || 0);

                                });



                                const totalPreventiveHoursForStudent = preventiveTotals[student.id] || 0;

                                // 예방지도 및 정서지원 연계 규칙 적용

                                // 1) 예방지도 최대 연계 가능 시수(학생별): 학습지원대상자는 별도 비율 적용

                                    const studentInfo = this.studentData.find(s => String(s['학번']) === student.id);

                                    const isSpecialSupport = studentInfo && studentInfo['특기사항'] === '학습지원대상';

                                const maxPreventiveLinkedHours = supplementaryHours * ((isSpecialSupport ? this.moduleConfig.specialPreventiveRatio : this.moduleConfig.preventiveRatio) / 100);

                                
                                
                                // 표시용(원자료) 시간은 그대로 보여주되,

                                // 총계 합산 시에만 최대 연계 가능 시수로 제한하여 반영

                                const displayPreventiveHours = totalPreventiveHoursForStudent;

                                // 표시값은 소수점 절삭

                                status[student.id].preventiveHours = Math.floor(displayPreventiveHours || 0);

                                // 합산값은 소수점 유지, 상한만 적용

                                const creditedPreventiveHours = Math.min((displayPreventiveHours || 0), maxPreventiveLinkedHours);

                                    currentStudentTotal += creditedPreventiveHours;



                                // 3) 정서지원 인정 시간: 자체 비율 캡을 적용하되,

                                //    (예방지도 인정 + 정서지원 인정) 합이 예방지도 최대 연계 가능 시간을 초과하지 않도록 추가 캡 적용

                                // 보충지도와 추가학습 모두에서 정서지원프로그램 시간 계산

                                if (this.teacherTab === 'supplementary' || this.teacherTab === 'additional') {

                                    const emotionalData = this.emotionalSupportData.find(e => String(e['학번']) === student.id);

                                    const uploadedHours = emotionalData ? Number(emotionalData['정서지원프로그램 참여시간']) : 0;

                                    // 표시용(정서지원) 시간: 학점당 이수시간 × 연계비율로 산출한 최대시수까지만 표시

                                    const displayEmotionalHours = Math.min(uploadedHours, maxEmotionalSupportHours);

                                    // 표시값은 소수점 절삭

                                    status[student.id].emotionalSupportHours = Math.floor(displayEmotionalHours || 0);

                                    // 합산용: 비율 기반 1차 캡 (소수점 유지)

                                    const baseEmotionalHours = Math.min((displayEmotionalHours || 0), maxEmotionalSupportHours);

                                    // 예방지도 최대 연계 가능 시수 내에서 남은 여유

                                    const remainingPreventiveCapacity = Math.max(0, maxPreventiveLinkedHours - creditedPreventiveHours);

                                    const creditedEmotionalHours = Math.min(baseEmotionalHours, remainingPreventiveCapacity);

                                    currentStudentTotal += creditedEmotionalHours;

                                }



                                // 총계만 소수점 절삭 적용

                                status[student.id].total = Math.floor(currentStudentTotal);

                                const tolerance = 0.001;

                                if (requiredHoursForCompletion > 0 && status[student.id].total >= Math.floor(requiredHoursForCompletion) - tolerance) {

                                    status[student.id].completionStatus = '이수';

                                } else {

                                    status[student.id].completionStatus = '미이수';

                                }

                                if (student.isException) {

                                    // 예외처리 학생은 보충지도/추가학습 이수시간이 0이어도 '이수'로 표시
                                    // 단, 합계(total)는 실제 참여한 이수시간을 그대로 유지
                                    status[student.id].completionStatus = '이수';

                                    }

                                if (student.note) {
                                    status[student.id].note = student.note;
                                }

                            });

                        }

                        return status;

                    },

                    savedGuidanceSessions() {

                        const data = this.currentGuidanceData;

                        if (!data || !data.sessions) return [];

                        return data.sessions.filter(s => s && s.isSaved && s.date);

                    },

                    guidanceOperationPeriod() {

                        const savedSessions = this.savedGuidanceSessions;

                        if (savedSessions.length === 0) return '미정';

                        const validDates = savedSessions

                            .map(s => { try { if (s && s.date && /^\d{4}-\d{2}-\d{2}$/.test(s.date)) { const dateObj = new Date(s.date); if (!isNaN(dateObj.getTime())) { return dateObj; } } return null; } catch (e) { return null; } })

                            .filter(d => d)

                            .sort((a, b) => a - b);

                        if (validDates.length === 0) return '유효한 날짜 없음';

                        try {

                            const startDate = validDates[0].toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });

                            const endDate = validDates[validDates.length - 1].toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });

                            return `${startDate} ~ ${endDate}`;

                        } catch (e) { console.error("Error formatting date:", e); return '날짜 형식 오류'; }

                    },

                },



                methods: {

                    // --- Subject Management ---

                    async selectSubjectFromCard(index) {

                        this.currentSubjectIndex = index;

                        this.teacherViewMode = 'dropdown';

                        await this.loadSubjectData(index);

                    },

                    async switchSubject() {

                        if (this.currentSubjectIndex >= 0 && this.currentSubjectIndex < this.teacherPlanList.length) {

                            await this.loadSubjectData(this.currentSubjectIndex);

                        }

                    },

                    returnToCardView() {

                        this.teacherViewMode = 'cards';

                        this.currentSubjectIndex = -1;

                        this.teacherTab = 'plan'; // 탭도 초기화

                    },

                    async loadSubjectData(index) {

                        if (index < 0 || index >= this.teacherPlanList.length) return;

                        const plan = this.teacherPlanList[index];

                        let guidance = this.teacherGuidanceDataList[index];

                        
                        
                        // guidance 데이터가 없으면 Firestore에서 로드 시도

                        if (!guidance) {

                            this.teacherPlan = JSON.parse(JSON.stringify(plan));

                            await this.loadGuidanceData();

                            guidance = JSON.parse(JSON.stringify(this.teacherGuidanceData));

                            // 로드한 데이터를 리스트에 저장

                            if (this.teacherGuidanceDataList.length <= index) {

                                this.teacherGuidanceDataList.push(guidance);

                            } else {

                                this.teacherGuidanceDataList[index] = guidance;

                            }

                        }

                        
                        
                        // 현재 teacherPlan과 teacherGuidanceData에 로드

                        this.teacherPlan = JSON.parse(JSON.stringify(plan));

                        this.teacherGuidanceData = JSON.parse(JSON.stringify(guidance));

                        
                        
                        // 날짜 필드 복원

                        const parseDates = (period) => (period || []).map(d => d ? new Date(d.seconds ? d.seconds * 1000 : d) : null).filter(d => d && !isNaN(d.getTime()));

                        this.teacherPlan.preventionPeriod = parseDates(this.teacherPlan.preventionPeriod);

                        this.teacherPlan.supplementaryPeriod = parseDates(this.teacherPlan.supplementaryPeriod);

                        this.teacherPlan.additionalPeriod = parseDates(this.teacherPlan.additionalPeriod);

                        
                        
                        this.updateMaxHours();

                        this.$nextTick(() => { this.initFlatpickr(); });

                    },

                    async addNewSubjectDirectly() {

                        // 중복 방지: 이미 진행 중인 추가 작업이 있으면 무시
                        if (this._isAddingSubject) {
                            console.log('이미 과목 추가 작업이 진행 중입니다.');
                            return;
                        }
                        this._isAddingSubject = true;
                        
                        try {
                        // 빈 과목 생성

                        const newPlan = {

                            subjectName: '',

                            subjectGrade: null,

                            subjectSemester: null,

                            subjectCategory: '',

                            teacherNames: [''],

                            achievements: [createEmptyAchievement()],

                            gradeCalculation: '추정분할점수',

                            conductPrevention: 'X',

                            preventionTarget: '',

                            preventionMethods: [],

                            preventionPeriod: [],

                            preventionSessions: [{ plan: '' }, { plan: '' }, { plan: '' }],

                            supplementaryMethods: [],

                            supplementaryPeriod: [],

                            supplementarySessions: [],

                            maxSupplementaryHours: 0,

                            additionalMethods: [],

                            additionalPeriod: [],

                            additionalSessions: [],

                            maxAdditionalHours: 0,

                        };

                        
                        
                        const newGuidance = this.getInitialGuidanceData();

                            
                            // 배열이 초기화되지 않았으면 초기화
                            if (!Array.isArray(this.teacherPlanList)) {
                                this.teacherPlanList = [];
                            }
                            if (!Array.isArray(this.teacherGuidanceDataList)) {
                                this.teacherGuidanceDataList = [];
                            }
                        
                        
                        this.teacherPlanList.push(newPlan);

                        this.teacherGuidanceDataList.push(newGuidance);

                        this.currentSubjectIndex = this.teacherPlanList.length - 1;

                        
                        
                        // 새 과목을 현재 선택된 과목으로 설정하고 드롭다운 뷰로 전환

                        await this.loadSubjectData(this.currentSubjectIndex);

                        this.teacherViewMode = 'dropdown';

                        this.teacherTab = 'plan'; // 계획서 탭으로 이동

                        
                        
                        // 저장

                        await this.saveAllTeacherData();

                        } finally {
                            this._isAddingSubject = false;
                        }
                    },

                    async addNewSubject() {

                        if (!this.newSubjectForm.subjectName.trim()) {

                            alert('과목명을 입력해주세요.');

                            return;
                        }
                        
                        // 중복 방지: 이미 진행 중인 추가 작업이 있으면 무시
                        if (this._isAddingSubject) {
                            console.log('이미 과목 추가 작업이 진행 중입니다.');
                            return;
                        }
                        this._isAddingSubject = true;
                        
                        try {
                            // 중복 과목 확인: 같은 과목명, 학년, 학기, 계열이 이미 있는지 확인
                            const existingSubject = this.teacherPlanList.find(plan => 
                                plan.subjectName === this.newSubjectForm.subjectName.trim() &&
                                plan.subjectGrade === this.newSubjectForm.subjectGrade &&
                                plan.subjectSemester === this.newSubjectForm.subjectSemester &&
                                plan.subjectSeries === this.newSubjectForm.subjectSeries
                            );
                            
                            if (existingSubject) {
                                alert('이미 동일한 과목(과목명, 학년, 학기, 계열)이 존재합니다.');
                                this._isAddingSubject = false;
                            return;

                        }

                        
                        
                        const newPlan = {

                            subjectName: this.newSubjectForm.subjectName,

                            subjectGrade: this.newSubjectForm.subjectGrade,

                            subjectSemester: this.newSubjectForm.subjectSemester,

                            subjectCategory: this.newSubjectForm.subjectCategory,

                            teacherNames: this.newSubjectForm.teacherNames.filter(n => n.trim()),

                            achievements: [createEmptyAchievement()],

                            gradeCalculation: '추정분할점수',

                            conductPrevention: 'X',

                            preventionTarget: '',

                            preventionMethods: [],

                            preventionPeriod: [],

                            preventionSessions: [{ plan: '' }, { plan: '' }, { plan: '' }],

                            supplementaryMethods: [],

                            supplementaryPeriod: [],

                            supplementarySessions: [],

                            maxSupplementaryHours: 0,

                            additionalMethods: [],

                            additionalPeriod: [],

                            additionalSessions: [],

                            maxAdditionalHours: 0,

                        };

                        
                        
                        const newGuidance = this.getInitialGuidanceData();

                            
                            // 배열이 초기화되지 않았으면 초기화
                            if (!Array.isArray(this.teacherPlanList)) {
                                this.teacherPlanList = [];
                            }
                            if (!Array.isArray(this.teacherGuidanceDataList)) {
                                this.teacherGuidanceDataList = [];
                            }
                        
                        
                        this.teacherPlanList.push(newPlan);

                        this.teacherGuidanceDataList.push(newGuidance);

                        this.currentSubjectIndex = this.teacherPlanList.length - 1;

                        
                        
                        // 새 과목을 현재 선택된 과목으로 설정

                        await this.loadSubjectData(this.currentSubjectIndex);

                        this.teacherViewMode = 'dropdown';

                        
                        
                        // 폼 초기화

                        this.newSubjectForm = {

                            subjectName: '',

                            subjectGrade: null,

                            subjectSemester: null,

                            subjectCategory: '',

                            teacherNames: ['']

                        };

                        this.showAddSubjectModal = false;
                        
                        

                        // 저장

                            await this.saveAllTeacherData();
                        } finally {
                            this._isAddingSubject = false;
                        }
                    },

                    deleteSubject(index) {

                        if (!confirm('정말 삭제하시겠습니까? 모든 데이터가 지워집니다.')) return;

                        
                        
                        this.teacherPlanList.splice(index, 1);

                        this.teacherGuidanceDataList.splice(index, 1);

                        
                        
                        if (this.currentSubjectIndex === index) {

                            this.currentSubjectIndex = -1;

                            this.teacherPlan = this.getInitialTeacherPlan();

                            this.teacherGuidanceData = this.getInitialGuidanceData();

                        } else if (this.currentSubjectIndex > index) {

                            this.currentSubjectIndex--;

                        }

                        
                        
                        this.saveAllTeacherData();

                    },

                    addNewSubjectTeacher() {

                        this.newSubjectForm.teacherNames.push('');

                    },

                    removeNewSubjectTeacher(index) {

                        this.newSubjectForm.teacherNames.splice(index, 1);

                    },

                    getTeacherLocalStorageKey() {
                        if (!this.user) return null;
                        const uid = this.user.uid || 'unknown';
                        const activeSchoolId = this.currentSchoolCode || this.schoolId || 'local';
                        return `minAchieve_teacher_${uid}_${activeSchoolId}`;
                    },
                    getAdminLocalStorageKey() {
                        if (!this.user) return null;
                        const uid = this.user.uid || 'unknown';
                        const activeSchoolId = this.currentSchoolCode || this.schoolId;
                        if (!activeSchoolId) return null;
                        return `minAchieve_admin_${uid}_${activeSchoolId}`;
                    },
                    async saveAllTeacherData() {

                        if (this.role !== '교과교사' || !this.user) return;
                        const storageKey = this.getTeacherLocalStorageKey();
                        if (!storageKey) return;
                        

                        try {

                            // 날짜 필드를 ISO 문자열로 변환하여 저장

                            const planListToSave = this.teacherPlanList.map(plan => {

                                const planCopy = JSON.parse(JSON.stringify(plan));

                                const formatDates = (period) =>
                                    (period || [])
                                        .map(d => (d instanceof Date && !isNaN(d.getTime())) ? d.toISOString() : null)
                                        .filter(Boolean);
                                planCopy.preventionPeriod = formatDates(plan.preventionPeriod);

                                planCopy.supplementaryPeriod = formatDates(plan.supplementaryPeriod);

                                planCopy.additionalPeriod = formatDates(plan.additionalPeriod);

                                planCopy.achievements = (planCopy.achievements || []).map((achievement) => {

                                    if (!achievement) return { text: '', statement: '' };

                                    const { loading, isEditing, editDraft, ...rest } = achievement;

                                    return rest;

                                });

                                return planCopy;

                            });
                            
                            

                            const payload = {
                                planList: planListToSave,

                                guidanceDataList: this.teacherGuidanceDataList,

                                lastUpdated: new Date().toISOString()

                            };
                            localStorage.setItem(storageKey, JSON.stringify(payload));
                            console.log('모든 과목 데이터가 로컬에 저장되었습니다.', { storageKey });
                        } catch (error) {

                            console.error('과목 데이터 로컬 저장 실패:', error);
                        }

                    },

                    async loadAllTeacherData() {

                        if (this.role !== '교과교사' || !this.user) return;
                        const storageKey = this.getTeacherLocalStorageKey();
                        if (!storageKey) return;

                        // 이미 데이터가 로드되어 있고, localStorage의 데이터와 동일한지 확인
                        // 중복 로드를 방지하기 위해 한 번만 로드하도록 함
                        if (this.teacherPlanList && this.teacherPlanList.length > 0) {
                            console.log('이미 교과 데이터가 로드되어 있습니다. 중복 로드를 방지합니다.', { 
                                currentCount: this.teacherPlanList.length,
                                storageKey 
                            });
                            return;
                        }

                        try {
                            const raw = localStorage.getItem(storageKey);
                            if (!raw) {
                                console.log('로컬에 저장된 교과 데이터가 없습니다.', { storageKey });
                                // 데이터가 없으면 빈 배열로 초기화
                                this.teacherPlanList = [];
                                this.teacherGuidanceDataList = [];
                                return;
                            }
                            const data = JSON.parse(raw);
                            
                            // 데이터 중복 방지: 기존 데이터가 있으면 덮어쓰지 않음
                                if (data.planList && Array.isArray(data.planList)) {

                                // 기존 데이터가 없을 때만 할당
                                if (!this.teacherPlanList || this.teacherPlanList.length === 0) {
                                    this.teacherPlanList = data.planList;

                                } else {
                                    console.log('기존 교과 데이터가 있어 localStorage 데이터를 무시합니다.', {
                                        existingCount: this.teacherPlanList.length,
                                        localStorageCount: data.planList.length
                                    });
                                }

                            } else {
                                this.teacherPlanList = [];
                            }
                            
                                if (data.guidanceDataList && Array.isArray(data.guidanceDataList)) {

                                // 기존 데이터가 없을 때만 할당
                                if (!this.teacherGuidanceDataList || this.teacherGuidanceDataList.length === 0) {
                                    this.teacherGuidanceDataList = data.guidanceDataList;

                                } else {
                                    console.log('기존 지도 데이터가 있어 localStorage 데이터를 무시합니다.', {
                                        existingCount: this.teacherGuidanceDataList.length,
                                        localStorageCount: data.guidanceDataList.length
                                    });
                                }
                            } else {
                                this.teacherGuidanceDataList = [];
                            }

                            // 배열 길이 동기화 (planList와 guidanceDataList의 길이가 다를 수 있음)
                            if (this.teacherPlanList.length !== this.teacherGuidanceDataList.length) {
                                console.warn('planList와 guidanceDataList의 길이가 다릅니다. 동기화합니다.', {
                                    planListLength: this.teacherPlanList.length,
                                    guidanceDataListLength: this.teacherGuidanceDataList.length
                                });
                                // 더 긴 배열의 길이에 맞춰 짧은 배열을 채움
                                const maxLength = Math.max(this.teacherPlanList.length, this.teacherGuidanceDataList.length);
                                while (this.teacherPlanList.length < maxLength) {
                                    this.teacherPlanList.push(this.getInitialTeacherPlan());
                                }
                                while (this.teacherGuidanceDataList.length < maxLength) {
                                    this.teacherGuidanceDataList.push(this.getInitialGuidanceData());
                                }
                                }

                                
                                
                                // 첫 번째 과목을 기본 선택

                                if (this.teacherPlanList.length > 0 && this.currentSubjectIndex < 0) {

                                    this.currentSubjectIndex = 0;

                                    await this.loadSubjectData(0);

                                }

                        } catch (error) {

                            console.error('로컬 교과 데이터 로드 실패:', error);
                            // 오류 발생 시 빈 배열로 초기화
                            this.teacherPlanList = [];
                            this.teacherGuidanceDataList = [];
                        }

                    },

                    // --- Textarea Resize Helper ---

                    handleTextareaResize(event) {

                        const textarea = event.target;

                        textarea.style.height = 'auto';

                        // 최소 높이를 입력칸과 비슷하게 설정 (약 2rem = 32px)

                        const minHeight = 32;

                        textarea.style.height = Math.max(minHeight, textarea.scrollHeight) + 'px';

                    },

                    // --- Initial Data Helpers ---

                    getInitialTeacherPlan() {

                        return {

                            subjectName: '', teacherNames: [''],

                            subjectGrade: null, subjectSemester: null, subjectSeries: '', subjectCategory: '',

                            subjectNotFound: false,  // 편제표에서 과목을 찾지 못한 경우 true

                            achievements: [createEmptyAchievement()],

                            gradeCalculation: '추정분할점수', conductPrevention: 'X',

                            preventionTarget: '', preventionMethods: [], preventionPeriod: [],

                            preventionSessions: [{ plan: '' }, { plan: '' }, { plan: '' }],

                            supplementaryMethods: [], supplementaryPeriod: [],

                            supplementarySessions: [],

                            maxSupplementaryHours: 0,

                            additionalMethods: [], additionalPeriod: [],

                            additionalSessions: [],

                            maxAdditionalHours: 0,

                        };

                    },

                    getInitialGuidanceData() {

                        const defaultSession = () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {}, originalAttendance: {} });
                        return {

                            preventive: { students: [], sessions: Array.from({ length: 10 }, defaultSession), error: ''},

                            supplementary: { students: [], sessions: Array.from({ length: 10 }, defaultSession), error: ''},
                            additional: { students: [], sessions: Array.from({ length: 10 }, defaultSession), error: ''}
                        };

                    },

                    normalizeUnderachieverEntry(entry) {

                        if (!entry) return null;

                        const normalized = { ...entry };

                        normalized.id = entry.id ? String(entry.id) : '';

                        normalized.name = entry.name || '';

                        normalized.gradeSubjects = Array.isArray(entry.gradeSubjects)

                            ? entry.gradeSubjects

                                .filter(subject => subject && subject.name)

                                .map(subject => ({

                                    ...subject,

                                    name: String(subject.name).trim(),

                                    credits: subject.credits !== undefined ? subject.credits : (subject.학점 || subject.credit || '')

                                }))

                            : [];

                        normalized.attendanceSubjects = Array.isArray(entry.attendanceSubjects)

                            ? entry.attendanceSubjects

                                .filter(subjectName => subjectName)

                                .map(subjectName => String(subjectName).trim())

                            : [];

                        let exceptionReason = entry.exceptionReason ? String(entry.exceptionReason).trim() : '';

                        if (!exceptionReason && entry.exceptions && typeof entry.exceptions === 'object') {

                            for (const subjectKey in entry.exceptions) {

                                if (!subjectKey) continue;

                                const value = entry.exceptions[subjectKey];

                                if (value) {

                                    exceptionReason = String(value).trim();

                                    break;

                                }

                            }

                        }

                        normalized.exceptionReason = exceptionReason;

                        if (normalized.exceptions) delete normalized.exceptions;

                        return normalized;

                    },

                    normalizeUnderachieverList(list) {

                        if (!Array.isArray(list)) return [];

                        const result = list

                            .map(entry => this.normalizeUnderachieverEntry(entry))

                            .filter(entry => entry && entry.id);

                        result.sort((a, b) => a.id.localeCompare(b.id));

                        return result;

                    },

                    getStudentExceptionReason(studentId) {

                        const id = studentId ? String(studentId) : '';

                        if (!id) return '';

                        const findReason = (list) => {

                            if (!Array.isArray(list)) return '';

                            const student = list.find(item => item && item.id === id);

                            if (!student) return '';

                            return student.exceptionReason ? String(student.exceptionReason).trim() : '';

                        };

                        return findReason(this.underachievers) || findReason(this.deployedUnderachievers) || '';

                    },

                    getStudentIdFromRow(tr) {

                        // 테이블 행에서 학번 셀 찾기

                        // 학번은 첫 번째 열이고, rowspan이 있으면 첫 번째 행에만 표시됨

                        const firstTd = tr.querySelector('td:first-child');

                        if (firstTd) {

                            const text = firstTd.textContent.trim();

                            if (text) return text;

                        }

                        // rowspan이 있는 경우 같은 tbody의 첫 번째 행에서 찾기

                        const tbody = tr.closest('tbody');

                        if (tbody) {

                            const firstRow = tbody.querySelector('tr:first-child');

                            if (firstRow) {

                                const firstCell = firstRow.querySelector('td:first-child');

                                if (firstCell) {

                                    const text = firstCell.textContent.trim();

                                    if (text) return text;

                                }

                            }

                        }

                        return null;

                    },

                    async updateStudentExceptionReason(studentId, reason) {

                        if (this.role !== '관리자') return;

                        const id = studentId ? String(studentId) : '';

                        const trimmedReason = reason ? String(reason).trim() : '';

                        if (!id) return;



                        const applyUpdate = (list) => {

                            if (!Array.isArray(list)) return false;

                            const student = list.find(item => item && item.id === id);

                            if (!student) return false;

                            student.exceptionReason = trimmedReason;

                            return true;

                        };



                        const updated = applyUpdate(this.underachievers);

                        applyUpdate(this.deployedUnderachievers);



                        // Firestore에는 더이상 미도달 명단을 저장하지 않음 (엑셀로만 관리)
                        if (updated) {

                            // 필요 시, 이후 엑셀 내보내기 시에 반영됨
                            console.log('예외처리 사유가 업데이트되었습니다.', { studentId, reason: trimmedReason });
                        }

                    },

                    updateAdditionalStudentExceptionReason(studentId, reason) {

                        if (this.role !== '교과교사') return;

                        const id = studentId ? String(studentId) : '';

                        const trimmedReason = reason ? String(reason).trim() : '';

                        if (!id) return;

                        const data = this.teacherGuidanceData.additional;

                        if (!data || !data.students) return;

                        const student = data.students.find(s => s && s.id === id);

                        if (!student) return;

                        student.exceptionReason = trimmedReason;

                        student.isException = !!trimmedReason;

                        if (trimmedReason) {

                            student.note = `추가학습 예외처리 대상자 (${trimmedReason})`;

                        } else {

                            student.note = '';

                        }

                        this.saveGuidanceData();

                        console.log('추가학습 예외처리 사유가 업데이트되었습니다.', { studentId, reason: trimmedReason });

                    },

                    getStudentGrade(studentId) {

                        const id = studentId ? String(studentId) : '';

                        if (!id) return '';

                        const studentInfo = this.studentData.find(student => String(student['학번']) === id);

                        if (studentInfo && studentInfo['학년']) {

                            return String(studentInfo['학년']);

                        }

                        return id.length > 0 ? id[0] : '';

                    },

                    openStatisticsModal() {

                        if (this.role !== '관리자') return;

                        this.showStatisticsModal = true;

                        this.$nextTick(() => {

                            // 엑셀 데이터가 있으면 엑셀 기준으로만 재계산, 없으면 Firestore 기준으로 계산
                            if (this.completionExcelData && this.completionExcelData.length > 0) {
                                this.recomputeStatisticsFromCompletionExcel();
                            } else {
                            this.computeStatisticsData();

                            }
                        });

                    },

                    closeStatisticsModal() {

                        this.showStatisticsModal = false;

                    },

                    resetStatisticsDashboard() {
                        if (this.role !== '관리자') return;
                        this.statisticsState.loading = false;
                        this.statisticsState.error = '';
                        this.statisticsState.subjectSummary = [];
                        this.statisticsState.preventionSummary = [];
                        this.statisticsState.additionalSummary = [];
                        this.statisticsState.remedialSummary = [];
                        this.statisticsState.deficitSummary = [];
                        this.statisticsState.multiSubjectBuckets = [];
                        this.statisticsState.gradePreventionRatios = [];
                        this.statisticsState.preventionCourseRatio = { totalSubjects: 0, activeSubjects: 0, percentage: 0 };
                        this.statisticsState.lastUpdated = '';
                        this.statisticsState.allData = {
                            subjectSummary: [],
                            preventionSummary: [],
                            additionalSummary: [],
                            remedialSummary: [],
                            deficitSummary: []
                        };
                        this.completionExcelData = [];
                        this.statisticsState.error = '통계 데이터가 초기화되었습니다. 이수현황 엑셀을 다시 업로드해주세요.';
                        
                        // 파일 입력 필드 초기화
                        this.$nextTick(() => {
                            const fileInput = document.querySelector('input[type="file"][accept=".xlsx,.xls"]');
                            if (fileInput) {
                                fileInput.value = '';
                            }
                        });
                    },
                    async handleCompletionExcelUpload(event) {
                        if (this.role !== '관리자') return;
                        const files = event?.target?.files;
                        if (!files || files.length === 0) return;

                        console.log('[통계] 엑셀 파일 업로드 시작:', {
                            fileCount: files.length,
                            fileNames: Array.from(files).map(f => f.name)
                        });

                        this.statisticsState.loading = true;
                        this.statisticsState.error = '';
                        this.completionExcelData = [];

                        try {
                            const readFileAsRows = (file) => new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = e => {
                                    try {
                                        const data = new Uint8Array(e.target.result);
                                        const workbook = XLSX.read(data, { type: 'array' });
                                        const firstSheet = workbook.SheetNames[0];
                                        const ws = workbook.Sheets[firstSheet];
                                        const rows = XLSX.utils.sheet_to_json(ws);
                                        resolve(rows);
                                    } catch (err) { reject(err); }
                                };
                                reader.onerror = err => reject(err);
                                reader.readAsArrayBuffer(file);
                            });

                            const allSubjects = [];

                            for (const file of files) {
                                console.log('[통계] 파일 읽기 시작:', file.name);
                                const rows = await readFileAsRows(file);
                                console.log('[통계] 파일 읽기 완료:', {
                                    fileName: file.name,
                                    rowsLength: rows?.length || 0,
                                    rowsType: typeof rows,
                                    isArray: Array.isArray(rows)
                                });

                                if (!rows || rows.length === 0) {
                                    console.warn('[통계] 빈 엑셀 파일:', file.name);
                                    continue;
                                }

                                let subjectName = '';
                                const name = file.name || '';
                                const parts = name.replace(/\.xlsx?$/i, '').split('_');
                                if (parts.length >= 2) {
                                    subjectName = parts[1]; // 이수현황표_<과목명>_날짜
                                }

                                console.log('[통계] 엑셀 파일 처리:', {
                                    fileName: file.name,
                                    subjectName,
                                    rowCount: rows.length,
                                    firstRowKeys: rows[0] ? Object.keys(rows[0]) : [],
                                    firstRowSample: rows[0]
                                });

                                const subjectData = { subjectName, rows };
                                allSubjects.push(subjectData);
                                console.log('[통계] allSubjects에 추가됨:', {
                                    currentLength: allSubjects.length,
                                    addedData: subjectData
                                });
                            }

                            console.log('[통계] 모든 파일 처리 완료:', {
                                totalFiles: files.length,
                                processedFiles: allSubjects.length,
                                allSubjects: allSubjects
                            });

                            console.log('[통계] 업로드된 엑셀 데이터 (저장 전):', {
                                totalFiles: allSubjects.length,
                                subjects: allSubjects.map(s => ({ name: s.subjectName, rows: s.rows?.length || 0 })),
                                allSubjects: allSubjects
                            });

                            if (allSubjects.length === 0) {
                                console.error('[통계] 처리된 엑셀 파일이 없습니다. 파일 형식을 확인해주세요.');
                                this.statisticsState.error = '엑셀 파일에서 데이터를 읽을 수 없습니다. 파일 형식을 확인해주세요.';
                                return;
                            }

                            // 데이터 저장 (새 배열로 할당하여 Vue 반응성 보장)
                            this.completionExcelData = [...allSubjects];
                            
                            console.log('[통계] completionExcelData 저장 완료:', {
                                storedLength: this.completionExcelData.length,
                                storedData: this.completionExcelData,
                                isArray: Array.isArray(this.completionExcelData),
                                hasData: this.completionExcelData && this.completionExcelData.length > 0,
                                firstSubject: this.completionExcelData[0]
                            });
                            
                            // 통계 재계산 (약간의 지연을 두어 Vue 반응성이 완료되도록)
                            await this.$nextTick();
                            
                            console.log('[통계] $nextTick 후 completionExcelData 확인:', {
                                storedLength: this.completionExcelData.length,
                                hasData: this.completionExcelData && this.completionExcelData.length > 0
                            });
                            
                            this.recomputeStatisticsFromCompletionExcel();
                            
                            // 파일 입력 필드 초기화 (같은 파일을 다시 선택할 수 있도록)
                            if (event?.target) {
                                event.target.value = '';
                            }
                        } catch (error) {
                            console.error('이수현황 엑셀 업로드 오류:', error);
                            this.statisticsState.error = '이수현황 엑셀을 처리하는 중 오류가 발생했습니다.';
                        } finally {
                            this.statisticsState.loading = false;
                        }
                    },
                    recomputeStatisticsFromCompletionExcel() {
                        console.log('[통계] recomputeStatisticsFromCompletionExcel 호출:', {
                            completionExcelData: this.completionExcelData,
                            length: this.completionExcelData?.length || 0,
                            isArray: Array.isArray(this.completionExcelData)
                        });

                        if (!this.completionExcelData || this.completionExcelData.length === 0) {
                            console.warn('[통계] 업로드된 이수현황 엑셀 데이터가 없습니다.', {
                                completionExcelData: this.completionExcelData,
                                type: typeof this.completionExcelData,
                                isArray: Array.isArray(this.completionExcelData)
                            });
                            this.statisticsState.error = '엑셀 데이터가 없습니다. 파일을 업로드해주세요.';
                            return;
                        }

                        console.log('[통계] 엑셀 데이터 재계산 시작:', {
                            subjectCount: this.completionExcelData.length,
                            subjects: this.completionExcelData.map(e => e.subjectName),
                            sampleRows: this.completionExcelData[0]?.rows?.slice(0, 2),
                            totalRows: this.completionExcelData.reduce((sum, e) => sum + (e.rows?.length || 0), 0)
                        });

                        // 에러 초기화
                        this.statisticsState.error = '';

                        const subjectSummaryMap = new Map();
                        const preventionSummaryMap = new Map();
                        const additionalSummaryMap = new Map();
                        const remedialSummaryMap = new Map();
                        // 다과목 미도달 학생 수 계산을 위한 학생별 과목 카운터
                        const studentSubjectCountMap = new Map(); // 학번 -> 과목 수

                        this.completionExcelData.forEach(entry => {
                            const subjectName = entry.subjectName || '미지정 과목';

                            // 엑셀 파일의 첫 번째 행에서 학년, 학기, 계열, 학점 정보 추출
                            let subjectGrade = null;
                            let subjectSemester = null;
                            let subjectCategory = '';
                            let subjectCredits = 0;

                            if (entry.rows && entry.rows.length > 0) {
                                const firstRow = entry.rows[0];
                                subjectGrade = firstRow['학년'] != null ? Number(firstRow['학년']) : null;
                                subjectSemester = firstRow['학기'] != null ? Number(firstRow['학기']) : null;
                                subjectCategory = String(firstRow['계열'] || '').trim();
                                subjectCredits = Number(firstRow['학점'] || 0);
                            }

                            // 과목명이 같아도 학점이 다르면 다른 과목으로 구분 (계열이 다름을 의미)
                            // 키: 과목명|계열|학점 (학점이 있으면), 또는 과목명|계열 (학점이 없으면)
                            const subjectKey = subjectCredits > 0 
                                ? `${subjectName}|${subjectCategory}|${subjectCredits}학점`
                                : `${subjectName}|${subjectCategory}`;

                            if (!subjectSummaryMap.has(subjectKey)) {
                                subjectSummaryMap.set(subjectKey, {
                                    subjectName,
                                    credits: subjectCredits,
                                    grade: subjectGrade,
                                    semester: subjectSemester,
                                    category: subjectCategory,
                                    gradeCount: 0,
                                    attendanceCount: 0,
                                    exceptionCount: 0,
                                    incompleteCount: 0,
                                    completeCount: 0
                                });
                            }
                            if (!preventionSummaryMap.has(subjectKey)) {
                                preventionSummaryMap.set(subjectKey, {
                                    subjectName,
                                    grade: subjectGrade,
                                    semester: subjectSemester,
                                    category: subjectCategory,
                                    hasPrevention: false,
                                    participants: 0,
                                    nonParticipants: 0
                                });
                            }
                            if (!additionalSummaryMap.has(subjectKey)) {
                                additionalSummaryMap.set(subjectKey, {
                                    subjectName,
                                    credits: subjectCredits,
                                    grade: subjectGrade,
                                    semester: subjectSemester,
                                    category: subjectCategory,
                                    attendanceTargets: 0,
                                    participants: 0,
                                    exceptionCount: 0,
                                    nonParticipants: 0,
                                    completeCount: 0,
                                    incompleteCount: 0
                                });
                            }
                            if (!remedialSummaryMap.has(subjectKey)) {
                                remedialSummaryMap.set(subjectKey, {
                                    subjectName,
                                    credits: subjectCredits,
                                    grade: subjectGrade,
                                    semester: subjectSemester,
                                    category: subjectCategory,
                                    gradeTargets: 0,
                                    participants: 0,
                                    nonParticipants: 0,
                                    exceptionCount: 0,
                                    completeCount: 0,
                                    incompleteCount: 0
                                });
                            }

                            const summary = subjectSummaryMap.get(subjectKey);
                            const prevention = preventionSummaryMap.get(subjectKey);
                            const additional = additionalSummaryMap.get(subjectKey);
                            const remedial = remedialSummaryMap.get(subjectKey);

                            (entry.rows || []).forEach((row, rowIndex) => {
                                // 각 행에서도 학년, 학기, 계열, 학점 정보 확인 (없으면 첫 번째 행의 값 사용)
                                const rowGrade = row['학년'] != null ? Number(row['학년']) : subjectGrade;
                                const rowSemester = row['학기'] != null ? Number(row['학기']) : subjectSemester;
                                const rowCategory = String(row['계열'] || '').trim() || subjectCategory;
                                const rowCredits = Number(row['학점'] || 0) || subjectCredits;

                                // 디버깅: 첫 번째 행의 열 이름 확인
                                if (rowIndex === 0) {
                                    console.log('[통계] 엑셀 첫 번째 행의 열 이름:', Object.keys(row));
                                    console.log('[통계] 엑셀 첫 번째 행 데이터:', row);
                                }

                                const status = String(row['이수여부'] || '').trim();
                                const reason = String(row['미도달항목'] || row['미도달내역'] || '').trim();
                                const specialNotes = String(row['특기사항'] || '').trim();
                                const note = String(row['비고'] || '').trim();
                                // 엑셀 파일에 저장된 실제 열 이름: '예방지도시간' (엑셀 저장 시 사용)
                                const preventiveHours = Number(row['예방지도시간'] || row['예방지도'] || 0);
                                const totalHours = Number(row['총계'] || 0);

                                // 디버깅: 첫 번째 행의 주요 값 확인
                                if (rowIndex === 0) {
                                    console.log('[통계] 첫 번째 행 주요 값:', {
                                        status,
                                        reason,
                                        preventiveHours,
                                        totalHours,
                                        hasGrade: reason.includes('학업성취율'),
                                        hasAttendance: reason.includes('과목출석률')
                                    });
                                }

                                const studentId = String(row['학번'] || '').trim();
                                const hasGrade = reason.includes('학업성취율');
                                const hasAttendance = reason.includes('과목출석률');
                                const isException = specialNotes.includes('예외') || note.includes('예외');

                                // 다과목 미도달 학생 수 계산: 각 학생이 몇 개 과목에서 미도달인지 카운트
                                if (studentId) {
                                    const currentCount = studentSubjectCountMap.get(studentId) || 0;
                                    studentSubjectCountMap.set(studentId, currentCount + 1);
                                }

                                // 과목별 이수현황 요약
                                if (hasGrade) summary.gradeCount += 1;
                                if (hasAttendance) summary.attendanceCount += 1;
                                if (isException) summary.exceptionCount += 1;

                                if (status === '이수') summary.completeCount += 1;
                                else summary.incompleteCount += 1;

                                // 과목별 예방지도 참여 현황
                                // 엑셀 파일에 예방지도 이수 시간이 있으면 진행여부에 '진행함' 표시
                                // 예방지도시간 > 0이면 참여 인원, 0이면 미참여 인원
                                const hasPreventive = preventiveHours > 0;
                                if (hasPreventive) {
                                    prevention.participants += 1;
                                    prevention.hasPrevention = true; // 진행함 표시
                                } else {
                                    prevention.nonParticipants += 1;
                                }

                                // 과목별 추가학습 참여 현황 (과목출석률 미도달만 있는 학생 대상)
                                if (hasAttendance && !hasGrade) {
                                    additional.attendanceTargets += 1;
                                    if (isException) additional.exceptionCount += 1;

                                    if (totalHours > 0) {
                                        additional.participants += 1;
                                    } else {
                                        additional.nonParticipants += 1;
                                    }

                                    if (status === '이수') additional.completeCount += 1;
                                    else if (status === '미이수') additional.incompleteCount += 1;
                                }

                                // 과목별 보충지도(학업성취율) 참여 현황
                                // 대상: 학업성취율 미도달 학생 (과목출석률 동시 미도달 포함)
                                if (hasGrade) {
                                    remedial.gradeTargets += 1;
                                    if (isException) remedial.exceptionCount += 1;

                                    if (totalHours > 0) {
                                        remedial.participants += 1;
                                    } else {
                                        remedial.nonParticipants += 1;
                                    }

                                    if (status === '이수') remedial.completeCount += 1;
                                    else if (status === '미이수') remedial.incompleteCount += 1;
                                }
                            });
                        });

                        // 정렬 및 상태 반영
                        // 과목명에 학점 정보 추가 (학점이 있고, 같은 과목명에 다른 학점이 있는 경우 구분)
                        const subjectSummary = Array.from(subjectSummaryMap.values()).map(item => {
                            const displayName = item.credits > 0 
                                ? `${item.subjectName}(${item.credits}학점)`
                                : item.subjectName;
                            return { ...item, displayName };
                        }).sort((a, b) => {
                            // 학년, 학기, 과목명 순으로 정렬
                            if (a.grade !== b.grade) return (a.grade || 0) - (b.grade || 0);
                            if (a.semester !== b.semester) return (a.semester || 0) - (b.semester || 0);
                            return a.subjectName.localeCompare(b.subjectName, 'ko');
                        });
                        const preventionSummary = Array.from(preventionSummaryMap.values()).map(item => {
                            // 예방지도는 학점 정보가 없을 수 있으므로 과목명만 사용
                            const displayName = item.subjectName;
                            return { ...item, displayName };
                        }).sort((a, b) => {
                            if (a.grade !== b.grade) return (a.grade || 0) - (b.grade || 0);
                            if (a.semester !== b.semester) return (a.semester || 0) - (b.semester || 0);
                            return a.subjectName.localeCompare(b.subjectName, 'ko');
                        });
                        const additionalSummary = Array.from(additionalSummaryMap.values()).map(item => {
                            const displayName = item.credits > 0 
                                ? `${item.subjectName}(${item.credits}학점)`
                                : item.subjectName;
                            return { ...item, displayName };
                        }).sort((a, b) => {
                            if (a.grade !== b.grade) return (a.grade || 0) - (b.grade || 0);
                            if (a.semester !== b.semester) return (a.semester || 0) - (b.semester || 0);
                            return a.subjectName.localeCompare(b.subjectName, 'ko');
                        });
                        const remedialSummary = Array.from(remedialSummaryMap.values()).map(item => {
                            const displayName = item.credits > 0 
                                ? `${item.subjectName}(${item.credits}학점)`
                                : item.subjectName;
                            return { ...item, displayName };
                        }).sort((a, b) => {
                            if (a.grade !== b.grade) return (a.grade || 0) - (b.grade || 0);
                            if (a.semester !== b.semester) return (a.semester || 0) - (b.semester || 0);
                            return a.subjectName.localeCompare(b.subjectName, 'ko');
                        });

                        this.statisticsState.subjectSummary = subjectSummary;
                        this.statisticsState.preventionSummary = preventionSummary;
                        this.statisticsState.additionalSummary = additionalSummary;
                        this.statisticsState.remedialSummary = remedialSummary;

                        // 다과목 미도달 학생 수 계산
                        const multiSubjectBuckets = [
                            { label: '0~1개 과목', count: 0 },
                            { label: '2~3개 과목', count: 0 },
                            { label: '4~5개 과목', count: 0 },
                            { label: '6~7개 과목', count: 0 },
                            { label: '8~9개 과목', count: 0 }
                        ];
                        
                        studentSubjectCountMap.forEach((count, studentId) => {
                            if (count === 0 || count === 1) {
                                multiSubjectBuckets[0].count += 1;
                            } else if (count >= 2 && count <= 3) {
                                multiSubjectBuckets[1].count += 1;
                            } else if (count >= 4 && count <= 5) {
                                multiSubjectBuckets[2].count += 1;
                            } else if (count >= 6 && count <= 7) {
                                multiSubjectBuckets[3].count += 1;
                            } else if (count >= 8 && count <= 9) {
                                multiSubjectBuckets[4].count += 1;
                            }
                        });

                        console.log('[통계] 다과목 미도달 학생 수:', {
                            totalStudents: studentSubjectCountMap.size,
                            buckets: multiSubjectBuckets,
                            sampleStudents: Array.from(studentSubjectCountMap.entries()).slice(0, 10)
                        });

                        // 엑셀 기반 재계산이므로, deficitSummary/기타는 일단 초기화
                        this.statisticsState.deficitSummary = [];
                        this.statisticsState.multiSubjectBuckets = multiSubjectBuckets;
                        this.statisticsState.gradePreventionRatios = []; // 삭제 요청에 따라 빈 배열로 유지
                        this.statisticsState.preventionCourseRatio = { totalSubjects: 0, activeSubjects: 0, percentage: 0 };

                        this.statisticsState.lastUpdated = new Date().toLocaleString();

                        console.log('[통계] 엑셀 데이터 재계산 완료:', {
                            subjectSummaryCount: subjectSummary.length,
                            preventionSummaryCount: preventionSummary.length,
                            additionalSummaryCount: additionalSummary.length,
                            remedialSummaryCount: remedialSummary.length,
                            multiSubjectBucketsCount: multiSubjectBuckets.length,
                            samplePrevention: preventionSummary.slice(0, 2),
                            sampleAdditional: additionalSummary.slice(0, 2),
                            sampleRemedial: remedialSummary.slice(0, 2),
                            fullPrevention: preventionSummary,
                            fullAdditional: additionalSummary,
                            fullRemedial: remedialSummary,
                            multiSubjectBuckets: multiSubjectBuckets
                        });

                        // 데이터가 제대로 계산되었는지 확인
                        if (subjectSummary.length === 0 && preventionSummary.length === 0) {
                            console.warn('[통계] 계산된 데이터가 없습니다. 엑셀 파일 형식을 확인해주세요.');
                            this.statisticsState.error = '엑셀 파일에서 데이터를 읽을 수 없습니다. 파일 형식을 확인해주세요.';
                        } else {
                            this.statisticsState.error = '';
                        }

                        // Vue 반응성 강제 업데이트
                        this.$nextTick(() => {
                            this.$forceUpdate();
                        });
                    },
                    async computeStatisticsData() {

                        // currentSchoolCode를 우선 사용, 없으면 schoolId 사용

                        const activeSchoolId = this.currentSchoolCode || this.schoolId;

                        if (this.role !== '관리자' || !activeSchoolId || !db) {

                            console.warn('[통계] computeStatisticsData 조건 불만족:', {

                                role: this.role,

                                currentSchoolCode: this.currentSchoolCode,

                                schoolId: this.schoolId,

                                activeSchoolId

                            });

                            return;

                        }

                        if (this.statisticsState.loading) return;

                        this.statisticsState.loading = true;

                        this.statisticsState.error = '';

                        console.log(`[통계] computeStatisticsData 시작: activeSchoolId=${activeSchoolId}`);

                        try {

                            const subjectStats = new Map();

                            const curriculumMap = new Map();

                            const curriculumInfoMap = new Map(); // 과목명 -> {학년, 학기, 분류, 학점} 정보 저장

                            (this.curriculumData || []).forEach(row => {

                                if (!row || !row['과목명']) return;

                                const subjectName = String(row['과목명']).trim();

                                if (!subjectName) return;

                                const credits = Number(row['학점']);

                                curriculumMap.set(subjectName, isNaN(credits) ? 0 : credits);

                                // 과목명을 키로 하되, 학년/학기/분류 정보도 함께 저장

                                const key = `${subjectName}_${row['학년'] || ''}_${row['학기'] || ''}_${row['분류'] || ''}`;

                                curriculumInfoMap.set(key, {

                                    subjectName: subjectName,

                                    grade: row['학년'] != null ? Number(row['학년']) : null,

                                    semester: row['학기'] != null ? Number(row['학기']) : null,

                                    category: row['분류'] ? String(row['분류']).trim() : '',

                                    credits: isNaN(credits) ? 0 : credits

                                });

                            });

                            const recognizedHoursConfig = Array.isArray(this.moduleConfig?.recognizedHours) ? this.moduleConfig.recognizedHours : [];

                            const recognizedHoursMap = new Map();

                            recognizedHoursConfig.forEach(item => {

                                if (!item) return;

                                const name = item.name ? String(item.name).trim() : '';

                                if (!name) return;

                                const hours = Number(item.hours);

                                recognizedHoursMap.set(name, isNaN(hours) ? 0 : hours);

                            });

                            const ensureSubject = (subjectName, grade = null, semester = null, category = null) => {

                                // 과목명과 계열을 함께 키로 사용하여 같은 과목명이지만 계열이 다른 경우 구분

                                const subjectNameKey = subjectName ? String(subjectName).trim() : '';

                                if (!subjectNameKey) return null;

                                
                                
                                // 교육과정 편제표에서 해당 과목의 학년/학기/분류 정보 찾기

                                let subjectInfo = null;

                                if (grade != null && semester != null) {

                                    subjectInfo = this.findSubjectInCurriculum(subjectName, grade, semester, null, category);

                                } else {

                                    // 학년/학기 정보가 없으면 첫 번째로 찾은 과목 정보 사용

                                    subjectInfo = this.curriculumData.find(row => 

                                        row && row['과목명'] && String(row['과목명']).trim() === subjectNameKey

                                    );

                                }

                                
                                
                                // 계열 정보 추출 (subjectInfo에서 가져오거나, category 파라미터 사용)

                                const subjectCategory = subjectInfo 

                                    ? (subjectInfo['분류'] ? String(subjectInfo['분류']).trim() : '') 

                                    : (category ? String(category).trim() : '');
                                
                                
                                
                                // 과목명과 계열을 함께 키로 사용

                                const key = `${subjectNameKey}|${subjectCategory}`;

                                
                                
                                if (!subjectStats.has(key)) {

                                    const subjectGrade = subjectInfo ? (subjectInfo['학년'] != null ? Number(subjectInfo['학년']) : null) : (grade != null ? Number(grade) : null);

                                    const subjectSemester = subjectInfo ? (subjectInfo['학기'] != null ? Number(subjectInfo['학기']) : null) : (semester != null ? Number(semester) : null);

                                    const subjectCredits = subjectInfo ? (Number(subjectInfo['학점']) || 0) : (curriculumMap.has(subjectNameKey) ? curriculumMap.get(subjectNameKey) : 0);

                                    
                                    
                                    subjectStats.set(key, {

                                        subjectName: subjectNameKey,

                                        credits: subjectCredits,

                                        grade: subjectGrade,

                                        semester: subjectSemester,

                                        category: subjectCategory,

                                        underachievers: new Set(),

                                        gradeUnderachievers: new Set(),

                                        attendanceUnderachievers: new Set(),

                                        exceptions: new Set(),

                                        completion: { complete: new Set(), incomplete: new Set() },

                                        preventionTargets: new Set(),

                                        preventionParticipants: new Set(),

                                        preventionSessions: 0,

                                        supplementaryParticipants: new Set(),

                                        supplementaryTargets: new Set(),

                                        completionTotals: new Map(),

                                        preventiveHours: new Map(),

                                        planTeachers: new Set(),

                                        preventiveTeachers: new Set()

                                    });

                                }

                                return subjectStats.get(key);

                            };



                            const baseUnderachieversRaw = (this.underachievers && this.underachievers.length > 0)

                                ? this.underachievers

                                : this.deployedUnderachievers;

                            const baseUnderachievers = this.normalizeUnderachieverList(baseUnderachieversRaw);

                            const gradeSubjectCounter = new Map();

                            const gradeTotals = { '1': new Set(), '2': new Set(), '3': new Set() };



                            baseUnderachievers.forEach(student => {

                                if (!student || !student.id) return;

                                const studentId = student.id;

                                const gradeValue = this.getStudentGrade(studentId);

                                if (gradeTotals[gradeValue]) {

                                    gradeTotals[gradeValue].add(studentId);

                                }

                                const gradeSubjectsSet = new Set();

                                (student.gradeSubjects || []).forEach(subjectInfo => {

                                    if (!subjectInfo || !subjectInfo.name) return;

                                    const subjectName = String(subjectInfo.name).trim();

                                    if (!subjectName) return;

                                    // 학생의 학년 정보를 사용하여 과목 검색

                                    const studentGrade = gradeValue ? Number(gradeValue) : null;

                                    // 미도달 학생 데이터에서 학년/학기 정보 추출 (있는 경우)

                                    const subjectGrade = student.grade || studentGrade;

                                    const subjectSemester = student.semester || null;

                                    const subjectCategory = student.category || null;

                                    const stats = ensureSubject(subjectName, subjectGrade, subjectSemester, subjectCategory);

                                    if (!stats) return;

                                    stats.underachievers.add(studentId);

                                    stats.gradeUnderachievers.add(studentId);

                                    if (student.exceptionReason) {

                                        stats.exceptions.add(studentId);

                                    }

                                    gradeSubjectsSet.add(subjectName);

                                });

                                (student.attendanceSubjects || []).forEach(subjectNameRaw => {

                                    if (!subjectNameRaw) return;

                                    const subjectName = String(subjectNameRaw).trim();

                                    if (!subjectName) return;

                                    const stats = ensureSubject(subjectName);

                                    if (!stats) return;

                                    stats.underachievers.add(studentId);

                                    stats.attendanceUnderachievers.add(studentId);

                                    if (student.exceptionReason) {

                                        stats.exceptions.add(studentId);

                                    }

                                });

                                if (gradeSubjectsSet.size > 0) {

                                    gradeSubjectCounter.set(studentId, gradeSubjectsSet.size);

                                }

                            });



                            // 엑셀 데이터를 우선 사용, 없으면 Firestore 백업 사용
                            if (this.completionExcelData && this.completionExcelData.length > 0) {
                                // 엑셀 데이터에서 이수현황 추출
                                this.completionExcelData.forEach(entry => {
                                    const subjectName = entry.subjectName || '미지정 과목';
                                    const stats = ensureSubject(subjectName);
                                    if (!stats) return;
                                    
                                    (entry.rows || []).forEach(row => {
                                        const studentId = String(row['학번'] || '').trim();
                                        if (!studentId) return;
                                        const status = String(row['이수여부'] || '').trim();
                                        if (status === '이수') {
                                            stats.completion.complete.add(studentId);
                                        } else if (status === '미이수') {
                                            stats.completion.incomplete.add(studentId);
                                        }
                                    });
                                });
                            } else {
                                // 엑셀 데이터가 없으면 Firestore 백업 사용 (하위 호환성)
                            try {

                                const completionDocRef = doc(db, `schools/${activeSchoolId}/commonData`, 'completionStatus');

                                const completionSnap = await getDoc(completionDocRef);

                                const completionData = completionSnap.exists() ? completionSnap.data().data || {} : {};

                                Object.keys(completionData || {}).forEach(subjectName => {

                                    const stats = ensureSubject(subjectName);

                                    if (!stats) return;

                                    const subjectEntries = completionData[subjectName] || {};

                                    Object.keys(subjectEntries).forEach(studentId => {

                                        const statusValue = subjectEntries[studentId];

                                        const id = String(studentId);

                                        if (statusValue === '이수') {

                                            stats.completion.complete.add(id);

                                        } else if (statusValue === '미이수') {

                                            stats.completion.incomplete.add(id);

                                        }

                                    });

                                });

                            } catch (error) {

                                console.warn('completionStatus 로드 실패:', error);

                                }
                            }



                            const planSubjects = new Set();

                            const preventionSubjects = new Set();

                            const gradeParticipants = { '1': new Set(), '2': new Set(), '3': new Set() };



                            // completionStatus 문서를 직접 찾기 위한 Set (중복 방지)

                            const processedCompletionDocs = new Set();

                            
                            
                            try {

                                const teacherDataRef = collection(db, `schools/${activeSchoolId}/teacherData`);

                                console.log(`[통계] teacherData 컬렉션 읽기 시도: activeSchoolId=${activeSchoolId}`);

                                const teacherDataSnap = await getDocs(teacherDataRef);

                                console.log(`[통계] teacherData 컬렉션 읽기 완료: 교사 수=${teacherDataSnap.docs.length}`);

                                
                                
                                // teacherData가 없어도 completionStatus 문서를 직접 찾기

                                // 모든 teacherData 문서의 completionStatus 하위 컬렉션을 확인

                                for (const teacherDoc of teacherDataSnap.docs) {

                                    console.log(`[통계] 교사 문서 처리 시작: teacherUid=${teacherDoc.id}`);

                                    // 교과교사 계획서 정보 저장 (guidance 문서 처리 시 사용)

                                    let planInfo = null;

                                    try {

                                        const planDocRef = doc(teacherDoc.ref, 'plans', 'teacherPlan');

                                        const planSnap = await getDoc(planDocRef);

                                        if (planSnap.exists()) {

                                            const planData = planSnap.data();

                                            if (planData && planData.subjectName) {

                                                const subjectName = String(planData.subjectName).trim();

                                                const planGrade = planData.subjectGrade != null ? Number(planData.subjectGrade) : null;

                                                const planSemester = planData.subjectSemester != null ? Number(planData.subjectSemester) : null;

                                                const planCategory = planData.subjectCategory ? String(planData.subjectCategory).trim() : null;

                                                planInfo = { subjectName, grade: planGrade, semester: planSemester, category: planCategory };

                                                const stats = ensureSubject(subjectName, planGrade, planSemester, planCategory);

                                                if (stats) {

                                                    stats.planTeachers.add(teacherDoc.id);

                                                    planSubjects.add(subjectName);

                                                }

                                            }

                                        }

                                    } catch (planError) {

                                        console.warn('교과교사 계획서 로드 실패:', planError);

                                    }



                                    try {

                                        const guidanceRef = collection(teacherDoc.ref, 'guidance');

                                        const guidanceSnap = await getDocs(guidanceRef);

                                        console.log(`[통계] guidance 문서 읽기: 교사=${teacherDoc.id}, 문서 수=${guidanceSnap.docs.length}`);

                                        for (const guidanceDoc of guidanceSnap.docs) {

                                            const subjectName = this.decodeSubjectName(guidanceDoc.id);

                                            console.log(`[통계] guidance 문서 처리: 과목=${subjectName}, docId=${guidanceDoc.id}`);

                                            // 계획서 정보가 있으면 사용, 없으면 null로 전달하여 교육과정 편제표에서 찾도록 함

                                            const stats = ensureSubject(

                                                subjectName, 

                                                planInfo ? planInfo.grade : null, 

                                                planInfo ? planInfo.semester : null, 

                                                planInfo ? planInfo.category : null

                                            );

                                            if (!stats) {

                                                console.warn(`[통계] stats가 null: 과목=${subjectName}`);

                                                continue;

                                            }

                                            const guidanceData = guidanceDoc.data() || {};



                                            const supplementaryStudents = guidanceData.supplementary?.students || [];

                                            supplementaryStudents.forEach(student => {

                                                if (!student || !student.id) return;

                                                const id = String(student.id);

                                                stats.supplementaryTargets.add(id);

                                                stats.supplementaryParticipants.add(id);

                                                if (student.exceptionReason) {

                                                    stats.exceptions.add(id);

                                                } else if (student.isException && student.reason) {

                                                    stats.exceptions.add(id);

                                                }

                                            });



                                            const preventiveStudents = guidanceData.preventive?.students || [];

                                            preventiveStudents.forEach(student => {

                                                if (!student || !student.id) return;

                                                const id = String(student.id);

                                                stats.preventionTargets.add(id);

                                                stats.preventionParticipants.add(id);

                                                const gradeValue = this.getStudentGrade(id);

                                                if (gradeParticipants[gradeValue]) {

                                                    gradeParticipants[gradeValue].add(id);

                                                }

                                            });



                                            const supplementarySessions = guidanceData.supplementary?.sessions || [];

                                            const supplementaryParticipants = new Set();

                                            supplementarySessions.forEach(session => {

                                                if (!session || !session.attendance) return;

                                                Object.entries(session.attendance).forEach(([studentId, methodName]) => {

                                                    if (!studentId) return;

                                                    const normalizedId = String(studentId).trim();

                                                    if (!normalizedId) return;

                                                    supplementaryParticipants.add(normalizedId);

                                                    const methodKey = methodName ? String(methodName).trim() : '';

                                                    const rawHours = recognizedHoursMap.has(methodKey) ? recognizedHoursMap.get(methodKey) : 0;

                                                    const increment = rawHours > 0 ? rawHours : 1;

                                                    const prevTotal = stats.completionTotals.get(normalizedId) || 0;

                                                    stats.completionTotals.set(normalizedId, prevTotal + increment);

                                                });

                                            });

                                            supplementaryParticipants.forEach(id => {

                                                stats.supplementaryParticipants.add(id);

                                            });



                                            const preventiveSessions = guidanceData.preventive?.sessions || [];

                                            const preventiveParticipants = new Set();

                                            let savedPreventiveCount = 0;

                                            preventiveSessions.forEach(session => {

                                                if (!session || !session.attendance) return;

                                                Object.entries(session.attendance).forEach(([studentId, methodName]) => {

                                                    if (!studentId) return;

                                                    const normalizedId = String(studentId).trim();

                                                    if (!normalizedId) return;

                                                    preventiveParticipants.add(normalizedId);

                                                    const methodKey = methodName ? String(methodName).trim() : '';

                                                    const rawHours = recognizedHoursMap.has(methodKey) ? recognizedHoursMap.get(methodKey) : 0;

                                                    const increment = rawHours > 0 ? rawHours : 1;

                                                    const prevPreventive = stats.preventiveHours.get(normalizedId) || 0;

                                                    stats.preventiveHours.set(normalizedId, prevPreventive + increment);

                                                });

                                                if (session.isSaved) {

                                                    savedPreventiveCount++;

                                                }

                                            });

                                            if (savedPreventiveCount > 0) {

                                                stats.preventionSessions += savedPreventiveCount;

                                                stats.preventiveTeachers.add(teacherDoc.id);

                                                preventionSubjects.add(subjectName);

                                            }

                                            preventiveParticipants.forEach(id => {

                                                stats.preventionParticipants.add(id);

                                                const gradeValue = this.getStudentGrade(id);

                                                if (gradeParticipants[gradeValue]) {

                                                    gradeParticipants[gradeValue].add(id);

                                                }

                                            });



                                            // completionStatus 데이터(교과교사가 전송한 이수현황)에서 참여자 추출

                                            // guidance에서 계산한 preventiveHours를 먼저 저장 (completionStatus에 없을 때 사용)

                                            const guidancePreventiveHoursMap = new Map();

                                            stats.preventiveHours.forEach((hours, studentId) => {

                                                guidancePreventiveHoursMap.set(studentId, hours);

                                            });

                                            
                                            
                                            // completionStatus 문서 읽기 (guidance 문서 ID와 동일한 인코딩된 과목명 사용)

                                            try {

                                                const completionDocRef = doc(teacherDoc.ref, 'completionStatus', guidanceDoc.id);

                                                console.log(`[통계] completionStatus 문서 읽기 시도: 과목=${subjectName}, docId=${guidanceDoc.id}`, {

                                                    teacherUid: teacherDoc.id,

                                                    activeSchoolId,

                                                    fullPath: `schools/${activeSchoolId}/teacherData/${teacherDoc.id}/completionStatus/${guidanceDoc.id}`

                                                });

                                                const completionDocSnap = await getDoc(completionDocRef);

                                                if (completionDocSnap.exists()) {

                                                    const completionData = completionDocSnap.data();

                                                    console.log(`[통계] completionStatus 문서 데이터 구조:`, {

                                                        hasData: !!completionData.data,

                                                        dataKeys: completionData.data ? Object.keys(completionData.data).slice(0, 3) : [],

                                                        fullData: completionData

                                                    });

                                                    const completionEntries = completionData.data || {};

                                                    const completionStudentIds = new Set(Object.keys(completionEntries));

                                                    
                                                    
                                                    console.log(`[통계] completionStatus 문서 읽기 성공: 과목=${subjectName}, 학생 수=${completionStudentIds.size}`, {

                                                        docId: guidanceDoc.id,

                                                        entries: Object.keys(completionEntries).slice(0, 3) // 처음 3개만 로그

                                                    });

                                                    
                                                    
                                                    // completionStatus에 있는 학생들 처리

                                                    Object.keys(completionEntries).forEach(studentId => {

                                                        const normalizedId = String(studentId);

                                                        const entry = completionEntries[studentId];

                                                        let completionStatusValue = null;

                                                        let totalHours = 0;

                                                        if (entry && typeof entry === 'object') {

                                                            completionStatusValue = entry.completionStatus || null;

                                                            totalHours = Number(entry.total) || 0;

                                                        } else if (typeof entry === 'string') {

                                                            completionStatusValue = entry;

                                                        } else if (typeof entry === 'number') {

                                                            totalHours = Number(entry);

                                                        }

                                                    const preventiveHoursFromCompletion = (entry && typeof entry === 'object' && entry.preventiveHours != null)

                                                        ? Number(entry.preventiveHours) || 0

                                                        : 0;

                                                        if (completionStatusValue === '이수') {

                                                            stats.completion.complete.add(normalizedId);

                                                        } else if (completionStatusValue === '미이수') {

                                                            stats.completion.incomplete.add(normalizedId);

                                                        }

                                                    // completionTotals는 completionStatus의 값이 있으면 저장 (보충지도 이수현황표 기준)

                                                    if (totalHours != null && !isNaN(totalHours)) {

                                                        stats.completionTotals.set(normalizedId, totalHours);

                                                        if (totalHours > 0) {

                                                            console.log(`[통계] 보충지도 이수시간 저장: 학생=${normalizedId}, 시간=${totalHours}`);

                                                        }

                                                    }

                                                    // preventiveHours는 completionStatus의 값이 있으면 사용, 없으면 guidance에서 계산한 값 사용

                                                    if (preventiveHoursFromCompletion != null && !isNaN(preventiveHoursFromCompletion)) {

                                                        // completionStatus에 preventiveHours가 있으면 사용 (0이어도 저장)

                                                        stats.preventiveHours.set(normalizedId, preventiveHoursFromCompletion);

                                                        if (preventiveHoursFromCompletion > 0) {

                                                            console.log(`[통계] 예방지도 이수시간 저장: 학생=${normalizedId}, 시간=${preventiveHoursFromCompletion}`);

                                                        }

                                                    } else {

                                                        // completionStatus에 preventiveHours가 없으면 guidance에서 계산한 값 사용

                                                        const guidanceHours = guidancePreventiveHoursMap.get(normalizedId) || 0;

                                                        if (guidanceHours > 0) {

                                                            stats.preventiveHours.set(normalizedId, guidanceHours);

                                                        }

                                                    }

                                                        if (totalHours > 0 || completionStatusValue === '이수' || completionStatusValue === '미이수') {

                                                            stats.supplementaryParticipants.add(normalizedId);

                                                            if (stats.preventionTargets.has(normalizedId)) {

                                                                stats.preventionParticipants.add(normalizedId);

                                                            }

                                                        }

                                                    const finalPreventiveHours = stats.preventiveHours.get(normalizedId) || 0;

                                                    if (finalPreventiveHours > 0) {

                                                        stats.preventionParticipants.add(normalizedId);

                                                    }

                                                    });

                                                    
                                                    
                                                    // completionStatus에 없지만 guidance에 있는 학생들 처리 (guidance에서 계산한 값 유지)

                                                    guidancePreventiveHoursMap.forEach((hours, studentId) => {

                                                        if (!completionStudentIds.has(studentId) && hours > 0) {

                                                            // completionStatus에 없지만 guidance에 예방지도 이수시간이 있는 경우

                                                            stats.preventiveHours.set(studentId, hours);

                                                            stats.preventionParticipants.add(studentId);

                                                        }

                                                    });

                                                    
                                                    
                                                    console.log(`[통계] completionStatus 처리 완료: 과목=${subjectName}, completionTotals=${stats.completionTotals.size}, preventiveHours=${stats.preventiveHours.size}`);

                                                } else {

                                                    console.log(`[통계] completionStatus 문서 없음: 과목=${subjectName}, docId=${guidanceDoc.id}`);

                                                    // completionStatus 문서가 없으면 guidance에서 계산한 값만 사용

                                                    // 이미 guidance에서 계산한 값이 stats.preventiveHours에 저장되어 있음

                                                }

                                            } catch (completionDocError) {

                                                console.error('completionStatus 문서 읽기 실패:', completionDocError, {

                                                    subjectName,

                                                    docId: guidanceDoc.id,

                                                    teacherUid: teacherDoc.id

                                                });

                                                // 에러 발생 시 guidance에서 계산한 값만 사용

                                            }

                                        }

                                    } catch (guidanceError) {

                                        console.error('교과교사 guidance 로드 실패:', guidanceError, {

                                            teacherUid: teacherDoc.id

                                        });

                                    }

                                    
                                    
                                    // guidance 문서가 없어도 completionStatus 문서를 직접 읽기

                                    try {

                                        const completionStatusRef = collection(teacherDoc.ref, 'completionStatus');

                                        const completionStatusSnap = await getDocs(completionStatusRef);

                                        console.log(`[통계] completionStatus 컬렉션 직접 읽기: 교사=${teacherDoc.id}, 문서 수=${completionStatusSnap.docs.length}`, {

                                            activeSchoolId,

                                            teacherUid: teacherDoc.id,

                                            fullPath: `schools/${activeSchoolId}/teacherData/${teacherDoc.id}/completionStatus`

                                        });

                                        
                                        
                                        for (const completionDoc of completionStatusSnap.docs) {

                                            const docKey = `${teacherDoc.id}/${completionDoc.id}`;

                                            if (processedCompletionDocs.has(docKey)) {

                                                console.log(`[통계] completionStatus 중복 스킵: ${docKey}`);

                                                continue;

                                            }

                                            processedCompletionDocs.add(docKey);

                                            
                                            
                                            const subjectName = this.decodeSubjectName(completionDoc.id);

                                            const stats = ensureSubject(subjectName);

                                            if (!stats) {

                                                console.warn(`[통계] stats가 null: 과목=${subjectName}`);

                                                continue;

                                            }

                                            
                                            
                                            const completionDocData = completionDoc.data();

                                            console.log(`[통계] completionStatus 문서 데이터:`, {

                                                docId: completionDoc.id,

                                                subjectName,

                                                hasData: !!completionDocData.data,

                                                dataKeys: completionDocData.data ? Object.keys(completionDocData.data).slice(0, 3) : [],

                                                fullData: completionDocData

                                            });

                                            const completionEntries = completionDocData.data || {};

                                            
                                            
                                            console.log(`[통계] completionStatus 직접 처리: 과목=${subjectName}, 학생 수=${Object.keys(completionEntries).length}`);

                                            
                                            
                                            Object.keys(completionEntries).forEach(studentId => {

                                                const normalizedId = String(studentId);

                                                const entry = completionEntries[studentId];

                                                let completionStatusValue = null;

                                                let totalHours = 0;

                                                if (entry && typeof entry === 'object') {

                                                    completionStatusValue = entry.completionStatus || null;

                                                    totalHours = Number(entry.total) || 0;

                                                } else if (typeof entry === 'string') {

                                                    completionStatusValue = entry;

                                                } else if (typeof entry === 'number') {

                                                    totalHours = Number(entry);

                                                }

                                                const preventiveHoursFromCompletion = (entry && typeof entry === 'object' && entry.preventiveHours != null)

                                                    ? Number(entry.preventiveHours) || 0

                                                    : 0;
                                                
                                                
                                                
                                                console.log(`[통계] completionStatus 엔트리 처리: 학생=${normalizedId}`, {

                                                    entry,

                                                    completionStatusValue,

                                                    totalHours,

                                                    preventiveHoursFromCompletion

                                                });

                                                
                                                
                                                if (completionStatusValue === '이수') {

                                                    stats.completion.complete.add(normalizedId);

                                                } else if (completionStatusValue === '미이수') {

                                                    stats.completion.incomplete.add(normalizedId);

                                                }

                                                
                                                
                                                // completionTotals는 completionStatus의 값이 있으면 저장 (보충지도 이수현황표 기준)

                                                if (totalHours != null && !isNaN(totalHours)) {

                                                    stats.completionTotals.set(normalizedId, totalHours);

                                                    if (totalHours > 0) {

                                                        console.log(`[통계] 보충지도 이수시간 저장(직접): 학생=${normalizedId}, 시간=${totalHours}`);

                                                    }

                                                }

                                                
                                                
                                                // preventiveHours는 completionStatus의 값이 있으면 사용

                                                if (preventiveHoursFromCompletion != null && !isNaN(preventiveHoursFromCompletion)) {

                                                    stats.preventiveHours.set(normalizedId, preventiveHoursFromCompletion);

                                                    if (preventiveHoursFromCompletion > 0) {

                                                        console.log(`[통계] 예방지도 이수시간 저장(직접): 학생=${normalizedId}, 시간=${preventiveHoursFromCompletion}`);

                                                    }

                                                }

                                            });

                                            
                                            
                                            console.log(`[통계] completionStatus 처리 완료(직접): 과목=${subjectName}`, {

                                                completionTotals: stats.completionTotals.size,

                                                preventiveHours: stats.preventiveHours.size,

                                                completionTotalsSample: Array.from(stats.completionTotals.entries()).slice(0, 3),

                                                preventiveHoursSample: Array.from(stats.preventiveHours.entries()).slice(0, 3)

                                            });

                                        }

                                    } catch (completionDirectError) {

                                        console.warn('completionStatus 직접 읽기 실패:', completionDirectError, {

                                            teacherUid: teacherDoc.id

                                        });

                                    }

                                }

                            } catch (teacherDataError) {

                                console.error('teacherData 컬렉션 읽기 실패:', teacherDataError, {

                                    activeSchoolId,

                                    currentSchoolCode: this.currentSchoolCode,

                                    schoolId: this.schoolId

                                });

                            }



                            const subjectSummary = [];

                            const preventionSummary = [];

                            const additionalSummary = [];

                            const remedialSummary = [];

                            const deficitSummary = [];



                            subjectStats.forEach(stats => {

                                const subjectName = stats.subjectName;

                                const gradeIds = Array.from(stats.gradeUnderachievers);

                                const attendanceIds = Array.from(stats.attendanceUnderachievers);

                                const exceptionEntries = Array.from(stats.exceptions);

                                const completeIds = Array.from(stats.completion.complete);

                                const incompleteIds = Array.from(stats.completion.incomplete);



                                const exceptionCount = exceptionEntries.length;

                                const exceptionCountAttendance = exceptionEntries.filter(id => stats.attendanceUnderachievers.has(id)).length;

                                const exceptionCountGrade = exceptionEntries.filter(id => stats.gradeUnderachievers.has(id)).length;



                                const completeCount = completeIds.length;

                                const incompleteCount = incompleteIds.length;

                                const completeCountAttendance = completeIds.filter(id => stats.attendanceUnderachievers.has(id)).length;

                                const incompleteCountAttendance = incompleteIds.filter(id => stats.attendanceUnderachievers.has(id)).length;

                                const completeCountGrade = completeIds.filter(id => stats.gradeUnderachievers.has(id)).length;

                                const incompleteCountGrade = incompleteIds.filter(id => stats.gradeUnderachievers.has(id)).length;



                                // 보충지도 이수현황표(completionStatus) 기준으로 참여 인원 집계

                                // completionTotals와 preventiveHours에 있는 모든 학생 ID 수집

                                const completionStudentIds = new Set([

                                    ...stats.completionTotals.keys(),

                                    ...stats.preventiveHours.keys()

                                ]);

                                
                                
                                console.log(`[통계] 참여 인원 집계 시작: 과목=${subjectName}`, {

                                    completionTotalsSize: stats.completionTotals.size,

                                    preventiveHoursSize: stats.preventiveHours.size,

                                    completionTotalsSample: Array.from(stats.completionTotals.entries()).slice(0, 3),

                                    preventiveHoursSample: Array.from(stats.preventiveHours.entries()).slice(0, 3)

                                });

                                
                                
                                // 보충지도 참여 인원: completionTotals에서 total > 0인 학생 수

                                const supplementaryParticipantsCount = Array.from(stats.completionTotals.values())

                                    .filter(total => total > 0).length;
                                
                                
                                
                                // 보충지도 미참여 인원: 대상자 중 참여하지 않은 학생 수

                                const supplementaryNonParticipantsCount = attendanceIds.filter(id => {

                                    const total = stats.completionTotals.get(id);

                                    return total == null || total <= 0;

                                }).length;

                                
                                
                                // 추가학습 대상자: 과목출석률만 미도달한 학생 (학업성취율 미도달 제외)

                                const additionalLearningTargets = attendanceIds.filter(id => 

                                    !stats.gradeUnderachievers.has(id)

                                );

                                
                                
                                // 추가학습 참여 인원: 추가학습 대상자 중 보충지도 이수시간이 있는 학생 수

                                const additionalParticipantsCount = additionalLearningTargets.filter(id => {

                                    const total = stats.completionTotals.get(id);

                                    return total != null && total > 0;

                                }).length;

                                
                                
                                // 추가학습 미참여 인원: 추가학습 대상자 중 보충지도 이수시간이 없는 학생 수

                                const additionalNonParticipantsCount = additionalLearningTargets.filter(id => {

                                    const total = stats.completionTotals.get(id);

                                    return total == null || total <= 0;

                                }).length;

                                
                                
                                // 추가학습 예외처리 인원: 추가학습 대상자 중 예외처리된 학생 수

                                const additionalExceptionCount = additionalLearningTargets.filter(id => 

                                    stats.exceptions.has(id)

                                ).length;



                                // 예방지도 참여 인원: preventiveHours에서 hours > 0인 학생 수

                                const preventiveParticipantList = Array.from(stats.preventiveHours.entries())

                                    .filter(([id, hours]) => hours > 0)

                                    .map(([id]) => id);

                                const preventiveParticipantSet = new Set(preventiveParticipantList);

                                
                                
                                // 예방지도 미참여 인원: 대상자 중 참여하지 않은 학생 수

                                const preventiveNonParticipants = Array.from(stats.preventionTargets).filter(id => 

                                    !preventiveParticipantSet.has(id)

                                );

                                
                                
                                console.log(`[통계] 참여 인원 집계 완료: 과목=${subjectName}`, {

                                    supplementaryParticipants: supplementaryParticipantsCount,

                                    preventiveParticipants: preventiveParticipantSet.size

                                });



                                subjectSummary.push({

                                    subjectName,

                                    credits: stats.credits,

                                    grade: stats.grade,

                                    semester: stats.semester,

                                    category: stats.category,

                                    gradeCount: gradeIds.length,

                                    attendanceCount: attendanceIds.length,

                                    exceptionCount,

                                    completeCount,

                                    incompleteCount

                                });



                                preventionSummary.push({

                                    subjectName,

                                    grade: stats.grade,

                                    semester: stats.semester,

                                    category: stats.category,

                                    hasPrevention: preventiveParticipantSet.size > 0 || stats.preventionSessions > 0,

                                    participants: preventiveParticipantSet.size,

                                    nonParticipants: preventiveNonParticipants.length

                                });



                                // 추가학습 이수/미이수 인원: 추가학습 대상자 중 이수/미이수 학생 수

                                const additionalCompleteCount = additionalLearningTargets.filter(id => 

                                    stats.completion.complete.has(id)

                                ).length;

                                const additionalIncompleteCount = additionalLearningTargets.filter(id => 

                                    stats.completion.incomplete.has(id)

                                ).length;

                                
                                
                                additionalSummary.push({

                                    subjectName,

                                    credits: stats.credits,

                                    grade: stats.grade,

                                    semester: stats.semester,

                                    category: stats.category,

                                    attendanceTargets: additionalLearningTargets.length,

                                    participants: additionalParticipantsCount,

                                    exceptionCount: additionalExceptionCount,

                                    nonParticipants: additionalNonParticipantsCount,

                                    completeCount: additionalCompleteCount,

                                    incompleteCount: additionalIncompleteCount

                                });



                                const gradeParticipantCount = gradeIds.filter(id => {

                                    const total = stats.completionTotals.get(id);

                                    if (total != null) return total > 0;

                                    return stats.supplementaryParticipants.has(id);

                                }).length;

                                const gradeNonParticipantCount = gradeIds.filter(id => {

                                    const total = stats.completionTotals.get(id);

                                    if (total != null) return total <= 0;

                                    return !stats.supplementaryParticipants.has(id);

                                }).length;



                                remedialSummary.push({

                                    subjectName,

                                    credits: stats.credits,

                                    grade: stats.grade,

                                    semester: stats.semester,

                                    category: stats.category,

                                    gradeTargets: gradeIds.length,

                                    participants: gradeParticipantCount,

                                    nonParticipants: gradeNonParticipantCount,

                                    exceptionCount: exceptionCountGrade,

                                    completeCount: completeCountGrade,

                                    incompleteCount: incompleteCountGrade

                                });



                                const gradeCount = stats.gradeUnderachievers.size;

                                const attendanceCount = stats.attendanceUnderachievers.size;

                                const bothCount = [...stats.gradeUnderachievers].filter(studentId => stats.attendanceUnderachievers.has(studentId)).length;

                                deficitSummary.push({

                                    subjectName,

                                    grade: stats.grade,

                                    semester: stats.semester,

                                    category: stats.category,

                                    gradeCount,

                                    attendanceCount,

                                    bothCount

                                });

                            });



                            subjectSummary.sort((a, b) => a.subjectName.localeCompare(b.subjectName, 'ko'));

                            preventionSummary.sort((a, b) => a.subjectName.localeCompare(b.subjectName, 'ko'));

                            additionalSummary.sort((a, b) => a.subjectName.localeCompare(b.subjectName, 'ko'));

                            remedialSummary.sort((a, b) => a.subjectName.localeCompare(b.subjectName, 'ko'));

                            deficitSummary.sort((a, b) => a.subjectName.localeCompare(b.subjectName, 'ko'));



                            const multiSubjectBuckets = [

                                { label: '1과목', count: 0 },

                                { label: '2~3과목', count: 0 },

                                { label: '4~5과목', count: 0 },

                                { label: '6과목 이상', count: 0 }

                            ];

                            gradeSubjectCounter.forEach(count => {

                                if (count === 1) multiSubjectBuckets[0].count += 1;

                                else if (count >= 2 && count <= 3) multiSubjectBuckets[1].count += 1;

                                else if (count >= 4 && count <= 5) multiSubjectBuckets[2].count += 1;

                                else if (count >= 6) multiSubjectBuckets[3].count += 1;

                            });



                            const gradePreventionRatios = ['1', '2', '3'].map(grade => {

                                const total = gradeTotals[grade]?.size || 0;

                                const participants = gradeParticipants[grade]?.size || 0;

                                const percentage = total > 0 ? Number(((participants / total) * 100).toFixed(1)) : 0;

                                return {

                                    grade: `${grade}학년`,

                                    total,

                                    participants,

                                    percentage

                                };

                            });



                            const preventionCourseRatio = {

                                totalSubjects: planSubjects.size,

                                activeSubjects: preventionSubjects.size,

                                percentage: planSubjects.size > 0

                                    ? Number(((preventionSubjects.size / planSubjects.size) * 100).toFixed(1))

                                    : 0

                            };



                            this.statisticsState.subjectSummary = subjectSummary;

                            this.statisticsState.preventionSummary = preventionSummary;

                            this.statisticsState.additionalSummary = additionalSummary;

                            this.statisticsState.remedialSummary = remedialSummary;

                            this.statisticsState.deficitSummary = deficitSummary;

                            this.statisticsState.multiSubjectBuckets = multiSubjectBuckets;

                            this.statisticsState.gradePreventionRatios = gradePreventionRatios;

                            this.statisticsState.preventionCourseRatio = preventionCourseRatio;

                            this.statisticsState.lastUpdated = new Date().toLocaleString('ko-KR');

                        } catch (error) {

                            console.error('통계 대시보드 계산 오류:', error);

                            this.statisticsState.error = error.message || '통계 데이터를 계산하는 중 오류가 발생했습니다.';

                        } finally {

                            this.statisticsState.loading = false;

                        }

                    },



                    // --- [핵심 수정] Initialization and Auth ---

                    async initApp() {

                        console.log("initApp called");

                        onAuthStateChanged(auth, async (user) => {

                            console.log("onAuthStateChanged triggered with user:", user ? user.email : null);

                            this.isLoading = true;

                            try {

                                if (user) {

                                    console.log("User is present. Setting up session.");

                                    this.user = user;

                                    this.isLoggedIn = true;

                                    await this.loadUserRoleAndSchoolId();

                                    console.log("Loaded role:", this.role, "and schoolId:", this.schoolId);



                                    if (this.role && this.schoolId) {

                                        console.log("Role and schoolId exist. Loading all data.");

                                        await this.fetchCurrentSchoolCode();

                                        await this.loadCommonData();

                                        if (this.role === '교과교사') {

                                            await this.loadAllTeacherData();

                                            // localStorage에서 로드한 후 현재 선택된 과목의 계획서 설정
                                            if (this.currentSubjectIndex >= 0 && this.currentSubjectIndex < this.teacherPlanList.length) {

                                                await this.loadSubjectData(this.currentSubjectIndex);

                                                if (this.teacherPlan.subjectName) {

                                                    await this.loadGuidanceData();

                                                    this.filterSupplementaryStudents();

                                                    this.filterAdditionalStudents();
                                                }

                                            }

                                        } else if (this.role === '관리자') {

                                        // loadCommonData() 내부에서 이미 localStorage나 Firestore에서 데이터를 로드하므로
                                        // 여기서 deployedUnderachievers로 덮어쓰지 않음
                                        // this.underachievers는 loadCommonData()에서 이미 설정됨
                                        }

                                    } else if (this.isLoggedIn && this.role && !this.schoolId) {

                                        console.log("Role exists, but schoolId is missing. Showing schoolId modal.");

                                        this.schoolIdMode = this.role === '관리자' ? 'create' : 'join';

                                        this.currentSchoolCode = '';

                                    this.newSchoolId = '';

                                    this.schoolIdError = '';

                                        this.showSchoolIdModal = true;

                                    } else {

                                        console.log("No role assigned. Role selection modal will be shown.");

                                    }

                                } else {

                                    console.log("User is null. Resetting application state.");

                                    this.user = null;

                                    this.isLoggedIn = false;

                                    this.resetAllLocalData();

                                }

                            } catch (error) {

                                console.error("Error during auth state change processing:", error);

                                this.resetAllLocalData();

                            } finally {

                                console.log("Auth processing finished. Setting isLoading to false.");

                                this.isLoading = false;

                                this.$nextTick(() => {

                                    this.initFlatpickr();

                                });

                            }

                        });

                    },

                    async login() {

                        const provider = new GoogleAuthProvider();

                        try {

                            const result = await signInWithPopup(auth, provider);

                            this.user = result.user;

                            this.isLoggedIn = true;

                            console.log("로그인 성공:", this.user.email);

                            await this.loadUserRoleAndSchoolId();

                        } catch (error) {

                            console.error("로그인 실패:", error);

                            alert("Google 로그인 실패: " + error.message);

                        }

                    },

                    async logout() {

                        try {

                            // 로그아웃 전 데이터 저장 (교과교사인 경우)

                            if (this.role === '교과교사' && this.schoolId && this.user) {

                                try {

                                    // 계획서 저장

                                    if (this.teacherPlan.subjectName) {

                                        await this.saveTeacherPlan();

                                        console.log("로그아웃: 계획서 저장 완료");

                                    }

                                    
                                    
                                    // 출석부 및 수업일지 저장

                                    const saveResult = await this.saveGuidanceData();

                                    if (saveResult && saveResult.success) {

                                        console.log("로그아웃: 출석부 데이터 저장 완료");

                                    } else {

                                        console.warn("로그아웃: 출석부 데이터 저장 실패", saveResult?.message);

                                    }

                                } catch (saveError) {

                                    console.error("Logout 전 데이터 저장 중 오류:", saveError);

                                    // 저장 실패해도 로그아웃은 진행하되, 사용자에게 알림

                                    alert(`데이터 저장 중 오류가 발생했습니다: ${saveError.message}. 로그아웃은 진행됩니다.`);

                                }

                            }

                            await signOut(auth);

                        } catch (error) { console.error("Logout failed:", error); alert(`로그아웃 실패: ${error.message}`); }

                    },



                    async fetchCurrentSchoolCode() {

                        if (!db || !this.schoolId) {

                            this.currentSchoolCode = '';

                            return null;

                        }

                        try {

                            const codesRef = collection(db, 'schoolCodes');

                            const q = query(codesRef, where('canonicalSchoolId', '==', this.schoolId));

                            const snapshot = await getDocs(q);

                            if (!snapshot.empty) {

                                const docs = snapshot.docs;

                                const activeDoc = docs.find(docSnap => {

                                    const data = docSnap.data();

                                    return !(data && data.disabled);

                                });

                                const targetDoc = activeDoc || docs[0];

                                this.currentSchoolCode = targetDoc.id;

                                return targetDoc.data();

                            } else {

                                this.currentSchoolCode = this.schoolId;

                                return null;

                            }

                        } catch (error) {

                            console.error('학교코드 조회 중 오류:', error);

                            this.currentSchoolCode = '';

                            return null;

                        }

                    },



                    setSchoolIdMode(mode) {

                        if (this.role !== '관리자') return;

                        if (mode !== 'create' && mode !== 'input') return;

                        if (this.schoolIdMode === mode) return;

                        this.schoolIdMode = mode;

                        this.schoolIdError = '';

                        this.newSchoolId = '';

                    },



                    // --- Role Management ---

                    async selectRole(selectedRole) {

                        console.log("selectRole called with:", selectedRole);

                        if (!this.user) { alert("사용자 정보가 없습니다. 다시 로그인해주세요."); return; }

                        
                        
                        // 이전 상태 초기화

                        this.showAdminCodeInput = false;

                        this.adminCodeError = '';

                        this.schoolIdError = '';

                        this.newSchoolId = '';

                        this.currentSchoolCode = '';

                        
                        
                        if (selectedRole === '관리자') {

                            console.log("관리자 선택됨, 코드 입력창 표시");

                            this.showAdminCodeInput = true;

                            this.schoolIdMode = 'create';

                            console.log("showAdminCodeInput 설정됨:", this.showAdminCodeInput);

                        } else {

                            console.log("교과교사/담임교사 선택됨:", selectedRole);

                            this.role = selectedRole;

                            // 교과교사/담임교사는 항상 학교 ID 모달 표시

                            this.schoolIdMode = 'join';

                            this.showSchoolIdModal = true;

                            console.log("role 설정됨:", this.role, "showSchoolIdModal:", this.showSchoolIdModal);

                        }

                    },

                    async submitAdminCode() {

                        if (this.adminCode === '0822') {

                            this.adminCodeError = '';

                            this.showAdminCodeInput = false;

                            this.role = '관리자';

                            this.isLoading = true;

                            await this.saveUserRoleAndSchoolId('관리자');

                            if (this.schoolId) {

                                await this.loadCommonData();

                                // loadCommonData() 내부에서 이미 localStorage나 Firestore에서 데이터를 로드하므로
                                // 여기서 deployedUnderachievers로 덮어쓰지 않음
                                // this.underachievers는 loadCommonData()에서 이미 설정됨
                                this.isLoading = false;

                            } else {

                                this.schoolIdMode = 'create';

                                this.newSchoolId = '';

                                this.schoolIdError = '';

                                this.showSchoolIdModal = true;

                                this.isLoading = false;

                            }

                            this.$nextTick(() => { this.initFlatpickr(); });

                        } else {

                            this.adminCodeError = '코드가 올바르지 않습니다.';

                        }

                        this.adminCode = '';

                    },

                    async finalizeSchoolCodeSelection(code, canonicalId) {

                        const effectiveCanonicalId = canonicalId || code;

                        const previousSchoolCode = this.currentSchoolCode;
                        const previousSchoolId = this.schoolId;
                        
                        this.schoolId = effectiveCanonicalId;

                        this.currentSchoolCode = code || effectiveCanonicalId;

                        this.showSchoolIdModal = false;

                        
                        
                        console.log("학교코드 최종 확정:", this.currentSchoolCode, "실제 ID:", this.schoolId, "역할:", this.role);

                        
                        // 학교코드가 변경된 경우 이전 학교코드의 로컬 데이터 초기화
                        // previousSchoolCode가 없거나 변경된 경우 모두 처리 (새 학교코드 생성 포함)
                        const isSchoolCodeChanged = !previousSchoolCode || previousSchoolCode !== this.currentSchoolCode;
                        
                        if (this.user && isSchoolCodeChanged) {
                            // 이전 학교코드가 있는 경우에만 localStorage에서 삭제
                            if (previousSchoolCode) {
                                // 교과교사 데이터 초기화
                                if (this.role === '교과교사') {
                                    const previousStorageKey = `minAchieve_teacher_${this.user.uid}_${previousSchoolCode}`;
                                    try {
                                        localStorage.removeItem(previousStorageKey);
                                        console.log("이전 학교코드의 교과교사 데이터 초기화:", previousStorageKey);
                                    } catch (error) {
                                        console.warn("이전 학교코드 데이터 초기화 실패:", error);
                                    }
                                }
                                // 관리자 데이터 초기화
                                if (this.role === '관리자') {
                                    const previousAdminStorageKey = `minAchieve_admin_${this.user.uid}_${previousSchoolCode}`;
                                    try {
                                        localStorage.removeItem(previousAdminStorageKey);
                                        console.log("이전 학교코드의 관리자 미도달 대상자 명단 초기화:", previousAdminStorageKey);
                                    } catch (error) {
                                        console.warn("이전 학교코드 관리자 데이터 초기화 실패:", error);
                                    }
                                }
                            }
                            
                            // 메모리상의 데이터도 초기화 (새 학교코드 생성 또는 변경 시)
                            if (this.role === '교과교사') {
                                this.teacherPlanList = [];
                                this.teacherGuidanceDataList = [];
                                this.currentSubjectIndex = -1;
                                this.teacherPlan = this.getInitialTeacherPlan();
                                this.teacherGuidanceData = this.getInitialGuidanceData();
                            }
                            if (this.role === '관리자') {
                                this.underachievers = [];
                                this.curriculumData = [];
                                this.studentData = [];
                                this.emotionalSupportData = [];
                                this.uploadStatus = {
                                    curriculum: '',
                                    student: '',
                                    emotionalSupport: ''
                                };
                            }
                        }
                        
                            await this.saveUserRoleAndSchoolId(this.role);

                            console.log("사용자 데이터 저장 완료");

                            
                            
                            await this.loadCommonData();

                            console.log("공용 데이터 로딩 완료");
                            
                            

                        // loadCommonData() 내부에서 이미 localStorage나 Firestore에서 데이터를 로드하므로
                        // 여기서 deployedUnderachievers로 덮어쓰지 않음
                        // this.underachievers는 loadCommonData()에서 이미 설정됨


                        if (this.role === '교과교사') {

                                console.log("교과교사 데이터 로딩 시작");

                                await this.loadAllTeacherData();

                                if (this.currentSubjectIndex >= 0 && this.currentSubjectIndex < this.teacherPlanList.length) {

                                    await this.loadSubjectData(this.currentSubjectIndex);

                                    console.log("교과교사 계획안 로딩 완료");

                                    if (this.teacherPlan.subjectName) {

                                        console.log("과목명 존재, 지도 자료 로딩 시작:", this.teacherPlan.subjectName);

                                        await this.loadGuidanceData();

                                        this.filterSupplementaryStudents();

                                        this.filterAdditionalStudents();
                                        console.log("지도 자료 로딩 완료");

                                    } else {

                                        console.log("과목명 없음, 지도 자료 로딩 건너뜀");

                                    }

                                }

                            }

                            
                            
                            this.newSchoolId = '';

                        await this.fetchCurrentSchoolCode();

                            this.$nextTick(() => { 

                                this.initFlatpickr();

                                console.log("Vue 상태 갱신 완료");

                            });

                        console.log("학교코드 설정 절차 완료");

                    },

                    async handleSchoolIdSubmit() {

                        const codeInput = this.newSchoolId.trim();

                        const invalidChars = /[\s./*#$[\]]/;

                        
                        
                        this.schoolIdError = '';

                        if (!codeInput) { this.schoolIdError = "학교코드를 입력해주세요."; return; }

                        if (invalidChars.test(codeInput)) { this.schoolIdError = "공백이나 특수문자 (/, ., *, # 등)는 사용할 수 없습니다."; return; }

                        if (this.role === '관리자' && !['create', 'input'].includes(this.schoolIdMode)) {

                            this.schoolIdError = "먼저 생성 또는 입력 경로를 선택해주세요.";

                            return;

                        }



                        this.isLoading = true;



                        try {

                            console.log("학교코드 처리 시작:", codeInput, "역할:", this.role, "모드:", this.schoolIdMode);

                            let canonicalId = null;



                            if (this.role === '관리자' && this.schoolIdMode === 'create') {

                                const canonicalForCreate = this.schoolId || codeInput;

                                const codeRef = doc(db, `schoolCodes/${codeInput}`);

                                await runTransaction(db, async (transaction) => {

                                    const codeSnap = await transaction.get(codeRef);

                                    if (codeSnap.exists()) {

                                        throw new Error('이미 사용 중인 학교코드입니다. 다른 코드를 입력하세요.');

                                    }

                                    const nowIso = new Date().toISOString();

                                    transaction.set(codeRef, {

                                        ownerUid: this.user.uid,

                                        ownerEmail: this.user.email || null,

                                        canonicalSchoolId: canonicalForCreate,

                                        createdAt: nowIso,

                                        updatedAt: nowIso,

                                        disabled: false,

                                        previousCodes: []

                                    });

                                });

                                canonicalId = canonicalForCreate;

                                console.log("새 학교코드 트랜잭션 생성 완료:", codeInput, "canonical:", canonicalId);
                                
                                // 새 학교코드 생성 시 Firestore 공용 데이터 초기화
                                try {
                                    const commonDataBasePath = `schools/${canonicalId}/commonData`;
                                    const commonDataDocs = ['curriculum', 'students', 'emotionalSupport', 'underachievers', 'underachieversProcessed'];
                                    
                                    for (const docName of commonDataDocs) {
                                        const docRef = doc(db, commonDataBasePath, docName);
                                        await setDoc(docRef, { data: [] }, { merge: false });
                                    }
                                    console.log("새 학교코드의 Firestore 공용 데이터 초기화 완료:", canonicalId);
                                } catch (clearError) {
                                    console.warn("Firestore 공용 데이터 초기화 실패 (계속 진행):", clearError);
                                }

                            } else if (this.role === '관리자' && this.schoolIdMode === 'input') {

                                const codeRef = doc(db, `schoolCodes/${codeInput}`);

                                const codeSnap = await getDoc(codeRef);

                                if (!codeSnap.exists()) {

                                    throw new Error('등록되지 않은 학교코드입니다. 먼저 생성하세요.');

                                }

                                const codeData = codeSnap.data();

                                if (codeData.ownerUid !== this.user.uid) {

                                    throw new Error('다른 관리자 계정에서 생성한 학교코드입니다. 본인이 생성한 코드를 입력하세요.');

                                }

                                if (codeData.disabled) {

                                    throw new Error('사용이 중지된 학교코드입니다. 새로 발급된 코드를 사용하세요.');

                                }

                                canonicalId = codeData.canonicalSchoolId || codeInput;

                                console.log("기존 학교코드 소유자 검증 완료:", codeInput, "canonical:", canonicalId);

                            } else if (this.role !== '관리자') {

                                const codeRef = doc(db, `schoolCodes/${codeInput}`);

                                const codeSnap = await getDoc(codeRef);

                                if (!codeSnap.exists()) {

                                    throw new Error('등록되지 않은 학교코드입니다. 관리자에게 확인하세요.');

                                }

                                const codeData = codeSnap.data();

                                if (codeData.disabled) {

                                    throw new Error('사용이 중지된 학교코드입니다. 관리자에게 최신 코드를 문의하세요.');

                                }

                                canonicalId = codeData.canonicalSchoolId || codeInput;

                                console.log("교과/담임 교사용 학교코드 검증 완료:", codeInput, "canonical:", canonicalId);

                            }



                            if (!canonicalId) {

                                canonicalId = this.schoolId || codeInput;

                            }



                            await this.finalizeSchoolCodeSelection(codeInput, canonicalId);

                            this.schoolIdError = '';

                        } catch (error) {

                            console.error("학교코드 처리 중 오류:", error);

                            this.schoolIdError = error?.message || '학교코드 처리 중 오류가 발생했습니다.';

                        } finally {

                            this.isLoading = false;

                            console.log("학교코드 처리 종료 - role:", this.role, "schoolId:", this.schoolId, "currentCode:", this.currentSchoolCode, "isLoading:", this.isLoading);

                        }

                    },

                    async resetRole() {

                        // 원래 역할과 학교ID를 임시 저장 (취소 시 복원용)

                        this.previousRole = this.role;

                        this.previousSchoolId = this.schoolId;

                        this.previousSchoolCode = this.currentSchoolCode;

                        
                        
                        this.role = null;

                        this.schoolId = null; // 메모리에서만 초기화 (DB에는 저장하지 않음)

                        this.currentSchoolCode = '';

                        // DB 저장은 사용자가 새 역할과 학교ID를 선택할 때만 수행

                        this.resetRoleSpecificData();

                        this.showAdminCodeInput = false;

                        this.adminCode = '';

                        this.adminCodeError = '';

                        this.statusMessage = '';

                    },

                    cancelRoleSelection() {

                        // 이전 역할로 복원

                        if (this.previousRole) {

                            this.role = this.previousRole;

                            this.schoolId = this.previousSchoolId;

                            this.currentSchoolCode = this.previousSchoolCode || '';

                            this.previousRole = null;

                            this.previousSchoolId = null;

                            this.previousSchoolCode = '';

                        } else {

                            // 이전 역할이 없으면 로그아웃

                            this.logout();

                        }

                        this.showAdminCodeInput = false;

                        this.adminCode = '';

                        this.adminCodeError = '';

                        this.statusMessage = '';

                    },

                    async saveUserRoleAndSchoolId(roleToSave) {

                        if (!this.user || !db) return;

                        const userDocRef = doc(db, `userData/${this.user.uid}`);

                        const dataToSave = { role: roleToSave, schoolId: this.schoolId };

                        try {

                            await setDoc(userDocRef, dataToSave, { merge: true });

                        } catch (error) { console.error("Error saving user data:", error); }

                    },

                    async loadUserRoleAndSchoolId() {

                        if (!this.user || !db) { this.role = null; this.schoolId = null; return; };

                        const userDocRef = doc(db, `userData/${this.user.uid}`);

                        try {

                            const userDocSnap = await getDoc(userDocRef);

                            if (userDocSnap.exists()) {

                                const data = userDocSnap.data();

                                this.role = data.role || null;

                                this.schoolId = data.schoolId || null;

                            } else {

                                this.role = null;

                                this.schoolId = null;

                            }

                        } catch (error) { console.error("Error loading user data:", error); this.role = null; this.schoolId = null; }

                    },



                    // --- Data Loading (Common) ---

                    async loadCommonData() {

                        if (!db) {

                            console.error("Firestore db가 초기화되지 않았습니다.");

                            return;

                        }

                        // currentSchoolCode를 우선 사용, 없으면 schoolId 사용

                        const activeSchoolId = this.currentSchoolCode || this.schoolId;

                        if (!activeSchoolId) {

                            console.error("schoolId 또는 currentSchoolCode가 설정되지 않았습니다. 데이터를 로드할 수 없습니다.");

                            // schoolId가 없으면 데이터만 초기화 (role과 schoolId는 유지)

                            this.curriculumData = []; 

                            this.studentData = []; 

                            this.emotionalSupportData = []; 

                            this.deployedUnderachievers = [];

                            return;

                        }

                        this.statusMessage = '공용 데이터 로딩 중...';

                        try {

                            const commonDataBasePath = `schools/${activeSchoolId}/commonData`;

                            console.log('[loadCommonData] 데이터 로드 경로:', commonDataBasePath, {

                                currentSchoolCode: this.currentSchoolCode,

                                schoolId: this.schoolId,

                                activeSchoolId: activeSchoolId

                            });

                            const [

                                curriculumSnap, studentsSnap, emotionalSupportSnap,

                                moduleConfigSnap, formTemplatesSnap, underachieversSnap, underachieversProcessedSnap

                            ] = await Promise.all([

                                getDoc(doc(db, commonDataBasePath, "curriculum")),

                                getDoc(doc(db, commonDataBasePath, "students")),

                                getDoc(doc(db, commonDataBasePath, "emotionalSupport")),

                                getDoc(doc(db, commonDataBasePath, "moduleConfig")),

                                getDoc(doc(db, commonDataBasePath, "formTemplates")),

                                getDoc(doc(db, commonDataBasePath, "underachievers")),

                                getDoc(doc(db, commonDataBasePath, "underachieversProcessed"))

                            ]);



                            this.curriculumData = curriculumSnap.exists() ? curriculumSnap.data().data || [] : [];

                            
                            
                            // 업로드 상태 표시 (관리자인 경우)

                            if (this.role === '관리자') {

                                if (curriculumSnap.exists() && curriculumSnap.data().data && curriculumSnap.data().data.length > 0) {

                                    this.uploadStatus.curriculum = `✓ 교육과정 편제표 업로드 완료 (${curriculumSnap.data().data.length}개 항목)`;

                                }

                                if (studentsSnap.exists() && studentsSnap.data().data && studentsSnap.data().data.length > 0) {

                                    this.uploadStatus.student = `✓ 학적 정보 업로드 완료 (${studentsSnap.data().data.length}명)`;

                                }

                                if (emotionalSupportSnap.exists() && emotionalSupportSnap.data().data && emotionalSupportSnap.data().data.length > 0) {

                                    this.uploadStatus.emotionalSupport = `✓ 정서지원프로그램 이수시간 업로드 완료 (${emotionalSupportSnap.data().data.length}명)`;

                                }

                            }

                            
                            
                            // studentData 로딩 및 디버깅 (기존 'student' 문서와 새 'students' 문서 모두 확인)

                            let studentDataLoaded = false;

                            if (studentsSnap.exists()) {

                                const studentsDataObj = studentsSnap.data();

                                console.log("학적 정보 문서 ('students') 존재함:", {

                                    hasDataField: 'data' in studentsDataObj,

                                    dataType: typeof studentsDataObj.data,

                                    dataIsArray: Array.isArray(studentsDataObj.data),

                                    dataLength: Array.isArray(studentsDataObj.data) ? studentsSnap.data().data.length : 'not array'

                                });

                                this.studentData = studentsSnap.data().data || [];

                                studentDataLoaded = true;

                            } else {

                                // 기존에 'student'로 저장된 문서 확인 (하위 호환성)

                                console.log("'students' 문서가 없음. 기존 'student' 문서 확인 중...");

                                try {

                                    const studentSnap = await getDoc(doc(db, commonDataBasePath, "student"));

                                    if (studentSnap.exists()) {

                                        console.log("기존 'student' 문서 발견 및 로드 완료");

                                        this.studentData = studentSnap.data().data || [];

                                        studentDataLoaded = true;

                                        // 자동 마이그레이션: 'students'로 복사

                                        await setDoc(doc(db, commonDataBasePath, "students"), { data: this.studentData });

                                        console.log("자동 마이그레이션 완료: 'student' → 'students'");

                                    }

                                } catch (migrationError) {

                                    console.error("기존 문서 확인 중 오류:", migrationError);

                                }

                            }

                            
                            
                            if (!studentDataLoaded) {

                                console.warn("학적 정보 문서가 존재하지 않습니다:", `schools/${this.schoolId}/commonData/students` + " 또는 " + `schools/${this.schoolId}/commonData/student`);

                                this.studentData = [];

                            }

                            
                            
                            console.log("로드된 studentData:", {

                                length: this.studentData.length,

                                firstItem: this.studentData.length > 0 ? this.studentData[0] : null,

                                schoolId: this.schoolId

                            });

                            
                            
                            this.emotionalSupportData = emotionalSupportSnap.exists() ? emotionalSupportSnap.data().data || [] : [];

                            
                            
                            const defaultModuleConfig = this.$options.data().moduleConfig;
                            
                            const loadedConfig = moduleConfigSnap.exists() ? moduleConfigSnap.data() : {};
                            
                            // 기존 hoursPerCredit을 hoursPerCreditByCategory로 마이그레이션
                            if (loadedConfig.hoursPerCredit && (!loadedConfig.hoursPerCreditByCategory || Object.keys(loadedConfig.hoursPerCreditByCategory).length === 0)) {
                                // 모든 계열에 동일한 값 적용
                                const hoursPerCredit = loadedConfig.hoursPerCredit;
                                loadedConfig.hoursPerCreditByCategory = {};
                                if (this.curriculumData && this.curriculumData.length > 0) {
                                    const categories = new Set();
                                    this.curriculumData.forEach(row => {
                                        if (row && row['분류']) {
                                            const category = String(row['분류']).trim();
                                            if (category) categories.add(category);
                                        }
                                    });
                                    if (categories.size === 0) categories.add('인문계열');
                                    categories.forEach(cat => {
                                        loadedConfig.hoursPerCreditByCategory[cat] = hoursPerCredit;
                                    });
                                } else {
                                    loadedConfig.hoursPerCreditByCategory['인문계열'] = hoursPerCredit;
                                }
                                // 기존 필드 제거
                                delete loadedConfig.hoursPerCredit;
                            }

                            this.moduleConfig = { ...defaultModuleConfig, ...loadedConfig };

                            
                            
                            const defaultNewsletter = this.$options.data().newsletterForm;

                            const defaultPledge = this.$options.data().pledgeForm;

                            if (formTemplatesSnap.exists()) {

                                const templatesData = formTemplatesSnap.data();

                                this.newsletterForm = templatesData.newsletter ? { ...defaultNewsletter, ...templatesData.newsletter } : defaultNewsletter;

                                this.pledgeForm = templatesData.pledge ? { ...defaultPledge, ...templatesData.pledge } : defaultPledge;

                            } else {

                                this.newsletterForm = defaultNewsletter;

                                this.pledgeForm = defaultPledge;

                            }



                            const deployedDataRaw = underachieversSnap.exists() ? underachieversSnap.data().data || [] : [];

                            this.deployedUnderachievers = this.normalizeUnderachieverList(deployedDataRaw);

                            
                            
                            // 관리자인 경우, 처리된 미도달 대상자 목록 불러오기

                            if (this.role === '관리자') {
                                // localStorage에서 먼저 확인 (저장된 데이터가 최우선)
                                // 사용자 ID와 학교코드가 모두 포함된 키 사용
                                const adminStorageKey = this.getAdminLocalStorageKey();
                                let loadedFromLocalStorage = false;
                                try {
                                    if (adminStorageKey) {
                                        const localData = localStorage.getItem(adminStorageKey);
                                        if (localData) {
                                            const parsed = JSON.parse(localData);
                                            if (parsed && parsed.underachievers && Array.isArray(parsed.underachievers) && parsed.underachievers.length > 0) {
                                                const processedData = this.normalizeUnderachieverList(parsed.underachievers);
                                                // localStorage에 저장된 데이터가 있으면 항상 사용 (저장된 데이터가 최신)
                                                this.underachievers = processedData;
                                                this.statusMessage = `공용 데이터 로딩 완료. (로컬 저장된 미도달 대상자 ${processedData.length}명 불러옴)`;
                                                loadedFromLocalStorage = true;
                                                console.log('관리자 미도달 대상자 명단이 localStorage에서 로드되었습니다.', { 
                                                    adminStorageKey,
                                                    count: processedData.length,
                                                    lastUpdated: parsed.lastUpdated
                                                });
                                            }
                                        }
                                    }
                                } catch (localStorageError) {
                                    console.warn('localStorage 로드 실패:', localStorageError);
                                }
                                
                                // localStorage에 없으면 빈 배열로 시작 (로컬 환경별로 완전히 분리)
                                // Firestore에서 로드하지 않음 (다른 로컬 환경과 공유되지 않도록)
                                if (!loadedFromLocalStorage) {
                                    this.underachievers = [];
                                    this.statusMessage = '공용 데이터 로딩 완료. (로컬 저장된 미도달 대상자 명단 없음)';
                                    console.log('로컬 저장소에 미도달 대상자 명단이 없습니다. 빈 배열로 시작합니다.', { adminStorageKey });
                                }

                            } else {

                                this.underachievers = this.normalizeUnderachieverList(this.deployedUnderachievers);

                                this.statusMessage = '공용 데이터 로딩 완료.';

                            }

                        } catch (error) {

                            console.error("Error loading common data:", error);

                            this.statusMessage = '공용 데이터 로딩 중 오류 발생.';

                            this.curriculumData = []; this.studentData = []; this.emotionalSupportData = []; this.deployedUnderachievers = [];

                        } finally {

                            setTimeout(() => this.statusMessage = '', 2000);

                            if (this.role) {

                                this.$nextTick(() => { this.initFlatpickr(); });

                            }

                        }

                    },



                    // --- Data Saving (Admin) ---

                    async uploadFile(event, type) {

                        // currentSchoolCode를 우선 사용, 없으면 schoolId 사용

                        const activeSchoolId = this.currentSchoolCode || this.schoolId;

                        if (!activeSchoolId) { alert("학교코드가 설정되지 않았습니다. '학교 코드 수정 및 발급' 메뉴에서 코드를 먼저 설정해주세요."); event.target.value = null; return; }

                        if (this.role !== '관리자' || !db) { event.target.value = null; return; }



                        const file = event.target.files[0];

                        if (!file) return;

                        this.uploadStatus[type] = `${file.name} 처리 및 저장 중...`;



                        const reader = new FileReader();

                        reader.onload = async (e) => {

                            try {

                                const data = new Uint8Array(e.target.result);

                                const workbook = XLSX.read(data, { type: 'array' });

                                const sheetName = workbook.SheetNames[0];

                                const worksheet = workbook.Sheets[sheetName];

                                const jsonData = XLSX.utils.sheet_to_json(worksheet);



                                // 문서 이름 매핑 (일관성 유지)

                                const docNameMap = {

                                    'curriculum': 'curriculum',

                                    'student': 'students',  // 'student'를 'students'로 매핑

                                    'emotionalSupport': 'emotionalSupport'

                                };

                                const docName = docNameMap[type] || type;

                                const docRef = doc(db, `schools/${activeSchoolId}/commonData`, docName);

                                console.log('[uploadFile] 데이터 저장 경로:', `schools/${activeSchoolId}/commonData/${docName}`, {

                                    currentSchoolCode: this.currentSchoolCode,

                                    schoolId: this.schoolId,

                                    activeSchoolId: activeSchoolId,

                                    type: type

                                });

                                await setDoc(docRef, { data: jsonData });



                                if (type === 'curriculum') this.curriculumData = jsonData;

                                if (type === 'student') this.studentData = jsonData;

                                if (type === 'emotionalSupport') this.emotionalSupportData = jsonData;



                                this.uploadStatus[type] = `✓ ${file.name} 업로드 및 저장 완료 (${new Date().toLocaleString('ko-KR')})`;

                                this.updateMaxHours();

                                // 성공 알림

                                setTimeout(() => {

                                    alert(`${type === 'curriculum' ? '교육과정 편제표' : type === 'student' ? '학적 정보' : '정서지원프로그램 이수시간'} 파일이 성공적으로 업로드 및 저장되었습니다.`);

                                }, 100);

                            } catch (error) {

                                console.error(`Error processing/saving ${type} file:`, error);

                                this.uploadStatus[type] = `${file.name} 처리/저장 중 오류 발생: ${error.message}`;

                            } finally {

                                event.target.value = null;

                            }

                        };

                        reader.readAsArrayBuffer(file);

                    },

                    async saveModuleConfig() {

                        // currentSchoolCode를 우선 사용, 없으면 schoolId 사용

                        const activeSchoolId = this.currentSchoolCode || this.schoolId;

                        if (!activeSchoolId) { alert("학교코드가 설정되지 않았습니다. '학교 코드 수정 및 발급' 메뉴에서 코드를 먼저 설정해주세요."); return; }

                        if (this.role !== '관리자' || !db) return;

                        this.moduleConfigStatus = "운영 모듈 설정 저장 중...";

                        try {

                            const docRef = doc(db, `schools/${activeSchoolId}/commonData`, "moduleConfig");

                            const configToSave = JSON.parse(JSON.stringify(this.moduleConfig));
                            
                            // 기존 hoursPerCredit 필드 제거 (있으면)
                            if (configToSave.hoursPerCredit) {
                                delete configToSave.hoursPerCredit;
                            }

                            await setDoc(docRef, configToSave);

                            this.moduleConfigStatus = "운영 모듈 설정이 저장되었습니다.";

                        } catch (error) { console.error("Error saving module config:", error); this.moduleConfigStatus = "저장 중 오류 발생."; }

                        setTimeout(() => this.moduleConfigStatus = '', 3000);

                    },

                    async saveFormTemplates(){

                        // currentSchoolCode를 우선 사용, 없으면 schoolId 사용

                        const activeSchoolId = this.currentSchoolCode || this.schoolId;

                        if (!activeSchoolId) { alert("학교코드가 설정되지 않았습니다. '학교 코드 수정 및 발급' 메뉴에서 코드를 먼저 설정해주세요."); return; }

                        if (this.role !== '관리자' || !db) return;

                        this.adminActionStatus = '양식 저장 중...';

                        try {

                            const docRef = doc(db, `schools/${activeSchoolId}/commonData`, "formTemplates");

                            const templatesToSave = {

                                newsletter: JSON.parse(JSON.stringify(this.newsletterForm)),

                                pledge: JSON.parse(JSON.stringify(this.pledgeForm))

                            };

                            await setDoc(docRef, templatesToSave);

                            this.adminActionStatus = '가정통신문 및 서약서 양식이 저장되었습니다.';

                            alert('양식 저장이 완료되었습니다.');

                        } catch (error) { console.error("Error saving form templates:", error); this.adminActionStatus = '양식 저장 실패.'; }

                        setTimeout(() => this.adminActionStatus = '', 3000);

                    },

                    openUnderachieverExportModal() {
                        if (this.role !== '관리자') return;
                        // 화면에 사용 중인 groupedUnderachievers( details 포함 ) 기준으로 과목 목록 추출
                        const subjectsSet = new Set();
                        (this.groupedUnderachievers || []).forEach(student => {
                            if (!student || !Array.isArray(student.details)) return;
                            student.details.forEach(detail => {
                                if (!detail || !detail.subjects) return;
                                // '과목명(4학점), 과목명(3학점)...' 형태의 토큰을 그대로 사용
                                // 과목명이 같아도 학점이 다르면 서로 다른 항목으로 구분되도록 함
                                const parts = String(detail.subjects).split(/[,]/).map(s => s.trim()).filter(Boolean);
                                parts.forEach(p => {
                                    if (p) subjectsSet.add(p);
                                });
                            });
                        });
                        this.underachieverExportSubjects = Array.from(subjectsSet).sort();
                        this.underachieverExportMode = 'all';
                        this.underachieverExportSubject = '';
                        this.showUnderachieverExportModal = true;
                    },
                    closeUnderachieverExportModal() {
                        this.showUnderachieverExportModal = false;
                    },
                    exportUnderachieversToExcel() {
                        if (this.role !== '관리자') return;
                        // groupedUnderachievers(계산된 details 구조)를 사용하여 엑셀 행 생성
                        const baseList = this.groupedUnderachievers || [];
                        if (!baseList.length) {
                            alert('내보낼 미도달 대상자 데이터가 없습니다.');
                            return;
                        }

                        let filtered = baseList;
                        if (this.underachieverExportMode === 'bySubject') {
                            const target = (this.underachieverExportSubject || '').trim();
                            if (!target) {
                                alert('과목을 선택해주세요.');
                                return;
                            }
                            filtered = baseList.filter(student =>
                                Array.isArray(student.details) &&
                                student.details.some(detail =>
                                    detail &&
                                    detail.subjects &&
                                    String(detail.subjects).includes(target)
                                )
                            );
                        }

                        if (!filtered.length) {
                            alert('선택한 조건에 해당하는 미도달 대상자가 없습니다.');
                            return;
                        }

                        // 엑셀 행 구성
                        const rows = [];
                        filtered.forEach(student => {
                            if (!student || !Array.isArray(student.details)) return;
                            student.details.forEach(detail => {
                                if (!detail) return;
                                rows.push({
                                    학번: student.id || '',
                                    이름: student.name || '',
                                    특기사항: student.specialNotes || '',
                                    미도달내역: detail.reason || '',
                                    '미도달 과목(학점수)': detail.subjects || '',
                                    '보충지도(추가학습) 내역': detail.lessonDetails || '',
                                    예외처리: this.getStudentExceptionReason(student.id) || ''
                                });
                            });
                        });

                        if (!rows.length) {
                            alert('내보낼 데이터가 없습니다.');
                            return;
                        }

                        try {
                            const ws = XLSX.utils.json_to_sheet(rows);
                            const wb = XLSX.utils.book_new();
                            XLSX.utils.book_append_sheet(wb, ws, '미도달대상자');

                            const now = new Date();
                            const y = now.getFullYear();
                            const m = String(now.getMonth() + 1).padStart(2, '0');
                            const d = String(now.getDate()).padStart(2, '0');
                            const suffix =
                                this.underachieverExportMode === 'all'
                                    ? '전체과목'
                                    : (this.underachieverExportSubject || '과목별');
                            const filename = `미도달대상자_${suffix}_${y}${m}${d}.xlsx`;

                            XLSX.writeFile(wb, filename);
                            this.underachieversStatus = '미도달 대상자 명단이 엑셀 파일로 저장되었습니다.';
                        } catch (error) { 

                            console.error('미도달 대상자 엑셀 내보내기 오류:', error);
                            alert('엑셀 파일 생성 중 오류가 발생했습니다.');
                        } finally {
                            this.showUnderachieverExportModal = false;
                            setTimeout(() => (this.underachieversStatus = ''), 3000);
                        }
                    },



                    // --- Data Loading/Saving (Teacher) ---

                    async loadTeacherPlan() {

                        // localStorage 기반으로 변경: loadAllTeacherData가 이미 호출되었으므로
                        // 현재 선택된 과목의 계획서를 teacherPlan에 설정
                        if (!this.user || this.role !== '교과교사') return;
                        
                        if (this.currentSubjectIndex >= 0 && this.currentSubjectIndex < this.teacherPlanList.length) {
                            const loadedPlan = this.teacherPlanList[this.currentSubjectIndex];
                            const defaultPlan = this.getInitialTeacherPlan();

                                this.teacherPlan = { ...defaultPlan, ...loadedPlan };



                                this.teacherPlan.teacherNames = this.teacherPlan.teacherNames && this.teacherPlan.teacherNames.length > 0 ? this.teacherPlan.teacherNames : [''];

                                const normalizeAchievements = (achievements) => {

                                    if (!Array.isArray(achievements) || achievements.length === 0) return [createEmptyAchievement()];

                                    return achievements.map(item => ({

                                        text: item?.text || '',

                                        statement: item?.statement || '',

                                        loading: false,

                                        isEditing: false,

                                        editDraft: ''

                                    }));

                                };

                                this.teacherPlan.achievements = normalizeAchievements(this.teacherPlan.achievements);

                                this.teacherPlan.preventionMethods = this.teacherPlan.preventionMethods || [];

                                this.teacherPlan.preventionSessions = this.teacherPlan.preventionSessions && this.teacherPlan.preventionSessions.length > 0 ? this.teacherPlan.preventionSessions : [{plan:''}];

                                this.teacherPlan.supplementaryMethods = this.teacherPlan.supplementaryMethods || [];

                                this.teacherPlan.supplementarySessions = this.teacherPlan.supplementarySessions || [];

                                this.teacherPlan.additionalMethods = this.teacherPlan.additionalMethods || [];

                                this.teacherPlan.additionalSessions = this.teacherPlan.additionalSessions || [];



                                this.teacherPlan.achievements.forEach(a => {

                                    a.loading = false;

                                    a.isEditing = false;

                                    a.editDraft = '';

                                });

                                
                                
                                const parseDates = (period) => (period || []).map(d => d ? new Date(d.seconds ? d.seconds * 1000 : d) : null).filter(d => d && !isNaN(d.getTime()));

                                this.teacherPlan.preventionPeriod = parseDates(this.teacherPlan.preventionPeriod);

                                this.teacherPlan.supplementaryPeriod = parseDates(this.teacherPlan.supplementaryPeriod);

                                this.teacherPlan.additionalPeriod = parseDates(this.teacherPlan.additionalPeriod);
                                
                            } else {

                            this.teacherPlan = this.getInitialTeacherPlan();

                        }

                        this.updateMaxHours();

                        this.$nextTick(() => { this.initFlatpickr(); });

                    },

                    saveUnderachieversToLocalStorage() {
                        if (this.role !== '관리자') return;
                        const adminStorageKey = this.getAdminLocalStorageKey();

                        if (!adminStorageKey) {
                            this.underachieversStatus = '학교코드가 설정되지 않았습니다.';
                            setTimeout(() => (this.underachieversStatus = ''), 3000);
                            return;
                        }
                        
                        if (!this.underachievers || this.underachievers.length === 0) {
                            this.underachieversStatus = '저장할 미도달 대상자 명단이 없습니다.';
                            setTimeout(() => (this.underachieversStatus = ''), 3000);
                            return;
                        }
                        try {
                            // 현재 underachievers 데이터를 깊은 복사하여 저장
                            const dataToSave = {
                                underachievers: JSON.parse(JSON.stringify(this.underachievers)),
                                lastUpdated: new Date().toISOString(),
                                count: this.underachievers.length
                            };
                            localStorage.setItem(adminStorageKey, JSON.stringify(dataToSave));
                            
                            // 저장 후 즉시 다시 로드하여 확인
                            const savedData = JSON.parse(localStorage.getItem(adminStorageKey));
                            if (savedData && savedData.underachievers && savedData.underachievers.length === this.underachievers.length) {
                                const savedTime = new Date().toLocaleString('ko-KR', { 
                                    year: 'numeric', 
                                    month: '2-digit', 
                                    day: '2-digit', 
                                    hour: '2-digit', 
                                    minute: '2-digit',
                                    second: '2-digit'
                                });
                                this.underachieversStatus = `✓ 미도달 대상자 ${this.underachievers.length}명이 로컬 환경에 저장되었습니다. (저장 시간: ${savedTime})`;
                                console.log('관리자 미도달 대상자 명단이 localStorage에 저장되었습니다.', { 
                                    adminStorageKey, 
                                    count: this.underachievers.length,
                                    lastUpdated: dataToSave.lastUpdated,
                                    verified: true
                                });
                            } else {
                                this.underachieversStatus = '저장은 완료되었으나 검증 중 오류가 발생했습니다.';
                                console.warn('저장 검증 실패:', { 
                                    savedCount: savedData?.underachievers?.length,
                                    originalCount: this.underachievers.length
                                });
                            }
                            setTimeout(() => (this.underachieversStatus = ''), 5000);
                        } catch (localStorageError) {
                            console.error('localStorage 저장 실패:', localStorageError);
                            this.underachieversStatus = '저장 중 오류가 발생했습니다: ' + (localStorageError.message || '알 수 없는 오류');
                            setTimeout(() => (this.underachieversStatus = ''), 5000);
                        }
                    },
                    resetUnderachieverList() {
                        if (this.role !== '관리자') return;
                        if (!confirm('현재 계산된 미도달 학생 명단을 모두 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
                        this.underachievers = [];
                        this.deployedUnderachievers = [];
                        
                        // localStorage도 초기화
                        const adminStorageKey = this.getAdminLocalStorageKey();
                        if (adminStorageKey) {
                            try {
                                localStorage.removeItem(adminStorageKey);
                                console.log('관리자 미도달 대상자 명단이 localStorage에서 삭제되었습니다.', { adminStorageKey });
                            } catch (localStorageError) {
                                console.warn('localStorage 삭제 실패:', localStorageError);
                            }
                        }
                        
                        this.underachieversStatus = '미도달 학생 명단이 초기화되었습니다.';
                        setTimeout(() => { this.underachieversStatus = ''; }, 3000);
                    },
                    async saveTeacherPlan() {
                        if (!this.user || this.role !== '교과교사') return;
                        if (!this.teacherPlan.subjectName) {

                            this.teacherPlanStatus = "과목명을 먼저 입력해주세요.";

                            setTimeout(() => this.teacherPlanStatus = '', 3000);

                            return;

                        }

                        this.teacherPlanStatus = "계획안 저장 중...";
                        
                        

                            const planToSave = { ...JSON.parse(JSON.stringify(this.teacherPlan)) };

                        const formatDates = (period) =>
                            (period || [])
                                .map(d => (d instanceof Date && !isNaN(d.getTime())) ? d.toISOString() : null)
                                .filter(Boolean);
                            planToSave.preventionPeriod = formatDates(this.teacherPlan.preventionPeriod);

                            planToSave.supplementaryPeriod = formatDates(this.teacherPlan.supplementaryPeriod);

                            planToSave.additionalPeriod = formatDates(this.teacherPlan.additionalPeriod);



                            planToSave.achievements = (planToSave.achievements || []).map((achievement) => {

                                if (!achievement) return { text: '', statement: '' };

                                const { loading, isEditing, editDraft, ...rest } = achievement;

                                return rest;

                            });
                            
                            

                        // 현재 선택된 과목이 있으면 해당 인덱스 업데이트, 아니면 새 과목으로 추가
                        if (this.currentSubjectIndex >= 0 && this.currentSubjectIndex < this.teacherPlanList.length) {
                            this.teacherPlanList[this.currentSubjectIndex] = planToSave;
                            
                        } else {
                            this.teacherPlanList.push(planToSave);
                            this.currentSubjectIndex = this.teacherPlanList.length - 1;
                        }
                            

                            await this.saveAllTeacherData();

                                this.teacherPlanStatus = "계획안이 저장되었습니다.";

                        setTimeout(() => this.teacherPlanStatus = '', 3000);

                    },

                    // 과목명을 안전한 문서 ID로 변환

                    encodeSubjectName(subjectName) {

                        if (!subjectName) return '';

                        // URL 인코딩하여 특수문자와 한글을 안전하게 처리

                        return encodeURIComponent(subjectName);

                    },

                    // 문서 ID를 과목명으로 디코딩

                    decodeSubjectName(encodedName) {

                        if (!encodedName) return '';

                        try {

                            return decodeURIComponent(encodedName);

                        } catch (e) {

                            return encodedName; // 디코딩 실패 시 원본 반환

                        }

                    },

                    async loadGuidanceData(){

                        // guidance 데이터는 이제 Firestore가 아닌 로컬 저장소(teacherGuidanceDataList)에서만 관리
                        if (this.role !== '교과교사') {
                            this.teacherGuidanceData = this.getInitialGuidanceData();

                            return;

                        }

                        if (!this.teacherPlan.subjectName) {

                            console.warn("loadGuidanceData: 과목명이 없어 초기 데이터 사용");

                            this.teacherGuidanceData = this.getInitialGuidanceData();

                            return;

                        }


                        if (this.currentSubjectIndex >= 0 &&
                            this.currentSubjectIndex < this.teacherGuidanceDataList.length &&
                            this.teacherGuidanceDataList[this.currentSubjectIndex]) {
                            this.teacherGuidanceData = JSON.parse(JSON.stringify(this.teacherGuidanceDataList[this.currentSubjectIndex]));
                            } else {

                                this.teacherGuidanceData = this.getInitialGuidanceData();

                            }


                            this.$nextTick(() => { this.initFlatpickr(); });

                    },

                    async saveGuidanceData(updateOriginal = false){
                        // 이제 출석부/수업일지는 Firestore가 아닌 로컬 저장소에만 저장
                        if (this.role !== '교과교사') {

                            console.warn("saveGuidanceData: 역할 불일치", { role: this.role });

                            return { success: false, message: '교과교사만 저장할 수 있습니다.' };

                        }

                        if (!this.teacherPlan.subjectName) {

                            console.warn("saveGuidanceData: 과목명이 없어 저장하지 않음");

                            return { success: false, message: '과목명을 입력해주세요.' };

                        }


                        // updateOriginal이 true일 때만 원본 attendance 값을 현재 값으로 업데이트 (변경 추적 리셋)
                        if (updateOriginal) {
                            if (this.teacherGuidanceData.preventive && this.teacherGuidanceData.preventive.sessions) {
                                this.teacherGuidanceData.preventive.sessions.forEach(session => {
                                    if (session && session.attendance) {
                                        if (!session.originalAttendance) {
                                            session.originalAttendance = {};
                                        }
                                        Object.keys(session.attendance).forEach(studentId => {
                                            session.originalAttendance[studentId] = session.attendance[studentId] || '';
                                        });
                                    }
                                });
                            }
                            if (this.teacherGuidanceData.supplementary && this.teacherGuidanceData.supplementary.sessions) {
                                this.teacherGuidanceData.supplementary.sessions.forEach(session => {
                                    if (session && session.attendance) {
                                        if (!session.originalAttendance) {
                                            session.originalAttendance = {};
                                        }
                                        Object.keys(session.attendance).forEach(studentId => {
                                            session.originalAttendance[studentId] = session.attendance[studentId] || '';
                                        });
                                    }
                                });
                            }

                            if (this.teacherGuidanceData.additional && this.teacherGuidanceData.additional.sessions) {
                                this.teacherGuidanceData.additional.sessions.forEach(session => {
                                    if (session && session.attendance) {
                                        if (!session.originalAttendance) {
                                            session.originalAttendance = {};
                                        }
                                        Object.keys(session.attendance).forEach(studentId => {
                                            session.originalAttendance[studentId] = session.attendance[studentId] || '';
                                        });
                                    }
                                });
                            }
                        }
                            
                            
                        // 현재 선택된 과목이 있으면 teacherGuidanceDataList에도 업데이트하고 로컬에 저장
                            if (this.currentSubjectIndex >= 0 && this.currentSubjectIndex < this.teacherGuidanceDataList.length) {

                                this.teacherGuidanceDataList[this.currentSubjectIndex] = JSON.parse(JSON.stringify(this.teacherGuidanceData));

                                await this.saveAllTeacherData();

                            }
                            
                            

                        console.log("saveGuidanceData: 로컬 저장 완료");
                            return { success: true, message: '출석부 및 수업일지가 저장되었습니다.' };

                    },

                    getHoursPerCredit(category) {
                        // 교과별(분류별) 학점당 시수를 가져오는 헬퍼 함수
                        // category는 분류(보통교과/전문교과)를 의미
                        if (!category || !this.moduleConfig.hoursPerCreditByCategory) {
                            // 기본값 반환 (기존 hoursPerCredit이 있으면 사용, 없으면 1)
                            return this.moduleConfig.hoursPerCreditByCategory && Object.keys(this.moduleConfig.hoursPerCreditByCategory).length > 0 
                                ? Object.values(this.moduleConfig.hoursPerCreditByCategory)[0] || 1 
                                : 1;
                        }
                        return this.moduleConfig.hoursPerCreditByCategory[category] || 1;
                    },

                    findSubjectInCurriculum(subjectName, grade, semester, series, category) {

                        // 교육과정 편제표에서 과목명, 학년, 학기, 계열, 분류가 모두 일치하는 과목 검색
                        // series: 계열 (인문계열/전문계열)
                        // category: 분류 (보통교과/전문교과) - 시수 적용 기준

                        if (!this.curriculumData || this.curriculumData.length === 0) {

                            console.warn('[findSubjectInCurriculum] curriculumData가 비어있습니다.');

                            return null;

                        }

                        
                        
                        // 기존 호출 호환성: 4개 파라미터로 호출된 경우 (category만 전달)
                        if (arguments.length === 4 && typeof series === 'string') {
                            // 기존 방식: 4번째 파라미터가 계열로 사용되던 경우
                            // 이제는 series로 처리하고, category는 null
                            const temp = series;
                            series = temp; // 기존 category를 series로 사용
                            category = null;
                        }

                        const normalizedSeries = series || null;
                        const normalizedCategory = category || null;

                        
                        
                        console.log('[findSubjectInCurriculum] 검색:', {

                            subjectName,

                            grade,

                            semester,

                            series: normalizedSeries,

                            category: normalizedCategory

                        });

                        
                        
                        // 1차 필터링: 계열로 먼저 필터링 (계열이 있는 경우만)

                        let searchData = this.curriculumData;

                        if (normalizedSeries && normalizedSeries !== '') {

                            searchData = this.curriculumData.filter(row => {

                                if (!row || !row['계열']) return false;

                                const rowSeries = String(row['계열']).trim();

                                return rowSeries === normalizedSeries;

                            });

                            console.log(`[findSubjectInCurriculum] 계열 "${normalizedSeries}"로 필터링: ${searchData.length}개 과목`);

                        } else {

                            console.log(`[findSubjectInCurriculum] 계열 없음. 전체 데이터에서 검색: ${searchData.length}개 과목`);

                        }

                        
                        
                        // 2차 필터링: 과목명, 학년, 학기, 분류로 검색 (정확한 일치 필요)
                        // 과목명은 앞뒤 공백만 제거하고 정확히 일치해야 함
                        // 분류도 정확히 일치해야 함

                        let result = searchData.find(row => {

                            if (!row || !row['과목명']) return false;

                            const rowName = String(row['과목명']).trim();
                            const searchName = String(subjectName || '').trim();
                            const nameMatch = rowName === searchName;

                            if (!nameMatch) return false;

                            
                            
                            // 학년 매칭 (있으면 일치해야 함)

                            if (grade != null && grade !== '') {

                                const rowGrade = row['학년'] != null ? Number(row['학년']) : null;

                                if (rowGrade === null || rowGrade !== Number(grade)) return false;

                            }

                            
                            
                            // 학기 매칭 (있으면 일치해야 함)

                            if (semester != null && semester !== '') {

                                const rowSemester = row['학기'] != null ? Number(row['학기']) : null;

                                if (rowSemester === null || rowSemester !== Number(semester)) return false;

                            }

                            
                            
                            // 분류 매칭 (있으면 일치해야 함)
                            if (normalizedCategory && normalizedCategory !== '') {
                                const rowCategory = row['분류'] ? String(row['분류']).trim() : '';
                                if (rowCategory !== normalizedCategory) return false;
                            }

                            
                            
                            return true;

                        });

                        
                        
                        if (result) {

                            console.log('[findSubjectInCurriculum] 찾음:', {

                                subjectName: result['과목명'],

                                grade: result['학년'],

                                semester: result['학기'],

                                series: result['계열'],

                                category: result['분류'],

                                credits: result['학점']

                            });

                        } else {

                            console.warn('[findSubjectInCurriculum] 찾지 못함:', {

                                subjectName,

                                grade,

                                semester,

                                series: normalizedSeries,

                                category: normalizedCategory,

                                totalCurriculumDataLength: this.curriculumData.length,

                                filteredBySeriesLength: searchData.length,

                                sampleFilteredRows: searchData.slice(0, 5).map(r => ({

                                    name: r['과목명'],

                                    grade: r['학년'],

                                    semester: r['학기'],

                                    category: r['분류']

                                }))

                            });

                        }

                        
                        
                        return result;

                    },

                    async saveGuidanceDataManually(type = 'attendance') {

                        // type: 'attendance' 또는 'lessonLog'

                        const statusVar = type === 'lessonLog' ? 'lessonLogDataStatus' : 'guidanceDataStatus';

                        
                        
                        if (!this.user || !db || !this.schoolId || this.role !== '교과교사') {

                            this[statusVar] = '저장할 수 없습니다: 권한이 없거나 로그인되지 않았습니다.';

                            setTimeout(() => this[statusVar] = '', 5000);

                            return;

                        }

                        if (!this.teacherPlan.subjectName) {

                            this[statusVar] = '과목명을 먼저 입력해주세요.';

                            setTimeout(() => this[statusVar] = '', 5000);

                            return;

                        }

                        this[statusVar] = '저장 중...';

                        const result = await this.saveGuidanceData(); // 차시별 저장에서 원본 값 업데이트하므로 여기서는 false
                        if (result) {

                            if (result.success) {

                                this[statusVar] = '✓ 저장 완료';

                                setTimeout(() => this[statusVar] = '', 3000);

                            } else {

                                this[statusVar] = result.message;

                                setTimeout(() => this[statusVar] = '', 5000);

                            }

                        } else {

                            this[statusVar] = '저장에 실패했습니다.';

                            setTimeout(() => this[statusVar] = '', 5000);

                        }

                    },

                    mergeSessions(defaultSessions, loadedSessions) {

                        const validLoadedSessions = Array.isArray(loadedSessions) ? loadedSessions : [];

                        const defaultLength = Array.isArray(defaultSessions) ? defaultSessions.length : 10;

                        const mergedLength = Math.max(defaultLength, validLoadedSessions.length);

                        const merged = [];

                        const currentStudents = (this.teacherTab === 'preventive' ? this.teacherGuidanceData.preventive?.students : this.teacherGuidanceData.supplementary?.students) || [];



                        for (let i = 0; i < mergedLength; i++) {

                            const defaultSess = { date: '', time: '', isSaved: false, place: '', content: '', attendance: {}, originalAttendance: {} };
                            const loadedSess = validLoadedSessions[i];

                            let sessionToPush;



                            if (loadedSess) {

                                loadedSess.attendance = loadedSess.attendance || {};

                                sessionToPush = { ...defaultSess, ...loadedSess };

                                // 원본 attendance 값 저장 (변경 추적용)
                                sessionToPush.originalAttendance = JSON.parse(JSON.stringify(loadedSess.attendance || {}));
                            } else {

                                sessionToPush = defaultSess;

                                sessionToPush.originalAttendance = {};
                            }

                            
                            
                            currentStudents.forEach(student => {

                                if (student && !sessionToPush.attendance.hasOwnProperty(student.id)) {

                                    sessionToPush.attendance[student.id] = '';

                                }

                                // originalAttendance에도 초기값 설정
                                if (student && !sessionToPush.originalAttendance.hasOwnProperty(student.id)) {
                                    sessionToPush.originalAttendance[student.id] = '';
                                }
                            });

                            merged.push(sessionToPush);

                        }

                        return merged;

                    },

                    isAttendanceChanged(session, studentId) {
                        // 세션이 없거나 원본 값이 없으면 변경되지 않은 것으로 간주
                        if (!session || !session.originalAttendance) {
                            return false;
                        }
                        // 현재 값과 원본 값 비교
                        const currentValue = session.attendance && session.attendance[studentId] ? session.attendance[studentId] : '';
                        const originalValue = session.originalAttendance[studentId] ? session.originalAttendance[studentId] : '';
                        return currentValue !== originalValue;
                    },
                    // findSubjectInCurriculum은 9121줄에 이미 정의되어 있음 (중복 제거)

                    async handleSubjectChange() {

                        // 입력값 변경 시에는 오류 메시지만 초기화 (실제 검증은 저장 버튼에서 수행)

                        this.teacherPlanError = '';

                        this.updateMaxHours();

                    },

                    async validateAndSaveSubject() {

                        // 과목명, 학년, 학기, 계열, 분류가 모두 입력되었는지 확인

                        if (!this.teacherPlan.subjectName || !this.teacherPlan.subjectName.trim()) {

                            this.teacherPlanError = '과목명을 입력해주세요.';

                            return;

                        }

                        if (this.teacherPlan.subjectGrade == null || this.teacherPlan.subjectGrade === '') {

                            this.teacherPlanError = '학년을 선택해주세요.';

                            return;

                        }

                        if (this.teacherPlan.subjectSemester == null || this.teacherPlan.subjectSemester === '') {

                            this.teacherPlanError = '학기를 선택해주세요.';

                            return;

                        }

                        if (!this.teacherPlan.subjectSeries || !this.teacherPlan.subjectSeries.trim()) {

                            this.teacherPlanError = '계열을 선택해주세요.';

                            return;

                        }

                        if (!this.teacherPlan.subjectCategory || !this.teacherPlan.subjectCategory.trim()) {

                            this.teacherPlanError = '분류를 선택해주세요.';

                            return;

                        }

                        // 교육과정 편제표에서 과목 검색 (정확한 일치 필요)

                        const subjectInfo = this.findSubjectInCurriculum(

                            this.teacherPlan.subjectName.trim(),

                            this.teacherPlan.subjectGrade,

                            this.teacherPlan.subjectSemester,

                            this.teacherPlan.subjectSeries.trim(),  // 계열

                            this.teacherPlan.subjectCategory.trim()  // 분류

                        );

                        if (!subjectInfo) {

                            this.teacherPlanError = '해당 과목을 편제표에서 찾을 수 없습니다. 과목명, 학년, 학기, 계열, 분류가 편제표와 정확히 일치하는지 확인해주세요.';

                            this.teacherPlan.subjectNotFound = true;

                            this.updateMaxHours();

                            return;

                        }

                        // 과목을 찾은 경우, 분류도 정확히 일치하는지 확인
                        const foundCategory = subjectInfo['분류'] ? String(subjectInfo['분류']).trim() : '';
                        const inputCategory = this.teacherPlan.subjectCategory.trim();

                        if (foundCategory !== inputCategory) {

                            this.teacherPlanError = `해당 과목을 편제표에서 찾을 수 없습니다. 입력한 분류("${inputCategory}")와 편제표의 분류("${foundCategory}")가 일치하지 않습니다.`;

                            this.teacherPlan.subjectNotFound = true;

                            this.updateMaxHours();

                            return;

                        }

                        // 모든 조건이 정확히 일치하는 경우

                        this.teacherPlanError = '';

                        this.teacherPlan.subjectNotFound = false;

                        // 학점 정보 업데이트

                        this.updateMaxHours();

                        // 저장

                        await this.saveTeacherPlan();

                        await this.loadGuidanceData();

                        this.filterSupplementaryStudents();

                        this.filterAdditionalStudents();

                    },



                    // --- Helper and UI Methods ---

                    formatDateRange(period) {

                        if (!period || !Array.isArray(period) || period.length === 0) return '';

                        const validDates = period.filter(d => d instanceof Date || (d && typeof d === 'object' && d.seconds));

                        if (validDates.length === 0) return '';

                        const dates = validDates.map(d => {

                            if (d instanceof Date) return d;

                            if (d.seconds) return new Date(d.seconds * 1000);

                            return null;

                        }).filter(d => d && !isNaN(d.getTime()));

                        if (dates.length === 0) return '';

                        if (dates.length === 1) return dates[0].toLocaleDateString('ko-KR');

                        return `${dates[0].toLocaleDateString('ko-KR')} ~ ${dates[1].toLocaleDateString('ko-KR')}`;

                    },

                    updatePeriodFromInput(type, event) {

                        // flatpickr의 onChange가 이미 처리하므로 여기서는 Vue 반응성만 보장

                        this.$forceUpdate();

                    },

                    initFlatpickr() {

                        this.$nextTick(() => {

                            document.querySelectorAll('.flatpickr-input').forEach(el => {

                                if (el?._flatpickr) { el._flatpickr.destroy(); }

                            });

                            flatpickr(".flatpickr-range", {

                                mode: "range", dateFormat: "Y-m-d", locale: "ko",

                                onChange: (selectedDates, dateStr, instance) => {

                                    let headerId = instance.element.dataset.planType;

                                    if (!headerId) return;

                                    
                                    
                                    const plan = this.teacherPlan;

                                    const targetPeriod = `${headerId}Period`;



                                    if (plan.hasOwnProperty(targetPeriod)) {

                                        if (Array.isArray(selectedDates) && selectedDates.every(d => d instanceof Date)) {

                                            plan[targetPeriod] = selectedDates;

                                            // Vue 반응성을 위해 강제 업데이트

                                            this.$nextTick(() => {

                                                this.$forceUpdate();

                                            });

                                        } else {

                                            plan[targetPeriod] = [];

                                            this.$nextTick(() => {

                                                this.$forceUpdate();

                                            });

                                        }

                                        this.saveTeacherPlan();

                                    }

                                },

                                defaultDate: null // 초기값 설정

                            });

                            flatpickr(".flatpickr-single", {

                                dateFormat: "Y-m-d", locale: "ko",

                            });

                        });

                    },

                    toggleExportOptions() { this.showExportOptions = !this.showExportOptions; },

                    downloadTemplate(type) {

                        let data, filename;

                        if (type === 'curriculum') { data = [["계열", "분류", "과목명", "학년", "학기", "학점", "교과군"]]; filename = "교육과정_편제표_양식.xlsx"; }

                        else if (type === 'student') { data = [["학번", "이름", "특기사항"]]; filename = "학적정보_양식.xlsx"; }

                        else if (type === 'emotionalSupport') { data = [["학번", "이름", "정서지원프로그램 참여시간"]]; filename = "정서지원프로그램_이수시간_양식.xlsx"; }

                        if (!data) return; const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1"); XLSX.writeFile(wb, filename);

                    },

                    handleImageUpload(event, formType, field) {

                        if (this.role !== '관리자') return;

                        const file = event.target.files[0]; if (!file) return; const reader = new FileReader();

                        reader.onload = (e) => {

                            if (file.size > 1048576) { alert("오류: 이미지 파일 크기는 1MB를 초과할 수 없습니다."); return; }

                            if (formType === 'newsletter') this.newsletterForm[field] = e.target.result;

                            else if (formType === 'pledge') this.pledgeForm[field] = e.target.result;

                            this.saveFormTemplates();

                        }; reader.readAsDataURL(file);

                    },

                    removeImage(formType, field) {

                        if (this.role !== '관리자') return;

                        if (formType === 'newsletter') {

                            if (!Object.prototype.hasOwnProperty.call(this.newsletterForm, field)) return;

                            this.newsletterForm[field] = null;

                        } else if (formType === 'pledge') {

                            if (!Object.prototype.hasOwnProperty.call(this.pledgeForm, field)) return;

                            this.pledgeForm[field] = null;

                        }

                        this.saveFormTemplates();

                    },

                    previewForm(type, studentsToPrint) {

                        const studentsArray = Array.isArray(studentsToPrint) ? studentsToPrint : [studentsToPrint];

                        if (!studentsArray || studentsArray.length === 0) {

                            studentsArray.push({ id: '10101', name: '김학생', gradeSubjects: [{name: '샘플과목', credits: 3}], attendanceSubjects: [] });

                            this.adminActionStatus = "샘플 학생 데이터로 미리보기를 생성합니다.";

                        } else {

                            this.adminActionStatus = '';

                        }



                        let allPreviewsHtml = '';

                        const form = (type === 'newsletter') ? this.newsletterForm : this.pledgeForm;



                        const logoImg = (type === 'newsletter' && form.logoUrl) ? `<img src="${form.logoUrl}" alt="School Logo" style="width: 70px; height: 70px; margin: 0 auto 15px auto; display: block;">` : '';

                        const sealSection = form.includeSeal && form.sealUrl

                            ? `<div class="seal-section"><p style="margin-bottom: 20px;">${form.dispatchDate || 'YYYY.MM.DD.'}</p><img src="${form.sealUrl}" alt="Principal Seal"></div>`

                            : `<div class="seal-section"><p>${form.dispatchDate || 'YYYY.MM.DD.'}</p><p class="school-name">00고등학교장 (직인생략)</p></div>`;



                        let commonHeader;

                        if (type === 'newsletter') {

                            commonHeader = `

                                <div style="text-align: center;">${logoImg}<h1>${form.title || '제목 없음'}</h1></div>

                                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 20px;">

                                    <span>${form.docNumber || '문서번호'}</span>

                                    <span>${form.department || '담당부서'}</span>

                                </div>

                                <div class="whitespace-pre-wrap">${(form.body || '').trim() || '내용 없음'}</div>`;

                        } else { // pledge

                            commonHeader = `

                                <h1>서 약 서</h1>

                                <div class="whitespace-pre-wrap" style="min-height: 100px;">${(form.content || '').trim() || '내용 없음'}</div>`;

                        }



                        const studentDocs = studentsArray.map(student => {

                            if (!student) return '';

                            const fullStudent = this.underachievers.find(s => s.id === student.id) || this.deployedUnderachievers.find(s => s.id === student.id) || student;



                            let studentTableHtml = `<h3 style="margin-top: 40px; font-size: 1.2rem; font-weight: bold;">[최소 성취수준 보장지도 대상자 확인]</h3>`;

                            studentTableHtml += `<table><thead><tr style="background-color: #f2f2f2;">

                                    <th style="width: 20%;">학번</th><th style="width: 20%;">이름</th>

                                    <th>미도달 과목</th><th>미도달 내역</th>

                                </tr></thead><tbody>`;



                            // 계열별로 그룹핑된 과목 정보 사용
                            const subjectsByCategory = new Map();
                            
                            // groupedUnderachievers에서 가져온 정보 사용
                            const groupedInfo = this.groupedUnderachievers.find(g => g.id === fullStudent.id);
                            
                            if (groupedInfo && groupedInfo.details) {
                                // 계열별로 그룹핑된 정보 사용
                                groupedInfo.details.forEach(detail => {
                                    const category = detail.category || '';
                                    if (!subjectsByCategory.has(category)) {
                                        subjectsByCategory.set(category, []);
                                    }
                                    
                                    // originalSubjects에서 과목 정보 추출
                                    if (detail.originalSubjects) {
                                        detail.originalSubjects.forEach(subject => {
                                            const reasons = new Set();
                                            if (subject.grade) reasons.add('학업성취율');
                                            if (subject.attendance) reasons.add('과목출석률');
                                            
                                            subjectsByCategory.get(category).push({
                                                name: subject.name,
                                                reasons: reasons,
                                                credits: subject.credits,
                                                hoursPerCredit: this.getHoursPerCredit(category)
                                            });
                                        });
                                    }
                                });
                            } else {
                                // 기존 방식 (fallback)
                                const subjectsMap = new Map();
                                
                                (fullStudent.gradeSubjects || []).forEach(s => {
                                    if (s && s.name) { 
                                        const category = s.category || fullStudent.category || '';
                                        if (!subjectsMap.has(`${category}|${s.name}`)) {
                                            subjectsMap.set(`${category}|${s.name}`, { name: s.name, category: category, reasons: new Set(['학업성취율']), credits: s.credits });
                                        } else {
                                            subjectsMap.get(`${category}|${s.name}`).reasons.add('학업성취율');
                                        }
                                    }
                                });
                                
                                (fullStudent.attendanceSubjects || []).forEach(sName => {
                                    if (sName) {
                                        const curriculumInfo = this.curriculumData.find(c => c.과목명 === sName);
                                        const category = curriculumInfo ? (curriculumInfo['분류'] || fullStudent.category || '') : (fullStudent.category || '');
                                        if (!subjectsMap.has(`${category}|${sName}`)) {
                                            subjectsMap.set(`${category}|${sName}`, { name: sName, category: category, reasons: new Set(['과목출석률']), credits: curriculumInfo ? curriculumInfo.학점 : 'N/A' });
                                        } else {
                                            subjectsMap.get(`${category}|${sName}`).reasons.add('과목출석률');
                                        }
                                    }
                                });
                                
                                // 계열별로 그룹핑
                                subjectsMap.forEach((subjectInfo, key) => {
                                    const category = subjectInfo.category || '';
                                    if (!subjectsByCategory.has(category)) {
                                        subjectsByCategory.set(category, []);
                                    }
                                    subjectsByCategory.get(category).push({
                                        name: subjectInfo.name,
                                        reasons: subjectInfo.reasons,
                                        credits: subjectInfo.credits,
                                        hoursPerCredit: this.getHoursPerCredit(category)
                                    });
                                });
                            }

                        if (subjectsByCategory.size > 0) {
                            let totalRows = 0;
                            subjectsByCategory.forEach((subjects) => {
                                totalRows += subjects.length;
                            });
                            
                            let currentRow = 0;
                            let isFirstRow = true;
                            
                            subjectsByCategory.forEach((subjects, category) => {
                                subjects.forEach((subject, index) => {
                                    if (isFirstRow) {
                                        studentTableHtml += `<tr>
                                            <td rowspan="${totalRows}" style="vertical-align: top;">${fullStudent.id}</td>
                                            <td rowspan="${totalRows}" style="vertical-align: top;">${fullStudent.name}</td>
                                            <td class="text-left">${subject.name}</td>
                                            <td>${Array.from(subject.reasons).join(' & ')}</td>
                                        </tr>`;
                                        isFirstRow = false;
                                    } else {
                                        studentTableHtml += `<tr>
                                            <td class="text-left">${subject.name}</td>
                                            <td>${Array.from(subject.reasons).join(' & ')}</td>
                                        </tr>`;
                                    }
                                    currentRow++;
                                });
                            });

                        } else {

                                studentTableHtml += `<tr><td>${fullStudent.id}</td><td>${fullStudent.name}</td><td colspan="2">미도달 내역 없음 (샘플)</td></tr>`;

                            }



                            studentTableHtml += `</tbody></table>`;

                            studentTableHtml += `

                            <div style="margin-top: 40px; line-height: 1.6; text-align: left;">

                                <p>위 학생은 위와 같은 사유로 최소 성취수준 보장지도 대상자로 선정되었음을 확인하며, 지도 프로그램에 성실히 참여할 것을 서약합니다.</p>

                                <div class="signature-section">

                                    <div><p>학생: ________________ (서명)</p></div>

                                    <div><p>학부모: ________________ (서명)</p></div>

                                </div>

                            </div>`;



                            return `${commonHeader}${studentTableHtml}${sealSection}`;

                        });



                        allPreviewsHtml = studentDocs.map((doc, index) => {

                            const style = (index < studentDocs.length - 1) ? 'page-break-after: always;' : '';

                            return `<div class="page-break" style="${style}">${doc}</div>`;

                        }).join('');

                        
                        
                        this.previewHtml = `<div id="print-area">${allPreviewsHtml}</div>`;

                        this.showPreviewModal = true;

                    },

                    previewFormAdmin(type) {

                        this.previewForm(type, this.underachievers.length > 0 ? this.underachievers : []);

                    },

                    printHomeroomStudentForm(student, type) {

                        if(this.role !== '담임교사') return;

                        if (!this.newsletterForm.title || !this.pledgeForm.content) { alert("공용 양식이 아직 로드되지 않았습니다. 잠시 후 다시 시도하세요."); return; }

                        const fullStudent = this.deployedUnderachievers.find(s => s.id === student.id);

                        if (!fullStudent) { alert("학생 정보를 찾을 수 없습니다."); return; }

                        if ((!fullStudent.gradeSubjects || fullStudent.gradeSubjects.length === 0) && (!fullStudent.attendanceSubjects || fullStudent.attendanceSubjects.length === 0)) {

                            alert("해당 학생의 미도달 과목 정보가 없습니다."); return;

                        }

                        this.previewForm(type, [fullStudent]);

                    },

                    printPreviewModalContent() {

                        // 인쇄 시 모든 상태 메시지 초기화

                        const originalStatuses = {

                            adminActionStatus: this.adminActionStatus,

                            teacherPlanStatus: this.teacherPlanStatus,

                            teacherPlanError: this.teacherPlanError,

                            moduleConfigStatus: this.moduleConfigStatus,

                            underachieversStatus: this.underachieversStatus

                        };

                        
                        
                        // 상태 메시지 임시 초기화

                        this.adminActionStatus = '';

                        this.teacherPlanStatus = '';

                        this.teacherPlanError = '';

                        this.moduleConfigStatus = '';

                        this.underachieversStatus = '';

                        
                        
                        // 인쇄 실행

                        this.$nextTick(() => {

                        window.print();

                            
                            
                            // 인쇄 후 원래 상태 복원

                            setTimeout(() => {

                                this.adminActionStatus = originalStatuses.adminActionStatus;

                                this.teacherPlanStatus = originalStatuses.teacherPlanStatus;

                                this.teacherPlanError = originalStatuses.teacherPlanError;

                                this.moduleConfigStatus = originalStatuses.moduleConfigStatus;

                                this.underachieversStatus = originalStatuses.underachieversStatus;

                            }, 100);

                        });

                    },

                    closePreviewModal() {

                        this.showPreviewModal = false;

                        this.previewHtml = '';

                        this.adminActionStatus = '';

                        this.teacherPlanError = '';

                        this.teacherPlanStatus = '';

                    },

                    processGradeFiles(event) {

                        if (this.role !== '관리자') return;

                        this.fileProcessingError = '';

                        const files = event.target.files;

                        if (!files || files.length === 0) return;

                        
                        
                        const attendanceOnly = this.normalizeUnderachieverList(this.underachievers.filter(s =>

                            (!s.gradeSubjects || s.gradeSubjects.length === 0) && (s.attendanceSubjects && s.attendanceSubjects.length > 0)

                        ));

                        let processedUnderachievers = [...attendanceOnly];

                        const resultData = new Map();

                        let filesProcessed = 0;

                        const totalFiles = files.length;



                        Array.from(files).forEach(file => {

                            const reader = new FileReader();

                            reader.onload = (e) => {

                                try {

                                    const data = new Uint8Array(e.target.result);

                                    const workbook = XLSX.read(data, { type: 'array' });

                                    const sheet = workbook.Sheets[workbook.SheetNames[0]];

                                    const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });



                                    // A3셀에서 학년, 학기, 분류 추출

                                    // 예: "2025학년도   1학기   주간   상업계   1학년   웹디자인과  8반"

                                    const classInfoRow = sheetData[2];

                                    if (!classInfoRow || !classInfoRow[0]) throw new Error(`'${file.name}' 파일의 3행 A열에서 학급 정보를 찾을 수 없습니다.`);

                                    const classInfo = String(classInfoRow[0]);



                                    // 학기 추출: '학기' 앞의 숫자

                                    const semesterMatch = classInfo.match(/(\d+)\s*학기/);

                                    const semester = semesterMatch ? Number(semesterMatch[1]) : null;

                                    
                                    
                                    // 학년 추출: '학년' 앞의 숫자 (단, '학년도'는 제외)

                                    const gradeMatch = classInfo.match(/(\d+)\s*학년(?!도)/);

                                    const classGrade = gradeMatch ? gradeMatch[1] : null;

                                    
                                    
                                    // 학급 추출

                                    const classNumMatch = classInfo.match(/(\d{1,2})\s*반/);

                                    const classNum = classNumMatch ? classNumMatch[1] : null;



                                    // 계열 추출: 학년 앞에 있는 '계' 정보로 판단
                                    // 일반계면 인문계열, 상업계면 전문계열
                                    let series = '인문계열'; // 기본값
                                    
                                    // 학년 앞의 텍스트에서 '일반계' 또는 '상업계' 찾기
                                    // 예: "2025학년도   1학기   주간   상업계   1학년   웹디자인과  8반"
                                    const beforeGradeMatch = classInfo.match(/(.+?)(\d+\s*학년)/);
                                    
                                    if (beforeGradeMatch && beforeGradeMatch[1]) {
                                        const beforeGrade = beforeGradeMatch[1];
                                        
                                        if (beforeGrade.includes('상업계')) {
                                            series = '전문계열';
                                        } else if (beforeGrade.includes('일반계')) {
                                            series = '인문계열';
                                        } else {
                                            // 학년 앞에 '계' 정보가 없으면 전체 문자열에서 확인
                                            if (classInfo.includes('상업계')) {
                                                series = '전문계열';
                                            } else if (classInfo.includes('일반계')) {
                                                series = '인문계열';
                                            } else {
                                                // '계'가 없거나 다른 경우, 기존 로직으로 fallback ('과' 유무로 판단)
                                                const categoryMatch = classInfo.match(/([^과]+)\s*과/);
                                                series = categoryMatch ? '전문계열' : '인문계열';
                                            }
                                        }
                                    } else {
                                        // 학년 패턴을 찾지 못한 경우, 전체 문자열에서 확인
                                        if (classInfo.includes('상업계')) {
                                            series = '전문계열';
                                        } else if (classInfo.includes('일반계')) {
                                            series = '인문계열';
                                        } else {
                                            // '계'가 없거나 다른 경우, 기존 로직으로 fallback ('과' 유무로 판단)
                                            const categoryMatch = classInfo.match(/([^과]+)\s*과/);
                                            series = categoryMatch ? '전문계열' : '인문계열';
                                        }
                                    }

                                    console.log(`[processGradeFiles] 계열 추출: "${classInfo}" → ${series}`);



                                    if (!classGrade || !classNum) throw new Error(`'${file.name}' 파일의 학급 정보 형식("${classInfo}")이 예상과 다릅니다. (예: '1학년 3반')`);

                                    
                                    
                                    const subjectHeaderRow = sheetData[3];

                                    if (!subjectHeaderRow) throw new Error(`'${file.name}' 파일의 4행에서 과목 정보를 찾을 수 없습니다.`);



                                    // 학생 데이터 행 찾기: 번호와 이름이 있는 행을 찾음

                                    for (let r = 4; r < sheetData.length; r++) {

                                        const currentRow = sheetData[r];

                                        if (!currentRow || currentRow[0] == null || currentRow[1] == null) continue;

                                        
                                        
                                        // 번호와 이름이 있는 행인지 확인

                                        const num = currentRow[0];

                                        const name = currentRow[1];

                                        
                                        
                                        // 번호가 숫자가 아니거나 이름이 비어있으면 건너뛰기

                                        if (isNaN(Number(num)) || !name || String(name).trim() === '') continue;

                                        
                                        
                                        // 다음 행이 상태 행인지 확인 (미도달 정보가 있는 행)

                                        const nextRow = sheetData[r + 1];

                                        if (!nextRow) continue;

                                        
                                        
                                        // 학번 형식: 학년*10000 + 반*100 + 번호 (5자리 숫자)

                                        const fullId = String(Number(classGrade) * 10000 + Number(classNum) * 100 + Number(num));

                                        
                                        
                                        // studentData에서 정확한 학생 찾기 (학번으로 검색)

                                        const foundStudent = this.studentData.find(s => {

                                            const studentId = String(s['학번'] || '').trim();

                                            return studentId === fullId || studentId === String(fullId);

                                        });

                                        
                                        
                                        // studentData에서 찾지 못한 경우, 이름으로도 검색 시도 (동명이인 처리)

                                        let actualStudentId = fullId;

                                        let actualStudentName = String(name).trim();

                                        if (!foundStudent && this.studentData && this.studentData.length > 0) {

                                            // 이름이 정확히 일치하는 학생 찾기

                                            const nameMatches = this.studentData.filter(s => {

                                                const studentName = String(s['이름'] || '').trim();

                                                return studentName === actualStudentName || studentName === String(actualStudentName);

                                            });

                                            
                                            
                                            if (nameMatches.length === 1) {

                                                // 이름이 정확히 일치하는 학생이 1명만 있으면 그 학생 사용

                                                actualStudentId = String(nameMatches[0]['학번'] || '').trim();

                                                actualStudentName = String(nameMatches[0]['이름'] || '').trim();

                                            } else if (nameMatches.length > 1) {

                                                // 동명이인이 여러 명인 경우, 학급 정보로 추가 필터링

                                                const classMatches = nameMatches.filter(s => {

                                                    const studentId = String(s['학번'] || '').trim();

                                                    // 학번에서 학년과 학급 추출 (5자리: 학년*10000+반*100+번호)

                                                    const studentIdNum = Number(studentId);

                                                    if (isNaN(studentIdNum)) return false;

                                                    const studentGrade = Math.floor(studentIdNum / 10000);

                                                    const studentClass = Math.floor((studentIdNum % 10000) / 100);

                                                    return studentGrade === Number(classGrade) && studentClass === Number(classNum);

                                                });

                                                
                                                
                                                if (classMatches.length === 1) {

                                                    actualStudentId = String(classMatches[0]['학번'] || '').trim();

                                                    actualStudentName = String(classMatches[0]['이름'] || '').trim();

                                                } else {

                                                    console.warn(`학생을 찾을 수 없음: ${actualStudentName} (${fullId}), 동명이인 ${nameMatches.length}명, 학급 일치 ${classMatches.length}명`);

                                                }

                                            }

                                        } else if (foundStudent) {

                                            actualStudentId = String(foundStudent['학번'] || '').trim();

                                            actualStudentName = String(foundStudent['이름'] || '').trim();

                                        }



                                        // 상태 행에서 미도달 과목 찾기

                                        for (let c = 3; c < nextRow.length; c++) {

                                            const statusValue = String(nextRow[c] || '').trim();

                                            
                                            
                                            // 미도달 인식: 다양한 형식 지원 (공백, 대소문자 등)

                                            const isUnderachiever = /미도달/i.test(statusValue) && statusValue.length <= 10;

                                            
                                            
                                            if (isUnderachiever) {

                                                const subjectWithCredits = subjectHeaderRow[c];

                                                if (!subjectWithCredits) continue;

                                                const subject = String(subjectWithCredits).split('(')[0].trim();

                                                
                                                
                                                console.log(`[processGradeFiles] 미도달 발견: 학생=${actualStudentName}(${actualStudentId}), 과목=${subject}, 상태값="${statusValue}"`);

                                                
                                                
                                                // 과목명, 학년, 학기, 계열을 모두 포함한 고유 키 생성

                                                const subjectKey = `${subject}|${classGrade}|${semester}|${series}`;

                                                
                                                
                                                if (!resultData.has(actualStudentId)) {

                                                    resultData.set(actualStudentId, { 

                                                        name: actualStudentName, 

                                                        subjects: new Map(), // Set 대신 Map 사용하여 과목별 학년/학기/계열 정보 저장

                                                        grade: classGrade ? Number(classGrade) : null,

                                                        semester: semester,

                                                        series: series

                                                    });

                                                }

                                                // 과목별로 학년/학기/계열 정보 저장

                                                const studentData = resultData.get(actualStudentId);

                                                if (!studentData.subjects.has(subjectKey)) {

                                                    studentData.subjects.set(subjectKey, {

                                                        name: subject,

                                                        grade: classGrade ? Number(classGrade) : null,

                                                        semester: semester,

                                                        series: series

                                                    });

                                                }

                                            }

                                        }

                                    }

                                } catch (err) {

                                    console.error(`Error processing file ${file.name}:`, err);

                                    this.fileProcessingError = `${file.name} 처리 오류: ${err.message}`;

                                } finally {

                                    filesProcessed++;

                                    if (filesProcessed === totalFiles) {

                                        resultData.forEach((data, id) => {

                                            const existingIndex = processedUnderachievers.findIndex(s => s.id === id);

                                            // Map에서 과목 정보 추출 (학년/학기/분류 정보 포함)

                                            const gradeSubjectsData = Array.from(data.subjects.values()).map(subjectInfo => {

                                                // 학년, 학기, 분류 정보를 사용하여 정확한 과목 검색

                                                try {

                                                    if (!this.findSubjectInCurriculum) {

                                                        console.error('findSubjectInCurriculum 함수가 정의되지 않았습니다.');

                                                        return { 

                                                            name: subjectInfo.name, 

                                                            credits: 'N/A',

                                                            grade: subjectInfo.grade,

                                                            semester: subjectInfo.semester,

                                                            category: subjectInfo.category

                                                        };

                                                    }

                                                    // 계열로 검색 시도 (분류는 null로 전달하여 교육과정 편제표에서 찾은 분류 사용)
                                                    // 정확히 일치하는 과목만 반환 (fallback 없음)
                                                    const curriculumInfo = this.findSubjectInCurriculum(

                                                        subjectInfo.name,

                                                        subjectInfo.grade,

                                                        subjectInfo.semester,

                                                        subjectInfo.series,  // 계열

                                                        null  // 분류는 교육과정 편제표에서 찾은 값 사용

                                                    );

                                                    if (!curriculumInfo) {

                                                        console.warn(`과목을 찾을 수 없음: ${subjectInfo.name}, 학년=${subjectInfo.grade}, 학기=${subjectInfo.semester}, 계열=${subjectInfo.series}`);

                                                    }

                                                    // 분류는 교육과정 편제표에서 찾은 값 사용 (보통교과/전문교과)
                                                    const subjectCategory = curriculumInfo ? curriculumInfo['분류'] : null;

                                                    return { 

                                                        name: subjectInfo.name, 

                                                        credits: curriculumInfo ? curriculumInfo.학점 : 'N/A',

                                                        grade: subjectInfo.grade,

                                                        semester: subjectInfo.semester,

                                                        series: subjectInfo.series,  // 계열 (인문계열/전문계열)

                                                        category: subjectCategory  // 분류 (보통교과/전문교과) - 시수 적용 기준

                                                    };

                                                } catch (error) {

                                                    console.error(`과목 검색 오류: ${subjectInfo.name}`, error);

                                                    return { 

                                                        name: subjectInfo.name, 

                                                        credits: 'N/A',

                                                        grade: subjectInfo.grade,

                                                        semester: subjectInfo.semester,

                                                        category: subjectInfo.category

                                                    };

                                                }

                                            }).filter(gs => gs && gs.name); // 빈 과목명 제거

                                            
                                            
                                            if (existingIndex > -1) {

                                                if (!processedUnderachievers[existingIndex].gradeSubjects) processedUnderachievers[existingIndex].gradeSubjects = [];

                                                // 기존 과목과 비교할 때 학년/학기/분류도 함께 비교

                                                const existingGradeSubjectsKeys = new Set(

                                                    processedUnderachievers[existingIndex].gradeSubjects.map(s => 

                                                        `${s.name}|${s.grade || ''}|${s.semester || ''}|${s.category || ''}`

                                                    )

                                                );

                                                gradeSubjectsData.forEach(gs => {

                                                    const subjectKey = `${gs.name}|${gs.grade || ''}|${gs.semester || ''}|${gs.category || ''}`;

                                                    if (!existingGradeSubjectsKeys.has(subjectKey)) {

                                                        processedUnderachievers[existingIndex].gradeSubjects.push(gs);

                                                    }

                                                });

                                            } else {

                                                processedUnderachievers.push({

                                                    id: id,

                                                    name: data.name,

                                                    gradeSubjects: gradeSubjectsData,

                                                    attendanceSubjects: [],

                                                    exceptionReason: ''

                                                });

                                            }

                                        });

                                        processedUnderachievers = this.normalizeUnderachieverList(processedUnderachievers);

                                        this.underachievers = processedUnderachievers;

                                        
                                        
                                        // Firestore에 저장 (로그아웃 후에도 유지)

                                        // currentSchoolCode를 우선 사용, 없으면 schoolId 사용

                                        const activeSchoolId = this.currentSchoolCode || this.schoolId;

                                        if (activeSchoolId && db && this.role === '관리자') {

                                            (async () => {

                                                try {

                                                    const docRef = doc(db, `schools/${activeSchoolId}/commonData`, "underachieversProcessed");

                                                    await setDoc(docRef, { data: JSON.parse(JSON.stringify(processedUnderachievers)) });

                                                    
                                                    // localStorage에도 저장 (페이지 새로고침 후에도 유지)
                                                    const adminStorageKey = this.getAdminLocalStorageKey();
                                                    if (adminStorageKey) {
                                                        try {
                                                            const dataToSave = {
                                                                underachievers: JSON.parse(JSON.stringify(processedUnderachievers)),
                                                                lastUpdated: new Date().toISOString(),
                                                                count: processedUnderachievers.length
                                                            };
                                                            localStorage.setItem(adminStorageKey, JSON.stringify(dataToSave));
                                                            console.log('관리자 미도달 대상자 명단이 localStorage에 저장되었습니다.', { adminStorageKey, count: processedUnderachievers.length });
                                                        
                                                        // 사용자에게 저장 완료 메시지 표시
                                                        const savedTime = new Date().toLocaleString('ko-KR', { 
                                                            year: 'numeric', 
                                                            month: '2-digit', 
                                                            day: '2-digit', 
                                                            hour: '2-digit', 
                                                            minute: '2-digit',
                                                            second: '2-digit'
                                                        });
                                                            this.underachieversStatus = `✓ 성적 파일 처리 완료: ${totalFiles}개 파일에서 ${processedUnderachievers.length}명의 미도달 학생 확인. 로컬 환경에 저장 완료 (${savedTime})`;
                                                            setTimeout(() => (this.underachieversStatus = ''), 8000);
                                                        } catch (localStorageError) {
                                                            console.warn('localStorage 저장 실패:', localStorageError);
                                                            this.underachieversStatus = `성적 파일 처리 완료: ${totalFiles}개 파일에서 ${processedUnderachievers.length}명의 미도달 학생 확인. (로컬 저장 실패: ${localStorageError.message})`;
                                                            setTimeout(() => (this.underachieversStatus = ''), 8000);
                                                        }
                                                    }
                                                    
                                                    this.fileProcessingError = '';

                                                    alert(`성적 파일 처리 완료: ${totalFiles}개 파일에서 ${processedUnderachievers.length}명의 미도달 학생이 확인되었습니다. 데이터가 저장되었습니다.`);

                                                } catch (saveError) {

                                                    console.error("Error saving processed underachievers:", saveError);

                                                    this.fileProcessingError = `처리 완료되었으나 저장 중 오류 발생: ${saveError.message}`;

                                                }

                                            })();

                                        }

                                        
                                        
                                        if (event && event.target) event.target.value = null;

                                    }

                                }

                            };

                            reader.readAsArrayBuffer(file);

                        });

                    },

                    closeAttendanceModal() { 

                        this.showAttendanceModal = false; 

                        this.newAttendanceStudent = { id: '', subjects: [''], grade: null, semester: null, category: '' }; 

                        this.attendanceModalError = ''; 

                    },

                    addAttendanceSubject() { this.newAttendanceStudent.subjects.push(''); },

                    removeAttendanceSubject(index) { this.newAttendanceStudent.subjects.splice(index, 1); },

                    addAttendanceStudent() {

                        if (this.role !== '관리자') return;

                        this.attendanceModalError = '';

                        const studentIdInput = this.newAttendanceStudent.id ? String(this.newAttendanceStudent.id).trim() : '';

                        const subjects = this.newAttendanceStudent.subjects;

                        const grade = this.newAttendanceStudent.grade;

                        const semester = this.newAttendanceStudent.semester;

                        const category = this.newAttendanceStudent.category;

                        
                        
                        if (!studentIdInput || subjects.some(s => !s.trim()) || !grade || !semester || !category) { 

                            this.attendanceModalError = '학번, 학년, 학기, 분류, 모든 과목명을 입력해주세요.'; 

                            return; 

                        }

                        const foundStudent = this.studentData.find(student => String(student['학번']) === studentIdInput);

                        if (!foundStudent) { 

                            this.attendanceModalError = '해당 학번을 찾을 수 없습니다. 학적 정보를 먼저 업로드 해주세요.'; 

                            return; 

                        }

                        
                        
                        const canonicalId = String(foundStudent['학번']);

                        const name = foundStudent['이름'];

                        const studentIndex = this.underachievers.findIndex(s => s.id === canonicalId);

                        const validSubjects = subjects.map(s => s.trim()).filter(s => s);

                        
                        
                        // 각 과목에 대해 학년, 학기, 분류 정보를 사용하여 학점 검색

                        const subjectsWithCredits = validSubjects.map(subjectName => {

                            const curriculumInfo = this.findSubjectInCurriculum(subjectName, grade, semester, null, category);

                            return { name: subjectName, credits: curriculumInfo ? curriculumInfo.학점 : 'N/A' };

                        });

                        
                        
                        if (studentIndex > -1) {

                            if (!this.underachievers[studentIndex].attendanceSubjects) this.underachievers[studentIndex].attendanceSubjects = [];

                            const existingSubjects = new Set(this.underachievers[studentIndex].attendanceSubjects);

                            validSubjects.forEach(subject => {

                                if (!existingSubjects.has(subject)) this.underachievers[studentIndex].attendanceSubjects.push(subject);

                            });

                        } else {

                            this.underachievers.push({ id: canonicalId, name, gradeSubjects: [], attendanceSubjects: validSubjects, exceptionReason: '' });

                        }

                        this.underachievers.sort((a, b) => a.id.localeCompare(b.id));

                        this.saveUnderachieversToLocalStorage();
                        this.closeAttendanceModal();

                    },

                    deleteDetailGroup(detailToDelete) {

                        if (this.role !== '관리자') return;

                        const student = this.underachievers.find(s => s.id === detailToDelete.id);

                        if (!student) return;

                        student.gradeSubjects = student.gradeSubjects || [];

                        student.attendanceSubjects = student.attendanceSubjects || [];

                        
                        
                        detailToDelete.originalSubjects.forEach(subjectInfo => {

                            if (detailToDelete.reason.includes('학업성취율')) {

                                student.gradeSubjects = student.gradeSubjects.filter(gs => gs.name !== subjectInfo.name);

                            }

                            if (detailToDelete.reason.includes('과목출석률')) {

                                student.attendanceSubjects = student.attendanceSubjects.filter(asName => asName !== subjectInfo.name);

                            }

                        });

                        
                        
                        if (student.gradeSubjects.length === 0 && student.attendanceSubjects.length === 0) {

                            this.underachievers = this.underachievers.filter(s => s.id !== student.id);

                        }

                        this.saveUnderachieversToLocalStorage();
                    },

                    exportTable(format) {

                        if (this.role !== '관리자' || !this.groupedUnderachievers || this.groupedUnderachievers.length === 0) { alert("내보낼 미도달 학생 데이터가 없습니다."); this.showExportOptions = false; return; }

                        const data = this.groupedUnderachievers.flatMap(student =>

                            student.details.map(detail => ({

                                '학번': student.id, '이름': student.name, '특기사항': student.specialNotes,

                                '미도달내역': detail.reason, '미도달 과목(학점수)': detail.subjects, '보충지도(추가학습) 내역': detail.lessonDetails,

                            }))

                        );

                        const today = new Date().toISOString().slice(0, 10);

                        const filename = `미도달_학생_현황_${today}`;

                        
                        
                        if (format === 'xlsx') { const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "현황"); XLSX.writeFile(wb, `${filename}.xlsx`); }

                        else if (format === 'csv') { const ws = XLSX.utils.json_to_sheet(data); const csv = XLSX.utils.sheet_to_csv(ws); const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" }); saveAs(blob, `${filename}.csv`); }

                        else if (format === 'pdf') {

                            this.adminActionStatus = 'PDF 생성 중...';

                            const table = document.getElementById('underachievers-table');

                            if (table) {

                                const tableClone = table.cloneNode(true);

                                
                                
                                // 조치 열(삭제 버튼) 제거

                                const actionHeaders = tableClone.querySelectorAll('th');

                                const actionHeader = Array.from(actionHeaders).find(th => th.textContent.trim() === '조치');

                                if (actionHeader) {

                                    const actionIndex = Array.from(actionHeaders).indexOf(actionHeader);

                                    actionHeader.remove();

                                    // 모든 행에서 해당 인덱스의 td 제거

                                    tableClone.querySelectorAll('tbody tr').forEach(tr => {

                                        const tds = tr.querySelectorAll('td');

                                        if (tds[actionIndex]) tds[actionIndex].remove();

                                    });

                                }

                                
                                
                                // 예외처리 열을 비고 열로 변경

                                const exceptionHeaders = tableClone.querySelectorAll('th');

                                const exceptionHeader = Array.from(exceptionHeaders).find(th => th.textContent.trim() === '예외처리');

                                if (exceptionHeader) {

                                    exceptionHeader.textContent = '비고';

                                    const exceptionIndex = Array.from(exceptionHeaders).indexOf(exceptionHeader);

                                    
                                    
                                    // 각 tbody별로 처리 (rowspan 때문에)

                                    tableClone.querySelectorAll('tbody').forEach(tbody => {

                                        const firstRow = tbody.querySelector('tr:first-child');

                                        if (firstRow) {

                                            const tds = firstRow.querySelectorAll('td');

                                            if (tds[exceptionIndex]) {

                                                const exceptionCell = tds[exceptionIndex];

                                                const studentId = this.getStudentIdFromRow(firstRow);

                                                if (studentId) {

                                                    const exceptionReason = this.getStudentExceptionReason(studentId);

                                                    // 예외처리 대상자로 선택된 경우만 비고에 표시

                                                    if (exceptionReason && exceptionReason.trim() !== '') {

                                                        exceptionCell.innerHTML = exceptionReason;

                                                    } else {

                                                        exceptionCell.innerHTML = '';

                                                    }

                                                }

                                            }

                                        }

                                    });

                                }

                                
                                
                                this.previewHtml = `<div id="print-area"><h1>미도달 학생 현황</h1>${tableClone.outerHTML}</div>`;

                                this.showPreviewModal = true;

                                // PDF 생성 완료 후 상태 메시지 숨기기

                                this.$nextTick(() => {

                                    this.adminActionStatus = '';

                                });

                            }

                        }

                        this.showExportOptions = false;

                    },



                    // --- Teacher Methods ---

                    switchTeacherTab(tab) {

                        this.teacherTab = tab;

                        this.$nextTick(() => { this.initFlatpickr(); });

                        if (tab === 'supplementary') {

                            this.filterSupplementaryStudents();

                        }

                    },

                    filterSupplementaryStudents() {

                        if (this.role !== '교과교사' || !this.teacherPlan.subjectName) {
                            if (this.teacherGuidanceData.supplementary) this.teacherGuidanceData.supplementary.students = [];

                            return;

                        }

                        const subject = this.teacherPlan.subjectName;

                        
                        // deployedUnderachievers가 없으면 기존 학생 목록 유지 (importUnderachievers로 추가한 학생 보존)
                        if (!this.deployedUnderachievers || this.deployedUnderachievers.length === 0) {
                            console.log("filterSupplementaryStudents: deployedUnderachievers가 없어 기존 학생 목록 유지");
                            return;
                        }
                        
                        const subjectSpecificUnderachievers = this.deployedUnderachievers.filter(student => {

                            if (!student) return false;

                            const gradeMatch = (student.gradeSubjects || []).some(s => s && s.name === subject);

                            const attendanceMatch = (student.attendanceSubjects || []).includes(subject);

                            return gradeMatch || attendanceMatch;

                        });



                        const currentSuppStudents = this.teacherGuidanceData.supplementary?.students || [];

                        
                        
                        const deployedIds = new Set(subjectSpecificUnderachievers.map(s => s.id));

                        // deployedUnderachievers에 있는 학생과 기존에 추가된 학생 모두 유지
                        const existingStudentsToKeep = currentSuppStudents.filter(s => {
                            // deployedUnderachievers에 있거나, importUnderachievers로 추가한 학생은 유지
                            return deployedIds.has(s.id) || !deployedIds.has(s.id);
                        });
                        
                        existingStudentsToKeep.forEach(s => {

                            const match = subjectSpecificUnderachievers.find(ds => ds.id === s.id);

                            if (match) {

                                let reason = '';

                                const gradeMatch = (match.gradeSubjects || []).some(m => m.name === subject);

                                const attendanceMatch = (match.attendanceSubjects || []).includes(subject);

                                if (gradeMatch && attendanceMatch) reason = '학업성취율&과목출석률';

                                else if (gradeMatch) reason = '학업성취율';

                                else if (attendanceMatch) reason = '과목출석률';

                                s.reason = reason || s.reason || '';

                                const exceptionReason = match.exceptionReason ? String(match.exceptionReason).trim() : '';

                                const isException = !!exceptionReason;

                                s.isException = isException;

                                s.exceptionReason = exceptionReason || '';

                                s.note = isException ? `보충지도 예외처리 대상자 (${exceptionReason})` : '';

                                if (!isException && !reason) {

                                    s.reason = s.reason || '';

                                }

                            }

                        });



                        existingStudentsToKeep.sort((a, b) => a.id.localeCompare(b.id));

                        this.teacherGuidanceData.supplementary.students = existingStudentsToKeep;

                        
                        
                        this.teacherGuidanceData.supplementary.sessions.forEach(session => {

                            if (!session) return;

                            const newAttendance = {};

                            existingStudentsToKeep.forEach(student => {

                                if (student) {

                                    newAttendance[student.id] = (session.attendance && session.attendance[student.id]) ? session.attendance[student.id] : '';

                                }

                            });

                            session.attendance = newAttendance;

                        });

                    },

                    filterAdditionalStudents() {
                        if (this.role !== '교과교사' || !this.teacherPlan.subjectName) {
                            if (this.teacherGuidanceData.additional) this.teacherGuidanceData.additional.students = [];
                            return;
                        }
                        const subject = this.teacherPlan.subjectName;
                        
                        // deployedUnderachievers가 없으면 기존 학생 목록 유지
                        if (!this.deployedUnderachievers || this.deployedUnderachievers.length === 0) {
                            console.log("filterAdditionalStudents: deployedUnderachievers가 없어 기존 학생 목록 유지");
                            return;
                        }
                        
                        // 과목출석률 미도달만 있는 학생 필터링
                        const subjectSpecificUnderachievers = this.deployedUnderachievers.filter(student => {
                            if (!student) return false;
                            const attendanceMatch = (student.attendanceSubjects || []).includes(subject);
                            const gradeMatch = (student.gradeSubjects || []).some(s => s && s.name === subject);
                            // 과목출석률 미도달만 있고 학업성취율 미도달은 없는 경우
                            return attendanceMatch && !gradeMatch;
                        });

                        const currentAdditionalStudents = this.teacherGuidanceData.additional?.students || [];
                        
                        const deployedIds = new Set(subjectSpecificUnderachievers.map(s => s.id));
                        // deployedUnderachievers에 있는 학생과 기존에 추가된 학생 모두 유지
                        const existingStudentsToKeep = currentAdditionalStudents.filter(s => {
                            return deployedIds.has(s.id) || !deployedIds.has(s.id);
                        });
                        
                        existingStudentsToKeep.forEach(s => {
                            const match = subjectSpecificUnderachievers.find(ds => ds.id === s.id);
                            if (match) {
                                s.reason = '과목출석률';
                                const exceptionReason = match.exceptionReason ? String(match.exceptionReason).trim() : '';
                                const isException = !!exceptionReason;
                                s.isException = isException;
                                s.exceptionReason = exceptionReason || '';
                                s.note = isException ? `추가학습 예외처리 대상자 (${exceptionReason})` : '';
                            }
                        });

                        existingStudentsToKeep.sort((a, b) => a.id.localeCompare(b.id));
                        this.teacherGuidanceData.additional.students = existingStudentsToKeep;
                        
                        this.teacherGuidanceData.additional.sessions.forEach(session => {
                            if (!session) return;
                            const newAttendance = {};
                            existingStudentsToKeep.forEach(student => {
                                if (student) {
                                    newAttendance[student.id] = (session.attendance && session.attendance[student.id]) ? session.attendance[student.id] : '';
                                }
                            });
                            session.attendance = newAttendance;
                        });
                    },
                    updateMaxHours() {

                        let calculatedHours = 0;
                        let subjectNotFound = false;

                        if (this.teacherPlan.subjectName && 

                            this.teacherPlan.subjectGrade != null && 

                            this.teacherPlan.subjectSemester != null && 

                            this.teacherPlan.subjectSeries &&
                            
                            this.teacherPlan.subjectCategory) {

                            const subject = this.findSubjectInCurriculum(

                                this.teacherPlan.subjectName,

                                this.teacherPlan.subjectGrade,

                                this.teacherPlan.subjectSemester,

                                this.teacherPlan.subjectSeries,  // 계열

                                this.teacherPlan.subjectCategory  // 분류는 시수 적용에만 사용

                            );

                        if (subject) {

                            const credits = Number(subject.학점);

                            if (!isNaN(credits) && credits > 0) {
                                // 찾은 과목의 분류를 사용 (보통교과/전문교과)
                                const category = subject['분류'] || this.teacherPlan.subjectCategory || '';
                                const hoursPerCredit = this.getHoursPerCredit(category);
                                calculatedHours = credits * hoursPerCredit;

                                }

                            } else {

                                // 과목을 찾지 못한 경우
                                subjectNotFound = true;

                            }

                        } else if (this.teacherPlan.subjectName || 
                                   this.teacherPlan.subjectGrade != null || 
                                   this.teacherPlan.subjectSemester != null || 
                                   this.teacherPlan.subjectSeries ||
                                   this.teacherPlan.subjectCategory) {

                            // 일부만 입력된 경우도 오류로 처리
                            subjectNotFound = true;

                        }

                        this.teacherPlan.maxSupplementaryHours = calculatedHours;

                        this.teacherPlan.maxAdditionalHours = calculatedHours; // Both are the same
                        
                        // 과목을 찾지 못한 경우 오류 상태 저장
                        this.teacherPlan.subjectNotFound = subjectNotFound;



                        if (this.teacherPlan.supplementarySessions.length > calculatedHours && calculatedHours > 0) {

                            this.teacherPlan.supplementarySessions = this.teacherPlan.supplementarySessions.slice(0, calculatedHours);

                        }

                        if (this.teacherPlan.additionalSessions.length > calculatedHours && calculatedHours > 0) {

                            this.teacherPlan.additionalSessions = this.teacherPlan.additionalSessions.slice(0, calculatedHours);

                        }

                    },

                    addAchievement() { this.teacherPlan.achievements.push(createEmptyAchievement()); },

                    removeAchievement(index) { this.teacherPlan.achievements.splice(index, 1); },

                    addPreventionSession() { this.teacherPlan.preventionSessions.push({ plan: '' }); },

                    removePreventionSession(index) { this.teacherPlan.preventionSessions.splice(index, 1); },

                    addSupplementarySession() { if (!this.teacherPlan.maxSupplementaryHours) { alert("먼저 과목명을 입력하여 최대 차시를 설정하세요."); return; } if (this.teacherPlan.supplementarySessions.length < this.teacherPlan.maxSupplementaryHours) this.teacherPlan.supplementarySessions.push({ plan: '' }); },

                    removeSupplementarySession(index) { this.teacherPlan.supplementarySessions.splice(index, 1); },

                    addAdditionalSession() { if (!this.teacherPlan.maxAdditionalHours) { alert("먼저 과목명을 입력하여 최대 차시를 설정하세요."); return; } if (this.teacherPlan.additionalSessions.length < this.teacherPlan.maxAdditionalHours) this.teacherPlan.additionalSessions.push({ plan: '' }); },

                    removeAdditionalSession(index) { this.teacherPlan.additionalSessions.splice(index, 1); },

                    addTeacher() { this.teacherPlan.teacherNames.push(''); },

                    removeTeacher(index) { this.teacherPlan.teacherNames.splice(index, 1); },

                    async generateStatement(index) {

                        this.teacherPlanError = '';

                        const achievement = this.teacherPlan.achievements[index];

                        if (!achievement.text) {

                            this.teacherPlanError = '성취기준을 먼저 입력해주세요.';

                            return;

                        }

                        achievement.loading = true;

                        achievement.statement = '';

                        achievement.isEditing = false;

                        achievement.editDraft = '';

                        
                        
                        const systemPrompt = "당신은 교육 전문가로서 성취기준을 바탕으로 최소 성취수준과 최소 성취수준 학생들의 행동 특성을 설명하는 역할입니다. 입력한 성취기준에 대한 학습자들의 성취수준을 A~E 5단계로 나누었을 때 최하 수준인 E수준을 한 문장으로 진술하세요. 성취수준이란 입력한 성취기준을 학습한 결과로 나타나는 학습자들의 학습 수준을 의미해. 최소 성취수준이므로 간단하고 기초적인 수준으로 입력하되, 부정적인 진술은 하지 말고, 최소한의 노력을 하고 성취기준에 해당하는 내용을 기초적인 수준에서 찾아보았다는 식으로 진술하세요. '학생들은~', '최소 성취수준:' 또는 'E수준:~' 이라는 별도의 설명 구문 없이 바로 성취수준 진술문만 제시해야 합니다. 예를 들어 성취기준이 '논증 요소에 따른 분석을 바탕으로 효과적으로 내용을 조직하여 논증하는 글을 쓴다.'인 경우 최소 성취수준은 '논증 요소에 대한 제한적인 분석을 바탕으로 논증하는 글을 쓴다.'로 진술할 수 있습니다. 예시로 든 진술문의 형식을 유지하면서 최소 성취수준 진술문을 제시해주세요.";

                        const userQuery = achievement.text;



                        try {

                            const response = await fetch('/.netlify/functions/openai-proxy', {

                                method: 'POST',

                                headers: { 'Content-Type': 'application/json' },

                                body: JSON.stringify({

                                    model: "gpt-3.5-turbo",

                                    messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userQuery }]

                                })

                            });

                            if (!response.ok) {

                                const errorBody = await response.json().catch(() => ({}));

                                console.error('API Error Response:', errorBody);

                                const errorMessage = errorBody.error?.message || errorBody.message || response.statusText;

                                
                                
                                // 구체적인 에러 메시지 제공

                                if (response.status === 401) {

                                    throw new Error(`API 인증 실패 (401): API 키가 유효하지 않거나 설정되지 않았을 수 있습니다.`);

                                } else if (response.status === 404) {

                                    throw new Error(`API 엔드포인트를 찾을 수 없습니다 (404): Netlify Functions가 배포되지 않았을 수 있습니다.`);

                                } else if (response.status === 500) {

                                    throw new Error(`서버 오류 (500): ${errorMessage}`);

                                } else {

                                throw new Error(`API 요청 실패 (${response.status}): ${errorMessage}`);

                                }

                            }

                            const result = await response.json();

                            console.log('API Raw Response:', result); // 디버깅용

                            
                            
                            // 다양한 응답 구조 지원

                            let generatedText = null;

                            
                            
                            // 프록시가 반환하는 OpenAI API 직접 응답 구조 (가장 일반적): result.choices?.[0]?.message?.content

                            if (result.choices?.[0]?.message?.content) {

                                generatedText = result.choices[0].message.content;

                            }

                            // 래퍼가 있는 경우: result.data?.choices?.[0]?.message?.content

                            else if (result.data?.choices?.[0]?.message?.content) {

                                generatedText = result.data.choices[0].message.content;

                            }

                            // Netlify Functions 래퍼 구조: result.content 또는 result.message

                            else if (result.content) {

                                generatedText = result.content;

                            }

                            else if (result.message) {

                                generatedText = result.message;

                            }

                            // 에러 응답 구조

                            else if (result.error) {

                                throw new Error(result.error.message || result.error || 'API 오류가 발생했습니다.');

                            }

                            
                            
                            if (generatedText) {

                                achievement.statement = generatedText.trim().replace(/^(E수준:|최소 성취수준:)\s*/, '');

                                this.saveTeacherPlan();

                            } else {

                                console.error('API Response 구조:', JSON.stringify(result, null, 2));

                                throw new Error(`API 응답에서 진술문을 찾을 수 없습니다. 응답 구조: ${JSON.stringify(result)}`);

                            }

                        } catch (error) {

                            console.error("AI 진술문 생성 오류:", error);

                            this.teacherPlanError = `진술문 생성 중 오류 발생: ${error.message}.`;

                        } finally {

                            achievement.loading = false;

                        }

                    },

                    startEditingStatement(index) {

                        this.teacherPlanError = '';

                        const achievement = this.teacherPlan.achievements[index];

                        if (!achievement) return;

                        achievement.isEditing = true;

                        achievement.editDraft = achievement.statement || '';

                    },

                    cancelEditingStatement(index) {

                        const achievement = this.teacherPlan.achievements[index];

                        if (!achievement) return;

                        achievement.isEditing = false;

                        achievement.editDraft = '';

                        this.teacherPlanError = '';

                    },

                    saveEditedStatement(index) {

                        const achievement = this.teacherPlan.achievements[index];

                        if (!achievement) return;

                        const edited = (achievement.editDraft || '').trim();

                        if (!edited) {

                            this.teacherPlanError = '진술문 내용을 입력해주세요.';

                            return;

                        }

                        achievement.statement = edited;

                        achievement.isEditing = false;

                        achievement.editDraft = '';

                        this.teacherPlanError = '';

                        this.saveTeacherPlan();

                    },

                    generatePlanPreview() {

                        const plan = this.teacherPlan;

                        const subjectInfo = this.curriculumData.find(s => s.과목명 === plan.subjectName);

                        if (!subjectInfo) {

                            this.teacherPlanError = '과목명을 찾을 수 없습니다. 편제표에 등록된 과목명과 일치하는지 확인해주세요.';

                            this.previewHtml = `<div id="print-area"><p style='color: red;'>${this.teacherPlanError}</p></div>`;

                            this.showPreviewModal = true;

                            return;

                        }

                        this.teacherPlanError = '';



                        const localModuleConfig = this.moduleConfig;

                        const supplementaryHours = this.teacherPlan.maxSupplementaryHours;

                        const requiredHours = Math.ceil((supplementaryHours * 2) / 3 * 10) / 10;

                        const preventionPossibleHours = Math.floor(supplementaryHours * (localModuleConfig.preventiveRatio / 100));

                        const emotionalSupportHours = Math.floor(supplementaryHours * (localModuleConfig.emotionalSupportRatio / 100));

                        
                        
                        const createTable = (headers, rows) => {

                            const ths = headers.map(h => `<th style="min-height: 45px; height: auto; vertical-align: middle;">${h}</th>`).join('');

                            const trs = rows.map(row => { 

                                // 각 행의 최대 높이를 계산하기 위해 모든 셀의 내용을 확인

                                const tds = row.map((cell, i) => {

                                    const isTextCell = headers[i] === '성취기준' || headers[i] === '지도 계획' || headers[i] === '내용';

                                    // 모든 셀에 동일한 최소 높이와 스타일 적용

                                    const cellStyle = `min-height: 40px; height: auto; vertical-align: top; ${isTextCell ? 'text-align: left;' : 'text-align: center;'}`;

                                    return `<td class="${isTextCell ? 'text-left' : ''}" style="${cellStyle}">${cell}</td>`;

                                }).join(''); 

                                // 행에 명시적으로 높이 자동 설정

                                return `<tr style="height: auto; min-height: 40px;">${tds}</tr>`;

                            }).join('');

                            return `<table style="table-layout: auto; width: 100%; border-collapse: collapse;"><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>`;

                        };

                        
                        
                        let achievementRateHtml = `<p>• 학업 성취율: 학기말 학업 성취율 40% 미만</p>`;

                        if (plan.gradeCalculation === '고정분할점수') {

                            achievementRateHtml += createTable(['성취율', '기준점수'], [['90% 이상', '90'], ['80% 이상 ~ 90% 미만', '80'], ['70% 이상 ~ 80% 미만', '70'], ['60% 이상 ~ 70% 미만', '60'], ['40% 이상 ~ 60% 미만', '40']]);

                        } else {

                            achievementRateHtml += `<p style="padding-left: 1em;">- 성취수준 기준점수는 학기말 추정분할점수 산출 결과에 따름</p>`;

                        }

                        
                        
                        const overviewTable = createTable(

                            ['운영 학년', '운영 학기', '보충/추가학습 시수', '이수 인정 기준 시수', '예방지도 인정 가능 시수', '정서 지원 프로그램 인정 가능 시수'],

                            [[subjectInfo.학년, subjectInfo.학기, `${supplementaryHours}시수`, `${requiredHours}시수 (2/3 반올림)`, `${preventionPossibleHours}시수 (일반)`, `${emotionalSupportHours}시수`]]

                        );

                        
                        
                        const statementsTable = createTable(['성취기준', '최소 성취수준 진술문'], plan.achievements.map(a => {

                            const textCell = a.text ? `<div class="whitespace-pre-wrap text-left">${a.text}</div>` : '';

                            const statementCell = a.statement ? `<div class="whitespace-pre-wrap text-left">${a.statement}</div>` : '미생성';

                            return [textCell, statementCell];

                        }));

                        
                        
                        let preventionPlanHtml = '';

                        if (plan.conductPrevention === 'O') {

                            const pPeriod = (plan.preventionPeriod || []).filter(d => d instanceof Date).map(d => d.toLocaleDateString('ko-KR'));

                            const pPeriodFmt = pPeriod.length === 2 ? `${pPeriod[0]} ~ ${pPeriod[1]}` : (pPeriod.length === 1 ? pPeriod[0] : '미정');

                            const preventionTargetCell = plan.preventionTarget ? `<div class="whitespace-pre-wrap text-left">${plan.preventionTarget}</div>` : '';

                            const pSessions = plan.preventionSessions.map((s, i) => [`${i + 1}차시`, `<div class="whitespace-pre-wrap text-left">${s.plan || ''}</div>`]);

                            preventionPlanHtml = `<h3>4. 최소 성취수준 미도달 예방 지도 계획</h3>${createTable(['구분', '내용'], [['대상학생 선정 기준', preventionTargetCell], ['지도 방법', (plan.preventionMethods || []).join(', ')], ['운영 차시', `${(plan.preventionSessions || []).length}차시`], ['운영 기간', pPeriodFmt]])}<h4>차시별 지도 계획</h4>${createTable(['차시', '지도 계획'], pSessions)}`;

                        } else {

                            preventionPlanHtml = `<h3>4. 최소 성취수준 미도달 예방 지도 계획</h3><p>- 해당 없음</p>`;

                        }

                        
                        
                        const createGuidancePlanHtml = (title, target, methods, period, sessions) => {

                            const sPeriod = (period || []).filter(d => d instanceof Date).map(d => d.toLocaleDateString('ko-KR'));

                            const sPeriodFmt = sPeriod.length === 2 ? `${sPeriod[0]} ~ ${sPeriod[1]}` : (sPeriod.length === 1 ? sPeriod[0] : '미정');

                            const sSessions = (sessions || []).map((s, i) => [`${i + 1}차시`, `<div class="whitespace-pre-wrap text-left">${s.plan || ''}</div>`]);

                            return `<h3>${title}</h3>${createTable(['구분', '내용'], [['대상학생 선정 기준', target], ['지도 방법', (methods || []).join(', ')], ['운영 차시', `${(sessions || []).length}차시`], ['운영 기간', sPeriodFmt]])}<h4>차시별 지도 계획</h4>${createTable(['차시', '지도 계획'], sSessions)}`;

                        };



                        const supplementaryPlanHtml = createGuidancePlanHtml('5. 보충 지도 운영 계획', '학업성취율 40% 미만', plan.supplementaryMethods, plan.supplementaryPeriod, plan.supplementarySessions);

                        const additionalLearningPlanHtml = createGuidancePlanHtml('6. 추가 학습 운영 계획', '과목출석률 2/3 미만', plan.additionalMethods, plan.additionalPeriod, plan.additionalSessions);

                        
                        
                        this.previewHtml = `<div id="print-area">

                            <h1>${this.planTitle}</h1>

                            <div style="text-align: right; font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem;">

                                <p><strong>과목명:</strong> ${plan.subjectName}</p>

                                <p><strong>교과교사:</strong> ${this.formattedTeacherNames}</p>

                            </div>

                            <h3>1. 학점이수 인정 기준</h3>

                            <p>• 과목 출석률: 수업 횟수의 2/3 미만 시</p>

                            ${achievementRateHtml}

                            <h3>2. 최소 성취수준 보장지도 개요</h3>

                            ${overviewTable}

                            <h3>3. 최소 성취수준 진술문</h3>

                            ${statementsTable}

                            ${preventionPlanHtml}

                            ${supplementaryPlanHtml}

                            ${additionalLearningPlanHtml}

                        </div>`;

                        this.showPreviewModal = true;

                    },



                    // --- GUIDANCE LOGBOOK METHODS ---

                    async addGuidanceStudent(type) {

                        if (this.role !== '교과교사') return;

                        const data = this.teacherGuidanceData[type];

                        if (!data) return;

                        data.error = '';

                        const studentId = this.newGuidanceStudentId.trim();

                        if (!studentId) return;

                        if (data.students.some(s => s.id === studentId)) { data.error = '이미 추가된 학생입니다.'; return; }

                        
                        
                        // studentData 로딩 확인 및 디버깅

                        if (!this.studentData || this.studentData.length === 0) {

                            console.warn("studentData가 로드되지 않았습니다. 다시 로드 시도...", {

                                studentData: this.studentData,

                                studentDataLength: this.studentData?.length,

                                schoolId: this.schoolId,

                                currentSchoolCode: this.currentSchoolCode

                            });

                            // studentData가 없으면 다시 로드 시도

                            try {

                                await this.loadCommonData();

                                if (!this.studentData || this.studentData.length === 0) {

                            data.error = '학적 정보가 로드되지 않았습니다. 관리자가 학적 정보를 업로드했는지 확인하거나 잠시 후 다시 시도해주세요.';

                            return;

                                }

                            } catch (error) {

                                console.error("학적 정보 재로드 실패:", error);

                                data.error = '학적 정보를 불러오는 중 오류가 발생했습니다. 관리자에게 문의하세요.';

                                return;

                            }

                        }



                        // 학번 필드명 확인 (다양한 필드명 지원)

                        const studentInfo = this.studentData.find(s => {

                            if (!s) return false;

                            const 학번값 = String(s['학번'] || s['studentId'] || s['학번_'] || '').trim();

                            return 학번값 === studentId;

                        });

                        
                        
                        if (studentInfo) {

                            const name = studentInfo['이름'] || studentInfo['name'] || studentInfo['이름_'] || '이름 없음';

                            const studentToAdd = { id: studentId, name: name, isException: false, exceptionReason: '' };

                            if (type === 'supplementary') {

                                const deployed = this.deployedUnderachievers.find(s => s.id === studentId);

                                if (deployed) {

                                    const subject = this.teacherPlan.subjectName;

                                    const gradeMatch = (deployed.gradeSubjects || []).some(s => s && s.name === subject);

                                    const attendanceMatch = (deployed.attendanceSubjects || []).includes(subject);

                                    if (gradeMatch && attendanceMatch) studentToAdd.reason = '학업성취율&과목출석률';

                                    else if (gradeMatch) studentToAdd.reason = '학업성취율';

                                    else if (attendanceMatch) studentToAdd.reason = '과목출석률';

                                }

                            } else if (type === 'additional') {

                                // 추가학습에서 보충지도 대상자(학업성취율 미도달자) 추가 시도 시 차단
                                const supplementary = this.teacherGuidanceData.supplementary;

                                if (supplementary && supplementary.students) {

                                    const isInSupplementary = supplementary.students.some(s => s && s.id === studentId);

                                    if (isInSupplementary) {

                                        // 보충지도 대상자에 이미 있는 경우, 추가학습 대상자로 추가하지 않음
                                        const supplementaryStudent = supplementary.students.find(s => s && s.id === studentId);

                                        if (supplementaryStudent) {

                                            // deployedUnderachievers에서 과목출석률 미도달 여부 확인
                                            const deployed = this.deployedUnderachievers.find(s => s.id === studentId);

                                            if (deployed) {

                                                const subject = this.teacherPlan.subjectName;

                                                const gradeMatch = (deployed.gradeSubjects || []).some(s => s && s.name === subject);

                                                const attendanceMatch = (deployed.attendanceSubjects || []).includes(subject);

                                                // 학업성취율과 과목출석률 모두 미도달인 경우 미도달 항목 업데이트 확인
                                                if (gradeMatch && attendanceMatch) {

                                                    // 현재 미도달 항목이 '학업성취율'인 경우에만 확인 팝업 표시
                                                    if (supplementaryStudent.reason === '학업성취율') {

                                                        const shouldUpdate = confirm('해당 학생은 학업성취율 미도달자이므로 보충지도 관리 탭에서 관리해야 합니다. 해당 학생의 미도달 항목에 과목출석률을 추가하시겠습니까?');

                                                        if (shouldUpdate) {

                                                            supplementaryStudent.reason = '학업성취율&과목출석률';

                                                            this.saveGuidanceData();

                                                        }

                                                    } else {

                                                        // 이미 '학업성취율&과목출석률'인 경우 안내만 표시
                                                        alert('해당 학생은 학업성취율 미도달자이므로 보충지도 관리 탭에서 관리하십시오.');

                                                    }

                                                } else {

                                                    // 과목출석률 미도달이 아닌 경우 안내만 표시
                                                    alert('해당 학생은 학업성취율 미도달자이므로 보충지도 관리 탭에서 관리하십시오.');

                                                }

                                            } else {

                                                // deployedUnderachievers에 없는 경우 안내만 표시
                                                alert('해당 학생은 학업성취율 미도달자이므로 보충지도 관리 탭에서 관리하십시오.');

                                            }

                                            this.newGuidanceStudentId = '';

                                            return;

                                        }

                                    } else {

                                        // 보충지도 대상자에 없지만 deployedUnderachievers에서 학업성취율 미도달자인 경우
                                        const deployed = this.deployedUnderachievers.find(s => s.id === studentId);

                                        if (deployed) {

                                            const subject = this.teacherPlan.subjectName;

                                            const gradeMatch = (deployed.gradeSubjects || []).some(s => s && s.name === subject);

                                            const attendanceMatch = (deployed.attendanceSubjects || []).includes(subject);

                                            // 학업성취율 미도달자인 경우 (과목출석률 미도달 여부와 관계없이)
                                            if (gradeMatch) {

                                                // 과목출석률도 미도달인 경우 확인 팝업 표시
                                                if (attendanceMatch) {

                                                    const shouldAdd = confirm('해당 학생은 학업성취율 미도달자이므로 보충지도 관리 탭에서 관리해야 합니다. 해당 학생의 미도달 항목에 과목출석률을 추가하시겠습니까?');

                                                    if (shouldAdd) {

                                                        // 보충지도 대상자에 추가하고 미도달 항목을 '학업성취율&과목출석률'로 설정
                                                        const supplementaryStudentToAdd = { 
                                                            id: studentId, 
                                                            name: name, 
                                                            reason: '학업성취율&과목출석률', 
                                                            isException: false, 
                                                            exceptionReason: '' 
                                                        };

                                                        supplementary.students.push(supplementaryStudentToAdd);

                                                        supplementary.students.sort((a, b) => a.id.localeCompare(b.id));

                                                        supplementary.sessions.forEach(session => { 

                                                            if (session) {

                                                                if (!session.attendance.hasOwnProperty(studentId)) { 

                                                                    session.attendance[studentId] = ''; 

                                                                }

                                                                if (!session.originalAttendance) {

                                                                    session.originalAttendance = {};

                                                                }

                                                                if (!session.originalAttendance.hasOwnProperty(studentId)) {

                                                                    session.originalAttendance[studentId] = '';

                                                                }

                                                            }

                                                        });

                                                        this.saveGuidanceData();

                                                    }

                                                } else {

                                                    // 과목출석률 미도달이 아닌 경우 자동으로 보충지도 대상자에 추가
                                                    const supplementaryStudentToAdd = { 
                                                        id: studentId, 
                                                        name: name, 
                                                        reason: '학업성취율', 
                                                        isException: false, 
                                                        exceptionReason: '' 
                                                    };

                                                    supplementary.students.push(supplementaryStudentToAdd);

                                                    supplementary.students.sort((a, b) => a.id.localeCompare(b.id));

                                                    supplementary.sessions.forEach(session => { 

                                                        if (session) {

                                                            if (!session.attendance.hasOwnProperty(studentId)) { 

                                                                session.attendance[studentId] = ''; 

                                                            }

                                                            if (!session.originalAttendance) {

                                                                session.originalAttendance = {};

                                                            }

                                                            if (!session.originalAttendance.hasOwnProperty(studentId)) {

                                                                session.originalAttendance[studentId] = '';

                                                            }

                                                        }

                                                    });

                                                    this.saveGuidanceData();

                                                    alert('해당 학생은 학업성취율 미도달자이므로 보충지도 관리 탭에서 관리하십시오.');

                                                }

                                                this.newGuidanceStudentId = '';

                                                return;

                                            }

                                        }

                                    }

                                }

                                // 추가학습 대상자로 추가 (과목출석률만 미도달)
                                studentToAdd.reason = '과목출석률';

                            }

                            data.students.push(studentToAdd);

                            data.students.sort((a, b) => a.id.localeCompare(b.id));

                            data.sessions.forEach(session => { 
                                if (session) {
                                    if (!session.attendance.hasOwnProperty(studentId)) { 
                                        session.attendance[studentId] = ''; 
                                    }
                                    if (!session.originalAttendance) {
                                        session.originalAttendance = {};
                                    }
                                    if (!session.originalAttendance.hasOwnProperty(studentId)) {
                                        session.originalAttendance[studentId] = '';
                                    }
                                }
                            });
                            this.newGuidanceStudentId = '';

                            this.saveGuidanceData();

                        } else {

                            console.warn("학생을 찾을 수 없습니다.", {

                                입력된학번: studentId,

                                studentData샘플: this.studentData.slice(0, 3),

                                전체개수: this.studentData.length

                            });

                            data.error = `학적 정보에 없는 학생입니다 (학번: ${studentId}). 학번을 확인하거나 관리자에게 문의하세요.`;

                        }

                    },

                    removeGuidanceStudent(type, studentId) {

                        if (this.role !== '교과교사') return;

                        const data = this.teacherGuidanceData[type];

                        if (!data) return;

                        
                        
                        // 학생 목록에서 제거

                        const studentIndex = data.students.findIndex(s => s && s.id === studentId);

                        if (studentIndex !== -1) {

                            data.students.splice(studentIndex, 1);

                        }

                        
                        
                        // 모든 세션의 출석 정보에서도 제거

                        if (data.sessions) {

                            data.sessions.forEach(session => {

                                if (session) {
                                    if (session.attendance && session.attendance.hasOwnProperty(studentId)) {
                                    delete session.attendance[studentId];

                                }
                                    if (session.originalAttendance && session.originalAttendance.hasOwnProperty(studentId)) {
                                        delete session.originalAttendance[studentId];
                                    }
                                }

                            });

                        }

                        
                        
                        this.saveGuidanceData();

                    },

                    addGuidanceSession(type) {

                        if (this.role !== '교과교사') return; const data = this.teacherGuidanceData[type]; if (!data) return;

                        const initialAttendance = {};

                        const initialOriginalAttendance = {};
                        data.students.forEach(s => { 
                            if (s) {
                                initialAttendance[s.id] = '';
                                initialOriginalAttendance[s.id] = '';
                            }
                        });
                        data.sessions.push({ date: '', time: '', isSaved: false, place: '', content: '', attendance: initialAttendance, originalAttendance: initialOriginalAttendance });
                        this.saveGuidanceData();

                        this.$nextTick(() => { this.initFlatpickr(); });

                    },

                    isSessionReadyToSave(session) {

                        if (!session || !session.date || !session.time) return false;

                        if (!this.currentGuidanceData?.students || this.currentGuidanceData.students.length === 0) return false;

                        return Object.values(session.attendance || {}).some(value => value);

                    },

                    toggleSaveSession(session) {

                        if (this.role !== '교과교사' || !session) return;

                        const wasSaved = session.isSaved;
                        session.isSaved = !session.isSaved;

                        if (this.currentGuidanceData && this.currentGuidanceData.students) {

                            this.currentGuidanceData.students.forEach(student => {

                                if (!session.attendance) session.attendance = {};

                                if (student && !session.attendance.hasOwnProperty(student.id)) {

                                    session.attendance[student.id] = '';

                                }

                            });

                        }

                        // 저장 버튼을 눌렀을 때 (isSaved가 false -> true로 변경될 때) 원본 값 업데이트
                        if (!wasSaved && session.isSaved && session.attendance) {
                            if (!session.originalAttendance) {
                                session.originalAttendance = {};
                            }
                            Object.keys(session.attendance).forEach(studentId => {
                                session.originalAttendance[studentId] = session.attendance[studentId] || '';
                            });
                        }
                        this.saveGuidanceData();

                    },

                    scrollAttendance(direction, event) {

                        const container = event.target.closest('.relative')?.querySelector('.overflow-x-auto');

                        if (!container) return;

                        const scrollAmount = container.clientWidth * 0.8;

                        container.scrollBy({ left: direction === 'left' ? -scrollAmount : scrollAmount, behavior: 'smooth' });

                    },

                    async generatePdfFromHtml(htmlContent) {

                        this.previewHtml = htmlContent;

                        this.showPreviewModal = true;

                        this.adminActionStatus = '미리보기 생성 완료. 인쇄 버튼을 눌러 PDF로 저장하세요.';

                    },

                    exportCompletionStatusExcel() {
                        if (this.role !== '교과교사' || (this.teacherTab !== 'supplementary' && this.teacherTab !== 'additional')) return;
                        if (!this.teacherPlan.subjectName) {
                            alert('과목명을 입력하고 저장해주세요.');
                            return;
                        }

                        const data = this.teacherGuidanceData[this.teacherTab];
                        if (!data || !data.students || data.students.length === 0) {
                            alert(`${this.teacherTab === 'supplementary' ? '보충지도' : '추가학습'} 대상 학생이 없습니다.`);
                            return;
                        }

                        // 교육과정 편제표에서 학년, 학기, 계열, 학점 정보 가져오기
                        let subjectGrade = this.teacherPlan.subjectGrade;
                        let subjectSemester = this.teacherPlan.subjectSemester;
                        let subjectCategory = this.teacherPlan.subjectCategory || '';
                        let subjectCredits = 0;

                        if (subjectGrade != null && subjectSemester != null && subjectCategory) {
                            try {
                                const subjectInfo = this.findSubjectInCurriculum(
                                    this.teacherPlan.subjectName,
                                    subjectGrade,
                                    subjectSemester,
                                    null,  // 계열 정보 없음
                                    subjectCategory  // 분류는 시수 적용에만 사용
                                );
                                if (subjectInfo) {
                                    subjectCredits = Number(subjectInfo.학점) || 0;
                                }
                            } catch (error) {
                                console.warn('교육과정 편제표에서 학점 정보를 찾을 수 없습니다:', error);
                            }
                        }

                        const rows = [];
                        (data.students || []).forEach(student => {
                            if (!student || !student.id) return;
                            const status = this.guidanceCompletionStatus[student.id] || {};

                            const base = {
                                학번: student.id,
                                이름: student.name || '',
                                ...(this.teacherTab === 'supplementary' || this.teacherTab === 'additional' ? {
                                    특기사항: status.specialNotes || '일반학생',
                                    미도달항목: this.teacherTab === 'additional' ? (student.reason || '과목출석률') : (student.reason || '')
                                } : {}),
                                예방지도시간: status.preventiveHours || 0,
                                정서지원시간: status.emotionalSupportHours || 0,
                                // 과목 정보 추가 (통계 대시보드에서 사용)
                                학년: subjectGrade != null ? subjectGrade : '',
                                학기: subjectSemester != null ? subjectSemester : '',
                                계열: subjectCategory || '',
                                학점: subjectCredits || 0
                            };

                            const methodCols = {};
                            (this.moduleConfig.recognizedHours || []).forEach(rh => {
                                if (!rh || !rh.name) return;
                                methodCols[rh.name] = status[rh.name] || 0;
                            });

                            rows.push({
                                ...base,
                                ...methodCols,
                                총계: status.total || 0,
                                이수여부: status.completionStatus || '미이수',
                                비고: student.note || ''
                            });
                        });

                        if (!rows.length) {
                            alert('엑셀로 내보낼 이수현황 데이터가 없습니다.');
                            return;
                        }

                        const ws = XLSX.utils.json_to_sheet(rows);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, '이수현황표');

                        const now = new Date();
                        const y = now.getFullYear();
                        const m = String(now.getMonth() + 1).padStart(2, '0');
                        const d = String(now.getDate()).padStart(2, '0');
                        const filename = `이수현황표_${this.teacherPlan.subjectName}_${y}${m}${d}.xlsx`;

                        XLSX.writeFile(wb, filename);
                    },
                    async generateCompletionStatusPdf(type) {

                        const data = this.teacherGuidanceData[type];

                        if (!data || !this.role) return;

                        const title = type === 'preventive' ? '예방지도' : type === 'supplementary' ? '보충지도' : '추가학습';
                        
                        
                        let tableHtml = `<table><thead><tr>

                            <th>학생</th>

                            ${type === 'supplementary' ? '<th>특기사항</th><th>미도달 항목</th><th>예방지도</th><th>정서지원프로그램</th>' : ''}

                            ${type === 'additional' ? '<th>특기사항</th><th>미도달 항목</th><th>예방지도</th><th>정서지원프로그램</th>' : ''}

                            ${this.moduleConfig.recognizedHours.map(rh => `<th>${rh.name}</th>`).join('')}

                            <th>총계</th>

                            ${type === 'supplementary' || type === 'additional' ? '<th>이수여부</th><th>비고</th>' : ''}

                            </tr></thead><tbody>`;



                        if (data.students && data.students.length > 0) {

                            data.students.forEach(student => {

                                if (!student) return;

                                tableHtml += `<tr><td class="text-left">${student.name} (${student.id})</td>`;

                                const studentStatus = this.guidanceCompletionStatus[student.id] || {};

                                if (type === 'supplementary') {

                                    tableHtml += `<td>${studentStatus.specialNotes || '일반학생'}</td><td>${student.reason || ''}</td><td>${studentStatus.preventiveHours || 0}</td><td>${studentStatus.emotionalSupportHours || 0}</td>`;

                                } else if (type === 'additional') {

                                    tableHtml += `<td>${studentStatus.specialNotes || '일반학생'}</td><td>${student.reason || '과목출석률'}</td><td>${studentStatus.preventiveHours || 0}</td><td>${studentStatus.emotionalSupportHours || 0}</td>`;

                                }

                                this.moduleConfig.recognizedHours.forEach(rh => {

                                    tableHtml += `<td>${studentStatus[rh.name] || 0}</td>`;

                                });

                                tableHtml += `<td>${studentStatus.total || 0}</td>`;

                                if (type === 'supplementary' || type === 'additional') {

                                    const status = studentStatus.completionStatus || '미이수';

                                    tableHtml += `<td style="color: ${status === '이수' ? 'green' : 'red'}; font-weight: bold;">${status}</td>`;

                                    tableHtml += `<td>${student.note || ''}</td>`;

                                }

                                tableHtml += '</tr>';

                            });

                        } else {

                            const colspan = this.moduleConfig.recognizedHours.length + (type === 'supplementary' ? 8 : type === 'additional' ? 8 : 2);

                            tableHtml += `<tr><td colspan="${colspan}">학생 정보가 없습니다.</td></tr>`;

                        }

                        tableHtml += '</tbody></table>';

                        
                        
                        const finalHtml = `<div id="print-area"><h1>${title} 이수현황표</h1><div style="font-size: 1rem; line-height: 1.6; border: 1px solid #ccc; padding: 10px; margin-bottom: 2rem;"><p><strong>과목명:</strong> ${this.teacherPlan.subjectName || '미입력'}</p><p><strong>지도교사:</strong> ${this.formattedTeacherNames}</p></div>${tableHtml}</div>`;

                        
                        
                        this.generatePdfFromHtml(finalHtml);

                    },

                    async generateAttendancePdf(type) {

                        const data = this.teacherGuidanceData[type];

                        if (!data || !this.role) return;

                        const title = type === 'preventive' ? '예방지도' : type === 'supplementary' ? '보충지도' : '추가학습';
                        const savedSessions = data.sessions.filter(s => s && s.date);

                        
                        
                        let tableHtml = `<table><thead><tr><th>학번</th><th>이름</th>${savedSessions.map((s, i) => `<th>${i + 1}차시<br/>(${s.date})</th>`).join('')}</tr></thead><tbody>`;

                        if (data.students && data.students.length > 0) {

                            data.students.forEach(student => {

                                if (!student) return;

                                tableHtml += `<tr><td class="text-left">${student.id}</td><td class="text-left">${student.name}</td>`;

                                savedSessions.forEach(s => { tableHtml += `<td>${(s?.attendance?.[student.id] || '')}</td>`; });

                                tableHtml += '</tr>';

                            });

                        } else {

                            tableHtml += `<tr><td colspan="${savedSessions.length + 2}">학생 정보가 없습니다.</td></tr>`;

                        }

                        tableHtml += '</tbody></table>';

                        
                        
                        const finalHtml = `<div id="print-area"><h1>${title} 출석부</h1><div style="font-size: 1rem; line-height: 1.6; border: 1px solid #ccc; padding: 10px; margin-bottom: 2rem;"><p><strong>과목명:</strong> ${this.teacherPlan.subjectName || '미입력'}</p><p><strong>지도교사:</strong> ${this.formattedTeacherNames}</p></div>${tableHtml}</div>`;

                        this.generatePdfFromHtml(finalHtml);

                    },

                    async generateLessonLogPdf(type) {

                        if (!this.currentGuidanceData || !this.role) return;

                        const title = type === 'preventive' ? '예방지도' : type === 'supplementary' ? '보충지도' : '추가학습';
                        
                        
                        let lessonLogHtml = this.savedGuidanceSessions.map((session, index) => {

                            if (!session) return '';

                            const isLast = index === this.savedGuidanceSessions.length - 1;

                            const borderBottom = isLast ? '' : 'border-bottom: 1px solid #ccc; padding-bottom: 15px; margin-bottom: 15px;';

                            return `<div style="${borderBottom}"><h3 style="margin-top: ${index === 0 ? '0' : '15px'}; margin-bottom: 10px;">${index + 1}차시 수업일지 (${session.date} / ${session.time})</h3><table style="font-size: 10pt; width: 100%;"><tr><th style="width: 20%;">장소</th><td class="text-left" style="width: 30%;">${session.place || ''}</td><th style="width: 20%;">수업방법</th><td class="text-left" style="width: 30%;">${[...new Set(Object.values(session.attendance || {}))].filter(Boolean).join(', ') || '미입력'}</td></tr><tr><th>지도내용</th><td colspan="3" class="text-left"><div class="whitespace-pre-wrap" style="padding: 5px;">${session.content || ''}</div></td></tr></table></div>`;

                        }).join('');

                        
                        
                        const finalHtml = `<div id="print-area"><h1>${title} 수업일지</h1><div style="font-size: 1rem; line-height: 1.6; border: 1px solid #ccc; padding: 10px; margin-bottom: 2rem;"><p><strong>과목명:</strong> ${this.teacherPlan.subjectName || '미입력'}</p><p><strong>지도교사:</strong> ${this.formattedTeacherNames}</p><p><strong>운영기간:</strong> ${this.guidanceOperationPeriod}</p></div>${lessonLogHtml.length > 0 ? lessonLogHtml : '<p style="text-align: center;">저장된 수업일지가 없습니다.</p>'}</div>`;

                        this.generatePdfFromHtml(finalHtml);

                    },

                    closeImportModal() {
                            this.showImportModal = false;
                            this.importClasses = [''];
                            this.importGrade = null;
                            this.importSemester = null;
                            this.importCategory = '';
                            this.importModalError = '';
                            this.selectedUnderachieverFile = null;
                        },
                    addImportClassInput() { this.importClasses.push(''); },

                    removeImportClassInput(index) { this.importClasses.splice(index, 1); },

                        handleUnderachieverFileChange(event) {
                            const files = event && event.target && event.target.files ? event.target.files : null;
                            this.selectedUnderachieverFile = files && files[0] ? files[0] : null;
                        },
                    async importUnderachievers() {

                        if (this.role !== '교과교사') return;

                        this.importModalError = '';

                            const subjectName = (this.teacherPlan.subjectName || '').trim();
                            const grade = this.teacherPlan.subjectGrade != null ? Number(this.teacherPlan.subjectGrade) : null;
                            const semester = this.teacherPlan.subjectSemester != null ? Number(this.teacherPlan.subjectSemester) : null;
                            const series = (this.teacherPlan.subjectSeries || '').trim();
                            const category = (this.teacherPlan.subjectCategory || '').trim();

                            if (!subjectName || grade == null || semester == null || !series || !category) {
                                this.importModalError = '계획서 작성 탭에서 과목명, 학년, 학기, 계열, 분류를 모두 입력하고 저장한 후 다시 시도해주세요.';
                                return;

                        }

                            // 유효한 학급 번호(3자리)만 필터링
                            const validClasses = (this.importClasses || [])
                                .map(c => String(c || '').trim())
                                .filter(c => c.length === 3);
                            if (!validClasses.length) {
                                this.importModalError = '학급 번호(예: 101, 102)를 3자리로 최소 1개 이상 정확히 입력해주세요.';
                            return;

                        }

                            const classSet = new Set(validClasses);
                            if (!this.selectedUnderachieverFile) {
                                this.importModalError = '관리자로부터 공유받은 미도달 대상자 엑셀 파일을 선택해주세요.';
                            return; 

                        }



                            try {
                                this.importModalError = '엑셀 파일을 읽는 중입니다...';
                                const file = this.selectedUnderachieverFile;
                                const arrayBuffer = await new Promise((resolve, reject) => {
                                    const reader = new FileReader();
                                    reader.onload = e => resolve(e.target.result);
                                    reader.onerror = err => reject(err);
                                    reader.readAsArrayBuffer(file);
                                });

                                const data = new Uint8Array(arrayBuffer);
                                const workbook = XLSX.read(data, { type: 'array' });
                                if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                                    this.importModalError = '엑셀 파일에 시트가 없습니다.';
                            return; 

                        }



                                const firstSheet = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[firstSheet];
                                const rows = XLSX.utils.sheet_to_json(worksheet);
                            
                                if (!rows || rows.length === 0) {
                                    this.importModalError = '엑셀 파일에 데이터가 없습니다.';
                                    return;
                            }
                            
                                const supplementary = this.teacherGuidanceData.supplementary;
                                if (!supplementary) {
                                    this.importModalError = '보충지도 데이터가 초기화되지 않았습니다.';
                                    return;
                            }
                            

                                if (!Array.isArray(supplementary.students)) {
                                    supplementary.students = [];
                                }
                                if (!Array.isArray(supplementary.sessions)) {
                                    supplementary.sessions = [];
                                }

                                const existingIds = new Set(
                                    supplementary.students
                                        .filter(s => s && s.id)
                                        .map(s => String(s.id))
                                );

                                const newStudentsMap = new Map();

                                rows.forEach(row => {
                                    const id = String(row['학번'] || '').trim();
                                    const name = String(row['이름'] || '').trim();
                                    if (!id || !name) return;

                                    // 학급 필터: 학번 앞 3자리가 입력된 여러 학급 번호 중 하나와 일치하는 학생만 대상
                                    const studentClass = id.substring(0, 3);
                                    if (!classSet.has(studentClass)) return;

                                    const subjectsCell = String(row['미도달 과목(학점수)'] || '');
                                    if (!subjectsCell) return;
                            
                                    // "국어(2학점), 수학(3학점)" 형태에서 과목명만 분리
                                    const subjects = subjectsCell.split(',').map(s => s.trim()).filter(Boolean);
                                    let isTargetSubject = false;

                                    subjects.forEach(token => {
                                        if (isTargetSubject) return;
                                        const namePart = token.split('(')[0].trim();
                                        if (!namePart || namePart !== subjectName) return;

                                        // 교육과정 편제표에서 학년/학기/계열/분류가 일치하는 과목인지 확인 (정확한 일치 필요)
                                        const match = (this.curriculumData || []).find(rowCur => {
                                            if (!rowCur || !rowCur['과목명']) return false;
                                            const curName = String(rowCur['과목명']).trim();
                                            const searchName = String(subjectName || '').trim();
                                            const curGrade = rowCur['학년'] != null ? Number(rowCur['학년']) : null;
                                            const curSemester = rowCur['학기'] != null ? Number(rowCur['학기']) : null;
                                            const curSeries = rowCur['계열'] ? String(rowCur['계열']).trim() : '';
                                            const curCategory = rowCur['분류'] ? String(rowCur['분류']).trim() : '';
                                            return searchName === curName &&
                                                curGrade === grade &&
                                                curSemester === semester &&
                                                curSeries === series &&
                                                curCategory === category;
                        });



                                        if (match) {
                                            isTargetSubject = true;
                                        }
                                    });

                                    if (!isTargetSubject) return;
                                    if (existingIds.has(id) || newStudentsMap.has(id)) return;

                                    const reason = String(row['미도달내역'] || '').trim();
                                    const exceptionReason = String(row['예외처리'] || '').trim();
                            const isException = !!exceptionReason;

                            const note = isException ? `보충지도 예외처리 대상자 (${exceptionReason})` : '';



                                    newStudentsMap.set(id, {
                                        id,
                                        name,
                                        reason,
                                    isException,

                                    exceptionReason,

                                    note

                                });

                                });

                                const newStudents = Array.from(newStudentsMap.values());
                                if (!newStudents.length) {
                                    this.importModalError = '새로 추가할 학생이 없습니다. (이미 목록에 있거나 학년/학기/계열/학급이 현재 과목과 일치하지 않습니다.)';
                                    return;
                            }


                                // 보충지도 대상자 추가 (학업성취율 미도달자)
                                const supplementaryStudents = newStudents.filter(s => s.reason && s.reason.includes('학업성취율'));
                                if (supplementaryStudents.length > 0) {
                                    supplementary.students.push(...supplementaryStudents);
                                    supplementary.students.sort((a, b) => String(a.id).localeCompare(String(b.id)));

                                    supplementary.sessions.forEach(session => {
                                        if (!session) return;
                                        if (!session.attendance) session.attendance = {};
                                        if (!session.originalAttendance) session.originalAttendance = {};
                                        supplementaryStudents.forEach(student => {
                                            if (!session.attendance.hasOwnProperty(student.id)) {
                                                session.attendance[student.id] = '';
                                            }
                                            if (!session.originalAttendance.hasOwnProperty(student.id)) {
                                                session.originalAttendance[student.id] = '';
                                            }
                                        });
                                    });
                                }

                                // 추가학습 대상자 추가 (과목출석률 미도달만 있는 학생)
                                const additional = this.teacherGuidanceData.additional;
                                if (!additional) {
                                    this.teacherGuidanceData.additional = { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {}, originalAttendance: {} })), error: '' };
                                }
                                if (!Array.isArray(additional.students)) {
                                    additional.students = [];
                                }
                                if (!Array.isArray(additional.sessions)) {
                                    additional.sessions = Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {}, originalAttendance: {} }));
                                }

                                const existingAdditionalIds = new Set(
                                    additional.students
                                        .filter(s => s && s.id)
                                        .map(s => String(s.id))
                                );

                                // 추가학습 대상자 추가 (과목출석률만 미도달한 학생, 학업성취율 미도달 제외)
                                const supplementaryIds = new Set(supplementaryStudents.map(s => s.id));
                                
                                // 학업성취율 미도달자인 경우 보충지도 대상자로 추가하고 미도달 항목 업데이트
                                const studentsToMoveToSupplementary = [];
                                const additionalStudents = newStudents.filter(s => {
                                    // 보충지도 대상자로 이미 추가된 학생은 제외
                                    if (supplementaryIds.has(s.id)) return false;
                                    
                                    // 추가학습 대상자에 이미 있는 학생은 제외
                                    if (existingAdditionalIds.has(s.id)) return false;
                                    
                                    // 미도달내역 확인
                                    const reason = s.reason || '';
                                    
                                    // 학업성취율 미도달자인 경우 (학업성취율 포함)
                                    if (reason.includes('학업성취율')) {
                                        // 보충지도 대상자에 추가하고 미도달 항목을 '학업성취율&과목출석률'로 설정
                                        studentsToMoveToSupplementary.push(s);
                                        return false; // 추가학습 대상자로는 추가하지 않음
                                    }
                                    
                                    // 과목출석률만 미도달한 학생만 추가학습 대상자로 추가
                                    return reason.includes('과목출석률') || !reason.includes('학업성취율');
                                });

                                // 학업성취율 미도달자를 보충지도 대상자로 추가
                                if (studentsToMoveToSupplementary.length > 0) {
                                    studentsToMoveToSupplementary.forEach(student => {
                                        const supplementaryStudent = {
                                            id: student.id,
                                            name: student.name,
                                            reason: '학업성취율&과목출석률',
                                            isException: student.isException || false,
                                            exceptionReason: student.exceptionReason || '',
                                            note: student.note || ''
                                        };
                                        
                                        // 보충지도 대상자에 이미 있는 경우 미도달 항목만 업데이트
                                        const existingStudent = supplementary.students.find(s => s && s.id === student.id);
                                        if (existingStudent) {
                                            existingStudent.reason = '학업성취율&과목출석률';
                                        } else {
                                            supplementary.students.push(supplementaryStudent);
                                        }
                                    });
                                    
                                    supplementary.students.sort((a, b) => String(a.id).localeCompare(String(b.id)));
                                    
                                    supplementary.sessions.forEach(session => {
                                        if (!session) return;
                                        if (!session.attendance) session.attendance = {};
                                        if (!session.originalAttendance) session.originalAttendance = {};
                                        studentsToMoveToSupplementary.forEach(student => {
                                            if (!session.attendance.hasOwnProperty(student.id)) {
                                                session.attendance[student.id] = '';
                                            }
                                            if (!session.originalAttendance.hasOwnProperty(student.id)) {
                                                session.originalAttendance[student.id] = '';
                                            }
                                        });
                                    });
                                }

                                if (additionalStudents.length > 0) {
                                    additionalStudents.forEach(student => {
                                        student.reason = '과목출석률';
                                        student.note = student.isException ? `추가학습 예외처리 대상자 (${student.exceptionReason})` : '';
                                    });
                                    additional.students.push(...additionalStudents);
                                    additional.students.sort((a, b) => String(a.id).localeCompare(String(b.id)));

                                    additional.sessions.forEach(session => {
                                        if (!session) return;
                                        if (!session.attendance) session.attendance = {};
                                        if (!session.originalAttendance) session.originalAttendance = {};
                                        additionalStudents.forEach(student => {
                                            if (!session.attendance.hasOwnProperty(student.id)) {
                                                session.attendance[student.id] = '';
                                            }
                                            if (!session.originalAttendance.hasOwnProperty(student.id)) {
                                                session.originalAttendance[student.id] = '';
                                            }
                                        });
                                    });
                                }
                                
                                // 학업성취율 미도달자가 있는 경우 안내 메시지
                                if (studentsToMoveToSupplementary.length > 0) {
                                    const movedCount = studentsToMoveToSupplementary.length;
                                    const message = `학업성취율 미도달자 ${movedCount}명은 보충지도 관리 탭에서 관리하십시오.`;
                                    if (additionalStudents.length > 0) {
                                        this.importModalError = `${message} 추가학습 대상자 ${additionalStudents.length}명이 추가되었습니다.`;
                                    } else {
                                        this.importModalError = message;
                                    }
                                } else if (additionalStudents.length > 0) {
                                    this.importModalError = '';
                                }

                                this.importModalError = '';
                                this.selectedUnderachieverFile = null;
                                this.showImportModal = false;
                                await this.saveGuidanceData();
                                
                                const totalAdded = supplementaryStudents.length + additionalStudents.length;
                                let message = '';
                                if (supplementaryStudents.length > 0 && additionalStudents.length > 0) {
                                    message = `보충지도 대상자 ${supplementaryStudents.length}명, 추가학습 대상자 ${additionalStudents.length}명을 추가했습니다.`;
                                } else if (supplementaryStudents.length > 0) {
                                    message = `${supplementaryStudents.length}명의 학생을 보충지도 대상자로 추가했습니다.`;
                                } else if (additionalStudents.length > 0) {
                                    message = `${additionalStudents.length}명의 학생을 추가학습 대상자로 추가했습니다.`;
                                } else {
                                    message = '추가된 학생이 없습니다.';
                                }
                                alert(message);
                            } catch (error) {
                                console.error('미도달 대상자 엑셀 업로드 오류:', error);
                                this.importModalError = '엑셀 파일을 처리하는 중 오류가 발생했습니다.';
                            }
                    },

                    resetSupplementaryStudents() {

                        if (this.role !== '교과교사') return;

                        if (this.teacherGuidanceData.supplementary) {

                            this.teacherGuidanceData.supplementary.students = [];

                            this.teacherGuidanceData.supplementary.sessions.forEach(session => { 
                                if(session) {
                                    session.attendance = {};
                                    session.originalAttendance = {};
                                }
                            });
                            this.saveGuidanceData();
                        }
                    },
                    resetAdditionalStudents() {
                        if (this.role !== '교과교사') return;
                        if (this.teacherGuidanceData.additional) {
                            this.teacherGuidanceData.additional.students = [];
                            this.teacherGuidanceData.additional.sessions.forEach(session => { 
                                if(session) {
                                    session.attendance = {};
                                    session.originalAttendance = {};
                                }
                            });
                            this.saveGuidanceData();

                        }

                    },



                    // --- Homeroom Teacher Methods ---

                    handleHomeroomUnderachieverUpload(event) {
                        if (this.role !== '담임교사') return;
                        const file = event?.target?.files?.[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = e => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const firstSheet = workbook.SheetNames[0];
                                const ws = workbook.Sheets[firstSheet];
                                const rows = XLSX.utils.sheet_to_json(ws);
                                this.homeroomUnderachieverRows = rows || [];
                                this.homeroomMessage = `미도달 대상자 ${this.homeroomUnderachieverRows.length}건의 데이터를 불러왔습니다. 학급 번호를 입력해 조회하세요.`;
                            } catch (error) {
                                console.error('담임 미도달 엑셀 업로드 오류:', error);
                                this.homeroomMessage = '엑셀 파일을 처리하는 중 오류가 발생했습니다.';
                                this.homeroomUnderachieverRows = [];
                            }
                        };
                        reader.onerror = err => {
                            console.error('담임 미도달 엑셀 파일 읽기 오류:', err);
                            this.homeroomMessage = '엑셀 파일을 읽는 중 오류가 발생했습니다.';
                        };
                        reader.readAsArrayBuffer(file);
                    },
                    async searchHomeroomClass(){

                        if(this.role !== '담임교사') return;

                        this.homeroomMessage = '데이터 조회 중...';

                        this.searchedStudents = [];

                        this.processedHomeroomStudents = []; // 초기화

                        const classInput = this.homeroomClassInput.trim();

                        if(!classInput){ 

                            this.homeroomMessage = '학급 번호를 입력해주세요.'; 
                        
                                this.processedHomeroomStudents = [];

                                return;

                        }

                        

                        const rows = this.homeroomUnderachieverRows || [];
                        if (!rows.length) {
                            this.homeroomMessage = '먼저 관리자가 공유한 미도달 대상자 엑셀 파일을 업로드해주세요.';
                            this.processedHomeroomStudents = [];

                            return; 

                        }



                        // processedHomeroomStudents 계산 로직 (엑셀 기반)
                        const studentMap = new Map();

                        rows.forEach(row => {
                            const id = String(row['학번'] || '').trim();
                            const name = String(row['이름'] || '').trim() || '이름 없음';
                            if (!id || !id.startsWith(classInput)) return;

                            const subjectsCell = String(row['미도달 과목(학점수)'] || '');
                            const reasonCell = String(row['미도달내역'] || row['미도달 항목'] || '').trim();


                            const subjects = subjectsCell.split(',').map(s => s.trim()).filter(Boolean);
                            if (!subjects.length) return;

                            if (!studentMap.has(id)) {
                                studentMap.set(id, {
                                    id,
                                    name,
                                    subjects: [],
                                    originalStudent: { id, name }
                                });
                            }
                            const studentData = studentMap.get(id);
                            subjects.forEach(subj => {
                                const subjectName = subj.split('(')[0].trim();
                                if (!subjectName) return;
                                studentData.subjects.push({
                                    subject: subjectName,
                                    reason: reasonCell || ''
                            });
                        });

                        });



                        const tableRows = [];

                        studentMap.forEach(studentData => {

                            studentData.subjects.forEach((subjectInfo, index) => {

                                tableRows.push({ ...studentData, ...subjectInfo, isFirstRow: index === 0, rowspan: studentData.subjects.length });

                            });

                        });

                        tableRows.sort((a, b) => {

                            if (!a || !a.id || !b || !b.id) return 0;

                            if (a.id < b.id) return -1; if (a.id > b.id) return 1; return 0;

                        });

                        
                        
                        this.processedHomeroomStudents = tableRows;

                        
                        
                        // 학생 수 계산 (studentMap의 크기)

                        const studentCount = studentMap.size;

                        
                        
                        if(studentCount > 0){

                            this.homeroomMessage = `${classInput}반 미도달 학생 ${studentCount}명을 조회했습니다.`;

                        } else {

                            this.homeroomMessage = `해당 학급에 미도달 학생이 없습니다.`;

                        }

                    },

                    async loadAllTeacherCompletionData() {

                        // 모든 교과교사의 이수 현황 데이터를 불러와서 allTeacherCompletionData에 저장

                        if (!this.schoolId || !db) return;

                        this.allTeacherCompletionData = {};

                        
                        
                        try {

                            // 먼저 commonData/completionStatus에서 전송된 데이터 확인 (권한이 있으면)

                            try {

                                const commonCompletionDocRef = doc(db, `schools/${this.schoolId}/commonData`, 'completionStatus');

                                const commonCompletionSnap = await getDoc(commonCompletionDocRef);

                                if (commonCompletionSnap.exists()) {

                                    const completionData = commonCompletionSnap.data().data || {};

                                    Object.keys(completionData).forEach(subjectName => {

                                        if (completionData[subjectName]) {

                                            if (!this.allTeacherCompletionData[subjectName]) {

                                                this.allTeacherCompletionData[subjectName] = {};

                                            }

                                            Object.keys(completionData[subjectName]).forEach(studentId => {

                                                const normalizedStudentId = String(studentId);

                                                const completionStatus = completionData[subjectName][studentId];

                                                if (completionStatus === '이수' || completionStatus === '미이수') {

                                                    this.allTeacherCompletionData[subjectName][normalizedStudentId] = completionStatus;

                                                    console.log(`전송된 데이터 로드 (commonData): ${subjectName} - ${normalizedStudentId} - ${completionStatus}`);

                                                }

                                            });

                                        }

                                    });

                                }

                            } catch (e) {

                                console.log('commonData/completionStatus 읽기 실패 (무시 가능):', e);

                            }

                            
                            
                            // commonData/completionStatus에서 전송된 데이터 우선 읽기

                            // collectionGroup 대신 직접 경로 접근 방식 사용

                            try {

                                // 1. commonData/completionStatus에서 전송된 이수현황 데이터 읽기 (우선)

                                // 이 데이터가 가장 최신이고 정확함

                                try {

                                    // currentSchoolCode를 우선 사용, 없으면 schoolId 사용

                                    const activeSchoolId = this.currentSchoolCode || this.schoolId;

                                    if (!activeSchoolId) {

                                        console.warn('학교코드가 설정되지 않아 이수현황 데이터를 읽을 수 없습니다.');

                                        return;

                                    }

                                    const commonCompletionDocRef = doc(db, `schools/${activeSchoolId}/commonData`, 'completionStatus');

                                    const commonCompletionSnap = await getDoc(commonCompletionDocRef);

                                    if (commonCompletionSnap.exists()) {

                                        const completionData = commonCompletionSnap.data().data || {};

                                        let loadedCount = 0;

                                        Object.keys(completionData).forEach(subjectName => {

                                            if (completionData[subjectName]) {

                                                if (!this.allTeacherCompletionData[subjectName]) {

                                                    this.allTeacherCompletionData[subjectName] = {};

                                                }

                                                Object.keys(completionData[subjectName]).forEach(studentId => {

                                                    const normalizedStudentId = String(studentId);

                                                    const completionStatus = completionData[subjectName][studentId];

                                                    if (completionStatus === '이수' || completionStatus === '미이수') {

                                                        this.allTeacherCompletionData[subjectName][normalizedStudentId] = completionStatus;

                                                        loadedCount++;

                                                        console.log(`전송된 데이터 로드 (commonData): ${subjectName} - ${normalizedStudentId} - ${completionStatus}`);

                                                    }

                                                });

                                            }

                                        });

                                        console.log(`commonData/completionStatus에서 총 ${loadedCount}개 학생 데이터 로드 완료`);

                                    }

                                } catch (e) {

                                    console.error('commonData/completionStatus 읽기 실패:', e);

                                }

                                
                                
                                // 2. teacherData 컬렉션을 순회하면서 각 교과교사의 guidance 데이터 읽기 (이수현황 계산용)

                                // commonData에 없는 데이터만 계산

                                try {

                                    // currentSchoolCode를 우선 사용, 없으면 schoolId 사용

                                    const activeSchoolId = this.currentSchoolCode || this.schoolId;

                                    if (!activeSchoolId) {

                                        console.warn('학교코드가 설정되지 않아 이수현황 데이터를 읽을 수 없습니다.');

                                        return;

                                    }

                                    console.log('teacherData 컬렉션 읽기 시작...', { activeSchoolId });

                                    const teacherDataRef = collection(db, `schools/${activeSchoolId}/teacherData`);

                                    const teacherDataSnap = await getDocs(teacherDataRef);

                                    console.log(`teacherData 문서 개수: ${teacherDataSnap.docs.length}`);

                                    
                                    
                                    for (const teacherDoc of teacherDataSnap.docs) {

                                        const uid = teacherDoc.id;

                                        
                                        
                                        // 각 교과교사의 guidance 컬렉션 읽기

                                        try {

                                            const guidanceRef = collection(teacherDoc.ref, 'guidance');

                                            const guidanceSnap = await getDocs(guidanceRef);

                                            
                                            
                                            for (const guidanceDoc of guidanceSnap.docs) {

                                                const guidanceData = guidanceDoc.data();

                                                const subjectName = this.decodeSubjectName(guidanceDoc.id);

                                                
                                                
                                                if (!guidanceData || !guidanceData.supplementary || !guidanceData.supplementary.students) continue;

                                                
                                                
                                                // 보충지도 시간 및 이수 현황 계산

                                                const subjectInfo = this.curriculumData.find(s => s.과목명 === subjectName);

                                                if (!subjectInfo) {

                                                    console.log(`과목 정보 없음: ${subjectName}`);

                                                    continue;

                                                }

                                                
                                                
                                                const requiredSubjectCredits = Number(subjectInfo.학점) || 0;

                                                if (requiredSubjectCredits <= 0) continue;

                                                
                                                
                                                const category = subjectInfo['분류'] || '';
                                                const hoursPerCredit = this.getHoursPerCredit(category);
                                                const supplementaryHours = requiredSubjectCredits * hoursPerCredit;

                                                const requiredHoursForCompletion = Math.ceil((supplementaryHours * 2) / 3 * 10) / 10;

                                                const maxEmotionalSupportHours = supplementaryHours * (this.moduleConfig.emotionalSupportRatio / 100);

                                                
                                                
                                                // 예방지도 시간 계산 (guidanceCompletionStatus와 동일한 로직)

                                                const preventiveTotals = {};

                                                const preventiveSessions = guidanceData.preventive?.sessions || [];

                                                if (preventiveSessions && preventiveSessions.length > 0) {

                                                    preventiveSessions.forEach(session => {

                                                        if (session && session.isSaved && session.attendance) {

                                                            for (const studentId in session.attendance) {

                                                                const methodName = session.attendance[studentId];

                                                                if (methodName) {

                                                                    const methodConfig = this.moduleConfig.recognizedHours.find(m => m.name === methodName);

                                                                    if (methodConfig) {

                                                                        if (!preventiveTotals[studentId]) preventiveTotals[studentId] = 0;

                                                                        preventiveTotals[studentId] += methodConfig.hours;

                                                                    }

                                                                }

                                                            }

                                                        }

                                                    });

                                                }

                                                
                                                
                                                const students = guidanceData.supplementary.students || [];

                                                const sessions = guidanceData.supplementary.sessions || [];

                                                
                                                
                                                // 학생별 이수 현황 계산 (guidanceCompletionStatus와 정확히 동일한 로직)

                                                students.forEach(student => {

                                                    if (!student || !student.id) return;

                                                    
                                                    
                                                    // 학번을 문자열로 정규화하여 일관성 보장

                                                    const studentId = String(student.id);

                                                    
                                                    
                                                    if (!this.allTeacherCompletionData[subjectName]) {

                                                        this.allTeacherCompletionData[subjectName] = {};

                                                    }

                                                    
                                                    
                                                    // 전송된 데이터가 이미 있으면 계산하지 않고 건너뛰기

                                                    if (this.allTeacherCompletionData[subjectName][studentId]) {

                                                        console.log(`전송된 데이터 사용: ${subjectName} - ${studentId} - ${this.allTeacherCompletionData[subjectName][studentId]}`);

                                                        return;

                                                    }

                                                    
                                                    
                                                    // 각 방법별 시간을 누적 (guidanceCompletionStatus와 동일)

                                                    const methodHours = {};

                                                    this.moduleConfig.recognizedHours.forEach(rh => {

                                                        methodHours[rh.name] = 0;

                                                    });

                                                    
                                                    
                                                    // 보충지도 시간 계산 (각 방법별로 누적)

                                                    if (sessions && sessions.length > 0) {

                                                        sessions.forEach(session => {

                                                            if (session && session.isSaved && session.attendance && session.attendance[studentId]) {

                                                                const methodName = session.attendance[studentId];

                                                                if (methodName && methodHours.hasOwnProperty(methodName)) {

                                                                    const methodConfig = this.moduleConfig.recognizedHours.find(m => m.name === methodName);

                                                                    if (methodConfig) {

                                                                        methodHours[methodName] = parseFloat((methodHours[methodName] + methodConfig.hours).toFixed(2));

                                                                    }

                                                                }

                                                            }

                                                        });

                                                    }

                                                    
                                                    
                                                    // 보충지도 시간 합계 계산

                                                    let currentStudentTotal = 0;

                                                    this.moduleConfig.recognizedHours.forEach(rh => {

                                                        currentStudentTotal += (methodHours[rh.name] || 0);

                                                    });

                                                    
                                                    
                                                    // 예방지도 시간 추가 (guidanceCompletionStatus와 동일한 로직)

                                                    const totalPreventiveHoursForStudent = preventiveTotals[studentId] || 0;

                                                    // 학생별 예방지도 최대 연계 가능 시수 산정

                                                    const studentInfo = this.studentData.find(s => String(s['학번']) === studentId);

                                                    const isSpecialSupport = studentInfo && studentInfo['특기사항'] === '학습지원대상';

                                                    const maxPreventiveLinkedHours = supplementaryHours * ((isSpecialSupport ? this.moduleConfig.specialPreventiveRatio : this.moduleConfig.preventiveRatio) / 100);

                                                    // 예방지도 인정 시간

                                                    // 합산값은 소수점 유지, 상한만 적용

                                                    const creditedPreventiveHours = Math.min((totalPreventiveHoursForStudent || 0), maxPreventiveLinkedHours);

                                                    currentStudentTotal += creditedPreventiveHours;

                                                    
                                                    
                                                    // 정서지원 시간 추가 (guidanceCompletionStatus와 동일한 로직)

                                                    const emotionalData = this.emotionalSupportData.find(e => String(e['학번']) === studentId);

                                                    const uploadedHours = emotionalData ? Number(emotionalData['정서지원프로그램 참여시간']) : 0;

                                                    // 비율 기반 1차 캡 (소수점 유지)

                                                    const baseEmotionalHours = Math.min((uploadedHours || 0), maxEmotionalSupportHours);

                                                    // 예방지도 최대 연계 가능 시수 내에서 남은 여유

                                                    const remainingPreventiveCapacity = Math.max(0, maxPreventiveLinkedHours - creditedPreventiveHours);

                                                    const creditedEmotionalHours = Math.min(baseEmotionalHours, remainingPreventiveCapacity);

                                                    currentStudentTotal += creditedEmotionalHours;

                                                    
                                                    
                                                    // 최종 합계 계산: 총계만 소수점 절삭

                                                    const finalTotal = Math.floor(currentStudentTotal);

                                                    
                                                    
                                                    // 이수 여부 판단 (guidanceCompletionStatus와 동일한 로직)

                                                    const tolerance = 0.001;

                                                    if (requiredHoursForCompletion > 0 && finalTotal >= requiredHoursForCompletion - tolerance) {

                                                        this.allTeacherCompletionData[subjectName][studentId] = '이수';

                                                        console.log(`이수현황 계산 완료: ${subjectName} - ${studentId} - 이수 (${finalTotal}/${requiredHoursForCompletion})`);

                                                    } else {

                                                        this.allTeacherCompletionData[subjectName][studentId] = '미이수';

                                                        console.log(`이수현황 계산 완료: ${subjectName} - ${studentId} - 미이수 (${finalTotal}/${requiredHoursForCompletion})`);

                                                    }

                                                });

                                            }

                                        } catch (guidanceError) {

                                            console.log(`교과교사 ${uid}의 guidance 컬렉션 읽기 실패 (권한 없음 가능):`, guidanceError);

                                        }

                                    }

                                } catch (e) {

                                    console.error('teacherData 컬렉션 읽기 실패:', e);

                                    console.error('오류 상세:', {

                                        code: e.code,

                                        message: e.message,

                                        stack: e.stack

                                    });

                                }

                            } catch (e) {

                                console.error('이수현황 데이터 로드 실패:', e);

                                console.error('오류 상세:', {

                                    code: e.code,

                                    message: e.message,

                                    stack: e.stack

                                });

                            }

                            
                            
                            console.log('담임교사 대시보드: 모든 교과교사 이수 현황 데이터 로드 완료', {

                                subjectsCount: Object.keys(this.allTeacherCompletionData).length,

                                subjects: Object.keys(this.allTeacherCompletionData),

                                data: this.allTeacherCompletionData

                            });

                            
                            
                            // 각 과목별로 학생 수 확인

                            Object.keys(this.allTeacherCompletionData).forEach(subj => {

                                const studentCount = Object.keys(this.allTeacherCompletionData[subj]).length;

                                console.log(`과목 ${subj}: ${studentCount}명의 이수현황 데이터`, this.allTeacherCompletionData[subj]);

                            });

                            
                            
                            // Vue 반응성을 위해 강제 업데이트

                            this.$forceUpdate();

                        } catch (error) {

                            console.error('교과교사 이수 현황 데이터 불러오기 오류:', error);

                        }

                    },

                    
                    
                    // --- Helper functions ---

                    resetRoleSpecificData() {

                        this.teacherPlan = this.getInitialTeacherPlan();

                        this.teacherGuidanceData = this.getInitialGuidanceData();

                        this.teacherPlanError = ''; this.teacherPlanStatus = ''; this.newGuidanceStudentId = '';

                        this.homeroomClassInput = ''; this.searchedStudents = []; this.homeroomMessage = '';

                        this.processedHomeroomStudents = [];

                    },

                    resetAllLocalData(resetAuth = true) {

                        if (resetAuth) {

                            this.user = null; this.isLoggedIn = false;

                        }

                        this.role = null; this.schoolId = null;

                        this.currentSchoolCode = '';

                        this.curriculumData = []; this.studentData = []; this.emotionalSupportData = [];

                        this.deployedUnderachievers = []; this.underachievers = [];

                        this.resetRoleSpecificData();

                        this.moduleConfig = this.$options.data().moduleConfig;

                        this.newsletterForm = this.$options.data().newsletterForm;

                        this.pledgeForm = this.$options.data().pledgeForm;

                        this.uploadStatus = { curriculum: '', student: '', emotionalSupport: '' };

                        this.statusMessage = ''; this.moduleConfigStatus = ''; this.underachieversStatus = ''; this.adminActionStatus = '';

                    },

                    resetTeacherData(resetGuidance = true) {

                        this.teacherPlan = this.getInitialTeacherPlan();

                        if (resetGuidance) { this.teacherGuidanceData = this.getInitialGuidanceData(); }

                        this.teacherPlanError = ''; this.teacherPlanStatus = ''; this.newGuidanceStudentId = '';

                    },



                    // --- Admin Modify Modal Methods ---

                    async openAdminModifyModal() {

                        if (this.role !== '관리자') return;

                        if (!this.currentSchoolCode) {

                            await this.fetchCurrentSchoolCode();

                        }

                        this.newSchoolIdForModify = this.currentSchoolCode || '';

                        this.adminModifyMode = 'schoolCode';

                        this.adminModifyError = '';

                        this.showAdminModifyModal = true;

                    },

                    async saveAdminSchoolIdModification() {

                        this.adminModifyError = '';

                        const newCode = this.newSchoolIdForModify.trim();

                        const invalidChars = /[\s./*#$[\]]/;



                        if (!newCode) { this.adminModifyError = "학교코드를 입력해주세요."; return; }

                        if (invalidChars.test(newCode)) { this.adminModifyError = "공백이나 특수문자 (/, ., *, # 등)는 사용할 수 없습니다."; return; }

                        if (!this.currentSchoolCode) { this.adminModifyError = "현재 설정된 학교코드를 찾을 수 없습니다."; return; }

                        if (newCode === this.currentSchoolCode) { this.showAdminModifyModal = false; return; }



                        this.isLoading = true;



                        try {

                            const nowIso = new Date().toISOString();

                            await runTransaction(db, async (transaction) => {

                                const currentRef = doc(db, `schoolCodes/${this.currentSchoolCode}`);

                                const currentSnap = await transaction.get(currentRef);

                                if (!currentSnap.exists()) {

                                    throw new Error('현재 학교코드를 찾을 수 없습니다. 다시 시도하세요.');

                                }

                                const currentData = currentSnap.data();

                                if (currentData.ownerUid !== this.user.uid) {

                                    throw new Error('해당 학교코드를 수정할 권한이 없습니다.');

                                }

                                const newRef = doc(db, `schoolCodes/${newCode}`);

                                const newSnap = await transaction.get(newRef);

                                if (newSnap.exists()) {

                                    throw new Error('이미 사용 중인 학교코드입니다. 다른 코드를 입력하세요.');

                                }

                                const previousCodes = Array.isArray(currentData.previousCodes)

                                    ? [...currentData.previousCodes, this.currentSchoolCode]

                                    : [this.currentSchoolCode];

                                transaction.set(newRef, {

                                    ownerUid: currentData.ownerUid,

                                    ownerEmail: currentData.ownerEmail || this.user.email || null,

                                    canonicalSchoolId: currentData.canonicalSchoolId || this.schoolId,

                                    createdAt: currentData.createdAt || nowIso,

                                    updatedAt: nowIso,

                                    disabled: false,

                                    previousCodes: previousCodes

                                });

                                transaction.set(currentRef, {

                                    disabled: true,

                                    updatedAt: nowIso,

                                    replacedBy: newCode

                                }, { merge: true });

                            });



                            const previousSchoolCode = this.currentSchoolCode;
                            this.currentSchoolCode = newCode;
                            
                            // 이전 학교코드의 관리자 localStorage 데이터 초기화
                            if (this.user && previousSchoolCode && previousSchoolCode !== this.currentSchoolCode) {
                                const previousAdminStorageKey = `minAchieve_admin_${this.user.uid}_${previousSchoolCode}`;
                                try {
                                    localStorage.removeItem(previousAdminStorageKey);
                                    console.log("이전 학교코드의 관리자 미도달 대상자 명단 초기화:", previousAdminStorageKey);
                                    // 메모리상의 데이터도 초기화
                                    this.underachievers = [];
                                } catch (error) {
                                    console.warn("이전 학교코드 관리자 데이터 초기화 실패:", error);
                                }
                            }

                            await this.fetchCurrentSchoolCode();
                            
                            // 새로운 학교코드로 공용 데이터 다시 로드 (이전 데이터는 초기화됨)
                            await this.loadCommonData();

                            this.adminModifyError = '';

                            this.adminActionStatus = `학교코드가 '${newCode}'(으)로 변경되었습니다. 새 코드를 교사들에게 공유하세요.`;

                            this.showAdminModifyModal = false;

                        this.newSchoolIdForModify = '';

                        } catch (error) {

                            console.error("학교코드 변경 중 오류:", error);

                            this.adminModifyError = error?.message || '학교코드 변경 중 오류가 발생했습니다.';

                        } finally {

                            this.isLoading = false;

                        }

                    },

                },



                mounted() {

                    this.initApp();

                    
                    
                    // 교과교사 데이터 자동 저장 (30초마다)

                    setInterval(() => {

                        if (this.role === '교과교사' && this.schoolId && this.user && this.teacherPlan.subjectName) {

                            // 조용히 저장 (에러가 있어도 로그만 출력)

                            this.saveTeacherPlan().catch(err => console.log("자동 저장 오류 (teacherPlan):", err));

                            this.saveGuidanceData().then(result => {

                                if (result && !result.success) {

                                    console.log("자동 저장 오류 (guidanceData):", result.message);

                                }

                            }).catch(err => console.log("자동 저장 오류 (guidanceData):", err));

                        }

                    }, 30000); // 30초마다

                },

                beforeUnmount() {

                    // 컴포넌트가 언마운트되기 전 마지막 저장

                    if (this.role === '교과교사' && this.schoolId && this.user && this.teacherPlan.subjectName) {

                        this.saveTeacherPlan().catch(err => console.log("마지막 저장 오류 (teacherPlan):", err));

                        this.saveGuidanceData().then(result => {

                            if (result && !result.success) {

                                console.log("마지막 저장 오류 (guidanceData):", result.message);

                            }

                        }).catch(err => console.log("마지막 저장 오류 (guidanceData):", err));

                    }

                }



            }).mount('#app');



        } catch (error) {

            console.error("Firebase initialization error:", error);

            alert("Firebase 초기화 중 심각한 오류가 발생했습니다. 페이지를 새로고침하거나 관리자에게 문의하세요.");

            const appElement = document.getElementById('app');

            if (appElement) {

                const loadingIndicator = appElement.querySelector('div[v-if="isLoading"]');

                if (loadingIndicator) loadingIndicator.style.display = 'none';

            }

        }

    </script>





</body>

</html>







