<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>최소 성취수준 보장지도 관리</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- XLSX / FileSaver  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: 'Inter', 'Pretendard', sans-serif; background-color: #f9fafb; }
    [v-cloak] { display: none; }
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex; align-items: center; justify-content: center;
      z-index: 50;
    }
    .modal-content {
      background: white; border-radius: 0.75rem;
      width: 90%; max-width: 480px;
      padding: 2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }
  </style>
</head>
<body>
  <div id="app" v-cloak class="min-h-screen flex flex-col">

    <!-- 헤더 -->
    <header class="bg-white shadow">
      <div class="max-w-7xl mx-auto px-4 flex justify-between items-center h-16">
        <div class="flex items-center space-x-2">
          <svg class="w-6 h-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"/>
          </svg>
          <span class="font-semibold text-xl text-gray-800">최소 성취수준 보장지도 관리</span>
        </div>
        <div>
          <button v-if="!isLoggedIn" @click="login"
            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm">
            Google 로그인
          </button>
          <div v-else class="flex items-center space-x-3">
            <span class="text-gray-700 text-sm">{{ user?.email }}</span>
            <button @click="logout" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">로그아웃</button>
          </div>
        </div>
      </div>
    </header>

    <!-- 메인 -->
    <main class="flex-grow p-6 container mx-auto text-center">

      <!-- 로딩 -->
      <div v-if="isLoading" class="mt-10 text-gray-500">로딩 중...</div>

      <!-- 로그인 전 -->
      <div v-if="!isLoggedIn && !isLoading" class="mt-20">
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Google 계정으로 로그인하세요</h2>
        <p class="text-gray-600 mb-6">
          이 서비스를 이용하려면 <strong>Google 계정으로 로그인</strong>해야 합니다.<br>
          로그인 후 역할(교과교사, 담임교사, 관리자)을 선택하여 시작할 수 있습니다.
        </p>
        <button @click="login"
          class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded shadow-lg">
          Google로 로그인하기
        </button>
      </div>

      <!-- 역할 선택 모달 -->
      <div v-if="isLoggedIn && !role && !isLoading" class="modal-overlay">
        <div class="modal-content">
          <h2 class="text-xl font-bold mb-4 text-center">역할 선택</h2>
          <button @click="selectRole('교과교사')" class="w-full mb-2 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-left rounded">교과교사</button>
          <button @click="selectRole('담임교사')" class="w-full mb-2 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-left rounded">담임교사</button>
          <button @click="showAdminCodeInput = true" class="w-full px-4 py-3 bg-gray-100 hover:bg-gray-200 text-left rounded">관리자</button>
          <div v-if="showAdminCodeInput" class="mt-3">
            <input type="password" v-model="adminCode" placeholder="관리자 코드 입력 (0822)"
              class="border rounded w-full p-2 mb-2"/>
            <button @click="submitAdminCode"
              class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">확인</button>
            <p v-if="adminCodeError" class="text-red-500 text-sm mt-1">{{ adminCodeError }}</p>
          </div>
        </div>
      </div>

      <!-- 학교 ID 입력 모달 -->
      <div v-if="showSchoolIdModal" class="modal-overlay">
        <div class="modal-content">
          <h3 class="font-bold text-xl text-center mb-3">학교 고유 ID {{ schoolIdMode==='create' ? '생성' : '입력' }}</h3>
          <p class="text-sm text-gray-600 mb-3">
            {{ schoolIdMode === 'create' ? '관리자 코드 인증이 완료되었습니다. 새 학교 ID를 생성하세요.' : '관리자에게 받은 ID를 입력하세요.' }}
          </p>
          <input type="text" v-model="newSchoolId" placeholder="학교 ID 입력" class="border rounded w-full p-2 mb-3">
          <button @click="handleSchoolIdSubmit"
            class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">저장</button>
          <p v-if="schoolIdError" class="text-red-500 text-sm mt-1">{{ schoolIdError }}</p>
        </div>
      </div>

      <!-- 로그인 후 (대시보드 축약 표시) -->
      <div v-if="role && isLoggedIn && !isLoading" class="mt-20 text-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">환영합니다 🎉</h2>
        <p>현재 역할: <strong>{{ role }}</strong></p>
        <p v-if="schoolId" class="text-gray-500 mt-1">학교 ID: {{ schoolId }}</p>
      </div>
    </main>
  </div>

  <!-- ===================== Vue3 + Firebase Auth ===================== -->
  <script type="module">
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD_KHsc9Izjj38b44-2GcH1YDKoQ9Sek1k",
      authDomain: "min-achievement-app-184d2.firebaseapp.com",
      projectId: "min-achievement-app-184d2",
      storageBucket: "min-achievement-app-184d2.appspot.com",
      messagingSenderId: "177231838739",
      appId: "1:177231838739:web:7e2f2b2cf20d8e4e2949e6",
      measurementId: "G-4GT4CZRPXB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    createApp({
      data() {
        return {
          user: null,
          isLoggedIn: false,
          isLoading: true,
          role: null,
          schoolId: null,
          showAdminCodeInput: false,
          adminCode: '',
          adminCodeError: '',
          showSchoolIdModal: false,
          schoolIdMode: 'join',
          newSchoolId: '',
          schoolIdError: '',
        };
      },
      methods: {
        /** 초기화 */
        initApp() {
          onAuthStateChanged(auth, async (user) => {
            this.isLoading = true;
            if (user) {
              this.user = user;
              this.isLoggedIn = true;
              await this.loadUserRoleAndSchoolId();
              if (this.role && !this.schoolId) {
                this.schoolIdMode = (this.role === '관리자') ? 'create' : 'join';
                this.showSchoolIdModal = true;
              }
            } else {
              this.user = null;
              this.isLoggedIn = false;
              this.role = null;
              this.schoolId = null;
            }
            this.isLoading = false;
          });
        },

        /** 로그인 */
        async login() {
          const provider = new GoogleAuthProvider();
          try {
            const result = await signInWithPopup(auth, provider);
            this.user = result.user;
            this.isLoggedIn = true;
            await this.loadUserRoleAndSchoolId();
          } catch (e) {
            console.error("로그인 실패:", e);
            alert("Google 로그인 실패: " + e.message);
          }
        },

        async logout() {
          await signOut(auth);
          this.user = null;
          this.isLoggedIn = false;
          this.role = null;
          this.schoolId = null;
        },

        async selectRole(role) {
          if (role === '관리자') {
            this.showAdminCodeInput = true;
          } else {
            this.role = role;
            await this.saveUserRoleAndSchoolId(role);
            if (!this.schoolId) this.showSchoolIdModal = true;
          }
        },

        async submitAdminCode() {
          if (this.adminCode === '0822') {
            this.role = '관리자';
            this.showAdminCodeInput = false;
            this.adminCodeError = '';
            await this.saveUserRoleAndSchoolId('관리자');
            this.schoolIdMode = 'create';
            this.showSchoolIdModal = true;
          } else {
            this.adminCodeError = '코드가 올바르지 않습니다.';
          }
        },

        async handleSchoolIdSubmit() {
          const id = this.newSchoolId.trim();
          if (!id) {
            this.schoolIdError = "학교 ID를 입력해주세요.";
            return;
          }
          this.schoolId = id;
          await this.saveUserRoleAndSchoolId(this.role);
          this.showSchoolIdModal = false;
        },

        async saveUserRoleAndSchoolId(roleToSave) {
          if (!this.user) return;
          const ref = doc(db, "userData", this.user.uid);
          await setDoc(ref, { role: roleToSave, schoolId: this.schoolId || null }, { merge: true });
        },

        async loadUserRoleAndSchoolId() {
          if (!this.user) return;
          const ref = doc(db, "userData", this.user.uid);
          const snap = await getDoc(ref);
          if (snap.exists()) {
            const data = snap.data();
            this.role = data.role || null;
            this.schoolId = data.schoolId || null;
          }
        },
      },
      mounted() {
        this.initApp();
      },
    }).mount("#app");
  </script>
</body>
</html>
