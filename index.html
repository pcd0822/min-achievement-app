<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>최소 성취수준 보장지도 관리 웹 앱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Inter', 'Pretendard', sans-serif; }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 500px;
        }
        .modal-preview {
             width: 800px;
             max-width: 95%;
        }

        [v-cloak] { display: none; }

        .table-cell-content {
            padding: 0.5rem 0;
            min-height: 2.5rem; /* Ensures consistent row height */
            display: flex;
            align-items: center;
        }

        .table-cell-content:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }

        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 30;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #4a5568;
            transition: all 0.2s ease-in-out;
        }
        .scroll-arrow:hover {
            background-color: rgba(255, 255, 255, 0.9);
            transform: translateY(-50%) scale(1.1);
        }
        .scroll-arrow.left { left: -1.25rem; }
        .scroll-arrow.right { right: -1.25rem; }


        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                border: 0;
            }
            @page {
                size: A4;
                margin: 20mm;
            }
            .page-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" v-cloak class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"/>
                        </svg>
                        <h1 class="ml-2 text-2xl font-bold text-gray-800">최소 성취수준 보장지도 관리</h1>
                    </div>
                     <!-- Login/Logout UI -->
                    <div v-if="isLoggedIn" class="flex items-center space-x-4">
                         <span class="text-gray-600 text-sm"> {{ user?.email }}</span>
                         <span v-if="role" class="text-gray-600 font-semibold">[{{ role }}] 모드</span>
                         <button @click="logout" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition text-sm">로그아웃</button>
                         <button v-if="role" @click="resetRole" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition text-sm">역할 재선택</button>
                    </div>
                     <div v-else>
                         <button @click="login" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">Google 로그인</button>
                     </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Loading Indicator -->
             <div v-if="isLoading" class="text-center mt-10">
                 <p class="text-gray-600">데이터 로딩 중...</p>
             </div>

             <!-- Login Button -->
             <div v-if="!isLoggedIn && !isLoading" class="text-center mt-10">
                 <button @click="login" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition text-lg shadow-md">
                     Google 계정으로 로그인
                 </button>
                  <p class="mt-4 text-gray-600">로그인 후 서비스를 이용해주세요.</p>
             </div>


            <!-- Role Selection Modal (Show if logged in but no role) -->
            <div v-if="isLoggedIn && !role && !isLoading" class="modal-overlay">
                <div class="modal-content">
                    <h3 class="text-2xl font-bold mb-6 text-center">역할 선택</h3>
                    <div class="space-y-4">
                        <button @click="selectRole('교과교사')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">교과교사</button>
                        <button @click="selectRole('담임교사')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">담임교사</button>
                        <div>
                            <button @click="selectRole('관리자')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">관리자</button>
                            <div v-if="showAdminCodeInput" class="mt-2">
                                <input type="password" v-model="adminCode" @keyup.enter="submitAdminCode" placeholder="관리자 코드 입력 (0822)" class="w-full p-2 border rounded-md">
                                <button @click="submitAdminCode" class="w-full mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">확인</button>
                                <p v-if="adminCodeError" class="text-red-500 text-sm mt-1">{{ adminCodeError }}</p>
                            </div>
                        </div>
                    </div>
                    <p v-if="statusMessage" class="mt-4 text-center text-sm text-blue-600">{{ statusMessage }}</p>
                </div>
            </div>

             <!-- Main Dashboard (Show only if logged in and role is selected) -->
             <div v-if="isLoggedIn && role && !isLoading">
                <!-- Admin View -->
                <div v-if="role === '관리자'">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">관리자 대시보드</h2>
                     <div class="space-y-8">
                         <!-- 1. 교육과정 편제표 업로드 -->
                         <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="text-xl font-semibold mb-4">1. 교육과정 편제표 업로드</h3>
                             <div class="flex space-x-4">
                                 <button @click="downloadTemplate('curriculum')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>
                                 <input type="file" @change="uploadFile($event, 'curriculum')" class="hidden" id="curriculum-upload-admin">
                                 <label for="curriculum-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</label>
                             </div>
                             <p v-if="uploadStatus.curriculum" class="mt-2 text-sm font-medium">{{ uploadStatus.curriculum }}</p>
                         </div>

                         <!-- 2. 학적 정보 업로드 -->
                         <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="text-xl font-semibold mb-4">2. 학적 정보 업로드</h3>
                             <div class="flex space-x-4">
                                 <button @click="downloadTemplate('student')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>
                                 <input type="file" @change="uploadFile($event, 'student')" class="hidden" id="student-upload-admin">
                                 <label for="student-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</label>
                             </div>
                              <p v-if="uploadStatus.student" class="mt-2 text-sm font-medium">{{ uploadStatus.student }}</p>
                         </div>

                          <!-- 2-1. 정서지원프로그램 이수시간 업로드 -->
                         <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="text-xl font-semibold mb-4">2-1. 정서지원프로그램 이수시간 업로드</h3>
                             <div class="flex space-x-4">
                                 <button @click="downloadTemplate('emotionalSupport')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>
                                 <input type="file" @change="uploadFile($event, 'emotionalSupport')" class="hidden" id="emotional-support-upload-admin">
                                 <label for="emotional-support-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</label>
                             </div>
                             <p v-if="uploadStatus.emotionalSupport" class="mt-2 text-sm font-medium">{{ uploadStatus.emotionalSupport }}</p>
                         </div>

                         <!-- 3. 운영 모듈 설계 -->
                         <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="text-xl font-semibold mb-4">3. 운영 모듈 설계</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700">학점당 시수</label>
                                     <input type="number" v-model.number="moduleConfig.hoursPerCredit" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                 </div>
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700">예방지도 연계 비율 (%)</label>
                                     <input type="number" v-model.number="moduleConfig.preventiveRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                 </div>
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700">정서지원 프로그램 연계 비율 (%)</label>
                                     <input type="number" v-model.number="moduleConfig.emotionalSupportRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                 </div>
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700">학습지원대상자 예방지도 인정비율 (%)</label>
                                     <input type="number" v-model.number="moduleConfig.specialPreventiveRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                 </div>
                             </div>
                             <h4 class="text-lg font-semibold mt-6 mb-2">항목별 인정시수 (1회 기준)</h4>
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                 <div v-for="(item, index) in moduleConfig.recognizedHours" :key="index">
                                     <label class="block text-sm font-medium text-gray-700">{{ item.name }}</label>
                                     <input type="number" step="0.1" v-model.number="item.hours" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                 </div>
                             </div>
                             <button @click="saveModuleConfig" class="mt-6 px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">운영 모듈 저장</button> <!-- Restored Save button -->
                              <p v-if="moduleConfigStatus" class="mt-2 text-sm font-medium text-green-600">{{ moduleConfigStatus }}</p>
                         </div>

                         <!-- 4. 대상자 선정 -->
                         <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="text-xl font-semibold mb-4">4. 대상자 선정</h3>
                             <div class="flex space-x-4">
                                 <input type="file" @change="processGradeFiles" multiple class="hidden" id="grade-upload">
                                 <label for="grade-upload" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">성적 파일 업로드 (복수 선택 가능)</label>
                                 <button @click="showAttendanceModal = true" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition">출석률 미도달 학생 입력</button>
                             </div>
                             <p v-if="fileProcessingError" class="mt-2 text-sm font-medium text-red-500">{{ fileProcessingError }}</p>

                             <div v-if="underachievers.length > 0" class="mt-6">
                                <h4 class="text-lg font-semibold mb-2">학업성취율/출석률 미도달 학생 현황 (처리 결과)</h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full" id="underachievers-table">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">학번</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이름</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">특기사항</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">미도달내역</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">미도달 과목(학점수)</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">보충지도(추가학습) 내역</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">조치</th>
                                            </tr>
                                        </thead>
                                        <tbody v-for="student in groupedUnderachievers" :key="student.id" class="bg-white">
                                            <tr v-for="(detail, detailIndex) in student.details" :key="student.id + detail.reason + detailIndex"> <!-- Adjusted key -->
                                                <td v-if="detailIndex === 0" :rowspan="student.details.length" class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ student.id }}</td>
                                                <td v-if="detailIndex === 0" :rowspan="student.details.length" class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ student.name }}</td>
                                                <td v-if="detailIndex === 0" :rowspan="student.details.length" class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ student.specialNotes }}</td>
                                                <td class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ detail.reason }}</td>
                                                <td class="px-6 py-4 whitespace-normal align-top border-b border-gray-200">{{ detail.subjects }}</td>
                                                <td class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ detail.lessonDetails }}</td>
                                                <td class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200 text-sm font-medium">
                                                    <button @click="deleteDetailGroup(detail)" class="text-red-600 hover:text-red-900">삭제</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-6 flex justify-end items-center space-x-4">
                                    <div class="relative">
                                        <button @click="toggleExportOptions" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">내보내기</button>
                                        <div v-if="showExportOptions" class="absolute right-0 bottom-full mb-2 w-48 bg-white rounded-md shadow-lg z-20">
                                            <a href="#" @click.prevent="exportTable('pdf')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">PDF로 저장</a>
                                            <a href="#" @click.prevent="exportTable('xlsx')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">XLSX 파일</a>
                                            <a href="#" @click.prevent="exportTable('csv')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CSV (Google Sheets용)</a>
                                        </div>
                                    </div>
                                    <button @click="deployUnderachievers" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">명단 확정 및 배포</button> <!-- Restored Deploy button -->
                                </div>
                                <p v-if="underachieversStatus" class="mt-2 text-right text-sm font-medium text-green-600">{{ underachieversStatus }}</p>
                             </div>
                         </div>

                         <!-- 5. 가정통신문 및 서약서 양식 관리 -->
                         <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="text-xl font-semibold mb-4">5. 가정통신문 및 서약서 양식 관리</h3>
                             <div class="flex border-b">
                                 <button class="tab-button" :class="{ 'active': adminFormTab === 'newsletter' }" @click="adminFormTab = 'newsletter'">가정통신문</button>
                                 <button class="tab-button" :class="{ 'active': adminFormTab === 'pledge' }" @click="adminFormTab = 'pledge'">서약서</button>
                             </div>

                             <!-- 가정통신문 폼 -->
                             <div v-if="adminFormTab === 'newsletter'" class="mt-6 space-y-4">
                                 <input type="text" v-model="newsletterForm.title" placeholder="제목" class="w-full p-2 border rounded">
                                 <input type="text" v-model="newsletterForm.docNumber" placeholder="문서 번호 (예: 한국고 2025-00호)" class="w-full p-2 border rounded">
                                 <input type="text" v-model="newsletterForm.department" placeholder="담당 부서 및 연락처" class="w-full p-2 border rounded">
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700">학교 로고 이미지</label>
                                     <input type="file" @change="handleImageUpload($event, 'newsletter', 'logoUrl')" accept="image/*" class="w-full">
                                      <img v-if="newsletterForm.logoUrl" :src="newsletterForm.logoUrl" alt="로고 미리보기" class="mt-2 h-16 object-contain">
                                 </div>
                                 <textarea v-model="newsletterForm.body" placeholder="본문 내용" rows="10" class="w-full p-2 border rounded"></textarea>
                                 <input type="text" v-model="newsletterForm.dispatchDate" placeholder="발송일 (예: 2025.7.14.)" class="w-full p-2 border rounded">
                                 <div class="flex items-center space-x-2">
                                     <input type="checkbox" v-model="newsletterForm.includeSeal" id="newsletterSealCheck">
                                     <label for="newsletterSealCheck">학교장 날인 포함</label>
                                 </div>
                                 <div v-if="newsletterForm.includeSeal">
                                     <label class="block text-sm font-medium text-gray-700">학교장 날인 이미지</label>
                                     <input type="file" @change="handleImageUpload($event, 'newsletter', 'sealUrl')" accept="image/*" class="w-full">
                                      <img v-if="newsletterForm.sealUrl" :src="newsletterForm.sealUrl" alt="날인 미리보기" class="mt-2 h-16 object-contain">
                                 </div>
                                 <div class="flex space-x-2">
                                     <button @click="previewForm('newsletter', underachievers)" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">미리보기 및 출력</button>
                                      <button @click="saveFormTemplates" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">양식 저장</button> <!-- Restored Save button -->
                                 </div>
                             </div>

                             <!-- 서약서 폼 -->
                              <div v-if="adminFormTab === 'pledge'" class="mt-6 space-y-4">
                                  <textarea v-model="pledgeForm.content" placeholder="서약서 동의 내용" rows="10" class="w-full p-2 border rounded"></textarea>
                                  <input type="text" v-model="pledgeForm.dispatchDate" placeholder="서약일 (예: 2025.7.14.)" class="w-full p-2 border rounded">
                                   <div class="flex items-center space-x-2">
                                       <input type="checkbox" v-model="pledgeForm.includeSeal" id="pledgeSealCheck">
                                       <label for="pledgeSealCheck">학교장 날인 포함</label>
                                   </div>
                                  <div v-if="pledgeForm.includeSeal">
                                      <label class="block text-sm font-medium text-gray-700">학교장 날인 이미지</label>
                                      <input type="file" @change="handleImageUpload($event, 'pledge', 'sealUrl')" accept="image/*" class="w-full">
                                      <img v-if="pledgeForm.sealUrl" :src="pledgeForm.sealUrl" alt="날인 미리보기" class="mt-2 h-16 object-contain">
                                  </div>
                                  <div class="flex space-x-2">
                                     <button @click="previewForm('pledge', underachievers)" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">미리보기 및 출력</button>
                                      <button @click="saveFormTemplates" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">양식 저장</button> <!-- Restored Save button -->
                                  </div>
                              </div>
                         </div>
                     </div>
                </div>

                <!-- Teacher View -->
                 <div v-if="role === '교과교사'">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">교과교사 대시보드</h2>
                    <div class="flex border-b mb-6">
                        <button class="tab-button" :class="{ 'active': teacherTab === 'plan' }" @click="switchTeacherTab('plan')">계획서 작성</button>
                        <button class="tab-button" :class="{ 'active': teacherTab === 'preventive' }" @click="switchTeacherTab('preventive')">예방지도 출석부 & 수업일지</button>
                        <button class="tab-button" :class="{ 'active': teacherTab === 'supplementary' }" @click="switchTeacherTab('supplementary')">보충지도(추가학습) 출석부&수업일지</button>
                    </div>

                    <!-- 계획서 작성 탭 -->
                    <div v-if="teacherTab === 'plan'" class="space-y-6">
                        <!-- Removed local module config and upload sections for Teacher -->
                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <div>
                                <label for="aiProvider" class="block text-sm font-medium text-gray-700">AI 모델 선택</label>
                                <select id="aiProvider" v-model="teacherPlan.aiProvider" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                    <option value="gemini">Gemini</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="claude">Claude</option>
                                </select>
                            </div>
                             <!-- Removed OpenAI API Key input -->
                            <div v-if="teacherPlan.aiProvider !== 'openai'">
                                <label for="apiKey" class="block text-sm font-medium text-gray-700">{{ teacherPlan.aiProvider.toUpperCase() }} API Key</label>
                                <input type="password" id="apiKey" v-model="teacherPlan.apiKey" placeholder="선택한 AI 모델의 API 키를 입력하세요" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="subjectName" class="block text-sm font-medium text-gray-700">과목명</label>
                                <input type="text" id="subjectName" v-model="teacherPlan.subjectName" @change="handleSubjectChange" placeholder="편제표에 등록된 과목명을 정확히 입력하세요" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"> <!-- Added @change handler -->
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">교과교사명</label>
                                <div v-for="(name, index) in teacherPlan.teacherNames" :key="index" class="flex items-center space-x-2 mt-2">
                                    <input type="text" v-model="teacherPlan.teacherNames[index]" placeholder="교과교사 이름을 입력하세요" class="w-full p-2 border border-gray-300 rounded-md">
                                    <button @click="removeTeacher(index)" v-if="teacherPlan.teacherNames.length > 1" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600">&times;</button>
                                </div>
                                <button @click="addTeacher" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 교과교사 추가</button>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <h3 class="text-lg font-semibold">성취기준 및 최소 성취수준 진술문</h3>
                            <div v-for="(achievement, index) in teacherPlan.achievements" :key="index" class="p-4 border rounded-md space-y-2">
                                <label class="block text-sm font-medium text-gray-700">성취기준 {{ index + 1 }}</label>
                                <textarea v-model="achievement.text" class="w-full p-2 border border-gray-300 rounded-md" rows="2"></textarea>
                                <div class="flex items-center justify-between">
                                    <button @click="generateStatement(index)" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 disabled:bg-gray-400" :disabled="(teacherPlan.aiProvider !== 'openai' && !teacherPlan.apiKey) || achievement.loading">
                                        <span v-if="!achievement.loading">최소 성취수준 진술문 생성</span>
                                        <span v-else>생성 중...</span>
                                    </button>
                                    <button @click="removeAchievement(index)" class="px-3 py-1.5 bg-red-500 text-white text-sm rounded-md hover:bg-red-600">&times; 삭제</button>
                                </div>
                                <div v-if="achievement.statement" class="mt-2 p-2 bg-gray-100 rounded-md">
                                    <p class="text-sm font-semibold">최소 성취수준 진술문:</p>
                                    <p class="text-sm text-gray-800">{{ achievement.statement }}</p>
                                </div>
                            </div>
                            <button @click="addAchievement" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 성취기준 추가</button>
                            <p v-if="teacherPlanError" class="text-red-500 text-sm mt-2">{{ teacherPlanError }}</p>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <h3 class="text-lg font-semibold">학기말 성적 산출 방법</h3>
                            <div class="flex space-x-4">
                                <label><input type="radio" v-model="teacherPlan.gradeCalculation" value="추정분할점수"> 추정분할점수</label>
                                <label><input type="radio" v-model="teacherPlan.gradeCalculation" value="고정분할점수"> 고정분할점수</label>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <h3 class="text-lg font-semibold">최소 성취수준 미도달 예방 지도 계획</h3>
                            <div class="flex space-x-4">
                                <label><input type="radio" v-model="teacherPlan.conductPrevention" value="O"> 진행함</label>
                                <label><input type="radio" v-model="teacherPlan.conductPrevention" value="X"> 진행하지 않음</label>
                            </div>
                            <div v-if="teacherPlan.conductPrevention === 'O'" class="space-y-4 pt-4 border-t">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">예방지도 대상자 선정기준</label>
                                    <textarea v-model="teacherPlan.preventionTarget" rows="3" class="mt-1 block w-full p-2 border rounded-md"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">예방지도 방법 (복수선택 가능)</label>
                                    <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                                        <label v-for="method in moduleConfig.recognizedHours" :key="method.name" class="flex items-center space-x-2">
                                            <input type="checkbox" :value="method.name" v-model="teacherPlan.preventionMethods">
                                            <span>{{ method.name }}</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">예방지도 운영 기간</label>
                                    <input type="text" class="flatpickr-range mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">차시별 지도 계획</label>
                                    <div v-for="(session, index) in teacherPlan.preventionSessions" :key="index" class="flex items-center space-x-2 mt-2">
                                        <span class="font-semibold">{{ index + 1 }}차시:</span>
                                        <input type="text" v-model="session.plan" class="w-full p-2 border rounded-md" placeholder="지도 계획을 입력하세요">
                                        <button @click="removePreventionSession(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">&times;</button>
                                    </div>
                                    <button @click="addPreventionSession" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 차시 추가</button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <h3 class="text-lg font-semibold">보충 지도 및 추가 학습 운영 계획</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">보충지도/추가학습 방법 (복수선택 가능)</label>
                                <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                                    <label v-for="method in moduleConfig.recognizedHours" :key="method.name" class="flex items-center space-x-2">
                                        <input type="checkbox" :value="method.name" v-model="teacherPlan.supplementaryMethods">
                                        <span>{{ method.name }}</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">보충지도/추가학습 운영 기간</label>
                                <input type="text" class="flatpickr-range mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">차시별 지도 계획 (최대 {{ teacherPlan.maxSupplementaryHours }}차시)</label>
                                <div v-for="(session, index) in teacherPlan.supplementarySessions" :key="index" class="flex items-center space-x-2 mt-2">
                                    <span class="font-semibold">{{ index + 1 }}차시:</span>
                                    <input type="text" v-model="session.plan" class="w-full p-2 border rounded-md" placeholder="지도 계획을 입력하세요">
                                    <button @click="removeSupplementarySession(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">&times;</button>
                                </div>
                                <button @click="addSupplementarySession" :disabled="teacherPlan.supplementarySessions.length >= teacherPlan.maxSupplementaryHours" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:bg-gray-400">+ 차시 추가</button>
                            </div>
                        </div>

                        <div class="text-center">
                             <button @click="saveTeacherPlan" class="mt-6 px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">계획안 저장</button> <!-- Save Plan Button -->
                            <button @click="generatePlanPreview" class="mt-6 ml-4 px-8 py-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition text-lg">계획안 미리보기</button>
                            <p v-if="teacherPlanStatus" class="mt-2 text-sm text-green-600">{{ teacherPlanStatus }}</p> <!-- Status Message -->
                        </div>
                    </div>

                    <!-- 지도 출석부 & 수업일지 -->
                    <div v-if="currentGuidanceData && teacherTab !== 'plan'" class="space-y-8"> <!-- Added check for teacherTab -->
                        <div class="bg-white p-6 rounded-lg shadow-md flex justify-between items-start">
                            <h3 class="text-xl font-semibold">{{ teacherTab === 'preventive' ? '예방지도' : '보충지도(추가학습)' }} 출석부 & 수업일지</h3>
                            <div class="text-right">
                                <p><strong>과목명:</strong> {{ teacherPlan.subjectName || '미입력' }}</p>
                                <p><strong>교과교사:</strong> {{ formattedTeacherNames }}</p>
                                <div class="mt-2 flex space-x-2">
                                    <button @click="generateCompletionStatusPdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">이수현황표 PDF</button>
                                    <button @click="generateAttendancePdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">출석부 PDF</button>
                                    <button @click="generateLessonLogPdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">수업일지 PDF</button>
                                </div>
                            </div>
                        </div>

                        <!-- 이수현황표 -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-lg font-semibold mb-4">{{ teacherTab === 'preventive' ? '예방지도' : '보충지도(추가학습)' }} 이수현황표</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm text-center">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-2 border">학생</th>
                                            <th v-if="teacherTab === 'supplementary'" class="p-2 border">특기사항</th>
                                            <th v-if="teacherTab === 'supplementary'" class="p-2 border">미도달 항목</th>
                                            <th v-if="teacherTab === 'supplementary'" class="p-2 border">예방지도</th>
                                            <th v-if="teacherTab === 'supplementary'" class="p-2 border">정서지원프로그램</th>
                                            <th v-for="rh in moduleConfig.recognizedHours" :key="rh.name" class="p-2 border">{{ rh.name }}</th>
                                            <th class="p-2 border bg-gray-100">총계</th>
                                            <th v-if="teacherTab === 'supplementary'" class="p-2 border bg-gray-100">이수여부</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="student in currentGuidanceData.students" :key="student.id">
                                            <td class="p-2 border font-semibold whitespace-nowrap">{{ student.name }} ({{ student.id }})</td>
                                            <td v-if="teacherTab === 'supplementary'" class="p-2 border">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].specialNotes : '일반학생' }}
                                            </td>
                                            <td v-if="teacherTab === 'supplementary'" class="p-2 border">{{ student.reason }}</td>
                                            <td v-if="teacherTab === 'supplementary'" class="p-2 border">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].preventiveHours : 0 }}
                                            </td>
                                            <td v-if="teacherTab === 'supplementary'" class="p-2 border">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].emotionalSupportHours : 0 }}
                                            </td>
                                            <td v-for="rh in moduleConfig.recognizedHours" :key="rh.name" class="p-2 border">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id][rh.name] : 0 }}
                                            </td>
                                            <td class="p-2 border bg-gray-100 font-bold">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].total : 0 }}
                                            </td>
                                            <td v-if="teacherTab === 'supplementary'"
                                                class="p-2 border font-bold"
                                                :class="{
                                                    'text-green-600': guidanceCompletionStatus[student.id] && guidanceCompletionStatus[student.id].completionStatus === '이수',
                                                    'text-red-600': guidanceCompletionStatus[student.id] && guidanceCompletionStatus[student.id].completionStatus === '미이수'
                                                }">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].completionStatus : '' }}
                                            </td>
                                        </tr>
                                         <tr v-if="currentGuidanceData.students.length === 0">
                                            <td :colspan="moduleConfig.recognizedHours.length + (teacherTab === 'supplementary' ? 7 : 2)" class="text-center p-4 text-gray-500">학생이 없습니다.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 출석부 -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-lg font-semibold mb-4">출석부</h4>
                            <div v-if="teacherTab === 'preventive'">
                                <div class="flex space-x-2 mb-4">
                                    <input type="text" v-model="newGuidanceStudentId" @keyup.enter="addGuidanceStudent(teacherTab)" placeholder="학번 입력 후 Enter" class="p-2 border rounded-md w-48">
                                    <button @click="addGuidanceStudent(teacherTab)" class="px-4 py-2 bg-blue-500 text-white rounded-md">학생 추가</button>
                                </div>
                                <p v-if="currentGuidanceData.error" class="text-red-500 text-sm mb-4 -mt-2">{{ currentGuidanceData.error }}</p>
                            </div>
                            <div v-else class="mb-4">
                                 <!-- Re-enabled Import Button -->
                                 <div class="flex space-x-2">
                                     <button @click="showImportModal = true" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition">대상자 가져오기</button>
                                     <button @click="resetSupplementaryStudents" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">대상자 초기화</button>
                                 </div>
                                 <p class="mt-2 text-sm text-gray-600">관리자가 배포한 미도달 학생 명단에서 과목, 학급별로 대상자를 검색하여 가져옵니다.</p>
                            </div>

                            <div class="relative">
                                <button @click="scrollAttendance('left', $event)" class="scroll-arrow left">‹</button>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm border-collapse">
                                        <thead>
                                            <tr class="text-center">
                                                <th class="sticky left-0 bg-gray-100 z-20 p-2 border-y border-l border-r border-gray-300 w-[80px]">학번</th>
                                                <th class="sticky left-[50px] bg-gray-100 z-20 p-2 border-y border-r border-gray-300 w-[96px] whitespace-nowrap">이름</th>
                                                <th v-for="(session, index) in currentGuidanceData.sessions" :key="index" class="p-2 border border-gray-300 min-w-[150px]">
                                                    <div class="flex items-center justify-center space-x-2 mb-2">
                                                        <p class="font-bold">{{ index + 1 }}차시</p>
                                                        <button v-if="session.isSaved" @click="toggleSaveSession(session)" title="수정" class="p-1 hover:bg-gray-200 rounded">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                                        </button>
                                                    </div>
                                                    <input type="text" class="flatpickr-single w-full p-1 border rounded text-center text-xs mb-1" placeholder="날짜 선택" :value="session.date" @change="session.date = $event.target.value; saveGuidanceData()" :disabled="session.isSaved"> <!-- Added save on change -->
                                                    <input type="text" class="w-full p-1 border rounded text-center text-xs" placeholder="예: 16:00~17:00" v-model="session.time" @change="saveGuidanceData" :disabled="session.isSaved"> <!-- Added save on change -->
                                                    <button v-if="!session.isSaved" @click="toggleSaveSession(session)" :disabled="!isSessionReadyToSave(session)" class="w-full mt-1 px-2 py-1 text-xs rounded text-white bg-green-500 hover:bg-green-600 disabled:bg-gray-400">저장</button>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="student in currentGuidanceData.students" :key="student.id" class="text-center">
                                                <td class="sticky left-0 bg-white z-20 p-2 border-l border-r border-b border-gray-300">{{ student.id }}</td>
                                                <td class="sticky left-[50px] bg-white z-20 p-2 border-r border-b border-gray-300 font-semibold whitespace-nowrap">{{ student.name }}</td>
                                                <td v-for="(session, index) in currentGuidanceData.sessions" :key="index" class="p-2 border border-gray-300">
                                                    <select class="w-full p-1 border rounded text-xs" v-model="session.attendance[student.id]" :disabled="session.isSaved" @change="saveGuidanceData"> <!-- Added @change to save -->
                                                        <option value="">선택</option> <!-- Allow unselecting -->
                                                        <option v-for="rh in moduleConfig.recognizedHours" :key="rh.name" :value="rh.name">{{ rh.name }}</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr v-if="currentGuidanceData.students.length === 0">
                                                <td :colspan="(currentGuidanceData.sessions?.length || 0) + 2" class="text-center p-4 border border-gray-300 text-gray-500">학생을 추가해주세요.</td> <!-- Safe navigation for sessions length -->
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <button @click="scrollAttendance('right', $event)" class="scroll-arrow right">›</button>
                            </div>
                            <button @click="addGuidanceSession(teacherTab)" class="mt-4 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm">+ 차시 추가</button>
                        </div>

                        <!-- 수업일지 -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-lg font-semibold mb-4">수업일지</h4>
                            <div class="mb-6 p-4 border rounded-md bg-gray-50 grid grid-cols-2 gap-4 text-sm">
                                <div><strong>과목명:</strong> {{ teacherPlan.subjectName || '미입력' }}</div>
                                <div><strong>운영차시:</strong> {{ savedGuidanceSessions.length }} 차시</div>
                                <div><strong>지도교사:</strong> {{ formattedTeacherNames }}</div>
                                <div><strong>운영기간:</strong> {{ guidanceOperationPeriod }}</div>
                            </div>
                            <div class="space-y-4">
                                <div v-for="(session, index) in savedGuidanceSessions" :key="session.date + index" class="p-4 border rounded-md">
                                    <p class="font-bold mb-2">{{ index + 1 }}차시 수업일지 ({{ session.date }} / {{ session.time }})</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <p><strong>수업방법:</strong> {{ [...new Set(Object.values(session.attendance || {}))].filter(Boolean).join(', ') }}</p> <!-- Safe navigation -->
                                        <div class="flex items-center">
                                            <label class="font-semibold mr-2 shrink-0">장소:</label>
                                            <input type="text" class="w-full p-1 border rounded" v-model="session.place" @change="saveGuidanceData"> <!-- Added @change -->
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label class="font-semibold text-sm">지도내용:</label>
                                        <textarea rows="3" class="w-full p-1 border rounded mt-1 text-sm" v-model="session.content" @change="saveGuidanceData"></textarea> <!-- Added @change -->
                                    </div>
                                </div>
                                <p v-if="savedGuidanceSessions.length === 0" class="text-center text-gray-500">저장된 수업일지가 없습니다.</p>
                            </div>
                        </div>
                    </div>
                     <!-- Message when teacher tab is not 'plan' but guidance data isn't ready -->
                     <div v-if="teacherTab !== 'plan' && !currentGuidanceData" class="text-center text-gray-500 mt-10">
                         <p>출석부 및 수업일지를 보려면 먼저 '계획서 작성' 탭에서 과목명을 입력하고 저장해주세요.</p>
                     </div>
                </div>

                 <!-- Homeroom Teacher View -->
                 <div v-if="role === '담임교사'" class="space-y-6">
                     <h2 class="text-3xl font-bold text-gray-800">담임교사 대시보드</h2>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="flex items-end space-x-2">
                             <div class="flex-grow">
                                 <label for="homeroom-class-input" class="block text-sm font-medium text-gray-700">학급 번호 입력</label>
                                 <input id="homeroom-class-input" type="text" v-model="homeroomClassInput" @keyup.enter="searchHomeroomClass" placeholder="예: 101" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                             </div>
                             <button @click="searchHomeroomClass" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">조회</button>
                         </div>
                         <p v-if="homeroomMessage" class="mt-2 text-sm text-gray-600">{{ homeroomMessage }}</p>
                     </div>

                     <div v-if="processedHomeroomStudents.length > 0" class="bg-white p-6 rounded-lg shadow-md">
                         <h3 class="text-xl font-semibold mb-4">{{ homeroomClassInput }}반 미도달 학생 현황</h3>
                         <p class="mb-4 text-sm text-yellow-700 bg-yellow-100 p-2 rounded-md">참고: '이수 현황'은 실시간 데이터가 아닐 수 있으며, 정확한 정보는 해당 과목 교과교사에게 문의하세요.</p>
                         <div class="overflow-x-auto">
                             <table class="min-w-full text-sm">
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th class="p-2 border">학번</th>
                                         <th class="p-2 border">이름</th>
                                         <th class="p-2 border">미도달 과목</th>
                                         <th class="p-2 border">미도달 내역</th>
                                         <th class="p-2 border">이수 현황 (참고용)</th>
                                         <th class="p-2 border">서류 출력</th>
                                     </tr>
                                 </thead>
                                 <tbody>
                                     <template v-for="(row, index) in processedHomeroomStudents" :key="row.id + row.subject + index">
                                         <tr>
                                             <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="p-2 border align-top text-center">{{ row.id }}</td>
                                             <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="p-2 border align-top text-center">{{ row.name }}</td>
                                             <td class="p-2 border">{{ row.subject }}</td>
                                             <td class="p-2 border text-center">{{ row.reason }}</td>
                                             <td class="p-2 border text-center font-bold" :class="row.statusColor">{{ row.status }}</td>
                                             <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="p-2 border align-top text-center">
                                                 <div class="flex flex-col space-y-2">
                                                     <button @click="printHomeroomStudentForm(row.originalStudent, 'newsletter')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded-md hover:bg-blue-600">가정통신문</button>
                                                     <button @click="printHomeroomStudentForm(row.originalStudent, 'pledge')" class="px-2 py-1 bg-green-500 text-white text-xs rounded-md hover:bg-green-600">서약서</button>
                                                 </div>
                                             </td>
                                         </tr>
                                     </template>
                                 </tbody>
                             </table>
                         </div>
                     </div>
                 </div>
             </div>
        </main>

        <!-- Modals -->
        <!-- Attendance Modal (Restored for Admin) -->
         <div v-if="showAttendanceModal" class="modal-overlay" @click.self="closeAttendanceModal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">출석률 미도달 학생 추가</h3>
                <form @submit.prevent="addAttendanceStudent">
                    <div class="space-y-4">
                        <input v-model="newAttendanceStudent.id" placeholder="학번" required class="w-full p-2 border rounded-md">

                        <div v-for="(subject, index) in newAttendanceStudent.subjects" :key="index" class="flex items-center space-x-2">
                             <input v-model="newAttendanceStudent.subjects[index]" placeholder="출석률 미도달 과목" required class="w-full p-2 border rounded-md">
                             <button type="button" v-if="newAttendanceStudent.subjects.length > 1" @click="removeAttendanceSubject(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">-</button>
                        </div>
                         <button type="button" @click="addAttendanceSubject" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+</button>
                    </div>
                    <p v-if="attendanceModalError" class="text-red-500 text-sm mt-2">{{ attendanceModalError }}</p>
                    <div class="mt-6 flex justify-end space-x-2">
                        <button type="button" @click="closeAttendanceModal" class="px-4 py-2 bg-gray-300 rounded-md">취소</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md">추가</button>
                    </div>
                </form>
            </div>
         </div>


        <!-- Preview Modal -->
        <div v-if="showPreviewModal" class="modal-overlay" @click.self="closePreviewModal">
            <div class="modal-content modal-preview overflow-auto max-h-screen">
                <div v-html="previewHtml"></div>
                <p v-if="teacherPlanError || adminActionStatus || moduleConfigStatus || underachieversStatus || teacherPlanStatus" class="text-sm mt-4 text-center font-semibold" :class="statusClass">{{ statusText }}</p> <!-- Combined status display -->
                <div class="mt-6 flex justify-end space-x-2">
                    <button @click="closePreviewModal" class="px-4 py-2 bg-gray-300 rounded-md">닫기</button>
                    <button @click="printPreview" class="px-4 py-2 bg-indigo-600 text-white rounded-md">pdf로 저장</button>
                </div>
            </div>
        </div>

         <!-- Import Modal (Restored for Teacher) -->
         <div v-if="showImportModal" class="modal-overlay" @click.self="closeImportModal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">보충지도 대상자 가져오기</h3>
                <form @submit.prevent="importUnderachievers">
                    <div class="space-y-4">
                        <input v-model="importSubject" placeholder="과목명 (현재 과목과 일치)" required class="w-full p-2 border rounded-md" :disabled="!teacherPlan.subjectName"> <!-- Disable if subject not set -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">학급</label>
                            <p class="text-xs text-gray-500 mb-2">한 칸에 하나의 학급만 입력해주세요. (예: 101)</p>
                            <div v-for="(classNum, index) in importClasses" :key="index" class="flex items-center space-x-2 mb-2">
                                <input v-model="importClasses[index]" placeholder="학급 입력" required class="w-full p-2 border rounded-md">
                                <button type="button" v-if="importClasses.length > 1" @click="removeImportClassInput(index)" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600">-</button>
                            </div>
                            <button type="button" @click="addImportClassInput" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 학급 추가</button>
                        </div>
                    </div>
                    <p v-if="importModalError" class="text-red-500 text-sm mt-2">{{ importModalError }}</p>
                    <div class="mt-6 flex justify-end space-x-2">
                        <button type="button" @click="closeImportModal" class="px-4 py-2 bg-gray-300 rounded-md">취소</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md" :disabled="!teacherPlan.subjectName">가져오기</button> <!-- Disable if subject not set -->
                    </div>
                </form>
            </div>
         </div>


        <!-- 인쇄용 컨테이너 (숨김) -->
        <div id="print-area-container" class="hidden"></div>

    </div>

    <script type="module">
        // Vue 3 CDN
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"; // Use a specific recent version
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js"; // Optional: Uncomment if needed

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD_KHsc9Izjj38b44-2GcH1YDKoQ9Sek1k",
            authDomain: "min-achievement-app-184d2.firebaseapp.com",
            projectId: "min-achievement-app-184d2",
            storageBucket: "min-achievement-app-184d2.appspot.com", // Corrected bucket URL
            messagingSenderId: "177231838739",
            appId: "1:177231838739:web:7e2f2b2cf20d8e4e2949e6",
            measurementId: "G-4GT4CZRPXB" // Optional
        };

        // --- Initialize Firebase ---
        let firebaseApp, auth, db; // Declare globally within module scope
        try {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
            // const analytics = getAnalytics(firebaseApp); // Optional
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            // Display error to user?
            alert("Firebase 초기화 중 오류가 발생했습니다. 페이지를 새로고침하거나 관리자에게 문의하세요.");
        }


        createApp({ // Create the app instance
            data() {
                return {
                    // --- Authentication State ---
                    user: null,
                    isLoggedIn: false,
                    isLoading: true, // Start in loading state

                    // --- Role Management State ---
                    role: null, // User's selected role, initially null
                    showAdminCodeInput: false,
                    adminCode: '',
                    adminCodeError: '',

                    // --- UI State ---
                    teacherTab: 'plan', // Default tab for teacher
                    adminFormTab: 'newsletter', // Default for Admin form view
                    uploadStatus: { curriculum: '', student: '', emotionalSupport: '' },
                    statusMessage: '', // General status messages for role selection/loading
                    moduleConfigStatus: '', // Status for saving module config
                    underachieversStatus: '', // Status for deploying underachievers
                    teacherPlanStatus: '', // Status for saving teacher plan
                    adminActionStatus: '', // Generic status for other admin actions

                    // --- Common Data (Loaded from Firestore) ---
                    moduleConfig: { // Default structure, will be overwritten by Firestore data
                        hoursPerCredit: 1,
                        preventiveRatio: 50,
                        emotionalSupportRatio: 20,
                        specialPreventiveRatio: 30,
                        recognizedHours: [
                            { name: '수업시간별도지도', hours: 1 }, { name: '온라인콘텐츠수강', hours: 1 },
                            { name: 'RunUP과정수강', hours: 1 }, { name: '학습멘토링', hours: 1 },
                            { name: '대면지도', hours: 1 }, { name: '보충과제부여', hours: 1 }
                        ]
                    },
                    newsletterForm: { // Defaults, will be overwritten
                        title: '최소 성취수준 보장지도 참여 안내', docNumber: '교무기획부-000', department: '담당부서 (연락처)',
                        logoUrl: null, body: '기본 안내 내용...', dispatchDate: 'YYYY.MM.DD.', includeSeal: false, sealUrl: null
                    },
                    pledgeForm: { // Defaults, will be overwritten
                        content: '기본 서약 내용...', dispatchDate: 'YYYY.MM.DD.', includeSeal: false, sealUrl: null
                    },
                    curriculumData: [], // Loaded from Firestore commonData
                    studentData: [], // Loaded from Firestore commonData
                    emotionalSupportData: [], // Loaded from Firestore commonData
                    deployedUnderachievers: [], // Underachievers list loaded from Firestore commonData

                    // --- Admin Specific Local State ---
                    underachievers: [], // Local list processed by admin before deploying
                    fileProcessingError: '',
                    showAttendanceModal: false,
                    newAttendanceStudent: { id: '', subjects: [''] },
                    attendanceModalError: '',
                    showExportOptions: false,

                    // --- Teacher Specific State ---
                    showImportModal: false,
                    importSubject: '',
                    importClasses: [''],
                    importModalError: '',
                    teacherPlan: { // Structure for teacher plan data (local before save)
                        aiProvider: 'gemini', apiKey: '', subjectName: '', teacherNames: [''],
                        achievements: [{ text: '', statement: '', loading: false }],
                        gradeCalculation: '추정분할점수', conductPrevention: 'X',
                        preventionTarget: '', preventionMethods: [], preventionPeriod: [],
                        preventionSessions: [{ plan: '' }, { plan: '' }, { plan: '' }],
                        supplementaryMethods: [], supplementaryPeriod: [],
                        supplementarySessions: [{ plan: '' }, { plan: '' }, { plan: '' }],
                        maxSupplementaryHours: 0,
                    },
                    teacherPlanError: '', // Error specific to AI generation
                    teacherGuidanceData: { // Structure for teacher guidance logs (loaded/saved to Firestore)
                        preventive: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })), error: ''},
                        supplementary: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })), error: ''}
                    },
                    newGuidanceStudentId: '',

                    // --- Homeroom Teacher State ---
                    homeroomClassInput: '',
                    searchedStudents: [], // Students filtered locally from deployedUnderachievers
                    homeroomMessage: '',

                    // --- Preview Modal State ---
                    showPreviewModal: false,
                    previewHtml: '',
                }
            },

            // --- Computed Properties ---
            computed: {
                 // Combined status message for preview modal
                 statusText() {
                     return this.teacherPlanError || this.adminActionStatus || this.moduleConfigStatus || this.underachieversStatus || this.teacherPlanStatus || '';
                 },
                 // Dynamic class for preview modal status
                 statusClass() {
                     const text = this.statusText;
                     if (text.includes('오류') || text.includes('실패')) {
                         return 'text-red-500';
                     } else if (text.includes('완료') || text.includes('성공') || text.includes('저장됨')) {
                         return 'text-green-600';
                     } else if (text.includes('중')) {
                         return 'text-blue-600';
                     }
                     return 'text-gray-600'; // Default or informational
                 },
                 formattedTeacherNames() {
                     // Safety check for teacherPlan
                     if (!this.teacherPlan || !this.teacherPlan.teacherNames) return '';
                    return this.teacherPlan.teacherNames
                        .map(name => name ? name.trim() : '') // Handle potential null/undefined names
                        .filter(name => name)
                        .map(name => `${name} (인)`)
                        .join(', ');
                },
                 groupedUnderachievers() { // For Admin view processing local underachievers list
                     if (this.role !== '관리자') return [];
                    const result = [];
                    // Use local 'underachievers' list for processing
                    this.underachievers.forEach(student => {
                         if (!student || !student.id) return; // Add null check
                        const studentInfo = this.studentData.find(s => String(s.학번) === student.id);
                        const specialNotes = (studentInfo && studentInfo.특기사항) ? studentInfo.특기사항 : '일반학생';

                        const studentEntry = { id: student.id, name: student.name, specialNotes: specialNotes, details: [] };
                        const subjectsByReason = new Map();
                        const allSubjects = new Map();

                        (student.gradeSubjects || []).forEach(subject => {
                             if (!subject || !subject.name) return; // Add null check
                            if (!allSubjects.has(subject.name)) {
                                allSubjects.set(subject.name, { grade: true, attendance: false, credits: subject.credits });
                            } else { allSubjects.get(subject.name).grade = true; }
                        });
                        (student.attendanceSubjects || []).forEach(subjectName => {
                             if (!subjectName) return; // Add null check
                            if (!allSubjects.has(subjectName)) {
                                const curriculumInfo = this.curriculumData.find(c => c.과목명 === subjectName);
                                const credits = curriculumInfo ? curriculumInfo.학점 : 'N/A';
                                allSubjects.set(subjectName, { grade: false, attendance: true, credits: credits });
                            } else { allSubjects.get(subjectName).attendance = true; }
                        });

                        allSubjects.forEach((details, subjectName) => {
                            let reason = '';
                            if (details.grade && details.attendance) reason = '학업성취율&과목출석률';
                            else if (details.grade) reason = '학업성취율';
                            else if (details.attendance) reason = '과목출석률';

                            if (!subjectsByReason.has(reason)) subjectsByReason.set(reason, []);
                            subjectsByReason.get(reason).push({ name: subjectName, ...details });
                        });

                        subjectsByReason.forEach((subjectsArray, reason) => {
                            const consolidatedSubjects = subjectsArray.map(s => `${s.name}(${s.credits}학점)`).join(', ');
                            const lessonType = subjectsArray.some(s => s.grade) ? '보충지도' : '추가학습';
                             // Ensure moduleConfig is available for calculation
                             const hoursText = this.moduleConfig.hoursPerCredit ? `*${this.moduleConfig.hoursPerCredit}시수` : '';
                             const lessonDetails = `${lessonType}(과목 학점수${hoursText})`;


                            studentEntry.details.push({
                                reason: reason, subjects: consolidatedSubjects, lessonDetails: lessonDetails,
                                originalSubjects: subjectsArray, id: student.id, name: student.name
                            });
                        });

                        if (studentEntry.details.length > 0) result.push(studentEntry);
                    });
                     result.sort((a, b) => a.id.localeCompare(b.id));
                    return result;
                },
                 currentGuidanceData() {
                     if (!this.role || this.role !== '교과교사') return null;
                     if (this.teacherTab === 'preventive' || this.teacherTab === 'supplementary') {
                         // Ensure the structure exists
                         if (!this.teacherGuidanceData[this.teacherTab]) {
                             this.teacherGuidanceData[this.teacherTab] = { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })), error: ''};
                         }
                        return this.teacherGuidanceData[this.teacherTab];
                    }
                    return null;
                },
                 guidanceCompletionStatus() {
                    const data = this.currentGuidanceData;
                     if (!this.role || !data) return {};

                     const preventiveTotals = {};
                    const preventiveData = this.teacherGuidanceData.preventive;
                     // Ensure sessions exist
                     if (preventiveData && preventiveData.sessions) {
                         preventiveData.sessions.forEach(session => {
                             if (session && session.isSaved && session.attendance) { // Add null checks
                                 for (const studentId in session.attendance) {
                                     const methodName = session.attendance[studentId];
                                     if (methodName) {
                                         const methodConfig = this.moduleConfig.recognizedHours.find(m => m.name === methodName);
                                         if (methodConfig) {
                                             if (!preventiveTotals[studentId]) preventiveTotals[studentId] = 0;
                                             preventiveTotals[studentId] += methodConfig.hours;
                                         }
                                     }
                                 }
                             }
                         });
                     }


                    const status = {};
                    let requiredHoursForCompletion = 0;
                    let maxEmotionalSupportHours = 0;
                    let supplementaryHours = 0;
                    let requiredSubjectCredits = 0;

                    if (this.teacherPlan.subjectName) {
                        const subjectInfo = this.curriculumData.find(s => s.과목명 === this.teacherPlan.subjectName);
                        if (subjectInfo) {
                            requiredSubjectCredits = Number(subjectInfo.학점) || 0;
                            supplementaryHours = requiredSubjectCredits * this.moduleConfig.hoursPerCredit;
                             requiredHoursForCompletion = Math.ceil((supplementaryHours * 2) / 3); // Use ceil for required hours
                            maxEmotionalSupportHours = supplementaryHours * (this.moduleConfig.emotionalSupportRatio / 100);
                        }
                    }

                     // Ensure data.students exists
                     if (data.students) {
                         data.students.forEach(student => {
                             if (!student || !student.id) return; // Skip if student or id is null/undefined
                             status[student.id] = { name: student.name };
                             const studentInfo = this.studentData.find(s => String(s['학번']) === student.id);
                             status[student.id].specialNotes = (studentInfo && studentInfo['특기사항']) ? studentInfo['특기사항'] : '일반학생';
                             this.moduleConfig.recognizedHours.forEach(rh => {
                                 status[student.id][rh.name] = 0;
                             });
                             status[student.id].total = 0;
                             if (this.teacherTab === 'supplementary') {
                                  status[student.id].preventiveHours = 0;
                                  status[student.id].emotionalSupportHours = 0;
                                  status[student.id].completionStatus = '미이수';
                             }
                         });

                         // Calculate hours from the CURRENT tab's saved sessions
                         if (data.sessions) {
                             data.sessions.forEach(session => {
                                 if (session && session.isSaved && session.attendance) { // Add null checks
                                     for (const studentId in session.attendance) {
                                         if (!status[studentId]) continue;
                                         const methodName = session.attendance[studentId];
                                         if (methodName) {
                                             const methodConfig = this.moduleConfig.recognizedHours.find(m => m.name === methodName);
                                             if (methodConfig) {
                                                 status[studentId][methodName] = parseFloat((status[studentId][methodName] + methodConfig.hours).toFixed(2));
                                                 if (this.teacherTab === 'preventive') {
                                                    status[studentId].total = parseFloat((status[studentId].total + methodConfig.hours).toFixed(2));
                                                 }
                                             }
                                         }
                                     }
                                 }
                             });
                         }


                         // --- Calculations specific to supplementary tab ---
                          if (this.teacherTab === 'supplementary' && requiredSubjectCredits > 0) {
                              data.students.forEach(student => {
                                   if (!student || !status[student.id]) return; // Add null checks

                                  let currentStudentTotal = 0;
                                  this.moduleConfig.recognizedHours.forEach(rh => {
                                     currentStudentTotal += (status[student.id][rh.name] || 0);
                                  });

                                 const totalPreventiveHoursForStudent = preventiveTotals[student.id] || 0;
                                  if (totalPreventiveHoursForStudent > 0) {
                                      const studentInfo = this.studentData.find(s => String(s['학번']) === student.id);
                                      const isSpecialSupport = studentInfo && studentInfo['특기사항'] === '학습지원대상';
                                     let maxAllowedHours = 0;
                                     let creditedPreventiveHours = 0;
                                      if (isSpecialSupport) {
                                          maxAllowedHours = supplementaryHours * (this.moduleConfig.specialPreventiveRatio / 100);
                                          creditedPreventiveHours = Math.min(totalPreventiveHoursForStudent, maxAllowedHours);
                                      } else {
                                         maxAllowedHours = supplementaryHours * (this.moduleConfig.preventiveRatio / 100);
                                         creditedPreventiveHours = Math.floor(Math.min(totalPreventiveHoursForStudent, maxAllowedHours));
                                     }
                                      status[student.id].preventiveHours = parseFloat(creditedPreventiveHours.toFixed(2));
                                      currentStudentTotal += creditedPreventiveHours;
                                  }

                                 const emotionalData = this.emotionalSupportData.find(e => String(e['학번']) === student.id);
                                 const uploadedHours = emotionalData ? Number(emotionalData['정서지원프로그램 참여시간']) : 0;
                                 const creditedEmotionalHours = Math.min(uploadedHours, maxEmotionalSupportHours);
                                  status[student.id].emotionalSupportHours = parseFloat(creditedEmotionalHours.toFixed(2));
                                  currentStudentTotal += creditedEmotionalHours;

                                 status[student.id].total = parseFloat(currentStudentTotal.toFixed(2));
                                  const tolerance = 0.001; // Tolerance for floating point comparisons
                                  // Check completion status only if requiredHoursForCompletion is positive
                                  if (requiredHoursForCompletion > 0 && status[student.id].total >= requiredHoursForCompletion - tolerance) {
                                      status[student.id].completionStatus = '이수';
                                  } else {
                                      status[student.id].completionStatus = '미이수';
                                  }
                             });
                         }
                     } // End of if (data.students)

                    return status;
                },


                 savedGuidanceSessions() {
                    const data = this.currentGuidanceData;
                     if (!data || !data.sessions) return []; // Add null check
                    return data.sessions.filter(s => s && s.isSaved && s.date); // Add null check for s
                },

                 guidanceOperationPeriod() {
                    const savedSessions = this.savedGuidanceSessions;
                    if (savedSessions.length === 0) return '미정';

                    const validDates = savedSessions
                         .map(s => {
                             try {
                                 // Check if date string is valid before creating Date object
                                 if (s && s.date && /^\d{4}-\d{2}-\d{2}$/.test(s.date)) {
                                     const dateObj = new Date(s.date);
                                      // Further check if the date object is valid
                                      if (!isNaN(dateObj.getTime())) { return dateObj; }
                                  }
                                 return null;
                             } catch (e) { return null; }
                         })
                         .filter(d => d) // Filter out nulls
                         .sort((a, b) => a - b);


                    if (validDates.length === 0) return '유효한 날짜 없음';

                    try {
                        const startDate = validDates[0].toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                        const endDate = validDates[validDates.length - 1].toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                        return `${startDate} ~ ${endDate}`;
                    } catch (e) {
                         console.error("Error formatting date:", e);
                         return '날짜 형식 오류';
                    }
                },
                 processedHomeroomStudents() {
                     if(this.role !== '담임교사') return [];

                    const studentMap = new Map();
                     // Use deployedUnderachievers loaded from Firestore
                    this.deployedUnderachievers.forEach(student => {
                         // Add null check for student and student.id
                         if (!student || !student.id) return;
                         // Check if the student belongs to the searched class
                         const studentClassIdentifier = student.id.substring(0, 3);
                         if (this.homeroomClassInput && studentClassIdentifier !== this.homeroomClassInput.trim()) return; // Filter by class here only if input exists

                        const allSubjects = new Map();
                         (student.gradeSubjects || []).forEach(subject => {
                              if (!subject || !subject.name) return; // Add null check
                            if (!allSubjects.has(subject.name)) { allSubjects.set(subject.name, { grade: true, attendance: false }); }
                            else { allSubjects.get(subject.name).grade = true; }
                        });
                         (student.attendanceSubjects || []).forEach(subjectName => {
                              if (!subjectName) return; // Add null check
                            if (!allSubjects.has(subjectName)) { allSubjects.set(subjectName, { grade: false, attendance: true }); }
                            else { allSubjects.get(subjectName).attendance = true; }
                        });

                        const subjectsArray = Array.from(allSubjects.entries()).map(([name, reasons]) => {
                            let reason = '';
                            if (reasons.grade && reasons.attendance) reason = '학업성취율&과목출석률';
                            else if (reasons.grade) reason = '학업성취율';
                            else if (reasons.attendance) reason = '과목출석률';

                            // Cannot reliably get status without querying specific teacher data
                            const completion = { status: '확인필요', color: 'text-gray-500'};

                            return { subject: name, reason: reason, status: completion.status, statusColor: completion.color };
                        });

                        studentMap.set(student.id, {
                            id: student.id, name: student.name, subjects: subjectsArray,
                            originalStudent: student // Keep original student for printing
                        });
                    });

                    const tableRows = [];
                    studentMap.forEach(studentData => {
                        studentData.subjects.forEach((subjectInfo, index) => {
                            tableRows.push({ ...studentData, ...subjectInfo, isFirstRow: index === 0, rowspan: studentData.subjects.length });
                        });
                    });
                     tableRows.sort((a, b) => {
                         if (!a || !a.id || !b || !b.id) return 0; // Add null checks
                         if (a.id < b.id) return -1; if (a.id > b.id) return 1; return 0;
                     });
                    return tableRows;
                },
            },

            // --- Methods ---
            methods: {
                 // --- Initialization and Auth ---
                 async initApp() {
                    this.isLoading = true;
                     if (!auth) {
                         console.error("Firebase Auth is not initialized.");
                         this.isLoading = false;
                         return;
                     }
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            this.user = user;
                            this.isLoggedIn = true;
                            await this.loadUserRole(); // Attempt to load role
                             if (this.role) { // Load common data only if role exists
                                await this.loadCommonData();
                                 if(this.role === '교과교사') {
                                     // Load teacher plan first, then guidance data if subject exists
                                     await this.loadTeacherPlan(); // Load saved plan
                                     if (this.teacherPlan.subjectName) {
                                        await this.loadGuidanceData();
                                        this.filterSupplementaryStudents(); // Ensure supplementary list is filtered after load
                                     }
                                 } else if (this.role === '관리자') {
                                     // Ensure admin's local underachievers start synced
                                     this.underachievers = JSON.parse(JSON.stringify(this.deployedUnderachievers));
                                 }
                             }
                        } else {
                            this.user = null;
                            this.isLoggedIn = false;
                            this.role = null;
                            this.resetAllLocalData(); // Clear all data on logout
                        }
                        this.isLoading = false;
                        this.initFlatpickr(); // Initialize date pickers after initial load/login/logout
                    });
                },
                 async login() {
                    const provider = new GoogleAuthProvider();
                    try {
                         if (!auth) throw new Error("Firebase Auth not initialized.");
                        await signInWithPopup(auth, provider);
                        // onAuthStateChanged will handle the rest
                    } catch (error) {
                        console.error("Login failed:", error);
                        // Check for specific error codes if needed
                        if (error.code === 'auth/popup-closed-by-user') {
                            console.log("Login popup closed by user.");
                        } else if (error.code === 'auth/cancelled-popup-request') {
                             console.log("Cancelled multiple login popups.");
                         } else {
                             alert(`로그인 실패: ${error.message}`);
                         }
                    }
                },
                 async logout() {
                     try {
                          if (!auth) throw new Error("Firebase Auth not initialized.");
                         await signOut(auth);
                         // onAuthStateChanged will handle resetting state
                     } catch (error) {
                          console.error("Logout failed:", error);
                         alert(`로그아웃 실패: ${error.message}`);
                     }
                },

                 // --- Role Management ---
                 async selectRole(selectedRole) {
                     if (!this.user) return; // Should not happen if UI is correct
                     if (selectedRole === '관리자') {
                         this.showAdminCodeInput = true;
                     } else {
                         await this.saveUserRole(selectedRole); // Save selected role
                         this.role = selectedRole;
                         this.showAdminCodeInput = false;
                         this.adminCodeError = '';
                         this.statusMessage = '';
                         this.isLoading = true; // Show loading while fetching data
                         await this.loadCommonData(); // Load common data after role selection
                          if(selectedRole === '교과교사') {
                              await this.loadTeacherPlan(); // Load saved plan for this teacher
                              if(this.teacherPlan.subjectName){ // If plan has subject, load guidance
                                 await this.loadGuidanceData();
                                 this.filterSupplementaryStudents(); // Filter after loading
                              }
                          } else if (selectedRole === '관리자') {
                              // Ensure admin's local list syncs with deployed on role selection
                              this.underachievers = JSON.parse(JSON.stringify(this.deployedUnderachievers));
                          }
                         this.isLoading = false; // Hide loading
                         this.initFlatpickr();
                     }
                },
                 async submitAdminCode() {
                     if (this.adminCode === '0822') {
                         await this.saveUserRole('관리자'); // Save admin role
                         this.role = '관리자';
                         this.adminCodeError = '';
                         this.showAdminCodeInput = false;
                         this.statusMessage = '';
                         this.isLoading = true; // Show loading
                         await this.loadCommonData(); // Load common data for admin
                         // Sync admin's local list with deployed data
                         this.underachievers = JSON.parse(JSON.stringify(this.deployedUnderachievers));
                         this.isLoading = false; // Hide loading
                         this.initFlatpickr();
                     } else {
                         this.adminCodeError = '코드가 올바르지 않습니다.';
                     }
                     this.adminCode = '';
                 },
                 async resetRole() {
                     await this.saveUserRole(null); // Clear role in Firestore
                     this.role = null; // Clear local role state to show selection modal
                     this.showAdminCodeInput = false;
                     this.adminCode = '';
                     this.adminCodeError = '';
                     this.statusMessage = '';
                     // Optionally reset other data if needed
                     // this.resetAllLocalData();
                 },
                 async saveUserRole(roleToSave) {
                     if (!this.user || !db) return;
                     this.statusMessage = '역할 저장 중...';
                     const userDocRef = doc(db, `userData/${this.user.uid}`);
                     try {
                         await setDoc(userDocRef, { role: roleToSave });
                         this.statusMessage = roleToSave ? '역할이 저장되었습니다.' : '역할이 초기화되었습니다.';
                     } catch (error) {
                         console.error("Error saving role:", error);
                         this.statusMessage = '역할 저장/초기화 실패.';
                     } finally {
                         setTimeout(() => this.statusMessage = '', 2000);
                     }
                 },
                  async loadUserRole() {
                     if (!this.user || !db) {
                          this.role = null;
                          return;
                      };
                     const userDocRef = doc(db, `userData/${this.user.uid}`);
                     try {
                         const userDocSnap = await getDoc(userDocRef);
                         if (userDocSnap.exists()) {
                             this.role = userDocSnap.data().role;
                         } else {
                             this.role = null; // No role saved yet
                         }
                     } catch (error) {
                         console.error("Error loading user role:", error);
                         this.role = null;
                     }
                 },

                // --- Data Loading (Common) ---
                 async loadCommonData() {
                    if (!db) return; // Don't proceed if DB isn't initialized
                    this.statusMessage = '공용 데이터 로딩 중...';
                    this.isLoading = true; // Indicate loading
                    try {
                        // Use document IDs directly under 'commonData' collection
                        const [
                            curriculumSnap, studentsSnap, emotionalSupportSnap,
                            moduleConfigSnap, formTemplatesSnap, underachieversSnap
                        ] = await Promise.all([
                            getDoc(doc(db, "commonData", "curriculum")),
                            getDoc(doc(db, "commonData", "students")),
                            getDoc(doc(db, "commonData", "emotionalSupport")),
                            getDoc(doc(db, "commonData", "moduleConfig")),
                            getDoc(doc(db, "commonData", "formTemplates")),
                            getDoc(doc(db, "commonData", "underachievers"))
                        ]);

                        this.curriculumData = curriculumSnap.exists() ? curriculumSnap.data().data || [] : [];
                        this.studentData = studentsSnap.exists() ? studentsSnap.data().data || [] : [];
                        this.emotionalSupportData = emotionalSupportSnap.exists() ? emotionalSupportSnap.data().data || [] : [];
                         if (moduleConfigSnap.exists()) Object.assign(this.moduleConfig, moduleConfigSnap.data());
                         if (formTemplatesSnap.exists()) {
                             const templatesData = formTemplatesSnap.data();
                             if(templatesData.newsletter) Object.assign(this.newsletterForm, templatesData.newsletter);
                             if(templatesData.pledge) Object.assign(this.pledgeForm, templatesData.pledge);
                         }
                         this.deployedUnderachievers = underachieversSnap.exists() ? underachieversSnap.data().data || [] : [];
                         // Admin's local underachievers sync when role is selected or data is loaded
                         // Teacher's supplementary list is filtered later

                        console.log("Common data loaded.");
                        this.statusMessage = '공용 데이터 로딩 완료.';
                    } catch (error) {
                        console.error("Error loading common data:", error);
                        this.statusMessage = '공용 데이터 로딩 중 오류 발생.';
                         this.curriculumData = []; this.studentData = []; this.emotionalSupportData = []; this.deployedUnderachievers = [];
                    } finally {
                        this.isLoading = false; // Finish loading indicator
                        setTimeout(() => this.statusMessage = '', 2000);
                         this.initFlatpickr();
                    }
                },

                // --- Data Saving (Admin) ---
                async uploadFile(event, type) { // Corrected Firestore path
                    if (this.role !== '관리자' || !db) return;
                    const file = event.target.files[0];
                    if (!file) return;
                    this.uploadStatus[type] = `${file.name} 처리 및 저장 중...`;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);

                            // Save data to Firestore commonData/{type} document
                            const docRef = doc(db, "commonData", type); // Corrected path
                            await setDoc(docRef, { data: jsonData });

                            // Update local data immediately
                            if (type === 'curriculum') this.curriculumData = jsonData;
                            if (type === 'student') this.studentData = jsonData;
                            if (type === 'emotionalSupport') this.emotionalSupportData = jsonData;

                            this.uploadStatus[type] = `${file.name} 업로드 및 저장 완료.`;
                             this.updateMaxHours(); // Recalculate if curriculum changed


                        } catch (error) {
                            console.error(`Error processing/saving ${type} file:`, error);
                            this.uploadStatus[type] = `${file.name} 처리/저장 중 오류 발생: ${error.message}`;
                        } finally {
                            event.target.value = null;
                            setTimeout(() => this.uploadStatus[type] = '', 5000);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                },
                 async saveModuleConfig() { // Corrected Firestore path
                     if (this.role !== '관리자' || !db) return;
                    this.moduleConfigStatus = "운영 모듈 설정 저장 중...";
                    try {
                        const docRef = doc(db, "commonData", "moduleConfig"); // Corrected path
                        const configToSave = JSON.parse(JSON.stringify(this.moduleConfig));
                        await setDoc(docRef, configToSave);
                        this.moduleConfigStatus = "운영 모듈 설정이 저장되었습니다.";
                    } catch (error) {
                        console.error("Error saving module config:", error);
                        this.moduleConfigStatus = "저장 중 오류 발생.";
                    } finally {
                        setTimeout(() => this.moduleConfigStatus = '', 3000);
                    }
                },
                 async saveFormTemplates(){ // Corrected Firestore path
                     if (this.role !== '관리자' || !db) return;
                    this.adminActionStatus = '양식 저장 중...';
                    try {
                        const docRef = doc(db, "commonData", "formTemplates"); // Corrected path
                        const templatesToSave = {
                            newsletter: JSON.parse(JSON.stringify(this.newsletterForm)),
                            pledge: JSON.parse(JSON.stringify(this.pledgeForm))
                        };
                        await setDoc(docRef, templatesToSave);
                        this.adminActionStatus = '가정통신문 및 서약서 양식이 저장되었습니다.';
                    } catch (error) {
                        console.error("Error saving form templates:", error);
                        this.adminActionStatus = '양식 저장 실패.';
                    } finally {
                        setTimeout(() => this.adminActionStatus = '', 3000);
                    }
                },
                 async deployUnderachievers() { // Corrected Firestore path
                    if (this.role !== '관리자' || !db) return;
                    this.underachieversStatus = "미도달 학생 명단 배포 중...";
                    try {
                        const docRef = doc(db, "commonData", "underachievers"); // Corrected path
                        await setDoc(docRef, { data: JSON.parse(JSON.stringify(this.underachievers)) });
                         this.deployedUnderachievers = JSON.parse(JSON.stringify(this.underachievers));
                        this.underachieversStatus = "대상자 명단이 Firestore에 배포되었습니다.";
                    } catch (error) {
                        console.error("Error deploying underachievers:", error);
                         this.underachieversStatus = "배포 중 오류 발생: " + error.message;
                    } finally {
                        setTimeout(() => this.underachieversStatus = '', 3000);
                    }
                },


                 // --- Data Loading/Saving (Teacher) ---
                  async loadTeacherPlan() { /* ... remains the same ... */
                     if (!this.user || !db || this.role !== '교과교사') return;
                     const planDocRef = doc(db, `teacherData/${this.user.uid}/teacherPlan`);
                     try {
                         const docSnap = await getDoc(planDocRef);
                         if (docSnap.exists()) {
                             const loadedPlan = docSnap.data();
                             Object.assign(this.teacherPlan, loadedPlan);
                             console.log("Teacher plan loaded.");
                              this.teacherPlan.teacherNames = this.teacherPlan.teacherNames || [''];
                              this.teacherPlan.achievements = this.teacherPlan.achievements || [{ text: '', statement: '', loading: false }];
                              this.teacherPlan.preventionMethods = this.teacherPlan.preventionMethods || [];
                              this.teacherPlan.preventionSessions = this.teacherPlan.preventionSessions || [{plan:''}];
                              this.teacherPlan.supplementaryMethods = this.teacherPlan.supplementaryMethods || [];
                              this.teacherPlan.supplementarySessions = this.teacherPlan.supplementarySessions || [{plan:''}];
                              // Convert ISO strings or Timestamps back to Date objects
                              this.teacherPlan.preventionPeriod = (this.teacherPlan.preventionPeriod || []).map(d => d ? new Date(d.seconds ? d.seconds * 1000 : d) : null).filter(d => d && !isNaN(d.getTime()));
                              this.teacherPlan.supplementaryPeriod = (this.teacherPlan.supplementaryPeriod || []).map(d => d ? new Date(d.seconds ? d.seconds * 1000 : d) : null).filter(d => d && !isNaN(d.getTime()));
                              this.updateMaxHours();
                         } else {
                             console.log("No saved teacher plan found, using defaults.");
                              this.resetTeacherData();
                         }
                     } catch (error) {
                         console.error("Error loading teacher plan:", error);
                         this.resetTeacherData();
                     }
                      this.initFlatpickr();
                  },
                  async saveTeacherPlan() { /* ... remains the same ... */
                     if (!this.user || !db || this.role !== '교과교사') return;
                     this.teacherPlanStatus = "계획안 저장 중...";
                      const planDocRef = doc(db, `teacherData/${this.user.uid}/teacherPlan`);
                     try {
                          const planToSave = { ...JSON.parse(JSON.stringify(this.teacherPlan)) };
                           // Convert valid Date objects to ISO strings
                           planToSave.preventionPeriod = this.teacherPlan.preventionPeriod.map(d => (d instanceof Date && !isNaN(d.getTime())) ? d.toISOString() : null);
                           planToSave.supplementaryPeriod = this.teacherPlan.supplementaryPeriod.map(d => (d instanceof Date && !isNaN(d.getTime())) ? d.toISOString() : null);
                          planToSave.achievements = planToSave.achievements.map(({ loading, ...rest }) => rest);
                         await setDoc(planDocRef, planToSave);
                         this.teacherPlanStatus = "계획안이 저장되었습니다.";
                     } catch (error) {
                         console.error("Error saving teacher plan:", error);
                         this.teacherPlanStatus = "계획안 저장 실패: " + error.message;
                     } finally {
                          setTimeout(() => this.teacherPlanStatus = '', 3000);
                     }
                  },
                 async loadGuidanceData(){ /* ... remains the same ... */
                    if (!this.user || !db || this.role !== '교과교사' || !this.teacherPlan.subjectName) {
                         this.teacherGuidanceData = { preventive: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })), error: ''}, supplementary: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })), error: ''} };
                        return;
                    }
                    const docPath = `teacherData/${this.user.uid}/${this.teacherPlan.subjectName}`; console.log("Loading guidance data from:", docPath);
                    try {
                        const docSnap = await getDoc(doc(db, docPath));
                        if (docSnap.exists()) {
                            const fetchedData = docSnap.data();
                            this.teacherGuidanceData.preventive = { students: fetchedData.preventive?.students || [], sessions: this.mergeSessions(this.teacherGuidanceData.preventive.sessions, fetchedData.preventive?.sessions), error: fetchedData.preventive?.error || '' };
                            this.teacherGuidanceData.supplementary = { students: fetchedData.supplementary?.students || [], sessions: this.mergeSessions(this.teacherGuidanceData.supplementary.sessions, fetchedData.supplementary?.sessions), error: fetchedData.supplementary?.error || '' };
                            console.log("Guidance data loaded for", this.teacherPlan.subjectName);
                        } else {
                             this.teacherGuidanceData = { preventive: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })), error: ''}, supplementary: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })), error: ''} };
                            console.log("No guidance data found for", this.teacherPlan.subjectName, ", initializing.");
                        }
                    } catch (error) {
                        console.error("Error loading guidance data:", error);
                          this.teacherGuidanceData = { preventive: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })), error: ''}, supplementary: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })), error: ''} };
                    } finally {
                        this.initFlatpickr();
                    }
                },
                 async saveGuidanceData(){ /* ... remains the same ... */
                    if (!this.user || !db || this.role !== '교과교사' || !this.teacherPlan.subjectName) return;
                    const docPath = `teacherData/${this.user.uid}/${this.teacherPlan.subjectName}`; console.log("Saving guidance data to:", docPath);
                    try {
                         const dataToSave = JSON.parse(JSON.stringify(this.teacherGuidanceData));
                        await setDoc(doc(db, docPath), dataToSave);
                        console.log("Guidance data saved for", this.teacherPlan.subjectName);
                    } catch (error) { console.error("Error saving guidance data:", error); }
                },
                 mergeSessions(defaultSessions, loadedSessions) { /* ... remains the same ... */
                     const validLoadedSessions = Array.isArray(loadedSessions) ? loadedSessions : [];
                     const defaultLength = Array.isArray(defaultSessions) ? defaultSessions.length : 10; // Default length
                     const mergedLength = Math.max(defaultLength, validLoadedSessions.length);
                     const merged = [];

                     for (let i = 0; i < mergedLength; i++) {
                          const defaultSess = (defaultSessions && defaultSessions[i]) ? defaultSessions[i] : { date: '', time: '', isSaved: false, place: '', content: '', attendance: {} }; // Safer default
                          const loadedSess = validLoadedSessions[i];
                          if (loadedSess) {
                              loadedSess.attendance = loadedSess.attendance || {};
                              merged.push({ ...defaultSess, ...loadedSess });
                          } else {
                              merged.push(defaultSess);
                          }
                      }
                      // Ensure all sessions have attendance for current students
                      const currentStudents = this.teacherGuidanceData[this.teacherTab]?.students || [];
                       merged.forEach(session => {
                           if (!session.attendance) session.attendance = {};
                           currentStudents.forEach(student => {
                                if (!student) return; // Add null check for student
                               if (!session.attendance.hasOwnProperty(student.id)) {
                                   session.attendance[student.id] = '';
                               }
                           });
                       });
                     return merged;
                 },
                 handleSubjectChange() { /* ... remains the same ... */
                     this.updateMaxHours();
                     this.loadGuidanceData().then(() => { this.filterSupplementaryStudents(); }); // Ensure filter runs after load
                 },


                // --- Helper and UI Methods ---
                initFlatpickr() { /* ... remains the same ... */
                     this.$nextTick(() => {
                         document.querySelectorAll('.flatpickr-input').forEach(el => {
                             if (el?._flatpickr) { el._flatpickr.destroy(); }
                         });
                         flatpickr(".flatpickr-range", {
                             mode: "range", dateFormat: "Y-m-d", locale: "ko",
                             onChange: (selectedDates, dateStr, instance) => {
                                  let headerText = ''; const headerElement = instance.element.closest('.bg-white')?.querySelector('h3'); if(headerElement) headerText = headerElement.textContent;
                                  const isPrevention = headerText.includes('예방'); const plan = this.teacherPlan; const targetPeriod = isPrevention ? 'preventionPeriod' : 'supplementaryPeriod';
                                  if (Array.isArray(selectedDates) && selectedDates.every(d => d instanceof Date)) { plan[targetPeriod] = selectedDates; } else { plan[targetPeriod] = []; }
                                  this.saveTeacherPlan();
                             }
                         });
                        flatpickr(".flatpickr-single", {
                             dateFormat: "Y-m-d", locale: "ko",
                             // onChange handled by @change on input element -> triggers saveGuidanceData
                         });
                    });
                },
                toggleExportOptions() { this.showExportOptions = !this.showExportOptions; },
                downloadTemplate(type) { /* ... remains the same ... */
                    let data, filename;
                    if (type === 'curriculum') { data = [["분류", "과목명", "학년", "학기", "학점", "교과군"]]; filename = "교육과정_편제표_양식.xlsx"; }
                    else if (type === 'student') { data = [["학번", "이름", "특기사항"]]; filename = "학적정보_양식.xlsx"; }
                    else if (type === 'emotionalSupport') { data = [["학번", "이름", "정서지원프로그램 참여시간"]]; filename = "정서지원프로그램_이수시간_양식.xlsx"; }
                     if (!data) return; const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1"); XLSX.writeFile(wb, filename);
                },
                handleImageUpload(event, formType, field) { /* ... remains the same ... */
                    const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
                    reader.onload = (e) => { if (formType === 'newsletter') this.newsletterForm[field] = e.target.result; else if (formType === 'pledge') this.pledgeForm[field] = e.target.result; }; reader.readAsDataURL(file);
                },
                previewForm(type, studentsToPrint) { /* ... logic remains the same ... */
                     const studentsToUse = (this.role === '관리자') ? this.underachievers : (this.role === '담임교사' ? studentsToPrint : []);
                     if (!studentsToUse || studentsToUse.length === 0) { alert("미리보기할 학생 데이터가 없습니다."); return; }
                     const studentsArray = Array.isArray(studentsToUse) ? studentsToUse : [studentsToUse];
                     if (type === 'newsletter') {
                         let allPreviewsHtml = ''; const form = this.newsletterForm; const logoImg = form.logoUrl ? `<img src="${form.logoUrl}" ...>` : ''; const sealSection = form.includeSeal && form.sealUrl ? `<div ...><img src="${form.sealUrl}" ...></div>` : `<div ...>... (직인생략)</div>`; const newsletterHeader = `<div ...>${logoImg}<h1 ...>${form.title || '제목 없음'}</h1></div>...`;
                         const studentDocs = studentsArray.map(student => { const fullStudent = this.deployedUnderachievers.find(s => s.id === student.id) || student; let studentTableHtml = `<h3 ...>...</h3><table ...><thead>...</thead><tbody>`; const subjectsMap = new Map(); (fullStudent.gradeSubjects || []).forEach(s => { if (!subjectsMap.has(s.name)) subjectsMap.set(s.name, new Set()); subjectsMap.get(s.name).add('학업성취율'); }); (fullStudent.attendanceSubjects || []).forEach(sName => { if (!subjectsMap.has(sName)) subjectsMap.set(sName, new Set()); subjectsMap.get(sName).add('과목출석률'); }); subjectsMap.forEach((reasons, subjectName) => { studentTableHtml += `<tr><td>${fullStudent.id}</td><td>${fullStudent.name}</td><td>${subjectName}</td><td>${Array.from(reasons).join(' & ')}</td></tr>`; }); studentTableHtml += `</tbody></table><div ...>...서약합니다...<div>학생:...</div><div>학부모:...</div></div>`; return `${newsletterHeader}${studentTableHtml}${sealSection}`; });
                         allPreviewsHtml = studentDocs.map((doc, index) => { const style = (index < studentDocs.length - 1) ? 'page-break-after: always;' : ''; return `<div class="page-break" style="... ${style}">${doc}</div>`; }).join(''); this.previewHtml = `<div id="print-area">${allPreviewsHtml}</div>`;
                     } else { /* pledge logic similar */
                        let allPreviewsHtml = ''; const form = this.pledgeForm; const sealSection = form.includeSeal && form.sealUrl ? `<div ...><img src="${form.sealUrl}" ...></div>` : `<div ...>... (직인생략)</div>`; const pledgeHeader = `<h1 ...>서 약 서</h1><div ...>${(form.content || '').trim() || '내용 없음'}</div>`;
                        const studentDocs = studentsArray.map(student => { const fullStudent = this.deployedUnderachievers.find(s => s.id === student.id) || student; let studentTableHtml = `<h3 ...>...</h3><table ...><thead>...</thead><tbody>`; const subjectsMap = new Map(); (fullStudent.gradeSubjects || []).forEach(s => { if (!subjectsMap.has(s.name)) subjectsMap.set(s.name, new Set()); subjectsMap.get(s.name).add('학업성취율'); }); (fullStudent.attendanceSubjects || []).forEach(sName => { if (!subjectsMap.has(sName)) subjectsMap.set(sName, new Set()); subjectsMap.get(sName).add('과목출석률'); }); subjectsMap.forEach((reasons, subjectName) => { studentTableHtml += `<tr><td>${fullStudent.id}</td><td>${fullStudent.name}</td><td>${subjectName}</td><td>${Array.from(reasons).join(' & ')}</td></tr>`; }); studentTableHtml += `</tbody></table><div ...>...서약합니다...<div>학생:...</div><div>학부모:...</div></div>`; return `${pledgeHeader}${studentTableHtml}${sealSection}`; });
                         allPreviewsHtml = studentDocs.map((doc, index) => { const style = (index < studentDocs.length - 1) ? 'page-break-after: always;' : ''; return `<div class="page-break" style="... ${style}">${doc}</div>`; }).join(''); this.previewHtml = `<div id="print-area">${allPreviewsHtml}</div>`;
                    } this.showPreviewModal = true;
                },
                closePreviewModal() { this.showPreviewModal = false; this.previewHtml = ''; this.teacherPlanError = ''; this.adminActionStatus = ''; },
                async printPreview() { /* ... remains the same ... */
                     const printContainer = document.getElementById('print-area-container'); printContainer.innerHTML = this.previewHtml; printContainer.style.position = 'absolute'; printContainer.style.left = '-9999px'; printContainer.style.width = '800px'; printContainer.classList.remove('hidden'); const printContent = printContainer.querySelector('#print-area');
                     const statusVar = this.role === '관리자' ? 'adminActionStatus' : 'teacherPlanError'; this[statusVar] = 'PDF 생성 중...';
                     const cleanup = () => { printContainer.innerHTML = ''; printContainer.classList.add('hidden'); printContainer.style = ''; }; if (!printContent) { console.error("Print area not found."); cleanup(); return; }
                     try { const canvas = await html2canvas(printContent, { scale: 2, useCORS: true }); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF('p', 'mm', 'a4'); const pdfPageWidth = pdf.internal.pageSize.getWidth(); const pdfPageHeight = pdf.internal.pageSize.getHeight(); const margin = 10; const contentWidth = pdfPageWidth - margin * 2; const imgRatio = canvas.height / canvas.width; const pdfImgWidth = contentWidth; const pdfImgHeight = pdfImgWidth * imgRatio; let position = 0; let heightLeft = pdfImgHeight; const pageContentHeight = pdfPageHeight - margin * 2; pdf.addImage(imgData, 'PNG', margin, margin + position, pdfImgWidth, pdfImgHeight); heightLeft -= pageContentHeight; while (heightLeft > 0) { position -= pageContentHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', margin, margin + position, pdfImgWidth, pdfImgHeight); heightLeft -= pageContentHeight; } pdf.save(`보장지도_문서_${new Date().toISOString().slice(0, 10)}.pdf`); this[statusVar] = 'PDF 생성 완료.'; }
                     catch (error) { console.error("PDF generation error:", error); this[statusVar] = `PDF 생성 오류: ${error.message}`; }
                     finally { cleanup(); setTimeout(() => { if (this[statusVar] === 'PDF 생성 완료.') this[statusVar] = '' }, 3000); }
                 },
                 processGradeFiles(event) { /* ... remains the same ... */
                    if (this.role !== '관리자') return; this.fileProcessingError = ''; const files = event.target.files; if (!files || files.length === 0) return; const attendanceOnly = this.underachievers.filter(s => !(s.gradeSubjects && s.gradeSubjects.length > 0) && (s.attendanceSubjects && s.attendanceSubjects.length > 0)); let processedUnderachievers = [...attendanceOnly]; const resultData = new Map(); let filesProcessed = 0; const totalFiles = files.length;
                    Array.from(files).forEach(file => { const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const sheet = workbook.Sheets[workbook.SheetNames[0]]; const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1 }); const classInfoRow = sheetData[2]; if (!classInfoRow || !classInfoRow[0]) throw new Error(`'${file.name}' 파일의 3행 A열에서 학급 정보를 찾을 수 없습니다.`); const classInfo = String(classInfoRow[0]); const gradeMatch = classInfo.match(/(\d)학년/); const classNumMatch = classInfo.match(/(\d{1,2})반/); if (!gradeMatch || !classNumMatch) throw new Error(`'${file.name}' 파일의 학급 정보 형식("${classInfo}")이 예상과 다릅니다.`); const classGrade = gradeMatch[1]; const classNum = classNumMatch[1]; const subjectHeaderRow = sheetData[3]; if (!subjectHeaderRow) throw new Error(`'${file.name}' 파일의 4행에서 과목 정보를 찾을 수 없습니다.`);
                    for (let r = 5; r < sheetData.length; r += 2) { const nameRow = sheetData[r - 1]; const statusRow = sheetData[r]; if (!nameRow || !statusRow || !nameRow[0] || !nameRow[1]) continue; const num = nameRow[0]; const name = nameRow[1]; const fullId = `${classGrade}${String(classNum).padStart(2, "0")}${String(num).padStart(2, "0")}`; for (let c = 3; c < statusRow.length; c++) { if (String(statusRow[c]).trim() === "미도달") { const subjectWithCredits = subjectHeaderRow[c]; if (!subjectWithCredits) continue; const subject = String(subjectWithCredits).split('(')[0].trim(); if (!resultData.has(fullId)) resultData.set(fullId, { name: name, subjects: new Set() }); resultData.get(fullId).subjects.add(subject); } } } }
                    catch (err) { console.error(`Error processing file ${file.name}:`, err); this.fileProcessingError = `${file.name} 처리 오류: ${err.message}`; }
                    finally { filesProcessed++; if (filesProcessed === totalFiles) { resultData.forEach((data, id) => { const existingIndex = processedUnderachievers.findIndex(s => s.id === id); const gradeSubjectsData = Array.from(data.subjects).map(subjectName => { const curriculumInfo = this.curriculumData.find(c => c.과목명 === subjectName); return { name: subjectName, credits: curriculumInfo ? curriculumInfo.학점 : 'N/A' }; }); if (existingIndex > -1) { const existingGradeSubjectsNames = new Set((processedUnderachievers[existingIndex].gradeSubjects || []).map(s => s.name)); if (!processedUnderachievers[existingIndex].gradeSubjects) processedUnderachievers[existingIndex].gradeSubjects = []; gradeSubjectsData.forEach(gs => { if (!existingGradeSubjectsNames.has(gs.name)) processedUnderachievers[existingIndex].gradeSubjects.push(gs); }); } else { processedUnderachievers.push({ id: id, name: data.name, gradeSubjects: gradeSubjectsData, attendanceSubjects: [] }); } }); processedUnderachievers.sort((a,b) => a.id.localeCompare(b.id)); this.underachievers = processedUnderachievers; event.target.value = null; } } }; reader.readAsArrayBuffer(file); });
                 },
                 closeAttendanceModal() { /* ... remains the same ... */ this.showAttendanceModal = false; this.newAttendanceStudent = { id: '', subjects: [''] }; this.attendanceModalError = ''; },
                 addAttendanceSubject() { /* ... remains the same ... */ this.newAttendanceStudent.subjects.push(''); },
                 removeAttendanceSubject(index) { /* ... remains the same ... */ this.newAttendanceStudent.subjects.splice(index, 1); },
                 addAttendanceStudent() { /* ... remains the same ... */
                     if (this.role !== '관리자') return; this.attendanceModalError = ''; const studentIdInput = this.newAttendanceStudent.id ? String(this.newAttendanceStudent.id).trim() : ''; const subjects = this.newAttendanceStudent.subjects; if (!studentIdInput || subjects.some(s => !s.trim())) { this.attendanceModalError = '학번과 모든 과목명을 입력해주세요.'; return; } const foundStudent = this.studentData.find(student => String(student['학번']) === studentIdInput); if (!foundStudent) { this.attendanceModalError = '해당 학번을 찾을 수 없습니다. 학적 정보를 먼저 업로드 해주세요.'; return; } const canonicalId = String(foundStudent['학번']); const name = foundStudent['이름']; const studentIndex = this.underachievers.findIndex(s => s.id === canonicalId); const validSubjects = subjects.map(s => s.trim()).filter(s => s);
                     if (studentIndex > -1) { if (!this.underachievers[studentIndex].attendanceSubjects) this.underachievers[studentIndex].attendanceSubjects = []; const existingSubjects = new Set(this.underachievers[studentIndex].attendanceSubjects); validSubjects.forEach(subject => { if (!existingSubjects.has(subject)) this.underachievers[studentIndex].attendanceSubjects.push(subject); }); }
                     else { this.underachievers.push({ id: canonicalId, name, gradeSubjects: [], attendanceSubjects: validSubjects }); } this.underachievers.sort((a, b) => a.id.localeCompare(b.id)); this.closeAttendanceModal();
                 },
                 deleteDetailGroup(detailToDelete) { /* ... remains the same ... */
                     if (this.role !== '관리자') return; const student = this.underachievers.find(s => s.id === detailToDelete.id); if (!student) return; student.gradeSubjects = student.gradeSubjects || []; student.attendanceSubjects = student.attendanceSubjects || []; detailToDelete.originalSubjects.forEach(subjectInfo => { student.gradeSubjects = student.gradeSubjects.filter(gs => gs.name !== subjectInfo.name); student.attendanceSubjects = student.attendanceSubjects.filter(asName => asName !== subjectInfo.name); }); if (student.gradeSubjects.length === 0 && student.attendanceSubjects.length === 0) this.underachievers = this.underachievers.filter(s => s.id !== student.id);
                 },
                exportTable(format) { /* ... remains the same ... */
                    if (this.role !== '관리자' || !this.groupedUnderachievers || this.groupedUnderachievers.length === 0) { alert("내보낼 미도달 학생 데이터가 없습니다."); this.showExportOptions = false; return; } const data = this.groupedUnderachievers.flatMap(student => student.details.map(detail => ({ '학번': student.id, '이름': student.name, '특기사항': student.specialNotes, '미도달내역': detail.reason, '미도달 과목(학점수)': detail.subjects, '보충지도(추가학습) 내역': detail.lessonDetails, }))); const today = new Date().toISOString().slice(0, 10); const filename = `미도달_학생_현황_${today}`;
                    if (format === 'xlsx') { const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "현황"); XLSX.writeFile(wb, `${filename}.xlsx`); }
                    else if (format === 'csv') { const ws = XLSX.utils.json_to_sheet(data); const csv = XLSX.utils.sheet_to_csv(ws); const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" }); saveAs(blob, `${filename}.csv`); }
                    else if (format === 'pdf') { const table = document.getElementById('underachievers-table'); if (table) { const tableClone = table.cloneNode(true); const rows = tableClone.querySelectorAll('tr'); rows.forEach(row => { row.querySelector('th:last-child, td:last-child')?.remove(); }); const style = document.createElement('style'); style.innerHTML = ` .pdf-table { width: 100%; font-size: 8pt; border-collapse: collapse; table-layout: fixed; } .pdf-table th, .pdf-table td { border: 1px solid #ddd; padding: 3px; text-align: left; vertical-align: top; word-wrap: break-word; } .pdf-table th { background-color: #f2f2f2; text-align: center; } .pdf-table tr > *:nth-child(1) { width: 7%; } .pdf-table tr > *:nth-child(2) { width: 7%; } .pdf-table tr > *:nth-child(3) { width: 10%; } .pdf-table tr > *:nth-child(4) { width: 14%; } .pdf-table tr > *:nth-child(5) { width: 40%; } .pdf-table tr > *:nth-child(6) { width: 22%; } `; tableClone.classList.add('pdf-table'); const printContainer = document.createElement('div'); printContainer.style.position = 'absolute'; printContainer.style.left = '-9999px'; printContainer.style.width = '1120px'; printContainer.appendChild(style); printContainer.appendChild(tableClone); document.body.appendChild(printContainer); html2canvas(printContainer, { scale: 2 }).then(canvas => { const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF('l', 'mm', 'a4'); const imgProps = pdf.getImageProperties(imgData); const margin = 10; const pdfWidth = pdf.internal.pageSize.getWidth() - (margin * 2); const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; const pageHeight = pdf.internal.pageSize.getHeight() - (margin * 2); let heightLeft = pdfHeight; let position = 0; pdf.addImage(imgData, 'PNG', margin, margin, pdfWidth, pdfHeight); heightLeft -= pageHeight; while (heightLeft > 0) { position -= pageHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', margin, margin + position, pdfWidth, pdfHeight); heightLeft -= pageHeight; } pdf.save(`${filename}.pdf`); }).finally(() => { document.body.removeChild(printContainer); }); } } this.showExportOptions = false;
                },

                // --- Teacher Methods ---
                switchTeacherTab(tab) { /* ... remains the same ... */ this.teacherTab = tab; this.initFlatpickr(); if (this.teacherPlan.subjectName) { this.loadGuidanceData(); } if (tab === 'supplementary') { this.filterSupplementaryStudents(); } },
                filterSupplementaryStudents() { /* ... logic remains the same, uses deployedUnderachievers ... */
                     if (this.role !== '교과교사' || !this.teacherPlan.subjectName || !this.deployedUnderachievers) { if (this.teacherGuidanceData.supplementary) this.teacherGuidanceData.supplementary.students = []; return; }
                     const subject = this.teacherPlan.subjectName; const subjectSpecificUnderachievers = this.deployedUnderachievers.filter(student => { if (!student) return false; const gradeMatch = (student.gradeSubjects || []).some(s => s.name === subject); const attendanceMatch = (student.attendanceSubjects || []).includes(subject); return gradeMatch || attendanceMatch; }); const newSupplementaryStudents = [];
                     subjectSpecificUnderachievers.forEach(underachiever => { let reason = ''; const gradeMatch = (underachiever.gradeSubjects || []).some(s => s.name === subject); const attendanceMatch = (underachiever.attendanceSubjects || []).includes(subject); if (gradeMatch && attendanceMatch) reason = '학업성취율&과목출석률'; else if (gradeMatch) reason = '학업성취율'; else if (attendanceMatch) reason = '과목출석률';
                     const existingStudent = this.teacherGuidanceData.supplementary.students.find(s => s.id === underachiever.id); if (existingStudent) { existingStudent.reason = reason; newSupplementaryStudents.push(existingStudent); } else { newSupplementaryStudents.push({ id: underachiever.id, name: underachiever.name, reason: reason }); } });
                     newSupplementaryStudents.sort((a, b) => a.id.localeCompare(b.id)); this.teacherGuidanceData.supplementary.students = newSupplementaryStudents;
                      this.teacherGuidanceData.supplementary.sessions.forEach(session => { if (!session) return; const newAttendance = {}; newSupplementaryStudents.forEach(student => { if (!student) return; newAttendance[student.id] = (session.attendance && session.attendance[student.id]) ? session.attendance[student.id] : ''; }); session.attendance = newAttendance; }); this.saveGuidanceData();
                },
                 updateMaxHours() { /* ... remains the same ... */
                     const subject = this.curriculumData.find(s => s.과목명 === this.teacherPlan.subjectName); if (subject) { const credits = Number(subject.학점); if (!isNaN(credits) && credits > 0) { this.teacherPlan.maxSupplementaryHours = credits * this.moduleConfig.hoursPerCredit; } else { this.teacherPlan.maxSupplementaryHours = 0; console.warn(`Invalid credits for ${this.teacherPlan.subjectName}`); } if(this.teacherPlan.supplementarySessions.length > this.teacherPlan.maxSupplementaryHours && this.teacherPlan.maxSupplementaryHours > 0){ this.teacherPlan.supplementarySessions = this.teacherPlan.supplementarySessions.slice(0, this.teacherPlan.maxSupplementaryHours); } else if (this.teacherPlan.maxSupplementaryHours <= 0) { this.teacherPlan.supplementarySessions = []; } } else { this.teacherPlan.maxSupplementaryHours = 0; this.teacherPlan.supplementarySessions = []; }
                 },
                addAchievement() { this.teacherPlan.achievements.push({ text: '', statement: '', loading: false }); },
                removeAchievement(index) { this.teacherPlan.achievements.splice(index, 1); },
                addPreventionSession() { this.teacherPlan.preventionSessions.push({ plan: '' }); },
                removePreventionSession(index) { this.teacherPlan.preventionSessions.splice(index, 1); },
                addSupplementarySession() { if (this.teacherPlan.supplementarySessions.length < this.teacherPlan.maxSupplementaryHours) this.teacherPlan.supplementarySessions.push({ plan: '' }); },
                removeSupplementarySession(index) { this.teacherPlan.supplementarySessions.splice(index, 1); },
                addTeacher() { this.teacherPlan.teacherNames.push(''); },
                removeTeacher(index) { this.teacherPlan.teacherNames.splice(index, 1); },
                async generateStatement(index) { /* ... logic remains the same ... */
                    this.teacherPlanError = ''; const achievement = this.teacherPlan.achievements[index]; if (!achievement.text) { this.teacherPlanError = '성취기준을 먼저 입력해주세요.'; return; } if (this.teacherPlan.aiProvider !== 'openai' && !this.teacherPlan.apiKey) { this.teacherPlanError = 'AI API 키를 먼저 입력해주세요.'; return; } achievement.loading = true; achievement.statement = ''; const systemPrompt = "당신은 교육 전문가... (Full prompt)"; const userQuery = achievement.text; let apiUrl, payload, headers = {}, responseParser; const provider = this.teacherPlan.aiProvider; const apiKey = this.teacherPlan.apiKey;
                    if (provider === 'gemini') { apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`; headers['Content-Type'] = 'application/json'; payload = { contents: [{ role: "user", parts: [{ text: systemPrompt + "\n\n 성취기준: " + userQuery }] }] }; responseParser = (r) => r.candidates?.[0]?.content?.parts?.[0]?.text; }
                    else if (provider === 'openai') { apiUrl = '/.netlify/functions/openai-proxy'; headers['Content-Type'] = 'application/json'; payload = { model: "gpt-3.5-turbo", messages: [{ role: "system", content: systemPrompt },{ role: "user", content: userQuery }] }; responseParser = (r) => r.choices?.[0]?.message?.content; }
                    else if (provider === 'claude') { apiUrl = '/.netlify/functions/claude-proxy'; headers = { 'Content-Type': 'application/json' }; payload = { model: "claude-3-sonnet-20240229", max_tokens: 1024, system: systemPrompt, messages: [{ role: "user", content: userQuery }] }; responseParser = (r) => r.content?.[0]?.text; }
                    try { const response = await fetch(apiUrl, { method: 'POST', headers: headers, body: JSON.stringify(payload) }); if (!response.ok) { const errorBody = await response.json().catch(() => ({})); const errorMessage = errorBody.error?.message || errorBody.message || errorBody.error || response.statusText; throw new Error(`API 요청 실패 (${response.status}): ${errorMessage}`); } const result = await response.json(); const actualResult = result.data || result; const generatedText = responseParser(actualResult); if (generatedText) { achievement.statement = generatedText.trim().replace(/^(E수준:|최소 성취수준:)\s*/, ''); } else { console.log('API Raw Response:', result); throw new Error('API 응답에서 진술문을 찾을 수 없습니다.'); } }
                    catch (error) { console.error("AI 진술문 생성 오류:", error); this.teacherPlanError = `진술문 생성 중 오류 발생: ${error.message}.`; } finally { achievement.loading = false; }
                 },
                generatePlanPreview() { /* ... logic remains the same ... */
                     const plan = this.teacherPlan; const subjectInfo = this.curriculumData.find(s => s.과목명 === plan.subjectName); if (!subjectInfo) { this.teacherPlanError = '과목명을 찾을 수 없습니다.'; this.previewHtml = `<div id="print-area"><p style='color: red;'>${this.teacherPlanError}</p></div>`; this.showPreviewModal = true; return; } this.teacherPlanError = ''; const localModuleConfig = this.moduleConfig; const supplementaryHours = this.teacherPlan.maxSupplementaryHours; const requiredHours = Math.ceil((supplementaryHours * 2) / 3); const preventionPossibleHours = Math.floor(supplementaryHours * (localModuleConfig.preventiveRatio / 100)); const emotionalSupportHours = Math.floor(supplementaryHours * (localModuleConfig.emotionalSupportRatio / 100)); const createTable = (h, r) => { /*...*/ }; let achievementRateHtml = `<p>• 학업 성취율: ...</p>`; if (plan.gradeCalculation === '고정분할점수') achievementRateHtml += createTable(/*...*/); else achievementRateHtml += `<p>...</p>`; const overviewTable = createTable(/*...*/); const statementsTable = createTable(['성취기준', '최소 성취수준 진술문'], plan.achievements.map(a => [`<div ...>${a.text || ''}</div>`, `<div ...>${a.statement || '미생성'}</div>`])); let preventionPlanHtml = ''; if (plan.conductPrevention === 'O') { const pPeriod = (plan.preventionPeriod || []).filter(d => d instanceof Date).map(d => d.toLocaleDateString('ko-KR')); const pPeriodFmt = pPeriod.length === 2 ? `${pPeriod[0]} ~ ${pPeriod[1]}` : (pPeriod.length === 1 ? pPeriod[0] : '미정'); const pSessions = plan.preventionSessions.map((s, i) => [`${i + 1}차시`, `<div ...>${s.plan || ''}</div>`]); preventionPlanHtml = `<h3 ...>4. ...</h3>${createTable(/*...*/)}<h4 ...>차시별 ...</h4>${createTable(['차시', '지도 계획'], pSessions)}`; } else { preventionPlanHtml = `<h3 ...>4. ...</h3><p>- 해당 없음</p>`; } const sPeriod = (plan.supplementaryPeriod || []).filter(d => d instanceof Date).map(d => d.toLocaleDateString('ko-KR')); const sPeriodFmt = sPeriod.length === 2 ? `${sPeriod[0]} ~ ${sPeriod[1]}` : (sPeriod.length === 1 ? sPeriod[0] : '미정'); const sSessions = plan.supplementarySessions.map((s, i) => [`${i + 1}차시`, `<div ...>${s.plan || ''}</div>`]); const supplementaryPlanHtml = `<h3 ...>5. ...</h3>${createTable(/*...*/)}<h4 ...>차시별 ...</h4>${createTable(['차시', '지도 계획'], sSessions)}`; const additionalLearningPlanHtml = `<h3 ...>6. ...</h3>${createTable(/*...*/)}<h4 ...>차시별 ...</h4>${createTable(['차시', '지도 계획'], sSessions)}`; this.previewHtml = `<div id="print-area" ...><h1 ...>...</h1>...${achievementRateHtml}${overviewTable}${statementsTable}${preventionPlanHtml}${supplementaryPlanHtml}${additionalLearningPlanHtml}</div>`; this.showPreviewModal = true;
                },

                // --- GUIDANCE LOGBOOK METHODS ---
                addGuidanceStudent(type) { /* ... logic remains the same ... */
                    if (this.role !== '교과교사') return; const data = this.teacherGuidanceData[type]; if (!data) return; data.error = ''; const studentId = this.newGuidanceStudentId.trim(); if (!studentId) return; if (data.students.some(s => s.id === studentId)) { data.error = '이미 추가된 학생입니다.'; return; } const studentInfo = this.studentData.find(s => String(s['학번']) === studentId); if (studentInfo) { data.students.push({ id: studentId, name: studentInfo['이름'] }); data.students.sort((a, b) => a.id.localeCompare(b.id)); data.sessions.forEach(session => { if (session && !session.attendance.hasOwnProperty(studentId)) { session.attendance[studentId] = ''; } }); this.newGuidanceStudentId = ''; this.saveGuidanceData(); } else { data.error = '학적 정보에 없는 학생입니다.'; }
                },
                removeGuidanceStudent(type, studentIdToRemove) { /* ... logic remains the same ... */
                     if (this.role !== '교과교사') return; const data = this.teacherGuidanceData[type]; if (!data) return; const index = data.students.findIndex(s => s.id === studentIdToRemove); if (index > -1) { data.students.splice(index, 1); data.sessions.forEach(session => { if (session) delete session.attendance[studentIdToRemove]; }); this.saveGuidanceData(); }
                },
                addGuidanceSession(type) { /* ... logic remains the same ... */
                     if (this.role !== '교과교사') return; const data = this.teacherGuidanceData[type]; if (!data) return; const initialAttendance = {}; data.students.forEach(s => { if (s) initialAttendance[s.id] = ''; }); data.sessions.push({ date: '', time: '', isSaved: false, place: '', content: '', attendance: initialAttendance }); this.initFlatpickr();
                },
                isSessionReadyToSave(session) { /* ... remains the same ... */ if (!session || !session.date || !session.time) return false; const currentStudents = this.currentGuidanceData?.students; if (!currentStudents) return false; return currentStudents.some(student => session.attendance && session.attendance[student.id]); },
                toggleSaveSession(session) { /* ... logic remains the same ... */
                    if (this.role !== '교과교사' || !session) return; session.isSaved = !session.isSaved; if (this.currentGuidanceData && this.currentGuidanceData.students) { this.currentGuidanceData.students.forEach(student => { if (!session.attendance) session.attendance = {}; if (student && !session.attendance.hasOwnProperty(student.id)) { session.attendance[student.id] = ''; } }); } this.saveGuidanceData();
                },
                scrollAttendance(direction, event) { /* ... remains the same ... */ const container = event.target.closest('.relative')?.querySelector('.overflow-x-auto'); if (!container) return; const scrollAmount = container.clientWidth * 0.8; container.scrollBy({ left: direction === 'left' ? -scrollAmount : scrollAmount, behavior: 'smooth' }); },
                 async generatePdfFromHtml(htmlContent, orientation, filename) { /* ... remains the same ... */
                     const printContainer = document.getElementById('print-area-container'); printContainer.innerHTML = htmlContent; printContainer.style.position = 'absolute'; printContainer.style.left = '-9999px'; printContainer.style.width = orientation === 'p' ? '800px' : '1120px'; printContainer.classList.remove('hidden'); const printContent = printContainer.children[0]; const statusVar = this.role === '관리자' ? 'adminActionStatus' : 'teacherPlanStatus'; const cleanup = () => { printContainer.innerHTML = ''; printContainer.classList.add('hidden'); printContainer.style = ''; }; if (!printContent) { console.error("Print area not found."); cleanup(); return; } try { const canvas = await html2canvas(printContent, { scale: 2, useCORS: true }); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF(orientation, 'mm', 'a4'); const pdfPageWidth = pdf.internal.pageSize.getWidth(); const pdfPageHeight = pdf.internal.pageSize.getHeight(); const margin = 15; const contentWidth = pdfPageWidth - margin * 2; const imgRatio = canvas.height / canvas.width; const pdfImgWidth = contentWidth; const pdfImgHeight = pdfImgWidth * imgRatio; let position = 0; let heightLeft = pdfImgHeight; const pageContentHeight = pdfPageHeight - margin * 2; pdf.addImage(imgData, 'PNG', margin, margin + position, pdfImgWidth, pdfImgHeight); heightLeft -= pageContentHeight; while (heightLeft > 0) { position -= pageContentHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', margin, margin + position, pdfImgWidth, pdfImgHeight); heightLeft -= pageContentHeight; } pdf.save(filename); this[statusVar] = 'PDF 생성 완료.'; } catch (error) { console.error("PDF generation error:", error); this[statusVar] = `PDF 생성 오류: ${error.message}`; } finally { cleanup(); setTimeout(() => { if (this[statusVar] === 'PDF 생성 완료.') this[statusVar] = '' }, 3000); }
                 },
                 async generateCompletionStatusPdf(type) { /* ... remains the same ... */ const data = this.teacherGuidanceData[type]; if (!data || !this.role) return; const title = type === 'preventive' ? '예방지도' : '보충지도(추가학습)'; let completionStatusTable = '<table...><thead>...</thead><tbody>'; if (data.students && data.students.length > 0) { data.students.forEach(student => { if (!student) return; completionStatusTable += `<tr><td>${student.name} (${student.id})</td>`; const studentStatus = this.guidanceCompletionStatus[student.id] || {}; if (type === 'supplementary') { completionStatusTable += `<td>${studentStatus.specialNotes || '일반학생'}</td><td>${student.reason || ''}</td><td>${studentStatus.preventiveHours || 0}</td><td>${studentStatus.emotionalSupportHours || 0}</td>`; } this.moduleConfig.recognizedHours.forEach(rh => { completionStatusTable += `<td>${studentStatus[rh.name] || 0}</td>`; }); completionStatusTable += `<td>${studentStatus.total || 0}</td>`; if (type === 'supplementary') { const status = studentStatus.completionStatus || '미이수'; const color = status === '이수' ? 'green' : 'red'; completionStatusTable += `<td style="color: ${color};">${status}</td>`; } completionStatusTable += '</tr>'; }); } else { const colspan = this.moduleConfig.recognizedHours.length + (type === 'supplementary' ? 7 : 2); completionStatusTable += `<tr><td colspan="${colspan}">학생 정보 없음</td></tr>`; } completionStatusTable += '</tbody></table>'; const pdfHtml = `<div ...><h1>${title} 이수현황표</h1>...<div>과목명:...</div><div>지도교사:...</div>${completionStatusTable}</div>`; await this.generatePdfFromHtml(pdfHtml, 'l', `${title}_이수현황표_${new Date().toISOString().slice(0, 10)}.pdf`); },
                async generateAttendancePdf(type) { /* ... remains the same ... */ const data = this.teacherGuidanceData[type]; if (!data || !this.role) return; const title = type === 'preventive' ? '예방지도' : '보충지도(추가학습)'; const savedSessions = data.sessions.filter(s => s && s.date); let attendanceTable = '<table...><thead>...</thead><tbody>'; if (data.students && data.students.length > 0) { data.students.forEach(student => { if (!student) return; attendanceTable += `<tr><td>${student.id}</td><td>${student.name}</td>`; savedSessions.forEach(session => { attendanceTable += `<td>${(session && session.attendance) ? (session.attendance[student.id] || '') : ''}</td>`; }); attendanceTable += '</tr>'; }); } else { attendanceTable += `<tr><td colspan="${savedSessions.length + 2}">학생 정보 없음</td></tr>`; } attendanceTable += '</tbody></table>'; const pdfHtml = `<div ...><h1>${title} 출석부</h1>...<div>과목명:...</div><div>지도교사:...</div>${attendanceTable}</div>`; await this.generatePdfFromHtml(pdfHtml, 'l', `${title}_출석부_${new Date().toISOString().slice(0, 10)}.pdf`); },
                async generateLessonLogPdf(type) { /* ... remains the same ... */ const data = this.teacherGuidanceData[type]; if (!data || !this.role) return; const title = type === 'preventive' ? '예방지도' : '보충지도(추가학습)'; let lessonLogHtml = ''; this.savedGuidanceSessions.forEach((session, index) => { if (!session) return; lessonLogHtml += `<div ...><h3>${index + 1}차시 ...</h3><p>장소: ${session.place || ''}</p><p>수업방법: ${[...new Set(Object.values(session.attendance || {}))].filter(Boolean).join(', ')}</p>...<div ...>${session.content || ''}</div></div>`; }); const pdfHtml = `<div ...><h1>${title} 수업일지</h1>...<div>과목명:...</div><div>지도교사:...</div><div>운영기간:...</div>${lessonLogHtml.length > 0 ? lessonLogHtml : '<p>저장된 수업일지 없음</p>'}</div>`; await this.generatePdfFromHtml(pdfHtml, 'p', `${title}_수업일지_${new Date().toISOString().slice(0, 10)}.pdf`); },
                closeImportModal() { /* ... remains the same ... */ this.showImportModal = false; this.importSubject = ''; this.importClasses = ['']; this.importModalError = ''; },
                addImportClassInput() { /* ... remains the same ... */ this.importClasses.push(''); },
                removeImportClassInput(index) { /* ... remains the same ... */ this.importClasses.splice(index, 1); },
                 importUnderachievers() { /* ... logic remains the same, uses deployedUnderachievers ... */
                     if (this.role !== '교과교사') return; this.importModalError = ''; const subject = this.teacherPlan.subjectName.trim(); if (!subject) { this.importModalError = '먼저 과목명을 입력하고 저장해주세요.'; return; } this.importSubject = subject; const classes = this.importClasses.map(c => c.trim()).filter(Boolean); if (classes.length === 0) { this.importModalError = '학급을 입력해주세요.'; return; } const allUnderachievers = this.deployedUnderachievers; if (!allUnderachievers || allUnderachievers.length === 0) { this.importModalError = '배포된 미도달 학생 명단 없음.'; return; }
                     const filteredStudents = allUnderachievers.filter(student => { if (!student || !student.id) return false; const studentClassId = student.id.substring(0, 3); const classMatch = classes.includes(studentClassId); if (!classMatch) return false; const gradeMatch = (student.gradeSubjects || []).some(s => s.name === subject); const attendanceMatch = (student.attendanceSubjects || []).includes(subject); return gradeMatch || attendanceMatch; }); if (filteredStudents.length === 0) { this.importModalError = '조건에 맞는 학생 없음.'; return; }
                     const newSupplementaryStudents = []; let addedCount = 0; const currentSuppStudents = this.teacherGuidanceData.supplementary.students; const currentSuppIds = new Set(currentSuppStudents.map(s => s.id)); // Get current IDs
                     filteredStudents.forEach(newStudent => { let reason = ''; const gradeMatch = (newStudent.gradeSubjects || []).some(s => s.name === subject); const attendanceMatch = (newStudent.attendanceSubjects || []).includes(subject); if (gradeMatch && attendanceMatch) reason = '학업성취율&과목출석률'; else if (gradeMatch) reason = '학업성취율'; else if (attendanceMatch) reason = '과목출석률';
                         // Add only if not already in the supplementary list
                         if (!currentSuppIds.has(newStudent.id)) {
                             newSupplementaryStudents.push({ id: newStudent.id, name: newStudent.name, reason: reason });
                             addedCount++;
                         }
                     });
                     if (addedCount > 0) {
                         // Add the new students to the existing list
                         this.teacherGuidanceData.supplementary.students.push(...newSupplementaryStudents);
                         this.teacherGuidanceData.supplementary.students.sort((a, b) => a.id.localeCompare(b.id)); // Sort combined list
                         // Update attendance objects in sessions
                         this.teacherGuidanceData.supplementary.sessions.forEach(session => { if (!session) return; if (!session.attendance) session.attendance = {}; newSupplementaryStudents.forEach(student => { if (student && !session.attendance.hasOwnProperty(student.id)) { session.attendance[student.id] = ''; } }); });
                         this.saveGuidanceData(); alert(`${addedCount}명의 학생을 추가했습니다.`); this.closeImportModal();
                     } else { this.importModalError = '새로 추가할 학생이 없습니다.'; }
                 },
                 resetSupplementaryStudents() { /* ... logic remains the same ... */ if (this.role !== '교과교사') return; if (this.teacherGuidanceData.supplementary) { this.teacherGuidanceData.supplementary.students = []; this.teacherGuidanceData.supplementary.sessions.forEach(session => { if(session) session.attendance = {}; }); this.saveGuidanceData(); } },

                 // --- Homeroom Teacher Methods ---
                 searchHomeroomClass(){ /* ... logic remains the same ... */ if(this.role !== '담임교사') return; this.homeroomMessage = ''; const classInput = this.homeroomClassInput.trim(); if(!classInput){ this.homeroomMessage = '학급 번호를 입력해주세요.'; this.searchedStudents = []; return; } const allStudents = this.deployedUnderachievers; if (!allStudents || allStudents.length === 0) { this.homeroomMessage = '배포된 학생 데이터 없음.'; this.searchedStudents = []; return; } const filtered = allStudents.filter(s => s && s.id && s.id.startsWith(classInput)); if(filtered.length > 0){ this.searchedStudents = filtered; this.homeroomMessage = `${classInput}반 미도달 학생 ${filtered.length}명 조회 완료.`; } else { this.searchedStudents = []; this.homeroomMessage = `해당 학급 학생 없음.`; } },
                 getSubjectCompletionStatus(studentId, subjectName){ /* ... logic remains the same ... */ if(this.role !== '담임교사') return { status: 'N/A', color: 'text-gray-500'}; return { status: '확인필요', color: 'text-gray-500'}; },
                 printHomeroomStudentForm(student, type) { /* ... logic remains the same ... */ if(this.role !== '담임교사') return; if (!this.newsletterForm.title || !this.pledgeForm.content) { alert("공용 양식 로드 안됨."); return; } const fullStudent = this.deployedUnderachievers.find(s => s.id === student.id); if (!fullStudent) { alert("학생 정보 찾을 수 없음."); return; } if (!fullStudent.gradeSubjects && !fullStudent.attendanceSubjects) { alert("미도달 과목 정보 없음."); return; } this.previewForm(type, [fullStudent]); },

                 // Helper to reset all local data states
                 resetAllLocalData() {
                     this.curriculumData = []; this.studentData = []; this.emotionalSupportData = []; this.deployedUnderachievers = []; this.underachievers = [];
                     this.resetTeacherData(); // Reset teacher specific data
                     Object.assign(this.moduleConfig, { hoursPerCredit: 1, preventiveRatio: 50, /* ... defaults ... */ });
                     Object.assign(this.newsletterForm, { title: '...', /* ... defaults ... */ }); Object.assign(this.pledgeForm, { content: '...', /* ... defaults ... */ });
                     this.uploadStatus = { curriculum: '', student: '', emotionalSupport: '' }; this.homeroomClassInput = ''; this.searchedStudents = []; this.homeroomMessage = ''; this.statusMessage = ''; this.moduleConfigStatus = ''; this.underachieversStatus = ''; this.teacherPlanStatus = ''; this.adminActionStatus = ''; console.log("Local data reset.");
                 },
                  // Helper to reset only teacher-specific data
                  resetTeacherData() {
                      Object.assign(this.teacherPlan, { aiProvider: 'gemini', apiKey: '', subjectName: '', teacherNames: [''], achievements: [{ text: '', statement: '', loading: false }], gradeCalculation: '추정분할점수', conductPrevention: 'X', preventionTarget: '', preventionMethods: [], preventionPeriod: [], preventionSessions: [{ plan: '' }], supplementaryMethods: [], supplementaryPeriod: [], supplementarySessions: [{ plan: '' }], maxSupplementaryHours: 0 });
                      this.teacherGuidanceData = { preventive: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })), error: ''}, supplementary: { students: [], sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })), error: ''} };
                      this.teacherPlanError = ''; this.teacherPlanStatus = ''; this.newGuidanceStudentId = '';
                      console.log("Teacher data reset.");
                  },
            },

            // --- Mounted Hook ---
            mounted() {
                this.initApp(); // Start the authentication listener
            }

        }).mount('#app'); // Mount the app

    </script>
</body>
</html>


