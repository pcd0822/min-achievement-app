<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>최소 성취수준 보장지도 관리 웹 앱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Inter', 'Pretendard', sans-serif; }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 500px;
        }
        /* A4 비율과 유사한 미리보기 모달창 스타일 */
        .modal-preview {
             width: 210mm; /* A4 width */
             max-width: 95%;
             max-height: 90vh; /* 높이 제한 */
             overflow-y: auto; /* 내용이 길면 스크롤 */
             padding: 0; /* 내부 패딩은 #print-area가 담당 */
        }
        /* 미리보기/인쇄 영역 스타일 */
        #print-area {
            font-family: 'Malgun Gothic', sans-serif;
            color: black;
            background: white;
            padding: 15mm; /* A4 여백과 유사한 패딩 */
            box-sizing: border-box;
            width: 100%; /* modal-preview 너비에 맞춤 */
        }
         #print-area h1, #print-area h3, #print-area h4 {
             margin-top: 1.5em;
             margin-bottom: 0.8em;
             font-weight: bold;
         }
         #print-area h1 { font-size: 1.8rem; text-align: center; }
         #print-area h3 { font-size: 1.2rem; }
         #print-area h4 { font-size: 1.0rem; }

         #print-area table {
             width: 100%;
             border-collapse: collapse;
             margin-top: 10px;
             font-size: 9pt;
             table-layout: fixed; /* 셀 너비 고정 */
         }
         #print-area th, #print-area td {
             border: 1px solid #666; /* 인쇄 시 잘 보이도록 어두운 테두리 */
             padding: 6px;
             text-align: center;
             vertical-align: middle;
             word-wrap: break-word; /* 긴 텍스트 줄바꿈 */
         }
          #print-area th {
              background-color: #f2f2f2;
          }
         /* 테이블 내 텍스트 왼쪽 정렬용 */
         #print-area .text-left {
             text-align: left;
         }
         /* 본문 내용 등 줄바꿈 유지를 위함 */
         #print-area .whitespace-pre-wrap {
            white-space: pre-wrap;
            word-break: break-all;
            text-align: left; /* 본문은 보통 왼쪽 정렬 */
            min-height: 150px; /* 본문 영역 최소 높이 */
         }
         #print-area .signature-section {
             margin-top: 50px;
             display: flex;
             justify-content: space-around;
             text-align: center;
             font-size: 1rem;
         }
         #print-area .seal-section {
            text-align: center;
            margin-top: 50px;
         }
         #print-area .seal-section img {
            width: 70px;
            height: 70px;
            margin: 0 auto;
         }
         #print-area .school-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 30px;
         }

        [v-cloak] { display: none; }

        .table-cell-content {
            padding: 0.5rem 0;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
        }

        .table-cell-content:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }

        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 30;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #4a5568;
            transition: all 0.2s ease-in-out;
        }
        .scroll-arrow:hover {
            background-color: rgba(255, 255, 255, 0.9);
            transform: translateY(-50%) scale(1.1);
        }
        .scroll-arrow.left { left: -1.25rem; }
        .scroll-arrow.right { right: -1.25rem; }

        /* 인쇄 전용 스타일 (안정적인 버전으로 수정) */
        @media print {
            /* 1. 기본 인쇄 설정 */
            body {
                margin: 0;
                padding: 0;
                background-color: white;
            }
            
            /* 2. 인쇄 불필요 UI 요소 명시적 숨기기 */
            #app > header, 
            #app > main,
            div[v-if="showAttendanceModal"],
            div[v-if="showImportModal"],
            div[v-if="showSchoolIdModal"], /* 학교 ID 모달 숨기기 */
            #print-area-container, /* html2canvas용 컨테이너 숨기기 */
            .modal-overlay .modal-content > div:not(#print-area-container-in-modal), /* 모달 내 버튼, 상태메시지 숨기기 */
            .scroll-arrow {
                display: none !important;
            }

            /* 3. 모달 관련 스타일 리셋 (인쇄 시 화면을 가리지 않도록) */
            .modal-overlay {
                position: static !important;
                background: none !important;
                overflow: visible !important;
                display: block !important;
                width: 100%; height: 100%; z-index: auto;
            }
            .modal-content {
                border: none !important; box-shadow: none !important;
                padding: 0 !important; width: 100% !important;
                max-width: 100% !important; max-height: none !important;
                overflow: visible !important; display: block !important;
            }
            
            /* 4. 인쇄할 컨테이너 및 내용 보이기 */
            #print-area-container-in-modal,
            #print-area-container-in-modal * {
                visibility: visible !important; /* visibility: visible로 되돌림 */
            }
            #print-area-container-in-modal {
                 display: block !important;
            }

            /* 5. 인쇄할 영역(#print-area) 스타일 리셋 */
            #print-area {
                padding: 0 !important; margin: 0 !important; /* @page 여백이 적용됨 */
                border: none !important; box-shadow: none !important;
                width: 100% !important; font-size: 10pt !important;
                color: black !important; background: white !important;
            }
            
            /* 6. 인쇄용 테이블/폰트 미세 조정 */
            #print-area table { font-size: 9pt !important; }
            #print-area th, #print-area td { padding: 5px !important; }

            /* 7. @page 설정 (A4 여백) */
            @page {
                size: A4 portrait;
                margin: 20mm;
            }
            .page-break {
                page-break-after: always !important;
            }
            img {
                 max-width: 100% !important;
                 height: auto !important;
                 visibility: visible !important;
             }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" v-cloak class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"/>
                        </svg>
                        <h1 class="ml-2 text-2xl font-bold text-gray-800">최소 성취수준 보장지도 관리</h1>
                    </div>
                     <!-- Login/Logout UI -->
                    <div v-if="isLoggedIn" class="flex items-center space-x-4">
                         <span class="text-gray-600 text-sm"> {{ user?.email }}</span>
                         <span v-if="role" class="text-gray-600 font-semibold">[{{ role }}] 모드</span>
                         <span v-if="schoolId" class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">ID: {{ schoolId }}</span>
                         <button @click="logout" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition text-sm">로그아웃</button>
                         <button v-if="role" @click="resetRole" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition text-sm">역할 재선택</button>
                         <button v-if="role === '관리자'" @click="openAdminModifyModal" class="ml-2 px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition text-sm">학교 코드 수정 및 발급</button>
                    </div>
                    <div v-else>
                         <button @click="login" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">Google 로그인</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Loading Indicator -->
             <div v-if="isLoading" class="text-center mt-10">
                 <p class="text-gray-600">데이터 로딩 중...</p>
             </div>

             <!-- Login Button -->
              <div v-if="!isLoggedIn && !isLoading" class="text-center mt-10">
                  <button @click="login" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition text-lg shadow-md">
                      Google 계정으로 로그인
                  </button>
                   <p class="mt-4 text-gray-600">로그인 후 서비스를 이용해주세요.</p>
              </div>


            <!-- Role Selection Modal (Show if logged in but no role) -->
            <div v-if="isLoggedIn && !role && !isLoading" class="modal-overlay">
                <div class="modal-content">
                    <h3 class="text-2xl font-bold mb-6 text-center">역할 선택</h3>
                    <div class="space-y-4">
                        <button @click="selectRole('교과교사')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">교과교사</button>
                        <button @click="selectRole('담임교사')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">담임교사</button>
                        <div>
                            <button @click="selectRole('관리자')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">관리자</button>
                            <div v-if="showAdminCodeInput" class="mt-2">
                                <input type="password" v-model="adminCode" @keyup.enter="submitAdminCode" placeholder="관리자 코드 입력 (0822)" class="w-full p-2 border rounded-md">
                                <button @click="submitAdminCode" class="w-full mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">확인</button>
                                <p v-if="adminCodeError" class="text-red-500 text-sm mt-1">{{ adminCodeError }}</p>
                            </div>
                        </div>
                    </div>
                    <p v-if="statusMessage" class="mt-4 text-center text-sm text-blue-600">{{ statusMessage }}</p>
                </div>
            </div>

            <!-- School ID Modal (Show if role selected, but no schoolId) -->
            <div v-if="showSchoolIdModal && !isLoading" class="modal-overlay">
                <div class="modal-content">
                    <h3 v-if="schoolIdMode === 'create'" class="text-2xl font-bold mb-4 text-center">학교 고유 ID 생성</h3>
                    <h3 v-else class="text-2xl font-bold mb-4 text-center">학교 고유 ID 입력</h3>

                    <p v-if="schoolIdMode === 'create'" class="text-sm text-gray-600 mb-4">
                        관리자 인증이 완료되었습니다. 이 학교에서 사용할 고유 ID를 생성하세요. 이 ID는 교사들에게 공유해야 합니다. (예: `korea_high_2025`)
                    </p>
                    <p v-else class="text-sm text-gray-600 mb-4">
                        학교 관리자에게 공유받은 '학교 고유 ID'를 입력하세요.
                    </p>
                    
                    <form @submit.prevent="handleSchoolIdSubmit" class="space-y-4">
                        <div>
                            <label for="school-id-input" class="sr-only">학교 고유 ID</label>
                            <input id="school-id-input" type="text" v-model="newSchoolId" placeholder="ID (예: korea_high_2025)" required class="w-full p-3 border border-gray-300 rounded-md">
                        </div>
                        <p v-if="schoolIdError" class="text-red-500 text-sm mt-1">{{ schoolIdError }}</p>
                        
                        <button type="submit" class="w-full px-6 py-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition">
                            <span v-if="schoolIdMode === 'create'">ID 생성하고 시작하기</span>
                            <span v-else>참여하기</span>
                        </button>
                    </form>
                </div>
            </div>

             <!-- Main Dashboard (Show only if logged in and role is selected) -->
             <div v-if="isLoggedIn && role && !isLoading">
                <!-- Admin View -->
                 <div v-if="role === '관리자'">
                      <h2 class="text-3xl font-bold text-gray-800 mb-6">관리자 대시보드 (학교 ID: {{ schoolId || 'null' }})</h2>
                      <div v-if="!schoolId" class="mb-6 p-4 bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500 rounded-md">
                          <p class="font-bold">안내</p>
                          <p>학교 ID가 설정되지 않았습니다. 데이터를 저장하거나 관리하려면 우측 상단의 '학교 코드 수정 및 발급' 버튼을 눌러 ID를 먼저 설정해주세요.</p>
                      </div>
                       <div class="space-y-8">
                           <!-- 1. 교육과정 편제표 업로드 -->
                           <div class="bg-white p-6 rounded-lg shadow-md">
                               <h3 class="text-xl font-semibold mb-4">1. 교육과정 편제표 업로드</h3>
                               <div class="flex space-x-4">
                                   <button @click="downloadTemplate('curriculum')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>
                                   <input type="file" @change="uploadFile($event, 'curriculum')" class="hidden" id="curriculum-upload-admin">
                                   <label for="curriculum-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</label>
                               </div>
                               <p v-if="uploadStatus.curriculum" class="mt-2 text-sm font-medium">{{ uploadStatus.curriculum }}</p>
                           </div>

                           <!-- 2. 학적 정보 업로드 -->
                           <div class="bg-white p-6 rounded-lg shadow-md">
                               <h3 class="text-xl font-semibold mb-4">2. 학적 정보 업로드</h3>
                               <div class="flex space-x-4">
                                   <button @click="downloadTemplate('student')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>
                                   <input type="file" @change="uploadFile($event, 'student')" class="hidden" id="student-upload-admin">
                                   <label for="student-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</label>
                               </div>
                                <p v-if="uploadStatus.student" class="mt-2 text-sm font-medium">{{ uploadStatus.student }}</p>
                           </div>

                            <!-- 2-1. 정서지원프로그램 이수시간 업로드 -->
                           <div class="bg-white p-6 rounded-lg shadow-md">
                               <h3 class="text-xl font-semibold mb-4">2-1. 정서지원프로그램 이수시간 업로드</h3>
                               <div class="flex space-x-4">
                                   <button @click="downloadTemplate('emotionalSupport')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>
                                   <input type="file" @change="uploadFile($event, 'emotionalSupport')" class="hidden" id="emotional-support-upload-admin">
                                   <label for="emotional-support-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</label>
                               </div>
                               <p v-if="uploadStatus.emotionalSupport" class="mt-2 text-sm font-medium">{{ uploadStatus.emotionalSupport }}</p>
                           </div>

                           <!-- 3. 운영 모듈 설계 -->
                           <div class="bg-white p-6 rounded-lg shadow-md">
                               <h3 class="text-xl font-semibold mb-4">3. 운영 모듈 설계</h3>
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">학점당 시수</label>
                                       <input type="number" v-model.number="moduleConfig.hoursPerCredit" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">예방지도 연계 비율 (%)</label>
                                       <input type="number" v-model.number="moduleConfig.preventiveRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">정서지원 프로그램 연계 비율 (%)</label>
                                       <input type="number" v-model.number="moduleConfig.emotionalSupportRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">학습지원대상자 예방지도 인정비율 (%)</label>
                                       <input type="number" v-model.number="moduleConfig.specialPreventiveRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                   </div>
                               </div>
                               <h4 class="text-lg font-semibold mt-6 mb-2">항목별 인정시수 (1회 기준)</h4>
                               <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                   <div v-for="(item, index) in moduleConfig.recognizedHours" :key="index">
                                       <label class="block text-sm font-medium text-gray-700">{{ item.name }}</label>
                                       <input type="number" step="0.1" v-model.number="item.hours" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                   </div>
                               </div>
                               <button @click="saveModuleConfig" class="mt-6 px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">운영 모듈 저장</button>
                                <p v-if="moduleConfigStatus" class="mt-2 text-sm font-medium text-green-600">{{ moduleConfigStatus }}</p>
                           </div>

                           <!-- 4. 대상자 선정 -->
                           <div class="bg-white p-6 rounded-lg shadow-md">
                               <h3 class="text-xl font-semibold mb-4">4. 대상자 선정</h3>
                               <div class="flex space-x-4">
                                   <input type="file" @change="processGradeFiles" multiple class="hidden" id="grade-upload">
                                   <label for="grade-upload" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">성적 파일 업로드 (복수 선택 가능)</label>
                                   <button @click="showAttendanceModal = true" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition">출석률 미도달 학생 입력</button>
                               </div>
                               <p v-if="fileProcessingError" class="mt-2 text-sm font-medium text-red-500">{{ fileProcessingError }}</p>

                               <div v-if="underachievers.length > 0" class="mt-6">
                                   <h4 class="text-lg font-semibold mb-2">학업성취율/출석률 미도달 학생 현황 (처리 결과)</h4>
                                   <div class="overflow-x-auto">
                                       <table class="min-w-full" id="underachievers-table">
                                           <thead class="bg-gray-50">
                                               <tr>
                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">학번</th>
                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이름</th>
                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">특기사항</th>
                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">미도달내역</th>
                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">미도달 과목(학점수)</th>
                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">보충지도(추가학습) 내역</th>
                                                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">조치</th>
                                               </tr>
                                           </thead>
                                           <tbody v-for="student in groupedUnderachievers" :key="student.id" class="bg-white">
                                               <tr v-for="(detail, detailIndex) in student.details" :key="student.id + detail.reason + detailIndex">
                                                   <td v-if="detailIndex === 0" :rowspan="student.details.length" class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ student.id }}</td>
                                                   <td v-if="detailIndex === 0" :rowspan="student.details.length" class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ student.name }}</td>
                                                   <td v-if="detailIndex === 0" :rowspan="student.details.length" class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ student.specialNotes }}</td>
                                                   <td class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ detail.reason }}</td>
                                                   <td class="px-6 py-4 whitespace-normal align-top border-b border-gray-200">{{ detail.subjects }}</td>
                                                   <td class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200">{{ detail.lessonDetails }}</td>
                                                   <td class="px-6 py-4 whitespace-nowrap align-top border-b border-gray-200 text-sm font-medium">
                                                       <button @click="deleteDetailGroup(detail)" class="text-red-600 hover:text-red-900">삭제</button>
                                                   </td>
                                               </tr>
                                           </tbody>
                                       </table>
                                   </div>
                                   <div class="mt-6 flex justify-end items-center space-x-4">
                                       <div class="relative">
                                           <button @click="toggleExportOptions" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">내보내기</button>
                                           <div v-if="showExportOptions" class="absolute right-0 bottom-full mb-2 w-48 bg-white rounded-md shadow-lg z-20">
                                               <a href="#" @click.prevent="exportTable('pdf')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">PDF로 저장</a>
                                               <a href="#" @click.prevent="exportTable('xlsx')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">XLSX 파일</a>
                                               <a href="#" @click.prevent="exportTable('csv')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CSV (Google Sheets용)</a>
                                           </div>
                                       </div>
                                       <button @click="deployUnderachievers" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">명단 확정 및 배포</button>
                                   </div>
                                   <p v-if="underachieversStatus" class="mt-2 text-right text-sm font-medium text-green-600">{{ underachieversStatus }}</p>
                               </div>
                           </div>

                           <!-- 5. 가정통신문 및 서약서 양식 관리 -->
                           <div class="bg-white p-6 rounded-lg shadow-md">
                               <h3 class="text-xl font-semibold mb-4">5. 가정통신문 및 서약서 양식 관리</h3>
                               <div class="flex border-b">
                                   <button class="tab-button" :class="{ 'active': adminFormTab === 'newsletter' }" @click="adminFormTab = 'newsletter'">가정통신문</button>
                                   <button class="tab-button" :class="{ 'active': adminFormTab === 'pledge' }" @click="adminFormTab = 'pledge'">서약서</button>
                               </div>

                               <!-- 가정통신문 폼 -->
                               <div v-if="adminFormTab === 'newsletter'" class="mt-6 space-y-4">
                                   <input type="text" v-model="newsletterForm.title" placeholder="제목" class="w-full p-2 border rounded">
                                   <input type="text" v-model="newsletterForm.docNumber" placeholder="문서 번호 (예: 한국고 2025-00호)" class="w-full p-2 border rounded">
                                   <input type="text" v-model="newsletterForm.department" placeholder="담당 부서 및 연락처" class="w-full p-2 border rounded">
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">학교 로고 이미지</label>
                                       <input type="file" @change="handleImageUpload($event, 'newsletter', 'logoUrl')" accept="image/*" class="w-full">
                                        <img v-if="newsletterForm.logoUrl" :src="newsletterForm.logoUrl" alt="로고 미리보기" class="mt-2 h-16 object-contain">
                                   </div>
                                   <textarea v-model="newsletterForm.body" placeholder="본문 내용" rows="10" class="w-full p-2 border rounded"></textarea>
                                   <input type="text" v-model="newsletterForm.dispatchDate" placeholder="발송일 (예: 2025.7.14.)" class="w-full p-2 border rounded">
                                   <div class="flex items-center space-x-2">
                                       <input type="checkbox" v-model="newsletterForm.includeSeal" id="newsletterSealCheck">
                                       <label for="newsletterSealCheck">학교장 날인 포함</label>
                                   </div>
                                   <div v-if="newsletterForm.includeSeal">
                                       <label class="block text-sm font-medium text-gray-700">학교장 날인 이미지</label>
                                       <input type="file" @change="handleImageUpload($event, 'newsletter', 'sealUrl')" accept="image/*" class="w-full">
                                        <img v-if="newsletterForm.sealUrl" :src="newsletterForm.sealUrl" alt="날인 미리보기" class="mt-2 h-16 object-contain">
                                   </div>
                                   <div class="flex space-x-2">
                                       <button @click="previewFormAdmin('newsletter')" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">미리보기 및 출력</button>
                                        <button @click="saveFormTemplates" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">양식 저장</button>
                                   </div>
                               </div>

                               <!-- 서약서 폼 -->
                                <div v-if="adminFormTab === 'pledge'" class="mt-6 space-y-4">
                                    <textarea v-model="pledgeForm.content" placeholder="서약서 동의 내용" rows="10" class="w-full p-2 border rounded"></textarea>
                                    <input type="text" v-model="pledgeForm.dispatchDate" placeholder="서약일 (예: 2025.7.14.)" class="w-full p-2 border rounded">
                                    <div class="flex items-center space-x-2">
                                        <input type="checkbox" v-model="pledgeForm.includeSeal" id="pledgeSealCheck">
                                        <label for="pledgeSealCheck">학교장 날인 포함</label>
                                    </div>
                                    <div v-if="pledgeForm.includeSeal">
                                        <label class="block text-sm font-medium text-gray-700">학교장 날인 이미지</label>
                                        <input type="file" @change="handleImageUpload($event, 'pledge', 'sealUrl')" accept="image/*" class="w-full">
                                         <img v-if="pledgeForm.sealUrl" :src="pledgeForm.sealUrl" alt="날인 미리보기" class="mt-2 h-16 object-contain">
                                    </div>
                                    <div class="flex space-x-2">
                                       <button @click="previewFormAdmin('pledge')" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">미리보기 및 출력</button>
                                        <button @click="saveFormTemplates" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">양식 저장</button>
                                    </div>
                                </div>
                           </div>
                       </div>
                 </div>

                <!-- Teacher View -->
                 <div v-if="role === '교과교사' && schoolId">
                       <h2 class="text-3xl font-bold text-gray-800 mb-6">교과교사 대시보드 (학교 ID: {{ schoolId }})</h2>
                       <div class="flex border-b mb-6">
                           <button class="tab-button" :class="{ 'active': teacherTab === 'plan' }" @click="switchTeacherTab('plan')">계획서 작성</button>
                           <button class="tab-button" :class="{ 'active': teacherTab === 'preventive' }" @click="switchTeacherTab('preventive')">예방지도 출석부 & 수업일지</button>
                           <button class="tab-button" :class="{ 'active': teacherTab === 'supplementary' }" @click="switchTeacherTab('supplementary')">보충지도(추가학습) 출석부&수업일지</button>
                       </div>

                       <!-- 계획서 작성 탭 -->
                       <div v-if="teacherTab === 'plan'" class="space-y-6">
                           <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                               <div>
                                   <label for="aiProvider" class="block text-sm font-medium text-gray-700">AI 모델 선택</label>
                                   <select id="aiProvider" v-model="teacherPlan.aiProvider" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                       <option value="gemini">Gemini</option>
                                       <option value="openai">OpenAI</option>
                                       <option value="claude">Claude</option>
                                   </select>
                               </div>
                               <div v-if="teacherPlan.aiProvider !== 'openai'">
                                   <label for="apiKey" class="block text-sm font-medium text-gray-700">{{ teacherPlan.aiProvider.toUpperCase() }} API Key</label>
                                   <input type="password" id="apiKey" v-model="teacherPlan.apiKey" placeholder="선택한 AI 모델의 API 키를 입력하세요" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                               </div>
                               <div>
                                   <label for="subjectName" class="block text-sm font-medium text-gray-700">과목명</label>
                                   <input type="text" id="subjectName" v-model="teacherPlan.subjectName" @change="handleSubjectChange" placeholder="편제표에 등록된 과목명을 정확히 입력하세요" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                               </div>
                               <div>
                                   <label class="block text-sm font-medium text-gray-700">교과교사명</label>
                                   <div v-for="(name, index) in teacherPlan.teacherNames" :key="index" class="flex items-center space-x-2 mt-2">
                                       <input type="text" v-model="teacherPlan.teacherNames[index]" placeholder="교과교사 이름을 입력하세요" class="w-full p-2 border border-gray-300 rounded-md">
                                       <button @click="removeTeacher(index)" v-if="teacherPlan.teacherNames.length > 1" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600">&times;</button>
                                   </div>
                                   <button @click="addTeacher" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 교과교사 추가</button>
                               </div>
                           </div>

                           <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                               <h3 class="text-lg font-semibold">성취기준 및 최소 성취수준 진술문</h3>
                               <div v-for="(achievement, index) in teacherPlan.achievements" :key="index" class="p-4 border rounded-md space-y-2">
                                   <label class="block text-sm font-medium text-gray-700">성취기준 {{ index + 1 }}</label>
                                   <textarea v-model="achievement.text" class="w-full p-2 border border-gray-300 rounded-md" rows="2"></textarea>
                                   <div class="flex items-center justify-between">
                                       <button @click="generateStatement(index)" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 disabled:bg-gray-400" :disabled="(teacherPlan.aiProvider !== 'openai' && !teacherPlan.apiKey) || achievement.loading">
                                           <span v-if="!achievement.loading">최소 성취수준 진술문 생성</span>
                                           <span v-else>생성 중...</span>
                                       </button>
                                       <button @click="removeAchievement(index)" class="px-3 py-1.5 bg-red-500 text-white text-sm rounded-md hover:bg-red-600">&times; 삭제</button>
                                   </div>
                                   <div v-if="achievement.statement" class="mt-2 p-2 bg-gray-100 rounded-md">
                                       <p class="text-sm font-semibold">최소 성취수준 진술문:</p>
                                       <p class="text-sm text-gray-800">{{ achievement.statement }}</p>
                                   </div>
                               </div>
                               <button @click="addAchievement" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 성취기준 추가</button>
                               <p v-if="teacherPlanError" class="text-red-500 text-sm mt-2">{{ teacherPlanError }}</p>
                           </div>

                           <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                               <h3 class="text-lg font-semibold">학기말 성적 산출 방법</h3>
                               <div class="flex space-x-4">
                                   <label><input type="radio" v-model="teacherPlan.gradeCalculation" value="추정분할점수"> 추정분할점수</label>
                                   <label><input type="radio" v-model="teacherPlan.gradeCalculation" value="고정분할점수"> 고정분할점수</label>
                               </div>
                           </div>

                           <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                               <h3 class="text-lg font-semibold">최소 성취수준 미도달 예방 지도 계획</h3>
                               <div class="flex space-x-4">
                                   <label><input type="radio" v-model="teacherPlan.conductPrevention" value="O"> 진행함</label>
                                   <label><input type="radio" v-model="teacherPlan.conductPrevention" value="X"> 진행하지 않음</label>
                               </div>
                               <div v-if="teacherPlan.conductPrevention === 'O'" class="space-y-4 pt-4 border-t">
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">예방지도 대상자 선정기준</label>
                                       <textarea v-model="teacherPlan.preventionTarget" rows="3" class="mt-1 block w-full p-2 border rounded-md"></textarea>
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">예방지도 방법 (복수선택 가능)</label>
                                       <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                                           <label v-for="method in moduleConfig.recognizedHours" :key="method.name" class="flex items-center space-x-2">
                                               <input type="checkbox" :value="method.name" v-model="teacherPlan.preventionMethods">
                                               <span>{{ method.name }}</span>
                                           </label>
                                       </div>
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">예방지도 운영 기간</label>
                                       <input type="text" class="flatpickr-range mt-1 block w-full p-2 border rounded-md" :value="teacherPlan.preventionPeriod | formatRangeDate">
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">차시별 지도 계획</label>
                                       <div v-for="(session, index) in teacherPlan.preventionSessions" :key="index" class="flex items-center space-x-2 mt-2">
                                           <span class="font-semibold">{{ index + 1 }}차시:</span>
                                           <input type="text" v-model="session.plan" class="w-full p-2 border rounded-md" placeholder="지도 계획을 입력하세요">
                                           <button @click="removePreventionSession(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">&times;</button>
                                       </div>
                                       <button @click="addPreventionSession" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 차시 추가</button>
                                   </div>
                               </div>
                           </div>

                           <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                               <h3 class="text-lg font-semibold">보충 지도 및 추가 학습 운영 계획</h3>
                               <div>
                                   <label class="block text-sm font-medium text-gray-700">보충지도/추가학습 방법 (복수선택 가능)</label>
                                   <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                                       <label v-for="method in moduleConfig.recognizedHours" :key="method.name" class="flex items-center space-x-2">
                                           <input type="checkbox" :value="method.name" v-model="teacherPlan.supplementaryMethods">
                                           <span>{{ method.name }}</span>
                                       </label>
                                   </div>
                               </div>
                               <div>
                                   <label class="block text-sm font-medium text-gray-700">보충지도/추가학습 운영 기간</label>
                                   <input type="text" class="flatpickr-range mt-1 block w-full p-2 border rounded-md" :value="teacherPlan.supplementaryPeriod | formatRangeDate">
                               </div>
                               <div>
                                   <label class="block text-sm font-medium text-gray-700">차시별 지도 계획 (최대 {{ teacherPlan.maxSupplementaryHours }}차시)</label>
                                   <div v-for="(session, index) in teacherPlan.supplementarySessions" :key="index" class="flex items-center space-x-2 mt-2">
                                       <span class="font-semibold">{{ index + 1 }}차시:</span>
                                       <input type="text" v-model="session.plan" class="w-full p-2 border rounded-md" placeholder="지도 계획을 입력하세요">
                                       <button @click="removeSupplementarySession(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">&times;</button>
                                   </div>
                                   <button @click="addSupplementarySession" :disabled="!teacherPlan.maxSupplementaryHours || teacherPlan.supplementarySessions.length >= teacherPlan.maxSupplementaryHours" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:bg-gray-400">+ 차시 추가</button>
                               </div>
                           </div>

                           <div class="text-center">
                                <button @click="saveTeacherPlan" class="mt-6 px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">계획안 저장</button>
                               <button @click="generatePlanPreview" class="mt-6 ml-4 px-8 py-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition text-lg">계획안 미리보기</button>
                                <p v-if="teacherPlanStatus" class="mt-2 text-sm text-green-600">{{ teacherPlanStatus }}</p>
                           </div>
                       </div>

                       <!-- 지도 출석부 & 수업일지 -->
                        <div v-if="currentGuidanceData && teacherTab !== 'plan'" class="space-y-8">
                           <div class="bg-white p-6 rounded-lg shadow-md flex justify-between items-start">
                               <h3 class="text-xl font-semibold">{{ teacherTab === 'preventive' ? '예방지도' : '보충지도(추가학습)' }} 출석부 & 수업일지</h3>
                               <div class="text-right">
                                   <p><strong>과목명:</strong> {{ teacherPlan.subjectName || '미입력' }}</p>
                                   <p><strong>교과교사:</strong> {{ formattedTeacherNames }}</p>
                                   <div class="mt-2 flex space-x-2">
                                       <button @click="generateCompletionStatusPdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">이수현황표 PDF</button>
                                       <button @click="generateAttendancePdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">출석부 PDF</button>
                                       <button @click="generateLessonLogPdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">수업일지 PDF</button>
                                   </div>
                               </div>
                           </div>

                           <!-- 이수현황표 -->
                           <div class="bg-white p-6 rounded-lg shadow-md">
                               <h4 class="text-lg font-semibold mb-4">{{ teacherTab === 'preventive' ? '예방지도' : '보충지도(추가학습)' }} 이수현황표</h4>
                               <div class="overflow-x-auto">
                                   <table class="min-w-full text-sm text-center">
                                       <thead class="bg-gray-50">
                                           <tr>
                                               <th class="p-2 border">학생</th>
                                               <th v-if="teacherTab === 'supplementary'" class="p-2 border">특기사항</th>
                                               <th v-if="teacherTab === 'supplementary'" class="p-2 border">미도달 항목</th>
                                               <th v-if="teacherTab === 'supplementary'" class="p-2 border">예방지도</th>
                                               <th v-if="teacherTab === 'supplementary'" class="p-2 border">정서지원프로그램</th>
                                               <th v-for="rh in moduleConfig.recognizedHours" :key="rh.name" class="p-2 border">{{ rh.name }}</th>
                                               <th class="p-2 border bg-gray-100">총계</th>
                                               <th v-if="teacherTab === 'supplementary'" class="p-2 border bg-gray-100">이수여부</th>
                                           </tr>
                                       </thead>
                                       <tbody>
                                           <tr v-for="student in currentGuidanceData.students" :key="student.id">
                                               <td class="p-2 border font-semibold whitespace-nowrap">{{ student.name }} ({{ student.id }})</td>
                                               <td v-if="teacherTab === 'supplementary'" class="p-2 border">
                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].specialNotes : '일반학생' }}
                                               </td>
                                               <td v-if="teacherTab === 'supplementary'" class="p-2 border">{{ student.reason }}</td>
                                               <td v-if="teacherTab === 'supplementary'" class="p-2 border">
                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].preventiveHours : 0 }}
                                               </td>
                                               <td v-if="teacherTab === 'supplementary'" class="p-2 border">
                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].emotionalSupportHours : 0 }}
                                               </td>
                                               <td v-for="rh in moduleConfig.recognizedHours" :key="rh.name" class="p-2 border">
                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id][rh.name] : 0 }}
                                               </td>
                                               <td class="p-2 border bg-gray-100 font-bold">
                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].total : 0 }}
                                               </td>
                                               <td v-if="teacherTab === 'supplementary'"
                                                   class="p-2 border font-bold"
                                                   :class="{
                                                       'text-green-600': guidanceCompletionStatus[student.id] && guidanceCompletionStatus[student.id].completionStatus === '이수',
                                                       'text-red-600': guidanceCompletionStatus[student.id] && guidanceCompletionStatus[student.id].completionStatus === '미이수'
                                                   }">
                                                   {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].completionStatus : '' }}
                                               </td>
                                           </tr>
                                            <tr v-if="!currentGuidanceData.students || currentGuidanceData.students.length === 0">
                                               <td :colspan="moduleConfig.recognizedHours.length + (teacherTab === 'supplementary' ? 7 : 2)" class="text-center p-4 text-gray-500">학생이 없습니다.</td>
                                           </tr>
                                       </tbody>
                                   </table>
                               </div>
                           </div>

                           <!-- 출석부 -->
                           <div class="bg-white p-6 rounded-lg shadow-md">
                               <h4 class="text-lg font-semibold mb-4">출석부</h4>
                               <div v-if="teacherTab === 'preventive'">
                                   <div class="flex space-x-2 mb-4">
                                       <input type="text" v-model="newGuidanceStudentId" @keyup.enter="addGuidanceStudent(teacherTab)" placeholder="학번 입력 후 Enter" class="p-2 border rounded-md w-48">
                                       <button @click="addGuidanceStudent(teacherTab)" class="px-4 py-2 bg-blue-500 text-white rounded-md">학생 추가</button>
                                   </div>
                                   <p v-if="currentGuidanceData.error" class="text-red-500 text-sm mb-4 -mt-2">{{ currentGuidanceData.error }}</p>
                               </div>
                               <div v-else class="mb-4">
                                    <div class="flex space-x-2">
                                        <button @click="showImportModal = true" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition">대상자 가져오기</button>
                                        <button @click="resetSupplementaryStudents" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">대상자 초기화</button>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-600">관리자가 배포한 미도달 학생 명단에서 과목, 학급별로 대상자를 검색하여 가져옵니다.</p>
                               </div>

                               <div class="relative">
                                   <button @click="scrollAttendance('left', $event)" class="scroll-arrow left">‹</button>
                                   <div class="overflow-x-auto">
                                       <table class="min-w-full text-sm border-collapse">
                                           <thead>
                                               <tr class="text-center">
                                                   <th class="sticky left-0 bg-gray-100 z-20 p-2 border-y border-l border-r border-gray-300 w-[80px]">학번</th>
                                                   <th class="sticky left-[50px] bg-gray-100 z-20 p-2 border-y border-r border-gray-300 w-[96px] whitespace-nowrap">이름</th>
                                                   <th v-for="(session, index) in currentGuidanceData.sessions" :key="index" class="p-2 border border-gray-300 min-w-[150px]">
                                                       <div class="flex items-center justify-center space-x-2 mb-2">
                                                           <p class="font-bold">{{ index + 1 }}차시</p>
                                                           <button v-if="session.isSaved" @click="toggleSaveSession(session)" title="수정" class="p-1 hover:bg-gray-200 rounded">
                                                               <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                                           </button>
                                                       </div>
                                                       <input type="text" class="flatpickr-single w-full p-1 border rounded text-center text-xs mb-1" placeholder="날짜 선택" :value="session.date" @change="session.date = $event.target.value; saveGuidanceData()" :disabled="session.isSaved">
                                                       <input type="text" class="w-full p-1 border rounded text-center text-xs" placeholder="예: 16:00~17:00" v-model="session.time" @change="saveGuidanceData" :disabled="session.isSaved">
                                                       <button v-if="!session.isSaved" @click="toggleSaveSession(session)" :disabled="!isSessionReadyToSave(session)" class="w-full mt-1 px-2 py-1 text-xs rounded text-white bg-green-500 hover:bg-green-600 disabled:bg-gray-400">저장</button>
                                                   </th>
                                               </tr>
                                           </thead>
                                           <tbody>
                                               <tr v-for="student in currentGuidanceData.students" :key="student.id" class="text-center">
                                                   <td class="sticky left-0 bg-white z-20 p-2 border-l border-r border-b border-gray-300">{{ student.id }}</td>
                                                   <td class="sticky left-[50px] bg-white z-20 p-2 border-r border-b border-gray-300 font-semibold whitespace-nowrap">{{ student.name }}</td>
                                                   <td v-for="(session, index) in currentGuidanceData.sessions" :key="index" class="p-2 border border-gray-300">
                                                       <select class="w-full p-1 border rounded text-xs" v-model="session.attendance[student.id]" :disabled="session.isSaved" @change="saveGuidanceData">
                                                           <option value="">선택</option>
                                                           <option v-for="rh in moduleConfig.recognizedHours" :key="rh.name" :value="rh.name">{{ rh.name }}</option>
                                                       </select>
                                                   </td>
                                               </tr>
                                               <tr v-if="!currentGuidanceData.students || currentGuidanceData.students.length === 0">
                                                   <td :colspan="(currentGuidanceData.sessions?.length || 0) + 2" class="text-center p-4 border border-gray-300 text-gray-500">학생을 추가해주세요.</td>
                                               </tr>
                                           </tbody>
                                       </table>
                                   </div>
                                   <button @click="scrollAttendance('right', $event)" class="scroll-arrow right">›</button>
                               </div>
                               <button @click="addGuidanceSession(teacherTab)" class="mt-4 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm">+ 차시 추가</button>
                           </div>

                           <!-- 수업일지 -->
                           <div class="bg-white p-6 rounded-lg shadow-md">
                               <h4 class="text-lg font-semibold mb-4">수업일지</h4>
                               <div class="mb-6 p-4 border rounded-md bg-gray-50 grid grid-cols-2 gap-4 text-sm">
                                   <div><strong>과목명:</strong> {{ teacherPlan.subjectName || '미입력' }}</div>
                                   <div><strong>운영차시:</strong> {{ savedGuidanceSessions.length }} 차시</div>
                                   <div><strong>지도교사:</strong> {{ formattedTeacherNames }}</div>
                                   <div><strong>운영기간:</strong> {{ guidanceOperationPeriod }}</div>
                               </div>
                               <div class="space-y-4">
                                   <div v-for="(session, index) in savedGuidanceSessions" :key="session.date + index" class="p-4 border rounded-md">
                                       <p class="font-bold mb-2">{{ index + 1 }}차시 수업일지 ({{ session.date }} / {{ session.time }})</p>
                                       <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                           <p><strong>수업방법:</strong> {{ [...new Set(Object.values(session.attendance || {}))].filter(Boolean).join(', ') }}</p>
                                           <div class="flex items-center">
                                               <label class="font-semibold mr-2 shrink-0">장소:</label>
                                               <input type="text" class="w-full p-1 border rounded" v-model="session.place" @change="saveGuidanceData">
                                           </div>
                                       </div>
                                       <div class="mt-2">
                                           <label class="font-semibold text-sm">지도내용:</label>
                                           <textarea rows="3" class="w-full p-1 border rounded mt-1 text-sm" v-model="session.content" @change="saveGuidanceData"></textarea>
                                       </div>
                                   </div>
                                   <p v-if="savedGuidanceSessions.length === 0" class="text-center text-gray-500">저장된 수업일지가 없습니다.</p>
                               </div>
                           </div>
                       </div>
                        <!-- Message when teacher tab is not 'plan' but guidance data isn't ready -->
                        <div v-if="teacherTab !== 'plan' && !teacherPlan.subjectName" class="text-center text-gray-500 mt-10">
                            <p>출석부 및 수업일지를 보려면 먼저 '계획서 작성' 탭에서 과목명을 입력하고 저장해주세요.</p>
                        </div>
                 </div>

                 <!-- Homeroom Teacher View -->
                  <div v-if="role === '담임교사' && schoolId" class="space-y-6">
                      <h2 class="text-3xl font-bold text-gray-800">담임교사 대시보드 (학교 ID: {{ schoolId }})</h2>
                      <div class="bg-white p-6 rounded-lg shadow-md">
                          <div class="flex items-end space-x-2">
                              <div class="flex-grow">
                                  <label for="homeroom-class-input" class="block text-sm font-medium text-gray-700">학급 번호 입력</label>
                                  <input id="homeroom-class-input" type="text" v-model="homeroomClassInput" @keyup.enter="searchHomeroomClass" placeholder="예: 101" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                              </div>
                              <button @click="searchHomeroomClass" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">조회</button>
                          </div>
                          <p v-if="homeroomMessage" class="mt-2 text-sm text-gray-600">{{ homeroomMessage }}</p>
                      </div>

                      <div v-if="processedHomeroomStudents.length > 0" class="bg-white p-6 rounded-lg shadow-md">
                          <h3 class="text-xl font-semibold mb-4">{{ homeroomClassInput }}반 미도달 학생 현황</h3>
                           <p class="mb-4 text-sm text-yellow-700 bg-yellow-100 p-2 rounded-md">참고: '이수 현황'은 교과교사가 데이터를 아직 저장하지 않았거나, 실시간 데이터가 아닐 수 있습니다. 정확한 정보는 해당 과목 교과교사에게 문의하세요.</p>
                          <div class="overflow-x-auto">
                              <table class="min-w-full text-sm">
                                  <thead class="bg-gray-50">
                                      <tr>
                                          <th class="p-2 border">학번</th>
                                          <th class="p-2 border">이름</th>
                                          <th class="p-2 border">미도달 과목</th>
                                          <th class="p-2 border">미도달 내역</th>
                                          <th class="p-2 border">이수 현황 (참고용)</th>
                                          <th class="p-2 border">서류 출력</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <template v-for="(row, index) in processedHomeroomStudents" :key="row.id + row.subject + index">
                                          <tr>
                                              <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="p-2 border align-top text-center">{{ row.id }}</td>
                                              <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="p-2 border align-top text-center">{{ row.name }}</td>
                                              <td class="p-2 border">{{ row.subject }}</td>
                                              <td class="p-2 border text-center">{{ row.reason }}</td>
                                              <td class="p-2 border text-center font-bold" :class="row.statusColor">{{ row.status }}</td>
                                              <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="p-2 border align-top text-center">
                                                  <div class="flex flex-col space-y-2">
                                                      <button @click="printHomeroomStudentForm(row.originalStudent, 'newsletter')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded-md hover:bg-blue-600">가정통신문</button>
                                                      <button @click="printHomeroomStudentForm(row.originalStudent, 'pledge')" class="px-2 py-1 bg-green-500 text-white text-xs rounded-md hover:bg-green-600">서약서</button>
                                                  </div>
                                              </td>
                                          </tr>
                                      </template>
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
             </div>
        </main>

        <!-- Modals -->
        <!-- Attendance Modal (Restored for Admin) -->
         <div v-if="showAttendanceModal" class="modal-overlay" @click.self="closeAttendanceModal">
             <div class="modal-content">
                 <h3 class="text-xl font-bold mb-4">출석률 미도달 학생 추가</h3>
                 <form @submit.prevent="addAttendanceStudent">
                     <div class="space-y-4">
                         <input v-model="newAttendanceStudent.id" placeholder="학번" required class="w-full p-2 border rounded-md">

                         <div v-for="(subject, index) in newAttendanceStudent.subjects" :key="index" class="flex items-center space-x-2">
                             <input v-model="newAttendanceStudent.subjects[index]" placeholder="출석률 미도달 과목" required class="w-full p-2 border rounded-md">
                             <button type="button" v-if="newAttendanceStudent.subjects.length > 1" @click="removeAttendanceSubject(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">-</button>
                         </div>
                          <button type="button" @click="addAttendanceSubject" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+</button>
                     </div>
                     <p v-if="attendanceModalError" class="text-red-500 text-sm mt-2">{{ attendanceModalError }}</p>
                     <div class="mt-6 flex justify-end space-x-2">
                         <button type="button" @click="closeAttendanceModal" class="px-4 py-2 bg-gray-300 rounded-md">취소</button>
                         <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md">추가</button>
                     </div>
                 </form>
             </div>
         </div>


        <!-- Preview Modal -->
        <div v-if="showPreviewModal" class="modal-overlay" @click.self="closePreviewModal">
            <div class="modal-content modal-preview"> <!-- Apply A4-like width -->
                 <!-- Container for printable content -->
                 <div id="print-area-container-in-modal"> <!-- ID for print media query -->
                    <div v-html="previewHtml"></div>
                 </div>
                 <!-- Combined status display -->
                <p v-if="statusText" class="text-sm mt-4 text-center font-semibold" :class="statusClass">{{ statusText }}</p>
                <div class="mt-6 flex justify-end space-x-2">
                    <button @click="closePreviewModal" class="px-4 py-2 bg-gray-300 rounded-md">닫기</button>
                     <!-- Use window.print() for native PDF generation/printing -->
                     <button @click="printPreviewModalContent" class="px-4 py-2 bg-indigo-600 text-white rounded-md">인쇄 / PDF 저장</button>
                </div>
            </div>
        </div>

         <!-- Import Modal (Restored for Teacher) -->
          <div v-if="showImportModal" class="modal-overlay" @click.self="closeImportModal">
             <div class="modal-content">
                 <h3 class="text-xl font-bold mb-4">보충지도 대상자 가져오기</h3>
                 <form @submit.prevent="importUnderachievers">
                     <div class="space-y-4">
                        <!-- MODIFIED: Input is now disabled and bound to teacherPlan.subjectName -->
                         <label class="block text-sm font-medium text-gray-700">과목명</label>
                         <input :value="teacherPlan.subjectName" placeholder="먼저 '계획서 작성' 탭에서 과목명을 입력하세요" required class="w-full p-2 border rounded-md bg-gray-100" disabled>
                         <div>
                             <label class="block text-sm font-medium text-gray-700">학급</label>
                             <p class="text-xs text-gray-500 mb-2">한 칸에 하나의 학급만 입력해주세요. (예: 101)</p>
                             <div v-for="(classNum, index) in importClasses" :key="index" class="flex items-center space-x-2 mb-2">
                                 <input v-model="importClasses[index]" placeholder="학급 입력" required class="w-full p-2 border rounded-md">
                                 <button type="button" v-if="importClasses.length > 1" @click="removeImportClassInput(index)" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600">-</button>
                             </div>
                             <button type="button" @click="addImportClassInput" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 학급 추가</button>
                         </div>
                     </div>
                     <p v-if="importModalError" class="text-red-500 text-sm mt-2">{{ importModalError }}</p>
                     <div class="mt-6 flex justify-end space-x-2">
                         <button type="button" @click="closeImportModal" class="px-4 py-2 bg-gray-300 rounded-md">취소</button>
                         <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md" :disabled="!teacherPlan.subjectName">가져오기</button>
                     </div>
                 </form>
             </div>
         </div>

        <!-- NEW: Admin Modify Modal (SchoolId & Admin Code) -->
        <div v-if="showAdminModifyModal" class="modal-overlay" @click.self="showAdminModifyModal = false">
            <div class="modal-content">
                <h3 class="text-2xl font-bold mb-4 text-center">학교 코드 수정 및 발급</h3>
                <div class="mb-4">
                    <label for="modify-mode" class="block text-sm font-medium text-gray-700">수정 항목</label>
                    <select id="modify-mode" v-model="adminModifyMode" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="schoolId">학교 ID</option>
                        <option value="adminCode">관리자 코드</option>
                    </select>
                </div>

                <!-- 학교 ID 수정 -->
                <div v-if="adminModifyMode === 'schoolId'">
                    <p class="text-sm text-gray-600 mb-2">현재 학교 ID: <strong class="text-indigo-600">{{ schoolId || '설정되지 않음' }}</strong></p>
                    <p class="text-sm text-gray-600 mb-2">새로운 학교 ID를 입력(발급)하거나, 다른 학교 ID로 변경할 수 있습니다. <br/> <strong class="text-red-600">주의: 변경 시, 해당 학교 ID의 데이터로 즉시 전환됩니다.</strong></p>
                    <input type="text" v-model="newSchoolIdForModify" placeholder="새 학교 ID 입력" class="w-full p-3 border border-gray-300 rounded-md">
                </div>
                
                <!-- 관리자 코드 확인 -->
                <div v-if="adminModifyMode === 'adminCode'">
                    <p class="text-sm text-gray-600 mb-2">현재 앱의 관리자 코드는 <strong class="text-indigo-600">'0822'</strong> 입니다.</p>
                    <p class="text-sm text-gray-600 mb-2">이 코드는 앱에 고정되어 있으며, 모든 학교 관리자가 동일하게 사용합니다. (변경 불가)</p>
                </div>

                <p v-if="adminModifyError" class="text-red-500 text-sm mt-2">{{ adminModifyError }}</p>
                
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" @click="showAdminModifyModal = false" class="px-4 py-2 bg-gray-300 rounded-md">닫기</button>
                    <button v-if="adminModifyMode === 'schoolId'" type="button" @click="saveAdminSchoolIdModification" class="px-4 py-2 bg-indigo-600 text-white rounded-md">학교 ID 저장</button>
                </div>
            </div>
        </div>    
        
        <!-- 인쇄용 컨테이너 (숨김 - html2canvas 전용) -->
        <div id="print-area-container" class="hidden"></div>

    </div>

    <script type="module">
        // Vue 3 CDN
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD_KHsc9Izjj38b44-2GcH1YDKoQ9Sek1k",
            authDomain: "min-achievement-app-184d2.firebaseapp.com",
            projectId: "min-achievement-app-184d2",
            storageBucket: "min-achievement-app-184d2.appspot.com",
            messagingSenderId: "177231838739",
            appId: "1:177231838739:web:7e2f2b2cf20d8e4e2949e6",
            measurementId: "G-4GT4CZRPXB"
        };

        // --- Initialize Firebase ---
        let firebaseApp, auth, db;
        try {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Firebase 초기화 중 오류가 발생했습니다. 페이지를 새로고침하거나 관리자에게 문의하세요.");
        }


        createApp({
            data() {
                return {
                    // --- Authentication State ---
                    user: null,
                    isLoggedIn: false,
                    isLoading: true,

                    // --- Role Management State ---
                    role: null,
                    schoolId: null,
                    showAdminCodeInput: false,
                    adminCode: '',
                    adminCodeError: '',
                    showSchoolIdModal: false,
                    schoolIdMode: 'join',
                    newSchoolId: '',
                    schoolIdError: '',

                    // --- UI State ---
                    teacherTab: 'plan',
                    adminFormTab: 'newsletter',
                    uploadStatus: { curriculum: '', student: '', emotionalSupport: '' },
                    statusMessage: '',
                    moduleConfigStatus: '',
                    underachieversStatus: '',
                    teacherPlanStatus: '',
                    adminActionStatus: '',

                    // --- Admin Modify Modal State ---
                    showAdminModifyModal: false,
                    adminModifyMode: 'schoolId',
                    newSchoolIdForModify: '',
                    adminModifyError: '',
                    
                    // --- Common Data (Loaded from Firestore) ---
                    moduleConfig: {
                        hoursPerCredit: 1,
                        preventiveRatio: 50,
                        emotionalSupportRatio: 20,
                        specialPreventiveRatio: 30,
                        recognizedHours: [
                            { name: '수업시간별도지도', hours: 1 }, { name: '온라인콘텐츠수강', hours: 1 },
                            { name: 'RunUP과정수강', hours: 1 }, { name: '학습멘토링', hours: 1 },
                            { name: '대면지도', hours: 1 }, { name: '보충과제부여', hours: 1 }
                        ]
                    },
                    newsletterForm: {
                        title: '최소 성취수준 보장지도 참여 안내', docNumber: '교무기획부-000', department: '담당부서 (연락처)',
                        logoUrl: null, body: '학부모님, 안녕하십니까?\n\n귀 자녀는 다음과 같은 사유로 최소 성취수준 보장지도 대상자로 선정되었음을 알려드립니다. 본교에서는 학생의 학업 능력 향상을 위해 보충 학습 프로그램을 운영하고 있으니, 학생이 프로그램에 성실히 참여할 수 있도록 가정에서도 많은 격려와 지도 부탁드립니다.\n\n[대상 학생 정보는 하단 참조]', dispatchDate: 'YYYY.MM.DD.', includeSeal: false, sealUrl: null
                    },
                    pledgeForm: {
                        content: '본인은 최소 성취수준 보장지도 프로그램의 모든 활동에 성실하게 참여할 것을 서약합니다.\n\n[대상 학생 정보는 하단 참조]', dispatchDate: 'YYYY.MM.DD.', includeSeal: false, sealUrl: null
                    },
                    curriculumData: [],
                    studentData: [],
                    emotionalSupportData: [],
                    deployedUnderachievers: [],

                    // --- Admin Specific Local State ---
                    underachievers: [],
                    fileProcessingError: '',
                    showAttendanceModal: false,
                    newAttendanceStudent: { id: '', subjects: [''] },
                    attendanceModalError: '',
                    showExportOptions: false,

                    // --- Teacher Specific State ---
                    showImportModal: false,
                    importClasses: [''],
                    importModalError: '',
                    teacherPlan: this.getInitialTeacherPlan(),
                    teacherPlanError: '',
                    teacherGuidanceData: this.getInitialGuidanceData(),
                    newGuidanceStudentId: '',

                    // --- Homeroom Teacher State ---
                    homeroomClassInput: '',
                    searchedStudents: [],
                    homeroomMessage: '',

                    // --- Preview Modal State ---
                    showPreviewModal: false,
                    previewHtml: '',
                }
            },

            computed: {
                statusText() {
                    return this.teacherPlanError || this.adminActionStatus || this.moduleConfigStatus || this.underachieversStatus || this.teacherPlanStatus || '';
                },
                statusClass() {
                    const text = this.statusText;
                    if (text.includes('오류') || text.includes('실패')) return 'text-red-500';
                    if (text.includes('완료') || text.includes('성공') || text.includes('저장됨') || text.includes('배포됨')) return 'text-green-600';
                    if (text.includes('중')) return 'text-blue-600';
                    return 'text-gray-600';
                },
                formattedTeacherNames() {
                    if (!this.teacherPlan || !this.teacherPlan.teacherNames) return '';
                    return this.teacherPlan.teacherNames
                        .map(name => name ? name.trim() : '')
                        .filter(name => name)
                        .map(name => `${name} (인)`)
                        .join(', ');
                },
                groupedUnderachievers() {
                    if (this.role !== '관리자') return [];
                    const result = [];
                    this.underachievers.forEach(student => {
                         if (!student || !student.id) return;
                        const studentInfo = this.studentData.find(s => String(s.학번) === student.id);
                        const specialNotes = (studentInfo && studentInfo.특기사항) ? studentInfo.특기사항 : '일반학생';

                        const studentEntry = { id: student.id, name: student.name, specialNotes: specialNotes, details: [] };
                        const subjectsByReason = new Map();
                        const allSubjects = new Map();

                        (student.gradeSubjects || []).forEach(subject => {
                             if (!subject || !subject.name) return;
                            if (!allSubjects.has(subject.name)) {
                                allSubjects.set(subject.name, { grade: true, attendance: false, credits: subject.credits });
                            } else { allSubjects.get(subject.name).grade = true; }
                        });
                        (student.attendanceSubjects || []).forEach(subjectName => {
                             if (!subjectName) return;
                            if (!allSubjects.has(subjectName)) {
                                const curriculumInfo = this.curriculumData.find(c => c.과목명 === subjectName);
                                const credits = curriculumInfo ? curriculumInfo.학점 : 'N/A';
                                allSubjects.set(subjectName, { grade: false, attendance: true, credits: credits });
                            } else { allSubjects.get(subjectName).attendance = true; }
                        });

                        allSubjects.forEach((details, subjectName) => {
                            let reason = '';
                            if (details.grade && details.attendance) reason = '학업성취율&과목출석률';
                            else if (details.grade) reason = '학업성취율';
                            else if (details.attendance) reason = '과목출석률';

                            if (reason) {
                                if (!subjectsByReason.has(reason)) subjectsByReason.set(reason, []);
                                subjectsByReason.get(reason).push({ name: subjectName, ...details });
                            }
                        });

                        subjectsByReason.forEach((subjectsArray, reason) => {
                            const consolidatedSubjects = subjectsArray.map(s => `${s.name}(${s.credits}학점)`).join(', ');
                            const lessonType = subjectsArray.some(s => s.grade) ? '보충지도' : '추가학습';
                             const hoursText = this.moduleConfig.hoursPerCredit ? `*${this.moduleConfig.hoursPerCredit}시수` : '';
                             const lessonDetails = `${lessonType}(과목 학점수${hoursText})`;

                            studentEntry.details.push({
                                reason: reason, subjects: consolidatedSubjects, lessonDetails: lessonDetails,
                                originalSubjects: subjectsArray, id: student.id, name: student.name
                            });
                        });

                        if (studentEntry.details.length > 0) result.push(studentEntry);
                    });
                     result.sort((a, b) => a.id.localeCompare(b.id));
                    return result;
                },
                currentGuidanceData() {
                    if (this.role !== '교과교사') return null;
                    if (this.teacherTab === 'preventive' || this.teacherTab === 'supplementary') {
                        if (!this.teacherGuidanceData[this.teacherTab]) {
                            this.teacherGuidanceData[this.teacherTab] = this.getInitialGuidanceData()[this.teacherTab];
                        }
                        return this.teacherGuidanceData[this.teacherTab];
                    }
                    return null;
                },
                guidanceCompletionStatus() {
                    const data = this.currentGuidanceData;
                     if (!this.role || !data || !data.students) return {};

                     const preventiveTotals = {};
                    const preventiveData = this.teacherGuidanceData.preventive;
                     if (preventiveData && preventiveData.sessions) {
                         preventiveData.sessions.forEach(session => {
                             if (session && session.isSaved && session.attendance) {
                                 for (const studentId in session.attendance) {
                                     const methodName = session.attendance[studentId];
                                     if (methodName) {
                                         const methodConfig = this.moduleConfig.recognizedHours.find(m => m.name === methodName);
                                         if (methodConfig) {
                                             if (!preventiveTotals[studentId]) preventiveTotals[studentId] = 0;
                                             preventiveTotals[studentId] += methodConfig.hours;
                                         }
                                     }
                                 }
                             }
                         });
                     }

                    const status = {};
                    let requiredHoursForCompletion = 0;
                    let maxEmotionalSupportHours = 0;
                    let supplementaryHours = 0;
                    let requiredSubjectCredits = 0;

                    if (this.teacherPlan.subjectName) {
                        const subjectInfo = this.curriculumData.find(s => s.과목명 === this.teacherPlan.subjectName);
                        if (subjectInfo) {
                             requiredSubjectCredits = Number(subjectInfo.학점) || 0;
                             supplementaryHours = requiredSubjectCredits * this.moduleConfig.hoursPerCredit;
                             requiredHoursForCompletion = Math.ceil((supplementaryHours * 2) / 3 * 10) / 10;
                             maxEmotionalSupportHours = supplementaryHours * (this.moduleConfig.emotionalSupportRatio / 100);
                        }
                    }

                     data.students.forEach(student => {
                         if (!student || !student.id) return;
                         status[student.id] = { name: student.name };
                         const studentInfo = this.studentData.find(s => String(s['학번']) === student.id);
                         status[student.id].specialNotes = (studentInfo && studentInfo['특기사항']) ? studentInfo['특기사항'] : '일반학생';
                         this.moduleConfig.recognizedHours.forEach(rh => {
                             status[student.id][rh.name] = 0;
                         });
                         status[student.id].total = 0;
                         if (this.teacherTab === 'supplementary') {
                             status[student.id].preventiveHours = 0;
                             status[student.id].emotionalSupportHours = 0;
                             status[student.id].completionStatus = '미이수';
                         }
                     });

                     if (data.sessions) {
                         data.sessions.forEach(session => {
                             if (session && session.isSaved && session.attendance) {
                                 for (const studentId in session.attendance) {
                                     if (!status[studentId]) continue;
                                     const methodName = session.attendance[studentId];
                                     if (methodName) {
                                         const methodConfig = this.moduleConfig.recognizedHours.find(m => m.name === methodName);
                                         if (methodConfig) {
                                             status[studentId][methodName] = parseFloat((status[studentId][methodName] + methodConfig.hours).toFixed(2));
                                             if (this.teacherTab === 'preventive') {
                                                 status[studentId].total = parseFloat((status[studentId].total + methodConfig.hours).toFixed(2));
                                             }
                                         }
                                     }
                                 }
                             }
                         });
                     }

                     if (this.teacherTab === 'supplementary' && requiredSubjectCredits > 0) {
                         data.students.forEach(student => {
                             if (!student || !status[student.id]) return;

                             let currentStudentTotal = 0;
                             this.moduleConfig.recognizedHours.forEach(rh => {
                                 currentStudentTotal += (status[student.id][rh.name] || 0);
                             });

                            const totalPreventiveHoursForStudent = preventiveTotals[student.id] || 0;
                             if (totalPreventiveHoursForStudent > 0) {
                                 const studentInfo = this.studentData.find(s => String(s['학번']) === student.id);
                                 const isSpecialSupport = studentInfo && studentInfo['특기사항'] === '학습지원대상';
                                let maxAllowedHours = 0;
                                let creditedPreventiveHours = 0;
                                 if (isSpecialSupport) {
                                     maxAllowedHours = supplementaryHours * (this.moduleConfig.specialPreventiveRatio / 100);
                                     creditedPreventiveHours = Math.min(totalPreventiveHoursForStudent, maxAllowedHours);
                                 } else {
                                    maxAllowedHours = supplementaryHours * (this.moduleConfig.preventiveRatio / 100);
                                     creditedPreventiveHours = Math.floor(Math.min(totalPreventiveHoursForStudent, maxAllowedHours));
                                 }
                                 status[student.id].preventiveHours = parseFloat(creditedPreventiveHours.toFixed(2));
                                 currentStudentTotal += creditedPreventiveHours;
                             }

                            const emotionalData = this.emotionalSupportData.find(e => String(e['학번']) === student.id);
                            const uploadedHours = emotionalData ? Number(emotionalData['정서지원프로그램 참여시간']) : 0;
                            const creditedEmotionalHours = Math.min(uploadedHours, maxEmotionalSupportHours);
                             status[student.id].emotionalSupportHours = parseFloat(creditedEmotionalHours.toFixed(2));
                             currentStudentTotal += creditedEmotionalHours;

                            status[student.id].total = parseFloat(currentStudentTotal.toFixed(2));
                             const tolerance = 0.001;
                             if (requiredHoursForCompletion > 0 && status[student.id].total >= requiredHoursForCompletion - tolerance) {
                                 status[student.id].completionStatus = '이수';
                             } else {
                                 status[student.id].completionStatus = '미이수';
                             }
                         });
                     }
                    return status;
                },
                savedGuidanceSessions() {
                    const data = this.currentGuidanceData;
                     if (!data || !data.sessions) return [];
                     return data.sessions.filter(s => s && s.isSaved && s.date);
                },
                guidanceOperationPeriod() {
                    const savedSessions = this.savedGuidanceSessions;
                    if (savedSessions.length === 0) return '미정';
                    const validDates = savedSessions
                         .map(s => { try { if (s && s.date && /^\d{4}-\d{2}-\d{2}$/.test(s.date)) { const dateObj = new Date(s.date); if (!isNaN(dateObj.getTime())) { return dateObj; } } return null; } catch (e) { return null; } })
                         .filter(d => d)
                         .sort((a, b) => a - b);
                     if (validDates.length === 0) return '유효한 날짜 없음';
                    try {
                        const startDate = validDates[0].toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                        const endDate = validDates[validDates.length - 1].toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                        return `${startDate} ~ ${endDate}`;
                    } catch (e) { console.error("Error formatting date:", e); return '날짜 형식 오류'; }
                },
                processedHomeroomStudents() {
                     if(this.role !== '담임교사' || !this.homeroomClassInput.trim()) return [];

                    const studentMap = new Map();
                     const classInput = this.homeroomClassInput.trim();
                    this.deployedUnderachievers.forEach(student => {
                         if (!student || !student.id) return;
                         const studentClassIdentifier = student.id.substring(0, 3);
                         if (studentClassIdentifier !== classInput) return;

                        const allSubjects = new Map();
                         (student.gradeSubjects || []).forEach(subject => {
                             if (!subject || !subject.name) return;
                            if (!allSubjects.has(subject.name)) { allSubjects.set(subject.name, { grade: true, attendance: false }); }
                            else { allSubjects.get(subject.name).grade = true; }
                        });
                         (student.attendanceSubjects || []).forEach(subjectName => {
                             if (!subjectName) return;
                            if (!allSubjects.has(subjectName)) { allSubjects.set(subjectName, { grade: false, attendance: true }); }
                            else { allSubjects.get(subjectName).attendance = true; }
                        });

                        const subjectsArray = Array.from(allSubjects.entries()).map(([name, reasons]) => {
                            let reason = '';
                            if (reasons.grade && reasons.attendance) reason = '학업성취율&과목출석률';
                            else if (reasons.grade) reason = '학업성취율';
                            else if (reasons.attendance) reason = '과목출석률';
                             const completion = { status: '확인필요', color: 'text-gray-500'};
                            return { subject: name, reason: reason, status: completion.status, statusColor: completion.color };
                        });

                        studentMap.set(student.id, {
                            id: student.id, name: student.name, subjects: subjectsArray,
                            originalStudent: student
                        });
                    });

                    const tableRows = [];
                    studentMap.forEach(studentData => {
                        studentData.subjects.forEach((subjectInfo, index) => {
                            tableRows.push({ ...studentData, ...subjectInfo, isFirstRow: index === 0, rowspan: studentData.subjects.length });
                        });
                    });
                     tableRows.sort((a, b) => {
                         if (!a || !a.id || !b || !b.id) return 0;
                         if (a.id < b.id) return -1; if (a.id > b.id) return 1; return 0;
                     });
                    return tableRows;
                },
            },

            methods: {
                // --- Initial Data Helpers ---
                getInitialTeacherPlan() {
                     return {
                         aiProvider: 'gemini', apiKey: '', subjectName: '', teacherNames: [''],
                         achievements: [{ text: '', statement: '', loading: false }],
                         gradeCalculation: '추정분할점수', conductPrevention: 'X',
                         preventionTarget: '', preventionMethods: [], preventionPeriod: [],
                         preventionSessions: [{ plan: '' }, { plan: '' }, { plan: '' }],
                         supplementaryMethods: [], supplementaryPeriod: [],
                         supplementarySessions: [{ plan: '' }, { plan: '' }, { plan: '' }],
                         maxSupplementaryHours: 0,
                    };
                },
                getInitialGuidanceData() {
                     const defaultSession = () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} });
                     return {
                         preventive: { students: [], sessions: Array.from({ length: 10 }, defaultSession), error: ''},
                         supplementary: { students: [], sessions: Array.from({ length: 10 }, defaultSession), error: ''}
                     };
                },

                // --- Initialization and Auth ---
                async initApp() {
                    this.isLoading = true;
                     if (!auth) { this.isLoading = false; return; }
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            this.user = user;
                            this.isLoggedIn = true;
                            await this.loadUserRoleAndSchoolId(); 
                             if (this.role && this.schoolId) {
                                 await this.loadCommonData();
                                 if(this.role === '교과교사') {
                                     await this.loadTeacherPlan();
                                     if (this.teacherPlan.subjectName) {
                                         await this.loadGuidanceData();
                                         this.filterSupplementaryStudents();
                                     }
                                 } else if (this.role === '관리자') {
                                     this.underachievers = JSON.parse(JSON.stringify(this.deployedUnderachievers));
                                 }
                             }
                        } else {
                            this.user = null;
                            this.isLoggedIn = false;
                            this.resetAllLocalData();
                        }
                        this.isLoading = false;
                         this.$nextTick(() => { this.initFlatpickr(); });
                    });
                },
                async login() {
                    const provider = new GoogleAuthProvider();
                    try {
                        await signInWithPopup(auth, provider);
                    } catch (error) {
                        console.error("Login failed:", error);
                         if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
                             alert(`로그인 실패: ${error.message}`);
                         }
                    }
                },
                async logout() {
                     try {
                        await signOut(auth);
                     } catch (error) { console.error("Logout failed:", error); alert(`로그아웃 실패: ${error.message}`); }
                },

                // --- Role Management ---
                async selectRole(selectedRole) {
                     if (!this.user) { alert("사용자 정보가 없습니다. 다시 로그인해주세요."); return; }
                     
                     if (selectedRole === '관리자') {
                         this.showAdminCodeInput = true;
                     } else {
                         this.showAdminCodeInput = false;
                         this.role = selectedRole;
                         if (!this.schoolId) {
                             this.schoolIdMode = 'join';
                             this.showSchoolIdModal = true;
                         } else {
                            this.isLoading = true;
                            await this.saveUserRoleAndSchoolId(this.role);
                            await this.loadCommonData();
                            if(this.role === '교과교사') {
                                 await this.loadTeacherPlan();
                                 if(this.teacherPlan.subjectName){
                                     await this.loadGuidanceData();
                                     this.filterSupplementaryStudents();
                                 }
                            }
                            this.isLoading = false;
                            this.$nextTick(() => { this.initFlatpickr(); });
                         }
                     }
                },
                async submitAdminCode() {
                     if (this.adminCode === '0822') {
                         this.adminCodeError = '';
                         this.showAdminCodeInput = false;
                         this.role = '관리자';
                         this.isLoading = true;
                         await this.saveUserRoleAndSchoolId('관리자');
                         if (this.schoolId) {
                            await this.loadCommonData();
                            this.underachievers = JSON.parse(JSON.stringify(this.deployedUnderachievers));
                         }
                         this.isLoading = false;
                         this.$nextTick(() => { this.initFlatpickr(); });
                     } else {
                         this.adminCodeError = '코드가 올바르지 않습니다.';
                     }
                     this.adminCode = '';
                },
                async handleSchoolIdSubmit() {
                    const id = this.newSchoolId.trim();
                    const invalidChars = /[\s./*#$[\]]/;
                    
                    this.schoolIdError = '';
                    if (!id) { this.schoolIdError = "학교 고유 ID를 입력해주세요."; return; }
                    if (invalidChars.test(id)) { this.schoolIdError = "공백이나 특수문자 (/, ., *, # 등)는 사용할 수 없습니다."; return; }
                    
                    this.schoolId = id;
                    this.isLoading = true;
                    this.showSchoolIdModal = false;
                    
                    await this.saveUserRoleAndSchoolId(this.role);
                    await this.loadCommonData();
                    
                    if(this.role === '교과교사') {
                         await this.loadTeacherPlan();
                         if(this.teacherPlan.subjectName){
                             await this.loadGuidanceData();
                             this.filterSupplementaryStudents();
                         }
                    }
                    
                    this.isLoading = false;
                    this.newSchoolId = '';
                    this.$nextTick(() => { this.initFlatpickr(); });
                },
                async resetRole() {
                    this.role = null;
                    await this.saveUserRoleAndSchoolId(null);
                    this.resetRoleSpecificData();
                    this.showAdminCodeInput = false;
                    this.adminCode = '';
                    this.adminCodeError = '';
                    this.statusMessage = '';
                },
                async saveUserRoleAndSchoolId(roleToSave) {
                     if (!this.user || !db) return;
                     const userDocRef = doc(db, `userData/${this.user.uid}`);
                     const dataToSave = { 
                         role: roleToSave, 
                         schoolId: this.schoolId
                     };
                     
                     try {
                         await setDoc(userDocRef, dataToSave, { merge: true });
                     } catch (error) { console.error("Error saving user data:", error); }
                },
                 async loadUserRoleAndSchoolId() {
                     if (!this.user || !db) { this.role = null; this.schoolId = null; return; };
                     const userDocRef = doc(db, `userData/${this.user.uid}`);
                     try {
                         const userDocSnap = await getDoc(userDocRef);
                         if (userDocSnap.exists()) {
                             const data = userDocSnap.data();
                             this.role = data.role || null;
                             this.schoolId = data.schoolId || null;
                         } else {
                             this.role = null;
                             this.schoolId = null;
                         }
                     } catch (error) { console.error("Error loading user data:", error); this.role = null; this.schoolId = null; }
                 },

                // --- Data Loading (Common) ---
                async loadCommonData() {
                    if (!db || !this.schoolId) {
                        console.warn("Cannot load common data: DB or schoolId is missing.");
                        this.curriculumData = []; this.studentData = []; this.emotionalSupportData = []; this.deployedUnderachievers = [];
                        return;
                    }
                    this.statusMessage = '공용 데이터 로딩 중...';
                    this.isLoading = true;
                    try {
                        const commonDataBasePath = `schools/${this.schoolId}/commonData`;
                        const [
                            curriculumSnap, studentsSnap, emotionalSupportSnap,
                            moduleConfigSnap, formTemplatesSnap, underachieversSnap
                        ] = await Promise.all([
                            getDoc(doc(db, commonDataBasePath, "curriculum")),
                            getDoc(doc(db, commonDataBasePath, "students")),
                            getDoc(doc(db, commonDataBasePath, "emotionalSupport")),
                            getDoc(doc(db, commonDataBasePath, "moduleConfig")),
                            getDoc(doc(db, commonDataBasePath, "formTemplates")),
                            getDoc(doc(db, commonDataBasePath, "underachievers"))
                        ]);

                        this.curriculumData = curriculumSnap.exists() ? curriculumSnap.data().data || [] : [];
                        this.studentData = studentsSnap.exists() ? studentsSnap.data().data || [] : [];
                        this.emotionalSupportData = emotionalSupportSnap.exists() ? emotionalSupportSnap.data().data || [] : [];
                        Object.assign(this.moduleConfig, this.$options.data().moduleConfig);
                        if (moduleConfigSnap.exists()) Object.assign(this.moduleConfig, moduleConfigSnap.data());
                        Object.assign(this.newsletterForm, this.$options.data().newsletterForm);
                        Object.assign(this.pledgeForm, this.$options.data().pledgeForm);
                        if (formTemplatesSnap.exists()) {
                            const templatesData = formTemplatesSnap.data();
                            if(templatesData.newsletter) Object.assign(this.newsletterForm, templatesData.newsletter);
                            if(templatesData.pledge) Object.assign(this.pledgeForm, templatesData.pledge);
                        }
                        this.deployedUnderachievers = underachieversSnap.exists() ? underachieversSnap.data().data || [] : [];

                        console.log("Common data loaded for school:", this.schoolId);
                        this.statusMessage = '공용 데이터 로딩 완료.';
                    } catch (error) {
                        console.error("Error loading common data:", error);
                        this.statusMessage = '공용 데이터 로딩 중 오류 발생.';
                         this.curriculumData = []; this.studentData = []; this.emotionalSupportData = []; this.deployedUnderachievers = [];
                    } finally {
                        this.isLoading = false;
                        setTimeout(() => this.statusMessage = '', 2000);
                        if (this.role) {
                             this.$nextTick(() => { this.initFlatpickr(); });
                        }
                    }
                },

                // --- Data Saving (Admin) ---
                async uploadFile(event, type) {
                    if (!this.schoolId) { alert("학교 ID가 설정되지 않았습니다. '학교 코드 수정 및 발급' 메뉴에서 ID를 먼저 설정해주세요."); event.target.value = null; return; }
                    if (this.role !== '관리자' || !db) { event.target.value = null; return; }

                    const file = event.target.files[0];
                    if (!file) return;
                    this.uploadStatus[type] = `${file.name} 처리 및 저장 중...`;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);

                            const docRef = doc(db, `schools/${this.schoolId}/commonData`, type);
                            await setDoc(docRef, { data: jsonData });

                            if (type === 'curriculum') this.curriculumData = jsonData;
                            if (type === 'student') this.studentData = jsonData;
                            if (type === 'emotionalSupport') this.emotionalSupportData = jsonData;

                            this.uploadStatus[type] = `${file.name} 업로드 및 저장 완료.`;
                             this.updateMaxHours();
                        } catch (error) {
                            console.error(`Error processing/saving ${type} file:`, error);
                            this.uploadStatus[type] = `${file.name} 처리/저장 중 오류 발생: ${error.message}`;
                        } finally {
                            event.target.value = null;
                        }
                    };
                    reader.readAsArrayBuffer(file);
                },
                async saveModuleConfig() {
                    if (!this.schoolId) { alert("학교 ID가 설정되지 않았습니다. '학교 코드 수정 및 발급' 메뉴에서 ID를 먼저 설정해주세요."); return; }
                    if (this.role !== '관리자' || !db) return;
                    this.moduleConfigStatus = "운영 모듈 설정 저장 중...";
                    try {
                        const docRef = doc(db, `schools/${this.schoolId}/commonData`, "moduleConfig");
                        const configToSave = JSON.parse(JSON.stringify(this.moduleConfig));
                        await setDoc(docRef, configToSave);
                        this.moduleConfigStatus = "운영 모듈 설정이 저장되었습니다.";
                    } catch (error) { console.error("Error saving module config:", error); this.moduleConfigStatus = "저장 중 오류 발생."; }
                     setTimeout(() => this.moduleConfigStatus = '', 3000);
                },
                async saveFormTemplates(){
                    if (!this.schoolId) { alert("학교 ID가 설정되지 않았습니다. '학교 코드 수정 및 발급' 메뉴에서 ID를 먼저 설정해주세요."); return; }
                    if (this.role !== '관리자' || !db) return;
                    this.adminActionStatus = '양식 저장 중...';
                    try {
                        const docRef = doc(db, `schools/${this.schoolId}/commonData`, "formTemplates");
                        const templatesToSave = {
                            newsletter: JSON.parse(JSON.stringify(this.newsletterForm)),
                            pledge: JSON.parse(JSON.stringify(this.pledgeForm))
                        };
                        await setDoc(docRef, templatesToSave);
                        this.adminActionStatus = '가정통신문 및 서약서 양식이 저장되었습니다.';
                    } catch (error) { console.error("Error saving form templates:", error); this.adminActionStatus = '양식 저장 실패.'; }
                     setTimeout(() => this.adminActionStatus = '', 3000);
                },
                async deployUnderachievers() {
                    if (!this.schoolId) { alert("학교 ID가 설정되지 않았습니다. '학교 코드 수정 및 발급' 메뉴에서 ID를 먼저 설정해주세요."); return; }
                    if (this.role !== '관리자' || !db) return;
                    this.underachieversStatus = "미도달 학생 명단 배포 중...";
                    try {
                        const docRef = doc(db, `schools/${this.schoolId}/commonData`, "underachievers");
                        await setDoc(docRef, { data: JSON.parse(JSON.stringify(this.underachievers)) });
                         this.deployedUnderachievers = JSON.parse(JSON.stringify(this.underachievers));
                        this.underachieversStatus = "대상자 명단이 Firestore에 배포되었습니다.";
                    } catch (error) { console.error("Error deploying underachievers:", error); this.underachieversStatus = "배포 중 오류 발생: " + error.message; }
                     setTimeout(() => this.underachieversStatus = '', 3000);
                },

                // --- Data Loading/Saving (Teacher) ---
                 async loadTeacherPlan() {
                     if (!this.user || !db || !this.schoolId || this.role !== '교과교사') return;
                     const planDocRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}`, "teacherPlan");
                     try {
                         const docSnap = await getDoc(planDocRef);
                         if (docSnap.exists()) {
                             const loadedPlan = docSnap.data();
                             Object.assign(this.teacherPlan, this.getInitialTeacherPlan());
                             Object.assign(this.teacherPlan, loadedPlan);
                             
                             this.teacherPlan.teacherNames = this.teacherPlan.teacherNames && this.teacherPlan.teacherNames.length > 0 ? this.teacherPlan.teacherNames : [''];
                             this.teacherPlan.achievements = this.teacherPlan.achievements && this.teacherPlan.achievements.length > 0 ? this.teacherPlan.achievements : [{ text: '', statement: '', loading: false }];
                             this.teacherPlan.preventionMethods = this.teacherPlan.preventionMethods || [];
                             this.teacherPlan.preventionSessions = this.teacherPlan.preventionSessions && this.teacherPlan.preventionSessions.length > 0 ? this.teacherPlan.preventionSessions : [{plan:''}];
                             this.teacherPlan.supplementaryMethods = this.teacherPlan.supplementaryMethods || [];
                             this.teacherPlan.supplementarySessions = this.teacherPlan.supplementarySessions && this.teacherPlan.supplementarySessions.length > 0 ? this.teacherPlan.supplementarySessions : [{plan:''}];
                             
                             this.teacherPlan.achievements.forEach(a => a.loading = false);
                             
                             this.teacherPlan.preventionPeriod = (this.teacherPlan.preventionPeriod || []).map(d => d ? new Date(d.seconds ? d.seconds * 1000 : d) : null).filter(d => d && !isNaN(d.getTime()));
                             this.teacherPlan.supplementaryPeriod = (this.teacherPlan.supplementaryPeriod || []).map(d => d ? new Date(d.seconds ? d.seconds * 1000 : d) : null).filter(d => d && !isNaN(d.getTime()));
                             
                         } else {
                             this.resetTeacherData(false);
                         }
                     } catch (error) { console.error("Error loading teacher plan:", error); this.resetTeacherData(false); }
                      this.updateMaxHours();
                      this.$nextTick(() => { this.initFlatpickr(); });
                 },
                 async saveTeacherPlan() {
                     if (!this.user || !db || !this.schoolId || this.role !== '교과교사') return;
                      if (!this.teacherPlan.subjectName) {
                          this.teacherPlanStatus = "과목명을 먼저 입력해주세요.";
                          setTimeout(() => this.teacherPlanStatus = '', 3000);
                          return;
                     }
                     this.teacherPlanStatus = "계획안 저장 중...";
                      const planDocRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}`, "teacherPlan");
                     try {
                          const planToSave = { ...JSON.parse(JSON.stringify(this.teacherPlan)) };
                           planToSave.preventionPeriod = this.teacherPlan.preventionPeriod.map(d => (d instanceof Date && !isNaN(d.getTime())) ? d.toISOString() : null).filter(Boolean);
                           planToSave.supplementaryPeriod = this.teacherPlan.supplementaryPeriod.map(d => (d instanceof Date && !isNaN(d.getTime())) ? d.toISOString() : null).filter(Boolean);
                           planToSave.achievements = (planToSave.achievements || []).map(({ loading, ...rest }) => rest);
                          await setDoc(planDocRef, planToSave);
                         this.teacherPlanStatus = "계획안이 저장되었습니다.";
                     } catch (error) { console.error("Error saving teacher plan:", error); this.teacherPlanStatus = "계획안 저장 실패: " + error.message; }
                      setTimeout(() => this.teacherPlanStatus = '', 3000);
                 },
                async loadGuidanceData(){
                     if (!this.user || !db || !this.schoolId || this.role !== '교과교사' || !this.teacherPlan.subjectName) {
                         this.teacherGuidanceData = this.getInitialGuidanceData();
                         return;
                     }
                     const docPath = `schools/${this.schoolId}/teacherData/${this.user.uid}/${this.teacherPlan.subjectName}`;
                     try {
                         const docSnap = await getDoc(doc(db, docPath));
                         if (docSnap.exists()) {
                             const fetchedData = docSnap.data();
                             const defaultGuidance = this.getInitialGuidanceData();
                             this.teacherGuidanceData.preventive = {
                                 students: fetchedData.preventive?.students || [],
                                 sessions: this.mergeSessions(defaultGuidance.preventive.sessions, fetchedData.preventive?.sessions),
                                 error: fetchedData.preventive?.error || ''
                             };
                             this.teacherGuidanceData.supplementary = {
                                 students: fetchedData.supplementary?.students || [],
                                 sessions: this.mergeSessions(defaultGuidance.supplementary.sessions, fetchedData.supplementary?.sessions),
                                 error: fetchedData.supplementary?.error || ''
                             };
                         } else {
                             this.teacherGuidanceData = this.getInitialGuidanceData();
                         }
                     } catch (error) {
                         console.error("Error loading guidance data:", error);
                          this.teacherGuidanceData = this.getInitialGuidanceData();
                     } finally {
                         this.$nextTick(() => { this.initFlatpickr(); });
                     }
                },
                async saveGuidanceData(){
                     if (!this.user || !db || !this.schoolId || this.role !== '교과교사' || !this.teacherPlan.subjectName) return;
                     const docPath = `schools/${this.schoolId}/teacherData/${this.user.uid}/${this.teacherPlan.subjectName}`;
                     try {
                         const dataToSave = JSON.parse(JSON.stringify(this.teacherGuidanceData));
                        await setDoc(doc(db, docPath), dataToSave);
                     } catch (error) { console.error("Error saving guidance data:", error); }
                },
                mergeSessions(defaultSessions, loadedSessions) {
                     const validLoadedSessions = Array.isArray(loadedSessions) ? loadedSessions : [];
                     const defaultLength = Array.isArray(defaultSessions) ? defaultSessions.length : 10;
                     const mergedLength = Math.max(defaultLength, validLoadedSessions.length);
                     const merged = [];
                     const currentStudents = (this.teacherTab === 'preventive' ? this.teacherGuidanceData.preventive?.students : this.teacherGuidanceData.supplementary?.students) || [];

                     for (let i = 0; i < mergedLength; i++) {
                          const defaultSess = { date: '', time: '', isSaved: false, place: '', content: '', attendance: {} };
                          const loadedSess = validLoadedSessions[i];
                          let sessionToPush;

                          if (loadedSess) {
                              loadedSess.attendance = loadedSess.attendance || {};
                              sessionToPush = { ...defaultSess, ...loadedSess };
                          } else {
                              sessionToPush = defaultSess;
                          }
                         
                         currentStudents.forEach(student => {
                             if (student && !sessionToPush.attendance.hasOwnProperty(student.id)) {
                                 sessionToPush.attendance[student.id] = '';
                             }
                         });
                         merged.push(sessionToPush);
                     }
                     return merged;
                 },
                async handleSubjectChange() {
                     await this.saveTeacherPlan();
                     this.updateMaxHours();
                     await this.loadGuidanceData();
                     this.filterSupplementaryStudents();
                 },

                // --- Helper and UI Methods ---
                initFlatpickr() {
                     this.$nextTick(() => {
                         document.querySelectorAll('.flatpickr-input').forEach(el => {
                             if (el?._flatpickr) { el._flatpickr.destroy(); }
                         });
                         flatpickr(".flatpickr-range", {
                             mode: "range", dateFormat: "Y-m-d", locale: "ko",
                             onChange: (selectedDates, dateStr, instance) => {
                                 let headerText = ''; const headerElement = instance.element.closest('.bg-white')?.querySelector('h3'); if(headerElement) headerText = headerElement.textContent;
                                 const isPrevention = headerText.includes('예방'); const plan = this.teacherPlan; const targetPeriod = isPrevention ? 'preventionPeriod' : 'supplementaryPeriod';
                                 if (Array.isArray(selectedDates) && selectedDates.every(d => d instanceof Date)) { plan[targetPeriod] = selectedDates; } else { plan[targetPeriod] = []; }
                                 this.saveTeacherPlan();
                             }
                         });
                         flatpickr(".flatpickr-single", {
                             dateFormat: "Y-m-d", locale: "ko",
                         });
                     });
                },
                toggleExportOptions() { this.showExportOptions = !this.showExportOptions; },
                downloadTemplate(type) {
                    let data, filename;
                    if (type === 'curriculum') { data = [["분류", "과목명", "학년", "학기", "학점", "교과군"]]; filename = "교육과정_편제표_양식.xlsx"; }
                    else if (type === 'student') { data = [["학번", "이름", "특기사항"]]; filename = "학적정보_양식.xlsx"; }
                    else if (type === 'emotionalSupport') { data = [["학번", "이름", "정서지원프로그램 참여시간"]]; filename = "정서지원프로그램_이수시간_양식.xlsx"; }
                     if (!data) return; const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1"); XLSX.writeFile(wb, filename);
                },
                handleImageUpload(event, formType, field) {
                    if (this.role !== '관리자') return;
                    const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
                    reader.onload = (e) => {
                         if (file.size > 1048576) { alert("오류: 이미지 파일 크기는 1MB를 초과할 수 없습니다."); return; }
                        if (formType === 'newsletter') this.newsletterForm[field] = e.target.result;
                        else if (formType === 'pledge') this.pledgeForm[field] = e.target.result;
                         this.saveFormTemplates();
                    }; reader.readAsDataURL(file);
                },
                previewForm(type, studentsToPrint) {
                     const studentsArray = Array.isArray(studentsToPrint) ? studentsToPrint : [studentsToPrint];
                     if (!studentsArray || studentsArray.length === 0) {
                         studentsArray.push({ id: '10101', name: '김학생', gradeSubjects: [{name: '샘플과목', credits: 3}], attendanceSubjects: [] });
                         this.adminActionStatus = "샘플 학생 데이터로 미리보기를 생성합니다.";
                     } else {
                         this.adminActionStatus = '';
                     }

                     let allPreviewsHtml = '';
                     const form = (type === 'newsletter') ? this.newsletterForm : this.pledgeForm;

                     const logoImg = (type === 'newsletter' && form.logoUrl) ? `<img src="${form.logoUrl}" alt="School Logo" style="width: 70px; height: 70px; margin: 0 auto 15px auto; display: block;">` : '';
                     const sealSection = form.includeSeal && form.sealUrl
                         ? `<div class="seal-section"><p style="margin-bottom: 20px;">${form.dispatchDate || 'YYYY.MM.DD.'}</p><img src="${form.sealUrl}" alt="Principal Seal"></div>`
                         : `<div class="seal-section"><p>${form.dispatchDate || 'YYYY.MM.DD.'}</p><p class="school-name">00고등학교장 (직인생략)</p></div>`;

                     let commonHeader;
                     if (type === 'newsletter') {
                         commonHeader = `
                             <div style="text-align: center;">${logoImg}<h1>${form.title || '제목 없음'}</h1></div>
                             <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 20px;">
                                 <span>${form.docNumber || '문서번호'}</span>
                                 <span>${form.department || '담당부서'}</span>
                             </div>
                             <div class="whitespace-pre-wrap">${(form.body || '').trim() || '내용 없음'}</div>`;
                     } else { // pledge
                         commonHeader = `
                             <h1>서 약 서</h1>
                             <div class="whitespace-pre-wrap" style="min-height: 100px;">${(form.content || '').trim() || '내용 없음'}</div>`;
                     }

                     const studentDocs = studentsArray.map(student => {
                          if (!student) return '';
                         const fullStudent = this.underachievers.find(s => s.id === student.id) || this.deployedUnderachievers.find(s => s.id === student.id) || student;

                         let studentTableHtml = `<h3 style="margin-top: 40px; font-size: 1.2rem; font-weight: bold;">[최소 성취수준 보장지도 대상자 확인]</h3>`;
                         studentTableHtml += `<table><thead><tr style="background-color: #f2f2f2;">
                                 <th style="width: 20%;">학번</th><th style="width: 20%;">이름</th>
                                 <th>미도달 과목</th><th>미도달 내역</th>
                             </tr></thead><tbody>`;

                         const subjectsMap = new Map();
                         (fullStudent.gradeSubjects || []).forEach(s => {
                             if (s && s.name) { if (!subjectsMap.has(s.name)) subjectsMap.set(s.name, new Set()); subjectsMap.get(s.name).add('학업성취율'); }
                         });
                         (fullStudent.attendanceSubjects || []).forEach(sName => {
                             if (sName) { if (!subjectsMap.has(sName)) subjectsMap.set(sName, new Set()); subjectsMap.get(s.name).add('과목출석률'); }
                         });

                      if (subjectsMap.size > 0) {
                         let subjectIndex = 0;
                         const subjectCount = subjectsMap.size;
                         subjectsMap.forEach((reasons, subjectName) => {
                             if (subjectIndex === 0) {
                                 studentTableHtml += `<tr>
                                     <td rowspan="${subjectCount}" style="vertical-align: top;">${fullStudent.id}</td>
                                     <td rowspan="${subjectCount}" style="vertical-align: top;">${fullStudent.name}</td>
                                     <td class="text-left">${subjectName}</td>
                                     <td>${Array.from(reasons).join(' & ')}</td>
                                 </tr>`;
                             } else {
                                 studentTableHtml += `<tr>
                                     <td class="text-left">${subjectName}</td>
                                     <td>${Array.from(reasons).join(' & ')}</td>
                                 </tr>`;
                             }
                             subjectIndex++;
                         });
                     } else {
                             studentTableHtml += `<tr><td>${fullStudent.id}</td><td>${fullStudent.name}</td><td colspan="2">미도달 내역 없음 (샘플)</td></tr>`;
                         }

                         studentTableHtml += `</tbody></table>`;
                         studentTableHtml += `
                         <div style="margin-top: 40px; line-height: 1.6; text-align: left;">
                             <p>위 학생은 위와 같은 사유로 최소 성취수준 보장지도 대상자로 선정되었음을 확인하며, 지도 프로그램에 성실히 참여할 것을 서약합니다.</p>
                             <div class="signature-section">
                                 <div><p>학생: ________________ (서명)</p></div>
                                 <div><p>학부모: ________________ (서명)</p></div>
                             </div>
                         </div>`;

                         return `${commonHeader}${studentTableHtml}${sealSection}`;
                     });

                     allPreviewsHtml = studentDocs.map((doc, index) => {
                         const style = (index < studentDocs.length - 1) ? 'page-break-after: always;' : '';
                         return `<div class="page-break" style="${style}">${doc}</div>`;
                     }).join('');
                     
                     this.previewHtml = `<div id="print-area">${allPreviewsHtml}</div>`;
                     this.showPreviewModal = true;
                },
                 previewFormAdmin(type) {
                     this.previewForm(type, this.underachievers.length > 0 ? this.underachievers : []);
                 },
                 printHomeroomStudentForm(student, type) {
                     if(this.role !== '담임교사') return;
                     if (!this.newsletterForm.title || !this.pledgeForm.content) { alert("공용 양식이 아직 로드되지 않았습니다. 잠시 후 다시 시도하세요."); return; }
                     const fullStudent = this.deployedUnderachievers.find(s => s.id === student.id);
                     if (!fullStudent) { alert("학생 정보를 찾을 수 없습니다."); return; }
                     if ((!fullStudent.gradeSubjects || fullStudent.gradeSubjects.length === 0) && (!fullStudent.attendanceSubjects || fullStudent.attendanceSubjects.length === 0)) {
                         alert("해당 학생의 미도달 과목 정보가 없습니다."); return;
                     }
                     this.previewForm(type, [fullStudent]);
                 },
                 printPreviewModalContent() {
                     window.print();
                 },
                 closePreviewModal() {
                     this.showPreviewModal = false;
                     this.previewHtml = '';
                     this.adminActionStatus = '';
                     this.teacherPlanError = '';
                     this.teacherPlanStatus = '';
                 },
                processGradeFiles(event) {
                     if (this.role !== '관리자') return;
                     this.fileProcessingError = '';
                     const files = event.target.files;
                     if (!files || files.length === 0) return;
                     
                     const attendanceOnly = this.underachievers.filter(s =>
                         (!s.gradeSubjects || s.gradeSubjects.length === 0) && (s.attendanceSubjects && s.attendanceSubjects.length > 0)
                     );
                     let processedUnderachievers = [...attendanceOnly];
                     const resultData = new Map();
                     let filesProcessed = 0;
                     const totalFiles = files.length;

                     Array.from(files).forEach(file => {
                         const reader = new FileReader();
                         reader.onload = (e) => {
                             try {
                                 const data = new Uint8Array(e.target.result);
                                 const workbook = XLSX.read(data, { type: 'array' });
                                 const sheet = workbook.Sheets[workbook.SheetNames[0]];
                                 const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });

                                 const classInfoRow = sheetData[2];
                                 if (!classInfoRow || !classInfoRow[0]) throw new Error(`'${file.name}' 파일의 3행 A열에서 학급 정보를 찾을 수 없습니다.`);
                                 const classInfo = String(classInfoRow[0]);

                                 const gradeMatch = classInfo.match(/(\d+)\s*학년(?!도)/);
                                 const classNumMatch = classInfo.match(/(\d{1,2})\s*반/);

                                 if (!gradeMatch || !classNumMatch) throw new Error(`'${file.name}' 파일의 학급 정보 형식("${classInfo}")이 예상과 다릅니다. (예: '1학년 3반')`);

                                 const classGrade = gradeMatch[1];
                                 const classNum = classNumMatch[1];
                                 
                                 const subjectHeaderRow = sheetData[3];
                                 if (!subjectHeaderRow) throw new Error(`'${file.name}' 파일의 4행에서 과목 정보를 찾을 수 없습니다.`);

                                 for (let r = 5; r < sheetData.length; r += 2) {
                                     const nameRow = sheetData[r - 1];
                                     const statusRow = sheetData[r];
                                     if (!nameRow || !statusRow || nameRow[0] == null || nameRow[1] == null) continue;

                                     const num = nameRow[0];
                                     const name = nameRow[1];
                                     const fullId = `${classGrade}${String(classNum).padStart(2, "0")}${String(num).padStart(2, "0")}`;

                                     for (let c = 3; c < statusRow.length; c++) {
                                         if (String(statusRow[c]).trim() === "미도달") {
                                             const subjectWithCredits = subjectHeaderRow[c];
                                             if (!subjectWithCredits) continue;
                                             const subject = String(subjectWithCredits).split('(')[0].trim();
                                             
                                             if (!resultData.has(fullId)) {
                                                 resultData.set(fullId, { name: name, subjects: new Set() });
                                             }
                                             resultData.get(fullId).subjects.add(subject);
                                         }
                                     }
                                 }
                             } catch (err) {
                                 console.error(`Error processing file ${file.name}:`, err);
                                 this.fileProcessingError = `${file.name} 처리 오류: ${err.message}`;
                             } finally {
                                 filesProcessed++;
                                 if (filesProcessed === totalFiles) {
                                     resultData.forEach((data, id) => {
                                         const existingIndex = processedUnderachievers.findIndex(s => s.id === id);
                                         const gradeSubjectsData = Array.from(data.subjects).map(subjectName => {
                                             const curriculumInfo = this.curriculumData.find(c => c.과목명 === subjectName);
                                             return { name: subjectName, credits: curriculumInfo ? curriculumInfo.학점 : 'N/A' };
                                         });
                                         
                                         if (existingIndex > -1) {
                                             if (!processedUnderachievers[existingIndex].gradeSubjects) processedUnderachievers[existingIndex].gradeSubjects = [];
                                             const existingGradeSubjectsNames = new Set(processedUnderachievers[existingIndex].gradeSubjects.map(s => s.name));
                                             gradeSubjectsData.forEach(gs => {
                                                 if (!existingGradeSubjectsNames.has(gs.name)) {
                                                     processedUnderachievers[existingIndex].gradeSubjects.push(gs);
                                                 }
                                             });
                                         } else {
                                             processedUnderachievers.push({ id: id, name: data.name, gradeSubjects: gradeSubjectsData, attendanceSubjects: [] });
                                         }
                                     });
                                     processedUnderachievers.sort((a,b) => a.id.localeCompare(b.id));
                                     this.underachievers = processedUnderachievers;
                                     if (event && event.target) event.target.value = null;
                                 }
                             }
                         };
                         reader.readAsArrayBuffer(file);
                     });
                },
                closeAttendanceModal() { this.showAttendanceModal = false; this.newAttendanceStudent = { id: '', subjects: [''] }; this.attendanceModalError = ''; },
                addAttendanceSubject() { this.newAttendanceStudent.subjects.push(''); },
                removeAttendanceSubject(index) { this.newAttendanceStudent.subjects.splice(index, 1); },
                addAttendanceStudent() {
                     if (this.role !== '관리자') return;
                     this.attendanceModalError = '';
                     const studentIdInput = this.newAttendanceStudent.id ? String(this.newAttendanceStudent.id).trim() : '';
                     const subjects = this.newAttendanceStudent.subjects;
                     if (!studentIdInput || subjects.some(s => !s.trim())) { this.attendanceModalError = '학번과 모든 과목명을 입력해주세요.'; return; }
                     const foundStudent = this.studentData.find(student => String(student['학번']) === studentIdInput);
                     if (!foundStudent) { this.attendanceModalError = '해당 학번을 찾을 수 없습니다. 학적 정보를 먼저 업로드 해주세요.'; return; }
                     
                     const canonicalId = String(foundStudent['학번']);
                     const name = foundStudent['이름'];
                     const studentIndex = this.underachievers.findIndex(s => s.id === canonicalId);
                     const validSubjects = subjects.map(s => s.trim()).filter(s => s);
                     
                     if (studentIndex > -1) {
                         if (!this.underachievers[studentIndex].attendanceSubjects) this.underachievers[studentIndex].attendanceSubjects = [];
                         const existingSubjects = new Set(this.underachievers[studentIndex].attendanceSubjects);
                         validSubjects.forEach(subject => {
                             if (!existingSubjects.has(subject)) this.underachievers[studentIndex].attendanceSubjects.push(subject);
                         });
                     } else {
                         this.underachievers.push({ id: canonicalId, name, gradeSubjects: [], attendanceSubjects: validSubjects });
                     }
                     this.underachievers.sort((a, b) => a.id.localeCompare(b.id));
                     this.closeAttendanceModal();
                },
                deleteDetailGroup(detailToDelete) {
                     if (this.role !== '관리자') return;
                     const student = this.underachievers.find(s => s.id === detailToDelete.id);
                     if (!student) return;
                     student.gradeSubjects = student.gradeSubjects || [];
                     student.attendanceSubjects = student.attendanceSubjects || [];
                     
                     detailToDelete.originalSubjects.forEach(subjectInfo => {
                         if (detailToDelete.reason.includes('학업성취율')) {
                             student.gradeSubjects = student.gradeSubjects.filter(gs => gs.name !== subjectInfo.name);
                         }
                         if (detailToDelete.reason.includes('과목출석률')) {
                             student.attendanceSubjects = student.attendanceSubjects.filter(asName => asName !== subjectInfo.name);
                         }
                     });
                     
                     if (student.gradeSubjects.length === 0 && student.attendanceSubjects.length === 0) {
                         this.underachievers = this.underachievers.filter(s => s.id !== student.id);
                     }
                },
                exportTable(format) {
                     if (this.role !== '관리자' || !this.groupedUnderachievers || this.groupedUnderachievers.length === 0) { alert("내보낼 미도달 학생 데이터가 없습니다."); this.showExportOptions = false; return; }
                     const data = this.groupedUnderachievers.flatMap(student =>
                         student.details.map(detail => ({
                             '학번': student.id, '이름': student.name, '특기사항': student.specialNotes,
                             '미도달내역': detail.reason, '미도달 과목(학점수)': detail.subjects, '보충지도(추가학습) 내역': detail.lessonDetails,
                         }))
                     );
                     const today = new Date().toISOString().slice(0, 10);
                     const filename = `미도달_학생_현황_${today}`;
                     
                     if (format === 'xlsx') { const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "현황"); XLSX.writeFile(wb, `${filename}.xlsx`); }
                     else if (format === 'csv') { const ws = XLSX.utils.json_to_sheet(data); const csv = XLSX.utils.sheet_to_csv(ws); const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" }); saveAs(blob, `${filename}.csv`); }
                     else if (format === 'pdf') {
                         this.adminActionStatus = 'PDF 생성 중...';
                         const table = document.getElementById('underachievers-table');
                         if (table) {
                             const tableClone = table.cloneNode(true);
                             tableClone.querySelector('th:last-child, td:last-child')?.remove();
                             this.previewHtml = `<div id="print-area"><h1>미도달 학생 현황</h1>${tableClone.outerHTML}</div>`;
                             this.showPreviewModal = true;
                         }
                     }
                     this.showExportOptions = false;
                },

                // --- Teacher Methods ---
                switchTeacherTab(tab) {
                    this.teacherTab = tab;
                     this.$nextTick(() => { this.initFlatpickr(); });
                     if (tab === 'supplementary') {
                         this.filterSupplementaryStudents();
                     }
                },
                filterSupplementaryStudents() {
                     if (this.role !== '교과교사' || !this.teacherPlan.subjectName || !this.deployedUnderachievers) {
                         if (this.teacherGuidanceData.supplementary) this.teacherGuidanceData.supplementary.students = [];
                         return;
                     }
                     const subject = this.teacherPlan.subjectName;
                     const subjectSpecificUnderachievers = this.deployedUnderachievers.filter(student => {
                         if (!student) return false;
                         const gradeMatch = (student.gradeSubjects || []).some(s => s && s.name === subject);
                         const attendanceMatch = (student.attendanceSubjects || []).includes(subject);
                         return gradeMatch || attendanceMatch;
                     });

                     const currentSuppStudents = this.teacherGuidanceData.supplementary?.students || [];
                     
                     const deployedIds = new Set(subjectSpecificUnderachievers.map(s => s.id));
                     const existingStudentsToKeep = currentSuppStudents.filter(s => deployedIds.has(s.id));
                     existingStudentsToKeep.forEach(s => {
                         const match = subjectSpecificUnderachievers.find(ds => ds.id === s.id);
                         if (match) {
                             let reason = '';
                             const gradeMatch = (match.gradeSubjects || []).some(m => m.name === subject);
                             const attendanceMatch = (match.attendanceSubjects || []).includes(subject);
                             if (gradeMatch && attendanceMatch) reason = '학업성취율&과목출석률';
                             else if (gradeMatch) reason = '학업성취율';
                             else if (attendanceMatch) reason = '과목출석률';
                             s.reason = reason;
                         }
                     });

                     existingStudentsToKeep.sort((a, b) => a.id.localeCompare(b.id));
                     this.teacherGuidanceData.supplementary.students = existingStudentsToKeep;
                     
                     this.teacherGuidanceData.supplementary.sessions.forEach(session => {
                         if (!session) return;
                         const newAttendance = {};
                         existingStudentsToKeep.forEach(student => {
                             if (student) {
                                 newAttendance[student.id] = (session.attendance && session.attendance[student.id]) ? session.attendance[student.id] : '';
                             }
                         });
                         session.attendance = newAttendance;
                     });
                },
                updateMaxHours() {
                     const subject = this.curriculumData.find(s => s.과목명 === this.teacherPlan.subjectName);
                     if (subject) {
                         const credits = Number(subject.학점);
                         if (!isNaN(credits) && credits > 0) { this.teacherPlan.maxSupplementaryHours = credits * this.moduleConfig.hoursPerCredit; }
                         else { this.teacherPlan.maxSupplementaryHours = 0; }
                         if(this.teacherPlan.supplementarySessions.length > this.teacherPlan.maxSupplementaryHours && this.teacherPlan.maxSupplementaryHours > 0){
                             this.teacherPlan.supplementarySessions = this.teacherPlan.supplementarySessions.slice(0, this.teacherPlan.maxSupplementaryHours);
                         } else if (this.teacherPlan.maxSupplementaryHours <= 0) {
                             this.teacherPlan.supplementarySessions = [];
                         }
                     } else {
                         this.teacherPlan.maxSupplementaryHours = 0;
                         this.teacherPlan.supplementarySessions = [];
                     }
                },
                addAchievement() { this.teacherPlan.achievements.push({ text: '', statement: '', loading: false }); },
                removeAchievement(index) { this.teacherPlan.achievements.splice(index, 1); },
                addPreventionSession() { this.teacherPlan.preventionSessions.push({ plan: '' }); },
                removePreventionSession(index) { this.teacherPlan.preventionSessions.splice(index, 1); },
                addSupplementarySession() { if (!this.teacherPlan.maxSupplementaryHours) { alert("먼저 과목명을 입력하여 최대 차시를 설정하세요."); return; } if (this.teacherPlan.supplementarySessions.length < this.teacherPlan.maxSupplementaryHours) this.teacherPlan.supplementarySessions.push({ plan: '' }); },
                removeSupplementarySession(index) { this.teacherPlan.supplementarySessions.splice(index, 1); },
                addTeacher() { this.teacherPlan.teacherNames.push(''); },
                removeTeacher(index) { this.teacherPlan.teacherNames.splice(index, 1); },
                async generateStatement(index) {
                     this.teacherPlanError = ''; const achievement = this.teacherPlan.achievements[index]; if (!achievement.text) { this.teacherPlanError = '성취기준을 먼저 입력해주세요.'; return; }
                     if (this.teacherPlan.aiProvider !== 'openai' && !this.teacherPlan.apiKey) { this.teacherPlanError = 'AI API 키를 먼저 입력해주세요.'; return; }
                     achievement.loading = true; achievement.statement = '';
                     const systemPrompt = "당신은 교육 전문가로서 성취기준을 바탕으로 최소 성취수준과 최소 성취수준 학생들의 행동 특성을 설명하는 역할입니다. 입력한 성취기준에 대한 학습자들의 성취수준을 A~E 5단계로 나누었을 때 최하 수준인 E수준을 한 문장으로 진술하세요. 성취수준이란 입력한 성취기준을 학습한 결과로 나타나는 학습자들의 학습 수준을 의미해. 최소 성취수준이므로 간단하고 기초적인 수준으로 입력하되, 부정적인 진술은 하지 말고, 최소한의 노력을 하고 성취기준에 해당하는 내용을 기초적인 수준에서 찾아보았다는 식으로 진술하세요. '학생들은~', '최소 성취수준:' 또는 'E수준:~' 이라는 별도의 설명 구문 없이 바로 성취수준 진술문만 제시해야 합니다. 예를 들어 성취기준이 '논증 요소에 따른 분석을 바탕으로 효과적으로 내용을 조직하여 논증하는 글을 쓴다.'인 경우 최소 성취수준은 '논증 요소에 대한 제한적인 분석을 바탕으로 논증하는 글을 쓴다.'로 진술할 수 있습니다. 예시로 든 진술문의 형식을 유지하면서 최소 성취수준 진술문을 제시해주세요.";
                     const userQuery = achievement.text;
                     let apiUrl, payload, headers = {}, responseParser;
                     const provider = this.teacherPlan.aiProvider; const apiKey = this.teacherPlan.apiKey;

                     if (provider === 'gemini') {
                         apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
                         headers['Content-Type'] = 'application/json';
                         payload = { contents: [{ role: "user", parts: [{ text: systemPrompt + "\n\n 성취기준: " + userQuery }] }] };
                         responseParser = (r) => r.candidates?.[0]?.content?.parts?.[0]?.text;
                     } else if (provider === 'openai') {
                         apiUrl = '/.netlify/functions/openai-proxy';
                         headers['Content-Type'] = 'application/json';
                         payload = { model: "gpt-3.5-turbo", messages: [{ role: "system", content: systemPrompt },{ role: "user", content: userQuery }] };
                         responseParser = (r) => r.choices?.[0]?.message?.content;
                     } else if (provider === 'claude') {
                         apiUrl = '/.netlify/functions/claude-proxy';
                         headers = { 'Content-Type': 'application/json' };
                         payload = { model: "claude-3-sonnet-20240229", max_tokens: 1024, system: systemPrompt, messages: [{ role: "user", content: userQuery }] };
                         responseParser = (r) => r.content?.[0]?.text;
                     }

                     try {
                         const response = await fetch(apiUrl, { method: 'POST', headers: headers, body: JSON.stringify(payload) });
                         if (!response.ok) { const errorBody = await response.json().catch(() => ({})); const errorMessage = errorBody.error?.message || errorBody.message || errorBody.error || response.statusText; throw new Error(`API 요청 실패 (${response.status}): ${errorMessage}`); }
                         const result = await response.json();
                         const actualResult = result.data || result;
                         const generatedText = responseParser(actualResult);
                         if (generatedText) {
                             achievement.statement = generatedText.trim().replace(/^(E수준:|최소 성취수준:)\s*/, '');
                             this.saveTeacherPlan();
                         } else { console.log('API Raw Response:', result); throw new Error('API 응답에서 진술문을 찾을 수 없습니다.'); }
                     } catch (error) { console.error("AI 진술문 생성 오류:", error); this.teacherPlanError = `진술문 생성 중 오류 발생: ${error.message}.`; }
                     finally { achievement.loading = false; }
                },
                generatePlanPreview() {
                     const plan = this.teacherPlan; const subjectInfo = this.curriculumData.find(s => s.과목명 === plan.subjectName);
                     if (!subjectInfo) { this.teacherPlanError = '과목명을 찾을 수 없습니다.'; this.previewHtml = `<div id="print-area"><p style='color: red;'>${this.teacherPlanError}</p></div>`; this.showPreviewModal = true; return; }
                     this.teacherPlanError = '';
                     const localModuleConfig = this.moduleConfig; const supplementaryHours = this.teacherPlan.maxSupplementaryHours;
                     const requiredHours = Math.ceil((supplementaryHours * 2) / 3 * 10) / 10;
                     const preventionPossibleHours = Math.floor(supplementaryHours * (localModuleConfig.preventiveRatio / 100));
                     const emotionalSupportHours = Math.floor(supplementaryHours * (localModuleConfig.emotionalSupportRatio / 100));
                     
                     const createTable = (headers, rows) => {
                         const ths = headers.map(h => `<th>${h}</th>`).join('');
                         const trs = rows.map(row => { const tds = row.map((cell, i) => `<td class="${headers[i] === '성취기준' || headers[i] === '지도 계획' ? 'text-left' : ''}">${cell}</td>`).join(''); return `<tr>${tds}</tr>`; }).join('');
                         return `<table><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>`;
                     };
                     
                     let achievementRateHtml = `<p>• 학업 성취율: 학기말 학업 성취율 40% 미만</p>`;
                     if (plan.gradeCalculation === '고정분할점수') achievementRateHtml += createTable(['성취율', '기준점수'], [['90% 이상', '90'], ['80% 이상 ~ 90% 미만', '80'], ['70% 이상 ~ 80% 미만', '70'], ['60% 이상 ~ 70% 미만', '60'], ['40% 이상 ~ 60% 미만', '40']]);
                     else achievementRateHtml += `<p style="padding-left: 1em;">- 성취수준 기준점수는 학기말 추정분할점수 산출 결과에 따름</p>`;
                     
                     const overviewTable = createTable(
                         ['운영 학년', '운영 학기', '보충지도 시수', '이수 인정 기준 시수', '예방지도 인정 가능 시수', '정서 지원 프로그램 인정 가능 시수'],
                         [[subjectInfo.학년, subjectInfo.학기, `${supplementaryHours}시수`, `${requiredHours}시수 (2/3 반올림)`, `${preventionPossibleHours}시수 (일반)`, `${emotionalSupportHours}시수`]]
                     );
                     
                     const statementsTable = createTable(['성취기준', '최소 성취수준 진술문'], plan.achievements.map(a => [`<div class="whitespace-pre-wrap text-left">${a.text || ''}</div>`, `<div class="whitespace-pre-wrap text-left">${a.statement || '미생성'}</div>`]));
                     
                     let preventionPlanHtml = '';
                     if (plan.conductPrevention === 'O') {
                         const pPeriod = (plan.preventionPeriod || []).filter(d => d instanceof Date).map(d => d.toLocaleDateString('ko-KR'));
                         const pPeriodFmt = pPeriod.length === 2 ? `${pPeriod[0]} ~ ${pPeriod[1]}` : (pPeriod.length === 1 ? pPeriod[0] : '미정');
                         const pSessions = plan.preventionSessions.map((s, i) => [`${i + 1}차시`, `<div class="whitespace-pre-wrap text-left">${s.plan || ''}</div>`]);
                         preventionPlanHtml = `<h3>4. 최소 성취수준 미도달 예방 지도 계획</h3>${createTable(['구분', '내용'], [['대상학생 선정 기준', `<div class="whitespace-pre-wrap text-left">${plan.preventionTarget || ''}</div>`], ['지도 방법', plan.preventionMethods.join(', ')], ['운영 차시', `${plan.preventionSessions.length}차시`], ['운영 기간', pPeriodFmt]])}<h4>차시별 지도 계획</h4>${createTable(['차시', '지도 계획'], pSessions)}`;
                     } else { preventionPlanHtml = `<h3>4. ...예방 지도 계획</h3><p>- 해당 없음</p>`; }
                     
                     const sPeriod = (plan.supplementaryPeriod || []).filter(d => d instanceof Date).map(d => d.toLocaleDateString('ko-KR'));
                     const sPeriodFmt = sPeriod.length === 2 ? `${sPeriod[0]} ~ ${sPeriod[1]}` : (sPeriod.length === 1 ? sPeriod[0] : '미정');
                     const sSessions = plan.supplementarySessions.map((s, i) => [`${i + 1}차시`, `<div class="whitespace-pre-wrap text-left">${s.plan || ''}</div>`]);
                     
                     const supplementaryPlanHtml = `<h3>5. 보충 지도 운영 계획</h3>${createTable(['구분', '내용'], [['대상학생 선정 기준', '학업성취율 40% 미만'], ['지도 방법', plan.supplementaryMethods.join(', ')], ['운영 차시', `${plan.supplementarySessions.length}차시`], ['운영 기간', sPeriodFmt]])}<h4>차시별 지도 계획</h4>${createTable(['차시', '지도 계획'], sSessions)}`;
                     const additionalLearningPlanHtml = `<h3>6. 추가 학습 운영 계획</h3>${createTable(['구분', '내용'], [['대상학생 선정 기준', '과목출석률 2/3 미만'], ['지도 방법', plan.supplementaryMethods.join(', ')], ['운영 차시', `${plan.supplementarySessions.length}차시`], ['운영 기간', sPeriodFmt]])}<h4>차시별 지도 계획</h4>${createTable(['차시', '지도 계획'], sSessions)}`;
                     
                     this.previewHtml = `<div id="print-area">
                         <h1>최소 성취수준 보장지도 운영 계획(안)</h1>
                         <div style="text-align: right; font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem;">
                             <p><strong>과목명:</strong> ${plan.subjectName}</p>
                             <p><strong>교과교사:</strong> ${this.formattedTeacherNames}</p>
                         </div>
                         <h3>1. 학점이수 인정 기준</h3>
                         <p>• 과목 출석률: 수업 횟수의 2/3 미만 시</p>
                         ${achievementRateHtml}
                         <h3>2. 최소 성취수준 보장지도 개요</h3>
                         ${overviewTable}
                         <h3>3. 최소 성취수준 진술문</h3>
                         ${statementsTable}
                         ${preventionPlanHtml}
                         ${supplementaryPlanHtml}
                         ${additionalLearningPlanHtml}
                     </div>`;
                     this.showPreviewModal = true;
                },

                // --- GUIDANCE LOGBOOK METHODS ---
                addGuidanceStudent(type) {
                     if (this.role !== '교과교사') return; const data = this.teacherGuidanceData[type]; if (!data) return;
                     data.error = ''; const studentId = this.newGuidanceStudentId.trim(); if (!studentId) return;
                     if (data.students.some(s => s.id === studentId)) { data.error = '이미 추가된 학생입니다.'; return; }
                     const studentInfo = this.studentData.find(s => String(s['학번']) === studentId);
                     if (studentInfo) {
                         const studentToAdd = { id: studentId, name: studentInfo['이름'] };
                         if (type === 'supplementary') {
                             const deployed = this.deployedUnderachievers.find(s => s.id === studentId);
                             if (deployed) {
                                 const subject = this.teacherPlan.subjectName;
                                 const gradeMatch = (deployed.gradeSubjects || []).some(s => s && s.name === subject);
                                 const attendanceMatch = (deployed.attendanceSubjects || []).includes(subject);
                                 if (gradeMatch && attendanceMatch) studentToAdd.reason = '학업성취율&과목출석률';
                                 else if (gradeMatch) studentToAdd.reason = '학업성취율';
                                 else if (attendanceMatch) studentToAdd.reason = '과목출석률';
                             }
                         }
                         data.students.push(studentToAdd);
                         data.students.sort((a, b) => a.id.localeCompare(b.id));
                         data.sessions.forEach(session => { if (session && !session.attendance.hasOwnProperty(studentId)) { session.attendance[studentId] = ''; } });
                         this.newGuidanceStudentId = '';
                         this.saveGuidanceData();
                     } else { data.error = '학적 정보에 없는 학생입니다. 먼저 학적 정보를 업로드해주세요.'; }
                },
                addGuidanceSession(type) {
                     if (this.role !== '교과교사') return; const data = this.teacherGuidanceData[type]; if (!data) return;
                     const initialAttendance = {};
                     data.students.forEach(s => { if (s) initialAttendance[s.id] = ''; });
                     data.sessions.push({ date: '', time: '', isSaved: false, place: '', content: '', attendance: initialAttendance });
                     this.$nextTick(() => { this.initFlatpickr(); });
                },
                isSessionReadyToSave(session) {
                    if (!session || !session.date || !session.time) return false;
                    if (!this.currentGuidanceData?.students || this.currentGuidanceData.students.length === 0) return false;
                     return Object.values(session.attendance || {}).some(value => value);
                },
                toggleSaveSession(session) {
                     if (this.role !== '교과교사' || !session) return;
                     session.isSaved = !session.isSaved;
                     if (this.currentGuidanceData && this.currentGuidanceData.students) {
                         this.currentGuidanceData.students.forEach(student => {
                             if (!session.attendance) session.attendance = {};
                             if (student && !session.attendance.hasOwnProperty(student.id)) {
                                 session.attendance[student.id] = '';
                             }
                         });
                     }
                     this.saveGuidanceData();
                },
                scrollAttendance(direction, event) {
                    const container = event.target.closest('.relative')?.querySelector('.overflow-x-auto');
                    if (!container) return;
                    const scrollAmount = container.clientWidth * 0.8;
                    container.scrollBy({ left: direction === 'left' ? -scrollAmount : scrollAmount, behavior: 'smooth' });
                },
                async generatePdfFromHtml(htmlContent) {
                    this.previewHtml = htmlContent;
                    this.showPreviewModal = true;
                    this.adminActionStatus = '미리보기 생성 완료. 인쇄 버튼을 눌러 PDF로 저장하세요.';
                },
                async generateCompletionStatusPdf(type) {
                     const data = this.teacherGuidanceData[type];
                     if (!data || !this.role) return;
                     const title = type === 'preventive' ? '예방지도' : '보충지도(추가학습)';
                     
                     let tableHtml = `<table><thead><tr>
                         <th>학생</th>
                         ${type === 'supplementary' ? '<th>특기사항</th><th>미도달 항목</th><th>예방지도</th><th>정서지원프로그램</th>' : ''}
                         ${this.moduleConfig.recognizedHours.map(rh => `<th>${rh.name}</th>`).join('')}
                         <th>총계</th>
                         ${type === 'supplementary' ? '<th>이수여부</th>' : ''}
                         </tr></thead><tbody>`;

                     if (data.students && data.students.length > 0) {
                         data.students.forEach(student => {
                             if (!student) return;
                             tableHtml += `<tr><td class="text-left">${student.name} (${student.id})</td>`;
                             const studentStatus = this.guidanceCompletionStatus[student.id] || {};
                             if (type === 'supplementary') {
                                 tableHtml += `<td>${studentStatus.specialNotes || '일반학생'}</td><td>${student.reason || ''}</td><td>${studentStatus.preventiveHours || 0}</td><td>${studentStatus.emotionalSupportHours || 0}</td>`;
                             }
                             this.moduleConfig.recognizedHours.forEach(rh => {
                                 tableHtml += `<td>${studentStatus[rh.name] || 0}</td>`;
                             });
                             tableHtml += `<td>${studentStatus.total || 0}</td>`;
                             if (type === 'supplementary') {
                                 const status = studentStatus.completionStatus || '미이수';
                                 tableHtml += `<td style="color: ${status === '이수' ? 'green' : 'red'}; font-weight: bold;">${status}</td>`;
                             }
                             tableHtml += '</tr>';
                         });
                     } else {
                         const colspan = this.moduleConfig.recognizedHours.length + (type === 'supplementary' ? 7 : 2);
                         tableHtml += `<tr><td colspan="${colspan}">학생 정보가 없습니다.</td></tr>`;
                     }
                     tableHtml += '</tbody></table>';
                     
                     const finalHtml = `<div id="print-area"><h1>${title} 이수현황표</h1><div style="font-size: 1rem; line-height: 1.6; border: 1px solid #ccc; padding: 10px; margin-bottom: 2rem;"><p><strong>과목명:</strong> ${this.teacherPlan.subjectName || '미입력'}</p><p><strong>지도교사:</strong> ${this.formattedTeacherNames}</p></div>${tableHtml}</div>`;
                     
                     this.generatePdfFromHtml(finalHtml);
                },
                async generateAttendancePdf(type) {
                     const data = this.teacherGuidanceData[type];
                     if (!data || !this.role) return;
                     const title = type === 'preventive' ? '예방지도' : '보충지도(추가학습)';
                     const savedSessions = data.sessions.filter(s => s && s.date);
                     
                     let tableHtml = `<table><thead><tr><th>학번</th><th>이름</th>${savedSessions.map((s, i) => `<th>${i + 1}차시<br/>(${s.date})</th>`).join('')}</tr></thead><tbody>`;
                     if (data.students && data.students.length > 0) {
                         data.students.forEach(student => {
                             if (!student) return;
                             tableHtml += `<tr><td class="text-left">${student.id}</td><td class="text-left">${student.name}</td>`;
                             savedSessions.forEach(s => { tableHtml += `<td>${(s?.attendance?.[student.id] || '')}</td>`; });
                             tableHtml += '</tr>';
                         });
                     } else {
                         tableHtml += `<tr><td colspan="${savedSessions.length + 2}">학생 정보가 없습니다.</td></tr>`;
                     }
                     tableHtml += '</tbody></table>';
                     
                     const finalHtml = `<div id="print-area"><h1>${title} 출석부</h1><div style="font-size: 1rem; line-height: 1.6; border: 1px solid #ccc; padding: 10px; margin-bottom: 2rem;"><p><strong>과목명:</strong> ${this.teacherPlan.subjectName || '미입력'}</p><p><strong>지도교사:</strong> ${this.formattedTeacherNames}</p></div>${tableHtml}</div>`;
                     this.generatePdfFromHtml(finalHtml);
                },
                async generateLessonLogPdf(type) {
                     if (!this.currentGuidanceData || !this.role) return;
                     const title = type === 'preventive' ? '예방지도' : '보충지도(추가학습)';
                     
                     let lessonLogHtml = this.savedGuidanceSessions.map((session, index) => {
                         if (!session) return '';
                         return `<div class="page-break" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px;"><h3>${index + 1}차시 수업일지 (${session.date} / ${session.time})</h3><table style="font-size: 10pt;"><tr><th style="width: 20%;">장소</th><td class="text-left" style="width: 30%;">${session.place || ''}</td><th style="width: 20%;">수업방법</th><td class="text-left" style="width: 30%;">${[...new Set(Object.values(session.attendance || {}))].filter(Boolean).join(', ')}</td></tr><tr><th>지도내용</th><td colspan="3" class="text-left"><div class="whitespace-pre-wrap" style="min-height: 100px;">${session.content || ''}</div></td></tr></table></div>`;
                     }).join('');
                     
                     const finalHtml = `<div id="print-area"><h1>${title} 수업일지</h1><div style="font-size: 1rem; line-height: 1.6; border: 1px solid #ccc; padding: 10px; margin-bottom: 2rem;"><p><strong>과목명:</strong> ${this.teacherPlan.subjectName || '미입력'}</p><p><strong>지도교사:</strong> ${this.formattedTeacherNames}</p><p><strong>운영기간:</strong> ${this.guidanceOperationPeriod}</p></div>${lessonLogHtml.length > 0 ? lessonLogHtml : '<p style="text-align: center;">저장된 수업일지가 없습니다.</p>'}</div>`;
                     this.generatePdfFromHtml(finalHtml);
                },
                closeImportModal() { this.showImportModal = false; this.importClasses = ['']; this.importModalError = ''; },
                addImportClassInput() { this.importClasses.push(''); },
                removeImportClassInput(index) { this.importClasses.splice(index, 1); },
                importUnderachievers() {
                     if (this.role !== '교과교사') return;
                     this.importModalError = '';
                     const subject = this.teacherPlan.subjectName.trim();
                     if (!subject) { this.importModalError = '먼저 과목명을 입력하고 저장해주세요.'; return; }
                     
                     const classes = this.importClasses.map(c => c.trim()).filter(Boolean);
                     if (classes.length === 0) { this.importModalError = '학급을 입력해주세요.'; return; }
                     
                     const allUnderachievers = this.deployedUnderachievers;
                     if (!allUnderachievers || allUnderachievers.length === 0) { this.importModalError = '배포된 미도달 학생 명단이 없습니다.'; return; }

                     const filteredStudents = allUnderachievers.filter(student => {
                         if (!student || !student.id) return false;
                         const studentClassId = student.id.substring(0, 3);
                         const classMatch = classes.includes(studentClassId);
                         if (!classMatch) return false;
                         const gradeMatch = (student.gradeSubjects || []).some(s => s && s.name === subject);
                         const attendanceMatch = (student.attendanceSubjects || []).includes(subject);
                         return gradeMatch || attendanceMatch;
                     });

                     if (filteredStudents.length === 0) { this.importModalError = '해당 조건에 맞는 학생을 찾을 수 없습니다.'; return; }

                     const newSupplementaryStudents = [];
                     let addedCount = 0;
                     const currentSuppStudents = this.teacherGuidanceData.supplementary.students;
                     const currentSuppIds = new Set(currentSuppStudents.map(s => s.id));

                     filteredStudents.forEach(newStudent => {
                         let reason = '';
                         const gradeMatch = (newStudent.gradeSubjects || []).some(s => s.name === subject);
                         const attendanceMatch = (newStudent.attendanceSubjects || []).includes(subject);
                         if (gradeMatch && attendanceMatch) reason = '학업성취율&과목출석률';
                         else if (gradeMatch) reason = '학업성취율';
                         else if (attendanceMatch) reason = '과목출석률';

                         if (!currentSuppIds.has(newStudent.id)) {
                             newSupplementaryStudents.push({ id: newStudent.id, name: newStudent.name, reason: reason });
                             addedCount++;
                         }
                     });

                     if (addedCount > 0) {
                         this.teacherGuidanceData.supplementary.students.push(...newSupplementaryStudents);
                         this.teacherGuidanceData.supplementary.students.sort((a, b) => a.id.localeCompare(b.id));
                         this.teacherGuidanceData.supplementary.sessions.forEach(session => { if (!session) return; if (!session.attendance) session.attendance = {}; newSupplementaryStudents.forEach(student => { if (student && !session.attendance.hasOwnProperty(student.id)) { session.attendance[student.id] = ''; } }); });
                         this.saveGuidanceData();
                         alert(`${addedCount}명의 학생을 추가했습니다.`);
                         this.closeImportModal();
                     } else { this.importModalError = '새로 추가할 학생이 없습니다. (이미 목록에 있거나 조건 불일치)'; }
                },
                resetSupplementaryStudents() {
                     if (this.role !== '교과교사') return;
                     if (this.teacherGuidanceData.supplementary) {
                         this.teacherGuidanceData.supplementary.students = [];
                         this.teacherGuidanceData.supplementary.sessions.forEach(session => { if(session) session.attendance = {}; });
                         this.saveGuidanceData();
                     }
                },

                // --- Homeroom Teacher Methods ---
                searchHomeroomClass(){
                     if(this.role !== '담임교사') return;
                     this.homeroomMessage = '';
                     const classInput = this.homeroomClassInput.trim();
                     if(!classInput){ this.homeroomMessage = '학급 번호를 입력해주세요.'; this.searchedStudents = []; return; }
                     
                     const allStudents = this.deployedUnderachievers;
                     if (!allStudents || allStudents.length === 0) { this.homeroomMessage = '관리자가 배포한 학생 데이터가 없습니다.'; this.searchedStudents = []; return; }

                     const filtered = allStudents.filter(s => s && s.id && s.id.startsWith(classInput));
                     
                     if(filtered.length > 0){
                         this.searchedStudents = filtered;
                         this.homeroomMessage = `${classInput}반 미도달 학생 ${filtered.length}명을 조회했습니다.`;
                     } else {
                         this.searchedStudents = [];
                         this.homeroomMessage = `해당 학급에 미도달 학생이 없습니다.`;
                     }
                },
                
                // --- Helper functions ---
                resetRoleSpecificData() {
                    Object.assign(this.teacherPlan, this.getInitialTeacherPlan());
                    this.teacherGuidanceData = this.getInitialGuidanceData();
                    this.teacherPlanError = ''; this.teacherPlanStatus = ''; this.newGuidanceStudentId = '';
                    this.homeroomClassInput = ''; this.searchedStudents = []; this.homeroomMessage = '';
                },
                resetAllLocalData(resetAuth = true) {
                    if (resetAuth) {
                        this.user = null; this.isLoggedIn = false;
                    }
                    this.role = null; this.schoolId = null;
                    this.curriculumData = []; this.studentData = []; this.emotionalSupportData = [];
                    this.deployedUnderachievers = []; this.underachievers = [];
                    this.resetRoleSpecificData();
                    Object.assign(this.moduleConfig, this.$options.data().moduleConfig);
                    Object.assign(this.newsletterForm, this.$options.data().newsletterForm);
                    Object.assign(this.pledgeForm, this.$options.data().pledgeForm);
                    this.uploadStatus = { curriculum: '', student: '', emotionalSupport: '' };
                    this.statusMessage = ''; this.moduleConfigStatus = ''; this.underachieversStatus = ''; this.adminActionStatus = '';
                },
                resetTeacherData(resetGuidance = true) {
                     Object.assign(this.teacherPlan, this.getInitialTeacherPlan());
                     if (resetGuidance) { this.teacherGuidanceData = this.getInitialGuidanceData(); }
                     this.teacherPlanError = ''; this.teacherPlanStatus = ''; this.newGuidanceStudentId = '';
                },

                // --- Admin Modify Modal Methods ---
                openAdminModifyModal() {
                    if (this.role !== '관리자') return;
                    this.newSchoolIdForModify = this.schoolId;
                    this.adminModifyMode = 'schoolId';
                    this.adminModifyError = '';
                    this.showAdminModifyModal = true;
                },
                async saveAdminSchoolIdModification() {
                    this.adminModifyError = '';
                    const newId = this.newSchoolIdForModify.trim();
                    const invalidChars = /[\s./*#$[\]]/;

                    if (!newId) { this.adminModifyError = "학교 고유 ID를 입력해주세요."; return; }
                    if (invalidChars.test(newId)) { this.adminModifyError = "공백이나 특수문자 (/, ., *, # 등)는 사용할 수 없습니다."; return; }
                    if (newId === this.schoolId) { this.showAdminModifyModal = false; return; }

                    this.isLoading = true;
                    this.showAdminModifyModal = false;

                    this.schoolId = newId;
                    await this.saveUserRoleAndSchoolId(this.role);
                    
                    // 현재 인증 상태를 제외한 모든 로컬 데이터 초기화
                    this.resetAllLocalData(false);
                    
                    // 역할과 새 schoolId 복원
                    this.role = '관리자';
                    this.schoolId = newId;

                    // 새 schoolId로 데이터 다시 로드
                    await this.loadCommonData();
                    this.underachievers = JSON.parse(JSON.stringify(this.deployedUnderachievers));
                    
                    this.isLoading = false;
                    this.newSchoolIdForModify = '';
                    this.$nextTick(() => { this.initFlatpickr(); });
                },
            },

            mounted() {
                 if (auth) {
                    this.initApp();
                 }
            }

        }).mount('#app');

    </script>
</body>
</html>
