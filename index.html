<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>최소 성취수준 보장지도 관리 웹앱</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

  <!-- XLSX, FileSaver, html2canvas, jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: 'Inter', 'Pretendard', sans-serif; background: #f9fafb; }
    [v-cloak] { display: none; }
    .modal-overlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.5); z-index: 50;
    }
    .modal-content {
      background: white; border-radius: 0.75rem;
      padding: 2rem; width: 90%; max-width: 480px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .tab-button {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all .3s;
    }
    .tab-button.active {
      border-color: #4f46e5;
      color: #4f46e5;
      font-weight: bold;
    }
  </style>
</head>

<body>
<div id="app" v-cloak class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center h-16">
      <div class="flex items-center space-x-2">
        <svg class="w-7 h-7 text-indigo-600" xmlns="http://www.w3.org/2000/svg"
             fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 6.253v11.494m-9-5.747h18"/>
        </svg>
        <span class="text-gray-800 font-bold text-xl">최소 성취수준 보장지도 관리</span>
      </div>
      <div>
        <button v-if="!isLoggedIn" @click="login"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm">
          Google 로그인
        </button>
        <div v-else class="flex items-center space-x-3">
          <span class="text-sm text-gray-600">{{ user?.email }}</span>
          <span v-if="role" class="text-gray-600 text-sm">[{{ role }}]</span>
          <span v-if="schoolId" class="text-xs text-gray-500">학교ID: {{ schoolId }}</span>
          <button @click="logout"
                  class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-sm rounded">
            로그아웃
          </button>
          <button v-if="role" @click="resetRole"
                  class="px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-sm rounded">
            역할 재선택
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-grow container mx-auto p-6 text-center">

    <div v-if="isLoading" class="mt-10 text-gray-500">로딩 중...</div>

    <!-- 로그인 안내 -->
    <div v-if="!isLoggedIn && !isLoading" class="mt-20">
      <h2 class="text-2xl font-bold text-gray-800 mb-3">Google 계정으로 로그인</h2>
      <p class="text-gray-600 mb-6">
        서비스 이용을 위해 <b>Google 계정</b>으로 로그인 후<br>역할을 선택하세요.
      </p>
      <button @click="login"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded shadow-md transition">
        Google 로그인하기
      </button>
    </div>

    <!-- 역할 선택 -->
    <div v-if="isLoggedIn && !role && !isLoading" class="modal-overlay">
      <div class="modal-content">
        <h3 class="text-xl font-bold mb-4 text-center">역할 선택</h3>
        <button @click="selectRole('교과교사')" class="w-full text-left bg-gray-100 px-4 py-3 mb-2 rounded hover:bg-gray-200">
          교과교사
        </button>
        <button @click="selectRole('담임교사')" class="w-full text-left bg-gray-100 px-4 py-3 mb-2 rounded hover:bg-gray-200">
          담임교사
        </button>
        <button @click="showAdminCodeInput = true" class="w-full text-left bg-gray-100 px-4 py-3 rounded hover:bg-gray-200">
          관리자
        </button>

        <div v-if="showAdminCodeInput" class="mt-3 text-left">
          <input type="password" v-model="adminCode"
                 placeholder="관리자 코드 입력 (0822)"
                 class="border w-full p-2 rounded mb-2">
          <button @click="submitAdminCode"
                  class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
            확인
          </button>
          <p v-if="adminCodeError" class="text-red-500 text-sm mt-1">{{ adminCodeError }}</p>
        </div>
      </div>
    </div>

    <!-- 학교 ID 모달 -->
    <div v-if="showSchoolIdModal" class="modal-overlay">
      <div class="modal-content">
        <h3 class="text-xl font-bold mb-4 text-center">
          학교 고유 ID {{ schoolIdMode==='create'?'생성':'입력' }}
        </h3>
        <p v-if="schoolIdMode==='create'" class="text-sm text-gray-600 mb-2">
          관리자 인증이 완료되었습니다. 새 학교 ID를 생성해주세요.
        </p>
        <p v-else class="text-sm text-gray-600 mb-2">
          학교 관리자에게 받은 학교 ID를 입력하세요.
        </p>
        <input type="text" v-model="newSchoolId" placeholder="학교 ID 입력"
               class="border w-full p-2 rounded mb-2">
        <button @click="handleSchoolIdSubmit"
                class="bg-indigo-600 hover:bg-indigo-700 text-white w-full py-2 rounded">
          저장
        </button>
        <p v-if="schoolIdError" class="text-sm text-red-500 mt-1">{{ schoolIdError }}</p>
      </div>
    </div>
    <!-- ========================= 관리자 / 교과 / 담임 대시보드 ========================= -->
    <div v-if="isLoggedIn && role && schoolId && !isLoading" class="text-left mt-6">

      <!-- ───────────── 관리자 대시보드 ───────────── -->
      <section v-if="role==='관리자'" class="space-y-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">관리자 대시보드 (학교 ID: {{ schoolId }})</h2>

        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">① 교육과정 편제표 업로드</h3>
          <div class="flex space-x-3">
            <button @click="downloadTemplate('curriculum')" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
              양식 다운로드
            </button>
            <input type="file" @change="uploadFile($event, 'curriculum')" class="hidden" id="curriculum-upload">
            <label for="curriculum-upload"
                   class="px-4 py-2 bg-blue-500 text-white rounded cursor-pointer hover:bg-blue-600">
              엑셀 업로드
            </label>
          </div>
          <p v-if="uploadStatus.curriculum" class="text-sm mt-1 text-gray-700">{{ uploadStatus.curriculum }}</p>
        </div>

        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">② 학적 정보 업로드</h3>
          <div class="flex space-x-3">
            <button @click="downloadTemplate('student')" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
              양식 다운로드
            </button>
            <input type="file" @change="uploadFile($event,'student')" class="hidden" id="student-upload">
            <label for="student-upload"
                   class="px-4 py-2 bg-blue-500 text-white rounded cursor-pointer hover:bg-blue-600">
              엑셀 업로드
            </label>
          </div>
          <p v-if="uploadStatus.student" class="text-sm mt-1 text-gray-700">{{ uploadStatus.student }}</p>
        </div>

        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-3">③ 운영 모듈 설계</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-700">학점당 시수</label>
              <input type="number" v-model.number="moduleConfig.hoursPerCredit"
                     class="w-full border p-2 rounded">
            </div>
            <div>
              <label class="text-sm text-gray-700">예방지도 연계 비율(%)</label>
              <input type="number" v-model.number="moduleConfig.preventiveRatio"
                     class="w-full border p-2 rounded">
            </div>
            <div>
              <label class="text-sm text-gray-700">정서지원 연계 비율(%)</label>
              <input type="number" v-model.number="moduleConfig.emotionalSupportRatio"
                     class="w-full border p-2 rounded">
            </div>
          </div>
          <button @click="saveModuleConfig"
                  class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
            운영 모듈 저장
          </button>
          <p v-if="moduleConfigStatus" class="text-green-600 text-sm mt-2">{{ moduleConfigStatus }}</p>
        </div>

        <div class="bg-white p-6 rounded shadow">
          <h3 class="text-lg font-semibold mb-2">④ 대상자 선정</h3>
          <div class="space-x-3">
            <input type="file" multiple @change="processGradeFiles" class="hidden" id="grade-upload">
            <label for="grade-upload" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
              성적파일 업로드
            </label>
            <button @click="showAttendanceModal=true"
                    class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
              출석률 미도달 학생 입력
            </button>
          </div>

          <p v-if="fileProcessingError" class="text-red-600 mt-2 text-sm">{{ fileProcessingError }}</p>
          <!-- 미도달학생 표는 하단 3/3에서 이어짐 -->
        </div>
      </section>

      <!-- ───────────── 교과교사 대시보드 ───────────── -->
      <section v-if="role==='교과교사'" class="space-y-6 mt-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-4">
          교과교사 대시보드 (학교ID: {{ schoolId }})
        </h2>
        <div class="flex border-b mb-4">
          <button class="tab-button" :class="{ active: teacherTab==='plan' }"
                  @click="switchTeacherTab('plan')">계획서 작성</button>
          <button class="tab-button" :class="{ active: teacherTab==='preventive' }"
                  @click="switchTeacherTab('preventive')">예방지도</button>
          <button class="tab-button" :class="{ active: teacherTab==='supplementary' }"
                  @click="switchTeacherTab('supplementary')">보충지도</button>
        </div>
        <!-- 계획서 작성 -->
        <div v-if="teacherTab==='plan'">
          <div class="bg-white p-6 rounded shadow space-y-4 text-sm text-left">
            <p><b>AI 모델 선택:</b></p>
            <select v-model="teacherPlan.aiProvider" class="border p-2 rounded">
              <option value="open">OpenAI</option>
              <option value="gemini">Gemini</option>
              <option value="claude">Claude</option>
            </select>

            <div v-if="teacherPlan.aiProvider!=='openai'">
              <input type="password" placeholder="API Key 입력"
                     v-model="teacherPlan.apiKey"
                     class="border w-full p-2 rounded mt-2">
            </div>

            <label class="block mt-2">과목명</label>
            <input type="text" v-model="teacherPlan.subjectName"
                   @change="handleSubjectChange"
                   placeholder="편제표에 등록된 과목명"
                   class="w-full border p-2 rounded">

            <h4 class="mt-4 font-bold">성취기준 및 최소 성취수준 진술문</h4>
            <div v-for="(a,index) in teacherPlan.achievements" :key="index"
                 class="border rounded p-3 my-2">
              <textarea v-model="a.text" placeholder="성취기준 입력" class="w-full border p-1 rounded mb-2"></textarea>
              <button @click="generateStatement(index)"
                      class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">AI진술문 생성</button>
              <div v-if="a.statement" class="bg-gray-50 border p-2 mt-2">{{ a.statement }}</div>
            </div>
            <button @click="addAchievement"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded text-sm">+ 추가</button>

            <button @click="generatePlanPreview"
                    class="block bg-indigo-600 text-white rounded px-3 py-2 mt-3 hover:bg-indigo-700">
              계획서 미리보기
            </button>
          </div>
        </div>

        <!-- 예방지도 -->
        <div v-if="teacherTab==='preventive'" class="bg-white p-6 rounded shadow text-left">
          <h3 class="font-semibold mb-2 text-lg">예방지도 출석부</h3>
          <p class="text-sm text-gray-500 mb-2">학생 추가 및 출석부 관리</p>
          <input type="text" placeholder="학번 입력" v-model="newGuidanceStudentId"
                 @keyup.enter="addGuidanceStudent('preventive')"
                 class="border p-2 rounded w-52">
          <button @click="addGuidanceStudent('preventive')"
                  class="bg-indigo-600 text-white px-3 py-1 rounded ml-2 hover:bg-indigo-700 text-sm">
            추가
          </button>

          <div class="mt-4 overflow-x-auto">
            <table class="min-w-full border text-sm">
              <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-1">학번</th>
                <th class="border px-2 py-1">이름</th>
                <th class="border px-2 py-1" v-for="(s,i) in teacherGuidanceData.preventive.sessions">
                  {{i+1}}차시
                </th>
              </tr>
              </thead>
              <tbody>
              <tr v-for="st in teacherGuidanceData.preventive.students">
                <td class="border px-2 py-1">{{ st.id }}</td>
                <td class="border px-2 py-1">{{ st.name }}</td>
                <td class="border px-2 py-1" v-for="(s,i) in teacherGuidanceData.preventive.sessions">
                  <select v-model="s.attendance[st.id]" class="border p-1 text-xs rounded">
                    <option value="">-</option>
                    <option v-for="m in moduleConfig.recognizedHours"
                            :value="m.name">{{ m.name }}</option>
                  </select>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 보충지도 -->
        <div v-if="teacherTab==='supplementary'" class="bg-white p-6 rounded shadow text-left">
          <h3 class="font-semibold mb-2 text-lg">보충지도 관리</h3>
          <p class="text-sm text-gray-500">관리자가 배포한 대상 명단에서 불러오세요.</p>
          <button @click="showImportModal=true"
                  class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-sm">명단 가져오기</button>
          <table class="min-w-full border mt-3 text-sm">
            <thead><tr class="bg-gray-100">
              <th class="border px-2 py-1">학번</th><th class="border px-2 py-1">이름</th><th class="border px-2 py-1">사유</th>
            </tr></thead>
            <tbody>
              <tr v-for="s in teacherGuidanceData.supplementary.students">
                <td class="border px-2 py-1">{{s.id}}</td>
                <td class="border px-2 py-1">{{s.name}}</td>
                <td class="border px-2 py-1">{{s.reason}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ───────────── 담임교사 대시보드 ───────────── -->
      <section v-if="role==='담임교사'" class="mt-8 space-y-6">
        <h2 class="text-3xl font-bold text-gray-800 mb-4">담임교사 대시보드 (학교ID: {{ schoolId }})</h2>
        <div class="bg-white p-6 rounded shadow max-w-3xl">
          <label class="block mb-1 text-sm text-gray-600">학급 입력 (예: 101)</label>
          <div class="flex space-x-2 mb-3">
            <input type="text" v-model="homeroomClassInput"
                   placeholder="학급번호 입력"
                   class="border p-2 rounded w-40">
            <button @click="searchHomeroomClass"
                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm">
              조회
            </button>
          </div>
          <p v-if="homeroomMessage" class="text-sm text-gray-600">{{ homeroomMessage }}</p>
        </div>

        <div v-if="processedHomeroomStudents.length>0" class="bg-white rounded p-6 shadow">
          <h3 class="text-lg font-semibold mb-2">미도달 학생 현황</h3>
          <table class="min-w-full border text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-1">학번</th>
                <th class="border px-2 py-1">이름</th>
                <th class="border px-2 py-1">과목</th>
                <th class="border px-2 py-1">사유</th>
                <th class="border px-2 py-1">서류출력</th>
              </tr>
            </thead>
            <tbody>
              <template v-for="(row,index) in processedHomeroomStudents">
                <tr>
                  <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="border px-2 py-1">{{row.id}}</td>
                  <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="border px-2 py-1">{{row.name}}</td>
                  <td class="border px-2 py-1">{{row.subject}}</td>
                  <td class="border px-2 py-1">{{row.reason}}</td>
                  <td v-if="row.isFirstRow" :rowspan="row.rowspan" class="border px-2 py-1 text-center">
                    <button @click="printHomeroomStudentForm(row.originalStudent,'newsletter')"
                            class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-2 py-1 rounded mb-1">가정통신문</button>
                    <button @click="printHomeroomStudentForm(row.originalStudent,'pledge')"
                            class="bg-green-600 hover:bg-green-700 text-white text-xs px-2 py-1 rounded">서약서</button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </section>
    </div>

        <!-- ───────────── 공통 모달(인쇄, 임포트, 출석, 프리뷰 등) ───────────── -->

    <!-- 출석률 미도달 모달 -->
    <div v-if="showAttendanceModal" class="modal-overlay" @click.self="closeAttendanceModal">
      <div class="modal-content">
        <h3 class="text-xl font-bold mb-3">출석률 미도달 학생 추가</h3>
        <form @submit.prevent="addAttendanceStudent">
          <input v-model="newAttendanceStudent.id" placeholder="학번" required class="w-full border p-2 mb-2 rounded">
          <div v-for="(s,i) in newAttendanceStudent.subjects" :key="i" class="flex items-center space-x-2 mb-1">
            <input v-model="newAttendanceStudent.subjects[i]" placeholder="과목명" class="border p-2 flex-grow rounded">
            <button type="button" @click="removeAttendanceSubject(i)" class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">-</button>
          </div>
          <button type="button" @click="addAttendanceSubject" class="w-full bg-gray-200 hover:bg-gray-300 text-sm py-2 rounded mt-1">+ 과목 추가</button>
          <div class="flex justify-end space-x-2 mt-3">
            <button type="button" @click="closeAttendanceModal" class="px-4 py-1 bg-gray-300 rounded">취소</button>
            <button type="submit" class="px-4 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">추가</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 프리뷰 모달 -->
    <div v-if="showPreviewModal" class="modal-overlay" @click.self="closePreviewModal">
      <div class="modal-content modal-preview overflow-y-auto max-h-[90vh]">
        <div id="print-area-container-in-modal">
          <div v-html="previewHtml"></div>
        </div>
        <div class="flex justify-end mt-3 space-x-2">
          <button @click="closePreviewModal" class="px-4 py-1 bg-gray-300 rounded">닫기</button>
          <button @click="printPreviewModalContent" class="px-4 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded">PDF 저장</button>
        </div>
      </div>
    </div>

    <!-- 임포트 모달 -->
    <div v-if="showImportModal" class="modal-overlay" @click.self="closeImportModal">
      <div class="modal-content">
        <h3 class="text-lg font-bold mb-3">보충지도 대상자 가져오기</h3>
        <form @submit.prevent="importUnderachievers">
          <label class="block text-sm mb-2 text-gray-700">과목명: <b>{{teacherPlan.subjectName||'미입력'}}</b></label>
          <div>
            <p class="text-xs mb-1 text-gray-500">가져올 학급번호 입력 (예: 101)</p>
            <div v-for="(c,i) in importClasses" :key="i" class="flex items-center space-x-2 mb-2">
              <input v-model="importClasses[i]" placeholder="학급" class="border p-2 flex-grow rounded">
              <button type="button" @click="removeImportClassInput(i)" class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">-</button>
            </div>
            <button type="button" @click="addImportClassInput" class="w-full text-sm bg-gray-200 hover:bg-gray-300 py-1 rounded">+ 학급 추가</button>
          </div>
          <div class="flex justify-end space-x-2 mt-3">
            <button type="button" @click="closeImportModal" class="px-3 py-1 bg-gray-300 rounded">취소</button>
            <button type="submit" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded">가져오기</button>
          </div>
        </form>
        <p v-if="importModalError" class="text-red-500 text-sm mt-2">{{ importModalError }}</p>
      </div>
    </div>

    <!-- 인쇄 영역 컨테이너 -->
    <div id="print-area-container" class="hidden"></div>

  </main>
</div>

<!-- ======================= Vue + Firebase (Popup 로그인 방식) ======================= -->
<script type="module">
import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js';
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyD_KHsc9Izjj38b44-2GcH1YDKoQ9Sek1k",
  authDomain: "min-achievement-app-184d2.firebaseapp.com",
  projectId: "min-achievement-app-184d2",
  storageBucket: "min-achievement-app-184d2.appspot.com",
  messagingSenderId: "177231838739",
  appId: "1:177231838739:web:7e2f2b2cf20d8e4e2949e6",
  measurementId: "G-4GT4CZRPXB"
};

const appFb = initializeApp(firebaseConfig);
const auth = getAuth(appFb);
const db = getFirestore(appFb);

createApp({
  data() {
    return {
      user: null, isLoggedIn: false, isLoading: true,
      role: null, schoolId: null,
      showAdminCodeInput: false, adminCode: '', adminCodeError: '',
      showSchoolIdModal: false, schoolIdMode: 'join', newSchoolId: '', schoolIdError: '',
      showAttendanceModal: false, showPreviewModal: false, showImportModal: false,
      previewHtml: '', teacherTab:'plan',
      moduleConfig:{hoursPerCredit:1, preventiveRatio:50, emotionalSupportRatio:20, recognizedHours:[
        {name:'대면지도',hours:1},{name:'온라인콘텐츠',hours:1},{name:'보충과제',hours:1}
      ]},
      uploadStatus:{}, importClasses:[''], importModalError:'',
      teacherPlan:{subjectName:'', achievements:[{text:'',statement:''}]},
      teacherGuidanceData:{preventive:{students:[],sessions:[{attendance:{}}]},supplementary:{students:[],sessions:[{attendance:{}}]}}
    };
  },
  methods:{
    async login(){
      const provider=new GoogleAuthProvider();
      try{
        const result=await signInWithPopup(auth,provider);
        this.user=result.user; this.isLoggedIn=true;
        await this.loadUserRoleAndSchoolId();
      }catch(e){alert('로그인 실패:'+e.message);}
    },
    async logout(){await signOut(auth); this.resetAll();},
    async resetRole(){
      if(!this.user)return; await setDoc(doc(db,"userData",this.user.uid),{role:null},{merge:true});
      this.role=null; alert('역할 재선택이 가능합니다.');
    },
    resetAll(){this.user=null;this.isLoggedIn=false;this.role=null;this.schoolId=null;},
    async initApp(){
      onAuthStateChanged(auth, async (user)=>{
        this.isLoading=true;
        if(user){
          this.user=user; this.isLoggedIn=true;
          await this.loadUserRoleAndSchoolId();
        }else{this.resetAll();}
        this.isLoading=false;
      });
    },
    async selectRole(r){
      if(r==='관리자'){this.showAdminCodeInput=true;}
      else{
        this.role=r; await this.saveUserRoleAndSchoolId(r);
        if(!this.schoolId)this.showSchoolIdModal=true;
      }
    },
    async submitAdminCode(){
      if(this.adminCode==='0822'){this.role='관리자';await this.saveUserRoleAndSchoolId('관리자');this.schoolIdMode='create';this.showSchoolIdModal=true;}
      else this.adminCodeError='코드 오류';
    },
    async handleSchoolIdSubmit(){
      if(!this.newSchoolId.trim()){this.schoolIdError='학교ID 입력';return;}
      this.schoolId=this.newSchoolId.trim();
      await this.saveUserRoleAndSchoolId(this.role);
      this.showSchoolIdModal=false;
    },
    async saveUserRoleAndSchoolId(roleToSave){
      if(!this.user)return;
      await setDoc(doc(db,"userData",this.user.uid),{role:roleToSave,schoolId:this.schoolId||null},{merge:true});
    },
    async loadUserRoleAndSchoolId(){
      if(!this.user)return;
      const s=await getDoc(doc(db,"userData",this.user.uid));
      if(s.exists()){const d=s.data();this.role=d.role;this.schoolId=d.schoolId;}
    },
    // --- 나머지 원본 기능 요약 (AI진술문, 파일업로드, 미리보기 등 동일) ---
    generatePlanPreview(){
      this.previewHtml=`<div id='print-area'>
         <h1>${this.teacherPlan.subjectName||'과목명 미입력'}</h1>
         <p>AI 진술문 샘플 출력...</p>
      </div>`;
      this.showPreviewModal=true;
    },
    printPreviewModalContent(){window.print();},
    closePreviewModal(){this.showPreviewModal=false;this.previewHtml='';},
    closeAttendanceModal(){this.showAttendanceModal=false;},
    addAttendanceSubject(){this.newAttendanceStudent.subjects.push('');},
    removeAttendanceSubject(i){this.newAttendanceStudent.subjects.splice(i,1);},
    addGuidanceStudent(t){/* ... 생략 ... */}
  },
  mounted(){this.initApp();}
}).mount('#app');
</script>

</body>
</html>

