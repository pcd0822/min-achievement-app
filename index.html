<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>최소 성취수준 보장지도 관리 웹 앱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Inter', 'Pretendard', sans-serif; }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 500px;
        }
        /* Adjusted modal-preview for better A4-like preview */
        .modal-preview {
             width: 210mm; /* A4 width */
             max-width: 95%;
             max-height: 90vh; /* Limit height */
             overflow-y: auto; /* Allow scrolling */
        }
        /* Styles specifically for the preview/print area */
        #print-area {
            font-family: 'Malgun Gothic', sans-serif;
            color: black;
            background: white;
            padding: 10mm; /* Add padding for visual spacing */
             box-sizing: border-box; /* Include padding in width calculation */
        }
         #print-area h1, #print-area h3, #print-area h4 {
             /* Add some basic heading styles */
             margin-top: 1.5em;
             margin-bottom: 0.8em;
             font-weight: bold;
         }
         #print-area table {
             width: 100%;
             border-collapse: collapse;
             margin-top: 10px;
             font-size: 9pt; /* Smaller font for tables */
             table-layout: fixed; /* Helps with column width control */
         }
         #print-area th, #print-area td {
             border: 1px solid #666; /* Darker border for print */
             padding: 6px;
             text-align: center;
             vertical-align: middle; /* Center vertically */
             word-wrap: break-word; /* Wrap long text */
         }
          #print-area th {
              background-color: #f2f2f2;
          }
         #print-area .text-left {
             text-align: left;
         }
         #print-area .whitespace-pre-wrap {
            white-space: pre-wrap; /* Preserve line breaks in textareas */
            word-break: break-all;
         }
         #print-area .signature-section {
             margin-top: 50px;
             display: flex;
             justify-content: space-around;
             text-align: center;
         }
         #print-area .seal-section {
            text-align: center;
            margin-top: 50px;
         }
         #print-area .seal-section img {
            width: 70px; /* Adjust seal size */
            height: 70px;
            margin: 0 auto;
         }
         #print-area .school-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 30px;
         }


        [v-cloak] { display: none; }

        .table-cell-content {
            padding: 0.5rem 0;
            min-height: 2.5rem; /* Ensures consistent row height */
            display: flex;
            align-items: center;
        }

        .table-cell-content:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }

        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 30;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #4a5568;
            transition: all 0.2s ease-in-out;
        }
        .scroll-arrow:hover {
            background-color: rgba(255, 255, 255, 0.9);
            transform: translateY(-50%) scale(1.1);
        }
        .scroll-arrow.left { left: -1.25rem; }
        .scroll-arrow.right { right: -1.25rem; }

        /* Print-specific styles */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background-color: white; /* Ensure white background for print */
            }
            body * {
                 visibility: hidden; /* Hide everything initially */
            }
             /* Show only the print area and its contents */
            #print-area-container, #print-area-container * {
                visibility: visible;
            }
            #print-area-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                 margin: 0;
                 padding: 0;
                 border: none;
                 background-color: white;
            }
            #print-area {
                padding: 0; /* Remove padding for actual print */
                 margin: 20mm; /* Apply margin for printing */
                 border: none;
                 box-shadow: none;
                 width: auto; /* Let the print media control width */
                 font-size: 10pt; /* Adjust base font size for print */
                 color: black !important; /* Ensure black text */
                 background: white !important; /* Ensure white background */
            }
             #print-area table { font-size: 8pt; } /* Further reduce table font if needed */
             #print-area th, #print-area td { padding: 4px; }

            .modal-overlay, header, main > div:not(#print-area-container) {
                display: none !important; /* Ensure modals and other UI are hidden */
            }

            @page {
                size: A4 portrait; /* Explicitly set size and orientation */
                margin: 20mm; /* Consistent margin */
            }
            .page-break {
                page-break-after: always;
                 visibility: visible !important; /* Make sure page breaks work */
            }
            /* Ensure images print */
             img {
                 visibility: visible;
                 max-width: 100%; /* Prevent images from overflowing */
                 height: auto;
             }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" v-cloak class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"/>
                        </svg>
                        <h1 class="ml-2 text-2xl font-bold text-gray-800">최소 성취수준 보장지도 관리</h1>
                    </div>
                     <!-- Role reset button (visible only after role selection) -->
                    <div v-if="role" class="flex items-center space-x-4">
                         <span class="text-gray-600 font-semibold">[{{ role }}] 모드</span>
                         <button @click="resetRole" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition text-sm">역할 재선택</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Role Selection Modal (Show if role is not selected) -->
            <div v-if="!role" class="modal-overlay">
                <div class="modal-content">
                    <h3 class="text-2xl font-bold mb-6 text-center">역할 선택</h3>
                    <div class="space-y-4">
                        <button @click="selectRole('교과교사')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">교과교사</button>
                        <button @click="selectRole('담임교사')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">담임교사</button>
                        <div>
                            <button @click="selectRole('관리자')" class="w-full text-left px-6 py-4 bg-gray-100 rounded-lg hover:bg-gray-200 transition">관리자</button>
                            <div v-if="showAdminCodeInput" class="mt-2">
                                <input type="password" v-model="adminCode" @keyup.enter="submitAdminCode" placeholder="관리자 코드 입력 (0822)" class="w-full p-2 border rounded-md">
                                <button @click="submitAdminCode" class="w-full mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">확인</button>
                                <p v-if="adminCodeError" class="text-red-500 text-sm mt-1">{{ adminCodeError }}</p>
                            </div>
                        </div>
                    </div>
                    <p v-if="statusMessage" class="mt-4 text-center text-sm text-blue-600">{{ statusMessage }}</p>
                </div>
            </div>

             <!-- Main Dashboard (Show only if role is selected) -->
             <div v-if="role">
                <!-- Admin View -->
                 <div v-if="role === '관리자'">
                    <!-- Admin Content Here (Simplified) -->
                     <div class="space-y-8">
                         <h2 class="text-3xl font-bold text-gray-800">관리자 대시보드 (임시)</h2>
                        <p class="mb-4 text-gray-700">참고: 관리자 기능은 현재 단순화되어 있으며, 데이터는 새로고침 시 초기화됩니다. 데이터 업로드 및 모듈 설정은 '교과교사' 탭에서 진행해주세요.</p>

                        <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="text-xl font-semibold mb-4">4. 대상자 선정 (기능 비활성화)</h3>
                             <p class="text-sm text-gray-500">현재 버전에서는 성적 파일 처리 및 대상자 자동 선정이 불가능합니다. 교과교사가 수동으로 학생을 추가해야 합니다.</p>
                             <!-- Add underachiever list display for viewing purposes -->
                             <div v-if="underachievers.length > 0" class="mt-6">
                                <h4 class="text-lg font-semibold mb-2">현재 추가된 미도달 학생 목록 (읽기 전용)</h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-xs">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">학번</th>
                                                <th class="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">이름</th>
                                                <th class="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">미도달 과목 (성적)</th>
                                                <th class="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">미도달 과목 (출석)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="student in underachievers" :key="student.id">
                                                <td class="px-4 py-2 border-b">{{ student.id }}</td>
                                                <td class="px-4 py-2 border-b">{{ student.name }}</td>
                                                <td class="px-4 py-2 border-b">{{ student.gradeSubjects.map(s => s.name).join(', ') || '-' }}</td>
                                                <td class="px-4 py-2 border-b">{{ student.attendanceSubjects.join(', ') || '-' }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                             </div>
                             <p v-else class="text-sm text-gray-500 mt-4">아직 추가된 미도달 학생이 없습니다.</p>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="text-xl font-semibold mb-4">5. 가정통신문 및 서약서 양식 관리 (미리보기만 가능)</h3>
                             <p class="text-sm text-gray-500 mb-4">양식은 현재 고정되어 있으며 교과교사/담임교사 탭에서 미리보기할 수 있습니다.</p>
                             <div class="flex space-x-2">
                                <button @click="previewFormAdmin('newsletter')" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 text-sm">가정통신문 미리보기 (샘플)</button>
                                <button @click="previewFormAdmin('pledge')" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 text-sm">서약서 미리보기 (샘플)</button>
                             </div>
                         </div>
                     </div>
                 </div>

                <!-- Teacher View -->
                 <div v-if="role === '교과교사'">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">교과교사 대시보드</h2>
                    <div class="flex border-b mb-6">
                        <button class="tab-button" :class="{ 'active': teacherTab === 'plan' }" @click="switchTeacherTab('plan')">계획서 작성</button>
                        <button class="tab-button" :class="{ 'active': teacherTab === 'preventive' }" @click="switchTeacherTab('preventive')">예방지도 출석부 & 수업일지</button>
                        <button class="tab-button" :class="{ 'active': teacherTab === 'supplementary' }" @click="switchTeacherTab('supplementary')">보충지도(추가학습) 출석부&수업일지</button>
                    </div>

                    <!-- 계획서 작성 탭 -->
                    <div v-if="teacherTab === 'plan'" class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                             <!-- Module Config Inputs -->
                            <h3 class="text-xl font-semibold mb-4">운영 모듈 설정 (임시)</h3>
                            <p class="text-sm text-gray-600 mb-4">참고: 이 설정은 페이지 새로고침 시 초기화됩니다.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">학점당 시수</label>
                                    <input type="number" v-model.number="moduleConfig.hoursPerCredit" @change="updateMaxHours" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">예방지도 연계 비율 (%)</label>
                                    <input type="number" v-model.number="moduleConfig.preventiveRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">정서지원 프로그램 연계 비율 (%)</label>
                                    <input type="number" v-model.number="moduleConfig.emotionalSupportRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">학습지원대상자 예방지도 인정비율 (%)</label>
                                    <input type="number" v-model.number="moduleConfig.specialPreventiveRatio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold mt-6 mb-2">항목별 인정시수 (1회 기준)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div v-for="(item, index) in moduleConfig.recognizedHours" :key="index">
                                    <label class="block text-sm font-medium text-gray-700">{{ item.name }}</label>
                                    <input type="number" step="0.1" v-model.number="item.hours" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                            <p v-if="moduleConfigStatus" class="mt-2 text-sm font-medium text-green-600">{{ moduleConfigStatus }}</p>
                            <!-- Removed Save button -->
                        </div>

                         <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <!-- Local Data Upload Section -->
                            <h3 class="text-xl font-semibold mb-4">데이터 업로드 (임시)</h3>
                             <p class="text-sm text-gray-600 mb-4">참고: 업로드된 데이터는 페이지 새로고침 시 사라집니다.</p>

                            <!-- 1. 교육과정 편제표 업로드 -->
                            <div class="border p-4 rounded-md">
                                <h4 class="text-lg font-semibold mb-2">1. 교육과정 편제표</h4>
                                <div class="flex space-x-4">
                                    <button @click="downloadTemplate('curriculum')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition text-sm">양식 다운로드</button>
                                    <input type="file" @change="uploadFile($event, 'curriculum')" class="hidden" id="curriculum-upload">
                                    <label for="curriculum-upload" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition text-sm">엑셀 업로드</label>
                                </div>
                                <p v-if="uploadStatus.curriculum" class="mt-2 text-xs font-medium">{{ uploadStatus.curriculum }}</p>
                            </div>

                            <!-- 2. 학적 정보 업로드 -->
                             <div class="border p-4 rounded-md">
                                <h4 class="text-lg font-semibold mb-2">2. 학적 정보</h4>
                                <div class="flex space-x-4">
                                    <button @click="downloadTemplate('student')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition text-sm">양식 다운로드</button>
                                    <input type="file" @change="uploadFile($event, 'student')" class="hidden" id="student-upload">
                                    <label for="student-upload" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition text-sm">엑셀 업로드</label>
                                </div>
                                 <p v-if="uploadStatus.student" class="mt-2 text-xs font-medium">{{ uploadStatus.student }}</p>
                             </div>

                             <!-- 2-1. 정서지원프로그램 이수시간 업로드 -->
                             <div class="border p-4 rounded-md">
                                <h4 class="text-lg font-semibold mb-2">2-1. 정서지원프로그램 이수시간</h4>
                                <div class="flex space-x-4">
                                    <button @click="downloadTemplate('emotionalSupport')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition text-sm">양식 다운로드</button>
                                    <input type="file" @change="uploadFile($event, 'emotionalSupport')" class="hidden" id="emotional-support-upload">
                                    <label for="emotional-support-upload" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition text-sm">엑셀 업로드</label>
                                </div>
                                <p v-if="uploadStatus.emotionalSupport" class="mt-2 text-xs font-medium">{{ uploadStatus.emotionalSupport }}</p>
                             </div>

                             <!-- 성적 파일 업로드 추가 -->
                              <div class="border p-4 rounded-md">
                                <h4 class="text-lg font-semibold mb-2">3. 성적 파일 업로드 (미도달 학생 추출용)</h4>
                                <div class="flex space-x-4">
                                     <input type="file" @change="processGradeFiles" multiple class="hidden" id="grade-upload">
                                     <label for="grade-upload" class="cursor-pointer px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 transition text-sm">성적 파일 선택 (복수 가능)</label>
                                </div>
                                 <p v-if="fileProcessingError" class="mt-2 text-xs font-medium text-red-500">{{ fileProcessingError }}</p>
                                <p class="mt-2 text-xs text-gray-500">성적 파일(미도달 표시된 파일)을 업로드하면 미도달 학생 목록에 자동으로 추가됩니다.</p>
                             </div>
                         </div>


                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <div>
                                <label for="aiProvider" class="block text-sm font-medium text-gray-700">AI 모델 선택</label>
                                <select id="aiProvider" v-model="teacherPlan.aiProvider" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                    <option value="gemini">Gemini</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="claude">Claude</option>
                                </select>
                            </div>
                             <!-- Removed OpenAI API Key input -->
                            <div v-if="teacherPlan.aiProvider !== 'openai'">
                                <label for="apiKey" class="block text-sm font-medium text-gray-700">{{ teacherPlan.aiProvider.toUpperCase() }} API Key</label>
                                <input type="password" id="apiKey" v-model="teacherPlan.apiKey" placeholder="선택한 AI 모델의 API 키를 입력하세요" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="subjectName" class="block text-sm font-medium text-gray-700">과목명</label>
                                <input type="text" id="subjectName" v-model="teacherPlan.subjectName" @change="updateMaxHours" placeholder="편제표에 등록된 과목명을 정확히 입력하세요" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">교과교사명</label>
                                <div v-for="(name, index) in teacherPlan.teacherNames" :key="index" class="flex items-center space-x-2 mt-2">
                                    <input type="text" v-model="teacherPlan.teacherNames[index]" placeholder="교과교사 이름을 입력하세요" class="w-full p-2 border border-gray-300 rounded-md">
                                    <button @click="removeTeacher(index)" v-if="teacherPlan.teacherNames.length > 1" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600">&times;</button>
                                </div>
                                <button @click="addTeacher" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 교과교사 추가</button>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <h3 class="text-lg font-semibold">성취기준 및 최소 성취수준 진술문</h3>
                            <div v-for="(achievement, index) in teacherPlan.achievements" :key="index" class="p-4 border rounded-md space-y-2">
                                <label class="block text-sm font-medium text-gray-700">성취기준 {{ index + 1 }}</label>
                                <textarea v-model="achievement.text" class="w-full p-2 border border-gray-300 rounded-md" rows="2"></textarea>
                                <div class="flex items-center justify-between">
                                    <button @click="generateStatement(index)" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 disabled:bg-gray-400" :disabled="(teacherPlan.aiProvider !== 'openai' && !teacherPlan.apiKey) || achievement.loading">
                                        <span v-if="!achievement.loading">최소 성취수준 진술문 생성</span>
                                        <span v-else>생성 중...</span>
                                    </button>
                                    <button @click="removeAchievement(index)" class="px-3 py-1.5 bg-red-500 text-white text-sm rounded-md hover:bg-red-600">&times; 삭제</button>
                                </div>
                                <div v-if="achievement.statement" class="mt-2 p-2 bg-gray-100 rounded-md">
                                    <p class="text-sm font-semibold">최소 성취수준 진술문:</p>
                                    <p class="text-sm text-gray-800">{{ achievement.statement }}</p>
                                </div>
                            </div>
                            <button @click="addAchievement" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 성취기준 추가</button>
                            <p v-if="teacherPlanError" class="text-red-500 text-sm mt-2">{{ teacherPlanError }}</p>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <h3 class="text-lg font-semibold">학기말 성적 산출 방법</h3>
                            <div class="flex space-x-4">
                                <label><input type="radio" v-model="teacherPlan.gradeCalculation" value="추정분할점수"> 추정분할점수</label>
                                <label><input type="radio" v-model="teacherPlan.gradeCalculation" value="고정분할점수"> 고정분할점수</label>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <h3 class="text-lg font-semibold">최소 성취수준 미도달 예방 지도 계획</h3>
                            <div class="flex space-x-4">
                                <label><input type="radio" v-model="teacherPlan.conductPrevention" value="O"> 진행함</label>
                                <label><input type="radio" v-model="teacherPlan.conductPrevention" value="X"> 진행하지 않음</label>
                            </div>
                            <div v-if="teacherPlan.conductPrevention === 'O'" class="space-y-4 pt-4 border-t">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">예방지도 대상자 선정기준</label>
                                    <textarea v-model="teacherPlan.preventionTarget" rows="3" class="mt-1 block w-full p-2 border rounded-md"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">예방지도 방법 (복수선택 가능)</label>
                                    <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                                        <label v-for="method in moduleConfig.recognizedHours" :key="method.name" class="flex items-center space-x-2">
                                            <input type="checkbox" :value="method.name" v-model="teacherPlan.preventionMethods">
                                            <span>{{ method.name }}</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">예방지도 운영 기간</label>
                                    <input type="text" class="flatpickr-range mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">차시별 지도 계획</label>
                                    <div v-for="(session, index) in teacherPlan.preventionSessions" :key="index" class="flex items-center space-x-2 mt-2">
                                        <span class="font-semibold">{{ index + 1 }}차시:</span>
                                        <input type="text" v-model="session.plan" class="w-full p-2 border rounded-md" placeholder="지도 계획을 입력하세요">
                                        <button @click="removePreventionSession(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">&times;</button>
                                    </div>
                                    <button @click="addPreventionSession" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">+ 차시 추가</button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                            <h3 class="text-lg font-semibold">보충 지도 및 추가 학습 운영 계획</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">보충지도/추가학습 방법 (복수선택 가능)</label>
                                <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                                    <label v-for="method in moduleConfig.recognizedHours" :key="method.name" class="flex items-center space-x-2">
                                        <input type="checkbox" :value="method.name" v-model="teacherPlan.supplementaryMethods">
                                        <span>{{ method.name }}</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">보충지도/추가학습 운영 기간</label>
                                <input type="text" class="flatpickr-range mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">차시별 지도 계획 (최대 {{ teacherPlan.maxSupplementaryHours }}차시)</label>
                                <div v-for="(session, index) in teacherPlan.supplementarySessions" :key="index" class="flex items-center space-x-2 mt-2">
                                    <span class="font-semibold">{{ index + 1 }}차시:</span>
                                    <input type="text" v-model="session.plan" class="w-full p-2 border rounded-md" placeholder="지도 계획을 입력하세요">
                                    <button @click="removeSupplementarySession(index)" class="px-2 py-1 bg-red-500 text-white rounded-md">&times;</button>
                                </div>
                                <button @click="addSupplementarySession" :disabled="teacherPlan.supplementarySessions.length >= teacherPlan.maxSupplementaryHours" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:bg-gray-400">+ 차시 추가</button>
                            </div>
                        </div>

                        <div class="text-center">
                            <button @click="generatePlanPreview" class="mt-6 px-8 py-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition text-lg">계획안 미리보기</button>
                        </div>
                    </div>

                    <!-- 지도 출석부 & 수업일지 -->
                    <div v-if="currentGuidanceData" class="space-y-8">
                        <div class="bg-white p-6 rounded-lg shadow-md flex justify-between items-start">
                            <h3 class="text-xl font-semibold">{{ teacherTab === 'preventive' ? '예방지도' : '보충지도(추가학습)' }} 출석부 & 수업일지</h3>
                            <div class="text-right">
                                <p><strong>과목명:</strong> {{ teacherPlan.subjectName || '미입력' }}</p>
                                <p><strong>교과교사:</strong> {{ formattedTeacherNames }}</p>
                                <div class="mt-2 flex space-x-2">
                                    <button @click="generateCompletionStatusPdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">이수현황표 PDF</button>
                                    <button @click="generateAttendancePdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">출석부 PDF</button>
                                    <button @click="generateLessonLogPdf(teacherTab)" class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-xs">수업일지 PDF</button>
                                </div>
                            </div>
                        </div>

                        <!-- 이수현황표 -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-lg font-semibold mb-4">{{ teacherTab === 'preventive' ? '예방지도' : '보충지도(추가학습)' }} 이수현황표</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm text-center">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-2 border">학생</th>
                                            <th v-if="teacherTab === 'supplementary'" class="p-2 border">특기사항</th>
                                            <th v-if="teacherTab === 'supplementary'" class="p-2 border">미도달 항목</th>
                                            <th v-if="teacherTab === 'supplementary'" class="p-2 border">예방지도</th>
                                            <th v-if="teacherTab === 'supplementary'" class="p-2 border">정서지원프로그램</th>
                                            <th v-for="rh in moduleConfig.recognizedHours" :key="rh.name" class="p-2 border">{{ rh.name }}</th>
                                            <th class="p-2 border bg-gray-100">총계</th>
                                            <th v-if="teacherTab === 'supplementary'" class="p-2 border bg-gray-100">이수여부</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="student in currentGuidanceData.students" :key="student.id">
                                            <td class="p-2 border font-semibold whitespace-nowrap">{{ student.name }} ({{ student.id }})</td>
                                            <td v-if="teacherTab === 'supplementary'" class="p-2 border">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].specialNotes : '일반학생' }}
                                            </td>
                                            <td v-if="teacherTab === 'supplementary'" class="p-2 border">{{ student.reason }}</td>
                                            <td v-if="teacherTab === 'supplementary'" class="p-2 border">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].preventiveHours : 0 }}
                                            </td>
                                            <td v-if="teacherTab === 'supplementary'" class="p-2 border">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].emotionalSupportHours : 0 }}
                                            </td>
                                            <td v-for="rh in moduleConfig.recognizedHours" :key="rh.name" class="p-2 border">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id][rh.name] : 0 }}
                                            </td>
                                            <td class="p-2 border bg-gray-100 font-bold">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].total : 0 }}
                                            </td>
                                            <td v-if="teacherTab === 'supplementary'"
                                                class="p-2 border font-bold"
                                                :class="{
                                                    'text-green-600': guidanceCompletionStatus[student.id] && guidanceCompletionStatus[student.id].completionStatus === '이수',
                                                    'text-red-600': guidanceCompletionStatus[student.id] && guidanceCompletionStatus[student.id].completionStatus === '미이수'
                                                }">
                                                {{ guidanceCompletionStatus[student.id] ? guidanceCompletionStatus[student.id].completionStatus : '' }}
                                            </td>
                                        </tr>
                                         <tr v-if="currentGuidanceData.students.length === 0">
                                            <td :colspan="moduleConfig.recognizedHours.length + (teacherTab === 'supplementary' ? 7 : 2)" class="text-center p-4 text-gray-500">학생이 없습니다.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 출석부 -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-lg font-semibold mb-4">출석부</h4>
                            <div v-if="teacherTab === 'preventive'">
                                <div class="flex space-x-2 mb-4">
                                    <input type="text" v-model="newGuidanceStudentId" @keyup.enter="addGuidanceStudent(teacherTab)" placeholder="학번 입력 후 Enter" class="p-2 border rounded-md w-48">
                                    <button @click="addGuidanceStudent(teacherTab)" class="px-4 py-2 bg-blue-500 text-white rounded-md">학생 추가</button>
                                </div>
                                <p v-if="currentGuidanceData.error" class="text-red-500 text-sm mb-4 -mt-2">{{ currentGuidanceData.error }}</p>
                            </div>
                            <div v-else class="mb-4">
                                <!-- Removed Firestore-dependent import button -->
                                 <p class="text-sm text-gray-600">참고: 보충지도 대상자는 예방지도 출석부에서 추가한 학생 중, 관리자가 생성한 대상자 명단에 포함된 학생만 이수 시수 계산에 반영됩니다.</p>
                                 <p class="text-sm text-gray-600 mt-2">수동으로 학생을 추가해야 하는 경우, '예방지도 출석부' 탭에서 추가하세요.</p>
                                <button @click="resetSupplementaryStudents" class="mt-2 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">대상자 초기화 (보충지도)</button>

                            </div>

                            <div class="relative">
                                <button @click="scrollAttendance('left', $event)" class="scroll-arrow left">‹</button>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm border-collapse">
                                        <thead>
                                            <tr class="text-center">
                                                <th class="sticky left-0 bg-gray-100 z-20 p-2 border-y border-l border-r border-gray-300 w-[80px]">학번</th>
                                                <th class="sticky left-[50px] bg-gray-100 z-20 p-2 border-y border-r border-gray-300 w-[96px] whitespace-nowrap">이름</th>
                                                <th v-for="(session, index) in currentGuidanceData.sessions" :key="index" class="p-2 border border-gray-300 min-w-[150px]">
                                                    <div class="flex items-center justify-center space-x-2 mb-2">
                                                        <p class="font-bold">{{ index + 1 }}차시</p>
                                                        <button v-if="session.isSaved" @click="toggleSaveSession(session)" title="수정" class="p-1 hover:bg-gray-200 rounded">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                                        </button>
                                                    </div>
                                                    <input type="text" class="flatpickr-single w-full p-1 border rounded text-center text-xs mb-1" placeholder="날짜 선택" :value="session.date" @change="session.date = $event.target.value" :disabled="session.isSaved">
                                                    <input type="text" class="w-full p-1 border rounded text-center text-xs" placeholder="예: 16:00~17:00" v-model="session.time" :disabled="session.isSaved">
                                                    <button v-if="!session.isSaved" @click="toggleSaveSession(session)" :disabled="!isSessionReadyToSave(session)" class="w-full mt-1 px-2 py-1 text-xs rounded text-white bg-green-500 hover:bg-green-600 disabled:bg-gray-400">저장</button>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="student in currentGuidanceData.students" :key="student.id" class="text-center">
                                                <td class="sticky left-0 bg-white z-20 p-2 border-l border-r border-b border-gray-300">{{ student.id }}</td>
                                                <td class="sticky left-[50px] bg-white z-20 p-2 border-r border-b border-gray-300 font-semibold whitespace-nowrap">{{ student.name }}</td>
                                                <td v-for="(session, index) in currentGuidanceData.sessions" :key="index" class="p-2 border border-gray-300">
                                                    <select class="w-full p-1 border rounded text-xs" v-model="session.attendance[student.id]" :disabled="session.isSaved">
                                                        <option value="">선택</option> <!-- Allow unselecting -->
                                                        <option v-for="rh in moduleConfig.recognizedHours" :key="rh.name" :value="rh.name">{{ rh.name }}</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr v-if="currentGuidanceData.students.length === 0">
                                                <td :colspan="currentGuidanceData.sessions.length + 2" class="text-center p-4 border border-gray-300 text-gray-500">학생을 추가해주세요.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <button @click="scrollAttendance('right', $event)" class="scroll-arrow right">›</button>
                            </div>
                            <button @click="addGuidanceSession(teacherTab)" class="mt-4 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm">+ 차시 추가</button>
                        </div>

                        <!-- 수업일지 -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-lg font-semibold mb-4">수업일지</h4>
                            <div class="mb-6 p-4 border rounded-md bg-gray-50 grid grid-cols-2 gap-4 text-sm">
                                <div><strong>과목명:</strong> {{ teacherPlan.subjectName || '미입력' }}</div>
                                <div><strong>운영차시:</strong> {{ savedGuidanceSessions.length }} 차시</div>
                                <div><strong>지도교사:</strong> {{ formattedTeacherNames }}</div>
                                <div><strong>운영기간:</strong> {{ guidanceOperationPeriod }}</div>
                            </div>
                            <div class="space-y-4">
                                <div v-for="(session, index) in savedGuidanceSessions" :key="session.date + index" class="p-4 border rounded-md">
                                    <p class="font-bold mb-2">{{ index + 1 }}차시 수업일지 ({{ session.date }} / {{ session.time }})</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <p><strong>수업방법:</strong> {{ [...new Set(Object.values(session.attendance))].filter(Boolean).join(', ') }}</p>
                                        <div class="flex items-center">
                                            <label class="font-semibold mr-2 shrink-0">장소:</label>
                                            <input type="text" class="w-full p-1 border rounded" v-model="session.place">
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label class="font-semibold text-sm">지도내용:</label>
                                        <textarea rows="3" class="w-full p-1 border rounded mt-1 text-sm" v-model="session.content"></textarea>
                                    </div>
                                </div>
                                <p v-if="savedGuidanceSessions.length === 0" class="text-center text-gray-500">저장된 수업일지가 없습니다.</p>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Homeroom Teacher View -->
                 <div v-if="role === '담임교사'" class="space-y-6">
                    <h2 class="text-3xl font-bold text-gray-800">담임교사 대시보드 (임시)</h2>
                     <p class="mb-4 text-gray-700">참고: 현재 버전에서는 담임교사가 학생 상태를 조회할 수 없습니다. 필요한 서류는 교과교사에게 요청하여 미리보기/출력하세요.</p>
                     <!-- Simplified Homeroom View -->
                     <div class="bg-white p-6 rounded-lg shadow-md">
                         <h3 class="text-xl font-semibold mb-4">학급 학생 현황 (기능 비활성화)</h3>
                         <p class="text-sm text-gray-500">학생 정보 조회 기능은 현재 제공되지 않습니다.</p>
                     </div>
                      <div class="bg-white p-6 rounded-lg shadow-md">
                         <h3 class="text-xl font-semibold mb-4">서류 출력 요청</h3>
                         <p class="text-sm text-gray-500">가정통신문 및 서약서 출력은 해당 과목의 교과교사에게 요청해주세요.</p>
                      </div>
                 </div>
             </div>
        </main>

        <!-- Modals -->
        <!-- Removed Attendance Modal (Functionality merged or removed) -->

        <!-- Preview Modal -->
        <div v-if="showPreviewModal" class="modal-overlay" @click.self="closePreviewModal">
            <div class="modal-content modal-preview"> <!-- Apply A4-like width -->
                 <!-- Container for printable content -->
                 <div id="print-area-container-in-modal">
                    <div v-html="previewHtml"></div>
                 </div>
                <p v-if="teacherPlanError" class="text-sm mt-4 text-center font-semibold" :class="teacherPlanError.includes('오류') ? 'text-red-500' : 'text-blue-600'">{{ teacherPlanError }}</p>
                <div class="mt-6 flex justify-end space-x-2">
                    <button @click="closePreviewModal" class="px-4 py-2 bg-gray-300 rounded-md">닫기</button>
                     <!-- Changed to use window.print() for simplicity -->
                     <button @click="printPreviewModalContent" class="px-4 py-2 bg-indigo-600 text-white rounded-md">인쇄 / PDF 저장</button>
                    <!-- <button @click="printPreview" class="px-4 py-2 bg-indigo-600 text-white rounded-md">pdf로 저장</button> -->
                </div>
            </div>
        </div>

         <!-- Removed Import Modal -->

        <!-- 인쇄용 컨테이너 (숨김, html2canvas용) -->
        <div id="print-area-container" class="hidden"></div>

    </div>

    <script type="module">
        // Vue 3 CDN
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

        // Firebase related imports and initialization are removed

        createApp({ // Create the app instance
            // State
            role: null, // User's selected role, initially null
            showAdminCodeInput: false,
            adminCode: '',
            adminCodeError: '',
            teacherTab: 'plan', // Default tab for teacher
            // adminFormTab: 'newsletter', // Kept for potential future use if admin view is restored
            uploadStatus: { curriculum: '', student: '', emotionalSupport: '' },
            statusMessage: '', // General status messages

            // Admin Data (Local Defaults - Reset on refresh)
            moduleConfig: {
                hoursPerCredit: 1,
                preventiveRatio: 50,
                emotionalSupportRatio: 20,
                specialPreventiveRatio: 30,
                recognizedHours: [
                    { name: '수업시간별도지도', hours: 1 },
                    { name: '온라인콘텐츠수강', hours: 1 },
                    { name: 'RunUP과정수강', hours: 1 },
                    { name: '학습멘토링', hours: 1 },
                    { name: '대면지도', hours: 1 },
                    { name: '보충과제부여', hours: 1 }
                ]
            },
            moduleConfigStatus: '',
            newsletterForm: { // Kept for potential future use
                title: '최소 성취수준 보장지도 참여 안내',
                docNumber: '교무기획부-123',
                department: '교무기획부 (02-123-4567)',
                logoUrl: null,
                body: '학부모님, 안녕하십니까?\n\n귀 자녀는 다음과 같은 사유로 최소 성취수준 보장지도 대상자로 선정되었음을 알려드립니다. 본교에서는 학생의 학업 능력 향상을 위해 보충 학습 프로그램을 운영하고 있으니, 학생이 프로그램에 성실히 참여할 수 있도록 가정에서도 많은 격려와 지도 부탁드립니다.',
                dispatchDate: '2025.07.14.',
                includeSeal: false,
                sealUrl: null
            },
            pledgeForm: { // Kept for potential future use
                content: '본인은 최소 성취수준 보장지도 프로그램의 모든 활동에 성실하게 참여할 것을 서약합니다.',
                dispatchDate: '2025.07.14.',
                includeSeal: false,
                sealUrl: null
            },
            showPreviewModal: false,
            previewHtml: '',

            // Data loaded from local files
            curriculumData: [],
            studentData: [],
            emotionalSupportData: [],
            underachievers: [], // Locally managed list of underachievers
            underachieversStatus: '',
            fileProcessingError: '',
            // Removed attendance modal related state
            showExportOptions: false, // Keep for export functionality
            // Removed import modal related state

            // Homeroom Teacher Data (Kept for potential future use)
            // homeroomClassInput: '',
            // searchedStudents: [],
            // homeroomMessage: '',

            // Teacher Data (Specific to the current session)
            teacherPlan: {
                aiProvider: 'gemini',
                apiKey: '',
                subjectName: '',
                teacherNames: [''],
                achievements: [{ text: '', statement: '', loading: false }],
                gradeCalculation: '추정분할점수',
                conductPrevention: 'X',
                preventionTarget: '',
                preventionMethods: [],
                preventionPeriod: [], // Will store Date objects from flatpickr
                preventionSessions: [{ plan: '' }, { plan: '' }, { plan: '' }],
                supplementaryMethods: [],
                supplementaryPeriod: [], // Will store Date objects from flatpickr
                supplementarySessions: [{ plan: '' }, { plan: '' }, { plan: '' }],
                maxSupplementaryHours: 0,
            },
            teacherPlanError: '',

            // Logbook Data (Specific to teacher and subject, local session)
            teacherGuidanceData: {
                preventive: {
                    students: [],
                    sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })),
                    error: ''
                },
                supplementary: {
                    students: [], // Supplementary students now need to be derived or manually added
                    sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })),
                    error: ''
                }
            },
             newGuidanceStudentId: '', // Added for adding students in preventive tab


            // Computed Properties
            get formattedTeacherNames() {
                return this.teacherPlan.teacherNames
                    .map(name => name.trim())
                    .filter(name => name)
                    .map(name => `${name} (인)`)
                    .join(', ');
            },
            // Removed groupedUnderachievers as it's not used without Admin view
            get currentGuidanceData() {
                // Ensure role is selected before accessing guidance data
                 if (!this.role) return null;
                 // Ensure teacherTab is valid before accessing
                 if (this.teacherTab === 'preventive' || this.teacherTab === 'supplementary') {
                    // Make sure the structure exists
                    if (!this.teacherGuidanceData[this.teacherTab]) {
                        this.teacherGuidanceData[this.teacherTab] = {
                            students: [],
                            sessions: Array.from({ length: 10 }, () => ({ date: '', time: '', isSaved: false, place: '', content: '', attendance: {} })),
                            error: ''
                        };
                    }
                    return this.teacherGuidanceData[this.teacherTab];
                }
                return null;
            },

            get guidanceCompletionStatus() {
                // This computed property calculates completion status based on locally stored guidance data
                const data = this.currentGuidanceData;
                 // Add check for role, return empty if no role or no data
                 if (!this.role || !data) return {};


                 const preventiveTotals = {};
                const preventiveData = this.teacherGuidanceData.preventive;
                // Calculate total preventive hours first, regardless of the current tab
                preventiveData.sessions.forEach(session => {
                    if (session.isSaved) {
                        for (const studentId in session.attendance) {
                            const methodName = session.attendance[studentId];
                            if (methodName) {
                                const methodConfig = this.moduleConfig.recognizedHours.find(m => m.name === methodName);
                                if (methodConfig) {
                                    if (!preventiveTotals[studentId]) preventiveTotals[studentId] = 0;
                                    preventiveTotals[studentId] += methodConfig.hours;
                                }
                            }
                        }
                    }
                });


                const status = {};
                let requiredHoursForCompletion = 0;
                let maxEmotionalSupportHours = 0;
                let supplementaryHours = 0;
                let requiredSubjectCredits = 0; // Added to store subject credits

                if (this.teacherPlan.subjectName) {
                    const subjectInfo = this.curriculumData.find(s => s.과목명 === this.teacherPlan.subjectName);
                    if (subjectInfo) {
                        requiredSubjectCredits = Number(subjectInfo.학점) || 0;
                        supplementaryHours = requiredSubjectCredits * this.moduleConfig.hoursPerCredit;
                        requiredHoursForCompletion = (supplementaryHours * 2) / 3;
                        maxEmotionalSupportHours = supplementaryHours * (this.moduleConfig.emotionalSupportRatio / 100);
                    }
                }


                // Initialize status for all students in the CURRENT tab's list
                 data.students.forEach(student => {
                    status[student.id] = { name: student.name };
                     const studentInfo = this.studentData.find(s => String(s['학번']) === student.id);
                    status[student.id].specialNotes = (studentInfo && studentInfo['특기사항']) ? studentInfo['특기사항'] : '일반학생';
                    this.moduleConfig.recognizedHours.forEach(rh => {
                        status[student.id][rh.name] = 0;
                    });
                    status[student.id].total = 0;
                    // Initialize supplementary-specific fields only if in that tab
                    if (this.teacherTab === 'supplementary') {
                         status[student.id].preventiveHours = 0; // Will be calculated later
                         status[student.id].emotionalSupportHours = 0; // Will be calculated later
                         status[student.id].completionStatus = '미이수'; // Default
                    }
                });

                // Calculate hours from the CURRENT tab's saved sessions
                data.sessions.forEach(session => {
                    if (session.isSaved) {
                        for (const studentId in session.attendance) {
                            if (!status[studentId]) continue; // Only process students in the current tab's list
                            const methodName = session.attendance[studentId];
                            if (methodName) {
                                const methodConfig = this.moduleConfig.recognizedHours.find(m => m.name === methodName);
                                if (methodConfig) {
                                    status[studentId][methodName] = parseFloat((status[studentId][methodName] + methodConfig.hours).toFixed(2));
                                    // Don't add to total yet if supplementary, handle combined total later
                                    if (this.teacherTab === 'preventive') {
                                       status[studentId].total = parseFloat((status[studentId].total + methodConfig.hours).toFixed(2));
                                    }
                                }
                            }
                        }
                    }
                });

                // --- Calculations specific to supplementary tab ---
                 if (this.teacherTab === 'supplementary' && requiredSubjectCredits > 0) {
                     data.students.forEach(student => {
                         if (!status[student.id]) return; // Should exist, but safety check

                         let currentStudentTotal = 0;
                         // Add supplementary hours already calculated above for this tab
                         this.moduleConfig.recognizedHours.forEach(rh => {
                            currentStudentTotal += (status[student.id][rh.name] || 0);
                         });


                        // Add credited preventive hours (calculated earlier from preventive tab data)
                        const totalPreventiveHoursForStudent = preventiveTotals[student.id] || 0;
                         if (totalPreventiveHoursForStudent > 0) {
                             const studentInfo = this.studentData.find(s => String(s['학번']) === student.id);
                             const isSpecialSupport = studentInfo && studentInfo['특기사항'] === '학습지원대상';

                            let maxAllowedHours = 0;
                            let creditedPreventiveHours = 0;

                             if (isSpecialSupport) {
                                 maxAllowedHours = supplementaryHours * (this.moduleConfig.specialPreventiveRatio / 100);
                                 // Allow decimals for special support
                                 creditedPreventiveHours = Math.min(totalPreventiveHoursForStudent, maxAllowedHours);
                             } else {
                                maxAllowedHours = supplementaryHours * (this.moduleConfig.preventiveRatio / 100);
                                // Floor for general students
                                creditedPreventiveHours = Math.floor(Math.min(totalPreventiveHoursForStudent, maxAllowedHours));
                            }

                             status[student.id].preventiveHours = parseFloat(creditedPreventiveHours.toFixed(2)); // Store credited amount
                             currentStudentTotal += creditedPreventiveHours; // Add to total
                         }


                        // Add credited emotional support hours
                        const emotionalData = this.emotionalSupportData.find(e => String(e['학번']) === student.id);
                        const uploadedHours = emotionalData ? Number(emotionalData['정서지원프로그램 참여시간']) : 0;
                        const creditedEmotionalHours = Math.min(uploadedHours, maxEmotionalSupportHours);

                         status[student.id].emotionalSupportHours = parseFloat(creditedEmotionalHours.toFixed(2));
                         currentStudentTotal += creditedEmotionalHours;

                        // Final total and completion status for supplementary
                        status[student.id].total = parseFloat(currentStudentTotal.toFixed(2));
                         // Check completion status only if requiredHoursForCompletion is positive
                         if (requiredHoursForCompletion > 0 && status[student.id].total >= requiredHoursForCompletion) {
                             status[student.id].completionStatus = '이수';
                         } else {
                             status[student.id].completionStatus = '미이수';
                         }
                    });
                }


                return status;
            },


            get savedGuidanceSessions() {
                const data = this.currentGuidanceData;
                if (!data) return [];
                return data.sessions.filter(s => s.isSaved && s.date);
            },

            get guidanceOperationPeriod() {
                const savedSessions = this.savedGuidanceSessions;
                if (savedSessions.length === 0) return '미정';

                // Filter out sessions without a valid date before mapping
                const validDates = savedSessions
                    .map(s => s.date ? new Date(s.date) : null)
                    .filter(d => d instanceof Date && !isNaN(d));

                if (validDates.length === 0) return '유효한 날짜 없음';

                validDates.sort((a, b) => a - b); // Sort valid dates

                try {
                    const startDate = validDates[0].toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                    const endDate = validDates[validDates.length - 1].toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                    return `${startDate} ~ ${endDate}`;
                } catch (e) {
                     console.error("Error formatting date:", e);
                     return '날짜 형식 오류';
                }
            },
            // Removed processedHomeroomStudents


            // --- Methods ---
             selectRole(selectedRole) {
                 if (selectedRole === '관리자') {
                     this.showAdminCodeInput = true;
                     // Don't set the role yet, wait for code input
                 } else {
                     this.role = selectedRole;
                     this.showAdminCodeInput = false; // Hide admin input if other role selected
                     this.adminCodeError = ''; // Clear admin error
                     this.statusMessage = ''; // Clear status
                     // Initialize Flatpickr when a role is chosen and the main view renders
                     this.initFlatpickr();
                 }
            },
             submitAdminCode() {
                 if (this.adminCode === '0822') { // Simple local check
                     this.role = '관리자';
                     this.adminCodeError = '';
                     this.showAdminCodeInput = false;
                     this.statusMessage = '';
                     this.initFlatpickr(); // Initialize Flatpickr for Admin view if needed
                 } else {
                     this.adminCodeError = '코드가 올바르지 않습니다.';
                 }
                 this.adminCode = ''; // Clear input after attempt
             },
             resetRole() {
                 this.role = null; // Go back to role selection
                 this.showAdminCodeInput = false; // Hide admin input
                 this.adminCode = '';
                 this.adminCodeError = '';
                 this.statusMessage = '';
                 // Reset data if needed, or keep it for potential re-selection
                 // this.resetData(); // Uncomment to clear all data on role reset
             },

            initFlatpickr() {
                 this.$nextTick(() => {
                    // Destroy existing instances first to avoid duplicates
                     document.querySelectorAll('.flatpickr-input').forEach(el => {
                         if (el?._flatpickr) { // Safe navigation
                             el._flatpickr.destroy();
                         }
                     });
                     // Re-initialize range pickers
                    flatpickr(".flatpickr-range", {
                         mode: "range",
                         dateFormat: "Y-m-d",
                         locale: "ko",
                         onChange: (selectedDates, dateStr, instance) => {
                             // Determine if it's prevention or supplementary based on context
                             const planSection = instance.element.closest('.space-y-4');
                             let targetPeriod = null;
                             if (planSection) {
                                 const preventionHeader = planSection.querySelector('h3[textContent*="예방"]');
                                 const supplementaryHeader = planSection.querySelector('h3[textContent*="보충"]');
                                 if (preventionHeader) targetPeriod = 'preventionPeriod';
                                 else if (supplementaryHeader) targetPeriod = 'supplementaryPeriod';
                             }

                             if (targetPeriod) {
                                this.teacherPlan[targetPeriod] = selectedDates; // Store Date objects
                             } else {
                                console.warn("Could not determine target period for Flatpickr range instance.");
                             }
                         }
                     });
                     // Re-initialize single date pickers
                    flatpickr(".flatpickr-single", {
                         dateFormat: "Y-m-d",
                         locale: "ko"
                         // onChange handled directly via @change on input
                     });
                });
            },

            toggleExportOptions() {
                this.showExportOptions = !this.showExportOptions;
            },
            downloadTemplate(type) {
                let data, filename;
                if (type === 'curriculum') {
                    data = [["분류", "과목명", "학년", "학기", "학점", "교과군"]];
                    filename = "교육과정_편제표_양식.xlsx";
                } else if (type === 'student') {
                    data = [["학번", "이름", "특기사항"]];
                    filename = "학적정보_양식.xlsx";
                } else if (type === 'emotionalSupport') {
                    data = [["학번", "이름", "정서지원프로그램 참여시간"]];
                    filename = "정서지원프로그램_이수시간_양식.xlsx";
                }
                 if (!data) return; // Added check
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, filename);
            },
             uploadFile(event, type) {
                const file = event.target.files[0];
                if (!file) return;
                this.uploadStatus[type] = `${file.name} 처리 중...`;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        if (type === 'curriculum') this.curriculumData = jsonData;
                        if (type === 'student') this.studentData = jsonData;
                        if (type === 'emotionalSupport') this.emotionalSupportData = jsonData;

                        this.uploadStatus[type] = `${file.name} 로드 완료. (새로고침 시 사라짐)`;

                        // Trigger updates if necessary
                        if (type === 'curriculum' || type === 'student') {
                            this.updateMaxHours();
                        }
                    } catch (error) {
                        console.error(`Error processing ${type} file:`, error);
                        this.uploadStatus[type] = `${file.name} 처리 중 오류 발생: ${error.message}`;
                    } finally {
                        event.target.value = null; // Clear input
                        setTimeout(() => this.uploadStatus[type] = '', 5000);
                    }
                };
                reader.readAsArrayBuffer(file);
            },
            // --- 성적 파일 처리 로직 (processGradeFiles) 수정 ---
             processGradeFiles(event) {
                this.fileProcessingError = '';
                const files = event.target.files;
                if (!files || files.length === 0) return;

                // Use a temporary map to aggregate results from multiple files
                const gradeResults = new Map();
                let filesProcessed = 0;
                 const totalFiles = files.length;

                 // Ensure studentData is loaded
                 if (!this.studentData || this.studentData.length === 0) {
                     this.fileProcessingError = '학적 정보가 먼저 업로드되어야 합니다.';
                     event.target.value = null; // Clear input
                     return;
                 }
                  // Ensure curriculumData is loaded
                 if (!this.curriculumData || this.curriculumData.length === 0) {
                     this.fileProcessingError = '교육과정 편제표가 먼저 업로드되어야 합니다.';
                     event.target.value = null; // Clear input
                     return;
                 }


                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                            // --- 학년 및 반 정보 추출 로직 개선 ---
                            const titleRowIndex = 2; // Assuming title is reliably on the 3rd row (index 2)
                            const classInfo = sheetData[titleRowIndex] ? String(sheetData[titleRowIndex][0]).trim() : '';
                            if (!classInfo) {
                                console.warn(`Skipping file ${file.name}: Could not find class info in row ${titleRowIndex + 1}.`);
                                filesProcessed++;
                                if (filesProcessed === totalFiles) this.updateUnderachieversList(gradeResults);
                                return;
                            }

                            // 정규식을 사용하여 '숫자학년' 및 '숫자반' 추출
                            const gradeMatch = classInfo.match(/(\d+)\s*학년/);
                            const classNumMatch = classInfo.match(/(\d+)\s*반/);

                            if (!gradeMatch || !classNumMatch) {
                                console.warn(`Skipping file ${file.name}: Could not parse grade or class number from title: "${classInfo}"`);
                                this.fileProcessingError = `${file.name} 파일에서 학년 또는 반 정보를 추출할 수 없습니다. 제목 형식을 확인하세요. (예: ... 1학년 1반 ...)`;
                                filesProcessed++;
                                if (filesProcessed === totalFiles) this.updateUnderachieversList(gradeResults);
                                return;
                            }
                            const classGrade = gradeMatch[1]; // 학년 숫자 (e.g., '1')
                            const classNum = classNumMatch[1]; // 반 숫자 (e.g., '1')
                            // --- 추출 로직 개선 끝 ---


                            const headerRowIndex = 3; // 과목명 행
                            const startRowIndex = 5; // 학생 데이터 시작 행 (짝수 행이 '미도달' 정보)

                            for (let r = startRowIndex; r < sheetData.length; r += 2) {
                                if (!sheetData[r - 1] || !sheetData[r]) continue; // 학생 정보 행과 미도달 정보 행 확인

                                const studentNum = sheetData[r - 1][0]; // 번호
                                const studentName = sheetData[r - 1][1]; // 이름
                                if (!studentNum || !studentName) continue; // 번호나 이름 없으면 스킵

                                const fullId = `${classGrade}${String(classNum).padStart(2, "0")}${String(studentNum).padStart(2, "0")}`;

                                for (let c = 3; c < sheetData[r].length; c++) { // 과목 열 순회
                                    const achievementStatus = sheetData[r][c];
                                    if (achievementStatus === "미도달") {
                                        const subjectWithCredits = sheetData[headerRowIndex][c];
                                        if (!subjectWithCredits) continue; // 과목명 없으면 스킵

                                        // 과목명에서 학점 정보 (괄호) 제거
                                        const subject = String(subjectWithCredits).split('(')[0].trim();
                                        if (!subject) continue; // 빈 과목명 스킵

                                        // 결과 맵에 추가 또는 업데이트
                                        if (!gradeResults.has(fullId)) {
                                            gradeResults.set(fullId, { name: studentName, subjects: new Set() });
                                        }
                                        gradeResults.get(fullId).subjects.add(subject);
                                    }
                                }
                            }
                        } catch (err) {
                            console.error(`Error processing file ${file.name}:`, err);
                            this.fileProcessingError = `${file.name} 파일 처리 중 오류: ${err.message}. 형식을 확인하세요.`;
                        } finally {
                            filesProcessed++;
                            if (filesProcessed === totalFiles) {
                                this.updateUnderachieversList(gradeResults); // 모든 파일 처리 후 목록 업데이트
                                event.target.value = null; // 모든 파일 처리 후 입력 필드 초기화
                            }
                        }
                    };
                    reader.onerror = (err) => {
                         console.error(`Error reading file ${file.name}:`, err);
                         this.fileProcessingError = `${file.name} 파일 읽기 오류.`;
                         filesProcessed++;
                         if (filesProcessed === totalFiles) {
                             this.updateUnderachieversList(gradeResults); // 오류 발생해도 일단 처리된 결과로 업데이트
                             event.target.value = null; // 입력 필드 초기화
                         }
                    };
                    reader.readAsArrayBuffer(file);
                });
            },
             updateUnderachieversList(gradeResults) {
                // Merges gradeResults into this.underachievers
                gradeResults.forEach((data, id) => {
                    const studentIndex = this.underachievers.findIndex(s => s.id === id);
                    const gradeSubjectsToAdd = Array.from(data.subjects).map(subjectName => {
                            const curriculumInfo = this.curriculumData.find(c => c.과목명 === subjectName);
                            return { name: subjectName, credits: curriculumInfo ? curriculumInfo.학점 : 'N/A' };
                        }).filter(s => s.credits !== 'N/A'); // 학점을 찾을 수 없는 과목은 제외할 수 있음

                     if (studentIndex > -1) {
                         // 기존 학생: 성적 미도달 과목 추가 (중복 제거)
                         const existingGradeSubjects = new Set(this.underachievers[studentIndex].gradeSubjects.map(s => s.name));
                         gradeSubjectsToAdd.forEach(newSubject => {
                             if (!existingGradeSubjects.has(newSubject.name)) {
                                 this.underachievers[studentIndex].gradeSubjects.push(newSubject);
                             }
                         });
                         // 이름 업데이트 (혹시 다를 경우 최신 파일 정보로)
                         this.underachievers[studentIndex].name = data.name;
                    } else {
                         // 새 학생 추가
                         this.underachievers.push({
                             id: id,
                             name: data.name,
                             gradeSubjects: gradeSubjectsToAdd,
                             attendanceSubjects: [] // 출석 미도달은 별도 로직 또는 수동 추가 필요
                         });
                    }
                });
                 // Sort the final list
                 this.underachievers.sort((a, b) => a.id.localeCompare(b.id));
                 this.fileProcessingError = gradeResults.size > 0 ? `${gradeResults.size}명의 학생 정보가 처리/업데이트되었습니다.` : '처리된 미도달 학생 정보가 없습니다.';
                 setTimeout(() => this.fileProcessingError = '', 5000);
            },
            // Removed attendance modal functions
            // Removed deleteDetailGroup
            exportTable(format) {
                 // This was tied to the Admin view's underachievers table.
                 // Keep the logic but note it won't work without that table/data.
                 alert("내보내기 기능은 관리자 화면에서만 사용할 수 있습니다 (현재 비활성화됨).");
                 this.showExportOptions = false;
            },
            // Removed deployUnderachievers

            // Teacher methods
            switchTeacherTab(tab) {
                this.teacherTab = tab;
                 // No need to load data from Firestore, just switch view
                 this.initFlatpickr(); // Re-initialize date pickers for the new tab
            },
             updateMaxHours() {
                // Calculation based on local curriculumData
                 const subject = this.curriculumData.find(s => s.과목명 === this.teacherPlan.subjectName);
                if (subject) {
                    const credits = Number(subject.학점);
                    // Ensure calculation results in a non-negative number
                    this.teacherPlan.maxSupplementaryHours = Math.max(0, credits * this.moduleConfig.hoursPerCredit);
                     // Adjust supplementary sessions if max hours decreased
                     if(this.teacherPlan.supplementarySessions.length > this.teacherPlan.maxSupplementaryHours && this.teacherPlan.maxSupplementaryHours >= 0){ // Check >= 0
                         this.teacherPlan.supplementarySessions = this.teacherPlan.supplementarySessions.slice(0, this.teacherPlan.maxSupplementaryHours);
                     }
                } else {
                    this.teacherPlan.maxSupplementaryHours = 0;
                     this.teacherPlan.supplementarySessions = []; // Clear if subject not found
                }
            },
            // Removed saveGuidanceData - handled locally
            // Removed loadGuidanceData - handled locally
            addAchievement() {
                this.teacherPlan.achievements.push({ text: '', statement: '', loading: false });
            },
            removeAchievement(index) {
                this.teacherPlan.achievements.splice(index, 1);
            },
            addPreventionSession() {
                this.teacherPlan.preventionSessions.push({ plan: '' });
            },
            removePreventionSession(index) {
                this.teacherPlan.preventionSessions.splice(index, 1);
            },
            addSupplementarySession() {
                if (this.teacherPlan.supplementarySessions.length < this.teacherPlan.maxSupplementaryHours) {
                    this.teacherPlan.supplementarySessions.push({ plan: '' });
                }
            },
            removeSupplementarySession(index) {
                this.teacherPlan.supplementarySessions.splice(index, 1);
            },
            addTeacher() {
                this.teacherPlan.teacherNames.push('');
            },
            removeTeacher(index) {
                this.teacherPlan.teacherNames.splice(index, 1);
            },
            async generateStatement(index) {
                // This function remains largely the same, using fetch for AI APIs
                 this.teacherPlanError = '';
                const achievement = this.teacherPlan.achievements[index];
                if (!achievement.text) {
                    this.teacherPlanError = 'AI 진술문을 생성하려면 성취기준을 먼저 입력해주세요.';
                    return;
                }

                 if (this.teacherPlan.aiProvider !== 'openai' && !this.teacherPlan.apiKey) {
                    this.teacherPlanError = 'AI API 키를 먼저 입력해주세요.';
                    return;
                }

                achievement.loading = true;
                achievement.statement = '';

                const systemPrompt = "당신은 교육 전문가로서 성취기준을 바탕으로 최소 성취수준과 최소 성취수준 학생들의 행동 특성을 설명하는 역할입니다. 입력한 성취기준에 대한 학습자들의 성취수준을 A~E 5단계로 나누었을 때 최하 수준인 E수준을 한 문장으로 진술하세요. 성취수준이란 입력한 성취기준을 학습한 결과로 나타나는 학습자들의 학습 수준을 의미해. 최소 성취수준이므로 간단하고 기초적인 수준으로 입력하되, 부정적인 진술은 하지 말고, 최소한의 노력을 하고 성취기준에 해당하는 내용을 기초적인 수준에서 찾아보았다는 식으로 진술하세요. '학생들은~',  '최소 성취수준:' 또는 'E수준:~' 이라는 별도의 설명 구문 없이 바로 성취수준 진술문만 제시해야 합니다.      예를 들어 성취기준이 '논증 요소에 따른 분석을 바탕으로 효과적으로 내용을 조직하여 논증하는 글을 쓴다.'인 경우 최소 성취수준은 '논증 요소에 대한 제한적인 분석을 바탕으로 논증하는 글을 쓴다.'로 진술할 수 있습니다. 예시로 든 진술문의 형식을 유지하면서 최소 성취수준 진술문을 제시해주세요. ";
                const userQuery = achievement.text;

                let apiUrl, payload, headers = {}, responseParser;
                const provider = this.teacherPlan.aiProvider;
                const apiKey = this.teacherPlan.apiKey;

                if (provider === 'gemini') {
                    // NOTE: User must provide their own Gemini API key in the input field
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`; // Using gemini-pro as flash is deprecated
                    headers['Content-Type'] = 'application/json';
                    payload = {
                         // Gemini Pro structure might differ slightly, adjust if needed based on API docs
                         // Assuming a structure similar to previous Flash call
                        // systemInstruction: { parts: [{ text: systemPrompt }] }, // System instruction might be passed differently
                         contents: [
                             // Include system prompt as part of the content if needed
                             // { role: "system", parts: [{ text: systemPrompt }] }, // Or pass via top-level param
                             { role: "user", parts: [{ text: systemPrompt + "\n\n 성취기준: " + userQuery }] } // Combine prompts
                         ],
                         // Add generationConfig if needed (e.g., safetySettings)
                    };
                     responseParser = (result) => result.candidates?.[0]?.content?.parts?.[0]?.text;
                } else if (provider === 'openai') {
                    // Use the Netlify Function proxy
                    apiUrl = '/.netlify/functions/openai-proxy';
                    headers['Content-Type'] = 'application/json';
                    // Proxy handles Authorization
                    payload = {
                        model: "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userQuery }
                        ]
                    };
                    responseParser = (result) => result.choices?.[0]?.message?.content;
                } else if (provider === 'claude') {
                    // NOTE: User must provide their own Claude API key
                     apiUrl = '/.netlify/functions/claude-proxy'; // Assume proxy exists
                    //apiUrl = 'https://api.anthropic.com/v1/messages';
                    headers = {
                        'Content-Type': 'application/json',
                         // Proxy handles API key
                       // 'x-api-key': apiKey,
                       // 'anthropic-version': '2023-06-01'
                    };
                    payload = {
                        model: "claude-3-sonnet-20240229", // Or another available model
                        max_tokens: 1024,
                        system: systemPrompt,
                        messages: [{ role: "user", content: userQuery }]
                    };
                    responseParser = (result) => result.content?.[0]?.text;
                }


                 try {
                     const response = await fetch(apiUrl, {
                         method: 'POST',
                         headers: headers,
                         body: JSON.stringify(payload)
                     });

                     if (!response.ok) {
                         const errorBody = await response.json().catch(() => ({}));
                         const errorMessage = errorBody.error?.message || errorBody.message || errorBody.error || response.statusText;
                         throw new Error(`API 요청 실패 (${response.status}): ${errorMessage}`);
                     }

                     const result = await response.json();
                     // Handle potential proxy structure
                     const actualResult = result.data || result; // If proxy wraps response in 'data'
                     const generatedText = responseParser(actualResult);


                     if (generatedText) {
                         let cleanedText = generatedText.trim().replace(/^(E수준:|최소 성취수준:)\s*/, '');
                         achievement.statement = cleanedText;
                     } else {
                         console.log('API Raw Response:', result);
                         throw new Error('API 응답에서 진술문을 찾을 수 없습니다.');
                     }
                 } catch (error) {
                     console.error("AI 진술문 생성 오류:", error);
                     this.teacherPlanError = `진술문 생성 중 오류 발생: ${error.message}. API 키와 엔드포인트를 확인하세요.`;
                 } finally {
                     achievement.loading = false;
                 }
            },
             generatePlanPreview() {
                // Generates preview HTML based on local plan data
                const plan = this.teacherPlan;
                const subjectInfo = this.curriculumData.find(s => s.과목명 === plan.subjectName);

                if (!subjectInfo) {
                    this.teacherPlanError = '과목명을 찾을 수 없습니다. 편제표에 등록된 과목명을 정확히 입력해주세요.';
                     // Display error directly in the preview area if modal is shown for error
                     this.previewHtml = `<div id="print-area" style="padding: 20px; color: red;">${this.teacherPlanError}</div>`;
                    this.showPreviewModal = true;
                    return;
                }
                this.teacherPlanError = '';

                const localModuleConfig = this.moduleConfig; // Use local config
                const supplementaryHours = Math.max(0, this.teacherPlan.maxSupplementaryHours); // Ensure non-negative
                const requiredHours = supplementaryHours > 0 ? Math.round((supplementaryHours * 2) / 3) : 0; // Avoid division by zero issue conceptually
                const preventionPossibleHours = Math.floor(supplementaryHours * (localModuleConfig.preventiveRatio / 100));
                const emotionalSupportHours = Math.floor(supplementaryHours * (localModuleConfig.emotionalSupportRatio / 100));

                const createTable = (headers, rows) => {
                    const ths = headers.map(h => `<th>${h}</th>`).join('');
                    const trs = rows.map(row => {
                        const tds = row.map(cell => `<td class="${cell.includes('<div') ? '' : 'text-center'}">${cell}</td>`).join(''); // Center unless it's a div
                        return `<tr>${tds}</tr>`;
                    }).join('');
                    // Added class for styling from #print-area
                    return `<table><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>`;
                };

                // Helper to format date range safely
                const formatDateRange = (periodArray) => {
                    if (!periodArray || periodArray.length === 0) return '미정';
                    try {
                        const start = periodArray[0] instanceof Date ? periodArray[0].toLocaleDateString('ko-KR') : '날짜 오류';
                        const end = periodArray.length > 1 && periodArray[1] instanceof Date ? periodArray[1].toLocaleDateString('ko-KR') : start;
                        return `${start} ~ ${end}`;
                    } catch {
                        return '날짜 형식 오류';
                    }
                };

                let achievementRateHtml = `<p>• 학업 성취율: 학기말 학업 성취율 40% 미만</p>`;
                if (plan.gradeCalculation === '고정분할점수') {
                    achievementRateHtml += createTable(
                        ['성취율', '기준점수'],
                        [['90% 이상', '90'], ['80% 이상 ~ 90% 미만', '80'], ['70% 이상 ~ 80% 미만', '70'],
                         ['60% 이상 ~ 70% 미만', '60'], ['40% 이상 ~ 60% 미만', '40']]
                    );
                } else {
                    achievementRateHtml += `<p>  - 성취수준 기준점수는 학기말 추정분할점수 산출 결과에 따름</p>`;
                }

                const overviewTable = createTable(
                    ['운영 학년', '운영 학기', '보충지도 시수', '이수 인정 기준 시수', '예방지도 인정 가능 시수', '정서 지원 프로그램 인정 가능 시수'],
                    [[subjectInfo.학년, subjectInfo.학기, `${supplementaryHours}시수`, `${requiredHours}시수`, `${preventionPossibleHours}시수`, `${emotionalSupportHours}시수`]]
                );

                const statementsTable = createTable(
                    ['성취기준', '최소 성취수준 진술문'],
                    plan.achievements.map(a => [
                        `<div class="text-left whitespace-pre-wrap">${a.text || ''}</div>`,
                        `<div class="text-left whitespace-pre-wrap">${a.statement || '미생성'}</div>`
                    ])
                );

                let preventionPlanHtml = '';
                if (plan.conductPrevention === 'O') {
                    const preventionPeriodFormatted = formatDateRange(plan.preventionPeriod);
                    const preventionSessions = plan.preventionSessions.map((s, i) => [`${i + 1}차시`, `<div class="text-left whitespace-pre-wrap">${s.plan || ''}</div>`]);
                    preventionPlanHtml = `
                        <h3>4. 최소 성취수준 미도달 예방 지도 계획</h3>
                        ${createTable(
                             ['구분', '내용'],
                             [
                                 ['대상학생 선정 기준', `<div class="text-left whitespace-pre-wrap">${plan.preventionTarget || ''}</div>`],
                                 ['지도 방법', plan.preventionMethods.join(', ')],
                                 ['운영 차시', `${plan.preventionSessions.length}차시`],
                                 ['운영 기간', preventionPeriodFormatted]
                             ]
                         )}
                        <h4>차시별 지도 계획</h4>
                        ${createTable(['차시', '지도 계획'], preventionSessions)}
                    `;
                } else {
                    preventionPlanHtml = `<h3>4. 최소 성취수준 미도달 예방 지도 계획</h3><p>- 해당 없음</p>`;
                }

                const supplementaryPeriodFormatted = formatDateRange(plan.supplementaryPeriod);
                const supplementarySessions = plan.supplementarySessions.map((s, i) => [`${i + 1}차시`, `<div class="text-left whitespace-pre-wrap">${s.plan || ''}</div>`]);

                const supplementaryPlanHtml = `
                    <h3>5. 보충 지도 운영 계획</h3>
                    ${createTable(
                        ['구분', '내용'],
                        [['대상학생 선정 기준', '학업성취율 40% 미만'],
                         ['지도 방법', plan.supplementaryMethods.join(', ')],
                         ['운영 차시', `${plan.supplementarySessions.length}차시`],
                         ['운영 기간', supplementaryPeriodFormatted]]
                    )}
                    <h4>차시별 지도 계획</h4>
                    ${createTable(['차시', '지도 계획'], supplementarySessions)}
                `;

                const additionalLearningPlanHtml = `
                    <h3>6. 추가 학습 운영 계획</h3>
                     ${createTable(
                         ['구분', '내용'],
                         [['대상학생 선정 기준', '과목출석률 2/3 미만'],
                          ['지도 방법', plan.supplementaryMethods.join(', ')],
                          ['운영 차시', `${plan.supplementarySessions.length}차시`],
                          ['운영 기간', supplementaryPeriodFormatted]]
                     )}
                    <h4>차시별 지도 계획</h4>
                    ${createTable(['차시', '지도 계획'], supplementarySessions)}
                 `;

                // Wrap generated content in a div with id="print-area"
                this.previewHtml = `
                    <div id="print-area">
                        <h1 style="font-size: 1.8rem; text-align: center; margin-bottom: 2rem;">최소 성취수준 보장지도 운영 계획(안)</h1>
                        <div style="text-align: right; font-size: 1.1rem; line-height: 1.6;">
                            <p><strong>과목명:</strong> ${plan.subjectName}</p>
                            <p><strong>교과교사:</strong> ${this.formattedTeacherNames}</p>
                        </div>
                        <h3>1. 학점이수 인정 기준</h3>
                        <p>• 과목 출석률: 수업 횟수의 2/3 미만</p>
                        ${achievementRateHtml}
                        <h3>2. 최소 성취수준 보장지도 개요</h3>
                        ${overviewTable}
                        <h3>3. 최소 성취수준 진술문</h3>
                        ${statementsTable}
                        ${preventionPlanHtml}
                        ${supplementaryPlanHtml}
                        ${additionalLearningPlanHtml}
                    </div>`;
                this.showPreviewModal = true;
            },


            // --- GUIDANCE LOGBOOK METHODS ---
            addGuidanceStudent(type) {
                const data = this.teacherGuidanceData[type];
                if (!data) return; // Add safety check
                data.error = ''; // Clear previous error
                const studentId = this.newGuidanceStudentId.trim();
                if (!studentId) return;

                if (data.students.some(s => s.id === studentId)) {
                    data.error = '이미 추가된 학생입니다.';
                    return;
                }

                // Use locally loaded studentData
                const studentInfo = this.studentData.find(s => String(s['학번']) === studentId);
                if (studentInfo) {
                    data.students.push({ id: studentId, name: studentInfo['이름'] });
                    data.students.sort((a, b) => a.id.localeCompare(b.id)); // Sort students by ID

                    // Add this student to all existing sessions' attendance with default empty value
                     data.sessions.forEach(session => {
                         if (!session.attendance.hasOwnProperty(studentId)) {
                            session.attendance[studentId] = '';
                         }
                     });

                    this.newGuidanceStudentId = '';
                    // No saveGuidanceData call needed
                } else {
                    data.error = '학적 정보에 없는 학생입니다. 먼저 학적 정보를 업로드해주세요.';
                }
            },

            removeGuidanceStudent(type, studentIdToRemove) { // Changed to accept ID
                const data = this.teacherGuidanceData[type];
                if (!data) return; // Add safety check
                const index = data.students.findIndex(s => s.id === studentIdToRemove);
                 if (index > -1) {
                    data.students.splice(index, 1);
                     // Also remove from attendance records
                     data.sessions.forEach(session => {
                        delete session.attendance[studentIdToRemove];
                     });
                     // No saveGuidanceData call needed
                 }
            },
            addGuidanceSession(type) {
                const data = this.teacherGuidanceData[type];
                if (!data) return; // Add safety check
                const initialAttendance = {};
                data.students.forEach(s => initialAttendance[s.id] = '');
                data.sessions.push({ date: '', time: '', isSaved: false, place: '', content: '', attendance: initialAttendance });
                 this.initFlatpickr(); // Re-initialize flatpickr
                // No save needed here
            },
            isSessionReadyToSave(session) {
                if (!session.date || !session.time) return false;
                // Check if at least one student *in the current view* has attendance
                 const currentStudents = this.currentGuidanceData?.students; // Optional chaining
                 if (!currentStudents) return false;
                 return currentStudents.some(student => session.attendance[student.id]);
            },

            toggleSaveSession(session) {
                session.isSaved = !session.isSaved;
                // Ensure attendance object exists for all current students
                 if (this.currentGuidanceData && this.currentGuidanceData.students) {
                     this.currentGuidanceData.students.forEach(student => {
                         if (!session.attendance.hasOwnProperty(student.id)) {
                             session.attendance[student.id] = ''; // Initialize if missing
                         }
                     });
                 }
                // No saveGuidanceData call needed
            },
            scrollAttendance(direction, event) {
                const container = event.target.closest('.relative').querySelector('.overflow-x-auto');
                if (!container) return; // Add check
                const scrollAmount = container.clientWidth * 0.8;
                container.scrollBy({
                    left: direction === 'left' ? -scrollAmount : scrollAmount,
                    behavior: 'smooth'
                });
            },
             async generatePdfFromHtml(htmlContent, orientation, filename) {
                 // Added styles within the HTML content itself for better rendering
                 const styledHtmlContent = `
                    <div style="font-family: 'Malgun Gothic', sans-serif; color: black; background: white; padding: 15mm; box-sizing: border-box;">
                        ${htmlContent}
                    </div>
                 `;

                 const printContainer = document.getElementById('print-area-container');
                 printContainer.innerHTML = styledHtmlContent;
                 printContainer.style.position = 'absolute';
                 printContainer.style.left = '-9999px';
                 // Set width based on A4 dimensions for html2canvas rendering
                 printContainer.style.width = orientation === 'p' ? '210mm' : '297mm';
                 printContainer.classList.remove('hidden');
                 const printContent = printContainer.children[0]; // Get the styled div

                 const cleanup = () => {
                     printContainer.innerHTML = '';
                     printContainer.classList.add('hidden');
                     printContainer.style.position = '';
                     printContainer.style.left = '';
                     printContainer.style.width = '';
                 };

                 if (!printContent) {
                     console.error("Print content element not found.");
                     cleanup();
                     return;
                 }

                 try {
                     const canvas = await html2canvas(printContent, {
                         scale: 2, // Increase scale for better resolution
                         useCORS: true,
                         // Ensure width/height capture the styled container
                         width: printContent.offsetWidth,
                         height: printContent.offsetHeight
                     });
                     const imgData = canvas.toDataURL('image/png');
                     const { jsPDF } = window.jspdf;
                     const pdf = new jsPDF(orientation, 'mm', 'a4');
                     const pdfPageWidth = pdf.internal.pageSize.getWidth();
                     const pdfPageHeight = pdf.internal.pageSize.getHeight();
                     const margin = 15; // PDF margin
                     const contentWidth = pdfPageWidth - margin * 2;
                     const contentHeight = pdfPageHeight - margin * 2; // Usable height per page

                     const imgRatio = canvas.height / canvas.width;
                     const pdfImgHeight = contentWidth * imgRatio; // Calculate height based on fixed width

                     let position = 0; // Tracks the Y position of the image slice on the PDF page relative to the top margin
                     let heightLeft = pdfImgHeight; // Remaining image height to add

                     // Add first page/slice
                     pdf.addImage(imgData, 'PNG', margin, margin + position, contentWidth, pdfImgHeight);
                     heightLeft -= contentHeight;

                     // Add subsequent pages if the image is taller than one page
                     while (heightLeft > 0) {
                         position -= contentHeight; // Move the image "up" relative to the new page's top margin
                         pdf.addPage();
                         pdf.addImage(imgData, 'PNG', margin, margin + position, contentWidth, pdfImgHeight);
                         heightLeft -= contentHeight;
                     }

                     pdf.save(filename);
                 } catch (error) {
                     console.error("PDF generation error:", error);
                     alert(`PDF 생성 중 오류가 발생했습니다: ${error.message}`);
                 } finally {
                     cleanup();
                 }
             },

             async generateCompletionStatusPdf(type) {
                // Simplified: Uses window.print() triggered via a separate preview modal
                 const data = this.currentGuidanceData;
                 if (!data || !this.role) return;
                 const title = type === 'preventive' ? '예방지도' : '보충지도(추가학습)';

                 // Generate the table HTML (similar to before)
                 let completionStatusTable = `<table><thead><tr style="background-color: #f2f2f2;">`;
                 completionStatusTable += `<th>학생</th>`;
                 if (type === 'supplementary') {
                    completionStatusTable += `<th>특기사항</th><th>미도달 항목</th><th>예방지도</th><th>정서지원프로그램</th>`;
                 }
                 this.moduleConfig.recognizedHours.forEach(rh => {
                     completionStatusTable += `<th>${rh.name}</th>`;
                 });
                 completionStatusTable += `<th>총계</th>`;
                 if (type === 'supplementary') {
                    completionStatusTable += `<th>이수여부</th>`;
                 }
                 completionStatusTable += '</tr></thead><tbody>';

                  if (data.students.length > 0) {
                     data.students.forEach(student => {
                         completionStatusTable += `<tr><td>${student.name} (${student.id})</td>`;
                         const studentStatus = this.guidanceCompletionStatus[student.id] || {};
                         if (type === 'supplementary') {
                             completionStatusTable += `<td>${studentStatus.specialNotes || '일반학생'}</td>`;
                             completionStatusTable += `<td>${student.reason || ''}</td>`;
                             completionStatusTable += `<td>${studentStatus.preventiveHours || 0}</td>`;
                             completionStatusTable += `<td>${studentStatus.emotionalSupportHours || 0}</td>`;
                         }
                         this.moduleConfig.recognizedHours.forEach(rh => {
                             completionStatusTable += `<td>${studentStatus[rh.name] || 0}</td>`;
                         });
                         completionStatusTable += `<td><strong>${studentStatus.total || 0}</strong></td>`;
                         if (type === 'supplementary') {
                             const status = studentStatus.completionStatus || '미이수';
                             const color = status === '이수' ? 'green' : 'red';
                             completionStatusTable += `<td style="color: ${color};"><strong>${status}</strong></td>`;
                         }
                         completionStatusTable += '</tr>';
                     });
                 } else {
                      const colspan = this.moduleConfig.recognizedHours.length + (type === 'supplementary' ? 7 : 2);
                      completionStatusTable += `<tr><td colspan="${colspan}">학생 정보가 없습니다.</td></tr>`;
                 }
                 completionStatusTable += '</tbody></table>';


                // Prepare HTML for the preview modal
                 this.previewHtml = `
                     <div id="print-area">
                         <h1>${title} 이수현황표</h1>
                         <div>
                             <p><strong>과목명:</strong> ${this.teacherPlan.subjectName || '미입력'}</p>
                             <p><strong>지도교사:</strong> ${this.formattedTeacherNames}</p>
                         </div>
                         ${completionStatusTable}
                     </div>`;
                 this.showPreviewModal = true; // Show the modal with the content
                 // The "인쇄 / PDF 저장" button in the modal will trigger printPreviewModalContent
            },

             async generateAttendancePdf(type) {
                // Simplified: Uses window.print() triggered via a separate preview modal
                 const data = this.currentGuidanceData;
                 if (!data || !this.role) return;
                 const title = type === 'preventive' ? '예방지도' : '보충지도(추가학습)';
                 const savedSessionsForAttendance = data.sessions.filter(s => s.date);

                 let attendanceTable = `<table><thead><tr style="background-color: #f2f2f2;">`;
                 attendanceTable += `<th>학번</th><th>이름</th>`;
                 savedSessionsForAttendance.forEach((session, index) => {
                     attendanceTable += `<th>${index + 1}차시<br/>(${session.date})</th>`;
                 });
                 attendanceTable += '</tr></thead><tbody>';

                 if (data.students.length > 0) {
                     data.students.forEach(student => {
                         attendanceTable += `<tr><td>${student.id}</td><td>${student.name}</td>`;
                         savedSessionsForAttendance.forEach(session => {
                             attendanceTable += `<td>${session.attendance[student.id] || ''}</td>`;
                         });
                         attendanceTable += '</tr>';
                     });
                 } else {
                     attendanceTable += `<tr><td colspan="${savedSessionsForAttendance.length + 2}">학생 정보가 없습니다.</td></tr>`;
                 }
                 attendanceTable += '</tbody></table>';

                 this.previewHtml = `
                    <div id="print-area">
                        <h1>${title} 출석부</h1>
                        <div>
                            <p><strong>과목명:</strong> ${this.teacherPlan.subjectName || '미입력'}</p>
                            <p><strong>지도교사:</strong> ${this.formattedTeacherNames}</p>
                        </div>
                        ${attendanceTable}
                    </div>
                 `;
                 this.showPreviewModal = true;
            },

             async generateLessonLogPdf(type) {
                // Simplified: Uses window.print() triggered via a separate preview modal
                 const data = this.currentGuidanceData;
                 if (!data || !this.role) return;
                 const title = type === 'preventive' ? '예방지도' : '보충지도(추가학습)';

                 let lessonLogHtml = '';
                 this.savedGuidanceSessions.forEach((session, index) => {
                     lessonLogHtml += `
                        <div class="log-entry" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; page-break-inside: avoid;">
                            <h3>${index + 1}차시 수업일지 (${session.date} / ${session.time})</h3>
                            <p><strong>장소:</strong> ${session.place || ''}</p>
                            <p><strong>수업방법:</strong> ${[...new Set(Object.values(session.attendance))].filter(Boolean).join(', ')}</p>
                            <p><strong>지도내용:</strong></p>
                            <div class="whitespace-pre-wrap" style="border: 1px solid #eee; padding: 10px; min-height: 50px;">${session.content || ''}</div>
                        </div>
                     `;
                 });

                 this.previewHtml = `
                    <div id="print-area">
                        <h1>${title} 수업일지</h1>
                        <div>
                            <p><strong>과목명:</strong> ${this.teacherPlan.subjectName || '미입력'}</p>
                            <p><strong>지도교사:</strong> ${this.formattedTeacherNames}</p>
                            <p><strong>운영기간:</strong> ${this.guidanceOperationPeriod}</p>
                        </div>
                        ${lessonLogHtml.length > 0 ? lessonLogHtml : '<p>저장된 수업일지가 없습니다.</p>'}
                    </div>
                 `;
                 this.showPreviewModal = true;
            },
            // Simplified print function for modal content
             printPreviewModalContent() {
                 const printContent = document.getElementById('print-area-container-in-modal')?.innerHTML;
                 if (!printContent) {
                     alert('인쇄할 내용을 찾을 수 없습니다.');
                     return;
                 }

                 const printWindow = window.open('', '_blank');
                 printWindow.document.write(`
                    <html>
                    <head>
                        <title>인쇄 미리보기</title>
                        <style>
                            body { font-family: 'Malgun Gothic', sans-serif; margin: 20mm; }
                            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 9pt; table-layout: fixed; }
                            th, td { border: 1px solid #666; padding: 6px; text-align: center; vertical-align: middle; word-wrap: break-word; }
                            th { background-color: #f2f2f2; }
                            .text-left { text-align: left; }
                            .whitespace-pre-wrap { white-space: pre-wrap; word-break: break-all; }
                            .signature-section { margin-top: 50px; display: flex; justify-content: space-around; text-align: center; }
                            .seal-section { text-align: center; margin-top: 50px; }
                            .seal-section img { width: 70px; height: 70px; margin: 0 auto; }
                            .school-name { font-size: 1.2rem; font-weight: bold; margin-top: 30px; }
                            .log-entry { page-break-inside: avoid; margin-bottom: 15px; border: 1px solid #ccc; padding: 15px; }
                            h1, h3, h4 { margin-top: 1.5em; margin-bottom: 0.8em; font-weight: bold; }
                            @media print {
                                @page { size: A4 portrait; margin: 20mm; } /* Ensure portrait for most forms */
                                .page-break { page-break-after: always; }
                            }
                        </style>
                    </head>
                    <body>${printContent}</body>
                    </html>
                 `);
                 printWindow.document.close(); // Important for some browsers
                 printWindow.focus(); // Focus the new window
                 // Delay print slightly to ensure content is rendered
                 setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                 }, 500);
                 this.closePreviewModal(); // Close the modal after initiating print
             },
             previewFormAdmin(type) {
                // Previews the form with sample data for Admin view
                const sampleStudent = {
                    id: '10101', name: '김학생',
                    gradeSubjects: [{ name: '샘플 과목', credits: 3 }],
                    attendanceSubjects: []
                };
                 this.previewForm(type, [sampleStudent]); // Use the existing previewForm logic
             },
            // Removed import modal functions
             resetSupplementaryStudents() {
                // Now only resets local data
                this.teacherGuidanceData.supplementary.students = [];
                 // Update attendance in sessions to remove these students
                 this.teacherGuidanceData.supplementary.sessions.forEach(session => {
                     session.attendance = {}; // Clear attendance for the supplementary tab
                 });
                 // No save call needed
             },
            // Removed Homeroom Teacher Methods

            // Mounted hook
            mounted() {
                 // Initialize flatpickr only *after* a role is selected and the view is rendered
                 // this.initFlatpickr(); // Removed from here
            }

        }).mount('#app'); // Mount the app

    </script>
</body>
</html>

