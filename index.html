<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>최소 성취수준 보장지도 관리 웹 앱</title>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        // 모듈 import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithRedirect, 
            signInWithPopup,
            getRedirectResult, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            writeBatch,
            deleteDoc,
            onSnapshot,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        
        // 전역 변수 (Canvas 환경)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 전역 Firebase 인스턴스
        let app, auth, db, storage;

        // Flatpickr (Date Picker)
        const flatpickrScript = document.createElement('script');
        flatpickrScript.src = "https://cdn.jsdelivr.net/npm/flatpickr";
        document.head.appendChild(flatpickrScript);

        const flatpickrStyle = document.createElement('link');
        flatpickrStyle.rel = "stylesheet";
        flatpickrStyle.href = "https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css";
        document.head.appendChild(flatpickrStyle);
        
        // SheetJS (XLSX)
        const sheetJsScript = document.createElement('script');
        sheetJsScript.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
        document.head.appendChild(sheetJsScript);

        // html2canvas
        const html2canvasScript = document.createElement('script');
        html2canvasScript.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
        document.head.appendChild(html2canvasScript);

    </script>
    <style>
        /* 기본 스타일 */
        body {
            font-family: 'Inter', 'Pretendard', sans-serif;
            background-color: #f4f7f6;
        }
        /* 스크롤바 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        /* 로딩 스피너 */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* 모달 공통 스타일 */
        .modal-overlay {
            position: fixed; z-index: 50;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 50rem; /* 800px */
            max-height: 90vh;
            overflow-y: auto;
        }
        /* 탭 버튼 스타일 */
        .tab-button {
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            color: #4B5563; /* gray-600 */
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            color: #3B82F6; /* blue-500 */
            border-bottom-color: #3B82F6;
        }
        .tab-button:hover:not(.active) {
            background-color: #F3F4F6; /* gray-100 */
        }
        /* 테이블 스타일 */
        table { width: 100%; border-collapse: collapse; }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: center;
            vertical-align: middle;
        }
        thead th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        tbody tr:nth-child(even) { background-color: #f9fafb; }
        /* 입력 필드 */
        input[type="text"], input[type="password"], input[type="date"], select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        /* 스크롤 버튼 */
        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .scroll-arrow.left { left: -1.25rem; }
        .scroll-arrow.right { right: -1.25rem; }

        /* 인쇄 전용 스타일 */
        @media print {
            /* 1. 기본 인쇄 설정 */
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                margin: 0;
                padding: 0;
                background-color: #fff;
            }
            
            /* 2. 인쇄 불필요 UI 요소 명시적 숨기기 */
            /* 3) FIX: 'body >'를 '#app >'로 수정하여 앱의 헤더와 메인을 숨깁니다. */
            #app > header, 
            #app > main,
            div[v-if="showAttendanceModal"],
            div[v-if="showImportModal"],
            div[v-if="showSchoolIdModal"], /* 학교 ID 모달 숨기기 */
            #print-area-container, /* html2canvas용 컨테이너 숨기기 */
            .modal-overlay .modal-content > div:not(#print-area-container-in-modal), /* 모달 내 버튼, 상태메시지 숨기기 */
            .scroll-arrow {
                display: none !important;
            }

            /* 3. 모달창 인쇄 영역 설정 */
            .modal-overlay {
                position: static !important;
                background-color: #fff !important;
            }
            .modal-content {
                width: 100% !important;
                max-width: 100% !important;
                max-height: none !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
            }
            
            /* 4. 인쇄할 모달 내용만 보이도록 설정 */
            #print-area-container-in-modal {
                visibility: visible !important;
                display: block !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
            }
            /* 5. 인쇄 시 내부 레이아웃 유지 */
            #print-area-container-in-modal * {
                 visibility: visible !important;
                 /* display: block !important; <-- 이 규칙은 내부 flex/grid 레이아웃을 깨트리므로 제거 */
            }
            
            /* 6. 페이지 나누기 */
            .page-break:not(:last-child) { 
                page-break-after: always !important; 
            }
            
            /* 7. 인쇄 시 테이블 스타일 보정 */
            table { 
                width: 100% !important;
                border-collapse: collapse !important; 
            }
            th, td { 
                border: 1px solid #333 !important; 
                padding: 6px 8px !important;
                color: #000 !important;
                background-color: #fff !important;
            }
            thead th {
                background-color: #eee !important;
            }
            /* 8. 인쇄 시 텍스트 스타일 보정 */
            h1, h2, h3, h4, p, span, div, td, th {
                color: #000 !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- 1. 헤더 -->
        <header class="bg-white shadow-md z-30">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13.5M8.25 6.253l7.5 13.5M15.75 6.253l-7.5 13.5"></path></svg>
                    <h1 class="text-2xl font-bold text-gray-800">최소 성취수준 보장지도 관리</h1>
                </div>
                <div class="flex items-center">
                    <div v-if="isLoggedIn && role" class="mr-4 text-sm">
                        <span class="font-semibold text-gray-700">{{ user.displayName || '사용자' }}</span>님
                        <span class="mx-1.5 text-gray-300">|</span>
                        <span class="font-bold" :class="role === '관리자' ? 'text-red-500' : 'text-blue-500'">{{ role }}</span>
                        <span class="mx-1.5 text-gray-300">|</span>
                        <span class="text-gray-600 font-mono text-xs bg-gray-100 px-2 py-1 rounded">{{ schoolId }}</span>
                         <button v-if="role" @click="resetRole" class="ml-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition text-sm">역할 재선택</button>
                         <button v-if="role === '관리자'" @click="openSchoolIdModal" class="ml-2 px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition text-sm">학교 ID 수정</button>
                         <button v-if="role === '관리자'" @click="openAdminCodeModal" class="ml-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition text-sm">코드 수정</button>
                    </div>
                    <button v-if="isLoggedIn" @click="logout" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition text-sm">로그아웃</button>
                    <button v-else @click="login" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">Google 로그인</button>
                </div>
            </div>
        </header>

        <!-- 2. 메인 콘텐츠 -->
        <main class="flex-grow container mx-auto px-6 py-8">
            <!-- 로딩 스피너 -->
            <div v-if="isLoading" class="flex justify-center items-center h-64">
                <div class="loader w-12 h-12 border-4 border-gray-200 rounded-full"></div>
            </div>

            <!-- 역할 선택 (로그인O, 역할X, 로딩X) -->
            <div v-if="isLoggedIn && !role && !isLoading && !showSchoolIdModal && !showAdminCodeModal" class="bg-white p-8 rounded-lg shadow-xl max-w-lg mx-auto text-center">
                <h2 class="text-2xl font-bold mb-6">역할 선택</h2>
                <p class="mb-8 text-gray-600">이 앱에서 사용할 역할을 선택하세요.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button @click="selectRole('교과교사')" class="p-6 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition">교과교사</button>
                    <button @click="selectRole('담임교사')" class="p-6 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition">담임교사</button>
                    <button @click="selectRole('관리자')" class="p-6 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">관리자</button>
                </div>
                <p v-if="roleSelectionError" class="mt-4 text-red-500 font-semibold">{{ roleSelectionError }}</p>
            </div>

            <!-- 관리자 코드 입력 모달 -->
            <div v-if="showAdminCodeModal && !isLoading" class="modal-overlay" @click.self="cancelAdminCode">
                <div class="modal-content max-w-md">
                    <h3 class="text-xl font-bold mb-4">관리자 인증</h3>
                    <p class="mb-4">관리자용 코드를 입력하세요.</p>
                    <input type="password" v-model="adminCodeInput" @keyup.enter="submitAdminCode" class="w-full p-2 border rounded" placeholder="관리자 코드">
                    <p v-if="adminCodeError" class="mt-2 text-red-500">{{ adminCodeError }}</p>
                    <div class="mt-6 flex justify-end space-x-2">
                        <button @click="cancelAdminCode" class="px-4 py-2 bg-gray-300 rounded-md">취소</button>
                        <button @click="submitAdminCode" class="px-4 py-2 bg-blue-600 text-white rounded-md">확인</button>
                    </div>
                </div>
            </div>

            <!-- 학교 ID 생성/입력 모달 -->
            <div v-if="showSchoolIdModal && !isLoading" class="modal-overlay" @click.self="cancelSchoolId">
                <div class="modal-content max-w-md">
                    <form @submit.prevent="handleSchoolIdSubmit">
                        <h3 class="text-xl font-bold mb-4">{{ selectedRole === '관리자' ? '학교 고유 ID 생성' : '학교 ID 참여' }}</h3>
                        
                        <div v-if="selectedRole === '관리자'">
                            <p class="mb-4">이 학교에서 사용할 고유 ID를 생성하세요. 이 ID는 교사들에게 공유해야 합니다. (예: `korea_high_2025`)</p>
                            <label for="school-id-input" class="font-semibold">학교 ID</label>
                            <input id="school-id-input" type="text" v-model="schoolIdInput" class="w-full p-2 border rounded mt-1" placeholder="영어, 숫자, 밑줄(_)만 사용" required>
                            <p class="text-xs text-gray-500 mt-1">한 번 생성하면 변경할 수 없습니다.</p>
                        </div>
                        
                        <div v-else>
                            <p class="mb-4">관리자로부터 공유받은 학교 ID를 입력하세요.</p>
                            <label for="school-id-input" class="font-semibold">학교 ID</label>
                            <input id="school-id-input" type="text" v-model="schoolIdInput" class="w-full p-2 border rounded mt-1" placeholder="학교 ID 입력" required>
                        </div>

                        <p v-if="schoolIdError" class="mt-2 text-red-500">{{ schoolIdError }}</p>
                        
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" @click="cancelSchoolId" class="px-4 py-2 bg-gray-300 rounded-md">취소</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">{{ selectedRole === '관리자' ? '생성하기' : '참여하기' }}</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 대시보드 (로그인O, 역할O, 로딩X) -->
            <div v-if="isLoggedIn && role && !isLoading && !showSchoolIdModal && !showAdminCodeModal">
                
                <!-- 탭 네비게이션 (관리자/교과교사/담임교사 공통) -->
                <div class="mb-6 bg-white rounded-lg shadow-sm">
                    <nav class="flex border-b border-gray-200">
                        <button v-if="role === '관리자'" @click="currentTab = 'adminDashboard'" 
                                :class="{'active': currentTab === 'adminDashboard'}" class="tab-button">
                            관리자 대시보드
                        </button>
                        <button v-if="role === '관리자' || role === '교과교사'" @click="currentTab = 'teacherPlan'" 
                                :class="{'active': currentTab === 'teacherPlan'}" class="tab-button">
                            지도 계획안 (교과)
                        </button>
                        <button v-if="role === '관리자' || role === '교과교사' || role === '담임교사'" @click="currentTab = 'attendanceBook'" 
                                :class="{'active': currentTab === 'attendanceBook'}" class="tab-button">
                            출결 및 이수 (보충지도)
                        </button>
                        <button v-if="role === '관리자' || role === '담임교사'" @click="currentTab = 'homeroomReport'" 
                                :class="{'active': currentTab === 'homeroomReport'}" class="tab-button">
                            학생 현황 (담임)
                        </button>
                    </nav>
                </div>

                <!-- 1. 관리자 대시보드 -->
                <div v-if="currentTab === 'adminDashboard'" class="space-y-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">관리자 대시보드</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 1. 교육과정 편제표 업로드 -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">1. 교육과정 편제표 업로드</h3>
                            <div class="flex space-x-4">
                                <button @click="downloadTemplate('curriculum')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>
                                <input type="file" @change="uploadFile($event, 'curriculum')" class="hidden" id="curriculum-upload-admin">
                                <label for="curriculum-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</label>
                                <!-- ADD DELETE BUTTON -->
                                <button @click="openDeleteModal('curriculum', '교육과정 편제표')" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition" :disabled="curriculumData.length === 0">파일 삭제</button>
                            </div>
                            <p v-if="uploadStatus.curriculum" class="mt-2 text-sm font-medium">{{ uploadStatus.curriculum }}</p>
                        </div>

                        <!-- 2. 학적 정보 업로드 -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">2. 학적 정보 업로드</h3>
                            <div class="flex space-x-4">
                                <button @click="downloadTemplate('student')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>
                                <input type="file" @change="uploadFile($event, 'student')" class="hidden" id="student-upload-admin">
                                <label for="student-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</label>
                                <!-- ADD DELETE BUTTON -->
                                <button @click="openDeleteModal('student', '학적 정보')" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition" :disabled="studentData.length === 0">파일 삭제</button>
                            </div>
                             <p v-if="uploadStatus.student" class="mt-2 text-sm font-medium">{{ uploadStatus.student }}</p>
                        </div>

                         <!-- 2-1. 정서지원프로그램 이수시간 업로드 -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">2-1. 정서지원프로그램 이수시간 업로드</h3>
                            <div class="flex space-x-4">
                                <button @click="downloadTemplate('emotionalSupport')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">양식 다운로드</button>
                                <input type="file" @change="uploadFile($event, 'emotionalSupport')" class="hidden" id="emotional-support-upload-admin">
                                <label for="emotional-support-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">엑셀 파일 업로드</llabel>
                                <!-- ADD DELETE BUTTON -->
                                <button @click="openDeleteModal('emotionalSupport', '정서지원프로그램 이수시간')" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition" :disabled="emotionalSupportData.length === 0">파일 삭제</button>
                            </div>
                            <p v-if="uploadStatus.emotionalSupport" class="mt-2 text-sm font-medium">{{ uploadStatus.emotionalSupport }}</p>
                        </div>

                        <!-- 3. 운영 모듈 설계 -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">3. 운영 모듈 설계</h3>
                            <div class="space-y-3">
                                <div class="flex items-center space-x-2">
                                    <label for="moduleA" class="w-48">모듈A (교과 내)</label>
                                    <input id="moduleA" type="text" v-model="moduleConfig.A" placeholder="예: 정규수업 + 과제" class="flex-grow">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label for="moduleB" class="w-48">모듈B (교과 연계)</label>
                                    <input id="moduleB" type="text" v-model="moduleConfig.B" placeholder="예: 점심/방과후 + 교과연계" class="flex-grow">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label for="moduleC" class="w-48">모듈C (타 교과/창체)</label>
                                    <input id="moduleC" type="text" v-model="moduleConfig.C" placeholder="예: 타교과 연계" class="flex-grow">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label for="moduleD" class="w-48">모듈D (정서 등)</label>
                                    <input id="moduleD" type="text" v-model="moduleConfig.D" placeholder="예: 정서지원 프로그램" class="flex-grow">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label for="moduleE" class="w-48">모듈E (기타)</label>
                                    <input id="moduleE" type="text" v-model="moduleConfig.E" placeholder="예: 학생 맞춤형" class="flex-grow">
                                </div>
                            </div>
                            <button @click="saveModuleConfig" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">모듈 설정 저장</button>
                            <p v-if="adminActionStatus.module" class="mt-2 text-sm font-medium">{{ adminActionStatus.module }}</p>
                        </div>
                    </div>

                    <!-- 4. 미도달 대상자 관리 -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">4. 미도달 대상자 관리</h3>
                        <div class="flex space-x-4">
                            <button @click="downloadTemplate('underachiever')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">성적(미도달) 양식 다운로드</button>
                            <input type="file" @change="uploadFile($event, 'underachiever')" class="hidden" id="underachiever-upload-admin">
                            <label for="underachiever-upload-admin" class="cursor-pointer px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">성적(미도달) 파일 업로드</label>
                            <button @click="deployUnderachievers" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition" :disabled="!isUnderachieverDataUploaded">미도달 대상자 배포</button>
                        </div>
                        <p v-if="uploadStatus.underachiever" class="mt-2 text-sm font-medium">{{ uploadStatus.underachiever }}</p>
                        <p v-if="adminActionStatus.deploy" class="mt-2 text-sm font-medium">{{ adminActionStatus.deploy }}</p>
                        
                        <!-- 배포된 미도달 대상자 목록 -->
                        <div v-if="deployedUnderachievers.length > 0" class="mt-6">
                            <h4 class="text-lg font-semibold mb-2">배포된 미도달 대상자 ({{ deployedUnderachievers.length }}명)</h4>
                            <div class="max-h-64 overflow-y-auto border rounded-md">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="py-2 px-3">학년</th>
                                            <th class="py-2 px-3">반</th>
                                            <th class="py-2 px-3">번호</th>
                                            <th class="py-2 px-3">이름</th>
                                            <th class="py-2 px-3">미도달 과목</th>
                                            <th class="py-2 px-3">미도달 내역</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template v-for="(student, sIdx) in groupedUnderachievers" :key="sIdx">
                                            <tr v-for="(subject, subIdx) in student.subjects" :key="subIdx">
                                                <td v-if="subIdx === 0" :rowspan="student.subjects.length" class="py-2 px-3">{{ student.grade }}</td>
                                                <td v-if="subIdx === 0" :rowspan="student.subjects.length" class="py-2 px-3">{{ student.class }}</td>
                                                <td v-if="subIdx === 0" :rowspan="student.subjects.length" class="py-2 px-3">{{ student.number }}</td>
                                                <td v-if="subIdx === 0" :rowspan="student.subjects.length" class="py-2 px-3">{{ student.name }}</td>
                                                <td class="py-2 px-3 text-left">{{ subject.subjectName }}</td>
                                                <td class="py-2 px-3 text-left">{{ subject.reasons.join(', ') }}</td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 5. 가정통신문 및 서약서 (관리자) -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">5. 가정통신문 및 서약서 관리</h3>
                        <div class="flex space-x-4">
                            <button @click="generateForm('notification')" class="px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 transition" :disabled="deployedUnderachievers.length === 0">
                                가정통신문 일괄 생성
                            </button>
                             <button @click="generateForm('pledge')" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 transition" :disabled="deployedUnderachievers.length === 0">
                                서약서 일괄 생성
                            </button>
                        </div>
                        <p v-if="adminActionStatus.form" class="mt-2 text-sm font-medium">{{ adminActionStatus.form }}</p>
                    </div>
                </div>

                <!-- 2. 지도 계획안 (교과교사) -->
                <div v-if="currentTab === 'teacherPlan'" class="bg-white p-8 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">최소 성취수준 보장지도 계획안</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">학년</label>
                            <select v-model="teacherPlan.grade" @change="updateSubjects" class="w-full">
                                <option disabled value="">학년 선택</option>
                                <option v-for="g in availableGrades" :key="g" :value="g">{{ g }}학년</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">과목</label>
                            <select v-model="teacherPlan.subject" @change="loadTeacherPlan" class="w-full">
                                <option disabled value="">과목 선택</option>
                                <option v-for="s in availableSubjects" :key="s" :value="s">{{ s }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">담당 교사</label>
                            <input type="text" v-model="teacherPlan.teacherName" placeholder="이름 입력" class="w-full" :disabled="!teacherPlan.subject">
                        </div>
                    </div>

                    <div v-if="teacherPlan.subject" class="space-y-4">
                        <textarea v-model="teacherPlan.planContent" rows="15" class="w-full p-4 border rounded-md" placeholder="여기에 지도 계획안 내용을 입력하세요..."></textarea>
                        
                        <div class="flex justify-between items-center">
                            <div>
                                <button @click="saveTeacherPlan" class="px-5 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">계획안 저장</button>
                                <p v-if="teacherPlanStatus" class="inline-block ml-4 text-sm font-medium">{{ teacherPlanStatus }}</p>
                            </div>
                            <button @click="generatePlanPreview" class="px-5 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">계획안 양식 미리보기</button>
                        </div>
                        <p v-if="teacherPlanError" class="text-red-500">{{ teacherPlanError }}</p>
                    </div>
                    <div v-else>
                        <p class="text-gray-500 text-center py-10">학년과 과목을 선택하면 계획안을 작성할 수 있습니다.</p>
                    </div>
                </div>

                <!-- 3. 출결 및 이수 (보충지도) -->
                <div v-if="currentTab === 'attendanceBook'" class="bg-white p-8 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">보충지도 출결 및 이수 관리</h2>
                        <div class="flex space-x-2">
                             <button @click="importAttendance" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition">
                                출결 이력 가져오기
                            </button>
                            <button @click="openAttendanceModal(null)" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">
                                대상자 가져오기
                            </button>
                        </div>
                    </div>

                    <!-- 출결부 테이블 -->
                    <div v-if="supplementaryStudents.length > 0" class="overflow-x-auto relative">
                         <!-- 스크롤 버튼 -->
                        <button v-if="showLeftScroll" @click="scrollTable(-1)" class="scroll-arrow left">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <button v-if="showRightScroll" @click="scrollTable(1)" class="scroll-arrow right">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>

                        <div ref="tableContainer" @scroll="handleTableScroll" class="overflow-x-auto max-w-full">
                            <table class="min-w-full">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="py-3 px-4 sticky left-0 bg-gray-50 z-10">학년</th>
                                        <th class="py-3 px-4 sticky left-16 bg-gray-50 z-10">반</th>
                                        <th class="py-3 px-4 sticky left-28 bg-gray-50 z-10">번호</th>
                                        <th class="py-3 px-4 sticky left-40 bg-gray-50 z-10">이름</th>
                                        <th class="py-3 px-4">과목</th>
                                        <th class="py-3 px-4">지도 모듈</th>
                                        <th class="py-3 px-4">지도교사</th>
                                        <th class="py-3 px-4">지도 시작일</th>
                                        <th class="py-3 px-4">지도 종료일</th>
                                        <!-- 차시별 출결 (동적 생성) -->
                                        <th v-for="n in totalSessions" :key="`header-${n}`" class="py-3 px-4 min-w-[80px]">
                                            {{ n }}차시<br>
                                            <input type="date" v-model="sessionDates[n-1]" @change="saveGuidanceData" class="text-xs p-1 w-28">
                                        </th>
                                        <th class="py-3 px-4">이수</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    <tr v-for="(student, sIdx) in supplementaryStudents" :key="sIdx" class="hover:bg-gray-50">
                                        <td class="py-3 px-4 sticky left-0 bg-white z-10">{{ student.grade }}</td>
                                        <td class="py-3 px-4 sticky left-16 bg-white z-10">{{ student.class }}</td>
                                        <td class="py-3 px-4 sticky left-28 bg-white z-10">{{ student.number }}</td>
                                        <td class="py-3 px-4 sticky left-40 bg-white z-10">{{ student.name }}</td>
                                        <td class="py-3 px-4">{{ student.subject }}</td>
                                        <td class="py-3 px-4">
                                            <select v-model="student.module" @change="saveGuidanceData" class="w-32">
                                                <option value="">선택</option>
                                                <option v-for="(name, key) in moduleConfig" :key="key" :value="key">{{ key }}: {{ name }}</option>
                                            </select>
                                        </td>
                                        <td class="py-3 px-4">
                                            <input type="text" v-model="student.teacher" @change="saveGuidanceData" class="w-24">
                                        </td>
                                        <td class="py-3 px-4">
                                            <input type="date" v-model="student.startDate" @change="saveGuidanceData" class="w-28">
                                        </td>
                                        <td class="py-3 px-4">
                                            <input type="date" v-model="student.endDate" @change="saveGuidanceData" class="w-28">
                                        </td>
                                        <!-- 차시별 출결 (동적 생성) -->
                                        <td v-for="n in totalSessions" :key="`cell-${sIdx}-${n}`" class="py-3 px-4">
                                            <select v-model="student.attendance[n-1]" @change="saveGuidanceData" class="w-20">
                                                <option value="O">O</option>
                                                <option value="X">X</option>
                                                <option value="/">/</option>
                                            </select>
                                        </td>
                                        <td class="py-3 px-4">
                                            <input type="checkbox" v-model="student.isCompleted" @change="saveGuidanceData" class="h-5 w-5">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <p v-else class="text-center text-gray-500 py-10">
                        '대상자 가져오기' 버튼을 클릭하여 보충지도 학생을 추가하세요.
                    </p>
                    <p v-if="attendanceStatus" class="mt-4 text-sm font-medium">{{ attendanceStatus }}</p>
                </div>

                <!-- 4. 학생 현황 (담임교사) -->
                <div v-if="currentTab === 'homeroomReport'" class="bg-white p-8 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">우리반 학생 현황</h2>
                    
                    <div class="flex space-x-4 mb-6">
                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">학년</label>
                            <select v-model="homeroomFilter.grade" @change="updateClasses" class="w-full">
                                <option disabled value="">학년 선택</option>
                                <option v-for="g in availableGrades" :key="g" :value="g">{{ g }}학년</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">반</label>
                            <select v-model="homeroomFilter.class" @change="filterHomeroomStudents" class="w-full">
                                <option disabled value="">반 선택</option>
                                <option v-for="c in availableClasses" :key="c" :value="c">{{ c }}반</option>
                            </select>
                        </div>
                    </div>

                    <div v-if="homeroomStudents.length > 0">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th>번호</th>
                                    <th>이름</th>
                                    <th>미도달 과목</th>
                                    <th>보충지도 모듈</th>
                                    <th>보충지도 이수 현황</th>
                                    <th>정서지원 이수 현황</th>
                                    <th>가정통신문/서약서</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="student in homeroomStudents" :key="student.id">
                                    <td>{{ student.number }}</td>
                                    <td>{{ student.name }}</td>
                                    <td class="text-left">
                                        <ul class="list-disc list-inside">
                                            <li v-for="item in student.underachieved" :key="item.subject">
                                                {{ item.subject }} ({{ item.reasons.join(', ') }})
                                            </li>
                                        </ul>
                                    </td>
                                    <td class="text-left">
                                         <ul class="list-disc list-inside">
                                            <li v-for="item in student.supplementary" :key="item.subject">
                                                {{ item.subject }} ({{ moduleConfig[item.module] || item.module }})
                                            </li>
                                        </ul>
                                    </td>
                                    <td class_="text-left">
                                        <ul class="list-disc list-inside">
                                            <li v-for="item in student.supplementary" :key="item.subject">
                                                {{ item.subject }}:
                                                <span :class="item.isCompleted ? 'text-green-600 font-semibold' : 'text-red-500'">
                                                    {{ item.isCompleted ? '이수' : '미이수' }}
                                                </span>
                                                ({{ item.progress }}%)
                                            </li>
                                        </ul>
                                    </td>
                                    <td>
                                        <span v-if="student.emotionalSupportHours !== null" :class="student.emotionalSupportHours > 0 ? 'text-green-600 font-semibold' : 'text-gray-500'">
                                            {{ student.emotionalSupportHours }} 시간
                                        </span>
                                        <span v-else class="text-gray-400">N/A</span>
                                    </td>
                                    <td>
                                        <div class="flex flex-col space-y-2">
                                            <button @click="generateForm('notification', [student.id])" class="px-3 py-1 bg-teal-500 text-white rounded-md text-sm hover:bg-teal-600">통신문</button>
                                            <button @click="generateForm('pledge', [student.id])" class="px-3 py-1 bg-orange-500 text-white rounded-md text-sm hover:bg-orange-600">서약서</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                     <p v-else-if="homeroomFilter.class" class="text-center text-gray-500 py-10">
                        선택한 학급에 학생 데이터가 없습니다.
                    </p>
                    <p v-else class="text-center text-gray-500 py-10">
                        학년과 반을 선택하세요.
                    </p>
                </div>
            </div>
        </main>
        
        <!-- 삭제 확인 모달 -->
        <div v-if="showDeleteModal" class="modal-overlay" @click.self="closeDeleteModal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">파일 삭제 확인</h3>
                <p>정말로 '{{ fileToDelete.name }}' 데이터를 삭제하시겠습니까?</p>
                <p class="text-sm text-red-600 my-2">이 작업은 되돌릴 수 없으며, 데이터베이스에서 해당 파일의 데이터가 영구적으로 삭제됩니다.</p>
                <p v-if="deleteStatus" class="mt-2 text-sm font-medium" :class="deleteStatus.includes('오류') ? 'text-red-500' : 'text-green-600'">{{ deleteStatus }}</p>
                <div class="mt-6 flex justify-end space-x-2">
                    <button @click="closeDeleteModal" class="px-4 py-2 bg-gray-300 rounded-md">취소</button>
                    <button @click="deleteUploadedFile" class="px-4 py-2 bg-red-600 text-white rounded-md">삭제</button>
                </div>
            </div>
        </div>

        <!-- 출결부 - 대상자 가져오기 모달 -->
        <div v-if="showAttendanceModal" class="modal-overlay" @click.self="closeAttendanceModal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">보충지도 대상자 가져오기</h3>
                <p class="mb-4">보충지도 출결부에 추가할 학생을 선택하세요. (관리자가 배포한 미도달 대상자)</p>
                
                <div v-if="availableUnderachievers.length > 0" class="max-h-96 overflow-y-auto border rounded-md">
                     <table class="min-w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="p-2"><input type="checkbox" @change="toggleSelectAllStudents($event)"></th>
                                <th class="p-2 text-left">학년</th>
                                <th class="p-2 text-left">반</th>
                                <th class="p-2 text-left">번호</th>
                                <th class="p-2 text-left">이름</th>
                                <th class="p-2 text-left">과목</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="student in availableUnderachievers" :key="student.id + student.subjectName" class="hover:bg-gray-50">
                                <td class="p-2 text-center">
                                    <input type="checkbox" v-model="selectedStudents" :value="student" class="h-4 w-4">
                                </td>
                                <td class="p-2">{{ student.grade }}</td>
                                <td class="p-2">{{ student.class }}</td>
                                <td class="p-2">{{ student.number }}</td>
                                <td class="p-2">{{ student.name }}</td>
                                <td class="p-2">{{ student.subjectName }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p v-else class="text-center text-gray-500 py-6">
                    관리자가 배포한 미도달 대상자가 없거나, 모든 대상자가 이미 출결부에 추가되었습니다.
                </p>

                <p v-if="attendanceModalStatus" class="mt-2 text-sm font-medium">{{ attendanceModalStatus }}</p>
                <div class="mt-6 flex justify-end space-x-2">
                    <button @click="closeAttendanceModal" class="px-4 py-2 bg-gray-300 rounded-md">취소</button>
                    <button @click="addStudentsToAttendance" class="px-4 py-2 bg-blue-600 text-white rounded-md" :disabled="selectedStudents.length === 0">선택한 학생 추가</button>
                </div>
            </div>
        </div>

        <!-- 미리보기 모달 (가정통신문, 계획안 등) -->
        <div v-if="showPreviewModal" class="modal-overlay" @click.self="closePreviewModal">
            <div class="modal-content relative">
                <!-- 모달 내용 (인쇄 영역) -->
                <div id="print-area-container-in-modal" class="prose max-w-none">
                     <div v-html="previewHtml"></div>
                </div>

                <!-- 모달 버튼 (인쇄 시 숨김) -->
                 <div class="mt-6 pt-6 border-t flex justify-end space-x-2">
                    <p v-if="adminActionStatus.form" class="mt-2 text-sm font-medium">{{ adminActionStatus.form }}</p>
                    <button @click="closePreviewModal" class="px-4 py-2 bg-gray-300 rounded-md">닫기</button>
                    <button @click="printPreviewModalContent" class="px-4 py-2 bg-blue-600 text-white rounded-md">인쇄 / PDF 저장</button>
                </div>
            </div>
        </div>

        <!-- 출결 이력 가져오기 모달 -->
        <div v-if="showImportModal" class="modal-overlay" @click.self="closeImportModal">
            <div class="modal-content max-w-lg">
                <h3 class="text-xl font-bold mb-4">출결 이력 가져오기</h3>
                <p class="mb-4">이전 학기 또는 다른 교사의 출결 이력이 담긴 엑셀 파일을 업로드하세요.</p>
                <input type="file" @change="handleAttendanceImport" class="w-full p-2 border rounded">
                <p v-if="importStatus" class="mt-2 text-sm font-medium" :class="importStatus.includes('오류') ? 'text-red-500' : 'text-green-600'">{{ importStatus }}</p>
                <div class="mt-6 flex justify-end space-x-2">
                    <button @click="closeImportModal" class="px-4 py-2 bg-gray-300 rounded-md">닫기</button>
                </div>
            </div>
        </div>

        <!-- 인쇄용 컨테이너 (숨김 - html2canvas 전용) -->
        <div id="print-area-container" class="hidden"></div>
    </div>

    <!-- Vue App Script -->
    <script type="module">
        // Firebase 인스턴스 초기화 (import 이후)
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);
        
        const { createApp, ref, reactive, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            data() {
                return {
                    // --- App State ---
                    isLoading: true,
                    isLoggedIn: false,
                    currentTab: 'adminDashboard', // 기본 탭
                    
                    // --- User & Auth ---
                    user: null,
                    role: null, // '관리자', '교과교사', '담임교사'
                    selectedRole: null, // 역할 선택 중 임시 저장
                    roleSelectionError: '',
                    schoolId: null, // 학교 고유 ID
                    schoolIdInput: '',
                    showSchoolIdModal: false,
                    schoolIdError: '',
                    adminCodeInput: '',
                    showAdminCodeModal: false,
                    adminCodeError: '',
                    adminCode: '0822', // 관리자 코드 (실제로는 Firestore 등에서 관리)

                    // --- Common Data (Admin) ---
                    curriculumData: [], // 편제표
                    studentData: [], // 학적
                    emotionalSupportData: [], // 정서지원
                    underachieverData: [], // 성적(미도달) - 임시 저장용
                    deployedUnderachievers: [], // 배포된 미도달 대상자
                    moduleConfig: { A: '', B: '', C: '', D: '', E: '' },
                    uploadStatus: { curriculum: '', student: '', emotionalSupport: '', underachiever: '' },
                    adminActionStatus: { module: '', deploy: '', form: '' },

                    // --- Teacher Plan (교과교사) ---
                    teacherPlan: {
                        grade: '',
                        subject: '',
                        teacherName: '',
                        planContent: ''
                    },
                    teacherPlanStatus: '',
                    teacherPlanError: '',

                    // --- Attendance (교과교사) ---
                    supplementaryStudents: [], // 출결부 학생 목록
                    totalSessions: 10, // 기본 차시
                    sessionDates: Array(10).fill(''),
                    attendanceStatus: '',
                    showAttendanceModal: false,
                    selectedStudents: [],
                    attendanceModalStatus: '',
                    showImportModal: false,
                    importStatus: '',
                    tableScrollTimer: null,
                    showLeftScroll: false,
                    showRightScroll: false,

                    // --- Homeroom (담임교사) ---
                    homeroomFilter: {
                        grade: '',
                        class: ''
                    },

                    // --- Preview Modal State ---
                    showPreviewModal: false,
                    previewHtml: '',

                    // --- Delete Modal State ---
                    showDeleteModal: false,
                    fileToDelete: { type: '', name: '' },
                    deleteStatus: '',
                }
            },
            
            computed: {
                // --- 데이터 가공 ---
                // 관리자: 배포된 미도달 학생 그룹화
                groupedUnderachievers() {
                    if (this.deployedUnderachievers.length === 0) return [];
                    const map = new Map();
                    this.deployedUnderachievers.forEach(s => {
                        const key = s.id; // 학생 고유 ID (학번)
                        if (!map.has(key)) {
                            map.set(key, {
                                ...s, // grade, class, number, name
                                subjects: []
                            });
                        }
                        map.get(key).subjects.push({
                            subjectName: s.subjectName,
                            reasons: s.reasons
                        });
                    });
                    return Array.from(map.values()).sort((a, b) => {
                         if (a.grade !== b.grade) return a.grade.localeCompare(b.grade);
                         if (a.class !== b.class) return a.class.localeCompare(b.class);
                         return a.number.localeCompare(b.number);
                    });
                },
                // 관리자: 미도달 성적 파일이 업로드되었는지
                isUnderachieverDataUploaded() {
                    return this.underachieverData.length > 0;
                },
                // 교과교사: 편제표에서 선택 가능한 학년
                availableGrades() {
                    return [...new Set(this.curriculumData.map(item => item.학년))].sort();
                },
                // 교과교사: 선택한 학년에 해당하는 과목
                availableSubjects() {
                    if (!this.teacherPlan.grade) return [];
                    return [...new Set(this.curriculumData
                        .filter(item => item.학년 === this.teacherPlan.grade)
                        .map(item => item.과목명))]
                        .sort();
                },
                // 담임교사: 학적부에서 선택 가능한 반
                availableClasses() {
                    if (!this.homeroomFilter.grade) return [];
                     return [...new Set(this.studentData
                        .filter(item => item.학년 === this.homeroomFilter.grade)
                        .map(item => item.반))]
                        .sort((a,b) => a - b); // 숫자 정렬
                },
                // 출결부: 모달에 표시할 미도달 학생 (이미 추가된 학생 제외)
                availableUnderachievers() {
                    const addedStudents = new Set(this.supplementaryStudents.map(s => s.id + s.subject));
                    
                    // deployedUnderachievers (id, grade, class, number, name, subjectName, reasons)
                    // -> (id, grade, class, number, name, subjectName)
                    return this.deployedUnderachievers
                        .filter(s => !addedStudents.has(s.id + s.subjectName))
                        .map(s => ({
                            id: s.id,
                            grade: s.grade,
                            class: s.class,
                            number: s.number,
                            name: s.name,
                            subjectName: s.subjectName
                        }));
                },
                // 담임교사: 필터링된 우리반 학생 목록
                homeroomStudents() {
                    if (!this.homeroomFilter.grade || !this.homeroomFilter.class) return [];
                    
                    // 1. 학적부에서 우리반 학생 필터링
                    const students = this.studentData
                        .filter(s => s.학년 === this.homeroomFilter.grade && s.반 === this.homeroomFilter.class)
                        .map(s => ({
                            id: s.학번,
                            grade: s.학년,
                            class: s.반,
                            number: s.번호,
                            name: s.이름,
                            underachieved: [], // 미도달 현황
                            supplementary: [], // 보충지도 현황
                            emotionalSupportHours: null // 정서지원
                        }))
                        .sort((a,b) => a.number.localeCompare(b.number));

                    // 2. 미도달 현황 매핑
                    this.deployedUnderachievers.forEach(ua => {
                        const student = students.find(s => s.id === ua.id);
                        if (student) {
                            student.underachieved.push({
                                subject: ua.subjectName,
                                reasons: ua.reasons
                            });
                        }
                    });

                    // 3. 보충지도 현황 매핑
                    this.supplementaryStudents.forEach(sup => {
                         const student = students.find(s => s.id === sup.id);
                         if (student) {
                             const total = sup.attendance.length;
                             const attended = sup.attendance.filter(a => a === 'O').length;
                             student.supplementary.push({
                                 subject: sup.subject,
                                 module: sup.module,
                                 isCompleted: sup.isCompleted,
                                 progress: total > 0 ? Math.round((attended / total) * 100) : 0
                             });
                         }
                    });

                    // 4. 정서지원 이수시간 매핑
                    this.emotionalSupportData.forEach(emo => {
                        const student = students.find(s => s.id === emo.학번);
                        if (student) {
                            student.emotionalSupportHours = emo.이수시간 || 0;
                        }
                    });

                    return students;
                }
            },

            watch: {
                // 역할이 변경되면 탭을 재설정
                role(newRole) {
                    if (!newRole) {
                        this.currentTab = 'adminDashboard'; // 기본값
                    } else if (newRole === '관리자') {
                        this.currentTab = 'adminDashboard';
                    } else if (newRole === '교과교사') {
                        this.currentTab = 'teacherPlan';
                    } else if (newRole === '담임교사') {
                        this.currentTab = 'homeroomReport';
                    }
                },
                // 보충지도 학생 목록이 바뀌면 차시 자동 확장
                supplementaryStudents: {
                    handler(newStudents) {
                        let maxSessions = this.totalSessions;
                        newStudents.forEach(s => {
                            if (s.attendance.length > maxSessions) {
                                maxSessions = s.attendance.length;
                            }
                        });
                        if (maxSessions > this.totalSessions) {
                            this.totalSessions = maxSessions;
                        }
                        // 날짜 배열도 맞춤
                        while(this.sessionDates.length < this.totalSessions) {
                            this.sessionDates.push('');
                        }
                    },
                    deep: true
                },
                // 총 차시가 늘어나면 학생들 출결 배열도 늘림
                totalSessions(newTotal) {
                    this.supplementaryStudents.forEach(s => {
                        while (s.attendance.length < newTotal) {
                            s.attendance.push('');
                        }
                    });
                     while(this.sessionDates.length < newTotal) {
                        this.sessionDates.push('');
                    }
                }
            },

            methods: {
                // --- Helper and UI Methods ---
                extractSchoolIdFromEmail(email) {
                    // Firestore 경로에 사용할 수 없는 문자 제거
                    const sanitize = (id) => id.replace(/[.#$[\]]/g, '_');
                    
                    if (!email) return null;
                    const parts = email.split('@');
                    if (parts.length !== 2) return null;
                    const domain = parts[1];

                    // 1. .kr 도메인 (schoolid.hs.kr, schoolid.es.kr 등)
                    const krMatch = domain.match(/^([a-zA-Z0-9-]+)\.(hs|ms|es|go|sc)\.kr$/);
                    if (krMatch && krMatch[1]) {
                        return sanitize(krMatch[1]);
                    }
                    
                    // 2. 일반 .kr 도메인 (schoolid.kr)
                    const basicKrMatch = domain.match(/^([a-zA-Z0-9-]+)\.kr$/);
                     if (basicKrMatch && basicKrMatch[1]) {
                        return sanitize(basicKrMatch[1]);
                    }

                    // 3. (추측) gmail.com 등 공용 도메인 -> ID 추출 불가
                    if (['gmail.com', 'naver.com', 'hanmail.net', 'daum.net'].includes(domain)) {
                        return null; 
                    }

                    // 4. (최후의 추측) 도메인의 첫 번째 부분 (test.com -> test)
                    return sanitize(domain.split('.')[0]);
                },
                initFlatpickr() {
                    // Flatpickr 초기화
                    if (window.flatpickr) {
                        flatpickr("input[type='date']", {
                            dateFormat: "Y-m-d",
                            locale: "ko" // 한국어 지원 시
                        });
                    }
                },
                handleTableScroll() {
                    if (this.tableScrollTimer) clearTimeout(this.tableScrollTimer);
                    this.tableScrollTimer = setTimeout(() => {
                        const el = this.$refs.tableContainer;
                        if (!el) return;
                        this.showLeftScroll = el.scrollLeft > 0;
                        this.showRightScroll = el.scrollLeft < (el.scrollWidth - el.clientWidth - 1); // -1 for precision
                    }, 100);
                },
                scrollTable(direction) {
                     const el = this.$refs.tableContainer;
                     if (!el) return;
                     const scrollAmount = el.clientWidth * 0.8 * direction; // 80%씩 스크롤
                     el.scrollBy({ left: scrollAmount, behavior: 'smooth' });
                },

                // --- Initialization and Auth ---
                async initApp() {
                    this.isLoading = true;
                    if (!auth) {
                        console.error("Firebase Auth is not initialized.");
                        this.isLoading = false;
                        return;
                    }
                    
                    // Google 리디렉션 로그인 결과 처리
                    try {
                        const result = await getRedirectResult(auth);
                        if (result) {
                            // 리디렉션에서 방금 돌아온 경우
                            this.user = result.user;
                            this.isLoggedIn = true;
                        }
                    } catch (error) {
                        console.error("Error during getRedirectResult:", error);
                    }

                    // 인증 상태 리스너 설정
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            this.user = user;
                            this.isLoggedIn = true;
                            
                            // schoolId 로드 시도 (이메일에서 추측/파싱)
                            const schoolIdGuess = this.extractSchoolIdFromEmail(user.email);
                            
                            // Firestore에서 역할/ID 로드
                            await this.loadUserRole(schoolIdGuess); 
                            
                            // schoolId와 role이 모두 확정되어야 데이터 로드
                            if (this.role && this.schoolId) { 
                                await this.loadCommonData(); // 공용 데이터
                                // 역할별 개인 데이터 로드
                                if (this.role === '교과교사') {
                                    // 교과교사는 과목 선택 시 로드
                                } else if (this.role === '담임교사') {
                                    // 담임교사는 학급 선택 시 로드
                                }
                                // 출결부 데이터는 항상 로드
                                await this.loadGuidanceData();
                            } 
                            
                        } else {
                            this.user = null;
                            this.isLoggedIn = false;
                            this.resetAllLocalData(true); // 로그아웃 시 모든 데이터 초기화
                        }
                        this.isLoading = false;
                        await nextTick();
                        this.initFlatpickr();
                        this.handleTableScroll();
                    });
                },

                login() {
                    const provider = new GoogleAuthProvider();
                    // signInWithRedirect(auth, provider);
                    signInWithPopup(auth, provider).catch(error => {
                         console.error("Login popup error:", error);
                    });
                },

                async logout() {
                    await signOut(auth);
                },

                // (수정됨) 역할 선택
                async selectRole(role) {
                    this.selectedRole = role; // 임시 저장
                    
                    if (role === '관리자') {
                        this.adminCodeInput = '';
                        this.adminCodeError = '';
                        this.showAdminCodeModal = true;
                    } else {
                        // 교과/담임교사
                        // 기존 schoolId가 있어도 다시 입력받도록 수정
                        this.schoolIdInput = this.schoolId || ''; // 기존 ID가 있으면 채워넣기
                        this.schoolIdError = '';
                        this.showSchoolIdModal = true;
                    }
                },

                // (수정됨) 관리자 코드 제출
                submitAdminCode() {
                    if (this.adminCodeInput === this.adminCode) {
                        this.adminCodeError = '';
                        this.showAdminCodeModal = false;
                        
                        // 관리자 코드 인증 성공 후, 학교 ID 입력 모달 표시
                        // 기존 schoolId가 있어도 다시 입력(확인)받도록 수정
                        this.schoolIdInput = this.schoolId || ''; // 기존 ID가 있으면 채워넣기
                        this.schoolIdError = '';
                        this.showSchoolIdModal = true;
                    } else {
                        this.adminCodeError = '코드가 일치하지 않습니다.';
                    }
                },
                
                openAdminCodeModal() {
                    this.adminCodeInput = '';
                    this.adminCodeError = '';
                    this.selectedRole = '관리자'; // 코드 수정 시에도 역할은 관리자
                    this.showAdminCodeModal = true;
                },

                cancelAdminCode() {
                    this.showAdminCodeModal = false;
                    this.selectedRole = null;
                },

                // (수정됨) 학교 ID 제출 (생성 또는 참여)
                async handleSchoolIdSubmit() {
                    const idPattern = /^[a-zA-Z0-9_]+$/; // 영어, 숫자, 밑줄만 허용
                    if (!this.schoolIdInput || !idPattern.test(this.schoolIdInput)) {
                        this.schoolIdError = 'ID는 영어, 숫자, 밑줄(_)만 사용 가능합니다.';
                        return;
                    }
                    
                    this.isLoading = true;
                    this.schoolIdError = '';
                    this.schoolId = this.schoolIdInput; // schoolId 확정
                    
                    try {
                        // 1. 역할과 ID를 Firestore에 저장
                        await this.saveUserRole(this.selectedRole); 
                        
                        // 2. this.role 확정
                        this.role = this.selectedRole; 
                        
                        // 3. 공용 데이터 로드 (중요: ID 확정 후 실행)
                        await this.loadCommonData();
                        
                        // 4. (필요 시) 개인 데이터 로드
                        await this.loadGuidanceData(); 

                        this.showSchoolIdModal = false;
                        this.selectedRole = null; // 임시 역할 비우기
                        
                    } catch (error) {
                        console.error("Error handling school ID submit:", error);
                        this.schoolIdError = `오류 발생: ${error.message}`;
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                openSchoolIdModal() {
                    this.schoolIdInput = this.schoolId || '';
                    this.schoolIdError = '';
                    this.selectedRole = this.role; // 현재 역할 (관리자)
                    this.showSchoolIdModal = true;
                },

                cancelSchoolId() {
                    this.showSchoolIdModal = false;
                    // 만약 schoolId가 아예 없는 초기 상태였다면 역할 선택으로 되돌림
                    if (!this.schoolId) {
                        this.selectedRole = null;
                    }
                },

                // (수정됨) 역할 재선택
                resetRole() {
                    // 로그아웃 없이 역할만 재선택
                    this.resetAllLocalData(false); // (false = schoolId는 유지)
                    this.role = null;
                    this.selectedRole = null;
                    // showSchoolIdModal 등 모달은 모두 닫힌 상태가 됨
                },
                
                resetAllLocalData(resetSchoolId = false) {
                    if (resetSchoolId) {
                        this.schoolId = null;
                        this.schoolIdInput = '';
                    }
                    this.role = null;
                    this.selectedRole = null;
                    this.curriculumData = [];
                    this.studentData = [];
                    this.emotionalSupportData = [];
                    this.underachieverData = [];
                    this.deployedUnderachievers = [];
                    this.moduleConfig = { A: '', B: '', C: '', D: '', E: '' };
                    this.teacherPlan = { grade: '', subject: '', teacherName: '', planContent: '' };
                    this.supplementaryStudents = [];
                    this.sessionDates = Array(10).fill('');
                    this.totalSessions = 10;
                    this.homeroomFilter = { grade: '', class: '' };
                    // ... (모든 상태 메시지 초기화)
                    this.uploadStatus = { curriculum: '', student: '', emotionalSupport: '', underachiever: '' };
                    this.adminActionStatus = { module: '', deploy: '', form: '' };
                    this.teacherPlanStatus = '';
                    this.teacherPlanError = '';
                    this.attendanceStatus = '';
                },

                // --- Firestore Data Load/Save ---
                
                // (수정됨) Firestore에서 사용자 역할/ID 로드
                async loadUserRole(schoolIdGuess) {
                     if (!this.user || !db) {
                         this.role = null; 
                         this.schoolId = null;
                         return; 
                     };
                     
                     const userDocRef = doc(db, `userData/${this.user.uid}`);
                     
                     try {
                         const userDocSnap = await getDoc(userDocRef);
                         if (userDocSnap.exists()) {
                             const data = userDocSnap.data();
                             this.role = data.role || null;
                             this.schoolId = data.schoolId || null;
                             
                             // Firestore에 schoolId가 없으면, 이메일 기반 추측 사용
                             if (!this.schoolId && schoolIdGuess) {
                                 this.schoolId = schoolIdGuess;
                                 // 추측한 ID를 저장해줌 (다음 로드를 위해)
                                 await this.saveUserRole(this.role); 
                             }
                             
                         } else {
                             // userData 문서가 아예 없음 (최초 로그인)
                             console.log("No userData doc, creating one.");
                             this.role = null;
                             this.schoolId = schoolIdGuess; // 이메일 기반 ID 사용
                             await this.saveUserRole(null); // ID만 저장 (역할은 null)
                         }
                     } catch (error) {
                         console.error("Error loading user role:", error);
                         this.role = null;
                         this.schoolId = null;
                     }
                },
                
                // (수정됨) Firestore에 사용자 역할/ID 저장
                async saveUserRole(roleToSave) {
                    if (!this.user || !db) return;
                    
                    // schoolId가 확정되지 않으면 저장하지 않음 (schoolIdSubmit에서 호출 보장)
                    if (!this.schoolId) {
                        console.error("Cannot save user role, schoolId is missing.");
                        return;
                    }

                    const userDocRef = doc(db, `userData/${this.user.uid}`);
                    try {
                        await setDoc(userDocRef, { 
                            role: roleToSave, // 새 역할 (또는 null)
                            schoolId: this.schoolId, // 확정된 ID
                            email: this.user.email 
                        }, { merge: true });
                        console.log("User role saved:", roleToSave, "School ID:", this.schoolId);
                    } catch (error) {
                        console.error("Error saving user role:", error);
                        if (this.showSchoolIdModal) {
                            this.schoolIdError = `역할 저장 실패: ${error.message}`;
                        }
                    }
                },
                
                // (수정됨) 공용 데이터 로드
                async loadCommonData() {
                    if (!db || !this.schoolId || !this.role) return;
                    console.log(`Loading common data for school: ${this.schoolId}`);
                    this.isLoading = true;
                    try {
                        const commonDataRef = collection(db, `schools/${this.schoolId}/commonData`);
                        
                        const docIds = ['curriculum', 'student', 'emotionalSupport', 'underachiever', 'moduleConfig'];
                        
                        for (const docId of docIds) {
                            const docRef = doc(commonDataRef, docId);
                            const docSnap = await getDoc(docRef);
                            
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (docId === 'curriculum') this.curriculumData = data.data || [];
                                if (docId === 'student') this.studentData = data.data || [];
                                if (docId === 'emotionalSupport') this.emotionalSupportData = data.data || [];
                                if (docId === 'underachiever') this.deployedUnderachievers = data.data || []; // '배포된' 데이터
                                if (docId === 'moduleConfig') this.moduleConfig = data.config || { A: '', B: '', C: '', D: '', E: '' };
                            } else {
                                console.log(`No common data for: ${docId}`);
                                // 기본값 설정 (초기화)
                                if (docId === 'curriculum') this.curriculumData = [];
                                if (docId === 'student') this.studentData = [];
                                if (docId === 'emotionalSupport') this.emotionalSupportData = [];
                                if (docId === 'underachiever') this.deployedUnderachievers = [];
                                if (docId === 'moduleConfig') this.moduleConfig = { A: '', B: '', C: '', D: '', E: '' };
                            }
                        }
                        console.log("Common data loaded.");
                        console.log("Deployed Underachievers:", this.deployedUnderachievers.length);
                    } catch (error) {
                        console.error("Error loading common data:", error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                // --- Admin: 엑셀 양식 다운로드 ---
                downloadTemplate(type) {
                    let data = [];
                    let filename = '';
                    
                    if (type === 'curriculum') {
                        data = [['학년', '과목명'], ['1', '국어'], ['1', '수학']];
                        filename = '교육과정_편제표_양식.xlsx';
                    } else if (type === 'student') {
                        data = [['학년', '반', '번호', '이름', '학번'], ['1', '1', '1', '홍길동', '10101']];
                        filename = '학적_정보_양식.xlsx';
                    } else if (type === 'underachiever') {
                        data = [['학년', '반', '번호', '이름', '학번', '과목명', '미도달 사유'], ['1', '1', '1', '홍길동', '10101', '국어', '읽기 능력 부족']];
                        filename = '미도달_대상자_양식.xlsx';
                    } else if (type === 'emotionalSupport') {
                        data = [['학번', '이름', '이수시간'], ['10101', '홍길동', '10']];
                        filename = '정서지원_이수시간_양식.xlsx';
                    }

                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
                    XLSX.writeFile(wb, filename);
                },

                // --- Admin: 엑셀 파일 업로드 ---
                uploadFile(event, type) {
                    if (this.role !== '관리자' || !db || !this.schoolId) return;
                    
                    const file = event.target.files[0];
                    if (!file) return;

                    const statusKey = type === 'underachiever' ? 'underachiever' : type;
                    this.uploadStatus[statusKey] = '파일 읽는 중...';

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            // 헤더 검증 및 데이터 파싱
                            const headers = jsonData[0];
                            const parsedData = jsonData.slice(1).map(row => {
                                let obj = {};
                                headers.forEach((header, index) => {
                                    obj[header] = row[index];
                                });
                                return obj;
                            });

                            // 데이터 유효성 검사 (간단)
                            if (parsedData.length === 0) throw new Error("파일에 데이터가 없습니다.");
                            if (type === 'curriculum' && (!headers.includes('학년') || !headers.includes('과목명'))) throw new Error("편제표 양식이 올바르지 않습니다. (학년, 과목명 필요)");
                            if (type === 'student' && (!headers.includes('학번') || !headers.includes('이름'))) throw new Error("학적 양식이 올바르지 않습니다. (학번, 이름 필요)");
                            if (type === 'underachiever' && (!headers.includes('학번') || !headers.includes('과목명'))) throw new Error("미도달 양식이 올바르지 않습니다. (학번, 과목명 필요)");
                            if (type === 'emotionalSupport' && (!headers.includes('학번') || !headers.includes('이수시간'))) throw new Error("정서지원 양식이 올바르지 않습니다. (학번, 이수시간 필요)");
                            
                            this.uploadStatus[statusKey] = '데이터베이스에 업로드 중...';

                            if (type === 'underachiever') {
                                // '미도달' 파일은 Firestore에 바로 저장하지 않고, 로컬(underachieverData)에 임시 저장
                                this.underachieverData = parsedData.map(item => ({
                                    grade: String(item.학년 || ''),
                                    class: String(item.반 || ''),
                                    number: String(item.번호 || ''),
                                    name: item.이름 || '',
                                    id: String(item.학번 || ''), // 학번(id)
                                    subjectName: item.과목명 || '',
                                    reasons: [String(item['미도달 사유'] || '')] // 우선 배열로
                                }));
                                this.uploadStatus[statusKey] = `[임시 저장] ${parsedData.length}명의 미도달 데이터를 읽었습니다. '배포' 버튼을 눌러야 적용됩니다.`;
                            } else {
                                // 편제표, 학적, 정서지원은 Firestore에 바로 저장
                                const docRef = doc(db, `schools/${this.schoolId}/commonData`, type);
                                await setDoc(docRef, { data: parsedData });

                                // 로컬 데이터도 업데이트
                                if (type === 'curriculum') this.curriculumData = parsedData;
                                if (type === 'student') this.studentData = parsedData;
                                if (type === 'emotionalSupport') this.emotionalSupportData = parsedData;

                                this.uploadStatus[statusKey] = `${parsedData.length}개 데이터 업로드 완료.`;
                            }

                        } catch (error) {
                            console.error(`Error processing ${type} file:`, error);
                            this.uploadStatus[statusKey] = `파일 처리 오류: ${error.message}`;
                        } finally {
                            event.target.value = null; // 같은 파일 다시 올릴 수 있도록 초기화
                        }
                    };
                    reader.readAsArrayBuffer(file);
                },
                
                // --- Admin: 파일 삭제 ---
                openDeleteModal(type, name) {
                    this.fileToDelete = { type: type, name: name };
                    this.deleteStatus = '';
                    this.showDeleteModal = true;
                },
                closeDeleteModal() {
                    this.showDeleteModal = false;
                    this.fileToDelete = { type: '', name: '' };
                    this.deleteStatus = '';
                },
                async deleteUploadedFile() {
                    if (this.role !== '관리자' || !db || !this.schoolId || !this.fileToDelete.type) return;
                    
                    const type = this.fileToDelete.type;
                    this.deleteStatus = `'${this.fileToDelete.name}' 데이터 삭제 중...`;
                    
                    try {
                        // Delete by setting data to an empty array
                        const docRef = doc(db, `schools/${this.schoolId}/commonData`, type);
                        await setDoc(docRef, { data: [] });

                        if (type === 'curriculum') {
                            this.curriculumData = [];
                            this.uploadStatus.curriculum = '편제표 데이터가 삭제되었습니다.';
                        }
                        if (type === 'student') {
                            this.studentData = [];
                            this.uploadStatus.student = '학적 정보가 삭제되었습니다.';
                        }
                        if (type === 'emotionalSupport') {
                            this.emotionalSupportData = [];
                            this.uploadStatus.emotionalSupport = '정서지원 데이터가 삭제되었습니다.';
                        }
                        // Note: 'underachiever' (배포된 데이터) 삭제는 별도 버튼/로직 필요 시 추가
                        
                        this.deleteStatus = '삭제가 완료되었습니다.';
                        setTimeout(() => this.closeDeleteModal(), 1500);

                    } catch (error) {
                        console.error(`Error deleting ${type} file:`, error);
                        this.deleteStatus = `데이터 삭제 중 오류 발생: ${error.message}`;
                    }
                },


                // --- Admin: 모듈 설정 저장 ---
                async saveModuleConfig() {
                     if (this.role !== '관리자' || !db || !this.schoolId) return;
                     this.adminActionStatus.module = '모듈 설정 저장 중...';
                     try {
                         const docRef = doc(db, `schools/${this.schoolId}/commonData`, 'moduleConfig');
                         await setDoc(docRef, { config: this.moduleConfig });
                         this.adminActionStatus.module = '모듈 설정이 저장되었습니다.';
                     } catch (error) {
                         console.error("Error saving module config:", error);
                         this.adminActionStatus.module = `저장 오류: ${error.message}`;
                     }
                },

                // --- Admin: 미도달 대상자 배포 ---
                async deployUnderachievers() {
                    if (this.role !== '관리자' || !db || !this.schoolId || !this.isUnderachieverDataUploaded) return;
                    
                    this.adminActionStatus.deploy = '미도달 대상자 배포 중...';
                    
                    // (학적 정보와 매핑하여 학년,반,번호,이름 보정)
                    const enrichedData = this.underachieverData
                        .map(ua => {
                            const studentInfo = this.studentData.find(s => s.학번 === ua.id);
                            if (studentInfo) {
                                return {
                                    ...ua,
                                    grade: studentInfo.학년,
                                    class: studentInfo.반,
                                    number: studentInfo.번호,
                                    name: studentInfo.이름
                                };
                            }
                            // 학적부에 없으면 원본 데이터 사용 (이름 등 누락 가능)
                            return ua; 
                        })
                        .reduce((acc, current) => {
                            // 동일 학번, 동일 과목의 사유가 여러 줄일 경우 합치기
                            const existing = acc.find(item => item.id === current.id && item.subjectName === current.subjectName);
                            if (existing) {
                                existing.reasons.push(...current.reasons);
                            } else {
                                acc.push(current);
                            }
                            return acc;
                        }, []);

                    try {
                        const docRef = doc(db, `schools/${this.schoolId}/commonData`, 'underachiever');
                        await setDoc(docRef, { data: enrichedData });
                        
                        this.deployedUnderachievers = enrichedData; // 로컬 데이터 업데이트
                        this.underachieverData = []; // 임시 데이터 비우기
                        this.uploadStatus.underachiever = ''; // 업로드 상태 초기화
                        this.adminActionStatus.deploy = `${enrichedData.length}명의 미도달 대상자 정보가 배포되었습니다.`;
                        
                    } catch (error) {
                        console.error("Error deploying underachievers:", error);
                        this.adminActionStatus.deploy = `배포 오류: ${error.message}`;
                    }
                },
                
                // --- Admin/Homeroom: 가정통신문/서약서 생성 ---
                generateForm(type, studentIds = null) {
                    this.adminActionStatus.form = '양식 생성 중...';
                    
                    let studentsToPrint;
                    if (studentIds) {
                        // 특정 학생 (담임용)
                        studentsToPrint = this.deployedUnderachievers.filter(s => studentIds.includes(s.id));
                    } else {
                        // 전체 학생 (관리자용)
                        studentsToPrint = this.deployedUnderachievers;
                    }
                    
                    if (studentsToPrint.length === 0) {
                        this.adminActionStatus.form = '오류: 대상 학생이 없습니다.';
                        return;
                    }
                    
                    // 학생별로 그룹화 (중복 제거)
                    const studentMap = new Map();
                    studentsToPrint.forEach(s => {
                         const key = s.id;
                         if (!studentMap.has(key)) {
                             studentMap.set(key, {
                                 id: s.id,
                                 grade: s.grade,
                                 class: s.class,
                                 number: s.number,
                                 name: s.name,
                                 subjects: new Map() // 과목별 사유
                             });
                         }
                         const student = studentMap.get(key);
                         if (!student.subjects.has(s.subjectName)) {
                             student.subjects.set(s.subjectName, new Set());
                         }
                         s.reasons.forEach(r => student.subjects.get(s.subjectName).add(r));
                    });
                    
                    // 학생별로 HTML 문서 생성
                    const studentDocs = Array.from(studentMap.values()).map(fullStudent => {
                        const subjectsMap = fullStudent.subjects;
                        let studentTableHtml = '';
                        
                        // (수정됨) rowspan 적용
                         if (subjectsMap.size > 0) {
                             let subjectIndex = 0;
                             const subjectCount = subjectsMap.size;
                             subjectsMap.forEach((reasons, subjectName) => {
                                 if (subjectIndex === 0) {
                                     // 첫 번째 행: 학번과 이름에 rowspan 적용
                                     studentTableHtml += `<tr>
                                         <td rowspan="${subjectCount}" style="vertical-align: top;">${fullStudent.id}</td>
                                         <td rowspan="${subjectCount}" style="vertical-align: top;">${fullStudent.name}</td>
                                         <td style="text-align: left; padding: 5px 8px;">${subjectName}</td>
                                         <td style="text-align: left; padding: 5px 8px;">${Array.from(reasons).join(' & ')}</td>
                                     </tr>`;
                                 } else {
                                     // 두 번째 행부터: 과목과 내역만
                                     studentTableHtml += `<tr>
                                         <td style="text-align: left; padding: 5px 8px;">${subjectName}</td>
                                         <td style="text-align: left; padding: 5px 8px;">${Array.from(reasons).join(' & ')}</td>
                                     </tr>`;
                                 }
                                 subjectIndex++;
                             });
                         } else {
                             studentTableHtml = `<tr>
                                 <td>${fullStudent.id}</td><td>${fullStudent.name}</td>
                                 <td colspan="2" style="text-align: center;">(미도달 내역 없음)</td>
                             </tr>`;
                         }
                        
                        // 양식 반환
                        if (type === 'notification') {
                            return this.getNotificationHtml(fullStudent, studentTableHtml);
                        } else {
                            return this.getPledgeHtml(fullStudent, studentTableHtml);
                        }
                    });

                    // 모든 학생 문서를 페이지 나누기로 연결
                    const allPreviewsHtml = studentDocs.map((doc) => {
                        return `<div class="page-break">${doc}</div>`;
                    }).join('');

                    this.previewHtml = allPreviewsHtml;
                    this.showPreviewModal = true;
                    this.adminActionStatus.form = '';
                },

                // --- Teacher Plan (교과교사) ---
                updateSubjects() {
                    this.teacherPlan.subject = ''; // 학년 변경 시 과목 초기화
                    this.teacherPlan.planContent = ''; // 내용 초기화
                    this.teacherPlanStatus = '';
                },
                async loadTeacherPlan() {
                    if (!this.teacherPlan.subject || !this.user || !db || !this.schoolId) return;
                    
                    this.teacherPlanStatus = '계획안 불러오는 중...';
                    try {
                        const docId = `${this.teacherPlan.grade}_${this.teacherPlan.subject}`;
                        const docRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}/plans`, docId);
                        const docSnap = await getDoc(docRef);
                        
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            this.teacherPlan.teacherName = data.teacherName || this.user.displayName || '';
                            this.teacherPlan.planContent = data.planContent || '';
                            this.teacherPlanStatus = '계획안을 불러왔습니다.';
                        } else {
                            this.teacherPlan.teacherName = this.user.displayName || '';
                            this.teacherPlan.planContent = '';
                            this.teacherPlanStatus = '새 계획안입니다.';
                        }
                    } catch (error) {
                        console.error("Error loading teacher plan:", error);
                        this.teacherPlanError = `불러오기 오류: ${error.message}`;
                    }
                },
                async saveTeacherPlan() {
                    if (!this.teacherPlan.subject || !this.user || !db || !this.schoolId) {
                        this.teacherPlanError = '학년, 과목을 모두 선택해야 저장할 수 있습니다.';
                        return;
                    }
                    this.teacherPlanStatus = '계획안 저장 중...';
                    this.teacherPlanError = '';
                    
                    try {
                        const docId = `${this.teacherPlan.grade}_${this.teacherPlan.subject}`;
                        const docRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}/plans`, docId);
                        
                        await setDoc(docRef, {
                            grade: this.teacherPlan.grade,
                            subject: this.teacherPlan.subject,
                            teacherName: this.teacherPlan.teacherName,
                            planContent: this.teacherPlan.planContent,
                            lastUpdated: new Date().toISOString()
                        });
                        
                        this.teacherPlanStatus = '계획안이 저장되었습니다.';
                    } catch (error) {
                         console.error("Error saving teacher plan:", error);
                        this.teacherPlanError = `저장 오류: ${error.message}`;
                    }
                },
                generatePlanPreview() {
                    this.previewHtml = this.getTeacherPlanPreviewHtml(this.teacherPlan);
                    this.showPreviewModal = true;
                },

                // --- Attendance (출결부) ---
                async loadGuidanceData() {
                    if (!this.user || !db || !this.schoolId) return;
                    
                    this.attendanceStatus = '출결 데이터 로드 중...';
                    try {
                        const docRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}/guidance`, 'main');
                        const docSnap = await getDoc(docRef);
                        
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            this.supplementaryStudents = data.students || [];
                            this.sessionDates = data.sessionDates || Array(this.totalSessions).fill('');
                            // totalSessions는 watch 핸들러가 자동으로 업데이트함
                        } else {
                            this.supplementaryStudents = [];
                            this.sessionDates = Array(this.totalSessions).fill('');
                        }
                        this.attendanceStatus = '출결 데이터 로드 완료.';
                    } catch (error) {
                        console.error("Error loading guidance data:", error);
                        this.attendanceStatus = `로드 오류: ${error.message}`;
                    }
                },
                async saveGuidanceData() {
                    if (!this.user || !db || !this.schoolId) return;
                    
                    this.attendanceStatus = '변경 사항 저장 중...';
                    try {
                        const docRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}/guidance`, 'main');
                        
                        // 차시 자동 확장 (O, X, / 입력 시)
                        let maxSessionNeeded = this.totalSessions;
                        this.supplementaryStudents.forEach(s => {
                            // 마지막 차시가 비어있지 않으면 5칸 추가
                            if(s.attendance.length > 0 && s.attendance[s.attendance.length - 1] !== '') {
                                maxSessionNeeded = s.attendance.length + 5;
                            }
                        });
                        if (maxSessionNeeded > this.totalSessions) {
                            this.totalSessions = maxSessionNeeded; // watch가 배열 확장을 처리
                        }
                        
                        await setDoc(docRef, {
                            students: this.supplementaryStudents,
                            sessionDates: this.sessionDates.slice(0, this.totalSessions) // 현재 차시까지만 저장
                        });
                        this.attendanceStatus = '변경 사항이 저장되었습니다.';
                    } catch (error) {
                        console.error("Error saving guidance data:", error);
                        this.attendanceStatus = `저장 오류: ${error.message}`;
                    }
                },
                openAttendanceModal() {
                    this.selectedStudents = [];
                    this.attendanceModalStatus = '';
                    this.showAttendanceModal = true;
                },
                closeAttendanceModal() {
                    this.showAttendanceModal = false;
                },
                toggleSelectAllStudents(event) {
                    if (event.target.checked) {
                        this.selectedStudents = [...this.availableUnderachievers];
                    } else {
                        this.selectedStudents = [];
                    }
                },
                addStudentsToAttendance() {
                    if (this.selectedStudents.length === 0) {
                        this.attendanceModalStatus = '추가할 학생을 선택하세요.';
                        return;
                    }
                    
                    const newStudents = this.selectedStudents.map(s => ({
                        id: s.id,
                        grade: s.grade,
                        class: s.class,
                        number: s.number,
                        name: s.name,
                        subject: s.subjectName,
                        module: '',
                        teacher: this.user.displayName || '',
                        startDate: '',
                        endDate: '',
                        attendance: Array(this.totalSessions).fill(''),
                        isCompleted: false
                    }));
                    
                    this.supplementaryStudents = [...this.supplementaryStudents, ...newStudents];
                    this.attendanceModalStatus = `${newStudents.length}명의 학생을 추가했습니다.`;
                    
                    // 저장
                    this.saveGuidanceData();
                    
                    setTimeout(() => {
                        this.closeAttendanceModal();
                    }, 1000);
                },
                // 출결 이력 가져오기 (모달)
                importAttendance() {
                    this.importStatus = '';
                    this.showImportModal = true;
                },
                closeImportModal() {
                    this.showImportModal = false;
                    this.importStatus = '';
                },
                handleAttendanceImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    this.importStatus = '파일 읽는 중...';
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                         try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            // 1. 학생 시트 (students)
                            const studentSheet = workbook.Sheets['students'];
                            if (!studentSheet) throw new Error("엑셀 파일에 'students' 시트가 없습니다.");
                            const studentsData = XLSX.utils.sheet_to_json(studentSheet);
                            
                            // 2. 날짜 시트 (sessionDates)
                            const dateSheet = workbook.Sheets['sessionDates'];
                            if (!dateSheet) throw new Error("엑셀 파일에 'sessionDates' 시트가 없습니다.");
                            const dateData = XLSX.utils.sheet_to_json(dateSheet, { header: 1 });
                            const newSessionDates = dateData.length > 0 ? (dateData[0] || []) : [];

                            // 유효성 검사
                            if (studentsData.length === 0) throw new Error("'students' 시트에 데이터가 없습니다.");

                            // 현재 데이터와 병합 (학번+과목 기준)
                            const studentMap = new Map(this.supplementaryStudents.map(s => [s.id + s.subject, s]));
                            
                            studentsData.forEach(importedStudent => {
                                const key = importedStudent.id + importedStudent.subject;
                                // 엑셀에서 attendance는 JSON 문자열로 저장되어 있어야 함
                                let importedAttendance = [];
                                try {
                                    importedAttendance = JSON.parse(importedStudent.attendance);
                                    if (!Array.isArray(importedAttendance)) importedAttendance = [];
                                } catch (e) { importedAttendance = []; }
                                
                                const existing = studentMap.get(key);
                                if (existing) {
                                    // 기존 학생 업데이트 (엑셀 데이터 우선)
                                    Object.assign(existing, importedStudent);
                                    existing.attendance = importedAttendance;
                                } else {
                                    // 새 학생 추가
                                    importedStudent.attendance = importedAttendance;
                                    studentMap.set(key, importedStudent);
                                }
                            });
                            
                            this.supplementaryStudents = Array.from(studentMap.values());
                            this.sessionDates = newSessionDates;
                            this.totalSessions = newSessionDates.length > 10 ? newSessionDates.length : 10;
                            
                            // Firestore에 즉시 저장
                            await this.saveGuidanceData();
                            this.importStatus = `${studentsData.length}개의 출결 이력을 가져왔습니다.`;

                         } catch (error) {
                             console.error("Error importing attendance:", error);
                             this.importStatus = `가져오기 오류: ${error.message}`;
                         } finally {
                             event.target.value = null;
                         }
                    };
                    reader.readAsArrayBuffer(file);
                },


                // --- Homeroom (담임) ---
                updateClasses() {
                    this.homeroomFilter.class = '';
                    // this.homeroomStudents = []; // computed가 자동으로 처리
                },
                filterHomeroomStudents() {
                    // computed가 자동으로 처리
                    if (this.homeroomStudents.length === 0 && this.homeroomFilter.class) {
                        console.log("No students found for this homeroom.");
                    }
                },

                // --- Preview Modal ---
                closePreviewModal() {
                    this.showPreviewModal = false;
                    this.previewHtml = '';
                    this.adminActionStatus.form = '';
                    this.teacherPlanError = '';
                    this.teacherPlanStatus = '';
                },
                printPreviewModalContent() {
                    // Native browser print
                    window.print();
                },

                // --- HTML Template Getters ---
                getNotificationHtml(student, tableHtml) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = today.getMonth() + 1;
                    const day = today.getDate();
                    
                    return `
                        <div style="width: 210mm; min-height: 297mm; padding: 20mm; box-sizing: border-box; font-family: 'Malgun Gothic', sans-serif; line-height: 1.8; color: #000;">
                            <h1 style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 30px;">
                                최소 성취수준 보장지도 대상자 선정 안내
                            </h1>
                            <p style="text-align: right; margin-bottom: 20px;">${student.grade}학년 ${student.class}반 ${student.number}번</p>
                            <p style="margin-bottom: 20px;">
                                학부모님께,<br>
                                귀 자녀 <strong>${student.name}</strong> 학생은 본교에서 실시한 ${year}학년도 1학기(또는 2학기) 성취도 평가 결과,
                                일부 교과에서 최소 성취수준에 도달하지 못한 것으로 확인되어, 「초·중등교육법 시행령」 제54조의2 및
                                본교 학업성적관리규정에 따라 최소 성취수준 보장지도 대상자로 선정되었음을 안내드립니다.
                            </p>

                            <h2 style="font-size: 18px; font-weight: bold; margin-top: 30px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
                                1. 최소 성취수준 보장지도 대상자 확인표
                            </h2>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; text-align: center;">
                                <thead style="background-color: #f4f4f4;">
                                    <tr>
                                        <th style="border: 1px solid #000; padding: 8px;">학번</th>
                                        <th style="border: 1px solid #000; padding: 8px;">이름</th>
                                        <th style="border: 1px solid #000; padding: 8px;">미도달 과목</th>
                                        <th style="border: 1px solid #000; padding: 8px;">미도달 내역</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableHtml}
                                </tbody>
                            </table>

                            <h2 style="font-size: 18px; font-weight: bold; margin-top: 30px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
                                2. 지도 계획
                            </h2>
                            <p style="margin-bottom: 20px;">
                                이에 따라 본교에서는 해당 학생의 학습 결손을 보충하고 성취수준 도달을 지원하기 위해 다음과 같은
                                보장지도 프로그램을 운영하고자 합니다. 학부모님의 적극적인 관심과 협조를 부탁드립니다.
                            </p>
                            <ul style="list-style-type: disc; margin-left: 20px; margin-bottom: 20px;">
                                <li><strong>지도 기간:</strong> ${year}년 (2학기) (예: 2025.09.01. ~ 2025.12.31.)</li>
                                <li><strong>지도 방법:</strong> 교과 내 지도(모듈A), 교과 연계 지도(모듈B), 정서지원(모듈D) 등 학생 맞춤형 지도</li>
                                <li><strong>지도 내용:</strong> 과목별 핵심 개념 이해, 기본 문제 해결력 신장, 학습 동기 부여 등</li>
                            </ul>
                            
                            <p style="margin-bottom: 40px;">
                                ※ 자세한 사항은 담임교사 또는 교과 담당 교사에게 문의 바랍니다.
                            </p>

                            <p style="text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 40px;">
                                ${year}년 ${month}월 ${day}일
                            </p>
                            
                            <p style="text-align: center; font-size: 20px; font-weight: bold;">
                                [ 학교장 직인 ]
                            </p>
                        </div>
                    `;
                },
                getPledgeHtml(student, tableHtml) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = today.getMonth() + 1;
                    const day = today.getDate();

                    return `
                        <div style="width: 210mm; min-height: 297mm; padding: 20mm; box-sizing: border-box; font-family: 'Malgun Gothic', sans-serif; line-height: 1.8; color: #000;">
                            <h1 style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 40px;">
                                최소 성취수준 보장지도 참여 서약서
                            </h1>
                            
                            <h2 style="font-size: 18px; font-weight: bold; margin-top: 30px; margin-bottom: 10px;">
                                1. 지도 대상 확인
                            </h2>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 14px; text-align: center;">
                                <thead style="background-color: #f4f4f4;">
                                    <tr>
                                        <th style="border: 1px solid #000; padding: 8px;">학번</th>
                                        <th style="border: 1px solid #000; padding: 8px;">이름</th>
                                        <th style="border: 1px solid #000; padding: 8px;">미도달 과목</th>
                                        <th style="border: 1px solid #000; padding: 8px;">미도달 내역</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableHtml}
                                </tbody>
                            </table>
                            
                            <h2 style="font-size: 18px; font-weight: bold; margin-top: 30px; margin-bottom: 10px;">
                                2. 서약 내용
                            </h2>
                            <p style="margin-bottom: 20px;">
                                본인(학생)과 학부모는 위 학생이 최소 성취수준 보장지도 대상자로 선정되었음을 확인하며,
                                학교에서 제공하는 보충지도 프로그램(교과 내 지도, 교과 연계 지도, 정서지원 프로그램 등)에
                                성실히 참여하여 학습 결손을 보충하고 성취수준에 도달할 수 있도록 노력할 것을 서약합니다.
                            </p>
                            
                            <p style="margin-bottom: 50px;">
                                또한, 프로그램 운영 기간 동안 학교의 지도 및 안내 사항을 준수하며,
                                프로그램 이수에 필요한 과제 및 활동에 적극적으로 임하겠습니다.
                            </p>

                            <p style="text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 40px;">
                                ${year}년 ${month}월 ${day}일
                            </p>
                            
                            <div style="display: flex; justify-content: space-around; width: 80%; margin: 0 auto; text-align: center;">
                                <div style="width: 45%;">
                                    <p style="font-size: 16px; margin-bottom: 10px;">학 생</p>
                                    <p style="font-size: 16px; margin-bottom: 40px;">성명: _______________ (인)</p>
                                </div>
                                <div style="width: 45%;">
                                    <p style="font-size: 16px; margin-bottom: 10px;">학부모</p>
                                    <p style="font-size: 16px; margin-bottom: 40px;">성명: _______________ (인)</p>
                                </div>
                            </div>
                            
                            <p style="text-align: center; font-size: 20px; font-weight: bold; margin-top: 30px;">
                                [ 학교장 ] 귀하
                            </p>
                        </div>
                    `;
                },
                getTeacherPlanPreviewHtml(plan) {
                    const today = new Date();
                    const year = today.getFullYear();
                    
                    // planContent를 HTML <pre> 태그로 감싸서 줄바꿈 유지
                    const planContentHtml = `<pre style="font-family: 'Malgun Gothic', sans-serif; white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; padding: 10px; border: 1px solid #eee; background: #fdfdfd; min-height: 400px;">${plan.planContent || '(계획안 내용이 없습니다.)'}</pre>`;

                    return `
                        <div style="width: 210mm; min-height: 297mm; padding: 15mm; box-sizing: border-box; font-family: 'Malgun Gothic', sans-serif; line-height: 1.8; color: #000;">
                            <h1 style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 30px;">
                                ${year}학년도 최소 성취수준 보장지도 계획안
                            </h1>
                            
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 14px; text-align: center;">
                                <tbody>
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 10px; background-color: #f4f4f4; font-weight: bold; width: 20%;">학년</td>
                                        <td style="border: 1px solid #000; padding: 10px; text-align: left; width: 30%;">${plan.grade || 'N/A'} 학년</td>
                                        <td style="border: 1px solid #000; padding: 10px; background-color: #f4f4f4; font-weight: bold; width: 20%;">과목</td>
                                        <td style="border: 1px solid #000; padding: 10px; text-align: left; width: 30%;">${plan.subject || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 10px; background-color: #f4f4f4; font-weight: bold;">담당교사</td>
                                        <td style="border: 1px solid #000; padding: 10px; text-align: left;" colspan="3">${plan.teacherName || 'N/A'}</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h2 style="font-size: 18px; font-weight: bold; margin-top: 30px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
                                지도 계획
                            </h2>
                            
                            ${planContentHtml}

                            <div style="position: absolute; bottom: 20mm; width: calc(100% - 40mm); text-align: center;">
                                <p style="text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 40px;">
                                    ${year}년 ${today.getMonth() + 1}월 ${today.getDate()}일
                                </p>
                                <p style="text-align: right; font-size: 16px; margin-right: 50px;">
                                    작성자: ${plan.teacherName || '_______________'} (인)
                                </p>
                            </div>
                        </div>
                    `;
                }

            },
            
            mounted() {
                // 앱 마운트 시 초기화 함수 실행
                this.initApp();
            }
        }).mount('#app');

    </script>
</body>
</html>

