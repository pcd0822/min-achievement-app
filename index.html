<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>최소 성취수준 보장지도 관리 웹 앱</title>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        // 모듈 import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithRedirect, 
            signInWithPopup,
            getRedirectResult, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            writeBatch,
            deleteDoc,
            onSnapshot,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        
        // 전역 변수 (Canvas 환경)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 전역 Firebase 인스턴스
        let app, auth, db, storage;

        // Flatpickr (Date Picker)
        const flatpickrScript = document.createElement('script');
        flatpickrScript.src = "https://cdn.jsdelivr.net/npm/flatpickr";
        document.head.appendChild(flatpickrScript);

        const flatpickrStyle = document.createElement('link');
        flatpickrStyle.rel = "stylesheet";
        flatpickrStyle.href = "https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css";
        document.head.appendChild(flatpickrStyle);
        
        // SheetJS (XLSX)
        const sheetJsScript = document.createElement('script');
        sheetJsScript.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
        document.head.appendChild(sheetJsScript);

        // html2canvas
        const html2canvasScript = document.createElement('script');
        html2canvasScript.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
        document.head.appendChild(html2canvasScript);

    </script>
    <style>
        /* 기본 스타일 */
        body {
            font-family: 'Inter', 'Pretendard', sans-serif;
            background-color: #f4f7f6;
        }
        /* 스크롤바 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        /* 로딩 스피너 */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* 모달 공통 스타일 */
        .modal-overlay {
            position: fixed; z-index: 50;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 50rem; /* 800px */
            max-height: 90vh;
            overflow-y: auto;
        }
        /* 탭 버튼 스타일 */
        .tab-button {
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            color: #4B5563; /* gray-600 */
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            color: #3B82F6; /* blue-500 */
            border-bottom-color: #3B82F6;
        }
        .tab-button:hover:not(.active) {
            background-color: #F3F4F6; /* gray-100 */
        }
        /* 테이블 스타일 */
        table { width: 100%; border-collapse: collapse; }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: center;
            vertical-align: middle;
        }
        thead th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        tbody tr:nth-child(even) { background-color: #f9fafb; }
        /* 입력 필드 */
        input[type="text"], input[type="password"], input[type="date"], select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        /* 스크롤 버튼 */
        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .scroll-arrow.left { left: -1.25rem; }
        .scroll-arrow.right { right: -1.25rem; }

        /* 인쇄 전용 스타일 */
        @media print {
            /* 1. 기본 인쇄 설정 */
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                margin: 0;
                padding: 0;
                background-color: #fff;
            }
            
            /* 2. 인쇄 불필요 UI 요소 명시적 숨기기 */
            /* 3) FIX: 'body >'를 '#app >'로 수정하여 앱의 헤더와 메인을 숨깁니다. */
            #app > header, 
            #app > main,
            div[v-if="showAttendanceModal"],
            /* div[v-if="showImportModal"], (제거됨) */
            div[v-if="showSchoolIdModal"], /* 학교 ID 모달 숨기기 */
            div[v-if="showAdminCodeModal"], /* 관리자 코드 모달 숨기기 */
            div[v-if="showAdminCodeEditModal"], /* 관리자 코드 수정 모달 숨기기 */
            #print-area-container, /* html2canvas용 컨테이너 숨기기 */
            .modal-overlay .modal-content > div:not(#print-area-container-in-modal), /* 모달 내 버튼, 상태메시지 숨기기 */
            .scroll-arrow {
                display: none !important;
            }

            /* 3. 모달창 인쇄 영역 설정 */
            .modal-overlay {
                position: static !important;
                background-color: #fff !important;
            }
            .modal-content {
                width: 100% !important;
                max-width: 100% !important;
                max-height: none !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
            }
            
            /* 4. 인쇄할 모달 내용만 보이도록 설정 */
            #print-area-container-in-modal {
                visibility: visible !important;
                display: block !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
            }
            /* 5. 인쇄 시 내부 레이OUT 유지 */
            #print-area-container-in-modal * {
                 visibility: visible !important;
                 /* display: block !important; <-- 이 규칙은 내부 flex/grid 레이아웃을 깨트리므로 제거 */
            }
            
            /* 6. 페이지 나누기 */
            .page-break:not(:last-child) { 
                page-break-after: always !important; 
            }
            
            /* 7. 인쇄 시 테이블 스타일 보정 */
            table { 
                width: 100% !important;
                border-collapse: collapse !important; 
            }
            th, td { 
                border: 1px solid #333 !important; 
                padding: 6px 8px !important;
                color: #000 !important;
                background-color: #fff !important;
            }
            thead th {
                background-color: #eee !important;
            }
            /* 8. 인쇄 시 텍스트 스타일 보정 */
            h1, h2, h3, h4, p, span, div, td, th {
                color: #000 !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- 1. 헤더 -->
        <header class="bg-white shadow-md z-30">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13.5M8.25 6.253l7.5 13.5M15.75 6.253l-7.5 13.5"></path></svg>
                    <h1 class="text-2xl font-bold text-gray-800">최소 성취수준 보장지도 관리</h1>
                </div>
                <div class="flex items-center">
                    <div v-if="isLoggedIn && role" class="mr-4 text-sm">
                        <span class="font-semibold text-gray-700">{{ user.displayName || '사용자' }}</span>님
                        <span class="mx-1.5 text-gray-300">|</span>
                        <span class="font-bold" :class="role === '관리자' ? 'text-red-500' : 'text-blue-500'">{{ role }}</span>
                        <span class="mx-1.5 text-gray-300">|</span>
                        <span class="text-gray-600 font-mono text-xs bg-gray-100 px-2 py-1 rounded">{{ schoolId }}</span>
                         <button v-if="role" @click="resetRole" class="ml-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition text-sm">역할 재선택</button>
                         <button v-if="role === '관리자'" @click="openSchoolIdModal" class="ml-2 px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition text-sm">학교 ID 수정</button>
                         <!-- (수정) 관리자 코드 수정 버튼 추가 -->
                         <button v-if="role === '관리자'" @click="openAdminCodeEditModal" class="ml-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition text-sm">코드 수정</button>
                    </div>
                    <button v-if="isLoggedIn" @click="logout" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition text-sm">로그아웃</button>
                    <!-- (수정) 로그인 버튼 로직 (v-else) -->
                    <button v-else @click="login" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">Google 로그인</button>
                </div>
            </div>
        </header>

        <!-- 2. 메인 콘텐츠 -->
        <main class="flex-grow container mx-auto px-6 py-8">
            <!-- 로딩 스피너 -->
            <div v-if="isLoading" class="flex justify-center items-center h-64">
                <div class="loader w-12 h-12 border-4 border-gray-200 rounded-full"></div>
            </div>

            <!-- 역할 선택 (로그인O, 역할X, 로딩X) -->
            <div v-if="isLoggedIn && !role && !isLoading && !showSchoolIdModal && !showAdminCodeModal" class="bg-white p-8 rounded-lg shadow-xl max-w-lg mx-auto text-center">
                <h2 class="text-2xl font-bold mb-6">역할 선택</h2>
                <p class="mb-8 text-gray-600">이 앱에서 사용할 역할을 선택하세요.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button @click="selectRole('교과교사')" class="p-6 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition">교과교사</button>
                    <button @click="selectRole('담임교사')" class="p-6 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition">담임교사</button>
                    <button @click="selectRole('관리자')" class="p-6 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">관리자</button>
                </div>
                <p v-if="roleSelectionError" class="mt-4 text-red-500 font-semibold">{{ roleSelectionError }}</p>
            </div>

            <!-- 대시보드 (로그인O, 역할O, 로딩X) -->
            <div v-if="isLoggedIn && role && !isLoading && !showSchoolIdModal && !showAdminCodeModal">
                
                <!-- 탭 네비게이션 (관리자/교과교사/담임교사 공통) -->
                <div class="mb-6 bg-white rounded-lg shadow-sm">
                    <nav class="flex border-b border-gray-200">
                        <button v-if="role === '관리자'" @click="currentTab = 'adminDashboard'" 
                                :class="{'active': currentTab === 'adminDashboard'}" class="tab-button">
                            관리자 대시보드
                        </button>
                        <button v-if="role === '관리자' || role === '교과교사'" @click="currentTab = 'teacherPlan'" 
                                :class="{'active': currentTab === 'teacherPlan'}" class="tab-button">
                            지도 계획안 (교과)
                        </button>
                        <button v-if="role === '관리자' || role === '교과교사' || role === '담임교사'" @click="currentTab = 'attendanceBook'" 
                                :class="{'active': currentTab === 'attendanceBook'}" class="tab-button">
                            출결 및 이수 (보충지도)
                        </button>
                        <button v-if="role === '관리자' || role === '담임교사'" @click="currentTab = 'counselingSupport'" 
                                :class="{'active': currentTab === 'counselingSupport'}" class="tab-button">
                            상담 및 정서지원 (담임)
                        </button>
                        <button v-if="role === '관리자' || role === '담임교사' || role === '교과교사'" @click="currentTab = 'printForms'" 
                                :class="{'active': currentTab === 'printForms'}" class="tab-button">
                            가정통신문 및 서약서
                        </button>
                    </nav>
                </div>

                <!-- 탭 콘텐츠 -->
                <div>
                    <!-- 1. 관리자 대시보드 -->
                    <div v-if="currentTab === 'adminDashboard' && role === '관리자'" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- 1.1 교육과정 편제표 -->
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h3 class="text-xl font-bold mb-4 border-b pb-2">1. 교육과정 편제표</h3>
                                <p class="text-sm text-gray-600 mb-4">
                                    Excel 파일을 업로드하세요. (시트명: '편제표')<br>
                                    필수 열: '학년', '과목', '교사'
                                </p>
                                <input type="file" @change="e => handleFileUpload(e, 'curriculum')" class="mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <button @click="uploadFile('curriculum')" :disabled="!files.curriculum" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 transition">편제표 업로드</button>
                                <!-- 파일 삭제 버튼 -->
                                <button @click="openDeleteModal('curriculum')" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 mt-2 transition">편제표 삭제</button>
                                
                                <p v-if="uploadStatus.curriculum" class="mt-3 text-sm font-semibold" :class="uploadStatus.curriculum.includes('성공') ? 'text-green-600' : 'text-red-600'">{{ uploadStatus.curriculum }}</p>
                            </div>
                            <!-- 1.2 학적 정보 -->
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h3 class="text-xl font-bold mb-4 border-b pb-2">2. 학적 정보</h3>
                                <p class="text-sm text-gray-600 mb-4">
                                    Excel 파일을 업로드하세요. (시트명: '학적')<br>
                                    필수 열: '학년', '반', '번호', '이름', '학생ID'
                                </p>
                                <input type="file" @change="e => handleFileUpload(e, 'students')" class="mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                <button @click="uploadFile('students')" :disabled="!files.students" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 transition">학적 업로드</button>
                                <!-- 파일 삭제 버튼 -->
                                <button @click="openDeleteModal('students')" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 mt-2 transition">학적 삭제</button>
                                
                                <p v-if="uploadStatus.students" class="mt-3 text-sm font-semibold" :class="uploadStatus.students.includes('성공') ? 'text-green-600' : 'text-red-600'">{{ uploadStatus.students }}</p>
                            </div>
                            <!-- 1.3 정서지원 프로그램 -->
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h3 class="text-xl font-bold mb-4 border-b pb-2">3. 정서지원 프로그램</h3>
                                <p class="text-sm text-gray-600 mb-4">
                                    Excel 파일을 업로드하세요. (시트명: '프로그램')<br>
                                    필수 열: '구분', '프로그램명', '담당자/기관'
                                </p>
                                <input type="file" @change="e => handleFileUpload(e, 'supportPrograms')" class="mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                                <button @click="uploadFile('supportPrograms')" :disabled="!files.supportPrograms" class="w-full px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 disabled:bg-gray-400 transition">프로그램 업로드</button>
                                <!-- 파일 삭제 버튼 -->
                                <button @click="openDeleteModal('supportPrograms')" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 mt-2 transition">프로그램 삭제</button>
                                
                                <p v-if="uploadStatus.supportPrograms" class="mt-3 text-sm font-semibold" :class="uploadStatus.supportPrograms.includes('성공') ? 'text-green-600' : 'text-red-600'">{{ uploadStatus.supportPrograms }}</p>
                            </div>
                        </div>

                        <!-- 1.4 성적 정보 및 미도달 대상자 -->
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4 border-b pb-2">4. 성적 정보 및 미도달 대상자 배포</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-sm text-gray-600 mb-4">
                                        성적 파일(Excel)을 업로드하세요. (시트명: '성적')<br>
                                        필수 열: '학생ID', '과목', '성취도'
                                    </p>
                                    <input type="file" @change="e => handleFileUpload(e, 'grades')" class="mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                                    <button @click="processGrades" :disabled="!files.grades" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:bg-gray-400 transition">성적 처리 및 대상자 추출</button>
                                    <p v-if="uploadStatus.grades" class="mt-3 text-sm font-semibold" :class="uploadStatus.grades.includes('추출') ? 'text-green-600' : 'text-red-600'">{{ uploadStatus.grades }}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 mb-2">미도달 대상자: {{ underachievers.length }}명</p>
                                    <p class="text-sm text-gray-600 mb-4">미도달 사유(선택): 'I'(미인정결), 'F'(미취득)</p>
                                    <div class="max-h-60 overflow-y-auto border rounded-md p-2 bg-gray-50 mb-4">
                                        <ul>
                                            <li v-for="student in underachievers" :key="student.id" class="text-sm py-1 border-b">
                                                {{ student.grade }}-{{ student.class }}-{{ student.number }} {{ student.name }} ({{ student.subject }})
                                                <div class="flex space-x-2 justify-end -mt-5">
                                                     <select v-model="student.reason" class="text-xs p-1 w-28 rounded border">
                                                        <option value="">사유 선택</option>
                                                        <option value="I">I (미인정결)</option>
                                                        <option value="F">F (미취득)</option>
                                                        <option value="기타">기타</option>
                                                    </select>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                    <button @click="deployUnderachievers" :disabled="underachievers.length === 0" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-400 transition">미도달 대상자 배포</button>
                                    <p v-if="uploadStatus.deployment" class="mt-3 text-sm font-semibold" :class="uploadStatus.deployment.includes('성공') ? 'text-green-600' : 'text-red-600'">{{ uploadStatus.deployment }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- 1.5 양식 관리 (가정통신문, 서약서) -->
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4 border-b pb-2">5. 가정통신문 및 서약서 양식</h3>
                            <p class="text-sm text-gray-600 mb-4">
                                학교에서 사용할 양식을 등록하세요. HTML 형식의 텍스트를 붙여넣거나, 파일을 업로드하세요.
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- 가정통신문 양식 -->
                                <div>
                                    <label class="block text-md font-semibold mb-2 text-gray-700">가정통신문 양식 (HTML)</label>
                                    <textarea v-model="formTemplates.notification.content" rows="10" class="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="<h1 style='color: blue;'>가정통신문</h1>..."></textarea>
                                    <input type="file" @change="e => handleFormTemplateUpload(e, 'notification')" class="mt-2 mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                    <button @click="saveFormTemplate('notification')" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-gray-400 transition">통신문 양식 저장</button>
                                </div>
                                <!-- 서약서 양식 -->
                                <div>
                                    <label class="block text-md font-semibold mb-2 text-gray-700">서약서 양식 (HTML)</label>
                                    <textarea v-model="formTemplates.pledge.content" rows="10" class="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="<h1 style='text-align: center;'>서 약 서</h1>..."></textarea>
                                    <input type="file" @change="e => handleFormTemplateUpload(e, 'pledge')" class="mt-2 mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100">
                                    <button @click="saveFormTemplate('pledge')" class="w-full px-4 py-2 bg-pink-600 text-white rounded-md hover:bg-pink-700 disabled:bg-gray-400 transition">서약서 양식 저장</button>
                                </div>
                            </div>
                            <p v-if="adminActionStatus" class="mt-4 text-center text-sm font-semibold" :class="adminActionStatus.includes('성공') ? 'text-green-600' : 'text-red-600'">{{ adminActionStatus }}</p>
                            <button @click="previewFormAdmin('notification')" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition">가정통신문 미리보기</button>
                            <button @click="previewFormAdmin('pledge')" class="mt-4 ml-2 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition">서약서 미리보기</button>
                        </div>
                    </div>

                    <!-- 2. 지도 계획안 (교과교사) -->
                    <div v-if="currentTab === 'teacherPlan' && (role === '관리자' || role === '교과교사')" class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold mb-6 border-b pb-3">지도 계획안 (교과)</h3>
                        <!-- 과목 선택 -->
                        <div class="mb-6 max-w-sm">
                            <label for="teacherSubjectSelect" class="block text-md font-semibold mb-2 text-gray-700">지도 과목 선택</label>
                            <select id="teacherSubjectSelect" v-model="currentTeacherPlan.subject" @change="loadTeacherPlan" class="w-full p-2 border rounded-md">
                                <option value="">과목을 선택하세요</option>
                                <option v-for="subject in teacherSubjects" :key="subject" :value="subject">{{ subject }}</option>
                            </select>
                        </div>

                        <div v-if="currentTeacherPlan.subject" class="space-y-4">
                            <!-- 계획안 폼 -->
                            <div>
                                <label class="block text-md font-semibold mb-2 text-gray-700">지도 기간</label>
                                <input type="text" id="teacherPlanDateRange" class="w-full p-2 border rounded-md" placeholder="기간 선택">
                            </div>
                            <div>
                                <label class="block text-md font-semibold mb-2 text-gray-700">지도 교사</label>
                                <input type="text" :value="user ? user.displayName : ''" readonly class="w-full p-2 border rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-md font-semibold mb-2 text-gray-700">지도 대상 (자동)</label>
                                <input type="text" :value="teacherPlanStudentsDisplay" readonly class="w-full p-2 border rounded-md bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-md font-semibold mb-2 text-gray-700">지도 모듈 (단원/영역)</label>
                                <input type="text" v-model="currentTeacherPlan.module" class="w-full p-2 border rounded-md" placeholder="예: 1단원 다항식">
                            </div>
                            <div>
                                <label class="block text-md font-semibold mb-2 text-gray-700">성취기준</label>
                                <textarea v-model="currentTeacherPlan.achievementStandard" rows="3" class="w-full p-2 border rounded-md" placeholder="예: [9수01-01] 다항식의 덧셈과 뺄셈의 원리를 이해하고, 그 계산을 할 수 있다."></textarea>
                            </div>
                            <div>
                                <label class="block text-md font-semibold mb-2 text-gray-700">지도 내용 (요소)</label>
                                <textarea v-model="currentTeacherPlan.content" rows="4" class="w-full p-2 border rounded-md" placeholder="예: 다항식의 덧셈과 뺄셈 계산하기"></textarea>
                            </div>
                            <div>
                                <label class="block text-md font-semibold mb-2 text-gray-700">지도 방법 및 자료</label>
                                <textarea v-model="currentTeacherPlan.method" rows="4" class="w-full p-2 border rounded-md" placeholder="예: 개념 설명, 예제 풀이, 형성평가지"></textarea>
                            </div>
                            
                            <!-- 버튼 그룹 -->
                            <div class="flex space-x-4 pt-4">
                                <button @click="saveTeacherPlan" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">계획안 저장</button>
                                <button @click="generatePlanPreview" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition">계획안 양식 미리보기</button>
                            </div>
                            
                            <p v-if="teacherPlanStatus" class="mt-3 text-sm font-semibold" :class="teacherPlanStatus.includes('성공') ? 'text-green-600' : 'text-red-600'">{{ teacherPlanStatus }}</p>
                            <p v-if="teacherPlanError" class="mt-3 text-sm font-semibold text-red-600">{{ teacherPlanError }}</p>
                        </div>
                        <p v-else class="text-gray-500">지도를 담당하는 과목을 선택하세요.</p>
                    </div>

                    <!-- 3. 출결 및 이수 (보충지도) -->
                    <div v-if="currentTab === 'attendanceBook'" class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-6 border-b pb-3">
                            <h3 class="text-xl font-bold">보충지도 출결 및 이수 현황</h3>
                            <div class="flex space-x-2">
                                <button @click="filterSupplementaryStudents" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                                    보충지도 대상자 가져오기
                                </button>
                                <!-- (수정) 출결 이력 가져오기 버튼 제거됨 -->
                            </div>
                        </div>

                        <!-- 학생 목록 테이블 -->
                        <div class="max-w-full overflow-x-auto relative">
                             <!-- 스크롤 버튼 -->
                            <button v-if="showLeftScroll" @click="scrollTable(-1)" class="scroll-arrow left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <button v-if="showRightScroll" @click="scrollTable(1)" class="scroll-arrow right">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                            
                            <div ref="tableContainer" class="overflow-x-auto" @scroll="handleTableScroll">
                                <table class="min-w-[1200px]">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="sticky left-0 bg-gray-50 z-10">학년</th>
                                            <th class="sticky left-12 bg-gray-50 z-10">반</th>
                                            <th class="sticky left-24 bg-gray-50 z-10">번호</th>
                                            <th class="sticky left-36 bg-gray-50 z-10 min-w-[100px]">이름</th>
                                            <th>과목</th>
                                            <th>지도교사</th>
                                            <th>총 차시</th>
                                            <!-- 동적 날짜 헤더 -->
                                            <th v-for="date in dynamicDates" :key="date" class="min-w-[100px]">
                                                {{ new Date(date).toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' }) }}
                                            </th>
                                            <th>이수</th>
                                            <th>비고</th>
                                            <th>저장</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        <template v-for="(student, index) in supplementaryStudents" :key="student.id">
                                            <tr>
                                                <td class="sticky left-0 bg-white z-10">{{ student.grade }}</td>
                                                <td class="sticky left-12 bg-white z-10">{{ student.class }}</td>
                                                <td class="sticky left-24 bg-white z-10">{{ student.number }}</td>
                                                <td class="sticky left-36 bg-white z-10 font-semibold">{{ student.name }}</td>
                                                <td>{{ student.subject }}</td>
                                                <td>{{ student.teacher }}</td>
                                                <td>{{ student.totalHours }}</td>
                                                <!-- 동적 출결 입력 -->
                                                <td v-for="date in dynamicDates" :key="date">
                                                    <select v-model="student.attendance[date]" class="w-full p-1 border rounded text-sm">
                                                        <option value="출석">출석</option>
                                                        <option value="결석">결석</option>
                                                        <option value="지각">지각</option>
                                                        <option value="조퇴">조퇴</option>
                                                        <option value="결과">결과</option>
                                                        <option value="">-</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <select v-model="student.completionStatus" class="w-full p-1 border rounded text-sm">
                                                        <option value="이수">이수</option>
                                                        <option value="미이수">미이수</option>
                                                        <option value="진행중">진행중</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="text" v-model="student.remarks" class="w-full p-1 border rounded text-sm" placeholder="비고 입력">
                                                </td>
                                                <td>
                                                    <button @click="saveAttendance(student)" class="px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm">저장</button>
                                                </td>
                                            </tr>
                                        </template>
                                        <tr v-if="supplementaryStudents.length === 0">
                                            <td colspan="11" class="text-center text-gray-500 py-8">
                                                '보충지도 대상자 가져오기' 버튼을 클릭하세요.
                                                <p v-if="attendanceError" class="text-red-500 font-semibold">{{ attendanceError }}</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <p v-if="attendanceStatus" class="mt-4 text-center text-sm font-semibold" :class="attendanceStatus.includes('성공') ? 'text-green-600' : 'text-red-600'">{{ attendanceStatus }}</p>
                    </div>

                    <!-- 4. 상담 및 정서지원 (담임교사) -->
                    <div v-if="currentTab === 'counselingSupport' && (role === '관리자' || role === '담임교사')" class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-6 border-b pb-3">
                            <h3 class="text-xl font-bold">상담 및 정서지원 관리</h3>
                            <div class="flex space-x-2">
                                <label for="homeroomSelect" class="text-md font-semibold text-gray-700 self-center mr-2">담당 학급:</label>
                                <select id="homeroomSelect" v-model="selectedHomeroom" @change="loadCounselingData" class="p-2 border rounded-md">
                                    <option value="">학급 선택</option>
                                    <option v-for="hr in homeroomClasses" :key="hr.id" :value="hr.id">{{ hr.grade }}학년 {{ hr.class }}반</option>
                                </select>
                            </div>
                        </div>
                        
                        <div v-if="selectedHomeroom">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th>번호</th>
                                        <th>이름</th>
                                        <th>상담일자</th>
                                        <th>상담내용 (요약)</th>
                                        <th>지원연계</th>
                                        <th>저장</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr v-for="student in homeroomStudents" :key="student.id">
                                        <td>{{ student.number }}</td>
                                        <td class="font-semibold">{{ student.name }}</td>
                                        <td>
                                            <input type="date" v-model="student.counselingDate" class="w-full p-1 border rounded text-sm">
                                        </td>
                                        <td>
                                            <textarea v-model="student.counselingNotes" rows="2" class="w-full p-1 border rounded text-sm" placeholder="상담 내용 요약..."></textarea>
                                        </td>
                                        <td>
                                            <select v-model="student.supportReferral" class="w-full p-1 border rounded text-sm">
                                                <option value="">선택</option>
                                                <option v-for="program in supportPrograms" :key="program.id" :value="program.name">{{ program.name }} ({{ program.type }})</option>
                                                <option value="기타">기타 (직접 입력)</option>
                                            </select>
                                            <input v-if="student.supportReferral === '기타'" type="text" v-model="student.supportReferralOther" class="w-full p-1 border rounded text-sm mt-1" placeholder="기타 지원 내용">
                                        </td>
                                        <td>
                                            <button @click="saveCounseling(student)" class="px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm">저장</button>
                                        </td>
                                    </tr>
                                    <tr v-if="homeroomStudents.length === 0">
                                        <td colspan="6" class="text-center text-gray-500 py-8">해당 학급의 학생 정보가 없습니다. (관리자 대시보드에서 학적 업로드)</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p v-if="counselingStatus" class="mt-4 text-center text-sm font-semibold" :class="counselingStatus.includes('성공') ? 'text-green-600' : 'text-red-600'">{{ counselingStatus }}</p>
                        </div>
                        <p v-else class="text-gray-500 text-center py-4">담당 학급을 선택하세요.</p>
                    </div>

                    <!-- 5. 가정통신문 및 서약서 -->
                    <div v-if="currentTab === 'printForms'" class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-6 border-b pb-3">
                            <h3 class="text-xl font-bold">가정통신문 및 서약서 출력</h3>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-lg font-semibold mb-3">대상자 선택</h4>
                                <div class="flex space-x-4">
                                    <select v-model="printFilter.grade" @change="updateClassFilter" class="p-2 border rounded-md">
                                        <option value="">전체 학년</option>
                                        <option v-for="g in availableFilters.grades" :key="g" :value="g">{{ g }}학년</option>
                                    </select>
                                    <select v-model="printFilter.class" @change="updateStudentFilter" class="p-2 border rounded-md">
                                        <option value="">전체 반</option>
                                        <option v-for="c in availableFilters.classes" :key="c" :value="c">{{ c }}반</option>
                                    </select>
                                    <select v-model="printFilter.subject" @change="updateStudentFilter" class="p-2 border rounded-md">
                                        <option value="">전체 과목</option>
                                        <option v-for="s in availableFilters.subjects" :key="s" :value="s">{{ s }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="max-h-80 overflow-y-auto border rounded-md">
                                <table class="w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th><input type="checkbox" @change="toggleSelectAllFiltered" :checked="allFilteredSelected"></th>
                                            <th>학년</th>
                                            <th>반</th>
                                            <th>번호</th>
                                            <th>이름</th>
                                            <th>과목</th>
                                            <th>미도달 사유</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        <tr v-for="student in filteredPrintStudents" :key="student.docId" class="hover:bg-gray-50">
                                            <td><input type="checkbox" v-model="student.selected"></td>
                                            <td>{{ student.grade }}</td>
                                            <td>{{ student.class }}</td>
                                            <td>{{ student.number }}</td>
                                            <td>{{ student.name }}</td>
                                            <td>{{ student.subject }}</td>
                                            <td>{{ student.reason || 'N/A' }}</td>
                                        </tr>
                                        <tr v-if="filteredPrintStudents.length === 0">
                                            <td colspan="7" class="text-center text-gray-500 py-8">선택된 조건에 해당하는 학생이 없습니다.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="flex justify-between items-center pt-4">
                                <span class="text-md font-semibold text-gray-700">
                                    총 {{ filteredPrintStudents.length }}명 중 {{ selectedPrintStudents.length }}명 선택됨
                                </span>
                                <div class="flex space-x-3">
                                    <button @click="previewForm('notification')" :disabled="selectedPrintStudents.length === 0" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 transition">가정통신문 인쇄</button>
                                    <button @click="previewForm('pledge')" :disabled="selectedPrintStudents.length === 0" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 transition">서약서 인쇄</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- (수정) 학교 ID 모달 (로그인O, 로딩X, 역할 선택 직후 또는 ID 수정 시) -->
            <!-- v-if 조건 수정: !role -> showSchoolIdModal -->
            <!-- 위치 수정: main 태그 밖으로 이동 (헤더 버튼에서도 열 수 있도록) -->
            

        </main>
    </div> <!-- #app end -->
    
    <!-- 모달들을 #app 외부에 배치 (z-index 및 포지셔닝 문제 방지) -->

    <!-- 학교 ID 설정 모달 -->
    <!-- (수정) 위치를 #app 내부 main 밖으로 이동 -->
    <div v-if="showSchoolIdModal && !isLoading" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <h2 class="text-2xl font-bold mb-4">학교 고유 ID {{ schoolId ? '확인' : '생성' }}</h2>
            <p v-if="selectedRole === '관리자'" class="mb-6 text-gray-600">
                관리자 인증이 완료되었습니다. 이 학교에서 사용할 고유 ID를 생성하세요. 이 ID는 교사들에게 공유해야 합니다. (예: `korea_high_2025`)
            </p>
            <p v-else class="mb-6 text-gray-600">
                관리자로부터 전달받은 학교 고유 ID를 입력하세요.
            </p>
            <!-- (수정) 잘못된 HTML 주석 및 코드 조각 삭제 -->
            <form @submit.prevent="handleSchoolIdSubmit">
                <input type="text" v-model.trim="inputSchoolId" class="w-full p-3 border rounded-md text-lg" placeholder="학교 ID 입력 (예: korea_high_2025)">
                <p v-if="schoolIdError" class="mt-3 text-red-500 font-semibold">{{ schoolIdError }}</p>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" @click="cancelSchoolId" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">취소</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                        {{ (selectedRole === '관리자' || schoolId) ? '확인' : '참여하기' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 관리자 코드 입력 모달 -->
    <div v-if="showAdminCodeModal" class="modal-overlay">
        <div class="modal-content max-w-sm">
            <h2 class="text-2xl font-bold mb-4">관리자 인증</h2>
            <p class="mb-6 text-gray-600">관리자 인증 코드를 입력하세요.</p>
            <form @submit.prevent="submitAdminCode">
                <input type="password" v-model="adminCodeInput" class="w-full p-3 border rounded-md text-lg text-center" placeholder="****">
                <p v-if="adminCodeError" class="mt-3 text-red-500 font-semibold">{{ adminCodeError }}</p>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" @click="cancelAdminCode" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">취소</button>
                    <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">인증</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- (수정) 관리자 코드 수정 모달 추가 -->
    <div v-if="showAdminCodeEditModal" class="modal-overlay">
        <div class="modal-content max-w-sm">
            <h2 class="text-2xl font-bold mb-4">관리자 코드 수정</h2>
            <p class="mb-6 text-gray-600">새로운 관리자 코드를 입력하세요.</p>
            <form @submit.prevent="updateAdminCode">
                <div class="space-y-3">
                    <input type="password" v-model="adminCodeEdit.current" class="w-full p-3 border rounded-md" placeholder="현재 코드 (0822)">
                    <input type="password" v-model="adminCodeEdit.new" class="w-full p-3 border rounded-md" placeholder="새 코드 (4자리 이상)">
                    <input type="password" v-model="adminCodeEdit.confirm" class="w-full p-3 border rounded-md" placeholder="새 코드 확인">
                </div>
                <p v-if="adminCodeEditError" class="mt-3 text-red-500 font-semibold">{{ adminCodeEditError }}</p>
                <p v-if="adminCodeEditStatus" class="mt-3 text-green-600 font-semibold">{{ adminCodeEditStatus }}</p>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" @click="showAdminCodeEditModal = false" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">닫기</button>
                    <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition">수정</button>
                </div>
            </form>
        </div>
    </div>

    <!-- (수정) 출결 이력 가져오기 모달 제거됨 -->

    <!-- 인쇄 미리보기 모달 -->
    <div v-if="showPreviewModal" class="modal-overlay">
        <div class="modal-content max-w-4xl max-h-[95vh]">
            <!-- 모달 상단 컨트롤 (인쇄 시 숨김) -->
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h2 class="text-2xl font-bold">인쇄 미리보기</h2>
                <div class_="space-x-2">
                    <span v-if="previewStatus" class="text-sm text-gray-500 mr-4">{{ previewStatus }}</span>
                    <button @click="printPreviewModalContent" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">인쇄 / PDF 저장</button>
                    <button @click="closePreviewModal" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">닫기</button>
                </div>
            </div>
            
            <!-- 인쇄될 영역 (모달 스크롤 내부) -->
            <div id="print-area-container-in-modal" class="max-h-[75vh] overflow-y-auto bg-gray-100 p-4 border rounded-md">
                <!-- 여기에 previewHtml이 렌더링됨 -->
                <div v-html="previewHtml"></div>
            </div>
            
             <p v-if="adminActionStatus" class="mt-4 text-center text-sm font-semibold" :class="adminActionStatus.includes('성공') ? 'text-green-600' : 'text-red-600'">{{ adminActionStatus }}</p>
        </div>
    </div>
    
    <!-- 파일 삭제 확인 모달 -->
    <div v-if="showDeleteModal" class="modal-overlay">
        <div class="modal-content max-w-md text-center">
            <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            <h2 class="text-2xl font-bold mb-4">정말 삭제하시겠습니까?</h2>
            <p class="mb-8 text-gray-600">
                '<span class="font-semibold text-red-600">{{ deleteTargetName }}</span>' 데이터를 삭제합니다.<br>이 작업은 되돌릴 수 없습니다.
            </p>
            <p v-if="deleteStatus" class="mb-4 text-sm font-semibold" :class="deleteStatus.includes('성공') ? 'text-green-600' : 'text-red-600'">{{ deleteStatus }}</p>
            <div class="flex justify-center space-x-4">
                <button @click="closeDeleteModal" class="px-8 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">취소</button>
                <button @click="confirmDeleteFile" class="px-8 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">삭제</button>
            </div>
        </div>
    </div>

    <!-- html2canvas 인쇄용 숨겨진 컨테이너 -->
    <div id="print-area-container" style="position: absolute; left: -9999px; top: -9999px; background: white; padding: 20px;"></div>


    <!-- Vue.js Application Script -->
    <script type="module">
        const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;

        createApp({
            data() {
                return {
                    // --- Auth & User ---
                    user: null,
                    isLoggedIn: false,
                    role: null, // '관리자', '교과교사', '담임교사'
                    schoolId: null, // 학교 고유 ID
                    isLoading: true, // 초기 로딩 상태
                    roleSelectionError: '',
                    
                    // --- Admin Code & School ID Modals ---
                    showAdminCodeModal: false,
                    adminCodeInput: '',
                    adminCodeError: '',
                    adminCode: "0822", // 기본 관리자 코드
                    showSchoolIdModal: false,
                    inputSchoolId: '', // 모달창에 입력되는 ID
                    schoolIdError: '',
                    selectedRole: '', // 역할 선택시 임시 저장
                    // (수정) 관리자 코드 수정 모달
                    showAdminCodeEditModal: false,
                    adminCodeEdit: {
                        current: '',
                        new: '',
                        confirm: ''
                    },
                    adminCodeEditError: '',
                    adminCodeEditStatus: '',
                    
                    // --- Navigation ---
                    currentTab: '', // 'adminDashboard', 'teacherPlan', 'attendanceBook', 'counselingSupport', 'printForms'

                    // --- Admin: File Upload ---
                    files: {
                        curriculum: null,
                        students: null,
                        supportPrograms: null,
                        grades: null
                    },
                    uploadStatus: {
                        curriculum: '',
                        students: '',
                        supportPrograms: '',
                        grades: '',
                        deployment: ''
                    },
                    
                    // --- Admin: Data & Deployment ---
                    underachievers: [], // 성적 처리 후 추출된 미도달 학생
                    
                    // --- Admin: Form Templates ---
                    formTemplates: {
                        notification: { content: '', file: null },
                        pledge: { content: '', file: null }
                    },
                    adminActionStatus: '',
                    
                    // --- Common Data (Loaded from DB) ---
                    curriculum: [], // 편제표
                    allStudents: [], // 학적
                    supportPrograms: [], // 정서지원 프로그램
                    deployedUnderachievers: [], // 배포된 미도달 학생 명단
                    loadedFormTemplates: { // DB에서 로드된 양식
                        notification: '',
                        pledge: ''
                    },

                    // --- Teacher Plan (Tab 2) ---
                    currentTeacherPlan: {
                        subject: '',
                        dateRange: '', // 예: "2025-10-01 to 2025-10-15"
                        module: '',
                        achievementStandard: '',
                        content: '',
                        method: ''
                    },
                    teacherPlanStatus: '',
                    teacherPlanError: '',
                    flatpickrInstance: null, // Date picker 인스턴스

                    // --- Attendance Book (Tab 3) ---
                    supplementaryStudents: [], // 보충지도 대상 학생 목록 (필터링됨)
                    dynamicDates: [], // 출결부의 동적 날짜 헤더
                    attendanceStatus: '',
                    attendanceError: '',
                    showLeftScroll: false,
                    showRightScroll: true,
                    // (수정) 출결 이력 모달 제거
                    
                    // --- Counseling (Tab 4) ---
                    selectedHomeroom: '', // 예: "1-1"
                    homeroomStudents: [], // 선택된 학급의 학생 목록
                    counselingStatus: '',

                    // --- Print Forms (Tab 5) ---
                    printFilter: {
                        grade: '',
                        class: '',
                        subject: ''
                    },
                    
                    // --- Preview Modal (공통) ---
                    showPreviewModal: false,
                    previewHtml: '',
                    previewStatus: '',
                    
                    // --- Delete Modal (관리자) ---
                    showDeleteModal: false,
                    deleteTarget: '',
                    deleteTargetName: '',
                    deleteStatus: '',
                }
            },
            
            // === COMPUTED PROPERTIES ===
            computed: {
                // --- Computed: User & Role ---
                
                // 관리자인지 여부
                isAdmin() {
                    return this.role === '관리자';
                },
                
                // 교과교사인지 여부 (지도 계획안 탭용)
                isSubjectTeacher() {
                    return this.role === '교과교사';
                },
                
                // 담임교사인지 여부 (상담 탭용)
                isHomeroomTeacher() {
                    return this.role === '담임교사';
                },
                
                // --- Computed: Teacher Plan (Tab 2) ---
                
                // 교과교사가 담당하는 과목 목록 (편제표 기준)
                teacherSubjects() {
                    if (!this.user || !this.curriculum.length) return [];
                    const teacherName = this.user.displayName;
                    const subjects = new Set();
                    this.curriculum.forEach(item => {
                        if (item.교사 === teacherName) {
                            subjects.add(item.과목);
                        }
                    });
                    // 관리자는 모든 과목을 볼 수 있음
                    if (this.role === '관리자') {
                         this.curriculum.forEach(item => subjects.add(item.과목));
                    }
                    return Array.from(subjects);
                },
                
                // 지도 계획안의 대상 학생 (이름만)
                teacherPlanStudentsDisplay() {
                    if (!this.currentTeacherPlan.subject) return "과목을 선택하세요";
                    
                    // 1. 선택한 과목의 미도달 학생 ID 목록
                    const studentIds = new Set(
                        this.deployedUnderachievers
                            .filter(s => s.subject === this.currentTeacherPlan.subject)
                            .map(s => s.studentId)
                    );
                    
                    // 2. ID를 이름으로 변환
                    const names = this.allStudents
                        .filter(s => studentIds.has(s.학생ID))
                        .map(s => s.이름);
                        
                    return names.length > 0 ? names.join(', ') : "대상 학생 없음";
                },

                // --- Computed: Counseling (Tab 4) ---
                
                // 담임교사가 담당하는 학급 목록 (학적 기준)
                homeroomClasses() {
                    if (!this.allStudents.length) return [];
                    const classes = new Map();
                    
                    if (this.role === '담임교사' && this.user) {
                        // TODO: 현재 로직은 담임-학급 배정 정보가 없으므로, 학적부의 모든 학급을 보여줌.
                        // 추후 '편제표' 등에 담임 정보가 있다면 필터링 필요.
                         this.allStudents.forEach(s => {
                            const classId = `${s.학년}-${s.반}`;
                            if (!classes.has(classId)) {
                                classes.set(classId, { id: classId, grade: s.학년, class: s.반 });
                            }
                        });
                    } else if (this.role === '관리자') {
                        // 관리자는 모든 학급을 볼 수 있음
                         this.allStudents.forEach(s => {
                            const classId = `${s.학년}-${s.반}`;
                            if (!classes.has(classId)) {
                                classes.set(classId, { id: classId, grade: s.학년, class: s.반 });
                            }
                        });
                    }
                    
                    // 정렬
                    return Array.from(classes.values()).sort((a, b) => {
                        if (a.grade !== b.grade) return a.grade - b.grade;
                        return a.class - b.class;
                    });
                },
                
                // --- Computed: Print Forms (Tab 5) ---
                
                // '가정통신문' 탭의 필터링 가능한 옵션
                availableFilters() {
                    const grades = new Set();
                    const classes = new Set();
                    const subjects = new Set();
                    
                    this.deployedUnderachievers.forEach(s => {
                        grades.add(s.grade);
                        if (!this.printFilter.grade || s.grade == this.printFilter.grade) {
                            classes.add(s.class);
                        }
                        subjects.add(s.subject);
                    });
                    
                    return {
                        grades: Array.from(grades).sort(),
                        classes: Array.from(classes).sort(),
                        subjects: Array.from(subjects).sort()
                    };
                },
                
                // 필터링된 학생 목록 (출력 대상)
                filteredPrintStudents() {
                    return this.deployedUnderachievers
                        .filter(student => {
                            const gradeMatch = !this.printFilter.grade || student.grade == this.printFilter.grade;
                            const classMatch = !this.printFilter.class || student.class == this.printFilter.class;
                            const subjectMatch = !this.printFilter.subject || student.subject == this.printFilter.subject;
                            return gradeMatch && classMatch && subjectMatch;
                        })
                        .map(student => ({ ...student, selected: false })); // 'selected' 속성 추가
                },
                
                // 'filteredPrintStudents' 중 'selected'가 true인 학생
                selectedPrintStudents() {
                    return this.filteredPrintStudents.filter(s => s.selected);
                },
                
                // '전체 선택' 체크박스 상태
                allFilteredSelected() {
                    return this.filteredPrintStudents.length > 0 && 
                           this.selectedPrintStudents.length === this.filteredPrintStudents.length;
                },
            },
            
            // === LIFECYCLE HOOKS ===
            onMounted() {
                // Firebase 초기화
                this.initApp();
            },
            
            // === METHODS ===
            methods: {
                // --- Helper and UI Methods ---
                
                // Flatpickr (날짜 범위 선택기) 초기화
                initFlatpickr() {
                    // $nextTick을 사용하여 DOM이 렌더링된 후 실행
                    nextTick(() => {
                        const dateInput = document.getElementById('teacherPlanDateRange');
                        if (dateInput && !this.flatpickrInstance) {
                            this.flatpickrInstance = flatpickr(dateInput, {
                                mode: "range",
                                dateFormat: "Y-m-d",
                                defaultDate: this.currentTeacherPlan.dateRange ? this.currentTeacherPlan.dateRange.split(" to ") : [],
                                onChange: (selectedDates) => {
                                    if (selectedDates.length === 2) {
                                        const [start, end] = selectedDates;
                                        this.currentTeacherPlan.dateRange = `${start.toISOString().split('T')[0]} to ${end.toISOString().split('T')[0]}`;
                                    } else {
                                        this.currentTeacherPlan.dateRange = '';
                                    }
                                }
                            });
                        }
                    });
                },
                
                // 테이블 가로 스크롤 버튼 상태 업데이트
                handleTableScroll(event) {
                    const el = event.target;
                    this.showLeftScroll = el.scrollLeft > 0;
                    this.showRightScroll = el.scrollLeft < (el.scrollWidth - el.clientWidth - 1);
                },

                // 테이블 가로 스크롤 실행
                scrollTable(direction) {
                    const container = this.$refs.tableContainer;
                    if (container) {
                        const scrollAmount = container.clientWidth * 0.8 * direction;
                        container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
                    }
                },
                
                // --- Initialization and Auth ---
                
                // Firebase 앱 초기화 및 인증 상태 리스너 설정
                async initApp() {
                    this.isLoading = true;
                    try {
                        if (!firebaseConfig.apiKey) {
                            console.error("Firebase config is missing.");
                            this.isLoading = false;
                            return;
                        }
                        
                        app = initializeApp(firebaseConfig);
                        db = getFirestore(app);
                        auth = getAuth(app);
                        storage = getStorage(app);

                        // 인증 상태 변경 리스너
                        onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                // 사용자가 로그인한 경우
                                this.user = user;
                                this.isLoggedIn = true;
                                
                                // Firestore에서 사용자 역할 및 schoolId 로드
                                await this.loadUserRole(); 
                                
                                // 역할과 학교 ID가 모두 있어야 다음 단계 진행
                                if (this.role && this.schoolId) {
                                    await this.loadCommonData(); // 공용 데이터 로드
                                    
                                    // 역할에 따른 기본 탭 설정
                                    if (this.role === '관리자') {
                                        this.currentTab = 'adminDashboard';
                                    } else if (this.role === '교과교사') {
                                        this.currentTab = 'teacherPlan';
                                    } else if (this.role === '담임교사') {
                                        this.currentTab = 'counselingSupport';
                                    } else {
                                        this.currentTab = 'attendanceBook'; // 기본값
                                    }
                                    
                                    // 역할별 데이터 로드 (분리)
                                    this.loadRoleSpecificData();
                                    
                                } else if (!this.schoolId && this.role) {
                                    // 역할은 있으나 학교 ID가 없는 경우 (예: 관리자가 ID 생성 전)
                                    this.selectedRole = this.role; // (수정) 역할 임시 저장
                                    this.showSchoolIdModal = true;
                                }
                                
                            } else {
                                // 사용자가 로그아웃한 경우
                                this.user = null;
                                this.isLoggedIn = false;
                                this.role = null;
                                this.schoolId = null; 
                                this.resetAllLocalData(true); // Reset everything on logout
                            }
                            // (수정) 로딩 완료를 if/else 바깥으로 이동
                            this.isLoading = false; 
                             this.$nextTick(() => { this.initFlatpickr(); });
                        });

                    } catch (error) {
                        console.error("Error initializing Firebase:", error);
                        this.isLoading = false;
                    }
                },
                
                // Google 로그인
                async login() {
                    this.isLoading = true;
                    const provider = new GoogleAuthProvider();
                    try {
                        // signInWithRedirect 대신 signInWithPopup 사용 (Iframe 환경 고려)
                        await signInWithPopup(auth, provider);
                        // onAuthStateChanged가 나머지를 처리
                    } catch (error) {
                        console.error("Google login error:", error);
                        this.isLoading = false;
                    }
                },

                // 로그아웃
                async logout() {
                    this.isLoading = true;
                    await signOut(auth);
                    // onAuthStateChanged가 나머지를 처리 (this.isLoading = false 포함)
                },
                
                // 역할 재선택
                resetRole() {
                    this.role = null; // 역할만 null로
                    this.selectedRole = ''; // 임시 역할도 초기화
                    this.resetAllLocalData(false); // 로컬 데이터 리셋 (schoolId 제외)
                    // showSchoolIdModal 등은 false로 유지 (역할 선택 화면으로 이동)
                },
                
                // 로컬 데이터 리셋 (로그아웃 또는 역할 변경 시)
                resetAllLocalData(isFullLogout) {
                    if (isFullLogout) {
                        this.schoolId = null;
                        this.inputSchoolId = '';
                    }
                    this.currentTab = '';
                    this.curriculum = [];
                    this.allStudents = [];
                    this.supportPrograms = [];
                    this.deployedUnderachievers = [];
                    this.underachievers = [];
                    this.supplementaryStudents = [];
                    this.homeroomStudents = [];
                    this.loadedFormTemplates = { notification: '', pledge: '' };
                    this.formTemplates = { notification: { content: '', file: null }, pledge: { content: '', file: null } };
                    // ... (기타 상태 초기화)
                },

                // --- Role & School ID Management ---

                // Firestore에서 사용자 역할 및 schoolId 로드
                async loadUserRole() {
                    if (!this.user || !db) return;
                    
                    const userDocRef = doc(db, `userData/${this.user.uid}`);
                    try {
                        const userDocSnap = await getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            const data = userDocSnap.data();
                            this.role = data.role || null;
                            this.schoolId = data.schoolId || null;
                            this.inputSchoolId = data.schoolId || ''; // (수정) 모달창 입력값 미리 채우기
                            // (수정) 관리자 코드 로드
                            if (data.adminCode) {
                                this.adminCode = data.adminCode;
                            }
                        } else {
                            // 문서가 없으면 역할/ID 모두 null
                            this.role = null;
                            this.schoolId = null;
                        }
                    } catch (error) {
                        console.error("Error loading user role:", error);
                        this.role = null;
                        this.schoolId = null;
                    }
                },
                
                // Firestore에 사용자 역할 및 schoolId 저장
                async saveUserRole(roleToSave, schoolIdToSave) {
                    if (!this.user || !db) return;
                    
                    const userDocRef = doc(db, `userData/${this.user.uid}`);
                    try {
                        // (수정) 관리자 코드도 함께 저장 (roleToSave가 관리자일 때)
                        const dataToSave = {
                            role: roleToSave,
                            schoolId: schoolIdToSave,
                            email: this.user.email
                        };
                        
                        await setDoc(userDocRef, dataToSave, { merge: true });
                        
                        // 로컬 상태 업데이트
                        this.role = roleToSave;
                        this.schoolId = schoolIdToSave;
                        this.inputSchoolId = schoolIdToSave;
                        
                    } catch (error) {
                        console.error("Error saving user role:", error);
                        this.roleSelectionError = `역할 저장 중 오류 발생: ${error.message}`;
                    }
                },
                
                // 역할 선택 버튼 클릭
                selectRole(role) {
                    this.selectedRole = role; // 임시 저장
                    
                    if (role === '관리자') {
                        this.showAdminCodeModal = true;
                    } else {
                        // (수정) 교과교사, 담임교사 선택 시
                        // (수정) 기존 schoolId가 있어도 항상 모달창 표시 (확인용)
                        this.inputSchoolId = this.schoolId || ''; // 기존 ID 채우기
                        this.showSchoolIdModal = true;
                    }
                },
                
                // 관리자 코드 인증
                submitAdminCode() {
                    if (this.adminCodeInput === this.adminCode) {
                        this.adminCodeError = '';
                        this.showAdminCodeModal = false;
                        this.adminCodeInput = '';
                        
                        // (수정) 관리자 인증 성공 시
                        // (수정) 기존 schoolId가 있어도 항상 모달창 표시 (생성/확인용)
                        this.inputSchoolId = this.schoolId || ''; // 기존 ID 채우기
                        this.showSchoolIdModal = true;
                        
                    } else {
                        this.adminCodeError = '인증 코드가 올바르지 않습니다.';
                    }
                },
                
                // 관리자 코드 모달 닫기
                cancelAdminCode() {
                    this.showAdminCodeModal = false;
                    this.adminCodeInput = '';
                    this.adminCodeError = '';
                    this.selectedRole = ''; // 역할 선택 취소
                },
                
                // (수정) 관리자 코드 수정 모달 열기
                openAdminCodeEditModal() {
                    this.adminCodeEdit = { current: '', new: '', confirm: '' };
                    this.adminCodeEditError = '';
                    this.adminCodeEditStatus = '';
                    this.showAdminCodeEditModal = true;
                },
                
                // (수정) 관리자 코드 업데이트
                async updateAdminCode() {
                    this.adminCodeEditError = '';
                    this.adminCodeEditStatus = '';
                    
                    if (this.adminCodeEdit.current !== this.adminCode) {
                        this.adminCodeEditError = '현재 코드가 일치하지 않습니다.';
                        return;
                    }
                    if (!this.adminCodeEdit.new || this.adminCodeEdit.new.length < 4) {
                        this.adminCodeEditError = '새 코드는 4자리 이상이어야 합니다.';
                        return;
                    }
                    if (this.adminCodeEdit.new !== this.adminCodeEdit.confirm) {
                        this.adminCodeEditError = '새 코드가 일치하지 않습니다.';
                        return;
                    }

                    // Firestore userData에 새 코드 저장
                    const newCode = this.adminCodeEdit.new;
                    const userDocRef = doc(db, `userData/${this.user.uid}`);
                    try {
                        await setDoc(userDocRef, { adminCode: newCode }, { merge: true });
                        this.adminCode = newCode; // 로컬 코드 업데이트
                        this.adminCodeEditStatus = '코드가 성공적으로 수정되었습니다.';
                        // 폼 비우기
                        this.adminCodeEdit = { current: '', new: '', confirm: '' };
                    } catch (error) {
                        console.error("Error updating admin code:", error);
                        this.adminCodeEditError = '코드 수정 중 오류가 발생했습니다.';
                    }
                },
                
                // (수정) 학교 ID 수정 버튼 (관리자 헤더)
                openSchoolIdModal() {
                    this.inputSchoolId = this.schoolId || ''; // 기존 ID 채우기
                    this.selectedRole = this.role; // 현재 역할을 임시 역할로 설정
                    this.schoolIdError = '';
                    this.showSchoolIdModal = true;
                },

                // 학교 ID 모달 '참여하기' / '확인' 버튼
                async handleSchoolIdSubmit() {
                    if (!this.inputSchoolId) {
                        this.schoolIdError = '학교 ID를 입력하세요.';
                        return;
                    }
                    
                    this.isLoading = true;
                    this.schoolIdError = '';
                    const newSchoolId = this.inputSchoolId;
                    
                    try {
                        // 1. 역할 및 ID 저장
                        await this.saveUserRole(this.selectedRole, newSchoolId);
                        
                        // 2. 모달 닫기
                        this.showSchoolIdModal = false;
                        
                        // 3. (수정) 공용 데이터 로드 (필수)
                        // (역할 변경 시 이 단계가 초기화된 데이터를 다시 불러옴)
                        await this.loadCommonData();
                        
                        // 4. 역할별 데이터 로드 (분리)
                        this.loadRoleSpecificData();

                        // 5. 역할에 따른 기본 탭 설정
                        if (this.role === '관리자') {
                            this.currentTab = 'adminDashboard';
                        } else if (this.role === '교과교사') {
                            this.currentTab = 'teacherPlan';
                        } else if (this.role === '담임교사') {
                            this.currentTab = 'counselingSupport';
                        } else {
                            this.currentTab = 'attendanceBook';
                        }

                    } catch (error) {
                        console.error("Error in handleSchoolIdSubmit:", error);
                        this.schoolIdError = `처리 중 오류 발생: ${error.message}`;
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // 학교 ID 모달 닫기
                cancelSchoolId() {
                    this.showSchoolIdModal = false;
                    this.inputSchoolId = this.schoolId || ''; // 원래 ID로 복원
                    this.schoolIdError = '';
                    
                    // (수정) 만약 ID가 없는 상태에서 취소했다면 역할 선택으로 복귀
                    if (!this.schoolId) {
                        this.selectedRole = '';
                        this.role = null;
                    }
                },
                
                // --- Data Loading (Common & Role-Specific) ---
                
                // 공용 데이터 로드 (학교 ID 확정 후)
                async loadCommonData() {
                    if (!db || !this.schoolId) return;
                    
                    const commonDataTypes = ['curriculum', 'students', 'supportPrograms', 'deployedUnderachievers', 'formTemplates'];
                    this.adminActionStatus = '학교 공용 데이터 로드 중...';
                    
                    try {
                        for (const type of commonDataTypes) {
                            const docRef = doc(db, `schools/${this.schoolId}/commonData/${type}`);
                            const docSnap = await getDoc(docRef);
                            
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (type === 'formTemplates') {
                                    this.loadedFormTemplates.notification = data.notification || '';
                                    this.loadedFormTemplates.pledge = data.pledge || '';
                                    // 관리자 탭의 textarea도 채우기
                                    this.formTemplates.notification.content = data.notification || '';
                                    this.formTemplates.pledge.content = data.pledge || '';
                                } else {
                                    this[type] = data.data || []; // 'curriculum', 'students' 등
                                }
                            } else {
                                console.warn(`No commonData doc found for type: ${type}`);
                                if (type !== 'formTemplates') {
                                    this[type] = [];
                                }
                            }
                        }
                        this.adminActionStatus = '학교 데이터 로드 완료.';
                    } catch (error) {
                        console.error("Error loading common data:", error);
                        this.adminActionStatus = `공용 데이터 로드 실패: ${error.message}`;
                    }
                },
                
                // 역할별 개인 데이터 로드
                loadRoleSpecificData() {
                    // $nextTick: DOM 렌더링 후 Flatpickr 초기화
                    this.$nextTick(() => { this.initFlatpickr(); });

                    // 교과교사: 마지막으로 저장된 계획안이 있다면 로드 (과목 선택 시 loadTeacherPlan이 처리)
                    if (this.role === '교과교사') {
                        // teacherSubjects가 계산될 때까지 기다릴 필요 없음
                    }
                    
                    // 담임교사: 학급 목록이 준비됨 (loadCounselingData는 학급 선택 시 호출)
                    if (this.role === '담임교사') {
                        // homeroomClasses가 계산됨
                    }
                },

                // --- Admin: File Upload & Processing (Tab 1) ---
                
                // 파일 선택 핸들러
                handleFileUpload(event, type) {
                    const file = event.target.files[0];
                    if (file) {
                        this.files[type] = file;
                        this.uploadStatus[type] = `'${file.name}' 선택됨.`;
                    }
                },

                // 파일 업로드 (공통 로직)
                async uploadFile(type) {
                    const file = this.files[type];
                    if (!file || !this.schoolId || !this.role === '관리자') {
                        this.uploadStatus[type] = '파일이 없거나 권한이 없습니다.';
                        return;
                    }
                    
                    this.uploadStatus[type] = '파일 처리 중...';
                    
                    try {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, { type: 'binary' });
                            
                            let sheetName;
                            if (type === 'curriculum') sheetName = '편제표';
                            else if (type === 'students') sheetName = '학적';
                            else if (type === 'supportPrograms') sheetName = '프로그램';
                            else {
                                this.uploadStatus[type] = '알 수 없는 파일 타입입니다.';
                                return;
                            }
                            
                            const worksheet = workbook.Sheets[sheetName];
                            if (!worksheet) {
                                this.uploadStatus[type] = `'${sheetName}' 시트를 찾을 수 없습니다.`;
                                return;
                            }
                            
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            
                            // Firestore에 저장
                            const docRef = doc(db, `schools/${this.schoolId}/commonData/${type}`);
                            await setDoc(docRef, { data: jsonData });
                            
                            // 로컬 데이터 업데이트
                            this[type] = jsonData;
                            
                            this.uploadStatus[type] = `${type} 업로드 성공! (${jsonData.length}개 레코드)`;
                            this.files[type] = null; // 파일 선택 초기화
                        };
                        reader.onerror = (error) => {
                             this.uploadStatus[type] = `파일 읽기 오류: ${error.message}`;
                        };
                        reader.readAsBinaryString(file);

                    } catch (error) {
                        console.error(`Error uploading ${type}:`, error);
                        this.uploadStatus[type] = `업로드 실패: ${error.message}`;
                    }
                },
                
                // (수정) 파일 삭제 모달 열기
                openDeleteModal(type) {
                    this.deleteTarget = type;
                    if (type === 'curriculum') this.deleteTargetName = '교육과정 편제표';
                    else if (type === 'students') this.deleteTargetName = '학적 정보';
                    else if (type === 'supportPrograms') this.deleteTargetName = '정서지원 프로그램';
                    else this.deleteTargetName = type;
                    
                    this.deleteStatus = '';
                    this.showDeleteModal = true;
                },
                
                // (수정) 파일 삭제 모달 닫기
                closeDeleteModal() {
                    this.showDeleteModal = false;
                    this.deleteTarget = '';
                    this.deleteTargetName = '';
                    this.deleteStatus = '';
                },
                
                // (수정) 파일 삭제 확정
                async confirmDeleteFile() {
                    const type = this.deleteTarget;
                    if (!type || !this.schoolId || this.role !== '관리자') {
                        this.deleteStatus = '권한이 없습니다.';
                        return;
                    }
                    
                    this.deleteStatus = '삭제 중...';
                    
                    try {
                        const docRef = doc(db, `schools/${this.schoolId}/commonData/${type}`);
                        // 문서를 삭제하는 대신, data 필드를 빈 배열로 업데이트
                        await setDoc(docRef, { data: [] }); 
                        
                        // 로컬 데이터 초기화
                        this[type] = [];
                        
                        this.deleteStatus = '삭제 성공.';
                        // 1초 후 모달 닫기
                        setTimeout(() => {
                            this.closeDeleteModal();
                        }, 1000);
                        
                    } catch (error) {
                        console.error(`Error deleting ${type}:`, error);
                        this.deleteStatus = `삭제 실패: ${error.message}`;
                    }
                },

                // 성적 처리 (미도달 대상자 추출)
                processGrades() {
                    const file = this.files.grades;
                    if (!file) {
                        this.uploadStatus.grades = '파일을 선택하세요.';
                        return;
                    }
                    if (!this.allStudents.length) {
                         this.uploadStatus.grades = '학적 정보가 먼저 업로드되어야 합니다.';
                        return;
                    }
                    
                    this.uploadStatus.grades = '성적 처리 중...';
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, { type: 'binary' });
                            const worksheet = workbook.Sheets['성적'];
                            if (!worksheet) {
                                this.uploadStatus.grades = "'성적' 시트를 찾을 수 없습니다.";
                                return;
                            }
                            
                            const gradesData = XLSX.utils.sheet_to_json(worksheet);
                            
                            const underachieversList = [];
                            gradesData.forEach(gradeEntry => {
                                // 성취도 'I' 또는 'F'인 경우
                                if (gradeEntry.성취도 === 'I' || gradeEntry.성취도 === 'F') {
                                    const student = this.allStudents.find(s => s.학생ID == gradeEntry.학생ID);
                                    if (student) {
                                        underachieversList.push({
                                            studentId: student.학생ID,
                                            name: student.이름,
                                            grade: student.학년,
                                            class: student.반,
                                            number: student.번호,
                                            subject: gradeEntry.과목,
                                            reason: gradeEntry.성취도 // 초기 사유
                                        });
                                    }
                                }
                            });
                            
                            this.underachievers = underachieversList;
                            this.uploadStatus.grades = `처리 완료. 미도달 대상 ${underachieversList.length}건 추출.`;
                            
                        } catch (error) {
                            console.error("Error processing grades:", error);
                            this.uploadStatus.grades = `성적 처리 실패: ${error.message}`;
                        }
                    };
                    reader.onerror = (error) => {
                        this.uploadStatus.grades = `파일 읽기 오류: ${error.message}`;
                    };
                    reader.readAsBinaryString(file);
                },
                
                // 미도달 대상자 배포 (Firestore에 저장)
                async deployUnderachievers() {
                    if (this.underachievers.length === 0) {
                        this.uploadStatus.deployment = '배포할 대상자가 없습니다.';
                        return;
                    }
                    
                    this.uploadStatus.deployment = '대상자 배포 중...';
                    
                    try {
                        // 1. 학생 정보 + 교사 정보 매칭
                        const deploymentData = this.underachievers.map(student => {
                            const curriculumEntry = this.curriculum.find(c => 
                                c.학년 == student.grade && c.과목 === student.subject
                            );
                            const teacherName = curriculumEntry ? curriculumEntry.교사 : '배정안됨';
                            
                            // 고유 ID 생성 (학생ID + 과목)
                            const docId = `${student.studentId}_${student.subject.replace(/[^a-zA-Z0-9]/g, '')}`;
                            
                            return {
                                ...student,
                                teacher: teacherName,
                                docId: docId // Firestore 문서 ID로 사용
                            };
                        });
                        
                        // 2. Firestore에 저장 (commonData/deployedUnderachievers)
                        // (수정) docId를 사용하지 않고, data 필드에 배열 전체를 저장
                        const docRef = doc(db, `schools/${this.schoolId}/commonData/deployedUnderachievers`);
                        await setDoc(docRef, { data: deploymentData });

                        // 3. 로컬 데이터 업데이트
                        this.deployedUnderachievers = deploymentData;
                        
                        this.uploadStatus.deployment = '대상자 배포 성공!';
                        this.underachievers = []; // 추출 목록 비우기
                        this.files.grades = null; // 파일 선택 비우기
                        
                    } catch (error) {
                        console.error("Error deploying underachievers:", error);
                        this.uploadStatus.deployment = `배포 실패: ${error.message}`;
                    }
                },

                // --- Admin: Form Template Management (Tab 1) ---
                
                // 양식 파일 업로드 핸들러 (HTML/TXT)
                handleFormTemplateUpload(event, type) {
                    const file = event.target.files[0];
                    if (file) {
                        this.formTemplates[type].file = file;
                        this.adminActionStatus = `'${file.name}' 선택됨.`;
                        
                        // 파일 내용 읽어서 textarea에 표시
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.formTemplates[type].content = e.target.result;
                        };
                        reader.onerror = (e) => {
                            this.adminActionStatus = '파일 읽기 오류.';
                        };
                        reader.readAsText(file);
                    }
                },
                
                // 양식 저장 (Firestore)
                async saveFormTemplate(type) {
                    const content = this.formTemplates[type].content;
                    if (!content) {
                        this.adminActionStatus = '저장할 내용이 없습니다.';
                        return;
                    }
                    
                    this.adminActionStatus = '양식 저장 중...';
                    
                    try {
                        const docRef = doc(db, `schools/${this.schoolId}/commonData/formTemplates`);
                        
                        // (수정) notification과 pledge를 한 문서에 같이 저장
                        const dataToSave = {};
                        if (type === 'notification') {
                            dataToSave.notification = content;
                        } else {
                            dataToSave.pledge = content;
                        }
                        
                        await setDoc(docRef, dataToSave, { merge: true }); // merge: true로 기존 양식 덮어쓰지 않기
                        
                        // 로컬 로드된 데이터도 업데이트
                        this.loadedFormTemplates[type] = content;
                        
                        this.adminActionStatus = `${type === 'notification' ? '가정통신문' : '서약서'} 양식 저장 성공.`;
                        
                    } catch (error) {
                        console.error("Error saving form template:", error);
                        this.adminActionStatus = `양식 저장 실패: ${error.message}`;
                    }
                },
                
                // (관리자용) 양식 미리보기
                previewFormAdmin(type) {
                    const content = this.formTemplates[type].content;
                    if (!content) {
                        this.adminActionStatus = '미리볼 양식이 없습니다. (저장되지 않은 내용)';
                        return;
                    }
                    this.previewHtml = content; // 단순 HTML 표시
                    this.showPreviewModal = true;
                    this.adminActionStatus = '';
                },

                // --- Teacher Plan (Tab 2) ---
                
                // (교과교사) 과목 선택 시, 저장된 계획안 로드
                async loadTeacherPlan() {
                    const subject = this.currentTeacherPlan.subject;
                    if (!subject || !this.user) {
                        // 폼 초기화
                        this.currentTeacherPlan = {
                            subject: subject, dateRange: '', module: '', 
                            achievementStandard: '', content: '', method: ''
                        };
                        return;
                    }
                    
                    this.teacherPlanStatus = '계획안 로드 중...';
                    
                    try {
                        // 경로는 /schools/{schoolId}/teacherData/{userId}/plans/{subject}
                        const docRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}/plans/${subject}`);
                        const docSnap = await getDoc(docRef);
                        
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            this.currentTeacherPlan = {
                                subject: subject,
                                dateRange: data.dateRange || '',
                                module: data.module || '',
                                achievementStandard: data.achievementStandard || '',
                                content: data.content || '',
                                method: data.method || ''
                            };
                            this.teacherPlanStatus = '저장된 계획안을 불러왔습니다.';
                            
                            // 날짜 선택기 업데이트
                            if (this.flatpickrInstance && data.dateRange) {
                                this.flatpickrInstance.setDate(data.dateRange.split(" to "));
                            }
                            
                        } else {
                            // 폼 초기화
                            this.currentTeacherPlan = {
                                subject: subject, dateRange: '', module: '', 
                                achievementStandard: '', content: '', method: ''
                            };
                            if (this.flatpickrInstance) this.flatpickrInstance.clear();
                            this.teacherPlanStatus = '새 계획안을 작성하세요.';
                        }
                        this.teacherPlanError = '';
                        
                    } catch (error) {
                        console.error("Error loading teacher plan:", error);
                        this.teacherPlanError = `계획안 로드 실패: ${error.message}`;
                        this.teacherPlanStatus = '';
                    }
                },
                
                // (교과교사) 지도 계획안 저장
                async saveTeacherPlan() {
                    const subject = this.currentTeacherPlan.subject;
                    if (!subject || !this.user) {
                        this.teacherPlanError = '과목이 선택되지 않았습니다.';
                        return;
                    }
                    
                    this.teacherPlanStatus = '계획안 저장 중...';
                    this.teacherPlanError = '';
                    
                    try {
                        // dateRange는 this.currentTeacherPlan.dateRange에 이미 바인딩됨
                        const dataToSave = { ...this.currentTeacherPlan };
                        delete dataToSave.subject; // subject는 문서 ID로 사용
                        
                        const docRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}/plans/${subject}`);
                        await setDoc(docRef, dataToSave, { merge: true });
                        
                        this.teacherPlanStatus = '계획안 저장 성공!';
                        
                    } catch (error) {
                        console.error("Error saving teacher plan:", error);
                        this.teacherPlanError = `계획안 저장 실패: ${error.message}`;
                        this.teacherPlanStatus = '';
                    }
                },
                
                // (교과교사) 계획안 양식 미리보기
                async generatePlanPreview() {
                    const plan = this.currentTeacherPlan;
                    if (!plan.subject) {
                        this.teacherPlanError = '과목을 선택하세요.';
                        return;
                    }
                    
                    // 1. 대상 학생 정보 (ID -> 이름)
                    const studentIds = new Set(
                        this.deployedUnderachievers
                            .filter(s => s.subject === plan.subject)
                            .map(s => s.studentId)
                    );
                    const studentNames = this.allStudents
                        .filter(s => studentIds.has(s.학생ID))
                        .map(s => s.이름).join(', ');
                        
                    // 2. 지도교사 이름
                    const teacherName = this.user ? this.user.displayName : 'N/A';
                    
                    // 3. HTML 생성
                    this.previewHtml = `
                        <div style="font-family: Arial, sans-serif; margin: 20px; border: 1px solid #ccc; padding: 20px;">
                            <h1 style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px;">
                                최소 성취수준 보장지도 계획안
                            </h1>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;" border="1">
                                <tbody>
                                    <tr>
                                        <td style="width: 20%; background: #f4f4f4; padding: 10px; font-weight: bold;">과목</td>
                                        <td style="width: 30%; padding: 10px;">${plan.subject || ''}</td>
                                        <td style="width: 20%; background: #f4f4f4; padding: 10px; font-weight: bold;">지도 교사</td>
                                        <td style="width: 30%; padding: 10px;">${teacherName}</td>
                                    </tr>
                                    <tr>
                                        <td style="background: #f4f4f4; padding: 10px; font-weight: bold;">지도 기간</td>
                                        <td colspan="3" style="padding: 10px;">${plan.dateRange || ''}</td>
                                    </tr>
                                    <tr>
                                        <td style="background: #f4f4f4; padding: 10px; font-weight: bold;">지도 대상</td>
                                        <td colspan="3" style="padding: 10px;">${studentNames || '대상 학생 없음'}</td>
                                    </tr>
                                    <tr>
                                        <td style="background: #f4f4f4; padding: 10px; font-weight: bold;">지도 모듈<br>(단원/영역)</td>
                                        <td colspan="3" style="padding: 10px; min-height: 60px;">${plan.module.replace(/\n/g, '<br>') || ''}</td>
                                    </tr>
                                    <tr>
                                        <td style="background: #f4f4f4; padding: 10px; font-weight: bold;">성취기준</td>
                                        <td colspan="3" style="padding: 10px; min-height: 80px;">${plan.achievementStandard.replace(/\n/g, '<br>') || ''}</td>
                                    </tr>
                                     <tr>
                                        <td style="background: #f4f4f4; padding: 10px; font-weight: bold;">지도 내용 (요소)</td>
                                        <td colspan="3" style="padding: 10px; min-height: 120px; vertical-align: top;">${plan.content.replace(/\n/g, '<br>') || ''}</td>
                                    </tr>
                                    <tr>
                                        <td style="background: #f4f4f4; padding: 10px; font-weight: bold;">지도 방법 및<br>자료</td>
                                        <td colspan="3" style="padding: 10px; min-height: 120px; vertical-align: top;">${plan.method.replace(/\n/g, '<br>') || ''}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    this.showPreviewModal = true;
                    this.teacherPlanError = '';
                    this.teacherPlanStatus = '';
                },

                // --- Attendance Book (Tab 3) ---
                
                // (교과/담임) 보충지도 대상자 가져오기
                filterSupplementaryStudents() {
                    this.attendanceError = '';
                    this.attendanceStatus = '';
                    
                    if (!this.deployedUnderachievers.length) {
                        this.attendanceError = '배포된 미도달 대상자 명단이 없습니다. (관리자 확인 필요)';
                        this.supplementaryStudents = [];
                        return;
                    }
                    
                    let filtered = [];
                    
                    // 1. 역할에 따라 필터링
                    if (this.role === '교과교사' && this.user) {
                        const teacherName = this.user.displayName;
                        filtered = this.deployedUnderachievers.filter(s => s.teacher === teacherName);
                    } else if (this.role === '담임교사' && this.user) {
                        // TODO: 담임교사-학급 매칭 로직 필요
                        // 임시: 담임교사는 모든 학생을 볼 수 없음 (관리자만)
                        this.attendanceError = '담임교사용 출결 로직은 구현 예정입니다.';
                        filtered = []; 
                    } else if (this.role === '관리자') {
                        filtered = [...this.deployedUnderachievers]; // 관리자는 전체
                    }
                    
                    // 2. 이전에 로드된 출결 데이터와 병합
                    this.loadGuidanceData(filtered);
                },

                // (교과/담임) 출결 데이터 로드 (대상자 필터링 후 호출됨)
                async loadGuidanceData(studentList) {
                    if (studentList.length === 0) {
                        if (!this.attendanceError) {
                             this.attendanceError = '가져올 대상 학생이 없습니다.';
                        }
                        this.supplementaryStudents = [];
                        return;
                    }
                    
                    this.attendanceStatus = '학생별 출결 데이터 로드 중...';
                    
                    const allDates = new Set();
                    const studentsWithData = [];
                    
                    try {
                        for (const student of studentList) {
                            // Firestore 경로: /schools/{schoolId}/teacherData/{userId}/guidance/{docId}
                            // (수정) 교사가 아닌 학생의 docId를 기준으로 저장/로드
                            // 경로: /schools/{schoolId}/guidanceData/{docId} (공용)
                            // (수정 2) 교사별로 저장 (권한 문제)
                            // 경로: /schools/{schoolId}/teacherData/{Teacher_UID}/guidance/{Student_DocId}
                            
                            // (수정 3) 교사 UID 대신 교사 이름을 사용 (편제표 기준)
                            // 이 경우 교사 이름이 중복되면 곤란함...
                            // -> 우선은 교사 UID (this.user.uid) 기준으로 감
                            
                            if (!this.user) {
                                this.attendanceError = '사용자 인증이 유효하지 않습니다.';
                                return;
                            }
                            
                            const docRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}/guidance/${student.docId}`);
                            const docSnap = await getDoc(docRef);
                            
                            let studentData = {
                                ...student,
                                attendance: {},
                                completionStatus: '진행중',
                                remarks: '',
                                totalHours: 0 // TODO: 총 차시 계산 로직 필요
                            };
                            
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                studentData.attendance = data.attendance || {};
                                studentData.completionStatus = data.completionStatus || '진행중';
                                studentData.remarks = data.remarks || '';
                                studentData.totalHours = data.totalHours || 0;
                                
                                // 날짜 추출
                                Object.keys(studentData.attendance).forEach(date => allDates.add(date));
                            }
                            
                            studentsWithData.push(studentData);
                        }
                        
                        // 날짜 헤더 정렬
                        this.dynamicDates = Array.from(allDates).sort();
                        // 학생 목록 정렬 (학년-반-번호)
                        this.supplementaryStudents = studentsWithData.sort((a, b) => {
                            if (a.grade !== b.grade) return a.grade - b.grade;
                            if (a.class !== b.class) return a.class - b.class;
                            return a.number - b.number;
                        });
                        
                        this.attendanceStatus = `${this.supplementaryStudents.length}명 로드 완료.`;
                        this.attendanceError = '';
                        
                        // 스크롤바 상태 업데이트
                        this.$nextTick(() => {
                           const container = this.$refs.tableContainer;
                           if (container) {
                               this.showLeftScroll = container.scrollLeft > 0;
                               this.showRightScroll = container.scrollWidth > container.clientWidth;
                           }
                        });

                    } catch (error) {
                        console.error("Error loading guidance data:", error);
                        this.attendanceError = `출결 데이터 로드 실패: ${error.message}`;
                        this.attendanceStatus = '';
                    }
                },
                
                // (교과/담임) 출결 저장
                async saveAttendance(student) {
                    if (!this.user || !this.schoolId) {
                        this.attendanceStatus = '저장 실패: 인증 정보 없음';
                        return;
                    }
                    
                    this.attendanceStatus = `${student.name} 학생 정보 저장 중...`;
                    
                    try {
                        const docRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}/guidance/${student.docId}`);
                        
                        const dataToSave = {
                            studentId: student.studentId,
                            subject: student.subject,
                            teacher: student.teacher, // 지도 교사
                            attendance: student.attendance,
                            completionStatus: student.completionStatus,
                            remarks: student.remarks,
                            totalHours: student.totalHours
                        };
                        
                        await setDoc(docRef, dataToSave, { merge: true });
                        this.attendanceStatus = `${student.name} 학생 정보 저장 성공.`;
                        
                    } catch (error) {
                        console.error("Error saving attendance:", error);
                        this.attendanceStatus = `${student.name} 학생 정보 저장 실패: ${error.message}`;
                    }
                },
                
                // (수정) 출결 이력 가져오기 모달 열기 (제거됨)
                // (수정) 출결 이력 가져오기 확정 (제거됨)

                // --- Counseling (Tab 4) ---
                
                // (담임) 학급 선택 시, 학생 및 상담 데이터 로드
                async loadCounselingData() {
                    if (!this.selectedHomeroom || !this.allStudents.length) {
                        this.homeroomStudents = [];
                        return;
                    }
                    
                    this.counselingStatus = '학급 학생 로드 중...';
                    const [grade, classNum] = this.selectedHomeroom.split('-');
                    
                    // 1. 학적부에서 해당 학급 학생 필터링
                    const students = this.allStudents
                        .filter(s => s.학년 == grade && s.반 == classNum)
                        .sort((a, b) => a.번호 - b.번호);
                        
                    // 2. Firestore에서 기존 상담 내역 로드
                    const studentsWithData = [];
                    try {
                        for (const student of students) {
                             // 경로: /schools/{schoolId}/teacherData/{userId}/counseling/{studentId}
                            const docRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}/counseling/${student.학생ID}`);
                            const docSnap = await getDoc(docRef);
                            
                            let studentData = {
                                id: student.학생ID,
                                name: student.이름,
                                number: student.번호,
                                counselingDate: '',
                                counselingNotes: '',
                                supportReferral: '',
                                supportReferralOther: ''
                            };
                            
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                studentData.counselingDate = data.counselingDate || '';
                                studentData.counselingNotes = data.counselingNotes || '';
                                studentData.supportReferral = data.supportReferral || '';
                                studentData.supportReferralOther = data.supportReferralOther || '';
                            }
                            studentsWithData.push(studentData);
                        }
                        
                        this.homeroomStudents = studentsWithData;
                        this.counselingStatus = '로드 완료.';
                        
                    } catch (error) {
                        console.error("Error loading counseling data:", error);
                        this.counselingStatus = `상담 내역 로드 실패: ${error.message}`;
                    }
                },
                
                // (담임) 상담 내역 저장
                async saveCounseling(student) {
                    if (!this.user || !this.schoolId) {
                        this.counselingStatus = '저장 실패: 인증 정보 없음';
                        return;
                    }
                    
                    this.counselingStatus = `${student.name} 학생 상담 내역 저장 중...`;
                    
                    try {
                        const docRef = doc(db, `schools/${this.schoolId}/teacherData/${this.user.uid}/counseling/${student.id}`);
                        
                        const dataToSave = {
                            counselingDate: student.counselingDate,
                            counselingNotes: student.counselingNotes,
                            supportReferral: student.supportReferral,
                            supportReferralOther: student.supportReferral === '기타' ? student.supportReferralOther : ''
                        };
                        
                        await setDoc(docRef, dataToSave, { merge: true });
                        this.counselingStatus = `${student.name} 학생 상담 내역 저장 성공.`;
                        
                    } catch (error) {
                        console.error("Error saving counseling data:", error);
                        this.counselingStatus = `${student.name} 학생 상담 내역 저장 실패: ${error.message}`;
                    }
                },
                
                // --- Print Forms (Tab 5) ---
                
                // (출력) 필터 변경 시
                updateClassFilter() {
                    this.printFilter.class = ''; // 반 선택 초기화
                    this.updateStudentFilter();
                },
                updateStudentFilter() {
                    // computed 'filteredPrintStudents'가 자동으로 다시 계산됨
                },
                
                // (출력) 전체 선택
                toggleSelectAllFiltered(event) {
                    const isChecked = event.target.checked;
                    this.filteredPrintStudents.forEach(student => student.selected = isChecked);
                },
                
                // (출력) 가정통신문/서약서 미리보기 생성
                previewForm(type) {
                    const studentsToPrint = this.selectedPrintStudents;
                    if (studentsToPrint.length === 0) {
                        this.adminActionStatus = '출력할 학생을 선택하세요.';
                        return;
                    }
                    
                    const template = (type === 'notification') 
                        ? this.loadedFormTemplates.notification 
                        : this.loadedFormTemplates.pledge;
                        
                    if (!template) {
                        this.adminActionStatus = '양식이 등록되지 않았습니다. (관리자 확인 필요)';
                        return;
                    }
                    
                    this.previewStatus = `${studentsToPrint.length}명 분의 ${type === 'notification' ? '가정통신문' : '서약서'} 생성 중...`;
                    this.showPreviewModal = true;
                    this.previewHtml = '';
                    
                    // 비동기 렌더링 (학생이 많을 경우 대비)
                    setTimeout(() => {
                        try {
                            // 1. 학생들을 이름 기준으로 그룹화 (동명이인 처리)
                            // -> 수정: 이름이 같아도 학년/반/번호가 다르면 다른 학생
                            // -> 수정 2: 이름/학번이 같아도 과목이 다르면 다른 행
                            
                            // 1. 학생 ID 기준으로 그룹화 (여러 과목)
                            const studentsById = new Map();
                            studentsToPrint.forEach(s => {
                                if (!studentsById.has(s.studentId)) {
                                    studentsById.set(s.studentId, {
                                        id: s.studentId,
                                        fullStudent: this.allStudents.find(as => as.학생ID === s.studentId),
                                        subjects: new Set()
                                    });
                                }
                                studentsById.get(s.studentId).subjects.add({ name: s.subject, reason: s.reason });
                            });
                            
                            // 2. 각 학생별로 HTML 생성
                            const allPreviewsHtml = Array.from(studentsById.values()).map(studentData => {
                                const { fullStudent, subjects } = studentData;
                                if (!fullStudent) return '';
                                
                                // 과목별 미도달 내역 테이블 생성
                                let studentTableHtml = `
                                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;" border="1">
                                        <thead style="background: #f4f4f4;">
                                            <tr>
                                                <th style="padding: 8px;">학번</th>
                                                <th style="padding: 8px;">이름</th>
                                                <th style="padding: 8px;">미도달 과목</th>
                                                <th style="padding: 8px;">미도달 내역(사유)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                `;
                                
                                // (수정) Rowspan 적용
                                if (subjects.size > 0) {
                                    let subjectIndex = 0;
                                    const subjectCount = subjects.size;
                                    subjects.forEach(subject => {
                                        const reasonText = subject.reason || 'N/A';
                                        if (subjectIndex === 0) {
                                            // 첫 번째 행: 학번과 이름에 rowspan 적용
                                            studentTableHtml += `<tr>
                                                <td rowspan="${subjectCount}" style="padding: 8px; text-align: center; vertical-align: top;">${fullStudent.학년}-${fullStudent.반}-${fullStudent.번호}</td>
                                                <td rowspan="${subjectCount}" style="padding: 8px; text-align: center; vertical-align: top;">${fullStudent.이름}</td>
                                                <td style="padding: 8px; text-align: left;">${subject.name}</td>
                                                <td style="padding: 8px; text-align: center;">${reasonText}</td>
                                            </tr>`;
                                        } else {
                                            // 두 번째 행부터: 과목과 내역만
                                            studentTableHtml += `<tr>
                                                <td style="padding: 8px; text-align: left;">${subject.name}</td>
                                                <td style="padding: 8px; text-align: center;">${reasonText}</td>
                                            </tr>`;
                                        }
                                        subjectIndex++;
                                    });
                                } else {
                                    studentTableHtml += `<tr><td colspan="4" style="padding: 8px; text-align: center;">미도달 내역 없음</td></tr>`;
                                }
                                
                                studentTableHtml += `</tbody></table>`;
                                
                                // 3. 템플릿에 데이터 삽입
                                let populatedTemplate = template
                                    .replace(/\[학생이름\]/g, fullStudent.이름)
                                    .replace(/\[학생학번\]/g, `${fullStudent.학년}-${fullStudent.반}-${fullStudent.번호}`)
                                    .replace(/\[미도달내역테이블\]/g, studentTableHtml);
                                
                                // (수정) 인라인 style 대신 CSS 클래스(.page-break) 사용
                                return `<div class="page-break">${populatedTemplate}</div>`;
                                
                            }).join('');
                            
                            this.previewHtml = allPreviewsHtml;
                            this.previewStatus = `총 ${studentsById.size}명의 학생 양식 생성 완료.`;
                            this.adminActionStatus = '';

                        } catch (error) {
                             console.error("Error generating preview:", error);
                             this.previewStatus = '';
                             this.adminActionStatus = `미리보기 생성 실패: ${error.message}`;
                             this.showPreviewModal = false;
                        }
                    }, 100);
                },

                // --- Preview Modal Methods ---
                
                // 미리보기 모달 닫기
                closePreviewModal() {
                    this.showPreviewModal = false;
                    this.previewHtml = '';
                    this.previewStatus = '';
                    this.adminActionStatus = '';
                    this.teacherPlanError = '';
                    this.teacherPlanStatus = '';
                },
                
                // (수정) 미리보기 모달 내용 인쇄 (window.print)
                printPreviewModalContent() {
                    // @media print CSS가 이 영역을 처리
                    window.print();
                },

            }
        }).mount('#app');
    </script>

</body>
</html>

